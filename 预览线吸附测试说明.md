# 预览线终端吸附功能测试说明

## 概述

本测试套件专门用于测试和调试预览线终端的拖拽吸附功能。通过全面的测试用例，帮助定位和解决预览线拖拽过程中的吸附问题。

## 测试文件位置

- **测试文件**: `src/tests/tdd-preview-line-endpoint-snap.test.js`
- **运行脚本**: `run-snap-tests.sh`

## 快速运行

```bash
# 方式1：使用运行脚本（推荐）
./run-snap-tests.sh

# 方式2：直接运行vitest
npx vitest run src/tests/tdd-preview-line-endpoint-snap.test.js --reporter=verbose
```

## 测试覆盖范围

### 1. 预览线终端拖拽事件处理
- ✅ 鼠标按下事件的正确处理
- ✅ 右键点击事件的忽略逻辑
- ✅ 事件冒泡的阻止机制
- ✅ 预览线实例的查找逻辑

### 2. 节点吸附检测算法
- ✅ 吸附距离内节点的正确检测
- ✅ 未配置节点的过滤逻辑
- ✅ 距离计算的准确性
- ✅ 最佳吸附位置的选择

### 3. 坐标系转换准确性
- ✅ 画布坐标到屏幕坐标的转换
- ✅ 拖拽过程中坐标的实时更新
- ✅ 坐标转换的一致性验证

### 4. 吸附距离阈值配置
- ✅ 配置值的正确读取（默认30像素）
- ✅ 边界距离的准确判断
- ✅ 阈值配置的有效性验证

### 5. 拖拽状态管理
- ✅ 拖拽开始时状态的正确设置
- ✅ 拖拽过程中状态的维护
- ✅ 拖拽结束时状态的清理

### 6. 视觉反馈和高亮显示
- ✅ 吸附目标节点的高亮显示
- ✅ 高亮效果的正确清除
- ✅ 视觉反馈的及时更新

### 7. 连接创建验证
- ✅ 成功吸附后连接的创建
- ✅ 拖拽结束时连接逻辑的处理
- ✅ 连接参数的正确传递

### 8. 综合场景测试
- ✅ 完整拖拽吸附流程的端到端测试
- ✅ 多个拖拽位置的连续测试
- ✅ 状态转换的完整性验证

## 调试输出信息

测试运行时会输出详细的调试信息，包括：

```
🧪 测试环境初始化完成
📊 测试节点数量: 4
⚙️ 吸附距离阈值: 30

🎯 测试：节点吸附检测
🔍 检测拖拽位置: {x: 120, y: 110}
📏 吸附距离阈值: 30
📐 到节点node1的距离: 22.36
🎯 找到吸附目标: node1
✅ 吸附检测验证通过
```

## 常见问题调试指南

### 问题1：拖拽无法启动
**可能原因**：
- 事件监听器未正确绑定
- `handlePreviewLineMouseDown` 方法实现有误
- 预览线实例查找失败

**调试方法**：
- 检查测试用例 "1. 预览线终端拖拽事件处理"
- 查看控制台输出中的事件处理日志

### 问题2：吸附检测不准确
**可能原因**：
- 距离计算算法错误
- 坐标系转换不正确
- 吸附距离阈值配置问题

**调试方法**：
- 检查测试用例 "2. 节点吸附检测算法"
- 验证测试用例 "3. 坐标系转换准确性"
- 确认测试用例 "4. 吸附距离阈值配置"

### 问题3：视觉反馈异常
**可能原因**：
- 高亮样式未正确应用
- 高亮清除逻辑有误
- DOM更新时机问题

**调试方法**：
- 检查测试用例 "6. 视觉反馈和高亮显示"
- 查看浏览器开发者工具中的样式变化

### 问题4：连接创建失败
**可能原因**：
- 拖拽结束事件处理不当
- 目标节点检测失败
- 连接创建方法参数错误

**调试方法**：
- 检查测试用例 "7. 连接创建验证"
- 验证拖拽状态管理逻辑

## 实际代码调试建议

### 1. 添加调试日志
在 `UnifiedPreviewLineManager.js` 中添加调试输出：

```javascript
// 在关键方法中添加日志
handlePreviewLineMouseDown(event) {
  console.debug('🖱️ 鼠标按下事件:', event.clientX, event.clientY);
  // ... 现有逻辑
}

getBestSnapPosition(dragPos, nodes) {
  console.debug('🔍 检测吸附位置:', dragPos);
  // ... 现有逻辑
}
```

### 2. 验证配置参数
确认吸附配置是否正确加载：

```javascript
console.debug('⚙️ 吸附配置:', this.VERTICAL_LAYOUT_CONFIG.SNAP_CONFIG);
```

### 3. 检查坐标转换
验证坐标转换的准确性：

```javascript
const canvasPos = { x: 100, y: 100 };
const screenPos = this.convertToScreenCoordinates(canvasPos);
console.debug('🎨 坐标转换:', canvasPos, '->', screenPos);
```

### 4. 监控状态变化
跟踪拖拽状态的变化：

```javascript
set isDragging(value) {
  console.debug('🎯 拖拽状态变化:', this._isDragging, '->', value);
  this._isDragging = value;
}
```

## 测试结果解读

### 成功输出示例
```
✓ src/tests/tdd-preview-line-endpoint-snap.test.js (14)
  ✓ 预览线终端吸附功能测试 (14)
    ✓ 1. 预览线终端拖拽事件处理 (2)
    ✓ 2. 节点吸附检测算法 (2)
    ...

Test Files  1 passed (1)
Tests  14 passed (14)
```

### 失败输出示例
```
❌ FAIL  src/tests/tdd-preview-line-endpoint-snap.test.js
AssertionError: expected 35 to be less than or equal to 30
```

## 扩展测试

如需添加更多测试用例，可以在现有测试文件中扩展：

```javascript
describe('9. 自定义测试场景', () => {
  it('应该处理特殊情况', () => {
    // 添加你的测试逻辑
  });
});
```

## 注意事项

1. **测试环境**：测试使用模拟数据，实际环境可能有差异
2. **浏览器兼容性**：某些坐标计算在不同浏览器中可能有细微差别
3. **性能考虑**：频繁的吸附检测可能影响性能，注意优化
4. **状态同步**：确保拖拽状态与UI状态保持同步

## 联系支持

如果测试发现问题或需要进一步的调试支持，请：

1. 保存测试输出日志
2. 记录具体的复现步骤
3. 提供浏览器和环境信息
4. 描述期望的行为和实际行为的差异

---

**最后更新**: 2024年12月
**测试框架**: Vitest
**覆盖功能**: 预览线终端拖拽吸附