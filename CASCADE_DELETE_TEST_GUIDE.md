# 节点级联删除功能测试指南

## 功能概述
实现了删除上级节点时自动删除所有挂载在该节点下的子节点的功能，包括用户确认机制和递归删除逻辑。

## 实现组件
1. **TaskFlowCanvas.vue** - 任务流程画布组件
2. **LayeredFlowCanvas.vue** - 分层流程画布组件

## 核心功能

### 1. 递归查找子节点
- `getAllChildNodes(nodeId)` - TaskFlowCanvas
- `getAllDescendantNodes(nodeId)` - LayeredFlowCanvas
- 递归遍历所有连接，找出指定节点的所有子节点

### 2. 级联删除逻辑
- `cascadeDeleteNode(nodeId)` - TaskFlowCanvas
- `deleteNodeAndDescendants(nodeId)` - LayeredFlowCanvas
- 按照从叶子节点到根节点的顺序删除，确保删除顺序正确

### 3. 用户确认机制
- 当删除的节点有子节点时，弹出确认对话框
- 显示将要删除的子节点数量和总节点数量
- 提供确认和取消选项，避免误操作

## 测试步骤

### 基础功能测试

#### 1. 单节点删除
- **操作**: 删除没有子节点的节点
- **预期**: 直接删除，不弹出确认对话框
- **验证**: 节点从画布消失，相关连接被清理

#### 2. 简单级联删除
- **操作**: 创建 A → B 的连接，删除节点A
- **预期**: 弹出确认对话框，显示"将删除1个子节点，总共2个节点"
- **验证**: 确认后A和B都被删除

#### 3. 复杂级联删除
- **操作**: 创建 A → B → C → D 的链式连接，删除节点A
- **预期**: 弹出确认对话框，显示"将删除3个子节点，总共4个节点"
- **验证**: 确认后A、B、C、D都被删除

### 复杂场景测试

#### 4. 分支结构删除
```
    A
   / \
  B   C
 /   / \
D   E   F
```
- **操作**: 删除节点A
- **预期**: 弹出确认对话框，显示"将删除5个子节点，总共6个节点"
- **验证**: 确认后所有节点都被删除

#### 5. 部分分支删除
- **操作**: 在上述结构中删除节点C
- **预期**: 弹出确认对话框，显示"将删除2个子节点，总共3个节点"
- **验证**: 确认后C、E、F被删除，A、B、D保留

#### 6. 取消删除操作
- **操作**: 删除有子节点的节点，但在确认对话框中点击取消
- **预期**: 对话框关闭，所有节点保持不变
- **验证**: 画布状态无变化

### 边界情况测试

#### 7. 开始节点删除
- **操作**: 尝试删除开始节点
- **预期**: 不允许删除（现有逻辑）
- **验证**: 删除按钮不可用或操作被阻止

#### 8. 循环引用处理
- **操作**: 如果存在循环连接，测试删除行为
- **预期**: 正确处理，避免无限递归
- **验证**: 删除操作正常完成

#### 9. 空画布操作
- **操作**: 在空画布上进行删除操作
- **预期**: 无异常发生
- **验证**: 应用保持稳定

### 用户体验测试

#### 10. 确认对话框内容
- **验证项目**:
  - 对话框标题清晰
  - 子节点数量显示正确
  - 总节点数量显示正确
  - 确认和取消按钮功能正常

#### 11. 删除动画和反馈
- **验证项目**:
  - 删除过程有适当的视觉反馈
  - 连接线正确清理
  - 画布布局自动调整

#### 12. 性能测试
- **操作**: 删除包含大量子节点的节点（如50+个节点）
- **预期**: 删除操作在合理时间内完成
- **验证**: 无明显卡顿，内存使用正常

## 成功指标

### 功能指标
- ✅ 能够正确识别所有子节点
- ✅ 按正确顺序删除节点（叶子到根）
- ✅ 完全清理相关连接和数据
- ✅ 用户确认机制工作正常

### 用户体验指标
- ✅ 确认对话框信息准确
- ✅ 操作响应及时
- ✅ 无意外的界面闪烁或错误
- ✅ 取消操作完全恢复原状

### 技术指标
- ✅ 无内存泄漏
- ✅ 无控制台错误
- ✅ 递归算法性能良好
- ✅ 代码逻辑清晰可维护

## 注意事项

### 开发注意
1. **递归深度**: 确保递归算法有合理的深度限制
2. **异步操作**: 删除操作可能涉及异步，需要正确处理
3. **状态同步**: 确保所有相关状态（选中、配置等）正确清理
4. **错误处理**: 添加适当的错误处理和用户提示

### 测试注意
1. **数据备份**: 测试前备份重要的流程数据
2. **浏览器兼容**: 在不同浏览器中测试确认对话框
3. **性能监控**: 关注大量节点删除时的性能表现
4. **边界测试**: 重点测试极端情况和边界条件

## 后续优化建议

### 功能增强
1. **批量删除**: 支持选中多个节点进行批量删除
2. **删除预览**: 在确认前高亮显示将要删除的节点
3. **撤销功能**: 提供删除操作的撤销功能
4. **删除历史**: 记录删除操作历史

### 用户体验优化
1. **渐进式删除**: 添加删除动画效果
2. **智能提示**: 根据节点类型提供更详细的删除提示
3. **快捷操作**: 支持键盘快捷键删除
4. **确认选项**: 提供"不再提示"选项给高级用户

## 相关文件
- `/src/pages/marketing/tasks/components/TaskFlowCanvas.vue`
- `/src/components/LayeredFlowCanvas.vue`
- `/CASCADE_DELETE_IMPLEMENTATION_GUIDE.md`