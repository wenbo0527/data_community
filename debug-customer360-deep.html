<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer360 æ·±åº¦è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            border-radius: 5px;
            background: #2a2a2a;
        }
        .button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        .button:hover {
            background: #005a9e;
        }
        .output {
            background: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 3px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .error {
            color: #ff4444;
        }
        .warning {
            color: #ffaa00;
        }
        .success {
            color: #44ff44;
        }
        .info {
            color: #4488ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Customer360 æ·±åº¦è¯Šæ–­å·¥å…·</h1>
        
        <div class="section">
            <h2>ğŸš€ å¿«é€Ÿæ“ä½œ</h2>
            <button class="button" onclick="openCustomer360()">æ‰“å¼€ Customer360 é¡µé¢</button>
            <button class="button" onclick="runFullDiagnosis()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
            <button class="button" onclick="checkMemoryLeaks()">æ£€æŸ¥å†…å­˜æ³„æ¼</button>
            <button class="button" onclick="clearOutput()">æ¸…ç©ºè¾“å‡º</button>
        </div>

        <div class="section">
            <h2>ğŸ“Š è¯Šæ–­ç»“æœ</h2>
            <div id="output" class="output">ç­‰å¾…è¯Šæ–­...</div>
        </div>
    </div>

    <script>
        let outputDiv = document.getElementById('output');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            outputDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }
        
        function clearOutput() {
            outputDiv.innerHTML = 'è¾“å‡ºå·²æ¸…ç©º\n';
        }
        
        function openCustomer360() {
            log('ğŸš€ æ­£åœ¨æ‰“å¼€ Customer360 é¡µé¢...', 'info');
            window.open('http://localhost:5173/discovery/customer360/887123', '_blank');
        }
        
        async function checkPageContent() {
            try {
                log('ğŸ” æ£€æŸ¥é¡µé¢å†…å®¹...', 'info');
                
                // æ£€æŸ¥å½“å‰é¡µé¢æ˜¯å¦æ˜¯Customer360
                const currentUrl = window.location.href;
                log(`å½“å‰é¡µé¢: ${currentUrl}`, 'info');
                
                if (currentUrl.includes('customer360')) {
                    log('âœ… å½“å‰åœ¨Customer360é¡µé¢', 'success');
                    
                    // æ£€æŸ¥Vueåº”ç”¨
                    if (window.Vue) {
                        log('âœ… Vueå·²åŠ è½½', 'success');
                    } else {
                        log('âŒ VueæœªåŠ è½½', 'error');
                    }
                    
                    // æ£€æŸ¥DOMå…ƒç´ 
                    const appElement = document.getElementById('app');
                    if (appElement) {
                        log('âœ… #appå…ƒç´ å­˜åœ¨', 'success');
                        log(`#appå†…å®¹é•¿åº¦: ${appElement.innerHTML.length}`, 'info');
                        
                        if (appElement.innerHTML.length < 100) {
                            log('âš ï¸ #appå†…å®¹è¿‡å°‘ï¼Œå¯èƒ½æœªæ­£ç¡®æ¸²æŸ“', 'warning');
                            log(`#appå†…å®¹: ${appElement.innerHTML.substring(0, 200)}`, 'info');
                        }
                    } else {
                        log('âŒ #appå…ƒç´ ä¸å­˜åœ¨', 'error');
                    }
                    
                    // æ£€æŸ¥ç‰¹å®šçš„Customer360å…ƒç´ 
                    const customer360Elements = document.querySelectorAll('[class*="customer360"], [id*="customer360"]');
                    log(`æ‰¾åˆ° ${customer360Elements.length} ä¸ªCustomer360ç›¸å…³å…ƒç´ `, 'info');
                    
                    // æ£€æŸ¥åŠ è½½çŠ¶æ€å…ƒç´ 
                    const loadingElements = document.querySelectorAll('[class*="loading"], [class*="spinner"]');
                    if (loadingElements.length > 0) {
                        log(`âš ï¸ å‘ç° ${loadingElements.length} ä¸ªåŠ è½½çŠ¶æ€å…ƒç´ ï¼Œé¡µé¢å¯èƒ½ä»åœ¨åŠ è½½`, 'warning');
                    }
                    
                    // æ£€æŸ¥é”™è¯¯å…ƒç´ 
                    const errorElements = document.querySelectorAll('[class*="error"], [class*="fail"]');
                    if (errorElements.length > 0) {
                        log(`âŒ å‘ç° ${errorElements.length} ä¸ªé”™è¯¯å…ƒç´ `, 'error');
                    }
                    
                } else {
                    log('â„¹ï¸ å½“å‰ä¸åœ¨Customer360é¡µé¢', 'info');
                }
                
            } catch (error) {
                log(`âŒ æ£€æŸ¥é¡µé¢å†…å®¹æ—¶å‡ºé”™: ${error.message}`, 'error');
            }
        }
        
        async function checkConsoleErrors() {
            log('ğŸ” æ£€æŸ¥æ§åˆ¶å°é”™è¯¯...', 'info');
            
            // é‡å†™console.erroræ¥æ•è·é”™è¯¯
            const originalError = console.error;
            const errors = [];
            
            console.error = function(...args) {
                errors.push(args.join(' '));
                originalError.apply(console, args);
            };
            
            setTimeout(() => {
                if (errors.length > 0) {
                    log(`âŒ å‘ç° ${errors.length} ä¸ªæ§åˆ¶å°é”™è¯¯:`, 'error');
                    errors.forEach(error => {
                        log(`  - ${error}`, 'error');
                    });
                } else {
                    log('âœ… æ²¡æœ‰å‘ç°æ§åˆ¶å°é”™è¯¯', 'success');
                }
                
                // æ¢å¤åŸå§‹console.error
                console.error = originalError;
            }, 2000);
        }
        
        async function checkNetworkRequests() {
            log('ğŸ” æ£€æŸ¥ç½‘ç»œè¯·æ±‚...', 'info');
            
            // ç›‘å¬fetchè¯·æ±‚
            const originalFetch = window.fetch;
            const requests = [];
            
            window.fetch = function(...args) {
                const url = args[0];
                requests.push({ url, timestamp: Date.now() });
                log(`ğŸ“¡ ç½‘ç»œè¯·æ±‚: ${url}`, 'info');
                
                return originalFetch.apply(this, args)
                    .then(response => {
                        log(`âœ… è¯·æ±‚æˆåŠŸ: ${url} (${response.status})`, 'success');
                        return response;
                    })
                    .catch(error => {
                        log(`âŒ è¯·æ±‚å¤±è´¥: ${url} - ${error.message}`, 'error');
                        throw error;
                    });
            };
            
            setTimeout(() => {
                log(`ğŸ“Š æ€»å…±ç›‘å¬åˆ° ${requests.length} ä¸ªç½‘ç»œè¯·æ±‚`, 'info');
                
                // æ¢å¤åŸå§‹fetch
                window.fetch = originalFetch;
            }, 5000);
        }
        
        function checkMemoryLeaks() {
            log('ğŸ” æ£€æŸ¥å†…å­˜æ³„æ¼...', 'info');
            
            // æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨
            const elements = document.querySelectorAll('*');
            let totalListeners = 0;
            
            elements.forEach(element => {
                const listeners = getEventListeners ? getEventListeners(element) : {};
                const listenerCount = Object.keys(listeners).length;
                if (listenerCount > 0) {
                    totalListeners += listenerCount;
                }
            });
            
            log(`ğŸ“Š æ€»äº‹ä»¶ç›‘å¬å™¨æ•°é‡: ${totalListeners}`, 'info');
            
            if (totalListeners > 100) {
                log('âš ï¸ äº‹ä»¶ç›‘å¬å™¨æ•°é‡è¾ƒå¤šï¼Œå¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼', 'warning');
            }
            
            // æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
            if (performance.memory) {
                const memory = performance.memory;
                log(`ğŸ’¾ å†…å­˜ä½¿ç”¨æƒ…å†µ:`, 'info');
                log(`  - å·²ä½¿ç”¨: ${(memory.usedJSHeapSize / 1024 / 1024).toFixed(2)} MB`, 'info');
                log(`  - æ€»è®¡: ${(memory.totalJSHeapSize / 1024 / 1024).toFixed(2)} MB`, 'info');
                log(`  - é™åˆ¶: ${(memory.jsHeapSizeLimit / 1024 / 1024).toFixed(2)} MB`, 'info');
            }
        }
        
        async function testApiDirectly() {
            log('ğŸ” ç›´æ¥æµ‹è¯•API...', 'info');
            
            try {
                // æ¨¡æ‹ŸAPIè°ƒç”¨
                const response = await fetch('/api/customer360/887123');
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… APIè°ƒç”¨æˆåŠŸ', 'success');
                    log(`ğŸ“Š è¿”å›æ•°æ®: ${JSON.stringify(data, null, 2)}`, 'info');
                } else {
                    log(`âŒ APIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(`âŒ APIè°ƒç”¨å¼‚å¸¸: ${error.message}`, 'error');
                
                // å°è¯•ç›´æ¥è°ƒç”¨æ¨¡æ‹Ÿå‡½æ•°
                try {
                    log('ğŸ”„ å°è¯•ç›´æ¥è°ƒç”¨æ¨¡æ‹Ÿå‡½æ•°...', 'info');
                    
                    // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„APIå‡½æ•°è·¯å¾„è°ƒæ•´
                    if (window.fetchUserInfo) {
                        const result = await window.fetchUserInfo('887123');
                        log('âœ… æ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨æˆåŠŸ', 'success');
                        log(`ğŸ“Š è¿”å›æ•°æ®: ${JSON.stringify(result, null, 2)}`, 'info');
                    } else {
                        log('âŒ æ‰¾ä¸åˆ°fetchUserInfoå‡½æ•°', 'error');
                    }
                } catch (mockError) {
                    log(`âŒ æ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨å¤±è´¥: ${mockError.message}`, 'error');
                }
            }
        }
        
        async function runFullDiagnosis() {
            log('ğŸš€ å¼€å§‹å®Œæ•´è¯Šæ–­...', 'info');
            log('=' .repeat(50), 'info');
            
            await checkPageContent();
            await checkConsoleErrors();
            await checkNetworkRequests();
            await testApiDirectly();
            
            log('=' .repeat(50), 'info');
            log('âœ… å®Œæ•´è¯Šæ–­å®Œæˆ', 'success');
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡ŒåŸºç¡€æ£€æŸ¥
        window.addEventListener('load', () => {
            log('ğŸš€ è¯Šæ–­å·¥å…·å·²åŠ è½½', 'success');
            log('ğŸ’¡ ç‚¹å‡»"è¿è¡Œå®Œæ•´è¯Šæ–­"å¼€å§‹æ·±åº¦åˆ†æ', 'info');
        });
    </script>
</body>
</html>