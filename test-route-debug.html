<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è·¯ç”±è°ƒè¯•æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        pre { background: #f0f0f0; padding: 10px; overflow-x: auto; }
        .url-test { background: #e3f2fd; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>ğŸ” Customer360 è·¯ç”±è°ƒè¯•æµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>å½“å‰URLä¿¡æ¯</h3>
        <div class="url-test">
            <p><strong>å½“å‰URL:</strong> <span id="currentUrl"></span></p>
            <p><strong>è·¯å¾„:</strong> <span id="currentPath"></span></p>
            <p><strong>æŸ¥è¯¢å‚æ•°:</strong> <span id="currentQuery"></span></p>
            <p><strong>Hash:</strong> <span id="currentHash"></span></p>
        </div>
    </div>
    
    <div class="test-section">
        <h3>æµ‹è¯•ä¸åŒçš„URLæ ¼å¼</h3>
        <button onclick="testUrl('/discovery/customer360/detail/887123')">æµ‹è¯•è·¯å¾„å‚æ•°</button>
        <button onclick="testUrl('/discovery/customer360/detail?userId=887123')">æµ‹è¯•æŸ¥è¯¢å‚æ•°</button>
        <button onclick="testUrl('/discovery/customer360/detail/887123?debug=true')">æµ‹è¯•æ··åˆå‚æ•°</button>
        <button onclick="testDirectApi()">ç›´æ¥æµ‹è¯•API</button>
        <button onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
    </div>
    
    <div class="test-section">
        <h3>æµ‹è¯•ç»“æœ</h3>
        <div id="results"></div>
    </div>
    
    <script type="module">
        // æ›´æ–°å½“å‰URLä¿¡æ¯
        function updateUrlInfo() {
            document.getElementById('currentUrl').textContent = window.location.href;
            document.getElementById('currentPath').textContent = window.location.pathname;
            document.getElementById('currentQuery').textContent = window.location.search;
            document.getElementById('currentHash').textContent = window.location.hash;
        }
        
        function addResult(title, content, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `
                <h4>${title}</h4>
                <pre>${typeof content === 'object' ? JSON.stringify(content, null, 2) : content}</pre>
                <small>æ—¶é—´: ${new Date().toLocaleTimeString()}</small>
            `;
            results.appendChild(div);
        }
        
        window.testUrl = function(url) {
            addResult(`ğŸ”— æµ‹è¯•URL: ${url}`, 'æ¨¡æ‹Ÿè·¯ç”±è·³è½¬...');
            
            // æ¨¡æ‹Ÿè§£æURLå‚æ•°
            const urlObj = new URL(url, window.location.origin);
            const pathParts = urlObj.pathname.split('/');
            const userId = pathParts[pathParts.length - 1]; // å‡è®¾userIdæ˜¯è·¯å¾„çš„æœ€åä¸€éƒ¨åˆ†
            const queryUserId = urlObj.searchParams.get('userId');
            
            addResult('ğŸ“ URLè§£æç»“æœ', {
                originalUrl: url,
                pathname: urlObj.pathname,
                pathParts: pathParts,
                pathUserId: userId,
                queryParams: Object.fromEntries(urlObj.searchParams),
                queryUserId: queryUserId,
                finalUserId: queryUserId || userId
            }, 'success');
            
            // å¦‚æœæœ‰æœ‰æ•ˆçš„userIdï¼Œæµ‹è¯•APIè°ƒç”¨
            const finalUserId = queryUserId || userId;
            if (finalUserId && finalUserId !== 'detail') {
                testApiWithUserId(finalUserId);
            }
        };
        
        async function testApiWithUserId(userId) {
            addResult(`ğŸ“¡ æµ‹è¯•APIè°ƒç”¨`, `userId: ${userId}`);
            
            try {
                // åŠ¨æ€å¯¼å…¥APIå‡½æ•°
                const { fetchUserInfo } = await import('/src/mock/customer360.ts');
                
                console.log(`ğŸš€ è°ƒç”¨ fetchUserInfo(${userId})`);
                const result = await fetchUserInfo(userId);
                
                console.log('ğŸ“¥ APIå“åº”:', result);
                
                if (result && result.error) {
                    addResult('âŒ APIè¿”å›é”™è¯¯', {
                        error: result.error,
                        message: result.message,
                        userId: result.userId
                    }, 'error');
                } else if (result) {
                    addResult('âœ… APIè°ƒç”¨æˆåŠŸ', {
                        userId: result.userId,
                        name: result.name,
                        hasBasicInfo: !!result.basicInfo,
                        hasProducts: !!(result.selfProducts || result.loanProducts),
                        dataKeys: Object.keys(result),
                        selfProductsCount: result.selfProducts?.length || 0,
                        loanProductsCount: result.loanProducts?.length || 0
                    }, 'success');
                } else {
                    addResult('âš ï¸ APIè¿”å›ç©ºæ•°æ®', { userId }, 'error');
                }
                
            } catch (error) {
                console.error('ğŸ’¥ APIè°ƒç”¨å¤±è´¥:', error);
                addResult('ğŸ’¥ APIè°ƒç”¨å¼‚å¸¸', {
                    error: error.message,
                    stack: error.stack
                }, 'error');
            }
        }
        
        window.testDirectApi = async function() {
            await testApiWithUserId('887123');
        };
        
        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
        };
        
        // é¡µé¢åŠ è½½æ—¶æ›´æ–°URLä¿¡æ¯
        updateUrlInfo();
        
        // ç›‘å¬URLå˜åŒ–
        window.addEventListener('popstate', updateUrlInfo);
        
        // è‡ªåŠ¨æµ‹è¯•å½“å‰URL
        window.addEventListener('load', () => {
            addResult('ğŸ¯ é¡µé¢åŠ è½½å®Œæˆ', 'å¼€å§‹è‡ªåŠ¨æµ‹è¯•å½“å‰URL');
            
            // æ£€æŸ¥å½“å‰URLæ˜¯å¦åŒ…å«userId
            const currentPath = window.location.pathname;
            const currentQuery = window.location.search;
            
            if (currentPath.includes('customer360') || currentQuery.includes('userId')) {
                addResult('ğŸ” æ£€æµ‹åˆ°customer360ç›¸å…³URL', 'å¼€å§‹è§£æå‚æ•°');
                testUrl(currentPath + currentQuery);
            } else {
                addResult('â„¹ï¸ å½“å‰ä¸æ˜¯customer360é¡µé¢', 'æ‰‹åŠ¨æµ‹è¯•APIè°ƒç”¨');
                setTimeout(() => {
                    testDirectApi();
                }, 1000);
            }
        });
    </script>
</body>
</html>