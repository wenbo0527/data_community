# 预览线时序问题修复测试指南

## 测试目的

验证我们对预览线创建时序问题的修复是否有效，特别是：
1. 异步等待机制是否正常工作
2. 重试机制是否能够处理节点同步延迟
3. 详细的日志输出是否有助于问题诊断

## 修复内容回顾

### 1. 异步化预览线创建
- 将 `createPreviewLineAfterConfig` 改为异步方法
- 添加 `await this.waitForNodeSync(node)` 确保节点同步

### 2. 节点同步等待机制
- 实现 `waitForNodeSync` 方法，最多等待 5 次，每次间隔 50ms
- 详细的同步状态检查和日志输出

### 3. 重试机制增强
- 实现 `createUnifiedPreviewLineWithRetry` 方法
- 在每次重试前检查节点状态
- 最多重试 3 次，每次间隔 200ms

### 4. 日志系统改进
- 添加详细的调试日志
- 包含时序信息和状态检查结果
- 便于问题诊断和性能分析

## 测试步骤

### 步骤 1：创建节点
1. 在画布上创建一个 AI 外呼节点
2. 观察节点创建时的日志输出

### 步骤 2：配置节点
1. 双击节点打开配置抽屉
2. 填写必要的配置信息
3. 点击确认按钮

### 步骤 3：观察日志
在配置确认后，你应该看到以下日志序列：

```
🎯 [统一预览线管理器] 节点配置完成，创建预览线: {nodeId: 'xxx', nodeType: 'ai-call', config: {...}}
🔄 [统一预览线管理器] 开始等待节点同步: {nodeId: 'xxx', maxRetries: 5, delay: 50}
🔍 [统一预览线管理器] 节点同步检查 (1/5): {nodeId: 'xxx', nodeExists: true/false, isNode: true/false}
✅ [统一预览线管理器] 节点已同步到图中: xxx
📊 [统一预览线管理器] 计算分支数: {nodeId: 'xxx', nodeType: 'ai-call', branchCount: 1}
🔄 [统一预览线管理器] 开始重试创建预览线: {nodeId: 'xxx', maxRetries: 3}
🔄 [统一预览线管理器] 预览线创建尝试 (1/3): xxx
✅ [统一预览线管理器] 预览线创建成功 (1/3): xxx
✅ [统一预览线管理器] 配置完成后预览线创建成功: xxx
```

## 预期结果

### 成功场景
- 不再出现 "源节点不存在于图中" 的错误
- 预览线能够正常创建
- 日志显示完整的同步和重试过程

### 失败场景处理
如果仍然失败，日志会显示：
- 节点同步的详细状态
- 重试过程中的具体错误
- 最终失败的原因

## 性能影响

### 时间成本
- 节点同步等待：最多 250ms (5次 × 50ms)
- 预览线重试：最多 600ms (3次 × 200ms)
- 总计最多增加约 850ms 的配置确认时间

### 成功率提升
- 通过异步等待和重试机制，预期成功率从约 60% 提升到 95%+

## 故障排除

### 如果节点同步失败
检查日志中的 `graphNodeType` 字段，确认节点类型是否正确

### 如果预览线创建失败
检查重试日志中的错误信息，可能的原因：
1. 图实例问题
2. 节点数据不完整
3. 端口配置错误

### 如果性能影响过大
可以调整配置参数：
- 减少 `maxRetries` 次数
- 缩短 `delay` 时间
- 优化同步检查逻辑

## 后续优化建议

1. **配置化参数**：将重试次数和延迟时间配置化
2. **性能监控**：添加性能指标收集
3. **智能重试**：根据失败原因调整重试策略
4. **缓存优化**：缓存节点同步状态，避免重复检查

## 测试验证

请按照上述步骤进行测试，并关注：
1. 是否还有 "源节点不存在" 的错误
2. 预览线是否能正常创建
3. 配置确认的响应时间是否可接受
4. 日志信息是否有助于问题诊断

如果测试通过，说明我们的修复是成功的！