import{_ as Ve,O as be,r as i,a as Ce,b as Q,u as $e,L as Ie,P as De,M as _,c as I,h as d,f as a,w as t,s as Se,v as qe,e as s,J as Te,o as h,j as u,i as X,x as Oe,t as v,d as L,g as Z,F as P,m as ee,N as U}from"./index-CsgcdrY7.js";import{couponMockData as Le}from"./coupon-BKFb4O9B.js";import{I as Pe}from"./index-B8gm8_GQ.js";const c=D=>(Se("data-v-16d5f89f"),D=D(),qe(),D),Ue={class:"coupon-container"},Me=c(()=>d("h2",null,"券库存管理",-1)),ze={class:"header-actions"},Fe={style:{cursor:"pointer"}},Ne={style:{"white-space":"nowrap",overflow:"hidden","text-overflow":"ellipsis",display:"block"}},Be={class:"create-coupon-container"},Ee=c(()=>d("div",{class:"page-header"},[d("h2",{class:"page-title"},"创建券库存")],-1)),Re=c(()=>d("span",{class:"help-text"},"选择合适的券模版作为基础配置",-1)),Ae=c(()=>d("span",{class:"help-text"},"选择负责审核该券的人员",-1)),Je=c(()=>d("span",{class:"help-text"},"当前登录用户",-1)),We=c(()=>d("span",{class:"help-text"},"设置便于识别的券名称，最多50个字符",-1)),je=c(()=>d("span",{class:"help-text"},"设置本次创建的券的发放数量",-1)),Ke=c(()=>d("span",{class:"help-text"},"选填项：设置每日最大发放数量",-1)),Ye=c(()=>d("span",{class:"help-text"},"选填项：设置每周最大发放数量",-1)),Ge=c(()=>d("span",{class:"help-text"},"选填项：设置每月最大发放数量",-1)),He=c(()=>d("span",{class:"help-text"},"选择券的有效期类型",-1)),Qe=c(()=>d("span",{class:"help-text"},"设置券的可用时间范围",-1)),Xe=c(()=>d("span",{class:"help-text"},"设置券的相对有效期天数，最长不超过45天",-1)),Ze=c(()=>d("span",{class:"help-text"},"详细描述券的使用条件和限制，便于用户理解",-1)),et={class:"form-actions"},tt={__name:"index",setup(D){const B=Te(),te=be(),E=i([]),S=i(!1),R=i("");i(!1),i([]),i([]),i([]),i([]),i([]),i([]),i(1),Ce(()=>{var n,l,r,m,g,C;return[{label:"券模版",value:((n=q.value.find(N=>{var k;return N.id===((k=o.value)==null?void 0:k.templateId)}))==null?void 0:n.name)||"-"},{label:"券名称",value:((l=o.value)==null?void 0:l.name)||"-"},{label:"发放数量",value:((r=o.value)==null?void 0:r.totalCount)||"-"},{label:"使用规则",value:((m=o.value)==null?void 0:m.rules)||"-"},{label:"有效期",value:(C=(g=o.value)==null?void 0:g.validity)!=null&&C.length?`${o.value.validity[0]} 至 ${o.value.validity[1]}`:"-"}]});const w=i({total:0,current:1,pageSize:10,showTotal:!0,showJumper:!0,showPageSize:!0}),b=i(!1),M=i(null),q=i([]),A=n=>{B.push({path:"/marketing/coupon/management/detail",query:{templateId:n.templateId,instanceId:n.id}})};i(!1),i({});const J=i([{id:"A001",name:"张三"},{id:"A002",name:"李四"},{id:"A003",name:"王五"}]),ae=i([{id:"O001",name:"赵六"},{id:"O002",name:"钱七"},{id:"O003",name:"孙八"}]),o=i({templateId:"",name:"",totalCount:1e3,dailyLimit:100,weeklyLimit:500,monthlyLimit:2e3,rules:"",validityType:"absolute",validity:[],relativeDays:1,auditor:"",operator:te.userInfo.username,validityPeriod:[],userLimitDesc:""}),le={templateId:[{required:!0,message:"请选择券模版"}],name:[{required:!0,message:"请输入券名称"},{maxLength:50,message:"名称长度不能超过50个字符"}],totalCount:[{required:!0,message:"请输入发放数量"}],validityType:[{required:!0,message:"请选择有效期类型"}],validity:[{required:!0,message:"请选择有效期"}],relativeDays:[{required:!0,message:"请输入相对有效期天数"}],auditor:[{required:!0,message:"请选择审核员"}],operator:[{required:!0,message:"请选择录入员"}],validityPeriod:[{required:!0,message:"请选择有效期"}]},T=i(null),z=()=>{T.value&&(clearTimeout(T.value),T.value=null)},f=async()=>{if(S.value)return;S.value=!0,z();const n=new Promise((l,r)=>{T.value=setTimeout(()=>{r(new Error("请求超时"))},5e3)});try{const l=new Promise(m=>{setTimeout(()=>{m(Le)},300)}),r=await Promise.race([l,n]);E.value=r,w.value.total=100}catch(l){_.error(l.message||"获取数据失败")}finally{S.value=!1,z()}},O=$e();Q(()=>{f(),W(),O.query.showCreateModal==="true"&&(b.value=!0,O.query.templateId&&(o.value.templateId=O.query.templateId,o.value.name=O.query.templateName))}),Ie(()=>{z()});const oe=()=>{w.value.current=1,f()},ne=n=>{w.value.current=n,f()},se=n=>{w.value.pageSize=n,w.value.current=1,f()},ie=n=>({草稿:"gray",待审核:"blue",生效中:"green",票劵停发:"orange",票劵失效:"gray"})[n]||"blue",W=async()=>{try{const{templateMockData:n}=await De(async()=>{const{templateMockData:l}=await import("./coupon-BKFb4O9B.js");return{templateMockData:l}},[]);q.value=n.map(l=>({id:l.id,name:l.name}))}catch{_.error("获取券模版失败")}},ue=n=>{const l=q.value.find(r=>r.id===n);l&&(o.value.name=`${l.name}-${new Date().getFullYear()}${String(new Date().getMonth()+1).padStart(2,"0")}`)},F=()=>{var n;(n=M.value)==null||n.resetFields(),b.value=!1},j=async()=>{const{error:n}=await M.value.validate();if(n)return!1;try{return _.success("创建成功"),F(),f(),!0}catch{return _.error("创建失败"),!1}},de=n=>{const l=n.status==="已暂停"?"启用":"暂停";U.warning({title:`确认${l}`,content:`确定要${l}「${n.name}」吗？`,onOk:async()=>{try{_.success(`${l}成功`),f()}catch{_.error(`${l}失败`)}}})},re=n=>{B.push(`/marketing/coupon/management/edit/${n.id}`)},me=n=>{var l;U.confirm({title:"确认上线",content:`
      确定要上线「${n.name}」吗？
        审核人：${((l=J.value.find(r=>r.id===n.auditor))==null?void 0:l.name)||"未指定"}
      
    `,onOk:async()=>{try{_.success("上线成功"),f()}catch{_.error("上线失败")}}})},ce=n=>{U.confirm({title:"确认撤回",content:`确定要撤回「${n.name}」的审核申请吗？`,onOk:async()=>{try{_.success("撤回成功"),f()}catch{_.error("撤回失败")}}})},pe=n=>{U.confirm({title:"确认删除",content:`确定要删除券包「${n.name}」吗？`,onOk:async()=>{try{_.success("删除成功"),await f()}catch{_.error("删除失败")}}})};return Q(()=>{f(),W()}),(n,l)=>{const r=s("a-input-search"),m=s("a-button"),g=s("a-space"),C=s("a-tag"),N=s("a-link"),k=s("a-tooltip"),x=s("a-table-column"),_e=s("a-table"),K=s("a-option"),Y=s("a-select"),p=s("a-form-item"),y=s("a-grid-item"),G=s("a-input"),$=s("a-input-number"),ve=s("a-alert"),H=s("a-radio"),fe=s("a-radio-group"),ye=s("a-range-picker"),he=s("a-grid"),ge=s("a-textarea"),xe=s("a-card"),we=s("a-form"),ke=s("a-modal");return h(),I("div",Ue,[Me,d("div",ze,[a(g,null,{default:t(()=>[a(r,{modelValue:R.value,"onUpdate:modelValue":l[0]||(l[0]=e=>R.value=e),placeholder:"搜索券名称",style:{width:"300px"},onSearch:oe},null,8,["modelValue"]),a(m,{type:"primary",onClick:l[1]||(l[1]=e=>b.value=!0)},{icon:t(()=>[a(X(Oe))]),default:t(()=>[u(" 新建券 ")]),_:1})]),_:1})]),a(_e,{data:E.value,loading:S.value,pagination:w.value,onPageChange:ne,onPageSizeChange:se,bordered:!0,stripe:!0},{columns:t(()=>[a(x,{title:"券名称","data-index":"name",width:220},{cell:t(({record:e})=>[a(k,{content:e.name,position:"top"},{default:t(()=>[a(g,null,{default:t(()=>[a(C,{color:e.type==="满减券"?"blue":"green"},{default:t(()=>[u(v(e.type),1)]),_:2},1032,["color"]),a(N,{onClick:V=>A(e),style:{color:"rgb(var(--primary-6))","white-space":"nowrap",overflow:"hidden","text-overflow":"ellipsis",display:"block"}},{default:t(()=>[u(v(e.name),1)]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1032,["content"])]),_:1}),a(x,{title:"状态","data-index":"status",width:150,align:"center",filterable:{filters:[{text:"草稿",value:"草稿"},{text:"待审核",value:"待审核"},{text:"生效中",value:"生效中"},{text:"已暂停",value:"已暂停"},{text:"已失效",value:"已失效"}]}},{cell:t(({record:e})=>[a(C,{color:ie(e.status)},{default:t(()=>[u(v(e.status),1)]),_:2},1032,["color"])]),_:1}),a(x,{title:"库存","data-index":"stock",width:120,align:"center"},{cell:t(({record:e})=>[a(k,{content:`初始化: ${e.unclaimed||0}
已领取: ${e.claimed||0}
已锁定: ${e.locked||0}
已核销: ${e.used||0}
已过期: ${e.expired||0}
已作废: ${e.invalid||0}`,position:"top","mouse-enter-delay":100,"mouse-leave-delay":100},{default:t(()=>[d("span",Fe,v(e.stock),1)]),_:2},1032,["content"])]),_:1}),a(x,{title:"下发比例",width:150,align:"center"},{cell:t(({record:e})=>[u(v((e.claimed/e.stock*100).toFixed(2))+"% ",1)]),_:1}),a(x,{title:"有效期","data-index":"validity",width:220},{cell:t(({record:e})=>[a(k,{content:`${new Date(e.startTime).toISOString().split("T")[0]} - ${new Date(e.endTime).toISOString().split("T")[0]}`,position:"top"},{default:t(()=>[d("span",Ne,v(new Date(e.startTime).toISOString().split("T")[0])+" - "+v(new Date(e.endTime).toISOString().split("T")[0]),1)]),_:2},1032,["content"])]),_:1}),a(x,{title:"录入员","data-index":"operator",width:150,filterable:{filters:ae.value.map(e=>({text:e.name,value:e.id}))}},{cell:t(({record:e})=>[u(v(e.operator),1)]),_:1},8,["filterable"]),a(x,{title:"操作",fixed:"right",width:150},{cell:t(({record:e})=>[a(g,null,{default:t(()=>[e.status==="草稿"?(h(),I(P,{key:0},[a(m,{type:"text",size:"small",onClick:V=>re(e)},{default:t(()=>[u("编辑")]),_:2},1032,["onClick"]),a(m,{type:"text",size:"small",onClick:V=>me(e)},{default:t(()=>[u("上线")]),_:2},1032,["onClick"]),a(m,{type:"text",size:"small",status:"danger",onClick:V=>pe(e)},{default:t(()=>[u("删除")]),_:2},1032,["onClick"])],64)):e.status==="待审核"?(h(),L(m,{key:1,type:"text",size:"small",onClick:V=>ce(e)},{default:t(()=>[u("撤回")]),_:2},1032,["onClick"])):e.status==="生效中"?(h(),I(P,{key:2},[a(m,{type:"text",size:"small",onClick:V=>A(e)},{default:t(()=>[u("详情")]),_:2},1032,["onClick"]),a(m,{type:"text",size:"small",onClick:V=>de(e)},{default:t(()=>[u("暂停")]),_:2},1032,["onClick"])],64)):Z("",!0)]),_:2},1024)]),_:1})]),_:1},8,["data","loading","pagination"]),a(ke,{visible:b.value,"onUpdate:visible":l[14]||(l[14]=e=>b.value=e),title:"创建券库存",onCancel:F,onBeforeOk:j,footer:!1,width:800},{default:t(()=>[d("div",Be,[Ee,a(we,{ref_key:"formRef",ref:M,model:o.value,rules:le,layout:"vertical",style:{maxWidth:"720px"}},{default:t(()=>[a(xe,{class:"section-card"},{default:t(()=>[a(he,{cols:2,"col-gap":16,"row-gap":16},{default:t(()=>[a(y,null,{default:t(()=>[a(p,{field:"templateId",label:"券模版",required:""},{help:t(()=>[Re]),default:t(()=>[a(Y,{modelValue:o.value.templateId,"onUpdate:modelValue":l[2]||(l[2]=e=>o.value.templateId=e),placeholder:"请选择券模版","allow-clear":"",onChange:ue},{default:t(()=>[(h(!0),I(P,null,ee(q.value,e=>(h(),L(K,{key:e.id,value:e.id},{default:t(()=>[u(v(e.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(y,null,{default:t(()=>[a(p,{field:"auditor",label:"审核员",required:""},{help:t(()=>[Ae]),default:t(()=>[a(Y,{modelValue:o.value.auditor,"onUpdate:modelValue":l[3]||(l[3]=e=>o.value.auditor=e),placeholder:"请选择审核员","allow-clear":""},{default:t(()=>[(h(!0),I(P,null,ee(J.value,e=>(h(),L(K,{key:e.id,value:e.id},{default:t(()=>[u(v(e.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(y,null,{default:t(()=>[a(p,{field:"operator",label:"录入员",required:""},{help:t(()=>[Je]),default:t(()=>[a(G,{modelValue:o.value.operator,"onUpdate:modelValue":l[4]||(l[4]=e=>o.value.operator=e),readonly:"",disabled:""},null,8,["modelValue"])]),_:1})]),_:1}),a(y,null,{default:t(()=>[a(p,{field:"name",label:"券名称",required:""},{help:t(()=>[We]),default:t(()=>[a(G,{modelValue:o.value.name,"onUpdate:modelValue":l[5]||(l[5]=e=>o.value.name=e),placeholder:"请输入券名称","allow-clear":""},null,8,["modelValue"])]),_:1})]),_:1}),a(y,null,{default:t(()=>[a(p,{field:"totalCount",label:"发放数量",required:""},{help:t(()=>[je]),default:t(()=>[a($,{modelValue:o.value.totalCount,"onUpdate:modelValue":l[6]||(l[6]=e=>o.value.totalCount=e),placeholder:"请输入发放数量",min:1,max:999999,step:1},null,8,["modelValue"])]),_:1})]),_:1}),a(y,null,{default:t(()=>[a(p,{field:"dailyLimit",label:"单日发放上限"},{help:t(()=>[Ke]),default:t(()=>[a($,{modelValue:o.value.dailyLimit,"onUpdate:modelValue":l[7]||(l[7]=e=>o.value.dailyLimit=e),placeholder:"请输入单日发放上限",min:1,max:o.value.totalCount,step:1},null,8,["modelValue","max"])]),_:1})]),_:1}),a(y,null,{default:t(()=>[a(p,{field:"weeklyLimit",label:"单周发放上限"},{help:t(()=>[Ye]),default:t(()=>[a($,{modelValue:o.value.weeklyLimit,"onUpdate:modelValue":l[8]||(l[8]=e=>o.value.weeklyLimit=e),placeholder:"请输入单周发放上限",min:1,max:o.value.totalCount,step:1},null,8,["modelValue","max"])]),_:1})]),_:1}),a(y,null,{default:t(()=>[a(p,{field:"monthlyLimit",label:"单月发放上限"},{help:t(()=>[Ge]),default:t(()=>[a($,{modelValue:o.value.monthlyLimit,"onUpdate:modelValue":l[9]||(l[9]=e=>o.value.monthlyLimit=e),placeholder:"请输入单月发放上限",min:1,max:o.value.totalCount,step:1},null,8,["modelValue","max"])]),_:1})]),_:1}),a(y,{span:24},{default:t(()=>[a(ve,{type:"info"},{icon:t(()=>[a(X(Pe)),u(" 【规则提示】相同名称的优惠券每个用户仅可领取一次 ")]),default:t(()=>[u(" "+v(o.value.userLimitDesc),1)]),_:1})]),_:1}),a(y,null,{default:t(()=>[a(p,{field:"validityType",label:"有效期类型",required:""},{help:t(()=>[He]),default:t(()=>[a(fe,{modelValue:o.value.validityType,"onUpdate:modelValue":l[10]||(l[10]=e=>o.value.validityType=e)},{default:t(()=>[a(H,{value:"absolute"},{default:t(()=>[u("绝对有效期")]),_:1}),a(H,{value:"relative"},{default:t(()=>[u("相对有效期")]),_:1})]),_:1},8,["modelValue"])]),_:1}),a(p,{field:"validity",label:"有效期",required:""},{help:t(()=>[Qe]),default:t(()=>[a(ye,{modelValue:o.value.validity,"onUpdate:modelValue":l[11]||(l[11]=e=>o.value.validity=e),"show-time":"",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),o.value.validityType==="relative"?(h(),L(p,{key:0,field:"relativeDays",label:"相对有效期",required:""},{help:t(()=>[Xe]),default:t(()=>[a($,{modelValue:o.value.relativeDays,"onUpdate:modelValue":l[12]||(l[12]=e=>o.value.relativeDays=e),min:1,max:45,step:1,style:{width:"100%"}},null,8,["modelValue"])]),_:1})):Z("",!0)]),_:1})]),_:1}),a(p,{field:"rules",label:"使用规则说明"},{help:t(()=>[Ze]),default:t(()=>[a(ge,{modelValue:o.value.rules,"onUpdate:modelValue":l[13]||(l[13]=e=>o.value.rules=e),placeholder:"请输入使用规则说明","max-length":200,"show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["model"]),d("div",et,[a(g,null,{default:t(()=>[a(m,{type:"primary",onClick:j},{default:t(()=>[u("确认创建")]),_:1}),a(m,{onClick:F},{default:t(()=>[u("取消")]),_:1})]),_:1})])])]),_:1},8,["visible"])])}}},nt=Ve(tt,[["__scopeId","data-v-16d5f89f"]]);export{nt as default};
