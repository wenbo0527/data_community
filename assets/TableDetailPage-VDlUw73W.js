import{a as Z}from"./data-map-BtHUnIhr.js";import{A as ke,B as Q,c as x,o as g,h as we,C as Te,n as he,D as Fe,a as W,E as xe,r as b,p as $e,K as pe,e as u,f as e,w as t,j as c,i as h,x as De,F as se,m as re,d as H,t as R,N as G,_ as de,ae as _e,af as Ie,ag as Se,u as Ne,J as Re,ah as Ve,a6 as ze,g as me,R as Le}from"./index-CsgcdrY7.js";import{I as Ee}from"./index-D3r115Ij.js";import{I as Me}from"./index-Cf7xlEWt.js";import{I as Ae}from"./index-B8gm8_GQ.js";const qe=Q({name:"IconExclamationCircle",props:{size:{type:[Number,String]},strokeWidth:{type:Number,default:4},strokeLinecap:{type:String,default:"butt",validator:d=>["butt","round","square"].includes(d)},strokeLinejoin:{type:String,default:"miter",validator:d=>["arcs","bevel","miter","miter-clip","round"].includes(d)},rotate:Number,spin:Boolean},emits:{click:d=>!0},setup(d,{emit:C}){const o=Fe("icon"),m=W(()=>[o,`${o}-exclamation-circle`,{[`${o}-spin`]:d.spin}]),k=W(()=>{const y={};return d.size&&(y.fontSize=xe(d.size)?`${d.size}px`:d.size),d.rotate&&(y.transform=`rotate(${d.rotate}deg)`),y});return{cls:m,innerStyle:k,onClick:y=>{C("click",y)}}}}),Ue=["stroke-width","stroke-linecap","stroke-linejoin"];function Be(d,C,o,m,k,i){return g(),x("svg",{viewBox:"0 0 48 48",fill:"none",xmlns:"http://www.w3.org/2000/svg",stroke:"currentColor",class:he(d.cls),style:Te(d.innerStyle),"stroke-width":d.strokeWidth,"stroke-linecap":d.strokeLinecap,"stroke-linejoin":d.strokeLinejoin,onClick:C[0]||(C[0]=(...y)=>d.onClick&&d.onClick(...y))},C[1]||(C[1]=[we("path",{d:"M24 28V14m0 16v4M6 24c0-9.941 8.059-18 18-18s18 8.059 18 18-8.059 18-18 18S6 33.941 6 24Z"},null,-1)]),14,Ue)}var ie=ke(qe,[["render",Be]]);const Pe=Object.assign(ie,{install:(d,C)=>{var o;const m=(o=C==null?void 0:C.iconPrefix)!=null?o:"";d.component(m+ie.name,ie)}}),We={class:"relation-editor-panel"},je=Q({__name:"RelationEditorPanel",props:{fieldName:{},initialRelations:{}},emits:["save-relations"],setup(d,{emit:C}){const o=d,m=b([]),k=b([]),i=b(!1),y=b(!1),r=$e({targetTable:"",relationField:"",relationType:"",relationDescription:""}),V=b(null);pe(()=>o.initialRelations,$=>{m.value=[...$]},{immediate:!0,deep:!0}),k.value=[{name:"dim_user",type:"dimension",category:"",domain:"",updateFrequency:"",owner:"",description:"",fields:[]},{name:"fact_loan_apply",type:"fact",category:"",domain:"",updateFrequency:"",owner:"",description:"",fields:[]},{name:"dws_risk_score",type:"dws",category:"",domain:"",updateFrequency:"",owner:"",description:"",fields:[]},{name:"dwd_fraud_alert",type:"dwd",category:"",domain:"",updateFrequency:"",owner:"",description:"",fields:[]},{name:"dim_product",type:"dimension",category:"",domain:"",updateFrequency:"",owner:"",description:"",fields:[]}];const L=()=>{y.value=!1,V.value=null,r.targetTable="",r.relationField=o.fieldName,r.relationType="",r.relationDescription="",i.value=!0},E=($,w)=>{y.value=!0,V.value=w,r.targetTable=$.targetTable,r.relationField=$.relationField,r.relationType=$.relationType||"",r.relationDescription=$.relationDescription||"",i.value=!0},z=$=>{G.confirm({title:"确认删除",content:"确定要删除这条关联关系吗？",onOk:()=>{m.value.splice($,1),C("save-relations",m.value)}})},A=()=>{!r.targetTable||!r.relationField||(y.value&&V.value!==null?m.value[V.value]={...r}:m.value.push({...r}),C("save-relations",m.value),i.value=!1)},q=()=>{i.value=!1};return($,w)=>{const U=u("a-button"),S=u("a-table-column"),j=u("a-space"),B=u("a-table"),N=u("a-option"),O=u("a-select"),M=u("a-form-item"),X=u("a-input"),Y=u("a-textarea"),ee=u("a-form"),P=u("a-modal");return g(),x("div",We,[e(j,{direction:"vertical",style:{width:"100%"}},{default:t(()=>[e(U,{type:"primary",size:"mini",onClick:L},{icon:t(()=>[e(h(De))]),default:t(()=>[c(" 新增关联 ")]),_:1}),e(B,{data:m.value,bordered:!1,pagination:!1},{columns:t(()=>[e(S,{title:"关联表",dataIndex:"targetTable"}),e(S,{title:"关联字段",dataIndex:"relationField"}),e(S,{title:"关联类型",dataIndex:"relationType"}),e(S,{title:"关联说明",dataIndex:"relationDescription"}),e(S,{title:"操作"},{cell:t(({record:f,rowIndex:K})=>[e(j,null,{default:t(()=>[e(U,{type:"text",size:"mini",onClick:ae=>E(f,K)},{default:t(()=>[c("编辑")]),_:2},1032,["onClick"]),e(U,{type:"text",size:"mini",status:"danger",onClick:ae=>z(K)},{default:t(()=>[c("删除")]),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])]),_:1}),e(P,{visible:i.value,"onUpdate:visible":w[4]||(w[4]=f=>i.value=f),title:y.value?"编辑关联关系":"新增关联关系",onOk:A,onCancel:q},{default:t(()=>[e(ee,{model:r,layout:"vertical"},{default:t(()=>[e(M,{label:"关联表",field:"targetTable",required:""},{default:t(()=>[e(O,{modelValue:r.targetTable,"onUpdate:modelValue":w[0]||(w[0]=f=>r.targetTable=f),placeholder:"请选择关联表","allow-search":"",disabled:y.value},{default:t(()=>[(g(!0),x(se,null,re(k.value,f=>(g(),H(N,{key:f.name,value:f.name},{default:t(()=>[c(R(f.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),e(M,{label:"关联字段",field:"relationField",required:""},{default:t(()=>[e(X,{modelValue:r.relationField,"onUpdate:modelValue":w[1]||(w[1]=f=>r.relationField=f),placeholder:"请输入关联字段"},null,8,["modelValue"])]),_:1}),e(M,{label:"关联类型",field:"relationType"},{default:t(()=>[e(O,{modelValue:r.relationType,"onUpdate:modelValue":w[2]||(w[2]=f=>r.relationType=f),placeholder:"请选择关联类型"},{default:t(()=>[e(N,{value:"主表关联"},{default:t(()=>[c("主表关联")]),_:1}),e(N,{value:"维度-事实关联"},{default:t(()=>[c("维度-事实关联")]),_:1}),e(N,{value:"维度-汇总关联"},{default:t(()=>[c("维度-汇总关联")]),_:1}),e(N,{value:"字段关联"},{default:t(()=>[c("字段关联")]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(M,{label:"关联说明",field:"relationDescription"},{default:t(()=>[e(Y,{modelValue:r.relationDescription,"onUpdate:modelValue":w[3]||(w[3]=f=>r.relationDescription=f),placeholder:"请输入关联说明","auto-size":{minRows:2,maxRows:4}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["visible","title"])])}}}),Oe=de(je,[["__scopeId","data-v-3d910bd3"]]),Ke=Q({__name:"AddToCollectionModal",props:{collections:{},initialSelectedCollection:{}},emits:["select-collection"],setup(d,{emit:C}){const o=d,m=b(o.initialSelectedCollection);_e(()=>{m.value=o.initialSelectedCollection});const k=i=>{m.value=i,C("select-collection",i)};return(i,y)=>(g(),x("div",null,[e(h(Se),{"model-value":m.value,placeholder:"请选择集合",style:{width:"100%"},"allow-clear":"",onChange:k},{default:t(()=>[(g(!0),x(se,null,re(i.collections,r=>(g(),H(h(Ie),{key:r.value,value:r.value,label:r.label},{default:t(()=>[c(R(r.label),1)]),_:2},1032,["value","label"]))),128))]),_:1},8,["model-value"])]))}}),Je=de(Ke,[["__scopeId","data-v-e41eace6"]]),Ze={class:"table-detail-page"},Ge={key:0,class:"table-content"},He={key:1},Qe={key:0},Xe={key:1},Ye={key:1,class:"empty-state"},ea=Q({__name:"TableDetailPage",setup(d){const o={debug:(a,...l)=>!1,info:(a,...l)=>!1,warn:(a,...l)=>a.includes("关联")&&console.warn(`[TableDetail] ${a}:`,...l),error:(a,...l)=>console.error(`[TableDetail] ${a}:`,...l)},m=Ne(),k=Re(),i=b(),y=a=>{k.push(`/discovery/data-map/table/${encodeURIComponent(a.name)}`)},r=b(!1),V=b(!1),L=b([]),E=b(),z=b("structure"),A=b([]),q=b(""),$=W(()=>{if(!i.value)return[];const a=i.value;return[{label:"表名",value:a.name},{label:"类型",value:a.type},{label:"分类",value:a.category},{label:"领域",value:a.domain},{label:"更新频率",value:a.updateFrequency},{label:"负责人",value:a.owner},{label:"创建时间",value:a.createTime||"N/A"},{label:"最后更新时间",value:a.lastUpdateTime||"N/A"}]});W(()=>{var l,n,s,v;const a=((n=(l=i.value)==null?void 0:l.fields)==null?void 0:n.filter(p=>["id","user_id","product_id"].includes(p.name.toLowerCase())))||[];return o.debug("关联字段解析",{totalFields:((v=(s=i.value)==null?void 0:s.fields)==null?void 0:v.length)||0,matchedFields:a.map(p=>p.name)}),a});const w=W(()=>{var a,l;return q.value?`${(a=i.value)==null?void 0:a.name} 与 ${q.value} 的关联关系`:`${((l=E==null?void 0:E.value)==null?void 0:l.name)||""} 关联表`});_e(()=>{var l;const a=Array.isArray(m.params.table)?m.params.table[0]:m.params.table||Array.isArray(m.params.tableName)?m.params.tableName[0]:m.params.tableName;o.debug("路由参数",{tableParam:a}),a?(i.value=U(a)||S({}),o.debug("解析表数据",{name:(l=i.value)==null?void 0:l.name})):i.value=S({})});function U(a){try{const l=decodeURIComponent(a);try{return JSON.parse(l)}catch{const n=Z.find(s=>s.name===l);return n?S(l==="dim_user"?{...n,rowCount:1e6,createTime:"2023-01-01",lastUpdateTime:"2024-01-15",storageSize:"500MB",collectionOwner:"数据治理组",type:"dimension",category:"用户数据",domain:"用户域",updateFrequency:"每日更新",owner:"张三"}:n):void 0}}catch(l){o.warn("解析表数据失败",l);return}}function S(a){return{name:"",type:"",category:"",domain:"",updateFrequency:"",owner:"",description:"",fields:[],...a}}pe(i,a=>{var l;if(!a||!((l=a.fields)!=null&&l.length)){o.debug("样本数据重置","表数据为空或无字段"),L.value=[];return}try{L.value=Array(2).fill(0).map((n,s)=>{const v={id:s+1};return a.fields.forEach(p=>{p!=null&&p.name&&(v[p.name]=`mock_${p.name}_${s+1}`)}),v}),o.debug("样本数据生成",{count:L.value.length})}catch(n){o.error("样本数据生成失败",n),L.value=[]}},{immediate:!0,deep:!0});const j=()=>{r.value=!r.value},B=b([{label:"常用表集合",value:"common"},{label:"个人收藏",value:"personal"},{label:"项目表集合",value:"project"},{label:"部门表集合",value:"department"}]),N=b(""),O=()=>{var l;o.debug("showAddToCollection called"),o.debug("打开添加到集合弹窗",{table:(l=i.value)==null?void 0:l.name}),o.debug("集合数据",{collections:B.value,selectedCollection:N.value});const a=n=>{var s,v,p,D;if(o.debug("handleSelect called",{value:n}),!n){o.warn("用户未选择集合",{table:(s=i.value)==null?void 0:s.name}),G.error({title:"错误",content:"请选择要添加到的集合"});return}o.info("添加到集合",{table:(v=i.value)==null?void 0:v.name,collection:n,collectionLabel:((p=B.value.find(I=>I.value===n))==null?void 0:p.label)||""}),G.success({title:"成功",content:"已添加到集合"}),o.debug("成功添加到集合",{table:(D=i.value)==null?void 0:D.name,collection:n}),N.value=n};G.info({title:"添加到集合",content:()=>Le(Je,{collections:B.value,initialSelectedCollection:N.value,"onSelect-collection":a}),onClose:()=>{var n;o.debug("用户关闭添加到集合弹窗",{table:(n=i.value)==null?void 0:n.name,selected:N.value})}})},M=()=>{var a;o.info("申请权限",(a=i.value)==null?void 0:a.name)},X=a=>{var n;console.group("关联字段处理"),o.debug("开始处理关联字段",{field:a.name,fieldType:a.type,currentTable:(n=i.value)==null?void 0:n.name}),E.value=a,q.value="";const l=Y(a);o.debug("获取关联表结果",{fieldName:a.name,matchedTables:l.map(s=>s.name),totalCount:l.length}),A.value=l.map(s=>{var D,I;const v=fe(((D=i.value)==null?void 0:D.name)||"",s.name),p=be(((I=i.value)==null?void 0:I.name)||"",s.name,a.name);return o.debug("处理关联表信息",{tableName:s.name,relationType:v,relationDescription:p}),{...s,relationField:a.name,relationType:v,relationDescription:p}}),V.value=!0,z.value="view",o.info("关联表查询完成",{field:a.name,count:l.length,relations:A.value.map(s=>`${s.name}(${s.relationType})`)}),console.groupEnd()},Y=a=>{console.group("获取关联表"),o.debug("开始查找关联表",{fieldName:a.name,isRelationField:["id","user_id"].includes(a.name.toLowerCase())});let l=[];return["id","user_id"].includes(a.name.toLowerCase())&&(l=Z.filter(n=>{var v;const s=(v=n.fields)==null?void 0:v.some(p=>p.name.toLowerCase()===a.name.toLowerCase());return o.debug("检查表字段匹配",{tableName:n.name,hasMatchingField:s,matchedField:a.name}),s})),o.debug("关联表查找完成",{fieldName:a.name,matchedTables:l.map(n=>n.name),totalMatches:l.length}),console.groupEnd(),l},ee=a=>{const l={dim:"#165DFF",fact:"#FF7D00",dwd:"#722ED1",dws:"#0FC6C2",ads:"#F5319D"},n=a.toLowerCase();return l[n]||"#86909C"},P=b(null),f=b([]),K=a=>{o.debug("编辑字段关联关系",{fieldName:a.name}),P.value=a,f.value=ve(a.name),V.value=!0,z.value="edit"},ae=a=>{var l;o.info("保存关联关系",{field:(l=P.value)==null?void 0:l.name,relations:a})},ve=a=>a.toLowerCase()==="user_id"?[{targetTable:"fact_loan_apply",relationField:"user_id",relationType:"维度-事实关联",relationDescription:"提供申请人基础信息"},{targetTable:"dws_risk_score",relationField:"user_id",relationType:"维度-汇总关联",relationDescription:"提供用户基础画像数据"}]:a.toLowerCase()==="id"?[{targetTable:"dim_product",relationField:"product_id",relationType:"字段关联",relationDescription:"关联产品信息"}]:[],fe=(a,l)=>{var v,p,D,I;if(!a||!l)return"字段关联";const n=((p=(v=Z.find(T=>T.name===a))==null?void 0:v.type)==null?void 0:p.toLowerCase())||"",s=((I=(D=Z.find(T=>T.name===l))==null?void 0:D.type)==null?void 0:I.toLowerCase())||"";return n==="dim"&&s.startsWith("fact")?"维度-事实关联":n==="dim"&&(s.startsWith("dwd")||s.startsWith("dws"))?"维度-汇总关联":n.startsWith("fact")&&s==="dim"?"事实-维度关联":(n.startsWith("dwd")||n.startsWith("dws"))&&s==="dim"?"汇总-维度关联":"字段关联"},be=(a,l,n)=>{if(a==="dim_user"){if(l==="fact_loan_apply")return"提供申请人基础信息";if(l==="dws_risk_score")return"提供用户基础画像数据";if(l==="dwd_fraud_alert")return"提供欺诈风险信息"}else if(l==="dim_user")return"获取用户基础信息";return"数据关联"};return(a,l)=>{var ue;const n=u("a-button"),s=u("a-space"),v=u("a-page-header"),p=u("a-descriptions"),D=u("a-card"),I=u("a-link"),T=u("a-table-column"),te=u("a-table"),le=u("a-tab-pane"),ne=u("a-typography-paragraph"),J=u("a-tag"),ce=u("a-alert"),ye=u("a-tabs"),ge=u("a-modal"),Ce=u("a-empty");return g(),x("div",Ze,[e(v,{title:((ue=i.value)==null?void 0:ue.name)||"未命名表",onBack:l[0]||(l[0]=_=>h(k).go(-1)),class:"page-header"},{extra:t(()=>[e(s,null,{default:t(()=>[e(n,{type:"outline",size:"mini",onClick:j},{icon:t(()=>[e(h(Ee),{fill:r.value?"#ffb400":"none"},null,8,["fill"])]),default:t(()=>[c(" 收藏 ")]),_:1}),e(n,{type:"outline",size:"mini",onClick:O},{icon:t(()=>[e(h(Me))]),default:t(()=>[c(" 添加到集合 ")]),_:1}),e(n,{type:"primary",size:"mini",onClick:M},{icon:t(()=>[e(h(Ve))]),default:t(()=>[c(" 申请权限 ")]),_:1})]),_:1})]),_:1},8,["title"]),i.value?(g(),x("div",Ge,[e(D,{class:"table-info"},{default:t(()=>[e(p,{column:2,data:$.value},null,8,["data"])]),_:1}),e(D,{class:"tab-content"},{default:t(()=>[e(ye,{type:"rounded","active-key":z.value,"onUpdate:activeKey":l[5]||(l[5]=_=>z.value=_)},{default:t(()=>[e(le,{key:"structure",title:"表结构"},{default:t(()=>[e(te,{data:i.value.fields||[],bordered:!1,pagination:!1},{columns:t(()=>[e(T,{title:"字段名",dataIndex:"name"},{cell:t(({record:_})=>[["id","user_id"].includes(_.name.toLowerCase())?(g(),H(I,{key:0,onClick:F=>X(_)},{default:t(()=>[c(R(_.name),1)]),_:2},1032,["onClick"])):(g(),x("span",He,R(_.name),1))]),_:1}),e(T,{title:"类型",dataIndex:"type"}),e(T,{title:"描述",dataIndex:"description"}),e(T,{title:"操作"},{cell:t(({record:_})=>[e(n,{type:"text",size:"mini",onClick:F=>K(_)},{default:t(()=>[c("编辑关联关系")]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1}),e(le,{key:"preview",title:"数据预览"},{default:t(()=>[e(te,{data:L.value,bordered:!1,pagination:!1},{columns:t(()=>[(g(!0),x(se,null,re(i.value.fields,_=>(g(),H(T,{key:_.name,title:_.name,dataIndex:_.name},null,8,["title","dataIndex"]))),128))]),_:1},8,["data"])]),_:1}),e(le,{key:"usage",title:"使用说明"},{default:t(()=>[e(ne,null,{default:t(()=>[c(R(i.value.description||"暂无使用说明")+" ",1),e(I,{copyable:""},{default:t(()=>[c(" /discovery/data-map/table/dim_user ")]),_:1}),e(n,{type:"primary",size:"small",style:{"margin-left":"8px"},onClick:l[1]||(l[1]=_=>h(k).push("/discovery/data-map/table/dim_user"))},{icon:t(()=>[e(h(ze))]),default:t(()=>[c(" 访问示例 ")]),_:1})]),_:1}),e(ne,null,{default:t(()=>[e(ce,{type:"info"},{icon:t(()=>[e(h(Ae))]),message:t(()=>[c(" 您可以将表名替换为任意有效的表名，例如： "),e(s,null,{default:t(()=>[e(J,{color:"#165DFF",style:{cursor:"pointer"},onClick:l[2]||(l[2]=_=>h(k).push("/discovery/data-map/table/fact_loan_apply"))},{default:t(()=>[c("fact_loan_apply")]),_:1}),e(J,{color:"#722ED1",style:{cursor:"pointer"},onClick:l[3]||(l[3]=_=>h(k).push("/discovery/data-map/table/dwd_fraud_alert"))},{default:t(()=>[c("dwd_fraud_alert")]),_:1}),e(J,{color:"#0FC6C2",style:{cursor:"pointer"},onClick:l[4]||(l[4]=_=>h(k).push("/discovery/data-map/table/dws_risk_score"))},{default:t(()=>[c("dws_risk_score")]),_:1})]),_:1})]),_:1})]),_:1}),e(ne,null,{default:t(()=>[e(ce,{type:"warning"},{icon:t(()=>[e(h(Pe))]),message:t(()=>[c(' 注意：请确保您有访问相应表的权限。如果没有权限，您可以点击页面右上角的"申请权限"按钮。 ')]),_:1})]),_:1})]),_:1})]),_:1},8,["active-key"])]),_:1}),e(ge,{visible:V.value,"onUpdate:visible":l[6]||(l[6]=_=>V.value=_),title:w.value,width:"800px"},{default:t(()=>{var _;return[z.value==="view"?(g(),x("div",Qe,[e(te,{data:A.value,bordered:!1},{columns:t(()=>[e(T,{title:"表名",dataIndex:"name"},{cell:t(({record:F})=>[e(I,{onClick:oe=>y(F)},{default:t(()=>[c(R(F.name),1)]),_:2},1032,["onClick"])]),_:1}),e(T,{title:"类型",dataIndex:"type"},{cell:t(({record:F})=>[e(J,{color:ee(F.type)},{default:t(()=>[c(R(F.type),1)]),_:2},1032,["color"])]),_:1}),e(T,{title:"关联字段",dataIndex:"relationField"},{cell:t(({record:F})=>{var oe;return[c(R(((oe=E.value)==null?void 0:oe.name)||"user_id"),1)]}),_:1}),e(T,{title:"关联类型",dataIndex:"relationType"},{cell:t(({record:F})=>[c(R(F.relationType||"主表关联"),1)]),_:1}),e(T,{title:"关联说明",dataIndex:"relationDescription"},{cell:t(({record:F})=>[c(R(F.relationDescription||"提供数据关联"),1)]),_:1})]),_:1},8,["data"])])):me("",!0),z.value==="edit"?(g(),x("div",Xe,[e(Oe,{"field-name":((_=P.value)==null?void 0:_.name)||"","initial-relations":f.value,onSaveRelations:ae},null,8,["field-name","initial-relations"])])):me("",!0)]}),_:1},8,["visible","title"])])):(g(),x("div",Ye,[e(Ce,{description:"请选择一个数据表查看详情"})]))])}}}),ia=de(ea,[["__scopeId","data-v-b6c32f7c"]]);export{ia as default};
