<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>预览线功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #40a9ff;
        }
        .log-output {
            background: #f6f6f6;
            border: 1px solid #d9d9d9;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>预览线生成功能测试</h1>
        <p>此页面用于测试修复后的预览线生成功能</p>
        
        <div>
            <button class="test-button" onclick="testPreviewLineManager()">测试预览线管理器</button>
            <button class="test-button" onclick="testNodeCreation()">测试节点创建</button>
            <button class="test-button" onclick="testPreviewLineGeneration()">测试预览线生成</button>
            <button class="test-button" onclick="clearLogs()">清除日志</button>
        </div>
        
        <div id="logOutput" class="log-output"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logOutput = document.getElementById('logOutput');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? 'red' : type === 'warn' ? 'orange' : 'black';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logOutput.appendChild(logEntry);
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logOutput').innerHTML = '';
        }

        function testPreviewLineManager() {
            log('开始测试预览线管理器...');
            
            // 检查是否有全局的预览线管理器实例
            if (typeof window.unifiedPreviewLineManager !== 'undefined') {
                log('✅ 找到全局预览线管理器实例');
                log(`管理器类型: ${typeof window.unifiedPreviewLineManager}`);
                
                // 测试关键方法是否存在
                const methods = ['shouldCreatePreviewLineWithDetails', 'generateAllPreviewLines', 'regeneratePreviewLineForNode'];
                methods.forEach(method => {
                    if (typeof window.unifiedPreviewLineManager[method] === 'function') {
                        log(`✅ 方法 ${method} 存在`);
                    } else {
                        log(`❌ 方法 ${method} 不存在`, 'error');
                    }
                });
            } else {
                log('❌ 未找到全局预览线管理器实例', 'error');
                log('尝试从其他位置查找...');
                
                // 尝试从Vue应用实例中查找
                if (typeof window.__VUE_DEVTOOLS_GLOBAL_HOOK__ !== 'undefined') {
                    log('Vue开发工具可用，尝试查找Vue实例...');
                }
            }
        }

        function testNodeCreation() {
            log('开始测试节点创建...');
            
            // 模拟节点数据
            const testNodes = [
                {
                    id: 'test-start-node',
                    type: 'start-node',
                    data: { isConfigured: true },
                    position: { x: 100, y: 100 }
                },
                {
                    id: 'test-manual-call',
                    type: 'manual-call',
                    data: { isConfigured: false },
                    position: { x: 300, y: 100 }
                },
                {
                    id: 'test-sms',
                    type: 'sms',
                    data: { isConfigured: true },
                    position: { x: 500, y: 100 }
                }
            ];
            
            log(`创