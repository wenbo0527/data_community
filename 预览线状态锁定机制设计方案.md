# é¢„è§ˆçº¿çŠ¶æ€é”å®šæœºåˆ¶è®¾è®¡æ–¹æ¡ˆ

## æ¦‚è¿°

åŸºäºæ–¹æ¡ˆ1ï¼ˆå¢å¼ºç°æœ‰åè°ƒæœºåˆ¶ï¼‰ï¼Œåœ¨å¸ƒå±€å¼•æ“ä¸­å¢åŠ é¢„è§ˆçº¿çŠ¶æ€é”å®šæœºåˆ¶ï¼Œé˜²æ­¢å¸ƒå±€æ›´æ–°è¿‡ç¨‹ä¸­é¢„è§ˆçº¿åˆ·æ–°æ“ä½œäº§ç”Ÿå†²çªã€‚

## è®¾è®¡ç›®æ ‡

1. **é˜²æ­¢æ—¶åºå†²çª**ï¼šå¸ƒå±€æ›´æ–°æœŸé—´é˜»æ­¢é¢„è§ˆçº¿åˆ·æ–°æ“ä½œ
2. **ä¿æŒæ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿ç»ˆç‚¹ä½ç½®è®¡ç®—çš„å”¯ä¸€æ€§å’Œå‡†ç¡®æ€§
3. **æœ€å°åŒ–æ€§èƒ½å½±å“**ï¼šé”å®šæœºåˆ¶è½»é‡åŒ–ï¼Œä¸å½±å“æ­£å¸¸æ“ä½œæ€§èƒ½
4. **å‘åå…¼å®¹**ï¼šä¸ç ´åç°æœ‰åŠŸèƒ½å’ŒAPIæ¥å£

## æ ¸å¿ƒè®¾è®¡

### 1. é”å®šçŠ¶æ€ç®¡ç†

#### 1.1 å¸ƒå±€å¼•æ“ä¸­çš„é”å®šçŠ¶æ€
```javascript
// UnifiedStructuredLayoutEngine.js
class UnifiedStructuredLayoutEngine {
  constructor() {
    // é¢„è§ˆçº¿åˆ·æ–°é”å®šçŠ¶æ€
    this.previewLineRefreshLocked = false;
    this.lockStartTime = null;
    this.lockReason = null;
  }
  
  // é”å®šé¢„è§ˆçº¿åˆ·æ–°
  lockPreviewLineRefresh(reason = 'layout_update') {
    this.previewLineRefreshLocked = true;
    this.lockStartTime = Date.now();
    this.lockReason = reason;
    console.debug(`ğŸ”’ [å¸ƒå±€å¼•æ“] é”å®šé¢„è§ˆçº¿åˆ·æ–°: ${reason}`);
  }
  
  // è§£é”é¢„è§ˆçº¿åˆ·æ–°
  unlockPreviewLineRefresh() {
    if (this.previewLineRefreshLocked) {
      const lockDuration = Date.now() - this.lockStartTime;
      console.debug(`ğŸ”“ [å¸ƒå±€å¼•æ“] è§£é”é¢„è§ˆçº¿åˆ·æ–°ï¼Œé”å®šæ—¶é•¿: ${lockDuration}ms`);
    }
    this.previewLineRefreshLocked = false;
    this.lockStartTime = null;
    this.lockReason = null;
  }
  
  // æ£€æŸ¥æ˜¯å¦é”å®š
  isPreviewLineRefreshLocked() {
    return this.previewLineRefreshLocked;
  }
  
  // è·å–é”å®šä¿¡æ¯
  getLockInfo() {
    return {
      locked: this.previewLineRefreshLocked,
      reason: this.lockReason,
      duration: this.lockStartTime ? Date.now() - this.lockStartTime : 0
    };
  }
}
```

#### 1.2 é¢„è§ˆçº¿ç®¡ç†å™¨ä¸­çš„é”å®šæ£€æŸ¥
```javascript
// UnifiedPreviewLineManager.js
class UnifiedPreviewLineManager {
  // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰§è¡Œé¢„è§ˆçº¿åˆ·æ–°
  canRefreshPreviewLines() {
    if (!this.layoutEngine) {
      return true; // æ²¡æœ‰å¸ƒå±€å¼•æ“æ—¶å…è®¸åˆ·æ–°
    }
    
    const isLocked = this.layoutEngine.isPreviewLineRefreshLocked();
    if (isLocked) {
      const lockInfo = this.layoutEngine.getLockInfo();
      console.debug(`â¸ï¸ [é¢„è§ˆçº¿ç®¡ç†å™¨] é¢„è§ˆçº¿åˆ·æ–°è¢«é”å®š: ${lockInfo.reason}, å·²é”å®š ${lockInfo.duration}ms`);
      return false;
    }
    
    return true;
  }
  
  // å¢å¼ºçš„åˆ·æ–°æ–¹æ³•
  refreshAllPreviewLines(options = {}) {
    // æ£€æŸ¥é”å®šçŠ¶æ€
    if (!this.canRefreshPreviewLines()) {
      if (options.force) {
        console.warn('âš ï¸ [é¢„è§ˆçº¿ç®¡ç†å™¨] å¼ºåˆ¶åˆ·æ–°é¢„è§ˆçº¿ï¼ˆå¿½ç•¥é”å®šçŠ¶æ€ï¼‰');
      } else {
        console.debug('ğŸš« [é¢„è§ˆçº¿ç®¡ç†å™¨] é¢„è§ˆçº¿åˆ·æ–°è¢«é˜»æ­¢ï¼ˆé”å®šçŠ¶æ€ï¼‰');
        return;
      }
    }
    
    // æ‰§è¡ŒåŸæœ‰åˆ·æ–°é€»è¾‘
    this._performRefreshAllPreviewLines(options);
  }
  
  // åŸæœ‰åˆ·æ–°é€»è¾‘é‡å‘½å
  _performRefreshAllPreviewLines(options = {}) {
    // ç°æœ‰çš„ refreshAllPreviewLines å®ç°
    // ...
  }
}
```

### 2. å…³é”®é›†æˆç‚¹çš„é”å®šé€»è¾‘

#### 2.1 å¸ƒå±€æ›´æ–°å¼€å§‹æ—¶é”å®š
```javascript
// UnifiedStructuredLayoutEngine.js
async performLayout(nodes, options = {}) {
  try {
    // å¼€å§‹å¸ƒå±€å‰é”å®šé¢„è§ˆçº¿åˆ·æ–°
    this.lockPreviewLineRefresh('layout_update');
    
    console.log('ğŸ”„ [å¸ƒå±€å¼•æ“] å¼€å§‹æ‰§è¡Œå¸ƒå±€æ›´æ–°...');
    
    // æ‰§è¡Œå¸ƒå±€è®¡ç®—
    const layoutResult = await this._executeLayoutCalculation(nodes, options);
    
    // å¸ƒå±€å®Œæˆåçš„æ¸…ç†å·¥ä½œ
    await this.performPostLayoutCleanup();
    
    return layoutResult;
    
  } catch (error) {
    console.error('âŒ [å¸ƒå±€å¼•æ“] å¸ƒå±€æ‰§è¡Œå¤±è´¥:', error);
    throw error;
  } finally {
    // æ— è®ºæˆåŠŸå¤±è´¥éƒ½è¦è§£é”
    this.unlockPreviewLineRefresh();
  }
}
```

#### 2.2 è™šæ‹Ÿç«¯ç‚¹åˆ›å»ºæ—¶çš„é”å®š
```javascript
// UnifiedStructuredLayoutEngine.js
async createVirtualEndpoints(layerNodes) {
  // åˆ›å»ºè™šæ‹Ÿç«¯ç‚¹æœŸé—´é”å®šé¢„è§ˆçº¿åˆ·æ–°
  this.lockPreviewLineRefresh('virtual_endpoint_creation');
  
  try {
    const virtualEndpoints = await this._performVirtualEndpointCreation(layerNodes);
    
    // è™šæ‹Ÿç«¯ç‚¹åˆ›å»ºå®Œæˆåï¼Œå»¶è¿Ÿè§£é”ä»¥ç¡®ä¿é¢„è§ˆçº¿èƒ½è·å–åˆ°æœ€æ–°ç«¯ç‚¹
    setTimeout(() => {
      this.unlockPreviewLineRefresh();
      
      // è§£é”åè§¦å‘é¢„è§ˆçº¿åˆ·æ–°
      if (this.previewLineManager) {
        this.previewLineManager.refreshAllPreviewLines({
          reason: 'virtual_endpoints_ready',
          smartRefresh: true
        });
      }
    }, 50); // 50mså»¶è¿Ÿç¡®ä¿è™šæ‹Ÿç«¯ç‚¹å®Œå…¨åˆ›å»º
    
    return virtualEndpoints;
    
  } catch (error) {
    this.unlockPreviewLineRefresh();
    throw error;
  }
}
```

#### 2.3 èŠ‚ç‚¹ä½ç½®æ›´æ–°æ—¶çš„é”å®š
```javascript
// UnifiedStructuredLayoutEngine.js
updateNodePositions(positionUpdates) {
  this.lockPreviewLineRefresh('node_position_update');
  
  try {
    // æ‰¹é‡æ›´æ–°èŠ‚ç‚¹ä½ç½®
    positionUpdates.forEach(update => {
      const { nodeId, position } = update;
      this._updateSingleNodePosition(nodeId, position);
    });
    
    // ä½ç½®æ›´æ–°å®Œæˆåè§£é”å¹¶åˆ·æ–°é¢„è§ˆçº¿
    this.unlockPreviewLineRefresh();
    
    // è§¦å‘é¢„è§ˆçº¿ä½ç½®é‡æ–°è®¡ç®—
    if (this.previewLineManager) {
      this.previewLineManager.recalculateAllPreviewPositions();
    }
    
  } catch (error) {
    this.unlockPreviewLineRefresh();
    throw error;
  }
}
```

### 3. é˜Ÿåˆ—æœºåˆ¶å¢å¼º

#### 3.1 å»¶è¿Ÿæ‰§è¡Œé˜Ÿåˆ—
```javascript
// UnifiedPreviewLineManager.js
class UnifiedPreviewLineManager {
  constructor(graph, layoutEngine) {
    // å»¶è¿Ÿæ‰§è¡Œé˜Ÿåˆ—
    this.pendingRefreshQueue = [];
    this.queueProcessingTimer = null;
  }
  
  // å°†åˆ·æ–°è¯·æ±‚åŠ å…¥é˜Ÿåˆ—
  queueRefreshRequest(options = {}) {
    this.pendingRefreshQueue.push({
      timestamp: Date.now(),
      options,
      id: Math.random().toString(36).substr(2, 9)
    });
    
    console.debug(`ğŸ“‹ [é¢„è§ˆçº¿ç®¡ç†å™¨] åˆ·æ–°è¯·æ±‚åŠ å…¥é˜Ÿåˆ—ï¼Œé˜Ÿåˆ—é•¿åº¦: ${this.pendingRefreshQueue.length}`);
    
    // å¯åŠ¨é˜Ÿåˆ—å¤„ç†
    this.scheduleQueueProcessing();
  }
  
  // è°ƒåº¦é˜Ÿåˆ—å¤„ç†
  scheduleQueueProcessing() {
    if (this.queueProcessingTimer) {
      clearTimeout(this.queueProcessingTimer);
    }
    
    this.queueProcessingTimer = setTimeout(() => {
      this.processRefreshQueue();
    }, 100); // 100msåå¤„ç†é˜Ÿåˆ—
  }
  
  // å¤„ç†åˆ·æ–°é˜Ÿåˆ—
  processRefreshQueue() {
    if (this.pendingRefreshQueue.length === 0) {
      return;
    }
    
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰§è¡Œåˆ·æ–°
    if (!this.canRefreshPreviewLines()) {
      console.debug('â³ [é¢„è§ˆçº¿ç®¡ç†å™¨] é˜Ÿåˆ—å¤„ç†å»¶è¿Ÿï¼ˆé”å®šçŠ¶æ€ï¼‰ï¼Œå°†é‡æ–°è°ƒåº¦');
      this.scheduleQueueProcessing();
      return;
    }
    
    // åˆå¹¶é˜Ÿåˆ—ä¸­çš„åˆ·æ–°è¯·æ±‚
    const mergedOptions = this.mergeQueuedRefreshOptions();
    
    console.debug(`ğŸ”„ [é¢„è§ˆçº¿ç®¡ç†å™¨] å¤„ç†é˜Ÿåˆ—ä¸­çš„ ${this.pendingRefreshQueue.length} ä¸ªåˆ·æ–°è¯·æ±‚`);
    
    // æ¸…ç©ºé˜Ÿåˆ—
    this.pendingRefreshQueue = [];
    
    // æ‰§è¡Œåˆ·æ–°
    this._performRefreshAllPreviewLines(mergedOptions);
  }
  
  // åˆå¹¶é˜Ÿåˆ—ä¸­çš„åˆ·æ–°é€‰é¡¹
  mergeQueuedRefreshOptions() {
    const mergedOptions = {
      smartRefresh: false,
      forceUpdate: false,
      reason: 'queued_refresh'
    };
    
    this.pendingRefreshQueue.forEach(request => {
      if (request.options.smartRefresh) mergedOptions.smartRefresh = true;
      if (request.options.forceUpdate) mergedOptions.forceUpdate = true;
    });
    
    return mergedOptions;
  }
}
```

### 4. é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶

#### 4.1 é”å®šè¶…æ—¶ä¿æŠ¤
```javascript
// UnifiedStructuredLayoutEngine.js
class UnifiedStructuredLayoutEngine {
  constructor() {
    this.LOCK_TIMEOUT = 5000; // 5ç§’è¶…æ—¶
    this.lockTimeoutTimer = null;
  }
  
  lockPreviewLineRefresh(reason = 'layout_update') {
    this.previewLineRefreshLocked = true;
    this.lockStartTime = Date.now();
    this.lockReason = reason;
    
    // è®¾ç½®è¶…æ—¶ä¿æŠ¤
    this.lockTimeoutTimer = setTimeout(() => {
      console.warn(`âš ï¸ [å¸ƒå±€å¼•æ“] é¢„è§ˆçº¿åˆ·æ–°é”å®šè¶…æ—¶ï¼Œå¼ºåˆ¶è§£é”ã€‚åŸå› : ${this.lockReason}`);
      this.unlockPreviewLineRefresh();
    }, this.LOCK_TIMEOUT);
    
    console.debug(`ğŸ”’ [å¸ƒå±€å¼•æ“] é”å®šé¢„è§ˆçº¿åˆ·æ–°: ${reason}`);
  }
  
  unlockPreviewLineRefresh() {
    if (this.lockTimeoutTimer) {
      clearTimeout(this.lockTimeoutTimer);
      this.lockTimeoutTimer = null;
    }
    
    if (this.previewLineRefreshLocked) {
      const lockDuration = Date.now() - this.lockStartTime;
      console.debug(`ğŸ”“ [å¸ƒå±€å¼•æ“] è§£é”é¢„è§ˆçº¿åˆ·æ–°ï¼Œé”å®šæ—¶é•¿: ${lockDuration}ms`);
    }
    
    this.previewLineRefreshLocked = false;
    this.lockStartTime = null;
    this.lockReason = null;
  }
}
```

#### 4.2 å¼‚å¸¸æƒ…å†µå¤„ç†
```javascript
// UnifiedPreviewLineManager.js
refreshAllPreviewLines(options = {}) {
  try {
    // æ£€æŸ¥é”å®šçŠ¶æ€
    if (!this.canRefreshPreviewLines()) {
      if (options.emergency) {
        console.warn('ğŸš¨ [é¢„è§ˆçº¿ç®¡ç†å™¨] ç´§æ€¥åˆ·æ–°æ¨¡å¼ï¼Œå¿½ç•¥é”å®šçŠ¶æ€');
      } else {
        // åŠ å…¥é˜Ÿåˆ—ç­‰å¾…å¤„ç†
        this.queueRefreshRequest(options);
        return;
      }
    }
    
    // æ‰§è¡Œåˆ·æ–°
    this._performRefreshAllPreviewLines(options);
    
  } catch (error) {
    console.error('âŒ [é¢„è§ˆçº¿ç®¡ç†å™¨] é¢„è§ˆçº¿åˆ·æ–°å¤±è´¥:', error);
    
    // é”™è¯¯æ¢å¤ï¼šå¦‚æœæ˜¯é”å®šç›¸å…³é”™è¯¯ï¼Œå°è¯•å¼ºåˆ¶è§£é”
    if (this.layoutEngine && error.message.includes('locked')) {
      console.warn('ğŸ”§ [é¢„è§ˆçº¿ç®¡ç†å™¨] æ£€æµ‹åˆ°é”å®šç›¸å…³é”™è¯¯ï¼Œå°è¯•å¼ºåˆ¶è§£é”');
      this.layoutEngine.unlockPreviewLineRefresh();
    }
    
    throw error;
  }
}
```

## å®ç°ä¼˜åŠ¿

1. **ç²¾ç¡®æ§åˆ¶**ï¼šåœ¨å…³é”®æ—¶åˆ»ç²¾ç¡®æ§åˆ¶é¢„è§ˆçº¿åˆ·æ–°æ—¶æœº
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…ä¸å¿…è¦çš„é‡å¤è®¡ç®—å’ŒDOMæ“ä½œ
3. **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿ç»ˆç‚¹ä½ç½®è®¡ç®—çš„å”¯ä¸€æ•°æ®æº
4. **é”™è¯¯æ¢å¤**ï¼šå®Œå–„çš„è¶…æ—¶å’Œå¼‚å¸¸å¤„ç†æœºåˆ¶
5. **è°ƒè¯•å‹å¥½**ï¼šè¯¦ç»†çš„æ—¥å¿—è¾“å‡ºä¾¿äºé—®é¢˜å®šä½

## æµ‹è¯•ç­–ç•¥

1. **å•å…ƒæµ‹è¯•**ï¼šé”å®š/è§£é”æœºåˆ¶çš„åŸºæœ¬åŠŸèƒ½
2. **é›†æˆæµ‹è¯•**ï¼šå¸ƒå±€æ›´æ–°ä¸é¢„è§ˆçº¿åˆ·æ–°çš„åè°ƒ
3. **å¹¶å‘æµ‹è¯•**ï¼šå¤šä¸ªæ“ä½œåŒæ—¶è¿›è¡Œæ—¶çš„é”å®šæ•ˆæœ
4. **æ€§èƒ½æµ‹è¯•**ï¼šé”å®šæœºåˆ¶å¯¹æ•´ä½“æ€§èƒ½çš„å½±å“
5. **å¼‚å¸¸æµ‹è¯•**ï¼šè¶…æ—¶å’Œé”™è¯¯æ¢å¤æœºåˆ¶çš„æœ‰æ•ˆæ€§

## éƒ¨ç½²è®¡åˆ’

1. **é˜¶æ®µ1**ï¼šå®ç°åŸºç¡€é”å®šæœºåˆ¶
2. **é˜¶æ®µ2**ï¼šé›†æˆåˆ°å…³é”®æ“ä½œç‚¹
3. **é˜¶æ®µ3**ï¼šæ·»åŠ é˜Ÿåˆ—å’Œé”™è¯¯å¤„ç†
4. **é˜¶æ®µ4**ï¼šæ€§èƒ½ä¼˜åŒ–å’Œæµ‹è¯•éªŒè¯
5. **é˜¶æ®µ5**ï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å’Œç›‘æ§