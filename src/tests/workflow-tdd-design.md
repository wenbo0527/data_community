# 工作流编辑器 TDD 测试设计文档

## 测试概述

本文档定义了工作流编辑器的完整测试策略，采用测试驱动开发（TDD）方法，确保代码质量和功能完整性。

## 测试架构

### 测试层级
1. **单元测试** - 测试独立的函数和组件
2. **集成测试** - 测试组件间的交互
3. **端到端测试** - 测试完整的用户流程

### 测试工具
- **Vitest** - 测试运行器
- **Vue Test Utils** - Vue组件测试工具
- **jsdom** - DOM环境模拟
- **@testing-library/vue** - 用户行为测试

## 核心模块测试规划

### 1. workflowNodeTypes.js 测试

#### 测试目标
- 验证节点类型定义的完整性
- 测试工具函数的正确性
- 确保类型安全

#### 测试用例
```javascript
// 节点类型枚举测试
- NodeType 枚举包含所有必要的节点类型
- 每个节点类型都有对应的图标映射
- 每个节点类型都有对应的颜色配置

// 工具函数测试
- getPortsByType() 为不同节点类型返回正确的端口配置
- getNodeTypeName() 返回正确的显示名称
- getNodeTypeColor() 返回正确的颜色值
- getNodeTypeIcon() 返回正确的图标组件
- getNodeTypeIconName() 返回正确的图标名称

// 边界条件测试
- 处理未知节点类型时的默认值
- 处理null/undefined参数
```

### 2. workflowNodeCreator.js 测试

#### 测试目标
- 验证节点创建逻辑
- 测试边连接功能
- 确保位置计算正确

#### 测试用例
```javascript
// 节点创建测试
- createNode() 创建有效的节点对象
- 节点ID唯一性验证
- 节点位置设置正确
- 节点数据结构完整
- 端口配置正确

// 边创建测试
- createEdge() 创建有效的连接边
- 边ID唯一性验证
- 源节点和目标节点连接正确
- 边样式配置正确

// 位置计算测试
- getDownstreamNodePosition() 计算正确的下游节点位置
- 避免节点重叠
- 处理多个下游节点的布局

// 下游节点创建测试
- createDownstreamNode() 同时创建节点和边
- 错误处理：创建失败时的回滚
- 批量创建功能测试

// 错误处理测试
- 无效参数处理
- Graph实例不存在时的处理
- 节点类型不存在时的处理
```

### 3. WorkflowNode.vue 组件测试

#### 测试目标
- 验证组件渲染正确
- 测试用户交互
- 确保事件处理正确

#### 测试用例
```javascript
// 组件渲染测试
- 节点正确渲染不同类型的图标和样式
- 节点名称和类型显示正确
- 状态指示器显示正确
- 端口根据节点类型正确显示/隐藏

// 交互测试
- 鼠标悬停时显示端口和加号按钮
- 点击节点时触发选择事件
- 点击加号按钮显示下拉菜单
- 选择菜单项创建下游节点

// 状态管理测试
- 选中状态正确更新
- 悬停状态正确更新
- 菜单显示状态正确管理

// 计算属性测试
- availableNodeTypes 根据当前节点类型正确过滤
- canAddDownstream 根据节点类型正确判断
- hasInputPort/hasOutputPort 正确判断端口显示

// 依赖注入测试
- graph 实例正确注入
- selectedNodeId 正确注入
- setSelectedNode 函数正确注入
```

### 4. WorkflowEditor.vue 组件测试

#### 测试目标
- 验证编辑器初始化
- 测试工作流操作
- 确保数据持久化

#### 测试用例
```javascript
// 编辑器初始化测试
- 画布正确初始化
- 工具栏按钮正确渲染
- 属性面板正确渲染
- 空工作流时自动创建输入节点

// 工作流操作测试
- 撤销/重做功能
- 缩放功能（放大、缩小、适应画布、重置）
- 节点选择和属性编辑
- 工作流保存和发布

// 数据加载测试
- 从存储加载工作流数据
- 渲染已有的节点和连接
- 处理损坏的工作流数据

// 事件处理测试
- 节点点击事件
- 画布拖拽事件
- 键盘快捷键

// 路由集成测试
- 从URL参数加载工作流ID
- 返回按钮导航
- 页面刷新时数据保持
```

## 集成测试规划

### 1. 节点创建流程测试
```javascript
// 完整的节点创建流程
- 点击加号按钮 → 显示菜单 → 选择节点类型 → 创建节点和连接
- 验证新节点在画布上正确显示
- 验证连接线正确绘制
- 验证节点数据正确保存
```

### 2. 工作流编辑流程测试
```javascript
// 完整的编辑流程
- 创建工作流 → 添加节点 → 配置属性 → 保存工作流
- 验证每个步骤的数据一致性
- 验证撤销/重做的正确性
```

### 3. 数据持久化测试
```javascript
// 数据保存和加载
- 保存工作流到本地存储
- 重新加载页面后数据恢复
- 处理存储配额限制
```

## 性能测试规划

### 1. 大规模工作流测试
```javascript
// 性能基准测试
- 100个节点的工作流渲染性能
- 1000个节点的工作流操作响应时间
- 内存使用情况监控
```

### 2. 交互响应性测试
```javascript
// 用户体验测试
- 节点拖拽的流畅性
- 缩放操作的响应时间
- 大量节点时的选择响应
```

## 错误处理测试规划

### 1. 异常情况测试
```javascript
// 错误恢复测试
- 网络错误时的处理
- 数据损坏时的恢复
- 浏览器兼容性问题
```

### 2. 用户输入验证
```javascript
// 输入验证测试
- 节点名称长度限制
- 特殊字符处理
- 空值处理
```

## 测试覆盖率目标

- **语句覆盖率**: ≥ 90%
- **分支覆盖率**: ≥ 85%
- **函数覆盖率**: ≥ 95%
- **行覆盖率**: ≥ 90%

## 测试执行策略

### 1. 开发阶段
- 每次代码提交前运行单元测试
- 功能开发完成后运行集成测试
- 使用测试覆盖率报告指导测试补充

### 2. 持续集成
- 自动运行所有测试
- 生成测试报告和覆盖率报告
- 测试失败时阻止代码合并

### 3. 发布前验证
- 运行完整的测试套件
- 执行性能基准测试
- 验证浏览器兼容性

## 测试数据管理

### 1. 测试数据准备
```javascript
// Mock数据结构
- 标准工作流数据
- 复杂工作流数据
- 边界情况数据
- 错误数据
```

### 2. 测试环境隔离
- 每个测试用例独立的数据环境
- 测试后自动清理
- 避免测试间的数据污染

## 测试维护策略

### 1. 测试代码质量
- 测试代码也需要代码审查
- 保持测试代码的可读性和可维护性
- 定期重构测试代码

### 2. 测试更新
- 功能变更时同步更新测试
- 定期审查测试的有效性
- 移除过时的测试用例

---

*本文档将随着项目发展持续更新和完善*