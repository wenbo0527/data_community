import{B as K,e as p,d as W,o as y,w as t,f as a,h as N,c as x,j as v,F,m as q,t as k,_ as H,p as le,a as X,K as G,b as te,g as Y,i as Q,y as se,r as L,M as J,s as ae,v as oe,U as ue,W as ce}from"./index-CsgcdrY7.js";import{c as ie,a as de,b as me}from"./calculations-CX3sW4IW.js";const re={class:"form-footer"},pe=K({__name:"BasicInfoStep",props:{modelValue:{default:()=>({name:"",cacheTime:"30",days:0,periods:0,description:"",periodDays:[30]})},step:{default:0}},emits:["update:modelValue","next"],setup(U,{emit:S}){const w=U,V=P=>{w.modelValue.periodDays=new Array(P).fill(0),S("update:modelValue",w.modelValue)},i=()=>{S("next")};return(P,D)=>{const E=p("a-input"),B=p("a-form-item"),T=p("a-col"),z=p("a-option"),j=p("a-select"),O=p("a-input-number"),C=p("a-row"),r=p("a-textarea"),_=p("a-divider"),R=p("a-button"),M=p("a-form");return y(),W(M,{model:P.modelValue,layout:"vertical",class:"basic-info-form"},{default:t(()=>[a(C,{gutter:24},{default:t(()=>[a(T,{span:6},{default:t(()=>[a(B,{label:"计划名称",field:"name",rules:[{required:!0,message:"请输入计划名称"}]},{default:t(()=>[a(E,{modelValue:P.modelValue.name,"onUpdate:modelValue":D[0]||(D[0]=d=>P.modelValue.name=d),placeholder:"请输入计划名称","show-word-limit":"","max-length":100,"allow-clear":"",class:"custom-input"},null,8,["modelValue"])]),_:1})]),_:1}),a(T,{span:6},{default:t(()=>[a(B,{label:"缓存时间",field:"cacheTime",rules:[{required:!0,message:"请选择缓存时间"}]},{default:t(()=>[a(j,{modelValue:P.modelValue.cacheTime,"onUpdate:modelValue":D[1]||(D[1]=d=>P.modelValue.cacheTime=d),placeholder:"请选择缓存时间",class:"custom-select"},{default:t(()=>[a(z,{value:"0"},{default:t(()=>[v("不使用缓存")]),_:1}),(y(),x(F,null,q(30,d=>a(z,{key:d,value:d},{default:t(()=>[v(k(d)+"天",1)]),_:2},1032,["value"])),64))]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(T,{span:6},{default:t(()=>[a(B,{label:"陪跑天数",field:"days",rules:[{required:!0,message:"请输入陪跑天数"},{type:"number",min:1,max:365,message:"天数范围为1-365天"}]},{default:t(()=>[a(O,{modelValue:P.modelValue.days,"onUpdate:modelValue":D[2]||(D[2]=d=>P.modelValue.days=d),placeholder:"请输入陪跑天数",min:1,max:365,class:"custom-input-number"},null,8,["modelValue"])]),_:1})]),_:1}),a(T,{span:6},{default:t(()=>[a(B,{label:"陪跑期数",field:"periods",rules:[{required:!0,message:"请选择陪跑期数"}]},{default:t(()=>[a(j,{modelValue:P.modelValue.periods,"onUpdate:modelValue":D[3]||(D[3]=d=>P.modelValue.periods=d),placeholder:"请选择陪跑期数",onChange:V,class:"custom-select"},{default:t(()=>[(y(),x(F,null,q(10,d=>a(z,{key:d,value:d},{default:t(()=>[v(k(d)+"期",1)]),_:2},1032,["value"])),64))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(C,{gutter:24},{default:t(()=>[a(T,{span:24},{default:t(()=>[a(B,{label:"备注",field:"description"},{default:t(()=>[a(r,{modelValue:P.modelValue.description,"onUpdate:modelValue":D[4]||(D[4]=d=>P.modelValue.description=d),placeholder:"请输入备注","max-length":1e3,"show-word-limit":"","allow-clear":"",class:"custom-textarea"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),a(_,{class:"custom-divider"},{default:t(()=>[v("期数配置")]),_:1}),a(C,{gutter:[24,16]},{default:t(()=>[(y(!0),x(F,null,q(P.modelValue.periods,d=>(y(),W(T,{key:d,span:6},{default:t(()=>[a(B,{label:`第${d}期天数`,field:`periodDays.${d-1}`,rules:[{required:!0,message:"请输入天数"},{type:"number",min:1,max:365,message:"天数范围为1-365天"}]},{default:t(()=>[a(O,{modelValue:P.modelValue.periodDays[d-1],"onUpdate:modelValue":o=>P.modelValue.periodDays[d-1]=o,placeholder:"请输入天数",min:1,max:365,class:"custom-input-number"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["label","field"])]),_:2},1024))),128))]),_:1}),N("div",re,[a(R,{type:"primary",size:"large",onClick:i},{default:t(()=>[v("下一步")]),_:1})])]),_:1},8,["model"])}}}),_e=H(pe,[["__scopeId","data-v-0349e485"]]),fe={class:"data-product-config"},ve={class:"product-header"},Ve={class:"actions"},he={class:"form-footer"},be=K({__name:"DataProductStep",props:{modelValue:{}},emits:["update:modelValue","next","prev"],setup(U,{emit:S}){const w=U,V=[{id:"dp1",name:"数据产品A",description:"用于信用评估的综合数据产品",price:100,supplier:"供应商A",sceneRatios:{}},{id:"dp2",name:"数据产品B",description:"用于风险控制的专业数据产品",price:150,supplier:"供应商B",sceneRatios:{}},{id:"dp3",name:"数据产品C",description:"用于营销分析的高级数据产品",price:200,supplier:"供应商C",sceneRatios:{}}],i=le({products:[...w.modelValue.products],periodDays:[...w.modelValue.periodDays]}),P=X(()=>i.products),D=X(()=>i.periodDays);G(()=>w.modelValue,C=>{Object.assign(i,C)},{deep:!0});const E=C=>{i.products.splice(C,1),S("update:modelValue",i)};te(()=>{i.products.length===0&&z(),i.products.forEach(C=>{(!C.periods||C.periods.length!==D.value.length)&&(C.periods=D.value.map((r,_)=>({count:0,days:r,ratio:0,dailyAmount:0,cost:0,discount:{type:"none",value:0}})))})});const B=[{title:"期数",slotName:"period",width:80},{title:"每期陪跑量",slotName:"periodConfig",width:120},{title:"当期占比",slotName:"periodRatio",width:100},{title:"日均陪跑量",slotName:"averageDailyAmount",width:100},{title:"折扣优惠",slotName:"discountOption",width:200},{title:"当期费用",slotName:"totalCost",width:120}],T=C=>{const r=V.find(_=>_.name===C);return(r==null?void 0:r.price)||0},z=()=>{const C={id:`dp${i.products.length+1}`,name:"",totalAmount:0,periods:D.value.map((r,_)=>({count:0,days:r,ratio:0,dailyAmount:0,cost:0,discount:{type:"none",value:0}})),sceneRatios:{},scenes:[]};i.products.push(C),S("update:modelValue",i)},j=()=>S("next"),O=()=>S("prev");return G(P,C=>{S("update:modelValue",{...i,products:C})},{deep:!0}),G(()=>i.products.map(C=>C.periods),()=>{console.log("Periods updated:",i.products.map(C=>C.periods)),S("update:modelValue",i)},{deep:!0}),(C,r)=>{const _=p("a-button"),R=p("a-option"),M=p("a-select"),d=p("a-form-item"),o=p("a-col"),c=p("a-input-number"),h=p("a-row"),e=p("a-table"),u=p("a-space");return y(),x("div",fe,[(y(!0),x(F,null,q(C.modelValue.products,(l,n)=>(y(),x("div",{key:n,class:"product-section"},[N("div",ve,[i.products.length>1?(y(),W(_,{key:0,type:"text",status:"danger",onClick:s=>E(n)},{default:t(()=>[a(Q(se))]),_:2},1032,["onClick"])):Y("",!0)]),a(h,{gutter:24},{default:t(()=>[a(o,{span:12},{default:t(()=>[a(d,{label:"数据产品",field:`products[${n}].name`,required:""},{default:t(()=>[a(M,{modelValue:l.name,"onUpdate:modelValue":s=>l.name=s,placeholder:"请选择数据产品",class:"custom-select"},{default:t(()=>[(y(),x(F,null,q(V,s=>a(R,{key:s.id,value:s.name},{default:t(()=>[v(k(s.name)+" - "+k(s.description)+" ("+k(s.price)+"元/条) ",1)]),_:2},1032,["value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1032,["field"])]),_:2},1024),a(o,{span:12},{default:t(()=>[a(d,{label:"总陪跑量",field:`products[${n}].totalAmount`,required:""},{default:t(()=>[a(c,{modelValue:l.totalAmount,"onUpdate:modelValue":s=>l.totalAmount=s,placeholder:"请输入总陪跑量",min:0,class:"custom-input-number"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1032,["field"])]),_:2},1024)]),_:2},1024),a(e,{data:l.periods,columns:B,pagination:!1,class:"period-table"},{period:t(({record:s,rowIndex:g})=>[v(" 第"+k(g+1)+"期 ",1)]),periodConfig:t(({record:s})=>[a(c,{modelValue:s.count,"onUpdate:modelValue":g=>s.count=g,min:0,max:l.totalAmount,class:"count-input",placeholder:"请输入条数"},null,8,["modelValue","onUpdate:modelValue","max"])]),periodRatio:t(({record:s})=>[v(k(Q(me)(s.count,l.totalAmount))+"% ",1)]),averageDailyAmount:t(({record:s})=>[v(k(Q(de)(s.count,s.days)),1)]),discountOption:t(({record:s})=>[a(h,{gutter:8},{default:t(()=>[a(o,{span:12},{default:t(()=>[a(M,{modelValue:s.discount.type,"onUpdate:modelValue":g=>s.discount.type=g,class:"discount-select"},{default:t(()=>[a(R,{value:"none"},{default:t(()=>[v("无优惠")]),_:1}),a(R,{value:"discount"},{default:t(()=>[v("折扣优惠")]),_:1}),a(R,{value:"free"},{default:t(()=>[v("免费条数")]),_:1})]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1024),a(o,{span:12},{default:t(()=>[s.discount.type!=="none"?(y(),W(c,{key:0,modelValue:s.discount.value,"onUpdate:modelValue":g=>s.discount.value=g,min:0,max:s.discount.type==="discount"?1:s.count,precision:s.discount.type==="discount"?2:0,placeholder:s.discount.type==="discount"?"请输入折扣率":"请输入免费条数",class:"discount-value-input"},null,8,["modelValue","onUpdate:modelValue","max","precision","placeholder"])):Y("",!0)]),_:2},1024)]),_:2},1024)]),totalCost:t(({record:s})=>[v(k(Q(ie)(s.count,T(l.name),s.discount.type,s.discount.value))+"元 ",1)]),_:2},1032,["data"])]))),128)),N("div",Ve,[a(_,{type:"outline",onClick:z},{default:t(()=>[v("新增数据产品")]),_:1})]),N("div",he,[a(u,null,{default:t(()=>[a(_,{size:"large",onClick:O},{default:t(()=>[v("上一步")]),_:1}),a(_,{type:"primary",size:"large",onClick:j},{default:t(()=>[v("下一步")]),_:1})]),_:1})])])}}}),ge=H(be,[["__scopeId","data-v-6f26d01d"]]),Z=U=>(ae("data-v-f6db10e8"),U=U(),oe(),U),Ae={class:"scene-step"},ye={class:"scene-selection"},Ce=Z(()=>N("h3",{class:"section-title"},"场景选择",-1)),Ne={class:"product-title"},Pe={class:"product-info"},ke=Z(()=>N("span",{class:"info-label"},"总条数：",-1)),we={class:"info-value"},$e={class:"condition-selects"},xe={key:0,class:"value-input"},De=Z(()=>N("span",{class:"separator"},"-",-1)),Re={class:"allocation-progress"},Se={class:"progress-text"},Ue={class:"form-footer"},Ie=K({__name:"SceneStep",props:{formData:{}},emits:["next","prev"],setup(U,{emit:S}){const w=U,V=L([]),i=[{label:"授信申请",value:"credit_apply"},{label:"授信通过",value:"credit_pass"},{label:"支用申请",value:"loan_apply"},{label:"支用通过",value:"loan_pass"}],P=[{label:"等于",value:"eq"},{label:"大于",value:"gt"},{label:"小于",value:"lt"},{label:"大于等于",value:"gte"},{label:"小于等于",value:"lte"},{label:"区间",value:"range"}],D=[{title:"场景",slotName:"scene",width:150},{title:"分配条数",slotName:"amount",width:150},{title:"分配比例",slotName:"ratio",width:150},{title:"条件",slotName:"amountCondition",width:300}],E=o=>V.value.map(c=>{var u,l;const h=((u=i.find(n=>n.value===c))==null?void 0:u.label)||"",e=(l=o.scenes)==null?void 0:l.find(n=>n.sceneValue===c);return{sceneValue:c,sceneName:h,amount:Number((e==null?void 0:e.amount)||0),selectedField:"amount",amountCondition:(e==null?void 0:e.amountCondition)||"",amountValue:Number((e==null?void 0:e.amountValue)||0),minAmount:Number((e==null?void 0:e.minAmount)||0),maxAmount:(e==null?void 0:e.maxAmount)||null,creditProducts:[]}}),B=(o,c)=>{o.amount>c.totalAmount&&(o.amount=c.totalAmount),c.scenes||(c.scenes=[]);const h=c.scenes.findIndex(u=>u.sceneValue===o.sceneValue),e={...o,ratio:T(o.amount,c.totalAmount)};h>=0?c.scenes[h]=e:c.scenes.push(e)},T=(o,c)=>c?Number((o/c*100).toFixed(2)):0,z=o=>{if(!o.totalAmount)return 0;const c=(o.scenes||[]).reduce((h,e)=>{const u=Math.round(Number(e.amount||0));return h+u},0);return Math.min(Number((c*100/o.totalAmount).toFixed(2)),100)},j=()=>V.value.length===0?(J.error("请至少选择一个场景进行数据分配"),!1):w.formData.dataProducts.every(o=>{var e;if(!((e=o.scenes)!=null&&e.length))return J.error(`请为数据产品「${o.name}」分配场景数据`),!1;const c=V.value.filter(u=>{var l;return!((l=o.scenes)!=null&&l.some(n=>n.sceneValue===u&&Number(n.amount)>0))});if(c.length>0){const u=c.map(l=>{var n;return(n=i.find(s=>s.value===l))==null?void 0:n.label}).filter(Boolean).join("、");return J.error(`数据产品「${o.name}」的「${u}」场景尚未分配数据`),!1}const h=o.scenes.reduce((u,l)=>u+Math.round(Number(l.amount||0)),0);if(h!==o.totalAmount){const u=Math.abs(h-o.totalAmount);return J.error(`数据产品「${o.name}」的场景分配总量(${h})与产品总量(${o.totalAmount})不一致，还需分配${u}条数据`),!1}return!0}),O=()=>{if(!j()){J.error("请确保所有数据产品的场景分配完成且总量正确");return}console.log("场景步骤校验通过，触发下一步"),S("next")},C=()=>{S("prev")},r=o=>({gt:"大于金额",lt:"小于金额",gte:"大于等于金额",lte:"小于等于金额"})[o]||"请输入金额",_=(o,c,h)=>{h.scenes||(h.scenes=[]);const e=h.scenes.findIndex(u=>u.sceneValue===c.sceneValue);e>=0?h.scenes[e].amountCondition=o:h.scenes.push({...c,amountCondition:o})},R=(o,c)=>{o.amountValue<0&&(o.amountValue=0),d(o,c)},M=(o,c)=>{o.minAmount<0&&(o.minAmount=0),o.maxAmount&&o.maxAmount<o.minAmount&&(o.maxAmount=o.minAmount),d(o,c)},d=(o,c)=>{c.scenes||(c.scenes=[]);const h=c.scenes.findIndex(e=>e.sceneValue===o.sceneValue);if(h>=0){const e={...c.scenes[h],amountCondition:String(o.amountCondition),amountValue:String(o.amountValue),minAmount:String(o.minAmount),maxAmount:o.maxAmount?String(o.maxAmount):null};c.scenes[h]=e}else c.scenes.push({sceneValue:String(o.sceneValue),sceneName:String(o.sceneName),amount:String(o.amount),amountCondition:String(o.amountCondition),amountValue:String(o.amountValue),minAmount:String(o.minAmount),maxAmount:o.maxAmount?String(o.maxAmount):null})};return G(()=>w.formData.dataProducts,()=>{console.log("场景数据更新:",JSON.parse(JSON.stringify(w.formData.dataProducts)))},{deep:!0,immediate:!0}),(o,c)=>{const h=p("a-option"),e=p("a-select"),u=p("a-input-number"),l=p("a-input"),n=p("a-table"),s=p("a-progress"),g=p("a-button"),A=p("a-space");return y(),x("div",Ae,[N("div",ye,[Ce,a(e,{modelValue:V.value,"onUpdate:modelValue":c[0]||(c[0]=b=>V.value=b),multiple:"",placeholder:"请选择场景",class:"scene-select"},{default:t(()=>[(y(),x(F,null,q(i,b=>a(h,{key:b.value,value:b.value},{default:t(()=>[v(k(b.label),1)]),_:2},1032,["value"])),64))]),_:1},8,["modelValue"])]),(y(!0),x(F,null,q(o.formData.dataProducts,(b,$)=>(y(),x("div",{key:$,class:"product-section"},[N("h3",Ne,k(b.name),1),N("div",Pe,[ke,N("span",we,k(b.totalAmount),1)]),a(n,{data:E(b),columns:D,pagination:!1,class:"scene-table"},{scene:t(({record:f})=>[v(k(f.sceneName),1)]),amount:t(({record:f})=>[a(u,{modelValue:f.amount,"onUpdate:modelValue":m=>f.amount=m,min:0,max:b.totalAmount,precision:0,placeholder:"请输入分配条数",class:"amount-input",onChange:m=>B(f,b)},null,8,["modelValue","onUpdate:modelValue","max","onChange"])]),ratio:t(({record:f})=>[v(k(T(f.amount,b.totalAmount))+"% ",1)]),amountCondition:t(({record:f})=>[N("div",$e,[a(e,{modelValue:f.selectedCondition,"onUpdate:modelValue":m=>f.selectedCondition=m,placeholder:"选择条件",class:"condition-type-select",style:{width:"100px"}},{default:t(()=>[a(h,{value:"amount"},{default:t(()=>[v("额度")]),_:1}),a(h,{value:"period"},{default:t(()=>[v("期数")]),_:1}),a(h,{value:"riskLevel"},{default:t(()=>[v("风险等级")]),_:1})]),_:2},1032,["modelValue","onUpdate:modelValue"]),a(e,{modelValue:f.amountCondition,"onUpdate:modelValue":m=>f.amountCondition=m,placeholder:"选择关系",class:"condition-select",onChange:m=>_(m,f,b)},{default:t(()=>[(y(),x(F,null,q(P,m=>a(h,{key:m.value,value:m.value},{default:t(()=>[v(k(m.label),1)]),_:2},1032,["value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),f.amountCondition?(y(),x("div",xe,[f.amountCondition==="range"?(y(),x(F,{key:0},[a(l,{modelValue:f.minAmount,"onUpdate:modelValue":[m=>f.minAmount=m,m=>f.minAmount=Number(m)],placeholder:"最小值",class:"condition-input",onChange:m=>M(f,b)},null,8,["modelValue","onUpdate:modelValue","onChange"]),De,a(l,{modelValue:f.maxAmount,"onUpdate:modelValue":[m=>f.maxAmount=m,m=>f.maxAmount=m?Number(m):null],placeholder:"最大值",class:"condition-input",onChange:m=>M(f,b)},null,8,["modelValue","onUpdate:modelValue","onChange"])],64)):(y(),W(l,{key:1,modelValue:f.amountValue,"onUpdate:modelValue":[m=>f.amountValue=m,m=>f.amountValue=Number(m)],placeholder:r(f.amountCondition),class:"condition-input",onChange:m=>R(f,b)},null,8,["modelValue","onUpdate:modelValue","placeholder","onChange"]))])):Y("",!0)])]),_:2},1032,["data"]),N("div",Re,[N("span",Se,"分配进度："+k(z(b))+"%",1),a(s,{percent:z(b),"show-text":!1,size:"small"},null,8,["percent"])])]))),128)),N("div",Ue,[a(A,null,{default:t(()=>[a(g,{size:"large",onClick:C},{default:t(()=>[v("上一步")]),_:1}),a(g,{type:"primary",size:"large",onClick:O},{default:t(()=>[v("下一步")]),_:1})]),_:1})])])}}}),Me=H(Ie,[["__scopeId","data-v-f6db10e8"]]),ne=U=>(ae("data-v-56bbee8b"),U=U(),oe(),U),Be={class:"credit-product-step"},Te={class:"credit-product-selection"},ze=ne(()=>N("h3",{class:"section-title"},"信贷产品选择",-1)),Fe={class:"selection-controls"},Oe={key:0,class:"configuration-details"},qe=ne(()=>N("h3",{class:"section-title"},"配置明细",-1)),Ee={class:"data-product-section"},je={class:"data-product-header"},Je={class:"data-product-name"},Le={class:"summary-info"},We={class:"scene-header"},Ke={class:"scene-name"},Ge={class:"form-footer"},He=K({__name:"CreditProductStep",props:{formData:{}},emits:["next","prev"],setup(U,{emit:S}){const w=U,V=L([]);console.log("初始化selectedCreditProducts:",V.value);const i=[{label:"信贷产品A",value:"credit_a",weeklyRatio:25.5,submissionRatio:18.2,recommendedRate:.35},{label:"信贷产品B",value:"credit_b",weeklyRatio:18,submissionRatio:12.5,recommendedRate:.28},{label:"信贷产品C",value:"credit_c",weeklyRatio:22.3,submissionRatio:15.8,recommendedRate:.32}],P=(e,u)=>{if(typeof e!="number"||typeof u!="number"||u<=0)return console.warn("计算比例参数无效:",{amount:e,total:u}),"0.00";const l=Math.max(0,e),n=(l/u*100).toFixed(2);return console.log("计算比例:",{amount:l,total:u,ratio:n}),n},D=(e,u)=>{var g;if(console.log("updateAmount调用，传入的record:",e,"场景名称:",u),!e||typeof e.amount!="number"||!e.creditProductValue||!e.sceneValue){console.warn("无效的记录数据:",e);return}const l=w.formData.dataProducts.find(A=>A.id===e.dataProductId);if(!l){console.warn("未找到对应的数据产品:",e.dataProductId);return}Array.isArray(l.scenes)||(l.scenes=[]);let n=l.scenes.find(A=>A.sceneValue===e.sceneValue);n||(n={sceneValue:e.sceneValue,sceneName:u,amount:e.sceneValueAmount||0,ratio:0,totalAmount:l.totalAmount||0,allocatedAmount:0,remainingAmount:l.totalAmount||0,weeklyAvgAmount:0,weeklyAvgRatio:"0",submissionRatio:"0",creditProducts:[]},l.scenes.push(n)),Array.isArray(n.creditProducts)||(n.creditProducts=[]);let s=n.creditProducts.find(A=>A.creditProductValue===e.creditProductValue);s?s.amount=Math.min(e.amount,n.amount||0):(s={creditProductValue:e.creditProductValue,creditProductName:((g=i.find(A=>A.value===e.creditProductValue))==null?void 0:g.label)||"",amount:Math.min(e.amount,n.amount||0),recommendedAmount:d(e),weeklyRatio:Number(o(e)),submissionRatio:Number(c(e)),totalRatio:Number(P(e.amount,l.totalAmount)),dataProductId:e.dataProductId,sceneValue:e.sceneValue,sceneValueAmount:n.amount||0},n.creditProducts.push(s)),n.allocatedAmount=n.creditProducts.reduce((A,b)=>A+(b.amount||0),0),n.remainingAmount=Math.max(0,n.amount-n.allocatedAmount),n.ratio=Number(P(n.allocatedAmount,l.totalAmount)),console.log("更新后的场景数据:",n)},E=()=>{S("next")},B=()=>{S("prev")},T=[{title:"信贷产品",slotName:"creditProduct",width:160},{title:"分配条数",slotName:"amount",width:140},{title:"建议分配量",slotName:"recommendedAmount",width:140},{title:"周均转化率",slotName:"weeklyRatio",width:120},{title:"提交转化率",slotName:"submissionRatio",width:120},{title:"总占比",slotName:"totalRatio",width:100}],z=e=>{if(console.log("获取表格数据，数据产品:",e),!e||!Array.isArray(e.scenes))return console.warn("数据产品或场景数据无效"),[];const u=e.scenes;console.log("场景数据:",u);const l=u.map(n=>{var g;if(!n)return[];console.log("处理场景数据:",n);const s=((g=R.find(A=>A.value===n.sceneValue))==null?void 0:g.label)||n.sceneName||"";return V.value.map(A=>{var f;const b=i.find(m=>m.value===A),$=(f=n.creditProducts)==null?void 0:f.find(m=>m.creditProductValue===A);return{sceneName:s,sceneValue:n.sceneValue,creditProductValue:A,creditProductName:(b==null?void 0:b.label)||"",amount:($==null?void 0:$.amount)||0,recommendedAmount:d({creditProductValue:A,sceneValueAmount:n.amount||0}),weeklyRatio:Number(o({creditProductValue:A})),submissionRatio:Number(c({creditProductValue:A})),totalRatio:Number(P(($==null?void 0:$.amount)||0,e.totalAmount)),dataProductId:e.id,sceneValueAmount:n.amount||0}})}).flat().filter(Boolean);return console.log("生成的表格数据:",l),l},j=e=>({"scene-row":!0}),O=e=>{var l;let u=0;return(l=e.scenes)==null||l.forEach(n=>{var s;(s=n.creditProducts)==null||s.forEach(g=>{u+=g.amount||0})}),u},C=e=>{const u=O(e);return e.totalAmount?(u/e.totalAmount*100).toFixed(2):0},r=L(["credit_apply","credit_pass"]),_=L({}),R=[{label:"授信申请",value:"credit_apply"},{label:"授信通过",value:"credit_pass"},{label:"信贷产品B",value:"credit_b"},{label:"信贷产品C",value:"credit_c"}],M=()=>{console.log("开始自动分配，当前选中的信贷产品:",V.value),r.value.forEach(e=>{const u=w.formData.dataProducts.reduce((n,s)=>{var A;const g=(A=s.scenes)==null?void 0:A.find(b=>b.sceneValue===e);return n+((g==null?void 0:g.amount)||0)},0),l=Math.floor(u/V.value.length);_.value[e]=V.value.map(n=>{var s,g;return{sceneValue:e,creditProductValue:n,amount:l,dataProductId:(s=w.formData.dataProducts[0])==null?void 0:s.id,creditProductName:((g=i.find(A=>A.value===n))==null?void 0:g.label)||""}})})},d=e=>{const u=i.find(l=>l.value===e.creditProductValue);return u&&e.sceneValueAmount?Math.round(e.sceneValueAmount*(u.recommendedRate||0)):0},o=e=>{var l;const u=i.find(n=>n.value===e.creditProductValue);return u&&((l=u.weeklyRatio)==null?void 0:l.toFixed(2))||"0.00"},c=e=>{var l;const u=i.find(n=>n.value===e.creditProductValue);return u&&((l=u.submissionRatio)==null?void 0:l.toFixed(2))||"0.00"};te(()=>{h(!0)});const h=(e=!1)=>{console.log("初始化场景配置开始，forceUpdate:",e),r.value=["credit_apply","credit_pass"],w.formData.dataProducts.forEach(u=>{console.log("处理数据产品:",u),r.value.forEach(l=>{console.log("处理场景:",l),_.value[l]=V.value.map(n=>{var A,b,$,f;const g=((A=_.value[l])==null?void 0:A.find(m=>m.creditProductValue===n&&m.dataProductId===u.id))||{sceneValue:l,creditProductValue:n,creditProductName:((b=i.find(m=>m.value===n))==null?void 0:b.label)||"",amount:0,dataProductId:u.id,sceneValueAmount:((f=($=u.scenes)==null?void 0:$.find(m=>m.sceneValue===l))==null?void 0:f.amount)||0};return console.log("场景配置项:",g),g})})}),console.log("初始化场景配置完成，当前配置:",_.value)};return G(V,e=>{console.log("信贷产品选择变化，新值:",e),console.log("当前表格数据:",z(w.formData.dataProducts[0])),h(!0)},{deep:!0}),(e,u)=>{const l=p("a-option"),n=p("a-select"),s=p("a-button"),g=p("a-input-number"),A=p("a-table"),b=p("a-space");return y(),x("div",Be,[N("div",Te,[ze,N("div",Fe,[a(n,{modelValue:V.value,"onUpdate:modelValue":u[0]||(u[0]=$=>V.value=$),multiple:"",placeholder:"请选择信贷产品",class:"credit-product-select"},{default:t(()=>[(y(),x(F,null,q(i,$=>a(l,{key:$.value,value:$.value},{default:t(()=>[v(k($.label),1)]),_:2},1032,["value"])),64))]),_:1},8,["modelValue"]),a(s,{type:"primary",onClick:M,class:"auto-btn"},{default:t(()=>[v(" 自动分配 ")]),_:1})])]),V.value.length>0?(y(),x("div",Oe,[qe,(y(!0),x(F,null,q(e.formData.dataProducts,($,f)=>(y(),x("div",Ee,[N("div",je,[N("span",Je,k($.name),1),N("div",Le,[N("span",null,"已分配总量: "+k(O($)),1),N("span",null,"待分配陪跑量: "+k($.totalAmount-O($)),1),N("span",null,"分配进度: "+k(C($))+"%",1)])]),(y(!0),x(F,null,q($.scenes,m=>(y(),x("div",{key:m.sceneValue,class:"scene-section"},[N("div",We,[N("span",Ke,k(m.sceneName),1)]),a(A,{data:z($),columns:T,pagination:!1,class:"credit-product-table","row-class":j},{scene:t(({record:I})=>[v(k(I.sceneName),1)]),creditProduct:t(({record:I})=>[v(k(I.creditProductName),1)]),amount:t(({record:I})=>[a(g,{modelValue:I.amount,"onUpdate:modelValue":ee=>I.amount=ee,min:0,max:I.sceneValueAmount||0,placeholder:"请输入陪跑量",onChange:ee=>D(I,I.sceneValue)},null,8,["modelValue","onUpdate:modelValue","max","onChange"])]),recommendedAmount:t(({record:I})=>[v(k(d(I)),1)]),weeklyRatio:t(({record:I})=>[v(k(o(I))+"% ",1)]),submissionRatio:t(({record:I})=>[v(k(c(I))+"% ",1)]),totalRatio:t(({record:I})=>[v(k(P(I.amount,$.totalAmount))+"% ",1)]),_:2},1032,["data"])]))),128))]))),256))])):Y("",!0),N("div",Ge,[a(b,null,{default:t(()=>[a(s,{size:"large",onClick:B},{default:t(()=>[v("上一步")]),_:1}),a(s,{type:"primary",size:"large",onClick:E},{default:t(()=>[v("下一步")]),_:1})]),_:1})])])}}}),Qe=H(He,[["__scopeId","data-v-56bbee8b"]]),Xe={class:"success-step"},Ye=K({__name:"SuccessStep",props:{formData:{}},setup(U){return(S,w)=>(y(),x("div",Xe))}}),Ze={class:"content"},et={class:"step-content"},tt=K({__name:"create",setup(U,{expose:S}){const w=[{key:"basic",title:"基本信息",component:_e},{key:"product",title:"数据产品",component:ge},{key:"scene",title:"场景选择",component:Me},{key:"credit",title:"信贷产品",component:Qe},{key:"success",title:"完成",component:Ye}],V=L(0),i=L({workId:"",basic:{name:"",cacheTime:"30",days:0,periods:0,description:"",periodDays:[30]},creditProducts:[],dataProducts:[]}),P=X(()=>{const r=w[V.value].component;return console.log(`当前步骤: ${w[V.value].key}, 组件: ${r.name}`),r}),D=X(()=>{const r={formData:i.value,step:V.value};return w[V.value].key==="product"?{...r,modelValue:{products:i.value.dataProducts,periodDays:i.value.basic.periodDays||[]},"onUpdate:modelValue":_=>{i.value.dataProducts=_.products,i.value.basic.periodDays=_.periodDays}}:w[V.value].key==="basic"?{...r,modelValue:i.value.basic,"onUpdate:modelValue":_=>{i.value.basic=_}}:(console.log("基础步骤props:",r),r)}),E=()=>{console.log("当前步骤:",w[V.value].key),T()?(console.log("校验通过，跳转到下一步"),V.value++):console.warn("步骤校验未通过")},B=()=>{V.value>0&&V.value--},T=()=>{const _={basic:z,product:j,scene:O,credit:C}[w[V.value].key];return _?_():!0},z=()=>{const{name:r,days:_,periods:R}=i.value.basic;return!!(r&&_&&R)},j=()=>i.value.dataProducts.every(r=>r.name&&r.totalAmount),O=()=>i.value.dataProducts.length?i.value.dataProducts.every(r=>{var R;if(!((R=r.scenes)!=null&&R.length))return J.error(`数据产品「${r.name}」未配置场景数据`),!1;const _=r.scenes.reduce((M,d)=>M+Math.round(Number(d.amount||0)),0);if(_!==r.totalAmount){const M=Math.abs(_-r.totalAmount);return J.error(`数据产品「${r.name}」场景分配总量(${_})与产品总量(${r.totalAmount})不一致，还需分配${M}条数据`),!1}return!0}):(J.error("请先添加数据产品"),!1),C=()=>{var _;return(_=i.value.creditProducts)!=null&&_.length?i.value.dataProducts.every(R=>(R.scenes||[]).every(d=>(d.creditProducts||[]).reduce((h,e)=>h+(e.amount||0),0)!==d.amount?(J.error(`数据产品「${R.name}」的场景「${d.sceneName}」信贷产品分配总量不正确`),!1):!0)):(J.error("请选择至少一个信贷产品"),!1)};return S({currentStep:V,steps:w,formData:i,goToNextStep:E,goToPreviousStep:B,currentComponent:P,currentStepProps:D}),(r,_)=>{const R=p("a-step"),M=p("a-steps");return y(),x("div",Ze,[a(M,{current:V.value,class:"steps-nav"},{default:t(()=>[(y(),x(F,null,q(w,d=>a(R,{key:d.key,title:d.title},null,8,["title"])),64))]),_:1},8,["current"]),N("div",et,[(y(),W(ce(P.value),ue(D.value,{onNext:E,onPrev:B}),null,16))])])}}}),nt=H(tt,[["__scopeId","data-v-68710d67"]]);export{nt as default};
