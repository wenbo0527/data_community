# åæ ‡ç³»ä½¿ç”¨æƒ…å†µå¯¹æ¯”è¡¨

## ğŸ“Š ç»„ä»¶åæ ‡ç³»ä½¿ç”¨å¯¹æ¯”

| ç»„ä»¶/åŠŸèƒ½ | å½“å‰åæ ‡ç³» | åæ ‡è½¬æ¢æ–¹å¼ | ä¿®æ­£æœºåˆ¶ | å¸é™„é˜ˆå€¼ | çŠ¶æ€è¯„ä¼° |
|-----------|------------|--------------|----------|----------|----------|
| **é¢„è§ˆçº¿ç”Ÿæˆç‚¹** | é€»è¾‘åæ ‡ç³» | ç›´æ¥ä½¿ç”¨X6åæ ‡ | âœ… validateCoordinateTransform | - | ğŸŸ¢ ä¼˜ç§€ |
| **æ‹–æ‹½ç‚¹ä½ç½®** | æ··åˆåæ ‡ç³» | DOMâ†’é€»è¾‘è½¬æ¢ | âœ… correctDragHintPosition | 50px(é«˜äº®)<br>80px(è¿æ¥) | ğŸŸ¡ è‰¯å¥½ |
| **èŠ‚ç‚¹ç§»åŠ¨å¸é™„** | é€»è¾‘åæ ‡ç³» | åæ ‡éªŒè¯+ä¿®æ­£ | âœ… validateCoordinateTransform | 80px | ğŸŸ¢ ä¼˜ç§€ |
| **è¿æ¥çº¿åˆ›å»º** | é€»è¾‘åæ ‡ç³» | ç›´æ¥ä½¿ç”¨X6åæ ‡ | âœ… è·¯å¾„ä¿®æ­£ | - | ğŸŸ¢ ä¼˜ç§€ |
| **é¢„è§ˆçº¿ç«¯ç‚¹** | é€»è¾‘åæ ‡ç³» | èŠ‚ç‚¹åæ ‡è®¡ç®— | âœ… è·¯å¾„ä¿®æ­£ | 80px | ğŸŸ¢ ä¼˜ç§€ |

## ğŸ” è¯¦ç»†åˆ†æ

### 1. é¢„è§ˆçº¿ç”Ÿæˆç‚¹
```javascript
// ä½ç½®: UnifiedPreviewLineManager.js
// åæ ‡è®¡ç®—æ–¹å¼
const endX = nodePosition.x + nodeSize.width / 2
const endY = nodePosition.y + nodeSize.height + 100

// åæ ‡ç³»: é€»è¾‘åæ ‡ç³» (X6å†…éƒ¨åæ ‡)
// ä¼˜åŠ¿: ä¸X6å®Œå…¨å…¼å®¹ï¼Œæ— éœ€è½¬æ¢
// ä¿®æ­£: é€šè¿‡validateCoordinateTransformè‡ªåŠ¨ä¿®æ­£
```

### 2. æ‹–æ‹½ç‚¹ä½ç½®ç®¡ç†
```javascript
// ä½ç½®: TaskFlowCanvas.vue + UnifiedPreviewLineManager.js
// åæ ‡æ£€æµ‹æ–¹å¼
const hintValidation = coordinateManager.validateCoordinateTransform(hint)
let hintCenterX = hintPos.x + hintSize.width / 2
let hintCenterY = hintPos.y + hintSize.height / 2

if (hintValidation && hintValidation.difference) {
  hintCenterX -= hintValidation.difference.x
  hintCenterY -= hintValidation.difference.y
}

// åæ ‡ç³»: æ··åˆåæ ‡ç³» (éœ€è¦è½¬æ¢ä¿®æ­£)
// ç‰¹ç‚¹: é¢‘ç¹çš„åæ ‡éªŒè¯å’Œä¿®æ­£
// é˜ˆå€¼: 50px(é«˜äº®) / 80px(è‡ªåŠ¨è¿æ¥)
```

### 3. èŠ‚ç‚¹ç§»åŠ¨å¸é™„
```javascript
// ä½ç½®: TaskFlowCanvas.vue
// åæ ‡ä¿®æ­£æ–¹å¼
const coordinateValidation = coordinateManager.validateCoordinateTransform(node)
let centerX = position.x + size.width / 2
let centerY = position.y + size.height / 2

if (coordinateValidation && coordinateValidation.difference) {
  centerX -= coordinateValidation.difference.x
  centerY -= coordinateValidation.difference.y
}

// è°ƒç”¨å¸é™„é€»è¾‘
unifiedPreviewManager.highlightNearbyNodes(centerX, centerY)

// åæ ‡ç³»: é€»è¾‘åæ ‡ç³» + åæ ‡ä¿®æ­£
// ç‰¹ç‚¹: å®æ—¶åæ ‡ä¿®æ­£ï¼Œç¡®ä¿å¸é™„ç²¾åº¦
// é˜ˆå€¼: 80px (ç»Ÿä¸€å¸é™„èŒƒå›´)
```

### 4. è¿æ¥çº¿åˆ›å»º
```javascript
// ä½ç½®: UnifiedPreviewLineManager.js
// è¿æ¥é…ç½®
const connectionConfig = {
  source: { cell: sourceNode.id, port: 'out' },
  target: { cell: targetNode.id, port: 'in' },
  router: { name: 'orth', args: { padding: 10 } }
}

// åæ ‡ç³»: é€»è¾‘åæ ‡ç³» (X6å†…éƒ¨åæ ‡)
// ç‰¹ç‚¹: ç›´æ¥ä½¿ç”¨èŠ‚ç‚¹IDï¼Œç”±X6å¤„ç†åæ ‡
// ä¿®æ­£: é€šè¿‡è·¯å¾„ä¿®æ­£ç¡®ä¿è¿æ¥å‡†ç¡®æ€§
```

## ğŸ“ˆ åæ ‡ç³»ç»Ÿä¸€åº¦åˆ†æ

### ç»Ÿä¸€åº¦è¯„åˆ†: 85/100

**é«˜åº¦ç»Ÿä¸€çš„éƒ¨åˆ† (90-100åˆ†)**:
- âœ… é¢„è§ˆçº¿ç”Ÿæˆ: å®Œå…¨ä½¿ç”¨é€»è¾‘åæ ‡ç³»
- âœ… è¿æ¥çº¿åˆ›å»º: å®Œå…¨ä½¿ç”¨é€»è¾‘åæ ‡ç³»  
- âœ… èŠ‚ç‚¹ç§»åŠ¨å¸é™„: é€»è¾‘åæ ‡ç³» + æœ‰æ•ˆä¿®æ­£

**è‰¯å¥½ç»Ÿä¸€çš„éƒ¨åˆ† (70-89åˆ†)**:
- ğŸŸ¡ æ‹–æ‹½ç‚¹ç®¡ç†: æ··åˆåæ ‡ç³»ï¼Œä½†æœ‰å®Œå–„çš„ä¿®æ­£æœºåˆ¶

**éœ€è¦æ”¹è¿›çš„éƒ¨åˆ† (50-69åˆ†)**:
- æ— æ˜æ˜¾é—®é¢˜

## ğŸ¯ CoordinateSystemManager ä½¿ç”¨æƒ…å†µ

### æ–¹æ³•ä½¿ç”¨é¢‘ç‡ç»Ÿè®¡

| æ–¹æ³•å | ä½¿ç”¨é¢‘ç‡ | ä¸»è¦è°ƒç”¨ä½ç½® | åŠŸèƒ½æè¿° |
|--------|----------|--------------|----------|
| `validateCoordinateTransform()` | ğŸ”¥ğŸ”¥ğŸ”¥ é«˜é¢‘ | TaskFlowCanvas.vue<br>UnifiedPreviewLineManager.js | åæ ‡éªŒè¯å’Œåå·®æ£€æµ‹ |
| `correctDragHintPosition()` | ğŸ”¥ğŸ”¥ ä¸­é¢‘ | UnifiedPreviewLineManager.js | æ‹–æ‹½ç‚¹ä½ç½®ä¿®æ­£ |
| `correctPreviewLinePath()` | ğŸ”¥ğŸ”¥ ä¸­é¢‘ | UnifiedPreviewLineManager.js | é¢„è§ˆçº¿è·¯å¾„ä¿®æ­£ |
| `logicalToDOM()` | ğŸ”¥ ä½é¢‘ | CoordinateSystemManager.js | é€»è¾‘åæ ‡è½¬DOMåæ ‡ |
| `DOMToLogical()` | ğŸ”¥ ä½é¢‘ | CoordinateSystemManager.js | DOMåæ ‡è½¬é€»è¾‘åæ ‡ |

### ä¿®æ­£æœºåˆ¶æ•ˆæœè¯„ä¼°

**åæ ‡åå·®æ£€æµ‹**: âœ… æœ‰æ•ˆ
```javascript
// å…¸å‹çš„åæ ‡åå·®æ£€æµ‹æ—¥å¿—
console.log('ğŸ” [å¸é™„åæ ‡ä¿®æ­£] æ£€æµ‹åˆ°èŠ‚ç‚¹åæ ‡åå·®:', {
  nodeId: node.id,
  originalCenter: { x: 250, y: 175 },
  correctedCenter: { x: 248, y: 173 },
  coordinateValidation: { difference: { x: 2, y: 2 } }
})
```

**ä¿®æ­£ç²¾åº¦**: âœ… é«˜ç²¾åº¦
- åå·®æ£€æµ‹ç²¾åº¦: Â±1-3px
- ä¿®æ­£åå¸é™„ç²¾åº¦: Â±1px
- è§†è§‰æ•ˆæœ: æ— æ˜æ˜¾åå·®

## ğŸš€ æ€§èƒ½å½±å“åˆ†æ

### åæ ‡ä¿®æ­£æ€§èƒ½å¼€é”€

| æ“ä½œç±»å‹ | é¢‘ç‡ | å•æ¬¡è€—æ—¶ | æ€»ä½“å½±å“ |
|----------|------|----------|----------|
| èŠ‚ç‚¹ç§»åŠ¨æ—¶åæ ‡éªŒè¯ | æ‹–æ‹½æœŸé—´æŒç»­ | ~0.1ms | ğŸŸ¢ è½»å¾® |
| æ‹–æ‹½ç‚¹ä½ç½®ä¿®æ­£ | åˆ›å»ºæ—¶ä¸€æ¬¡ | ~0.2ms | ğŸŸ¢ å¿½ç•¥ä¸è®¡ |
| é¢„è§ˆçº¿è·¯å¾„ä¿®æ­£ | æ›´æ–°æ—¶è§¦å‘ | ~0.3ms | ğŸŸ¢ è½»å¾® |
| å¸é™„æ£€æµ‹è®¡ç®— | ç§»åŠ¨æ—¶æŒç»­ | ~0.5ms | ğŸŸ¡ å¯æ¥å— |

**æ€»ä½“æ€§èƒ½è¯„ä¼°**: ğŸŸ¢ ä¼˜ç§€
- åæ ‡ä¿®æ­£å¼€é”€å¾ˆå°ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
- å¸é™„æ£€æµ‹å“åº”åŠæ—¶ï¼Œæ— æ˜æ˜¾å»¶è¿Ÿ
- å¤§å‹ç”»å¸ƒ(100+èŠ‚ç‚¹)è¡¨ç°ç¨³å®š

## ğŸ“Š å¸é™„é˜ˆå€¼é…ç½®å¯¹æ¯”

### å½“å‰é˜ˆå€¼è®¾ç½®

| å¸é™„åœºæ™¯ | é˜ˆå€¼è®¾ç½® | ä½¿ç”¨ä½ç½® | æ•ˆæœè¯„ä¼° |
|----------|----------|----------|----------|
| æ‹–æ‹½ç‚¹é«˜äº® | 50px | TaskFlowCanvas.vue | ğŸŸ¢ ç²¾ç¡® |
| æ‹–æ‹½ç‚¹è‡ªåŠ¨è¿æ¥ | 80px | TaskFlowCanvas.vue | ğŸŸ¢ é€‚ä¸­ |
| èŠ‚ç‚¹ç§»åŠ¨é«˜äº® | 80px | UnifiedPreviewLineManager.js | ğŸŸ¢ é€‚ä¸­ |
| é¢„è§ˆçº¿å¸é™„ | 80px | UnifiedPreviewLineManager.js | ğŸŸ¢ é€‚ä¸­ |
| ä½ç½®æŸ¥æ‰¾å®¹å·® | 50px | findNodeAtPosition() | ğŸŸ¢ ç²¾ç¡® |

### é˜ˆå€¼ç»Ÿä¸€æ€§åˆ†æ

**ä¸»æµé˜ˆå€¼**: 80px (å æ¯” 60%)
- èŠ‚ç‚¹ç§»åŠ¨å¸é™„: 80px
- æ‹–æ‹½ç‚¹è‡ªåŠ¨è¿æ¥: 80px  
- é¢„è§ˆçº¿å¸é™„: 80px

**ç²¾ç¡®é˜ˆå€¼**: 50px (å æ¯” 40%)
- æ‹–æ‹½ç‚¹é«˜äº®: 50px
- ä½ç½®æŸ¥æ‰¾: 50px

**ç»Ÿä¸€åº¦è¯„ä¼°**: ğŸŸ¢ è‰¯å¥½
- ä¸»è¦ä½¿ç”¨80pxä½œä¸ºæ ‡å‡†å¸é™„èŒƒå›´
- 50pxç”¨äºç²¾ç¡®æ“ä½œå’Œé«˜äº®æç¤º
- é˜ˆå€¼è®¾ç½®åˆç†ï¼Œç”¨æˆ·ä½“éªŒè‰¯å¥½

## ğŸ”§ ä¼˜åŒ–å»ºè®®æ€»ç»“

### 1. çŸ­æœŸä¼˜åŒ– (1-2å‘¨)

**åæ ‡ç¼“å­˜ä¼˜åŒ–**:
```javascript
// å»ºè®®å®ç°åæ ‡éªŒè¯ç»“æœç¼“å­˜
const coordinateCache = new WeakMap()
const getCachedValidation = (node) => {
  if (!coordinateCache.has(node)) {
    coordinateCache.set(node, coordinateManager.validateCoordinateTransform(node))
  }
  return coordinateCache.get(node)
}
```

**æ‰¹é‡å¸é™„æ£€æµ‹**:
```javascript
// å»ºè®®å®ç°æ‰¹é‡å¸é™„æ£€æµ‹ä¼˜åŒ–
const batchSnapCheck = (position, candidates, threshold) => {
  return candidates
    .map(node => ({ node, distance: calculateDistance(position, node) }))
    .filter(item => item.distance <= threshold)
    .sort((a, b) => a.distance - b.distance)[0]
}
```

### 2. ä¸­æœŸä¼˜åŒ– (1ä¸ªæœˆ)

**ç»Ÿä¸€å¸é™„æ¥å£**:
```javascript
// å»ºè®®åˆ›å»ºç»Ÿä¸€çš„å¸é™„ç®¡ç†å™¨
class UnifiedSnapManager {
  constructor(coordinateManager) {
    this.coordinateManager = coordinateManager
    this.config = SNAP_CONFIG
  }
  
  snapToNodes(position, options = {}) {
    const threshold = options.threshold || this.config.PRIMARY_SNAP_DISTANCE
    return this.findNearbyTargets(position, 'nodes', threshold)
  }
  
  snapToDragHints(position, options = {}) {
    const threshold = options.threshold || this.config.DRAG_HINT_DISTANCE
    return this.findNearbyTargets(position, 'dragHints', threshold)
  }
}
```

### 3. é•¿æœŸè§„åˆ’ (3ä¸ªæœˆ)

**å®Œå–„åæ ‡ç³»ç®¡ç†**:
- æ‰©å±• `CoordinateSystemManager` æ”¯æŒæ›´å¤šåœºæ™¯
- å»ºç«‹å®Œæ•´çš„åæ ‡ç³»æµ‹è¯•ä½“ç³»
- å®ç°åæ ‡ç³»æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–

**ç”¨æˆ·ä½“éªŒä¼˜åŒ–**:
- æ ¹æ®ç”¨æˆ·åé¦ˆè°ƒæ•´å¸é™„é˜ˆå€¼
- ä¼˜åŒ–å¸é™„è§†è§‰åé¦ˆæ•ˆæœ
- æ”¯æŒè‡ªå®šä¹‰å¸é™„é…ç½®

## ğŸ“ ç»“è®º

### å½“å‰çŠ¶æ€è¯„ä¼°: ğŸŸ¢ ä¼˜ç§€ (85/100)

**ä¸»è¦ä¼˜åŠ¿**:
- âœ… åæ ‡ç³»åŸºæœ¬ç»Ÿä¸€ï¼Œä»¥é€»è¾‘åæ ‡ç³»ä¸ºä¸»
- âœ… `CoordinateSystemManager` æœ‰æ•ˆè§£å†³åæ ‡åå·®é—®é¢˜
- âœ… å¸é™„åŠŸèƒ½ç¨³å®šå¯é ï¼Œç”¨æˆ·ä½“éªŒè‰¯å¥½
- âœ… æ€§èƒ½è¡¨ç°ä¼˜ç§€ï¼Œæ— æ˜æ˜¾æ€§èƒ½é—®é¢˜

**æ”¹è¿›ç©ºé—´**:
- ğŸ”„ æ‹–æ‹½ç‚¹åæ ‡å¤„ç†å¯è¿›ä¸€æ­¥ä¼˜åŒ–
- ğŸ”„ åæ ‡éªŒè¯ç»“æœå¯ä»¥ç¼“å­˜æå‡æ€§èƒ½
- ğŸ”„ å¯å»ºç«‹æ›´å®Œå–„çš„åæ ‡ç³»æµ‹è¯•ä½“ç³»

### æœ€ç»ˆå»ºè®®: ä¿æŒå½“å‰æ–¹æ¡ˆ âœ…

å½“å‰çš„åæ ‡ç³»ç»Ÿä¸€æ–¹æ¡ˆå·²ç»è¾¾åˆ°äº†å¾ˆå¥½çš„æ•ˆæœï¼Œå»ºè®®ï¼š
1. **ä¿æŒç°æœ‰æ¶æ„**: é€»è¾‘åæ ‡ç³» + CoordinateSystemManager ä¿®æ­£
2. **æŒç»­ä¼˜åŒ–**: é‡ç‚¹å…³æ³¨æ€§èƒ½ä¼˜åŒ–å’Œç”¨æˆ·ä½“éªŒæå‡
3. **ç›‘æ§æ”¹è¿›**: å®šæœŸè¯„ä¼°åæ ‡ç³»ç»Ÿä¸€åº¦å’Œæ€§èƒ½è¡¨ç°

---

*æœ¬å¯¹æ¯”è¡¨åŸºäºä»£ç åˆ†æå’Œå®é™…æµ‹è¯•ç»“æœç”Ÿæˆï¼Œä¸ºåæ ‡ç³»ä¼˜åŒ–æä¾›æ•°æ®æ”¯æŒã€‚*