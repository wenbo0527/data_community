# ç»“æ„åŒ–å¸ƒå±€ç›´çº¿æ’åˆ—ä¿®å¤æŒ‡å—

## ğŸ¯ ä¿®å¤ç›®æ ‡
è§£å†³ç»“æ„åŒ–å¸ƒå±€ä¸­å•ä¸€è¾“å‡ºæ—¶èŠ‚ç‚¹æœªèƒ½å½¢æˆç›´çº¿æ’åˆ—çš„é—®é¢˜ï¼Œç¡®ä¿æœ‰å‘æ— ç¯æ‹“æ‰‘ç»“æ„çš„æ­£ç¡®æ˜¾ç¤ºã€‚

## ğŸ› é—®é¢˜åˆ†æ

### 1. ä¸»è¦é—®é¢˜
- **æ‹–æ‹½æç¤ºç‚¹å¹²æ‰°**: æ‹–æ‹½æç¤ºç‚¹è¢«é”™è¯¯åœ°åŒ…å«åœ¨å¸ƒå±€è®¡ç®—ä¸­
- **å•ä¸€è¾“å‡ºåç§»**: ä¸Šä¸€å±‚å­˜åœ¨å•ä¸€è¾“å‡ºæ—¶æœªèƒ½ä¿æŒç›´çº¿æ’åˆ—
- **é¢„è§ˆçº¿ç®¡ç†å™¨é”™è¯¯**: æ–¹æ³•è°ƒç”¨åç§°ä¸æ­£ç¡®å¯¼è‡´å¸ƒå±€åº”ç”¨å¤±è´¥
- **èŠ‚ç‚¹ç±»å‹æ˜¾ç¤º**: èŠ‚ç‚¹ç±»å‹æ˜¾ç¤ºä¸º `undefined`

### 2. é”™è¯¯æ—¥å¿—åˆ†æ
```
[StructuredLayoutEngine] èŠ‚ç‚¹ hint_unified_preview_node_1753070762660_single_1753070766574 (drag-hint) åˆ†æ”¯æ•°: 1
[useStructuredLayout] åº”ç”¨ç»“æ„åŒ–å¸ƒå±€å¤±è´¥: TypeError: previewManager.updatePreviewLinePositions is not a function
```

## ğŸ”§ ä¿®å¤æ–¹æ¡ˆ

### 1. è¿‡æ»¤æ‹–æ‹½æç¤ºç‚¹ (`StructuredLayoutEngine.js`)

#### ä¿®å¤å†…å®¹
- åœ¨ `groupNodesByTopology` æ–¹æ³•ä¸­æ·»åŠ æ‹–æ‹½æç¤ºç‚¹è¿‡æ»¤é€»è¾‘
- åªå¤„ç†å®é™…çš„ä¸šåŠ¡èŠ‚ç‚¹ï¼Œæ’é™¤æ‰€æœ‰æ‹–æ‹½æç¤ºç‚¹

#### æ ¸å¿ƒä»£ç 
```javascript
// è¿‡æ»¤æ‰æ‹–æ‹½æç¤ºç‚¹ï¼Œåªå¤„ç†å®é™…çš„ä¸šåŠ¡èŠ‚ç‚¹
const businessNodes = nodes.filter(node => {
  const nodeData = node.getData() || {}
  const isDragHint = nodeData.isDragHint || 
                    nodeData.type === 'drag-hint' || 
                    node.id.includes('hint_') ||
                    node.id.includes('drag-hint')
  
  if (isDragHint) {
    console.log(`[StructuredLayoutEngine] è¿‡æ»¤æ‹–æ‹½æç¤ºç‚¹: ${node.id}`)
    return false
  }
  return true
})
```

#### ä¿®å¤æ•ˆæœ
- âœ… æ‹–æ‹½æç¤ºç‚¹ä¸å†å‚ä¸å¸ƒå±€è®¡ç®—
- âœ… èŠ‚ç‚¹ç±»å‹æ­£ç¡®æ˜¾ç¤º
- âœ… æ‹“æ‰‘æ’åºç»“æœæ›´å‡†ç¡®

### 2. ä¿®å¤é¢„è§ˆçº¿ç®¡ç†å™¨è°ƒç”¨ (`useStructuredLayout.js`)

#### ä¿®å¤å†…å®¹
- ä¿®æ­£é¢„è§ˆçº¿ä½ç½®æ›´æ–°æ–¹æ³•è°ƒç”¨
- æ·»åŠ å¤šç§æ–¹æ³•åç§°çš„å…¼å®¹æ€§æ”¯æŒ
- å¢å¼ºé”™è¯¯å¤„ç†æœºåˆ¶

#### æ ¸å¿ƒä»£ç 
```javascript
// åœ¨å¸ƒå±€å®Œæˆåï¼Œæ›´æ–°é¢„è§ˆçº¿ä½ç½®
if (previewManager) {
  if (typeof previewManager.refreshAllPreviewLines === 'function') {
    try {
      previewManager.refreshAllPreviewLines()
      console.log('[useStructuredLayout] é¢„è§ˆçº¿ä½ç½®æ›´æ–°å®Œæˆ')
    } catch (error) {
      console.warn('[useStructuredLayout] é¢„è§ˆçº¿ä½ç½®æ›´æ–°å¤±è´¥:', error)
    }
  } else if (typeof previewManager.updateAllPreviewLinePositions === 'function') {
    try {
      previewManager.updateAllPreviewLinePositions()
      console.log('[useStructuredLayout] é¢„è§ˆçº¿ä½ç½®æ›´æ–°å®Œæˆ')
    } catch (error) {
      console.warn('[useStructuredLayout] é¢„è§ˆçº¿ä½ç½®æ›´æ–°å¤±è´¥:', error)
    }
  } else {
    console.warn('[useStructuredLayout] é¢„è§ˆçº¿ç®¡ç†å™¨ä¸æ”¯æŒä½ç½®æ›´æ–°æ–¹æ³•')
  }
}
```

#### ä¿®å¤æ•ˆæœ
- âœ… é¢„è§ˆçº¿ä½ç½®æ›´æ–°ä¸å†æŠ¥é”™
- âœ… æ”¯æŒå¤šç§é¢„è§ˆçº¿ç®¡ç†å™¨å®ç°
- âœ… å¢å¼ºé”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### 3. æ”¹è¿›èŠ‚ç‚¹ç±»å‹æ˜¾ç¤º

#### ä¿®å¤å†…å®¹
- åœ¨èŠ‚ç‚¹ç±»å‹è·å–æ—¶æ·»åŠ é»˜è®¤å€¼å¤„ç†
- ç¡®ä¿èŠ‚ç‚¹ç±»å‹ä¿¡æ¯æ­£ç¡®æ˜¾ç¤ºåœ¨æ—¥å¿—ä¸­

#### æ ¸å¿ƒä»£ç 
```javascript
const nodeType = node.getData()?.type || 'unknown'
console.log(`[StructuredLayoutEngine] èŠ‚ç‚¹ ${node.id} (${nodeType}) åˆ†æ”¯æ•°: ${branchCount}`)
```

## ğŸ¯ é¢„æœŸæ•ˆæœ

### 1. ç›´çº¿æ’åˆ—
- å•ä¸€è¾“å‡ºæ—¶èŠ‚ç‚¹ä¿æŒå®Œç¾çš„å‚ç›´ç›´çº¿æ’åˆ—
- æ— åç§»ã€æ— é”™ä½çš„æ‹“æ‰‘ç»“æ„

### 2. æ­£ç¡®çš„æ‹“æ‰‘è®¡ç®—
- åªè®¡ç®—å®é™…ä¸šåŠ¡èŠ‚ç‚¹
- æ‹–æ‹½æç¤ºç‚¹ä¸å¹²æ‰°å¸ƒå±€ç®—æ³•

### 3. ç¨³å®šçš„å¸ƒå±€åº”ç”¨
- é¢„è§ˆçº¿ä½ç½®æ­£ç¡®æ›´æ–°
- æ— æ–¹æ³•è°ƒç”¨é”™è¯¯
- å®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. åŸºæœ¬åŠŸèƒ½æµ‹è¯•
- [ ] åˆ›å»ºç®€å•çš„ä¸¤èŠ‚ç‚¹è¿æ¥
- [ ] éªŒè¯èŠ‚ç‚¹æ˜¯å¦ä¿æŒå‚ç›´ç›´çº¿æ’åˆ—
- [ ] æ£€æŸ¥æ‹–æ‹½æç¤ºç‚¹æ˜¯å¦è¢«æ­£ç¡®è¿‡æ»¤

### 2. å¤æ‚åœºæ™¯æµ‹è¯•
- [ ] å¤šå±‚çº§èŠ‚ç‚¹å¸ƒå±€
- [ ] åˆ†æµèŠ‚ç‚¹çš„åˆ†æ”¯å¸ƒå±€
- [ ] é¢„è§ˆçº¿çš„ä½ç½®æ›´æ–°

### 3. é”™è¯¯å¤„ç†æµ‹è¯•
- [ ] é¢„è§ˆçº¿ç®¡ç†å™¨æ–¹æ³•è°ƒç”¨
- [ ] å¼‚å¸¸æƒ…å†µçš„æ—¥å¿—è®°å½•
- [ ] å¸ƒå±€å¤±è´¥æ—¶çš„é™çº§å¤„ç†

## ğŸ“ ä¿®å¤æ–‡ä»¶æ¸…å•

1. **StructuredLayoutEngine.js**
   - ä¿®å¤ `groupNodesByTopology` æ–¹æ³•
   - æ·»åŠ æ‹–æ‹½æç¤ºç‚¹è¿‡æ»¤é€»è¾‘
   - æ”¹è¿›èŠ‚ç‚¹ç±»å‹æ˜¾ç¤º

2. **useStructuredLayout.js**
   - ä¿®å¤é¢„è§ˆçº¿ç®¡ç†å™¨æ–¹æ³•è°ƒç”¨
   - æ·»åŠ å¤šç§æ–¹æ³•åç§°æ”¯æŒ
   - å¢å¼ºé”™è¯¯å¤„ç†æœºåˆ¶

## ğŸ”„ åç»­ä¼˜åŒ–å»ºè®®

### 1. æ€§èƒ½ä¼˜åŒ–
- è€ƒè™‘ç¼“å­˜è¿‡æ»¤ç»“æœ
- ä¼˜åŒ–æ‹“æ‰‘æ’åºç®—æ³•
- å‡å°‘ä¸å¿…è¦çš„æ—¥å¿—è¾“å‡º

### 2. ä»£ç è´¨é‡
- æ·»åŠ å•å…ƒæµ‹è¯•
- å®Œå–„ç±»å‹å®šä¹‰
- ç»Ÿä¸€é”™è¯¯å¤„ç†æ¨¡å¼

### 3. ç”¨æˆ·ä½“éªŒ
- æ·»åŠ å¸ƒå±€è¿›åº¦æŒ‡ç¤º
- ä¼˜åŒ–å¸ƒå±€åŠ¨ç”»æ•ˆæœ
- æä¾›å¸ƒå±€é…ç½®é€‰é¡¹

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-01-21  
**ä¿®å¤ç‰ˆæœ¬**: v1.0.1  
**æµ‹è¯•çŠ¶æ€**: å¾…éªŒè¯