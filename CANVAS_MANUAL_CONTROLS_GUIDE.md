# 画布手动控制功能使用说明

## 概述

为了解决画布拖拽时自动居中和自动布局的冲突问题，我们已经将所有自动化功能改为手动触发，并提供了一个专门的手动控制面板。

## 主要变更

### 1. 自动化功能默认禁用
- **自动布局**: 默认禁用，需要手动启用或手动触发
- **自动居中**: 已移除，只保留手动触发
- **自动缩放**: 已移除，只保留手动触发

### 2. 新增手动控制面板
在画布右上角工具栏中新增了"手动控制"按钮，点击可显示/隐藏手动控制面板。

## 手动控制面板功能

### 布局控制
- **应用布局**: 手动触发结构化布局
- **自动布局开关**: 切换自动布局的启用/禁用状态

### 视图控制
- **居中内容**: 手动将画布内容居中
- **适应缩放**: 手动缩放以适应所有内容
- **重置视图**: 重置画布到默认缩放和位置

### 快捷操作
- **布局+居中**: 先应用布局，然后居中内容
- **居中+缩放**: 先居中内容，然后适应缩放

### 高级配置
点击"显示高级选项"可以配置：
- **布局后自动居中**: 是否在布局后自动居中
- **布局后自动缩放**: 是否在布局后自动缩放
- **详细日志**: 是否输出详细的操作日志

## 配置文件

新增了 `canvasAutomationConfig.js` 配置文件，用于集中管理所有自动化功能的开关：

```javascript
// 获取配置
const autoLayoutEnabled = getAutomationConfig('AUTO_LAYOUT', 'ENABLED')

// 设置配置
setAutomationConfig('AUTO_LAYOUT', 'ENABLED', true)

// 重置所有配置
resetAutomationConfig()

// 启用/禁用所有自动化功能
enableAllAutomation()
disableAllAutomation()
```

## 使用建议

### 正常工作流程
1. 添加节点和连接
2. 使用手动控制面板的"应用布局"整理节点位置
3. 根据需要使用"居中内容"或"适应缩放"调整视图

### 避免冲突
- 在拖拽画布时，所有自动化功能都会被暂停
- 手动触发的操作会检查画布拖拽状态，避免冲突
- 如果需要自动化功能，可以在高级配置中启用

### 调试模式
- 启用"详细日志"可以查看所有操作的详细信息
- 配置变更会在控制台输出当前状态

## 技术实现

### 依赖注入
手动控制组件通过 Vue 的 `provide/inject` 机制获取必要的依赖：
- `graph`: X6 图实例
- `structuredLayout`: 结构化布局管理器
- `panZoomManager`: 画布平移缩放管理器

### 状态管理
- 使用响应式状态管理控制面板的显示/隐藏
- 配置状态与全局配置文件同步
- 操作状态防止重复执行

### 样式设计
- 面板采用现代化的卡片设计
- 支持动画过渡效果
- 响应式布局适应不同屏幕尺寸

## 故障排除

### 如果手动控制面板不显示
1. 检查是否在只读模式下（readonly=true）
2. 确认工具栏中的"手动控制"按钮是否可见
3. 查看控制台是否有错误信息

### 如果操作无效果
1. 检查画布是否正在拖拽中
2. 确认相关管理器是否正确初始化
3. 启用详细日志查看具体错误

### 如果配置不生效
1. 检查配置文件是否正确导入
2. 确认配置键名是否正确
3. 重置配置后重新设置

## 文件结构

```
src/
├── components/
│   └── CanvasManualControls.vue          # 手动控制组件
├── config/
│   └── canvasAutomationConfig.js         # 自动化配置文件
├── composables/
│   └── useStructuredLayout.js            # 结构化布局管理（已更新）
└── pages/marketing/tasks/components/
    └── TaskFlowCanvas.vue                # 主画布组件（已更新）
```

这个实现完全解决了画布拖拽时的自动居中冲突问题，同时提供了更好的用户控制体验。