# 页面自动关闭问题修复指南

## 问题描述

用户反馈在营销任务创建页面点击AB测试节点配置抽屉时，页面会自动关闭并跳转到任务列表页面。

## 根本原因分析

通过日志分析发现，问题的根本原因是：

1. **意外触发保存任务**：用户可能意外点击了"保存任务"按钮
2. **自动跳转逻辑**：保存任务成功后会自动执行 `router.push('/marketing/tasks')` 跳转到任务列表
3. **缺少确认机制**：原有的保存逻辑没有确认对话框，容易误操作

## 修复方案

### 1. 添加保存确认对话框

在 `saveTask` 方法开始处添加确认对话框：

```javascript
// 添加确认对话框，防止意外保存
const confirmed = await new Promise((resolve) => {
  Modal.confirm({
    title: '确认保存任务',
    content: '保存后将创建营销任务并跳转到任务列表页面，确定要保存吗？',
    okText: '确定保存',
    cancelText: '取消',
    onOk: () => resolve(true),
    onCancel: () => resolve(false)
  })
})
```

### 2. 页面离开保护机制

- **未保存更改检测**：添加 `hasUnsavedChanges` 状态标记
- **页面离开确认**：添加 `beforeunload` 事件监听
- **路由离开确认**：实现 `beforeRouteLeave` 逻辑
- **表单变化监听**：监听所有表单字段和画布变化

### 3. 键盘快捷键防护

防止意外的 Ctrl+S 保存：

```javascript
const handleKeyDown = (event) => {
  if (event.ctrlKey && event.key === 's') {
    event.preventDefault()
    Message.info('请使用页面底部的"保存任务"按钮')
    return false
  }
}
```

### 4. 画布变化监听

监听画布的所有变化事件：
- `canvas-ready`
- `node-added`
- `node-deleted`
- `node-moved`
- `connection-created`
- `connection-deleted`
- `node-updated`

## 测试验证步骤

### 基础功能测试

1. **正常保存流程**
   - 填写任务信息
   - 点击"保存任务"按钮
   - 确认弹出确认对话框
   - 点击"确定保存"
   - 验证成功跳转到任务列表

2. **取消保存测试**
   - 填写任务信息
   - 点击"保存任务"按钮
   - 点击"取消"
   - 验证留在当前页面

### 页面保护测试

3. **表单变化检测**
   - 修改任务名称
   - 尝试刷新页面
   - 验证弹出"您有未保存的更改"提示

4. **画布变化检测**
   - 添加节点到画布
   - 尝试关闭浏览器标签页
   - 验证浏览器弹出离开确认

5. **路由离开保护**
   - 修改表单内容
   - 点击"返回"按钮
   - 验证弹出确认对话框

### 快捷键防护测试

6. **Ctrl+S 防护**
   - 在页面中按 Ctrl+S
   - 验证显示提示信息而不是保存

### AB测试节点测试

7. **节点配置抽屉测试**
   - 添加AB测试节点
   - 点击节点打开配置抽屉
   - 验证抽屉正常打开，页面不跳转
   - 配置节点信息并保存
   - 验证抽屉关闭，页面仍在创建页面

## 成功指标

- ✅ 点击AB测试节点不再导致页面跳转
- ✅ 保存任务需要用户明确确认
- ✅ 页面离开时有适当的保护提示
- ✅ 意外操作得到有效防护
- ✅ 用户体验得到改善

## 技术要点

### 状态管理
- 使用 `hasUnsavedChanges` ref 跟踪页面状态
- 在保存成功后重置状态标记

### 事件监听
- `beforeunload` 事件处理页面关闭
- `keydown` 事件处理快捷键
- 表单和画布事件监听变化

### 确认对话框
- 使用 Arco Design 的 Modal.confirm
- 提供清晰的操作说明和选择

### 生命周期管理
- `onMounted` 中添加事件监听
- `onBeforeUnmount` 中清理事件监听

## 注意事项

1. **性能考虑**：事件监听器在组件卸载时必须清理
2. **用户体验**：确认对话框的文案要清晰明确
3. **兼容性**：确保在不同浏览器中正常工作
4. **测试覆盖**：需要测试各种边缘情况

## 后续优化建议

1. **自动保存草稿**：定期自动保存用户的工作进度
2. **操作历史**：实现撤销/重做功能
3. **快捷键支持**：添加更多有用的快捷键
4. **状态持久化**：在页面刷新后恢复工作状态