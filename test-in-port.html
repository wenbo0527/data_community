<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>inç«¯å£ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .log-output {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        button {
            background: #4299e1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #3182ce;
        }
        .test-results {
            margin-top: 20px;
        }
        .result-item {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #4299e1;
            background: #f7fafc;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª æ¨ªå‘ç”»å¸ƒinç«¯å£ä¿®å¤éªŒè¯æµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>ğŸ“‹ æµ‹è¯•è¯´æ˜</h2>
            <p>æœ¬æµ‹è¯•ç”¨äºéªŒè¯æ¨ªå‘ç”»å¸ƒä¸­inç«¯å£ä¿®å¤æ•ˆæœï¼š</p>
            <ul>
                <li><strong>inç«¯å£</strong>ï¼šåº”è¯¥å§‹ç»ˆä½äºèŠ‚ç‚¹å‚ç›´ä¸­å¿ƒï¼Œdy=0</li>
                <li><strong>outç«¯å£</strong>ï¼šåº”è¯¥ä¸å†…å®¹è¡Œå¯¹é½ï¼Œæœ‰æ­£ç¡®çš„rowIndex</li>
                <li><strong>ç«¯å£è¯†åˆ«</strong>ï¼šåº”è¯¥èƒ½æ­£ç¡®åŒºåˆ†inç«¯å£å’Œoutç«¯å£</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>ğŸ¯ æµ‹è¯•æ“ä½œ</h2>
            <button onclick="runTest()">ğŸ§ª è¿è¡Œæµ‹è¯•</button>
            <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
            <button onclick="navigateToCanvas()">ğŸ–¼ï¸ æ‰“å¼€æ¨ªå‘ç”»å¸ƒ</button>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š æµ‹è¯•ç»“æœ</h2>
            <div id="test-results" class="test-results"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“ è°ƒè¯•æ—¥å¿—</h2>
            <div id="log-output" class="log-output">ç­‰å¾…æµ‹è¯•è¿è¡Œ...</div>
        </div>
    </div>

    <script>
        let testResults = [];

        function log(message, type = 'info') {
            const logOutput = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            
            if (type === 'error') {
                console.error(logEntry);
            } else if (type === 'warn') {
                console.warn(logEntry);
            } else {
                console.log(logEntry);
            }
            
            logOutput.textContent += logEntry + '\n';
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        function addResult(test, status, message, details = {}) {
            testResults.push({ test, status, message, details, time: new Date().toLocaleTimeString() });
            updateResultsDisplay();
        }

        function updateResultsDisplay() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = testResults.map(result => {
                const statusClass = result.status === 'pass' ? 'success' : 
                                  result.status === 'fail' ? 'error' : 'warning';
                const statusText = result.status === 'pass' ? 'âœ… é€šè¿‡' : 
                                 result.status === 'fail' ? 'âŒ å¤±è´¥' : 'âš ï¸ è­¦å‘Š';
                
                let detailsHtml = '';
                if (Object.keys(result.details).length > 0) {
                    detailsHtml = '<div style="margin-top: 10px; font-size: 12px;">' +
                        Object.entries(result.details).map(([key, value]) => 
                            `<div><strong>${key}:</strong> ${JSON.stringify(value)}</div>`
                        ).join('') + '</div>';
                }
                
                return `<div class="result-item">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>${result.test}</strong>
                        <span class="status ${statusClass}">${statusText}</span>
                    </div>
                    <div style="margin-top: 5px; color: #666;">${result.message}</div>
                    ${detailsHtml}
                    <div style="margin-top: 5px; font-size: 11px; color: #999;">${result.time}</div>
                </div>`;
            }).join('');
        }

        function clearLog() {
            document.getElementById('log-output').textContent = '';
            testResults = [];
            updateResultsDisplay();
            log('ğŸ—‘ï¸ æ—¥å¿—å·²æ¸…é™¤');
        }

        function navigateToCanvas() {
            window.open('/src/pages/marketing/tasks/horizontal/', '_blank');
            log('ğŸ–¼ï¸ å·²æ‰“å¼€æ¨ªå‘ç”»å¸ƒé¡µé¢');
        }

        async function runTest() {
            testResults = [];
            clearLog();
            log('ğŸ§ª å¼€å§‹è¿è¡Œinç«¯å£ä¿®å¤éªŒè¯æµ‹è¯•...', 'info');

            try {
                // ç­‰å¾…é¡µé¢åŠ è½½
                await new Promise(resolve => setTimeout(resolve, 1000));

                // è·å–graphå®ä¾‹
                const graph = window.horizontalGraph || window.graph;
                if (!graph) {
                    log('âŒ æœªæ‰¾åˆ°graphå®ä¾‹ï¼Œè¯·ç¡®ä¿åœ¨æ¨ªå‘ç”»å¸ƒé¡µé¢è¿è¡Œ', 'error');
                    addResult('graphå®ä¾‹æ£€æµ‹', 'fail', 'æœªæ‰¾åˆ°graphå®ä¾‹');
                    return;
                }

                log('âœ… æ‰¾åˆ°graphå®ä¾‹');
                addResult('graphå®ä¾‹æ£€æµ‹', 'pass', 'æˆåŠŸè·å–graphå®ä¾‹');

                // æŸ¥æ‰¾æµ‹è¯•èŠ‚ç‚¹
                const nodes = graph.getNodes();
                log(`ğŸ“Š ç”»å¸ƒä¸­å…±æœ‰ ${nodes.length} ä¸ªèŠ‚ç‚¹`);

                if (nodes.length === 0) {
                    log('âš ï¸ ç”»å¸ƒä¸­æ²¡æœ‰èŠ‚ç‚¹ï¼Œæ— æ³•æµ‹è¯•', 'warn');
                    addResult('èŠ‚ç‚¹æ£€æµ‹', 'warn', 'ç”»å¸ƒä¸­æ²¡æœ‰èŠ‚ç‚¹');
                    return;
                }

                // ä¼˜å…ˆé€‰æ‹©splitç±»å‹èŠ‚ç‚¹
                let testNode = nodes.find(node => {
                    const data = node.getData();
                    return data && (data.nodeType === 'crowd-split' || data.nodeType === 'audience-split');
                });

                if (!testNode) {
                    log('âš ï¸ æœªæ‰¾åˆ°splitç±»å‹èŠ‚ç‚¹ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œæµ‹è¯•');
                    testNode = nodes[0];
                }

                const nodeData = testNode.getData();
                const nodeType = nodeData?.nodeType || 'unknown';

                log(`ğŸ¯ é€‰æ‹©æµ‹è¯•èŠ‚ç‚¹: ID=${testNode.id}, ç±»å‹=${nodeType}`);
                addResult('èŠ‚ç‚¹é€‰æ‹©', 'pass', `é€‰æ‹©èŠ‚ç‚¹ ${testNode.id} (ç±»å‹: ${nodeType})`);

                // è·å–ç«¯å£ä¿¡æ¯
                const ports = testNode.getPorts();
                log(`ğŸ” èŠ‚ç‚¹å…±æœ‰ ${ports.length} ä¸ªç«¯å£`);

                // åˆ†æç«¯å£
                const inPorts = ports.filter(p => p.group === 'in' || p.id === 'in');
                const outPorts = ports.filter(p => p.group === 'out' || p.id?.startsWith('out'));

                log(`ğŸ“ ç«¯å£åˆ†æ: inç«¯å£=${inPorts.length}, outç«¯å£=${outPorts.length}`);

                // éªŒè¯inç«¯å£
                if (inPorts.length === 0) {
                    log('âš ï¸ æœªæ‰¾åˆ°inç«¯å£', 'warn');
                    addResult('inç«¯å£æ£€æµ‹', 'warn', 'æœªæ‰¾åˆ°inç«¯å£');
                } else {
                    log(`âœ… æ‰¾åˆ° ${inPorts.length} ä¸ªinç«¯å£`);
                    
                    inPorts.forEach((port, index) => {
                        const args = port.args || {};
                        const dy = args.dy || 0;
                        
                        log(`ğŸ” inç«¯å£ ${port.id}: dy=${dy}`);
                        
                        if (dy === 0) {
                            log(`âœ… inç«¯å£ ${port.id} æ­£ç¡®ä½äºèŠ‚ç‚¹ä¸­å¿ƒ (dy=0)`);
                            addResult(`inç«¯å£ ${port.id}`, 'pass', 'æ­£ç¡®ä½äºèŠ‚ç‚¹ä¸­å¿ƒ', { dy });
                        } else {
                            log(`âŒ inç«¯å£ ${port.id} æœ‰åç§» (dy=${dy})ï¼Œåº”è¯¥ä¸º0`, 'error');
                            addResult(`inç«¯å£ ${port.id}`, 'fail', 'æœ‰åç§»ï¼Œåº”è¯¥ä½äºèŠ‚ç‚¹ä¸­å¿ƒ', { dy, expectedDy: 0 });
                        }
                    });
                }

                // éªŒè¯outç«¯å£
                if (outPorts.length === 0) {
                    log('âš ï¸ æœªæ‰¾åˆ°outç«¯å£', 'warn');
                    addResult('outç«¯å£æ£€æµ‹', 'warn', 'æœªæ‰¾åˆ°outç«¯å£');
                } else {
                    log(`âœ… æ‰¾åˆ° ${outPorts.length} ä¸ªoutç«¯å£`);
                    
                    outPorts.forEach((port, index) => {
                        const args = port.args || {};
                        log(`ğŸ” outç«¯å£ ${port.id}:`, args);
                        
                        if (args.rowIndex !== undefined) {
                            log(`âœ… outç«¯å£ ${port.id} æœ‰æ­£ç¡®çš„è¡Œç´¢å¼•: ${args.rowIndex}`);
                            addResult(`outç«¯å£ ${port.id}`, 'pass', 'æœ‰æ­£ç¡®çš„è¡Œç´¢å¼•', args);
                        } else {
                            log(`âš ï¸ outç«¯å£ ${port.id} ç¼ºå°‘è¡Œç´¢å¼•ä¿¡æ¯`, 'warn');
                            addResult(`outç«¯å£ ${port.id}`, 'warn', 'ç¼ºå°‘è¡Œç´¢å¼•ä¿¡æ¯', args);
                        }
                    });
                }

                // è·å–èŠ‚ç‚¹BBoxè¿›è¡ŒéªŒè¯
                const bbox = testNode.getBBox();
                const nodeCenterY = bbox.y + bbox.height / 2;
                log(`ğŸ“ èŠ‚ç‚¹ä¸­å¿ƒYåæ ‡: ${nodeCenterY}`);

                // DOMéªŒè¯
                const view = graph.findViewByCell(testNode);
                if (view) {
                    log('ğŸ” è¿›è¡ŒDOMéªŒè¯...');
                    const container = view.container;
                    const portElements = container.querySelectorAll('[data-port], [port]');
                    
                    log(`   - æ‰¾åˆ° ${portElements.length} ä¸ªç«¯å£DOMå…ƒç´ `);
                    
                    portElements.forEach((el, index) => {
                        const portId = el.getAttribute('data-port') || el.getAttribute('port') || el.id || `port-${index}`;
                        const rect = el.getBoundingClientRect();
                        const centerY = rect.top + rect.height / 2;
                        
                        log(`   - ç«¯å£ ${portId}: å±å¹•ä¸­å¿ƒY=${centerY}`);
                    });
                    
                    addResult('DOMéªŒè¯', 'pass', `æ‰¾åˆ° ${portElements.length} ä¸ªç«¯å£DOMå…ƒç´ `);
                }

                log('ğŸ‰ inç«¯å£ä¿®å¤éªŒè¯æµ‹è¯•å®Œæˆï¼', 'info');
                addResult('æµ‹è¯•å®Œæˆ', 'pass', 'æ‰€æœ‰æµ‹è¯•é¡¹ç›®å·²å®Œæˆ');

            } catch (error) {
                log(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
                console.error('æµ‹è¯•é”™è¯¯:', error);
                addResult('æµ‹è¯•æ‰§è¡Œ', 'fail', `å‘ç”Ÿé”™è¯¯: ${error.message}`);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡Œæµ‹è¯•
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡è¿è¡Œæµ‹è¯•...');
            }, 1000);
        });
    </script>
</body>
</html>