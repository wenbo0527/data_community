<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIæµ‹è¯• - Customer360</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .status-info { background-color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Customer360 API æ·±åº¦æµ‹è¯•</h1>
        
        <div class="test-section info">
            <h3>ğŸ“Š æµ‹è¯•æ§åˆ¶é¢æ¿</h3>
            <button onclick="testDirectAPI()">ğŸš€ æµ‹è¯•APIè°ƒç”¨</button>
            <button onclick="testPageLoad()">ğŸ“„ æµ‹è¯•é¡µé¢åŠ è½½</button>
            <button onclick="testDataFlow()">ğŸ”„ æµ‹è¯•æ•°æ®æµ</button>
            <button onclick="checkMemoryLeaks()">ğŸ§  æ£€æŸ¥å†…å­˜æ³„æ¼</button>
            <button onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“ˆ æµ‹è¯•çŠ¶æ€</h3>
            <div id="test-status">
                <div><span class="status-indicator status-info"></span>ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ è¯¦ç»†æ—¥å¿—</h3>
            <div id="log-output" class="log-output">ç­‰å¾…æµ‹è¯•ç»“æœ...
            </div>
        </div>
    </div>

    <script type="module">
        let logOutput = document.getElementById('log-output');
        let testStatus = document.getElementById('test-status');
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logOutput.textContent += logEntry;
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            const statusClass = `status-${type}`;
            testStatus.innerHTML = `<div><span class="status-indicator ${statusClass}"></span>${message}</div>`;
        }
        
        window.clearLogs = function() {
            logOutput.textContent = '';
            updateStatus('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }
        
        // æµ‹è¯•ç›´æ¥APIè°ƒç”¨
        window.testDirectAPI = async function() {
            addLog('ğŸš€ å¼€å§‹æµ‹è¯•APIè°ƒç”¨...');
            updateStatus('æ­£åœ¨æµ‹è¯•APIè°ƒç”¨...', 'warning');
            
            try {
                // åŠ¨æ€å¯¼å…¥APIå‡½æ•°
                const { fetchUserInfo } = await import('./src/mock/customer360.ts');
                addLog('âœ… APIæ¨¡å—å¯¼å…¥æˆåŠŸ');
                
                // æµ‹è¯•APIè°ƒç”¨
                addLog('ğŸ“ è°ƒç”¨ fetchUserInfo("887123")...');
                const result = await fetchUserInfo('887123');
                
                addLog('âœ… APIè°ƒç”¨æˆåŠŸ');
                addLog(`ğŸ“Š è¿”å›æ•°æ®ç±»å‹: ${typeof result}`);
                addLog(`ğŸ“Š è¿”å›æ•°æ®æ˜¯å¦ä¸ºnull: ${result === null}`);
                addLog(`ğŸ“Š è¿”å›æ•°æ®æ˜¯å¦ä¸ºundefined: ${result === undefined}`);
                
                if (result) {
                    addLog(`ğŸ“Š è¿”å›æ•°æ®é”®: ${Object.keys(result).join(', ')}`);
                    addLog(`ğŸ“Š æ˜¯å¦æœ‰errorå±æ€§: ${'error' in result}`);
                    addLog(`ğŸ“Š æ˜¯å¦æœ‰basicInfo: ${'basicInfo' in result}`);
                    
                    if (result.error) {
                        addLog(`âŒ APIè¿”å›é”™è¯¯: ${result.error}`);
                        addLog(`âŒ é”™è¯¯æ¶ˆæ¯: ${result.message}`);
                        updateStatus('APIè¿”å›é”™è¯¯', 'error');
                    } else {
                        addLog('âœ… APIè¿”å›æ­£å¸¸æ•°æ®');
                        addLog(`ğŸ‘¤ ç”¨æˆ·å§“å: ${result.basicInfo?.name || 'æœªçŸ¥'}`);
                        addLog(`ğŸ“± ç”¨æˆ·æ‰‹æœº: ${result.basicInfo?.phone || 'æœªçŸ¥'}`);
                        addLog(`ğŸ¦ è‡ªè¥äº§å“æ•°é‡: ${result.selfProducts?.length || 0}`);
                        addLog(`ğŸ’° åŠ©è´·äº§å“æ•°é‡: ${result.loanProducts?.length || 0}`);
                        updateStatus('APIæµ‹è¯•æˆåŠŸ', 'success');
                    }
                } else {
                    addLog('âŒ APIè¿”å›nullæˆ–undefined');
                    updateStatus('APIè¿”å›ç©ºæ•°æ®', 'error');
                }
                
            } catch (error) {
                addLog(`âŒ APIè°ƒç”¨å¼‚å¸¸: ${error.message}`);
                addLog(`âŒ é”™è¯¯å †æ ˆ: ${error.stack}`);
                updateStatus('APIæµ‹è¯•å¤±è´¥', 'error');
            }
        }
        
        // æµ‹è¯•é¡µé¢åŠ è½½
        window.testPageLoad = function() {
            addLog('ğŸ“„ å¼€å§‹æµ‹è¯•é¡µé¢åŠ è½½...');
            updateStatus('æ­£åœ¨æµ‹è¯•é¡µé¢åŠ è½½...', 'warning');
            
            // æ‰“å¼€Customer360é¡µé¢
            const testWindow = window.open('/discovery/customer360/887123', '_blank');
            
            if (testWindow) {
                addLog('âœ… é¡µé¢çª—å£å·²æ‰“å¼€');
                
                // ç›‘å¬é¡µé¢åŠ è½½
                testWindow.addEventListener('load', () => {
                    addLog('âœ… é¡µé¢åŠ è½½å®Œæˆ');
                    
                    // æ£€æŸ¥é¡µé¢å†…å®¹
                    setTimeout(() => {
                        try {
                            const doc = testWindow.document;
                            const hasContent = doc.body.children.length > 0;
                            const hasVueApp = doc.querySelector('#app') !== null;
                            const hasLoadingSpinner = doc.querySelector('.arco-spin') !== null;
                            
                            addLog(`ğŸ“Š é¡µé¢æœ‰å†…å®¹: ${hasContent}`);
                            addLog(`ğŸ“Š æœ‰Vueåº”ç”¨: ${hasVueApp}`);
                            addLog(`ğŸ“Š æœ‰åŠ è½½åŠ¨ç”»: ${hasLoadingSpinner}`);
                            
                            if (hasContent && hasVueApp) {
                                updateStatus('é¡µé¢åŠ è½½æˆåŠŸ', 'success');
                            } else {
                                updateStatus('é¡µé¢åŠ è½½å¼‚å¸¸', 'error');
                            }
                        } catch (e) {
                            addLog(`âŒ æ— æ³•è®¿é—®é¡µé¢å†…å®¹: ${e.message}`);
                            updateStatus('é¡µé¢è®¿é—®å—é™', 'warning');
                        }
                    }, 2000);
                });
                
                testWindow.addEventListener('error', (e) => {
                    addLog(`âŒ é¡µé¢åŠ è½½é”™è¯¯: ${e.message}`);
                    updateStatus('é¡µé¢åŠ è½½å¤±è´¥', 'error');
                });
            } else {
                addLog('âŒ æ— æ³•æ‰“å¼€é¡µé¢çª—å£');
                updateStatus('é¡µé¢æ‰“å¼€å¤±è´¥', 'error');
            }
        }
        
        // æµ‹è¯•æ•°æ®æµ
        window.testDataFlow = async function() {
            addLog('ğŸ”„ å¼€å§‹æµ‹è¯•æ•°æ®æµ...');
            updateStatus('æ­£åœ¨æµ‹è¯•æ•°æ®æµ...', 'warning');
            
            try {
                // æ¨¡æ‹ŸVueç»„ä»¶çš„æ•°æ®æµ
                const { fetchUserInfo } = await import('./src/mock/customer360.ts');
                
                // æ¨¡æ‹ŸloadingçŠ¶æ€
                let loading = true;
                let userInfo = null;
                let error = null;
                
                addLog('ğŸ“Š åˆå§‹çŠ¶æ€:');
                addLog(`  loading: ${loading}`);
                addLog(`  userInfo: ${userInfo}`);
                addLog(`  error: ${error}`);
                
                // æ¨¡æ‹ŸAPIè°ƒç”¨
                addLog('ğŸ“ å¼€å§‹APIè°ƒç”¨...');
                try {
                    const response = await fetchUserInfo('887123');
                    
                    if (response && response.error) {
                        // APIè¿”å›é”™è¯¯
                        userInfo = {
                            error: true,
                            errorType: response.error,
                            errorMessage: response.message || 'ç”¨æˆ·ä¸å­˜åœ¨',
                            userId: '887123'
                        };
                        addLog('ğŸ“Š APIè¿”å›é”™è¯¯ï¼Œè®¾ç½®é”™è¯¯çŠ¶æ€');
                    } else {
                        // APIè¿”å›æ­£å¸¸æ•°æ®
                        userInfo = response;
                        addLog('ğŸ“Š APIè¿”å›æ­£å¸¸æ•°æ®');
                    }
                } catch (apiError) {
                    error = apiError.message;
                    addLog(`ğŸ“Š APIè°ƒç”¨å¼‚å¸¸: ${error}`);
                } finally {
                    loading = false;
                }
                
                addLog('ğŸ“Š æœ€ç»ˆçŠ¶æ€:');
                addLog(`  loading: ${loading}`);
                addLog(`  userInfo: ${userInfo ? (userInfo.error ? 'é”™è¯¯å¯¹è±¡' : 'æ­£å¸¸æ•°æ®') : 'null'}`);
                addLog(`  error: ${error}`);
                
                // æ¨¡æ‹Ÿæ¡ä»¶æ¸²æŸ“é€»è¾‘
                addLog('ğŸ­ æ¨¡æ‹Ÿæ¡ä»¶æ¸²æŸ“:');
                if (loading) {
                    addLog('  â†’ æ˜¾ç¤ºåŠ è½½çŠ¶æ€');
                } else if (userInfo && userInfo.error) {
                    addLog('  â†’ æ˜¾ç¤ºé”™è¯¯é¡µé¢');
                } else if (!userInfo) {
                    addLog('  â†’ æ˜¾ç¤ºæ— æ•°æ®çŠ¶æ€');
                } else {
                    addLog('  â†’ æ˜¾ç¤ºä¸»è¦å†…å®¹');
                }
                
                updateStatus('æ•°æ®æµæµ‹è¯•å®Œæˆ', 'success');
                
            } catch (error) {
                addLog(`âŒ æ•°æ®æµæµ‹è¯•å¤±è´¥: ${error.message}`);
                updateStatus('æ•°æ®æµæµ‹è¯•å¤±è´¥', 'error');
            }
        }
        
        // æ£€æŸ¥å†…å­˜æ³„æ¼
        window.checkMemoryLeaks = function() {
            addLog('ğŸ§  å¼€å§‹æ£€æŸ¥å†…å­˜æ³„æ¼...');
            updateStatus('æ­£åœ¨æ£€æŸ¥å†…å­˜æ³„æ¼...', 'warning');
            
            // æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨
            const eventTargets = [window, document, document.body];
            let totalListeners = 0;
            
            eventTargets.forEach((target, index) => {
                const targetName = ['window', 'document', 'document.body'][index];
                
                // æ£€æŸ¥å¸¸è§äº‹ä»¶ç±»å‹
                const eventTypes = ['click', 'scroll', 'resize', 'load', 'unload', 'beforeunload'];
                
                eventTypes.forEach(eventType => {
                    // è¿™é‡Œåªèƒ½æ£€æµ‹åˆ°æˆ‘ä»¬èƒ½è®¿é—®çš„ç›‘å¬å™¨
                    // å®é™…çš„Vueåº”ç”¨å¯èƒ½æœ‰æ›´å¤šå†…éƒ¨ç›‘å¬å™¨
                    try {
                        const listeners = target.getEventListeners ? target.getEventListeners(eventType) : [];
                        if (listeners && listeners.length > 0) {
                            totalListeners += listeners.length;
                            addLog(`ğŸ“Š ${targetName}.${eventType}: ${listeners.length} ä¸ªç›‘å¬å™¨`);
                        }
                    } catch (e) {
                        // getEventListeners åœ¨æŸäº›æµè§ˆå™¨ä¸­ä¸å¯ç”¨
                    }
                });
            });
            
            // æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
            if (performance.memory) {
                const memory = performance.memory;
                addLog('ğŸ“Š å†…å­˜ä½¿ç”¨æƒ…å†µ:');
                addLog(`  å·²ä½¿ç”¨: ${(memory.usedJSHeapSize / 1024 / 1024).toFixed(2)} MB`);
                addLog(`  æ€»åˆ†é…: ${(memory.totalJSHeapSize / 1024 / 1024).toFixed(2)} MB`);
                addLog(`  é™åˆ¶: ${(memory.jsHeapSizeLimit / 1024 / 1024).toFixed(2)} MB`);
                
                const usagePercent = (memory.usedJSHeapSize / memory.jsHeapSizeLimit * 100).toFixed(2);
                addLog(`  ä½¿ç”¨ç‡: ${usagePercent}%`);
                
                if (usagePercent > 80) {
                    updateStatus('å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜', 'error');
                } else if (usagePercent > 60) {
                    updateStatus('å†…å­˜ä½¿ç”¨ç‡è¾ƒé«˜', 'warning');
                } else {
                    updateStatus('å†…å­˜ä½¿ç”¨æ­£å¸¸', 'success');
                }
            } else {
                addLog('âŒ æ— æ³•è·å–å†…å­˜ä¿¡æ¯ï¼ˆæµè§ˆå™¨ä¸æ”¯æŒï¼‰');
                updateStatus('å†…å­˜æ£€æŸ¥å®Œæˆ', 'info');
            }
            
            addLog(`ğŸ“Š æ£€æµ‹åˆ° ${totalListeners} ä¸ªäº‹ä»¶ç›‘å¬å™¨`);
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¼€å§‹æµ‹è¯•
        addLog('ğŸ‰ APIæµ‹è¯•å·¥å…·å·²åŠ è½½');
        addLog('ğŸ’¡ ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•');
    </script>
</body>
</html>