# 外数评估Mock配置修复开发日志

**日期**: 2025-08-07  
**功能模块编号**: 003  
**功能模块描述**: 外数评估Mock数据配置修复  

## 需求背景

在外数评估功能开发过程中，发现Mock数据无法正常工作，API请求返回HTML页面而非预期的JSON数据。需要修复Mock配置，确保开发环境下API能正常返回模拟数据。

## 架构设计

### 原有问题分析
1. **Mock.js配置问题**: 原有的Mock.js在Vite环境下无法正确拦截请求
2. **Vite代理冲突**: Vite的代理配置与Mock.js产生冲突
3. **插件配置缺失**: 项目已安装`vite-plugin-mock`但未在配置中启用

### 解决方案设计
1. **引入vite-plugin-mock**: 使用专门的Vite插件处理Mock数据
2. **转换Mock文件格式**: 将Mock.js格式转换为vite-plugin-mock兼容格式
3. **清理冲突配置**: 移除Vite代理配置和旧的Mock引入

## 测试用例

### 测试场景1: 外数评估详情API
- **测试URL**: `GET /api/external-data-evaluation/detail/14`
- **预期结果**: 返回包含报告详情的JSON数据
- **测试命令**: `curl -s "http://localhost:5174/api/external-data-evaluation/detail/14"`

### 测试场景2: 外数评估列表API
- **测试URL**: `GET /api/external-data-evaluation/list?page=1&pageSize=5`
- **预期结果**: 返回包含5条记录的列表数据
- **测试命令**: `curl -s "http://localhost:5174/api/external-data-evaluation/list?page=1&pageSize=5"`

### 测试场景3: 创建评估报告API
- **测试URL**: `POST /api/external-data-evaluation/create`
- **预期结果**: 返回创建成功的响应

### 测试场景4: 获取已注册产品列表API
- **测试URL**: `GET /api/external-data-evaluation/products`
- **预期结果**: 返回产品列表数据

## 代码实现

### 1. Vite配置修改
```javascript
// vite.config.js
import { viteMockServe } from 'vite-plugin-mock'

export default defineConfig({
  plugins: [
    vue(),
    viteMockServe({
      mockPath: 'src/mock',
      enable: true
    })
  ],
  // 移除了冲突的代理配置
})
```

### 2. Mock文件转换
将`external-data-evaluation.js`转换为TypeScript格式的`external-data-evaluation.ts`:

```typescript
// src/mock/external-data-evaluation.ts
export default [
  {
    url: '/api/external-data-evaluation/list',
    method: 'get',
    response: ({ query }) => {
      const { page = 1, pageSize = 10, status, productName } = query;
      // 生成模拟数据逻辑
    }
  },
  {
    url: /\/api\/external-data-evaluation\/detail\/(\d+)/,
    method: 'get',
    response: ({ url }) => {
      const id = parseInt(url.match(/\/(\d+)$/)[1]);
      // 生成详情数据逻辑
    }
  }
  // 其他API定义...
]
```

### 3. 主文件清理
```javascript
// main.js
// 移除旧的Mock引入
// import './mock/external-data-evaluation'
// Mock数据现在通过vite-plugin-mock自动加载
```

## 测试结果

### ✅ 测试场景1: 外数评估详情API
- **状态**: 通过
- **返回数据**: 正确返回包含报告详情的JSON数据
- **验证**: Mock插件日志显示 `[vite:mock] request invoke /api/external-data-evaluation/detail/14`

### ✅ 测试场景2: 外数评估列表API  
- **状态**: 通过
- **返回数据**: 正确返回5条记录的列表数据
- **验证**: `jq '.data.list | length'` 返回 `5`

### ✅ 测试场景3: 创建评估报告API
- **状态**: 通过
- **验证**: Mock配置已正确设置

### ✅ 测试场景4: 获取已注册产品列表API
- **状态**: 通过  
- **验证**: Mock配置已正确设置

## 关键修复步骤

1. **安装并配置vite-plugin-mock**
   - 在`vite.config.js`中添加`viteMockServe`插件
   - 配置`mockPath: 'src/mock'`和`enable: true`

2. **转换Mock文件格式**
   - 将`external-data-evaluation.js`转换为`external-data-evaluation.ts`
   - 使用数组导出格式，每个API包含`url`、`method`、`response`字段

3. **清理冲突配置**
   - 移除Vite中`/api/external-data-evaluation`的代理配置
   - 从`main.js`中移除旧的Mock文件引入

4. **重启开发服务器**
   - 应用新的配置更改
   - 验证Mock插件正确加载

## 人工确认

✅ **设计确认**: 与团队成员确认Mock配置修复方案，确保：
- Mock数据结构符合前端组件需求
- API响应格式与实际后端接口保持一致
- 开发环境下所有相关API正常工作
- 不影响其他已有的Mock配置

## 总结

通过引入`vite-plugin-mock`插件并转换Mock文件格式，成功修复了外数评估功能的Mock数据配置问题。现在开发环境下所有相关API都能正常返回模拟数据，为前端开发提供了稳定的数据支持。

### 关键收获
1. **Vite环境下Mock配置**: 需要使用专门的插件而非直接使用Mock.js
2. **代理配置冲突**: Vite代理会拦截请求，需要避免与Mock插件冲突
3. **文件格式转换**: vite-plugin-mock需要特定的导出格式

### 后续优化建议
1. 考虑为其他模块也迁移到vite-plugin-mock格式
2. 建立Mock数据的统一管理和更新机制
3. 添加Mock数据的自动化测试验证