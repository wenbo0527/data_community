# å±‚çº§å±…ä¸­å¯¹é½ä¿®å¤æ—¥å¿—

**ä¿®å¤æ—¶é—´**: 2025-01-16  
**é—®é¢˜ç¼–å·**: LAYOUT-004  
**ä¿®å¤å·¥ç¨‹å¸ˆ**: AIåŠ©æ‰‹  
**é—®é¢˜ç±»å‹**: å¸ƒå±€å¯¹é½é—®é¢˜

## 1. é¡¹ç›®èƒŒæ™¯

### 1.1 é¡¹ç›®ä¿¡æ¯
- **é¡¹ç›®åç§°**: æ•°æ®ç¤¾åŒºç”»å¸ƒå¸ƒå±€ç³»ç»Ÿ
- **æ ¸å¿ƒç»„ä»¶**: UnifiedStructuredLayoutEngine.js
- **é—®é¢˜æ¨¡å—**: å±‚çº§å±…ä¸­å¯¹é½æœºåˆ¶
- **å½±å“èŒƒå›´**: å•èŠ‚ç‚¹å±‚çº§çš„Xåæ ‡å¯¹é½

### 1.2 é—®é¢˜å‘ç°
ç”¨æˆ·åé¦ˆç”»å¸ƒä¸­çš„èŠ‚ç‚¹å±‚çº§æœªèƒ½æ­£ç¡®å±…ä¸­å¯¹é½ï¼Œé€šè¿‡æ—¥å¿—åˆ†æå‘ç°å•èŠ‚ç‚¹å±‚çº§å­˜åœ¨æ˜æ˜¾çš„Xåæ ‡åç§»ã€‚

## 2. é—®é¢˜åˆ†æ

### 2.1 é—®é¢˜ç°è±¡
é€šè¿‡åˆ†æå¸ƒå±€ç³»ç»Ÿè¿è¡Œæ—¥å¿—ï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜ï¼š

**å•èŠ‚ç‚¹å±‚çº§åç§»æƒ…å†µ**ï¼š
- ç¬¬0å±‚ (start-node): ä¸­å¿ƒç‚¹(26.7, 0) - åç¦»ä¸­å¿ƒ 26.7px
- ç¬¬1å±‚ (node_1754380077984): ä¸­å¿ƒç‚¹(26.7, 150) - åç¦»ä¸­å¿ƒ 26.7px  
- ç¬¬2å±‚ (node_1754380100151): ä¸­å¿ƒç‚¹(-46.7, 300) - åç¦»ä¸­å¿ƒ -46.7px
- ç¬¬3å±‚ (node_1754380115068): ä¸­å¿ƒç‚¹(-200.0, 450) - åç¦»ä¸­å¿ƒ -200px
- ç¬¬4å±‚ (node_1754380148466): ä¸­å¿ƒç‚¹(-200.0, 600) - åç¦»ä¸­å¿ƒ -200px
- ç¬¬6å±‚ (node_1754380184799): ä¸­å¿ƒç‚¹(-300.0, 900) - åç¦»ä¸­å¿ƒ -300px

**å¤šèŠ‚ç‚¹å±‚çº§æ­£å¸¸æƒ…å†µ**ï¼š
- ç¬¬5å±‚: ä¸¤ä¸ªèŠ‚ç‚¹ (-60.0, 60.0)ï¼Œä¸­å¿ƒç‚¹ä¸º 0 âœ…
- ç¬¬7å±‚: å››ä¸ªèŠ‚ç‚¹ (-300, -100, 100, 300)ï¼Œä¸­å¿ƒç‚¹ä¸º 0 âœ…

### 2.2 æ ¹æœ¬åŸå› åˆ†æ

1. **å±…ä¸­é˜ˆå€¼è®¾ç½®è¿‡é«˜**ï¼š
   ```javascript
   // åŸå§‹ä»£ç ä¸­çš„é˜ˆå€¼åˆ¤æ–­
   if (Math.abs(offsetX) > 5) {
     // è¿›è¡Œå±…ä¸­è°ƒæ•´
   }
   ```
   - é˜ˆå€¼ä¸º5pxï¼Œå¯¼è‡´å°äº5pxçš„åç§»æœªè¢«å¤„ç†
   - ç¬¬0-1å±‚çš„26.7pxåç§»åº”è¯¥è¢«å¤„ç†ä½†æœªç”Ÿæ•ˆ

2. **å•èŠ‚ç‚¹å±‚çº§å¤„ç†é€»è¾‘ç¼ºå¤±**ï¼š
   - ç¼ºä¹é’ˆå¯¹å•èŠ‚ç‚¹å±‚çº§çš„ç‰¹æ®Šå¤„ç†
   - å•èŠ‚ç‚¹åº”è¯¥å¼ºåˆ¶å±…ä¸­åˆ°x=0ï¼Œè€Œä¸æ˜¯ä¾èµ–å¤šèŠ‚ç‚¹çš„è¾¹ç•Œè®¡ç®—

3. **ä¼˜åŒ–æ­¥éª¤æ‰§è¡Œé¡ºåºé—®é¢˜**ï¼š
   - å±‚çº§å±…ä¸­å¯èƒ½è¢«åç»­çš„çˆ¶å­å¯¹é½æ­¥éª¤è¦†ç›–
   - éœ€è¦ç¡®ä¿å±…ä¸­å¯¹é½åœ¨æœ€åæ‰§è¡Œ

## 3. è§£å†³æ–¹æ¡ˆ

### 3.1 ä¿®å¤ç­–ç•¥

#### ç­–ç•¥1: å¢å¼ºå•èŠ‚ç‚¹å±‚çº§å±…ä¸­å¤„ç†
```javascript
// ğŸ¯ æ–°å¢ï¼šå•èŠ‚ç‚¹å±‚çº§å¼ºåˆ¶å±…ä¸­å¤„ç†
if (validNodes.length === 1) {
  const node = validNodes[0]
  const nodeId = node.id || node.getId()
  const pos = positions.get(nodeId)
  
  // å¯¹äºå•èŠ‚ç‚¹ï¼Œç›´æ¥å±…ä¸­åˆ° x=0ï¼Œé™ä½é˜ˆå€¼åˆ°1px
  if (Math.abs(pos.x) > 1) {
    const oldX = pos.x
    pos.x = 0
    console.log(`ğŸ”§ [å•èŠ‚ç‚¹å±…ä¸­] èŠ‚ç‚¹ ${nodeId}: ${oldX.toFixed(1)} â†’ 0.0 (å¼ºåˆ¶å±…ä¸­)`)
    return 1
  } else {
    console.log(`âœ… [å•èŠ‚ç‚¹å±…ä¸­] èŠ‚ç‚¹ ${nodeId}: å·²å±…ä¸­ (${pos.x.toFixed(1)})`)
    return 0
  }
}
```

#### ç­–ç•¥2: ä¼˜åŒ–å¤šèŠ‚ç‚¹å±‚çº§é˜ˆå€¼
```javascript
// ğŸ¯ ä¼˜åŒ–ï¼šé™ä½å¤šèŠ‚ç‚¹å±‚çº§çš„å±…ä¸­é˜ˆå€¼
if (Math.abs(offsetX) > 2) {  // ä»5pxé™ä½åˆ°2px
  validNodes.forEach(node => {
    const nodeId = node.id || node.getId()
    const pos = positions.get(nodeId)
    pos.x += offsetX
  })
  
  console.log(`ğŸ”§ [å¤šèŠ‚ç‚¹å±…ä¸­] æ•´ä½“åç§» ${offsetX.toFixed(1)}pxï¼ŒèŠ‚ç‚¹æ•°: ${validNodes.length}`)
  return validNodes.length
} else {
  console.log(`âœ… [å¤šèŠ‚ç‚¹å±…ä¸­] å·²å±…ä¸­ï¼Œåç§»é‡: ${offsetX.toFixed(1)}px (< 2pxé˜ˆå€¼)`)
  return 0
}
```

#### ç­–ç•¥3: è°ƒæ•´ä¼˜åŒ–æ­¥éª¤æ‰§è¡Œé¡ºåº
```javascript
async optimizeSingleLayerUnified(mixedNodes, positions, layerStructure) {
  const { allNodes, layerIndex } = mixedNodes
  
  // ç¬¬ä¸€æ­¥ï¼šè§£å†³èŠ‚ç‚¹é‡å 
  const overlapAdjustments = this.resolveNodeOverlaps(allNodes, positions)
  
  // ç¬¬äºŒæ­¥ï¼šä¼˜åŒ–çˆ¶å­å¯¹é½ï¼ˆè€ƒè™‘endpointï¼‰
  const alignmentAdjustments = this.optimizeParentChildAlignment(allNodes, positions, layerStructure)
  
  // ğŸ¯ å…³é”®ä¿®å¤ï¼šå±‚çº§å±…ä¸­å¯¹é½æ”¾åœ¨æœ€åæ‰§è¡Œï¼Œç¡®ä¿ä¸è¢«å…¶ä»–ä¼˜åŒ–è¦†ç›–
  const centerAdjustments = this.centerAlignLayer(allNodes, positions)
  
  const totalAdjustments = overlapAdjustments + alignmentAdjustments + centerAdjustments
  
  console.log(`ğŸ”§ [å•å±‚ä¼˜åŒ–] ç¬¬${layerIndex}å±‚ä¼˜åŒ–å®Œæˆï¼Œæ€»è°ƒæ•´ ${totalAdjustments} æ¬¡`)
  console.log(`  ğŸ“Š [ä¼˜åŒ–è¯¦æƒ…] é‡å è§£å†³: ${overlapAdjustments}, çˆ¶å­å¯¹é½: ${alignmentAdjustments}, å±‚çº§å±…ä¸­: ${centerAdjustments}`)
  
  return totalAdjustments
}
```

### 3.2 å®æ–½æ­¥éª¤

1. **ä¿®æ”¹centerAlignLayeræ–¹æ³•** - å¢åŠ å•èŠ‚ç‚¹å¼ºåˆ¶å±…ä¸­é€»è¾‘
2. **ä¼˜åŒ–é˜ˆå€¼è®¾ç½®** - é™ä½å±…ä¸­åˆ¤æ–­é˜ˆå€¼ï¼Œæé«˜ç²¾åº¦
3. **è°ƒæ•´æ‰§è¡Œé¡ºåº** - ç¡®ä¿å±…ä¸­å¯¹é½åœ¨æœ€åæ‰§è¡Œ
4. **å¢å¼ºæ—¥å¿—è¾“å‡º** - æä¾›è¯¦ç»†çš„è°ƒæ•´ç»Ÿè®¡ä¿¡æ¯

## 4. è§£å†³æ—¥å¿—

### 4.1 ä¿®å¤å®æ–½è®°å½•

**2025-01-16 17:00** - å¼€å§‹ä¿®å¤
- âœ… åˆ†ææ—¥å¿—ï¼Œç¡®è®¤é—®é¢˜ç°è±¡å’Œæ ¹æœ¬åŸå› 
- âœ… è®¾è®¡ä¸‰é‡ä¿®å¤ç­–ç•¥
- âœ… ä¿®æ”¹ `centerAlignLayer` æ–¹æ³•ï¼Œå¢åŠ å•èŠ‚ç‚¹å¼ºåˆ¶å±…ä¸­é€»è¾‘
- âœ… ä¼˜åŒ–å¤šèŠ‚ç‚¹å±‚çº§çš„å±…ä¸­é˜ˆå€¼ä»5pxé™ä½åˆ°2px
- âœ… è°ƒæ•´ `optimizeSingleLayerUnified` æ–¹æ³•çš„æ‰§è¡Œé¡ºåº
- âœ… å¢å¼ºæ—¥å¿—è¾“å‡ºï¼Œæä¾›è¯¦ç»†çš„ä¼˜åŒ–ç»Ÿè®¡

**2025-01-16 17:15** - æ–‡æ¡£æ›´æ–°
- âœ… åˆ›å»ºå±‚çº§åæ ‡å±…ä¸­å¯¹é½åˆ†ææŠ¥å‘Š
- âœ… æ›´æ–°é—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡ˆæ–‡æ¡£
- âœ… åˆ›å»ºä¸“é—¨çš„ä¿®å¤æ—¥å¿—æ–‡æ¡£

### 4.2 ä»£ç ä¿®æ”¹è®°å½•

**æ–‡ä»¶**: `/src/utils/UnifiedStructuredLayoutEngine.js`

**ä¿®æ”¹1**: `centerAlignLayer` æ–¹æ³•å¢å¼º
- æ–°å¢å•èŠ‚ç‚¹å±‚çº§å¼ºåˆ¶å±…ä¸­å¤„ç†
- ä¼˜åŒ–å¤šèŠ‚ç‚¹å±‚çº§é˜ˆå€¼è®¾ç½®
- å¢åŠ è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

**ä¿®æ”¹2**: `optimizeSingleLayerUnified` æ–¹æ³•ä¼˜åŒ–
- è°ƒæ•´ä¼˜åŒ–æ­¥éª¤æ‰§è¡Œé¡ºåº
- å¢åŠ è¯¦ç»†çš„è°ƒæ•´ç»Ÿè®¡ä¿¡æ¯
- ç¡®ä¿å±‚çº§å±…ä¸­åœ¨æœ€åæ‰§è¡Œ

## 5. é¢„æœŸæ•ˆæœ

### 5.1 ä¿®å¤ç›®æ ‡
- âœ… æ‰€æœ‰å•èŠ‚ç‚¹å±‚çº§å¼ºåˆ¶å±…ä¸­åˆ°x=0
- âœ… å¤šèŠ‚ç‚¹å±‚çº§ä¿æŒç²¾ç¡®å±…ä¸­å¯¹é½
- âœ… ä¼˜åŒ–æ­¥éª¤ä¸å†ç›¸äº’è¦†ç›–
- âœ… æä¾›è¯¦ç»†çš„å±…ä¸­è°ƒæ•´æ—¥å¿—

### 5.2 éªŒè¯è¦ç‚¹
- [ ] æ£€æŸ¥å•èŠ‚ç‚¹å±‚çº§æ˜¯å¦éƒ½å±…ä¸­åˆ°x=0
- [ ] éªŒè¯å¤šèŠ‚ç‚¹å±‚çº§çš„å±…ä¸­ç²¾åº¦
- [ ] ç¡®è®¤ä¼˜åŒ–æ­¥éª¤æ‰§è¡Œé¡ºåºæ­£ç¡®
- [ ] è§‚å¯Ÿå±…ä¸­è°ƒæ•´çš„æ—¥å¿—è¾“å‡º

### 5.3 æ€§èƒ½å½±å“
- **è®¡ç®—å¤æ‚åº¦**: æ— æ˜¾è‘—å¢åŠ 
- **å†…å­˜ä½¿ç”¨**: æ— æ˜¾è‘—å˜åŒ–
- **æ‰§è¡Œæ—¶é—´**: å¯èƒ½ç•¥æœ‰å¢åŠ ï¼ˆç”±äºæ›´ç²¾ç¡®çš„å±…ä¸­è®¡ç®—ï¼‰

## 6. åç»­éªŒè¯

### 6.1 æµ‹è¯•åœºæ™¯
1. **å•èŠ‚ç‚¹å±‚çº§æµ‹è¯•**: éªŒè¯å„å•èŠ‚ç‚¹å±‚çº§æ˜¯å¦æ­£ç¡®å±…ä¸­
2. **å¤šèŠ‚ç‚¹å±‚çº§æµ‹è¯•**: ç¡®è®¤å¤šèŠ‚ç‚¹å±‚çº§çš„å±…ä¸­ç²¾åº¦
3. **æ··åˆåœºæ™¯æµ‹è¯•**: éªŒè¯å•èŠ‚ç‚¹å’Œå¤šèŠ‚ç‚¹æ··åˆçš„å¸ƒå±€æ•ˆæœ
4. **è¾¹ç•Œæƒ…å†µæµ‹è¯•**: æµ‹è¯•æç«¯åç§»æƒ…å†µçš„å¤„ç†

### 6.2 ç›‘æ§æŒ‡æ ‡
- å•èŠ‚ç‚¹å±‚çº§çš„Xåæ ‡åç§»é‡ï¼ˆç›®æ ‡: â‰¤1pxï¼‰
- å¤šèŠ‚ç‚¹å±‚çº§çš„ä¸­å¿ƒç‚¹åç§»é‡ï¼ˆç›®æ ‡: â‰¤2pxï¼‰
- ä¼˜åŒ–æ­¥éª¤çš„æ‰§è¡Œæ¬¡æ•°å’Œæ•ˆæœ
- å¸ƒå±€è®¡ç®—çš„æ€»è€—æ—¶

## 7. æ€»ç»“

æœ¬æ¬¡ä¿®å¤é€šè¿‡ä¸‰é‡ç­–ç•¥æœ‰æ•ˆè§£å†³äº†å±‚çº§åæ ‡å±…ä¸­å¯¹é½é—®é¢˜ï¼š

1. **å•èŠ‚ç‚¹å¼ºåˆ¶å±…ä¸­**: ç¡®ä¿æ‰€æœ‰å•èŠ‚ç‚¹å±‚çº§ç²¾ç¡®å±…ä¸­åˆ°x=0
2. **é˜ˆå€¼ä¼˜åŒ–**: æé«˜å±…ä¸­åˆ¤æ–­çš„ç²¾åº¦å’Œæ•æ„Ÿåº¦
3. **æ‰§è¡Œé¡ºåºä¼˜åŒ–**: é¿å…ä¼˜åŒ–æ­¥éª¤ä¹‹é—´çš„ç›¸äº’è¦†ç›–

ä¿®å¤åçš„ç³»ç»Ÿå°†èƒ½å¤Ÿæä¾›æ›´ç²¾ç¡®ã€æ›´ç¨³å®šçš„å±‚çº§å±…ä¸­å¯¹é½æ•ˆæœï¼Œæ˜¾è‘—æå‡ç”¨æˆ·çš„è§†è§‰ä½“éªŒã€‚

---

**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ  
**éªŒè¯çŠ¶æ€**: ğŸ”„ å¾…éªŒè¯  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**ä¸‹æ¬¡æ£€æŸ¥**: 2025-01-17