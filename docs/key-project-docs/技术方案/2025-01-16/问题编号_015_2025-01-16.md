# Xè½´åˆ†å¸ƒæ·±åº¦ä¼˜åŒ–æ–¹æ¡ˆ

**åˆ¶å®šæ—¶é—´**: 2025-01-16  
**ä¼˜åŒ–ç›®æ ‡**: åœ¨ä¿æŒæŠ€æœ¯ç¨³å®šæ€§åŸºç¡€ä¸Šï¼Œæ˜¾è‘—æå‡Xè½´åˆ†å¸ƒè§†è§‰æ•ˆæœ  
**ä¼˜å…ˆçº§**: é«˜ä¼˜å…ˆçº§ï¼ˆç”¨æˆ·ä½“éªŒå…³é”®æ”¹è¿›ï¼‰

## ğŸ“Š ç°çŠ¶åˆ†æ

### âœ… æŠ€æœ¯åŸºç¡€ç¨³å®š
- æ—¶åºé—®é¢˜å·²å½»åº•è§£å†³
- å¸ƒå±€å¼•æ“è¿è¡Œç¨³å®š
- é¢„è§ˆçº¿åŒæ­¥æ­£å¸¸

### âš ï¸ è§†è§‰æ•ˆæœå¾…ä¼˜åŒ–
- **æ•´ä½“åˆ†å¸ƒä¸å‡**: å·¦å€¾ä¸¥é‡ï¼Œç¼ºä¹å¹³è¡¡æ„Ÿ
- **å¯¹ç§°åˆ†å¸ƒæœºæ¢°åŒ–**: å›ºå®šæ•°å€¼ï¼Œç¼ºä¹è§†è§‰ç¾æ„Ÿ
- **é¢„è§ˆçº¿ç»ˆç‚¹é›†ä¸­**: å¤šæ¡çº¿é‡å ï¼Œå±‚æ¬¡ä¸æ¸…

## ğŸ¯ æ ¸å¿ƒé—®é¢˜å®šä½

### é—®é¢˜1: å¯¹ç§°åˆ†å¸ƒç®—æ³•è¿‡äºå›ºåŒ–

**å½“å‰å®ç°** (`UnifiedStructuredLayoutEngine.js:1964-2020`):
```javascript
// å›ºåŒ–çš„å¯¹ç§°åˆ†å¸ƒ
if (nodeCount === 2) {
  const targetPositions = [-60, 60];  // å›ºå®šå€¼
} else if (nodeCount === 3) {
  const targetPositions = [-80, 0, 80];  // å›ºå®šå€¼
} else if (nodeCount === 4) {
  const targetPositions = [-90, -30, 30, 90];  // å›ºå®šå€¼
}
```

**é—®é¢˜åˆ†æ**:
- æ•°å€¼å®Œå…¨å›ºåŒ–ï¼Œç¼ºä¹åŠ¨æ€è°ƒæ•´
- æœªè€ƒè™‘èŠ‚ç‚¹å†…å®¹å’Œé‡è¦æ€§
- è§†è§‰æ•ˆæœå•è°ƒï¼Œç¼ºä¹å±‚æ¬¡æ„Ÿ

### é—®é¢˜2: å…¨å±€å¹³è¡¡ç®—æ³•ç¼ºå¤±

**å½“å‰å®ç°** (`UnifiedStructuredLayoutEngine.js:2145-2276`):
```javascript
// åªæœ‰å±€éƒ¨å¯¹ç§°ä¿æŠ¤ï¼Œç¼ºä¹å…¨å±€å¹³è¡¡
const protectedLayers = new Set();
// ä»…ä¿æŠ¤å¯¹ç§°åˆ†å¸ƒï¼Œæœªè€ƒè™‘æ•´ä½“å¹³è¡¡
```

**é—®é¢˜åˆ†æ**:
- åªè€ƒè™‘å±‚çº§å†…å¯¹ç§°ï¼Œå¿½ç•¥è·¨å±‚çº§å¹³è¡¡
- æ²¡æœ‰å…¨å±€Xè½´åˆ†å¸ƒå¯†åº¦åˆ†æ
- å®¹æ˜“äº§ç”Ÿå·¦å€¾æˆ–å³å€¾çš„æ•´ä½“å¸ƒå±€

### é—®é¢˜3: é¢„è§ˆçº¿ç»ˆç‚¹åˆ†å¸ƒå•ä¸€

**å½“å‰å®ç°** (`UnifiedStructuredLayoutEngine.js:483`):
```javascript
// ç®€å•çš„å›ºå®šåç§»
const endPosition = {
  x: nodePosition.x + 50,  // å›ºå®šåç§»50px
  y: nodePosition.y + nodeSize.height / 2,
};
```

**é—®é¢˜åˆ†æ**:
- æ‰€æœ‰é¢„è§ˆçº¿ç»ˆç‚¹ä½¿ç”¨ç›¸åŒåç§»
- å¤šæ¡é¢„è§ˆçº¿å®¹æ˜“é‡å 
- ç¼ºä¹è§†è§‰å±‚æ¬¡å’Œåˆ†æ•£æ•ˆæœ

## ğŸ”§ ä¼˜åŒ–æ–¹æ¡ˆè¯¦ç»†è®¾è®¡

### æ–¹æ¡ˆ1: å¢å¼ºå¯¹ç§°åˆ†å¸ƒç®—æ³• (é«˜ä¼˜å…ˆçº§)

#### 1.1 åŠ¨æ€é—´è·ç®—æ³•

**ç›®æ ‡**: ä¿æŒå¯¹ç§°æ€§ï¼Œå¢åŠ è§†è§‰å¸å¼•åŠ›

**å®ç°ç­–ç•¥**:
```javascript
// æ–°å¢åŠ¨æ€å¯¹ç§°åˆ†å¸ƒæ–¹æ³•
optimizeEnhancedSymmetricDistribution(validNodes, positions) {
  const nodeCount = validNodes.length;
  
  // åŸºç¡€é—´è·è®¡ç®— - è€ƒè™‘èŠ‚ç‚¹é‡è¦æ€§å’Œå†…å®¹
  const baseSpacing = this.calculateDynamicSpacing(validNodes);
  
  switch(nodeCount) {
    case 2:
      // åŠ¨æ€2èŠ‚ç‚¹åˆ†å¸ƒ: åŸºç¡€120pxï¼Œå¯è°ƒæ•´åˆ°100-160px
      const spacing2 = Math.max(100, Math.min(160, baseSpacing));
      return [-spacing2/2, spacing2/2];
      
    case 3:
      // åŠ¨æ€3èŠ‚ç‚¹åˆ†å¸ƒ: ä¸­å¿ƒ0ï¼Œå¤–ä¾§70-100px
      const outerSpacing = Math.max(70, Math.min(100, baseSpacing * 0.8));
      return [-outerSpacing, 0, outerSpacing];
      
    case 4:
      // é»„é‡‘æ¯”ä¾‹4èŠ‚ç‚¹åˆ†å¸ƒ
      const golden = baseSpacing * 0.618; // é»„é‡‘æ¯”ä¾‹
      const outer = baseSpacing;
      return [-outer, -golden, golden, outer];
      
    default:
      // 5+èŠ‚ç‚¹æ™ºèƒ½åˆ†å¸ƒ
      return this.calculateIntelligentDistribution(nodeCount, baseSpacing);
  }
}

// è®¡ç®—åŠ¨æ€é—´è·
calculateDynamicSpacing(nodes) {
  // è€ƒè™‘å› ç´ :
  // 1. èŠ‚ç‚¹ç±»å‹é‡è¦æ€§
  // 2. èŠ‚ç‚¹å†…å®¹å¤æ‚åº¦  
  // 3. å±‚çº§ä½ç½®æƒé‡
  // 4. å…¨å±€å¸ƒå±€å¯†åº¦
  
  let baseSpacing = 120; // åŸºç¡€é—´è·
  
  // èŠ‚ç‚¹é‡è¦æ€§è°ƒæ•´
  const importanceWeight = this.calculateNodeImportance(nodes);
  baseSpacing *= (1 + importanceWeight * 0.3);
  
  // å…¨å±€å¯†åº¦è°ƒæ•´
  const densityFactor = this.calculateGlobalDensity();
  baseSpacing *= (1 + densityFactor * 0.2);
  
  return Math.max(80, Math.min(200, baseSpacing));
}
```

#### 1.2 è§†è§‰ç¾æ„Ÿä¼˜åŒ–

**é»„é‡‘æ¯”ä¾‹åº”ç”¨**:
```javascript
// 4èŠ‚ç‚¹é»„é‡‘æ¯”ä¾‹åˆ†å¸ƒ
calculateGoldenRatioDistribution(baseSpacing) {
  const phi = 1.618; // é»„é‡‘æ¯”ä¾‹
  const inner = baseSpacing / phi;
  const outer = baseSpacing;
  
  return [-outer, -inner, inner, outer];
}

// å¤šèŠ‚ç‚¹æ–æ³¢é‚£å¥‘åˆ†å¸ƒ
calculateFibonacciDistribution(nodeCount, baseSpacing) {
  const fibonacci = [1, 1, 2, 3, 5, 8, 13, 21];
  const positions = [];
  
  for (let i = 0; i < nodeCount; i++) {
    const ratio = fibonacci[i % fibonacci.length] / fibonacci[3];
    const position = (i - (nodeCount - 1) / 2) * baseSpacing * ratio;
    positions.push(position);
  }
  
  return positions;
}
```

### æ–¹æ¡ˆ2: å…¨å±€Xè½´å¹³è¡¡ç®—æ³• (ä¸­ä¼˜å…ˆçº§)

#### 2.1 åˆ†å¸ƒå¯†åº¦åˆ†æ

**ç›®æ ‡**: ç¡®ä¿æ•´ä½“Xè½´åˆ†å¸ƒå‡åŒ€

**å®ç°ç­–ç•¥**:
```javascript
// æ–°å¢å…¨å±€å¹³è¡¡åˆ†ææ–¹æ³•
analyzeGlobalXDistribution(positions) {
  const allXCoords = Array.from(positions.values()).map(pos => pos.x);
  
  // 1. è®¡ç®—åˆ†å¸ƒå¯†åº¦
  const density = this.calculateDistributionDensity(allXCoords);
  
  // 2. è¯†åˆ«ç¨€ç–å’Œå¯†é›†åŒºåŸŸ
  const sparseRegions = this.identifySparseRegions(density);
  const denseRegions = this.identifyDenseRegions(density);
  
  // 3. è®¡ç®—å¹³è¡¡åº¦è¯„åˆ†
  const balanceScore = this.calculateBalanceScore(density);
  
  return {
    density,
    sparseRegions,
    denseRegions,
    balanceScore,
    needsRebalancing: balanceScore < 0.7
  };
}

// è®¡ç®—åˆ†å¸ƒå¯†åº¦
calculateDistributionDensity(xCoords) {
  const minX = Math.min(...xCoords);
  const maxX = Math.max(...xCoords);
  const range = maxX - minX;
  const bucketSize = range / 10; // åˆ†æˆ10ä¸ªåŒºé—´
  
  const buckets = new Array(10).fill(0);
  
  xCoords.forEach(x => {
    const bucketIndex = Math.floor((x - minX) / bucketSize);
    const index = Math.max(0, Math.min(9, bucketIndex));
    buckets[index]++;
  });
  
  return buckets;
}

// å…¨å±€é‡å¹³è¡¡
rebalanceGlobalDistribution(positions, analysis) {
  if (!analysis.needsRebalancing) return;
  
  // 1. è¯†åˆ«å¯è°ƒæ•´çš„å±‚çº§
  const adjustableLayers = this.identifyAdjustableLayers(positions);
  
  // 2. è®¡ç®—æœ€ä¼˜è°ƒæ•´æ–¹æ¡ˆ
  const adjustments = this.calculateOptimalAdjustments(
    adjustableLayers, 
    analysis.sparseRegions, 
    analysis.denseRegions
  );
  
  // 3. åº”ç”¨è°ƒæ•´
  this.applyGlobalAdjustments(positions, adjustments);
}
```

#### 2.2 æ™ºèƒ½é‡å¹³è¡¡ç­–ç•¥

**é‡è¦æ€§æƒé‡**:
```javascript
// èŠ‚ç‚¹é‡è¦æ€§è¯„ä¼°
calculateNodeImportance(node) {
  let importance = 1.0;
  
  // èŠ‚ç‚¹ç±»å‹æƒé‡
  const typeWeights = {
    'start': 1.5,
    'end': 1.3,
    'decision': 1.4,
    'action': 1.0,
    'endpoint': 0.8
  };
  
  const nodeType = node.getData()?.type || 'action';
  importance *= typeWeights[nodeType] || 1.0;
  
  // è¿æ¥æ•°æƒé‡
  const connectionCount = this.getNodeConnectionCount(node);
  importance *= (1 + connectionCount * 0.1);
  
  // å±‚çº§ä½ç½®æƒé‡
  const layerIndex = this.getNodeLayerIndex(node);
  if (layerIndex === 0 || layerIndex === this.maxLayerIndex) {
    importance *= 1.2; // é¦–å°¾å±‚çº§æ›´é‡è¦
  }
  
  return Math.max(0.5, Math.min(2.0, importance));
}

// åŠ¨æ€è°ƒæ•´ç­–ç•¥
calculateDynamicAdjustment(layer, globalContext) {
  const layerImportance = this.calculateLayerImportance(layer);
  const globalBalance = globalContext.balanceScore;
  const localDensity = globalContext.getLocalDensity(layer.centerX);
  
  // ç»¼åˆè°ƒæ•´å› å­
  let adjustmentFactor = 1.0;
  
  // é‡è¦å±‚çº§è·å¾—æ›´å¥½ä½ç½®
  adjustmentFactor *= layerImportance;
  
  // ç¨€ç–åŒºåŸŸæ‰©å±•é—´è·
  if (localDensity < 0.5) {
    adjustmentFactor *= 1.3;
  }
  
  // å¯†é›†åŒºåŸŸå‹ç¼©é—´è·
  if (localDensity > 1.5) {
    adjustmentFactor *= 0.8;
  }
  
  return adjustmentFactor;
}
```

### æ–¹æ¡ˆ3: é¢„è§ˆçº¿ç»ˆç‚¹æ™ºèƒ½åˆ†å¸ƒ (ä¸­ä¼˜å…ˆçº§)

#### 3.1 åˆ†æ•£ç®—æ³•è®¾è®¡

**ç›®æ ‡**: é¿å…é¢„è§ˆçº¿é‡å ï¼Œæå‡è§†è§‰å±‚æ¬¡

**å®ç°ç­–ç•¥**:
```javascript
// ä¼˜åŒ–è™šæ‹Ÿç«¯ç‚¹ä½ç½®è®¡ç®—
calculateOptimalEndpointPosition(sourceNode, branchId, existingEndpoints) {
  const nodePosition = sourceNode.getPosition();
  const nodeSize = sourceNode.getSize();
  
  // 1. åŸºç¡€ä½ç½®è®¡ç®—
  let baseX = nodePosition.x + nodeSize.width / 2;
  let baseY = nodePosition.y + nodeSize.height / 2;
  
  // 2. åˆ†æåŒå±‚çº§é¢„è§ˆçº¿åˆ†å¸ƒ
  const sameLayerEndpoints = this.getSameLayerEndpoints(existingEndpoints, baseY);
  
  // 3. è®¡ç®—æœ€ä¼˜Xåç§»
  const optimalOffsetX = this.calculateOptimalXOffset(
    baseX, 
    sameLayerEndpoints,
    branchId
  );
  
  // 4. åº”ç”¨æ™ºèƒ½åˆ†æ•£ç®—æ³•
  const finalX = this.applyDispersionAlgorithm(
    baseX + optimalOffsetX,
    sameLayerEndpoints
  );
  
  return {
    x: finalX,
    y: baseY
  };
}

// æ™ºèƒ½Xåç§»è®¡ç®—
calculateOptimalXOffset(baseX, existingEndpoints, branchId) {
  // åŸºç¡€åç§»èŒƒå›´: 40-80px
  const minOffset = 40;
  const maxOffset = 80;
  
  // æ ¹æ®åˆ†æ”¯ç±»å‹è°ƒæ•´
  const branchTypeOffsets = {
    'yes': 60,
    'no': 70,
    'default': 50,
    'virtual': 45
  };
  
  let baseOffset = branchTypeOffsets[branchId] || branchTypeOffsets['default'];
  
  // æ ¹æ®ç°æœ‰ç«¯ç‚¹åˆ†å¸ƒè°ƒæ•´
  if (existingEndpoints.length > 0) {
    const avgX = existingEndpoints.reduce((sum, ep) => sum + ep.x, 0) / existingEndpoints.length;
    const distanceFromAvg = Math.abs(baseX - avgX);
    
    // è·ç¦»å¹³å‡ä½ç½®è¾ƒè¿œæ—¶ï¼Œå‡å°‘åç§»
    if (distanceFromAvg > 100) {
      baseOffset *= 0.8;
    }
  }
  
  return Math.max(minOffset, Math.min(maxOffset, baseOffset));
}

// åˆ†æ•£ç®—æ³•
applyDispersionAlgorithm(targetX, existingEndpoints) {
  const minDistance = 30; // æœ€å°é—´è·
  
  // æ£€æŸ¥ä¸ç°æœ‰ç«¯ç‚¹çš„è·ç¦»
  for (const endpoint of existingEndpoints) {
    const distance = Math.abs(targetX - endpoint.x);
    
    if (distance < minDistance) {
      // éœ€è¦è°ƒæ•´ä½ç½®
      const direction = targetX > endpoint.x ? 1 : -1;
      targetX = endpoint.x + direction * minDistance;
    }
  }
  
  return targetX;
}
```

#### 3.2 å±‚æ¬¡åŒ–åˆ†å¸ƒ

**å¤šå±‚çº§åè°ƒ**:
```javascript
// è·¨å±‚çº§é¢„è§ˆçº¿åè°ƒ
coordinateMultiLayerEndpoints(allEndpoints) {
  // æŒ‰Yåæ ‡åˆ†ç»„
  const layerGroups = this.groupEndpointsByLayer(allEndpoints);
  
  // å±‚çº§é—´åè°ƒ
  layerGroups.forEach((endpoints, layerY) => {
    // 1. å±‚çº§å†…åˆ†æ•£
    this.disperseWithinLayer(endpoints);
    
    // 2. ä¸ç›¸é‚»å±‚çº§åè°ƒ
    this.coordinateWithAdjacentLayers(endpoints, layerY, layerGroups);
  });
}

// å±‚çº§å†…åˆ†æ•£
disperseWithinLayer(endpoints) {
  if (endpoints.length <= 1) return;
  
  // æ’åº
  endpoints.sort((a, b) => a.x - b.x);
  
  // è®¡ç®—ç†æƒ³é—´è·
  const totalWidth = endpoints[endpoints.length - 1].x - endpoints[0].x;
  const idealSpacing = Math.max(30, totalWidth / (endpoints.length - 1));
  
  // è°ƒæ•´ä½ç½®
  for (let i = 1; i < endpoints.length - 1; i++) {
    const expectedX = endpoints[0].x + i * idealSpacing;
    const currentX = endpoints[i].x;
    
    if (Math.abs(currentX - expectedX) > 10) {
      endpoints[i].x = expectedX;
    }
  }
}
```

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### è§†è§‰æ”¹è¿›æŒ‡æ ‡

1. **åˆ†å¸ƒå‡åŒ€æ€§**: ä»å½“å‰60%æå‡åˆ°85%
2. **è§†è§‰å¹³è¡¡åº¦**: ä»å½“å‰55%æå‡åˆ°80%
3. **å±‚æ¬¡æ¸…æ™°åº¦**: ä»å½“å‰70%æå‡åˆ°90%
4. **æ•´ä½“åè°ƒæ€§**: ä»å½“å‰65%æå‡åˆ°85%

### ç”¨æˆ·ä½“éªŒæå‡

1. **è§†è§‰å¸å¼•åŠ›**: æ›´åŠ ç¾è§‚çš„å¯¹ç§°åˆ†å¸ƒ
2. **ä¿¡æ¯å±‚æ¬¡**: æ¸…æ™°çš„é¢„è§ˆçº¿åˆ†å¸ƒ
3. **æ•´ä½“å¹³è¡¡**: æ¶ˆé™¤å·¦å€¾å³å€¾é—®é¢˜
4. **ä¸“ä¸šæ„Ÿ**: ç¬¦åˆè®¾è®¡ç¾å­¦çš„å¸ƒå±€

## ğŸš€ å®æ–½è®¡åˆ’

### é˜¶æ®µ1: å¢å¼ºå¯¹ç§°åˆ†å¸ƒç®—æ³• (1-2å¤©)
- å®ç°åŠ¨æ€é—´è·è®¡ç®—
- åº”ç”¨é»„é‡‘æ¯”ä¾‹åˆ†å¸ƒ
- æµ‹è¯•å¤šèŠ‚ç‚¹åœºæ™¯

### é˜¶æ®µ2: å…¨å±€å¹³è¡¡ç®—æ³• (2-3å¤©)
- å®ç°åˆ†å¸ƒå¯†åº¦åˆ†æ
- å¼€å‘é‡å¹³è¡¡ç­–ç•¥
- é›†æˆåˆ°ç°æœ‰æµç¨‹

### é˜¶æ®µ3: é¢„è§ˆçº¿ä¼˜åŒ– (1-2å¤©)
- å®ç°æ™ºèƒ½åˆ†æ•£ç®—æ³•
- ä¼˜åŒ–å±‚çº§åè°ƒ
- å®Œå–„è§†è§‰æ•ˆæœ

### é˜¶æ®µ4: æ•´ä½“æµ‹è¯•ä¼˜åŒ– (1å¤©)
- ç»¼åˆæµ‹è¯•æ‰€æœ‰æ”¹è¿›
- æ€§èƒ½ä¼˜åŒ–
- æ–‡æ¡£æ›´æ–°

## ğŸ“‹ é£é™©è¯„ä¼°

### æŠ€æœ¯é£é™©: ä½
- åŸºäºç°æœ‰ç¨³å®šæ¶æ„
- æ¸è¿›å¼æ”¹è¿›ç­–ç•¥
- å®Œå–„çš„å›æ»šæœºåˆ¶

### å…¼å®¹æ€§é£é™©: ä½
- ä¿æŒç°æœ‰APIæ¥å£
- å‘åå…¼å®¹è®¾è®¡
- æ¸è¿›å¼éƒ¨ç½²

### æ€§èƒ½é£é™©: ä½
- ç®—æ³•å¤æ‚åº¦å¯æ§
- ç¼“å­˜ä¼˜åŒ–ç­–ç•¥
- å¼‚æ­¥å¤„ç†æœºåˆ¶

---

**æ€»ç»“**: æœ¬ä¼˜åŒ–æ–¹æ¡ˆåœ¨ä¿æŒæŠ€æœ¯ç¨³å®šæ€§çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡ç®—æ³•å¢å¼ºã€å…¨å±€å¹³è¡¡å’Œæ™ºèƒ½åˆ†å¸ƒä¸‰ä¸ªç»´åº¦ï¼Œæ˜¾è‘—æå‡Xè½´åˆ†å¸ƒçš„è§†è§‰æ•ˆæœå’Œç”¨æˆ·ä½“éªŒã€‚é¢„æœŸå®æ–½åï¼Œç”¨æˆ·åé¦ˆçš„è§†è§‰é—®é¢˜å°†å¾—åˆ°æ ¹æœ¬æ€§æ”¹å–„ã€‚