# 节点层级信息缺失问题修复日志

## 项目背景
数字社区营销画布平台在运行过程中出现布局引擎无法找到特定节点层级信息的错误，导致预览线计算失败并产生控制台警告。

## 问题分析

### 错误现象
```
⚠️ [布局引擎] 未找到节点 node_1754380077984 的层级信息
⚠️ [布局引擎] 未找到节点 node_1754380100151 的层级信息  
⚠️ [布局引擎] 未找到节点 node_1754380148466 的层级信息
```

### 错误调用链
```
calculateBranchPreviewPosition @ UnifiedPreviewLineManager.js:3504
getNextLayerY @ UnifiedStructuredLayoutEngine.js:529
getNodeLayerY @ UnifiedStructuredLayoutEngine.js:514
```

### 根本原因分析
1. **时序问题**: 预览线管理器在布局引擎完成层级计算之前就尝试获取节点层级信息
2. **映射缺失**: `layoutModel.nodeToLayer` 映射表中缺少某些节点的层级信息
3. **容错不足**: 原有代码缺乏智能推断和容错机制

## 解决方案

### 修复策略
1. **增强容错机制**: 在获取层级信息失败时提供智能推断
2. **多重推断策略**: 基于节点位置、父子关系、节点类型等多种方式推断
3. **默认值保障**: 为不同类型节点提供合理的默认Y坐标

### 具体实现

#### 1. 增强 getNodeLayerY 方法
```javascript
getNodeLayerY(nodeId) {
  // 🎯 修复1：增强布局模型检查
  if (!this.layoutModel || !this.layoutModel.nodeToLayer) {
    console.warn(`⚠️ [布局引擎] 布局模型未初始化，节点 ${nodeId} 使用默认Y坐标`)
    return this.getDefaultLayerY(nodeId)
  }
  
  // 🎯 修复2：首先检查节点层级映射
  const layerIndex = this.layoutModel.nodeToLayer.get(nodeId)
  if (layerIndex === undefined) {
    console.warn(`⚠️ [布局引擎] 未找到节点 ${nodeId} 的层级信息，尝试智能推断`)
    return this.inferNodeLayerY(nodeId)
  }
  
  const layerY = layerIndex * this.options.layer.baseHeight
  console.log(`📍 [布局引擎] 节点 ${nodeId} 层级Y坐标: 第${layerIndex}层 -> Y=${layerY}`)
  return layerY
}
```

#### 2. 新增智能推断方法
```javascript
inferNodeLayerY(nodeId) {
  try {
    // 🎯 策略1：通过图形节点位置推断
    const node = this.graph.getCellById(nodeId)
    if (node) {
      const position = node.getPosition()
      const estimatedLayer = Math.floor(position.y / this.options.layer.baseHeight)
      const estimatedY = estimatedLayer * this.options.layer.baseHeight
      
      // 临时添加到层级映射中，避免重复推断
      if (this.layoutModel && this.layoutModel.nodeToLayer) {
        this.layoutModel.nodeToLayer.set(nodeId, estimatedLayer)
      }
      
      return estimatedY
    }
    
    // 🎯 策略2：通过父子关系推断
    if (this.layoutModel && this.layoutModel.childParentMap) {
      const parents = this.layoutModel.childParentMap.get(nodeId) || []
      if (parents.length > 0) {
        const parentId = parents[0]
        const parentLayer = this.layoutModel.nodeToLayer.get(parentId)
        if (parentLayer !== undefined) {
          const childLayer = parentLayer + 1
          const childY = childLayer * this.options.layer.baseHeight
          
          // 临时添加到层级映射中
          this.layoutModel.nodeToLayer.set(nodeId, childLayer)
          return childY
        }
      }
    }
    
    // 🎯 策略3：使用默认Y坐标
    return this.getDefaultLayerY(nodeId)
    
  } catch (error) {
    console.warn(`⚠️ [智能推断] 节点 ${nodeId} 推断失败:`, error.message)
    return this.getDefaultLayerY(nodeId)
  }
}
```

#### 3. 新增默认坐标方法
```javascript
getDefaultLayerY(nodeId) {
  // 🎯 根据节点类型返回不同的默认Y坐标
  if (nodeId.includes('start')) {
    return 0 // 起始节点在第0层
  } else if (nodeId.includes('virtual_endpoint') || nodeId.includes('endpoint')) {
    return this.options.layer.baseHeight * 3 // endpoint节点默认在第3层
  } else {
    return this.options.layer.baseHeight // 普通节点默认在第1层
  }
}
```

#### 4. 增强 getNextLayerY 方法
```javascript
getNextLayerY(nodeId) {
  try {
    const currentLayerY = this.getNodeLayerY(nodeId)
    const nextLayerY = currentLayerY + this.options.layer.baseHeight
    console.log(`📍 [布局引擎] 节点 ${nodeId} 下一层Y坐标: ${currentLayerY} + ${this.options.layer.baseHeight} = ${nextLayerY}`)
    return nextLayerY
  } catch (error) {
    console.warn(`⚠️ [布局引擎] 获取节点 ${nodeId} 下一层Y坐标失败:`, error.message)
    // 使用默认的下一层Y坐标
    return this.options.layer.baseHeight * 2
  }
}
```

## 解决日志

### 修复时间
2025年01月16日 15:45

### 修改文件
- `/Users/mac/nis_mock/data_comunity/data_comunity/src/utils/UnifiedStructuredLayoutEngine.js`

### 修改内容
1. **新增方法**:
   - `inferNodeLayerY()`: 智能推断节点层级Y坐标
   - `getDefaultLayerY()`: 获取默认层级Y坐标

2. **修改方法**:
   - `getNodeLayerY()`: 增加容错机制和智能推断
   - `getNextLayerY()`: 增加异常捕获和容错处理

### 预期效果
1. **消除警告**: 不再出现"未找到节点层级信息"的控制台警告
2. **提高稳定性**: 布局引擎具备更强的容错能力
3. **保障功能**: 确保预览线能够正常计算和显示
4. **智能推断**: 即使在层级映射缺失的情况下也能提供合理的坐标

### 测试验证
修复后需要验证以下场景：
1. 正常的节点层级计算
2. 缺失层级信息时的智能推断
3. 预览线的正常显示和交互
4. 不同类型节点的默认坐标分配

---
**修复状态**: ✅ 已完成  
**文档版本**: 1.0  
**创建时间**: 2025年01月16日 15:45