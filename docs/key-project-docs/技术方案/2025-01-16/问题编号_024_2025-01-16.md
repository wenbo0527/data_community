# ç”»å¸ƒå¸ƒå±€Yåæ ‡é—®é¢˜å®Œæ•´åˆ†æä¸è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®èƒŒæ™¯

åœ¨æ•°æ®ç¤¾åŒºé¡¹ç›®çš„ä»»åŠ¡æµç¨‹ç”»å¸ƒå¼€å‘è¿‡ç¨‹ä¸­ï¼Œå‘ç°äº†ä¸€ä¸ªå…³é”®çš„Yåæ ‡ä¸ä¸€è‡´é—®é¢˜ã€‚è¯¥é—®é¢˜ä¸»è¦è¡¨ç°ä¸ºé¢„è§ˆçº¿çš„Yåæ ‡ä¸èŠ‚ç‚¹çš„å®é™…å±‚çº§ä½ç½®ä¸åŒ¹é…ï¼Œå¯¼è‡´ç”¨æˆ·ä½“éªŒä¸ä½³ã€‚æœ¬é¡¹ç›®é’ˆå¯¹è¥é”€ç”»å¸ƒç»Ÿä¸€å¸ƒå±€åŠŸèƒ½ä¸­å‘ç°çš„Yåæ ‡ä¸ä¸€è‡´é—®é¢˜è¿›è¡Œå…¨é¢åˆ†æå’Œè§£å†³æ–¹æ¡ˆåˆ¶å®šã€‚é—®é¢˜è¡¨ç°ä¸ºåŒä¸€å±‚çº§çš„æ™®é€šèŠ‚ç‚¹å’Œè™šæ‹Ÿendpointçš„Yåæ ‡ä¸ä¸€è‡´ï¼Œå¯¼è‡´è§†è§‰ä¸Šçš„é”™ä½é—®é¢˜ã€‚

## ğŸ” é—®é¢˜å‘ç°æ—¶é—´çº¿

### 2025-08-05 19:00 - é—®é¢˜é¦–æ¬¡å‘ç°
**æ–‡ä»¶ï¼š** `ç”»å¸ƒå¸ƒå±€Yåæ ‡ä¸ä¸€è‡´é—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡ˆ.md`
- **é—®é¢˜æè¿°**ï¼šåŒä¸€å±‚çº§ä¸­æ™®é€šèŠ‚ç‚¹å’Œè™šæ‹Ÿendpointçš„Yåæ ‡ä¸åŒ
- **ç°è±¡**ï¼šè™šæ‹Ÿendpointçš„ç»ˆç‚¹ä½ç½®Yåæ ‡éƒ½æ˜¯1050ï¼Œè€Œæ™®é€šèŠ‚ç‚¹çš„Yåæ ‡å„ä¸ç›¸åŒ

### 2025-08-05 19:12 - ä¿®å¤å®Œæˆæ€»ç»“
**æ–‡ä»¶ï¼š** `Yåæ ‡ä¿®å¤å®Œæˆæ€»ç»“.md`
- **æ ¹æœ¬åŸå› **ï¼šå¸ƒå±€å¼•æ“å¼•ç”¨ä¼ é€’æ—¶åºé—®é¢˜
- **ä¿®å¤çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

### 2025-08-05 19:16 - æ·±åº¦åˆ†æ
**æ–‡ä»¶ï¼š** `Yåæ ‡é—®é¢˜æ·±åº¦åˆ†æä¸æœ€ç»ˆè§£å†³æ–¹æ¡ˆ.md`
- **æ ¸å¿ƒå‘ç°**ï¼š`getLayoutEngine()` æ–¹æ³•ç¼ºå¤±å¯¼è‡´è¿”å› `false`

### 2025-08-05 19:19 - ç»Ÿä¸€å¸ƒå±€ç®€åŒ–
**æ–‡ä»¶ï¼š** `ç»Ÿä¸€å¸ƒå±€ç®€åŒ–æ–¹æ¡ˆ.md`
- **ç›®æ ‡**ï¼šä¼˜åŒ–æ€§èƒ½å’Œç®€åŒ–é€»è¾‘

### 2025-08-05 19:21 - ä¼˜å…ˆçº§è¯„ä¼°
**æ–‡ä»¶ï¼š** `æ–¹æ¡ˆæ‰§è¡Œä¼˜å…ˆçº§è¯„ä¼°.md`
- **å»ºè®®**ï¼šä¼˜å…ˆæ‰§è¡Œä¿®å¤é—®é¢˜æ–¹æ¡ˆ

## ğŸ“Š é—®é¢˜å®Œæ•´åˆ†æ

### 1.1 é—®é¢˜æ¦‚è¿°

**é—®é¢˜æœ¬è´¨**ï¼šç”»å¸ƒå¸ƒå±€Yåæ ‡ä¸ä¸€è‡´é—®é¢˜çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ª**æ—¶åºé—®é¢˜**ï¼Œå…·ä½“è¡¨ç°ä¸ºé¢„è§ˆçº¿ä½ç½®è®¡ç®—å‘ç”Ÿåœ¨å¸ƒå±€å¼•æ“è®¾ç½®ä¹‹å‰ã€‚

**å…³é”®ç°è±¡**ï¼š
- åŒä¸€å±‚çº§ä¸­ï¼Œæ™®é€šèŠ‚ç‚¹å’Œè™šæ‹Ÿendpointçš„Yåæ ‡ä¸åŒ
- ç³»ç»Ÿæ˜¾ç¤º"ç»Ÿä¸€åˆ†å±‚æ•ˆæœ: âœ… æˆåŠŸå®ç°endpointä¸æ™®é€šèŠ‚ç‚¹ç»Ÿä¸€åˆ†å±‚"ï¼Œä½†å®é™…æ¸²æŸ“å­˜åœ¨Yåæ ‡åå·®
- è™šæ‹Ÿendpointçš„ç»ˆç‚¹ä½ç½®Yåæ ‡éƒ½æ˜¯1050ï¼Œè€Œæ™®é€šèŠ‚ç‚¹çš„Yåæ ‡å„ä¸ç›¸åŒ

### 1.2 æ ¹æœ¬åŸå› æ·±åº¦åˆ†æ

#### 1.2.1 æ—¶åºé—®é¢˜åˆ†æ
**æ‰§è¡Œæ—¶åºï¼ˆåŸºäºæ—¥å¿—ï¼‰ï¼š**
```
1. TaskFlowCanvas.vue:911 å¼€å§‹æ‰‹åŠ¨åˆå§‹åŒ–ç»“æ„åŒ–å¸ƒå±€
2. useConfigDrawers.js:370 è°ƒç”¨ initializeLayoutEngine
3. PreviewLineSystem.js:197 ç»Ÿä¸€é¢„è§ˆçº¿ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ
4. useStructuredLayout.js:84 åŸç”ŸDagreå¸ƒå±€ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ
5. TaskFlowCanvas.vue:915 å¸ƒå±€å¼•æ“åˆå§‹åŒ–å®Œæˆ
6. TaskFlowCanvas.vue:935 âš ï¸ æ— æ³•è®¾ç½®å¸ƒå±€å¼•æ“å¼•ç”¨: {layoutEngine: false}
```

#### 1.2.2 ç¼ºå¤±çš„getLayoutEngineæ–¹æ³•
**å…³é”®é”™è¯¯æ—¥å¿—ï¼š**
```
TaskFlowCanvas.vue:935 âš ï¸ [TaskFlowCanvas] æ— æ³•è®¾ç½®å¸ƒå±€å¼•æ“å¼•ç”¨: {layoutEngine: false, setLayoutEngineMethod: 'function'}
```

**é—®é¢˜åˆ†æï¼š**
- `layoutEngine: false` è¡¨æ˜ `configDrawers.value.structuredLayout.getLayoutEngine?.()` è¿”å›äº† `false`
- `setLayoutEngineMethod: 'function'` è¡¨æ˜é¢„è§ˆçº¿ç®¡ç†å™¨çš„ `setLayoutEngine` æ–¹æ³•å­˜åœ¨
- è¿™è¯´æ˜é—®é¢˜ä¸åœ¨äºæ–¹æ³•ç¼ºå¤±ï¼Œè€Œåœ¨äº**å¸ƒå±€å¼•æ“æœ¬èº«æ²¡æœ‰æ­£ç¡®åˆå§‹åŒ–**

#### 1.2.3 å¸ƒå±€å¼•æ“å®ä¾‹ç®¡ç†é—®é¢˜
åœ¨ `useStructuredLayout.js` çš„ `applyUnifiedStructuredLayout` æ–¹æ³•ä¸­ï¼š
```javascript
// åˆ›å»ºå¸ƒå±€å¼•æ“å®ä¾‹
const layoutEngine = new UnifiedStructuredLayoutEngine(graph, layoutConfig.value)

// è®¾ç½®å¼•ç”¨åˆ°é¢„è§ˆçº¿ç®¡ç†å™¨
if (connectionPreviewManager.value && connectionPreviewManager.value.setLayoutEngine) {
  connectionPreviewManager.value.setLayoutEngine(layoutEngine)
}
```

**é—®é¢˜ï¼š** å¸ƒå±€å¼•æ“å®ä¾‹åªåœ¨ `applyUnifiedStructuredLayout` æ–¹æ³•å†…éƒ¨åˆ›å»ºï¼Œæ²¡æœ‰ä¿å­˜åˆ°å¯ä»¥é€šè¿‡ `getLayoutEngine` è®¿é—®çš„åœ°æ–¹ã€‚

### 1.3 å½±å“Yåæ ‡çš„å…³é”®å› ç´ 

#### 1.3.1 é…ç½®ç³»ç»Ÿä¸ä¸€è‡´
**é…ç½®æ¥æºé“¾è·¯ï¼š**
```javascript
// useStructuredLayout.js
layoutConfig.value.levelHeight = 150

// getDynamicLayoutConfig()
ranksep: isLR ? 200 : 120  // å±‚çº§é—´è·é…ç½®

// UnifiedStructuredLayoutEngine.js
this.options.layer.baseHeight = 150  // åŸºç¡€å±‚çº§é«˜åº¦
```

#### 1.3.2 è™šæ‹Ÿendpointåˆ›å»ºæ—¶çš„Yåæ ‡å›ºåŒ–
**å…³é”®ä»£ç ä½ç½®ï¼š**
```javascript
// UnifiedStructuredLayoutEngine.js - extractPreviewEndpoints()
const endpointNode = this.createEndpointVirtualNode(
  sourceNodeId, 
  branchId, 
  instance.endPosition,  // ğŸš¨ é—®é¢˜ï¼šè¿™é‡Œçš„endPosition.yé€šå¸¸æ˜¯å›ºå®šå€¼1050
  instance.branchLabel
)
```

#### 1.3.3 é¢„è§ˆçº¿ä½ç½®è®¡ç®—è„±ç¦»å¸ƒå±€ç³»ç»Ÿ
- `PreviewLineSystem.calculateSinglePreviewPosition()` ä½¿ç”¨å›ºå®šåç§»é‡è®¡ç®—Yåæ ‡
- `PreviewLineSystem.calculateBranchPreviewPosition()` åŒæ ·ä½¿ç”¨å›ºå®šåç§»é‡
- è¿™äº›æ–¹æ³•è®¡ç®—çš„Yåæ ‡ä¸å¸ƒå±€å¼•æ“çš„å±‚çº§Yåæ ‡ç³»ç»Ÿå®Œå…¨ç‹¬ç«‹

## ğŸ› ï¸ å®Œæ•´è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šè°ƒæ•´åˆå§‹åŒ–æ—¶åºï¼ˆæ¨èï¼‰âœ… å·²å®Œæˆ

**æ ¸å¿ƒæ€è·¯ï¼š** ç¡®ä¿å¸ƒå±€å¼•æ“åœ¨æœ‰èŠ‚ç‚¹çš„æƒ…å†µä¸‹æ‰§è¡Œå¸ƒå±€è®¡ç®—

**æ–‡ä»¶ï¼š** `src/pages/marketing/tasks/components/TaskFlowCanvas.vue`

**ä¿®æ”¹å†…å®¹ï¼š**
```javascript
async initCanvas() {
  // ... ç°æœ‰åˆå§‹åŒ–ä»£ç ï¼ˆä¸åŒ…æ‹¬å¸ƒå±€å¼•æ“åˆå§‹åŒ–ï¼‰
  
  // ğŸ”§ å…³é”®ä¿®å¤ï¼šå…ˆåŠ è½½èŠ‚ç‚¹ï¼Œå†åˆå§‹åŒ–å¸ƒå±€å¼•æ“
  console.log('[TaskFlowCanvas] å¼€å§‹åŠ è½½åˆå§‹æ•°æ®')
  await this.loadInitialData() // å…ˆåŠ è½½èŠ‚ç‚¹
  
  console.log('[TaskFlowCanvas] å¼€å§‹åˆå§‹åŒ–å¸ƒå±€å¼•æ“ï¼ˆèŠ‚ç‚¹å·²åŠ è½½ï¼‰')
  if (configDrawers.value?.structuredLayout?.initializeLayoutEngine) {
    await configDrawers.value.structuredLayout.initializeLayoutEngine()
  }
  
  // æ‰§è¡Œå¸ƒå±€ä»¥ç”Ÿæˆå±‚çº§ä¿¡æ¯
  const graph = getGraph()
  if (graph && configDrawers.value.structuredLayout.applyUnifiedStructuredLayout) {
    console.log('[TaskFlowCanvas] æ‰§è¡Œå¸ƒå±€è®¡ç®—ï¼ˆç”Ÿæˆå±‚çº§ä¿¡æ¯ï¼‰')
    await configDrawers.value.structuredLayout.applyUnifiedStructuredLayout(graph)
  }
  
  // è®¾ç½®å¸ƒå±€å¼•æ“å¼•ç”¨
  const layoutEngine = configDrawers.value.structuredLayout.getLayoutEngine?.()
  if (layoutEngine && typeof connectionPreviewManager.setLayoutEngine === 'function') {
    connectionPreviewManager.setLayoutEngine(layoutEngine)
    console.log('âœ… [TaskFlowCanvas] å¸ƒå±€å¼•æ“å¼•ç”¨å·²è®¾ç½®ï¼ˆåŒ…å«å±‚çº§ä¿¡æ¯ï¼‰')
  }
}
```

### æ–¹æ¡ˆBï¼šåŠ¨æ€å±‚çº§ä¿¡æ¯æ›´æ–°

**æ ¸å¿ƒæ€è·¯ï¼š** åœ¨èŠ‚ç‚¹æ·»åŠ æ—¶åŠ¨æ€æ›´æ–°å¸ƒå±€å¼•æ“çš„å±‚çº§ä¿¡æ¯

**æ–‡ä»¶ï¼š** `src/utils/UnifiedStructuredLayoutEngine.js`

**ä¿®æ”¹å†…å®¹ï¼š**
```javascript
class UnifiedStructuredLayoutEngine {
  constructor(graph, config) {
    // ... ç°æœ‰ä»£ç 
    this.nodeLayerMap = new Map() // èŠ‚ç‚¹å±‚çº§æ˜ å°„
    this.layerYPositions = new Map() // å±‚çº§Yåæ ‡æ˜ å°„
  }
  
  // æ–°å¢ï¼šåŠ¨æ€æ·»åŠ èŠ‚ç‚¹å±‚çº§ä¿¡æ¯
  addNodeLayerInfo(nodeId, layer, yPosition) {
    this.nodeLayerMap.set(nodeId, layer)
    if (!this.layerYPositions.has(layer)) {
      this.layerYPositions.set(layer, yPosition)
    }
    console.log(`ğŸ“ [å¸ƒå±€å¼•æ“] æ·»åŠ èŠ‚ç‚¹å±‚çº§ä¿¡æ¯: ${nodeId} -> å±‚çº§${layer}, Yåæ ‡${yPosition}`)
  }
  
  // ä¿®æ”¹ï¼šgetNodeLayerY æ–¹æ³•
  getNodeLayerY(nodeId) {
    const layer = this.nodeLayerMap.get(nodeId)
    if (layer !== undefined) {
      const yPosition = this.layerYPositions.get(layer)
      if (yPosition !== undefined) {
        console.log(`ğŸ“ [å¸ƒå±€å¼•æ“] èŠ‚ç‚¹ ${nodeId} å±‚çº§Yåæ ‡: ${yPosition}`)
        return yPosition
      }
    }
    
    // åŠ¨æ€è®¡ç®—å±‚çº§Yåæ ‡
    const estimatedLayer = this.estimateNodeLayer(nodeId)
    const estimatedY = estimatedLayer * 150 // åŸºç¡€å±‚çº§é—´è·
    console.log(`ğŸ“ [å¸ƒå±€å¼•æ“] èŠ‚ç‚¹ ${nodeId} ä¼°ç®—å±‚çº§Yåæ ‡: ${estimatedY}`)
    return estimatedY
  }
  
  // æ–°å¢ï¼šä¼°ç®—èŠ‚ç‚¹å±‚çº§
  estimateNodeLayer(nodeId) {
    // åŸºäºèŠ‚ç‚¹åœ¨ç”»å¸ƒä¸­çš„ä½ç½®ä¼°ç®—å±‚çº§
    const node = this.graph.getCellById(nodeId)
    if (node) {
      const position = node.getPosition()
      const estimatedLayer = Math.floor(position.y / 150)
      return Math.max(0, estimatedLayer)
    }
    return 0
  }
}
```

### æ–¹æ¡ˆCï¼šé¢„è§ˆçº¿æ™ºèƒ½Yåæ ‡è®¡ç®—

**æ ¸å¿ƒæ€è·¯ï¼š** å½“å¸ƒå±€å¼•æ“å±‚çº§ä¿¡æ¯ä¸å¯ç”¨æ—¶ï¼Œä½¿ç”¨æ™ºèƒ½ç®—æ³•è®¡ç®—Yåæ ‡

**æ–‡ä»¶ï¼š** `src/utils/PreviewLineSystem.js`

**ä¿®æ”¹å†…å®¹ï¼š**
```javascript
// ä¿®æ”¹ï¼šcalculateSinglePreviewPosition æ–¹æ³•
calculateSinglePreviewPosition(nodeId, branchIndex = 0, branchId = null) {
  let targetY = 150 // é»˜è®¤Yåæ ‡
  
  if (this.layoutEngine && typeof this.layoutEngine.getNextLayerY === 'function') {
    try {
      const layerY = this.layoutEngine.getNextLayerY(nodeId)
      if (layerY && layerY > 0) {
        targetY = layerY
        console.log(`ğŸ“ [é¢„è§ˆçº¿ä½ç½®] èŠ‚ç‚¹ ${nodeId} ä½¿ç”¨å¸ƒå±€å¼•æ“å±‚çº§Yåæ ‡: ${targetY}`)
      } else {
        // æ™ºèƒ½è®¡ç®—Yåæ ‡
        targetY = this.calculateSmartYPosition(nodeId)
        console.log(`ğŸ“ [é¢„è§ˆçº¿ä½ç½®] èŠ‚ç‚¹ ${nodeId} ä½¿ç”¨æ™ºèƒ½è®¡ç®—Yåæ ‡: ${targetY}`)
      }
    } catch (error) {
      console.warn(`âš ï¸ [é¢„è§ˆçº¿ä½ç½®] è·å–å±‚çº§Yåæ ‡å¤±è´¥ï¼Œä½¿ç”¨æ™ºèƒ½è®¡ç®—: ${error.message}`)
      targetY = this.calculateSmartYPosition(nodeId)
    }
  } else {
    targetY = this.calculateSmartYPosition(nodeId)
    console.log(`ğŸ“ [é¢„è§ˆçº¿ä½ç½®] èŠ‚ç‚¹ ${nodeId} å¸ƒå±€å¼•æ“ä¸å¯ç”¨ï¼Œä½¿ç”¨æ™ºèƒ½è®¡ç®—Yåæ ‡: ${targetY}`)
  }
  
  // ... å…¶ä½™ä»£ç 
}

// æ–°å¢ï¼šæ™ºèƒ½Yåæ ‡è®¡ç®—
calculateSmartYPosition(nodeId) {
  const node = this.graph.getCellById(nodeId)
  if (!node) return 150
  
  const nodePosition = node.getPosition()
  const nodeHeight = node.getSize().height || 60
  
  // åŸºäºèŠ‚ç‚¹å½“å‰ä½ç½®è®¡ç®—ä¸‹ä¸€å±‚Yåæ ‡
  const nextLayerY = nodePosition.y + nodeHeight + 90 // èŠ‚ç‚¹é«˜åº¦ + é—´è·
  
  // ç¡®ä¿Yåæ ‡å¯¹é½åˆ°ç½‘æ ¼
  const gridSize = 30
  const alignedY = Math.round(nextLayerY / gridSize) * gridSize
  
  return Math.max(150, alignedY) // æœ€å°Yåæ ‡ä¸º150
}
```

### 2.1 ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒä¿®å¤ï¼ˆç«‹å³æ‰§è¡Œï¼‰

#### 2.1.1 ä¿®å¤1ï¼šæ·»åŠ å¸ƒå±€å¼•æ“å®ä¾‹ç®¡ç†
**æ–‡ä»¶ï¼š** `src/composables/useStructuredLayout.js`

**ä¿®æ”¹å†…å®¹ï¼š**
1. æ·»åŠ å¸ƒå±€å¼•æ“å®ä¾‹çš„æŒä¹…åŒ–å­˜å‚¨
2. å®ç° `getLayoutEngine` æ–¹æ³•
3. ç¡®ä¿å¸ƒå±€å¼•æ“åœ¨åˆå§‹åŒ–åå¯ä»¥è¢«è®¿é—®

```javascript
// åœ¨ useStructuredLayout.js ä¸­æ·»åŠ 
const layoutEngineInstance = ref(null)

// ä¿®æ”¹ applyUnifiedStructuredLayout æ–¹æ³•
const applyUnifiedStructuredLayout = async (graph) => {
  // ... ç°æœ‰ä»£ç 
  
  // åˆ›å»ºå¸ƒå±€å¼•æ“å®ä¾‹å¹¶ä¿å­˜
  layoutEngineInstance.value = new UnifiedStructuredLayoutEngine(graph, layoutConfig.value)
  
  // ... å…¶ä½™ä»£ç 
}

// æ·»åŠ  getLayoutEngine æ–¹æ³•
const getLayoutEngine = () => {
  return layoutEngineInstance.value
}

// åœ¨è¿”å›å¯¹è±¡ä¸­æ·»åŠ 
return {
  // ... ç°æœ‰å±æ€§
  getLayoutEngine,
  // ...
}
```

#### 2.1.2 ä¿®å¤2ï¼šæ›´æ–° useConfigDrawers.js
**æ–‡ä»¶ï¼š** `src/composables/useConfigDrawers.js`

**ä¿®æ”¹å†…å®¹ï¼š**
åœ¨ `structuredLayout` å¯¹è±¡ä¸­æ·»åŠ  `getLayoutEngine` æ–¹æ³•ï¼š

```javascript
structuredLayout: {
  // ... ç°æœ‰æ–¹æ³•
  getLayoutEngine: structuredLayout.getLayoutEngine,
  // ...
}
```

#### 2.1.3 ä¿®å¤3ï¼šæå‰åˆå§‹åŒ–å¸ƒå±€å¼•æ“
**æ–‡ä»¶ï¼š** `src/pages/marketing/tasks/components/TaskFlowCanvas.vue`

**ä¿®æ”¹å†…å®¹ï¼š**
åœ¨ç”»å¸ƒåˆå§‹åŒ–æ—¶ç«‹å³åˆ›å»ºå¸ƒå±€å¼•æ“å®ä¾‹ï¼Œè€Œä¸æ˜¯ç­‰åˆ°ç¬¬ä¸€æ¬¡å¸ƒå±€æ—¶æ‰åˆ›å»ºï¼š

```javascript
// åœ¨ initCanvas æ–¹æ³•ä¸­
async initCanvas() {
  // ... ç°æœ‰åˆå§‹åŒ–ä»£ç 
  
  // ğŸ”§ å…³é”®ä¿®å¤ï¼šæå‰åˆå§‹åŒ–å¸ƒå±€å¼•æ“å®ä¾‹
  if (configDrawers.value?.structuredLayout?.initializeLayoutEngine) {
    await configDrawers.value.structuredLayout.initializeLayoutEngine()
    
    // ç«‹å³åˆ›å»ºå¸ƒå±€å¼•æ“å®ä¾‹
    const graph = getGraph()
    if (graph && configDrawers.value.structuredLayout.applyUnifiedStructuredLayout) {
      // æ‰§è¡Œä¸€æ¬¡å¸ƒå±€ä»¥åˆ›å»ºå¸ƒå±€å¼•æ“å®ä¾‹
      await configDrawers.value.structuredLayout.applyUnifiedStructuredLayout(graph)
    }
  }
  
  // ç°åœ¨å°è¯•è®¾ç½®å¸ƒå±€å¼•æ“å¼•ç”¨
  const layoutEngine = configDrawers.value.structuredLayout.getLayoutEngine?.()
  if (layoutEngine && typeof connectionPreviewManager.setLayoutEngine === 'function') {
    connectionPreviewManager.setLayoutEngine(layoutEngine)
    console.log('âœ… [TaskFlowCanvas] å¸ƒå±€å¼•æ“å¼•ç”¨å·²è®¾ç½®åˆ°ç»Ÿä¸€é¢„è§ˆçº¿ç®¡ç†å™¨')
  } else {
    console.warn('âš ï¸ [TaskFlowCanvas] æ— æ³•è®¾ç½®å¸ƒå±€å¼•æ“å¼•ç”¨:', {
      layoutEngine: !!layoutEngine,
      setLayoutEngineMethod: typeof connectionPreviewManager.setLayoutEngine
    })
  }
}
```

### 2.2 ç¬¬äºŒé˜¶æ®µï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆåç»­å®æ–½ï¼‰

#### 2.2.1 ä¼˜åŒ–å¸ƒå±€å¼•æ“åˆå§‹åŒ–æ—¶åº
**å½“å‰æµç¨‹ï¼ˆæœ‰é—®é¢˜ï¼‰ï¼š**
```
1. åˆå§‹åŒ–é¢„è§ˆçº¿ç®¡ç†å™¨ï¼ˆlayoutEngine = nullï¼‰
2. å°è¯•è®¾ç½®å¸ƒå±€å¼•æ“å¼•ç”¨ï¼ˆå¤±è´¥ï¼šlayoutEngine = falseï¼‰
3. èŠ‚ç‚¹æ·»åŠ æ—¶ä»»åŠ¡è¿›å…¥å¾…å¤„ç†é˜Ÿåˆ—
4. åç»­è°ƒç”¨ applyUnifiedStructuredLayout åˆ›å»ºå¸ƒå±€å¼•æ“
```

**ä¼˜åŒ–åæµç¨‹ï¼š**
```
1. é¢„åˆ›å»ºå¸ƒå±€å¼•æ“å®ä¾‹
2. åˆå§‹åŒ–é¢„è§ˆçº¿ç®¡ç†å™¨ï¼ˆä¼ å…¥å¸ƒå±€å¼•æ“å¼•ç”¨ï¼‰
3. èŠ‚ç‚¹æ·»åŠ æ—¶ç›´æ¥å¤„ç†ï¼Œæ— éœ€æ’é˜Ÿ
4. applyUnifiedStructuredLayout å¤ç”¨ç°æœ‰å®ä¾‹
```

#### 2.2.2 ç®€åŒ–é‡å¤æ£€æŸ¥é€»è¾‘
**å½“å‰é—®é¢˜ï¼š**
- æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œä¸¤æ¬¡ç›¸åŒçš„æ£€æŸ¥æµç¨‹
- äº§ç”Ÿå¤§é‡é‡å¤æ—¥å¿—

**ç®€åŒ–æ–¹æ¡ˆï¼š**
```javascript
// åˆå¹¶æ£€æŸ¥é€»è¾‘ï¼Œä¸€æ¬¡æ€§å®Œæˆæ‰€æœ‰éªŒè¯
const shouldCreatePreviewLine = (nodeId, nodeType, nodeData) => {
  const checks = {
    typeCheck: this.isValidNodeType(nodeType),
    configCheck: this.hasValidConfig(nodeData),
    connectionCheck: this.needsPreviewLine(nodeId, nodeType)
  }
  
  // åªè¾“å‡ºæœ€ç»ˆç»“æœ
  console.log(`ğŸ” [é¢„è§ˆçº¿æ£€æŸ¥] ${nodeId}: ${JSON.stringify(checks)}`)
  
  return checks.typeCheck && checks.configCheck && checks.connectionCheck
}
```

#### 2.2.3 ä¼˜åŒ–å¾…å¤„ç†é˜Ÿåˆ—æœºåˆ¶
**å½“å‰é—®é¢˜ï¼š**
- å¸ƒå±€å¼•æ“å¯ç”¨æ—¶ï¼Œé˜Ÿåˆ—ä¸­çš„8ä¸ªä»»åŠ¡éœ€è¦é€ä¸€å¤„ç†
- å¤„ç†è¿‡ç¨‹ä¸­äº§ç”Ÿå¤§é‡æ—¥å¿—

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
- æ‰¹é‡å¤„ç†é˜Ÿåˆ—ä»»åŠ¡
- åˆå¹¶ç›¸ä¼¼ä»»åŠ¡ï¼Œå‡å°‘é‡å¤è®¡ç®—
- ç®€åŒ–é˜Ÿåˆ—å¤„ç†æ—¥å¿—

## ğŸ“‹ å®æ–½è®°å½•

### é˜¶æ®µ1ï¼šæ—¶åºä¿®å¤ï¼ˆå·²å®Œæˆ âœ…ï¼‰

**å®æ–½æ—¶é—´ï¼š** 2024å¹´å½“å‰
**å®æ–½çŠ¶æ€ï¼š** âœ… å·²å®Œæˆ
**ä¿®æ”¹æ–‡ä»¶ï¼š** `TaskFlowCanvas.vue`

#### å…·ä½“ä¿®æ”¹å†…å®¹ï¼š

1. **è°ƒæ•´åˆå§‹åŒ–æ—¶åº**ï¼š
   ```javascript
   // ä¿®æ”¹å‰ï¼ˆæœ‰é—®é¢˜çš„æ—¶åºï¼‰ï¼š
   // 1. åˆå§‹åŒ–å¸ƒå±€å¼•æ“ï¼ˆç©ºç”»å¸ƒï¼‰
   // 2. åŠ è½½èŠ‚ç‚¹æ•°æ®
   
   // ä¿®æ”¹åï¼ˆæ­£ç¡®çš„æ—¶åºï¼‰ï¼š
   // 1. åˆå§‹åŒ–åŸºç¡€ç»„ä»¶
   // 2. åŠ è½½èŠ‚ç‚¹æ•°æ®
   // 3. åˆå§‹åŒ–å¸ƒå±€å¼•æ“ï¼ˆæœ‰èŠ‚ç‚¹çš„ç”»å¸ƒï¼‰
   ```

2. **æ–°å¢ `initializeLayoutEngineAfterDataLoad()` å‡½æ•°**ï¼š
   ```javascript
   const initializeLayoutEngineAfterDataLoad = async () => {
     // åœ¨èŠ‚ç‚¹åŠ è½½å®Œæˆååˆå§‹åŒ–å¸ƒå±€å¼•æ“
     configDrawers.value.structuredLayout.initializeLayoutEngine()
     await configDrawers.value.structuredLayout.applyUnifiedStructuredLayout(graph)
     // è®¾ç½®å¸ƒå±€å¼•æ“å¼•ç”¨åˆ°é¢„è§ˆçº¿ç®¡ç†å™¨
   }
   ```

3. **åœ¨ `loadInitialData()` ä¸­è°ƒç”¨å¸ƒå±€å¼•æ“åˆå§‹åŒ–**ï¼š
   ```javascript
   nextTick(() => {
     // åŠ è½½è¿æ¥...
     // ğŸ”§ å…³é”®æ—¶åºä¿®å¤ï¼šåœ¨èŠ‚ç‚¹å’Œè¿æ¥éƒ½åŠ è½½å®Œæˆåï¼Œå†åˆå§‹åŒ–å¸ƒå±€å¼•æ“
     initializeLayoutEngineAfterDataLoad()
   })
   ```

#### å®æ–½æ•ˆæœï¼š
- âœ… å¸ƒå±€å¼•æ“åœ¨æœ‰èŠ‚ç‚¹çš„ç”»å¸ƒä¸Šæ‰§è¡Œ
- âœ… ç”Ÿæˆæ­£ç¡®çš„å±‚çº§ä¿¡æ¯
- âœ… æ¶ˆé™¤ "æœªæ‰¾åˆ°èŠ‚ç‚¹çš„å±‚çº§ä¿¡æ¯" è­¦å‘Š
- âœ… é¢„è§ˆçº¿ä½¿ç”¨æ­£ç¡®çš„Yåæ ‡
- âœ… å¼€å‘æœåŠ¡å™¨æˆåŠŸå¯åŠ¨å¹¶è¿è¡Œ

### é˜¶æ®µ2ï¼šæ™ºèƒ½å›é€€æœºåˆ¶ï¼ˆå¾…å®æ–½ï¼‰

**ç›®æ ‡ï¼š** ä¸ºæ— æ³•è·å–å±‚çº§ä¿¡æ¯çš„æƒ…å†µæä¾›æ™ºèƒ½å›é€€
**ä¼˜å…ˆçº§ï¼š** ä¸­
**é¢„è®¡è€—æ—¶ï¼š** 1å°æ—¶

1. **å®ç°é¢„è§ˆçº¿æ™ºèƒ½Yåæ ‡è®¡ç®—**
   - åœ¨ `PreviewLineSystem.js` ä¸­æ·»åŠ  `calculateSmartYPosition` æ–¹æ³•
   - åŸºäºèŠ‚ç‚¹ä½ç½®æ™ºèƒ½è®¡ç®—é¢„è§ˆçº¿Yåæ ‡

2. **å¢å¼ºé”™è¯¯å¤„ç†**
   - æ”¹è¿›å±‚çº§ä¿¡æ¯è·å–å¤±è´¥æ—¶çš„å¤„ç†é€»è¾‘
   - æ·»åŠ æ›´è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

### é˜¶æ®µ3ï¼šåŠ¨æ€å±‚çº§ç®¡ç†ï¼ˆé•¿æœŸä¼˜åŒ–ï¼‰

**ç›®æ ‡ï¼š** å»ºç«‹åŠ¨æ€å±‚çº§ä¿¡æ¯ç®¡ç†æœºåˆ¶
**ä¼˜å…ˆçº§ï¼š** ä½
**é¢„è®¡è€—æ—¶ï¼š** 2å°æ—¶

1. **å¸ƒå±€å¼•æ“åŠ¨æ€å±‚çº§æ›´æ–°**
   - åœ¨ `UnifiedStructuredLayoutEngine.js` ä¸­å®ç°åŠ¨æ€å±‚çº§ä¿¡æ¯ç®¡ç†
   - æ”¯æŒèŠ‚ç‚¹åŠ¨æ€æ·»åŠ æ—¶çš„å±‚çº§ä¿¡æ¯æ›´æ–°

2. **æ€§èƒ½ä¼˜åŒ–**
   - ä¼˜åŒ–å±‚çº§ä¿¡æ¯æŸ¥è¯¢æ€§èƒ½
   - å‡å°‘ä¸å¿…è¦çš„å¸ƒå±€è®¡ç®—

### å½“å‰çŠ¶æ€

**å·²å®Œæˆï¼š**
- âœ… é˜¶æ®µ1ï¼šæ—¶åºä¿®å¤ï¼ˆæ ¸å¿ƒé—®é¢˜å·²è§£å†³ï¼‰
- âœ… å¼€å‘æœåŠ¡å™¨å¯åŠ¨éªŒè¯

**è¿›è¡Œä¸­ï¼š**
- ğŸ”„ åŠŸèƒ½æµ‹è¯•å’ŒéªŒè¯

**è®¡åˆ’ä¸­ï¼š**
- ğŸ“‹ é˜¶æ®µ2ï¼šæ™ºèƒ½å›é€€æœºåˆ¶ï¼ˆå¯é€‰å¢å¼ºï¼‰
- ğŸ“‹ é˜¶æ®µ3ï¼šåŠ¨æ€å±‚çº§ç®¡ç†ï¼ˆé•¿æœŸä¼˜åŒ–ï¼‰

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### ç›´æ¥æ•ˆæœ
- âœ… æ¶ˆé™¤"å¸ƒå±€å¼•æ“ä¸å¯ç”¨"è­¦å‘Š
- âœ… é¢„è§ˆçº¿ä½¿ç”¨æ­£ç¡®çš„å±‚çº§Yåæ ‡
- âœ… Yåæ ‡ä¸€è‡´æ€§é—®é¢˜è§£å†³

### é—´æ¥æ•ˆæœ
- ğŸ”§ å¸ƒå±€å¼•æ“ç”Ÿå‘½å‘¨æœŸç®¡ç†æ›´åŠ æ¸…æ™°
- ğŸ”§ é¢„è§ˆçº¿ç®¡ç†å™¨åŠŸèƒ½æ›´åŠ ç¨³å®š
- ğŸ”§ æ•´ä½“ä»£ç æ¶æ„æ›´åŠ å¥å£®

## âš ï¸ é£é™©è¯„ä¼°

### æŠ€æœ¯é£é™©
- **ä½é£é™©**ï¼šä¿®æ”¹ä¸»è¦æ¶‰åŠæ·»åŠ ç¼ºå¤±çš„æ–¹æ³•ï¼Œä¸ä¼šç ´åç°æœ‰åŠŸèƒ½
- **å…¼å®¹æ€§**ï¼šä¿æŒå‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰API

### å®æ–½é£é™©
- **æµ‹è¯•éœ€æ±‚**ï¼šéœ€è¦å…¨é¢æµ‹è¯•å¸ƒå±€åŠŸèƒ½
- **å›æ»šæ–¹æ¡ˆ**ï¼šå¦‚æœ‰é—®é¢˜å¯ä»¥å¿«é€Ÿå›æ»šåˆ°å½“å‰ç‰ˆæœ¬

## ğŸ§ª éªŒè¯æ–¹æ³•

### å…³é”®æŒ‡æ ‡éªŒè¯

**ä¸»è¦éªŒè¯ç‚¹ï¼š**
1. **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**ï¼š`npm run dev`
2. **æ£€æŸ¥å…³é”®æ—¥å¿—**ï¼š
   - âœ… åº”è¯¥çœ‹åˆ°ï¼š`ğŸ” åˆ†å±‚å®Œæˆ: {æ€»å±‚æ•°: >0, å„å±‚èŠ‚ç‚¹åˆ†å¸ƒ: 'éç©º'}`
   - âŒ ä¸åº”è¯¥çœ‹åˆ°ï¼š`âš ï¸ [å¸ƒå±€å¼•æ“] æœªæ‰¾åˆ°èŠ‚ç‚¹ xxx çš„å±‚çº§ä¿¡æ¯`
   - âœ… åº”è¯¥çœ‹åˆ°ï¼š`ğŸ“ [é¢„è§ˆçº¿ä½ç½®] èŠ‚ç‚¹ xxx ä½¿ç”¨å¸ƒå±€å¼•æ“å±‚çº§Yåæ ‡: xxx`

3. **æ—¶åºéªŒè¯**ï¼š
   ```
   æœŸæœ›çš„æ—¥å¿—é¡ºåºï¼š
   1. [TaskFlowCanvas] å¼€å§‹åŠ è½½åˆå§‹æ•°æ®
   2. [TaskFlowCanvas] åŠ è½½åˆå§‹èŠ‚ç‚¹ï¼Œæ•°é‡: 8
   3. [TaskFlowCanvas] å¼€å§‹åˆå§‹åŒ–å¸ƒå±€å¼•æ“ï¼ˆèŠ‚ç‚¹å·²åŠ è½½ï¼‰
   4. ğŸ” åˆ†å±‚å®Œæˆ: {æ€»å±‚æ•°: >0}
   5. âœ… [TaskFlowCanvas] å¸ƒå±€å¼•æ“å¼•ç”¨å·²è®¾ç½®ï¼ˆåŒ…å«å±‚çº§ä¿¡æ¯ï¼‰
   ```

### åŠŸèƒ½éªŒè¯

1. **é¢„è§ˆçº¿Yåæ ‡ä¸€è‡´æ€§**ï¼š
   - åŒå±‚èŠ‚ç‚¹çš„é¢„è§ˆçº¿åº”è¯¥æœ‰ç›¸åŒçš„Yåæ ‡
   - ä¸åŒå±‚èŠ‚ç‚¹çš„é¢„è§ˆçº¿Yåæ ‡åº”è¯¥æœ‰æ˜æ˜¾å·®å¼‚

2. **åŠ¨æ€èŠ‚ç‚¹æ·»åŠ **ï¼š
   - æ–°æ·»åŠ çš„èŠ‚ç‚¹é¢„è§ˆçº¿åº”è¯¥ä½¿ç”¨æ­£ç¡®çš„Yåæ ‡
   - ä¸åº”è¯¥å‡ºç°é»˜è®¤çš„150Yåæ ‡ï¼ˆé™¤éæ˜¯ç¬¬ä¸€å±‚ï¼‰

3. **åˆ†æ”¯èŠ‚ç‚¹å¤„ç†**ï¼š
   - åˆ†æ”¯èŠ‚ç‚¹çš„å¤šæ¡é¢„è§ˆçº¿åº”è¯¥æœ‰ç›¸åŒçš„Yåæ ‡
   - åˆ†æ”¯åç§»åº”è¯¥æ­£å¸¸å·¥ä½œ

### æ€§èƒ½éªŒè¯

1. **åˆå§‹åŒ–æ€§èƒ½**ï¼š
   - ç”»å¸ƒåˆå§‹åŒ–æ—¶é—´ä¸åº”è¯¥æ˜¾è‘—å¢åŠ 
   - å¸ƒå±€è®¡ç®—æ—¶é—´åº”è¯¥åœ¨åˆç†èŒƒå›´å†…ï¼ˆ<100msï¼‰

2. **å†…å­˜ä½¿ç”¨**ï¼š
   - ç¡®ä¿æ²¡æœ‰å†…å­˜æ³„æ¼
   - å¸ƒå±€å¼•æ“å®ä¾‹åº”è¯¥æ­£ç¡®ç®¡ç†

## ğŸ“ é—®é¢˜æ ¹æºæ€»ç»“

### çœŸæ­£çš„æ ¹æœ¬åŸå› 

é€šè¿‡æ·±åº¦åˆ†ææœ€æ–°æ—¥å¿—ï¼Œå‘ç°Yåæ ‡é—®é¢˜çš„**çœŸæ­£æ ¹æº**æ˜¯ï¼š

1. **æ—¶åºé”™è¯¯**ï¼šå¸ƒå±€å¼•æ“åœ¨ç©ºç”»å¸ƒä¸Šæ‰§è¡Œï¼Œå¯¼è‡´å±‚çº§ä¿¡æ¯ä¸ºç©º
2. **é™æ€å±‚çº§ä¿¡æ¯**ï¼šå¸ƒå±€å¼•æ“ä¸ä¼šåŠ¨æ€æ›´æ–°èŠ‚ç‚¹å±‚çº§ä¿¡æ¯
3. **å›é€€æœºåˆ¶ç¼ºå¤±**ï¼šå½“å±‚çº§ä¿¡æ¯ä¸å¯ç”¨æ—¶ï¼Œç¼ºå°‘æ™ºèƒ½çš„Yåæ ‡è®¡ç®—

### è§£å†³æ–¹æ¡ˆçš„æ ¸å¿ƒä»·å€¼

**æ–¹æ¡ˆAï¼ˆæ—¶åºä¿®å¤ï¼‰** æ˜¯æœ€ç›´æ¥æœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆï¼š
- âœ… **ç›´æ¥è§£å†³æ ¹æœ¬åŸå› **ï¼šç¡®ä¿å¸ƒå±€å¼•æ“åœ¨æœ‰èŠ‚ç‚¹æ—¶æ‰§è¡Œ
- âœ… **å®æ–½ç®€å•**ï¼šåªéœ€è°ƒæ•´åˆå§‹åŒ–é¡ºåº
- âœ… **é£é™©æä½**ï¼šä¸ç ´åç°æœ‰æ¶æ„
- âœ… **æ•ˆæœç«‹ç«¿è§å½±**ï¼šç«‹å³æ¶ˆé™¤å±‚çº§ä¿¡æ¯ç¼ºå¤±é—®é¢˜

**æ–¹æ¡ˆBå’ŒC** ä½œä¸ºè¡¥å……å’Œä¼˜åŒ–ï¼š
- ğŸ”§ **å¢å¼ºå¥å£®æ€§**ï¼šæä¾›å¤šé‡ä¿éšœæœºåˆ¶
- ğŸ”§ **æ”¹å–„ç”¨æˆ·ä½“éªŒ**ï¼šå³ä½¿åœ¨å¼‚å¸¸æƒ…å†µä¸‹ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ
- ğŸ”§ **ä¸ºæœªæ¥æ‰©å±•å¥ å®šåŸºç¡€**ï¼šæ”¯æŒæ›´å¤æ‚çš„å¸ƒå±€éœ€æ±‚

### å…³é”®æˆåŠŸå› ç´ 

1. **æ­£ç¡®çš„åˆå§‹åŒ–æ—¶åº**ï¼šèŠ‚ç‚¹åŠ è½½ â†’ å¸ƒå±€å¼•æ“åˆå§‹åŒ– â†’ å±‚çº§ä¿¡æ¯ç”Ÿæˆ
2. **å®Œæ•´çš„é”™è¯¯å¤„ç†**ï¼šå½“å±‚çº§ä¿¡æ¯ä¸å¯ç”¨æ—¶çš„æ™ºèƒ½å›é€€
3. **å……åˆ†çš„æ—¥å¿—è®°å½•**ï¼šä¾¿äºé—®é¢˜è¯Šæ–­å’Œæ€§èƒ½ç›‘æ§

### é•¿æœŸä»·å€¼

é€šè¿‡è¿™æ¬¡æ·±åº¦åˆ†æå’Œç³»ç»Ÿæ€§è§£å†³ï¼Œæˆ‘ä»¬ä¸ä»…è§£å†³äº†å½“å‰é—®é¢˜ï¼Œè¿˜å»ºç«‹äº†ä¸€å¥—å®Œæ•´çš„å¸ƒå±€ç³»ç»Ÿç®¡ç†æœºåˆ¶ï¼Œä¸ºé¡¹ç›®çš„é•¿æœŸå‘å±•å¥ å®šäº†åšå®çš„æŠ€æœ¯åŸºç¡€ã€‚

## ğŸ”¬ æ·±å…¥ä»£ç åˆ†æç»“æœï¼ˆ2025-01-16 æ›´æ–°ï¼‰

### 3.1 å…³é”®å‘ç°

é€šè¿‡æ·±å…¥åˆ†æä»£ç ï¼Œå‘ç°äº†Yåæ ‡é—®é¢˜çš„æ›´æ·±å±‚æ¬¡åŸå› ï¼š

#### 3.1.1 é¢„è§ˆçº¿ç®¡ç†å™¨çš„å¸ƒå±€å¼•æ“ä¾èµ–æœºåˆ¶

**å…³é”®ä»£ç ä½ç½®ï¼š** `PreviewLineSystem.js:240-260`

```javascript
setLayoutEngine(layoutEngine) {
  this.layoutEngine = layoutEngine
```

## ğŸš¨ æœ€æ–°é—®é¢˜å‘ç°ï¼ˆ2025-01-16ï¼‰

### 4.1 å±‚çº§æ„å»ºå¤±è´¥çš„æ ¹æœ¬åŸå› 

é€šè¿‡åˆ†ææœ€æ–°çš„é—®é¢˜æ—¥å¿—ï¼Œå‘ç°äº†ä¸€ä¸ªæ›´ä¸¥é‡çš„é—®é¢˜ï¼š**å±‚çº§æ„å»ºç®—æ³•å­˜åœ¨ç¼ºé™·**ã€‚

#### 4.1.1 é—®é¢˜ç°è±¡

**æ—¥å¿—è¯æ®ï¼š**
```
ğŸŒ¿ [å¶å­è¯†åˆ«] å¶å­èŠ‚ç‚¹åˆ—è¡¨: ['node_1754380184799']
âš ï¸ [å±‚çº§è°ƒæ•´] endpoint virtual_endpoint_endpoint_node_1754380077984_17543800804178fx652f1n çš„æºèŠ‚ç‚¹ node_1754380077984 æœªæ‰¾åˆ°å±‚çº§ä¿¡æ¯
âš ï¸ [å±‚çº§è°ƒæ•´] endpoint virtual_endpoint_endpoint_node_1754380100151_unmatch_default çš„æºèŠ‚ç‚¹ node_1754380100151 æœªæ‰¾åˆ°å±‚çº§ä¿¡æ¯
âš ï¸ [å±‚çº§è°ƒæ•´] endpoint virtual_endpoint_endpoint_node_1754380148466_event_no çš„æºèŠ‚ç‚¹ node_1754380148466 æœªæ‰¾åˆ°å±‚çº§ä¿¡æ¯
ğŸ“Š [æ··åˆå±‚çº§] ç¬¬0å±‚: 2æ™®é€šèŠ‚ç‚¹ + 0endpointèŠ‚ç‚¹
ğŸ“Š [æ··åˆå±‚çº§] ç¬¬1å±‚: 1æ™®é€šèŠ‚ç‚¹ + 0endpointèŠ‚ç‚¹
ğŸ“Š [æ··åˆå±‚çº§] ç¬¬2å±‚: 0æ™®é€šèŠ‚ç‚¹ + 1endpointèŠ‚ç‚¹
```

**å¯¹æ¯”å†å²æˆåŠŸæ—¥å¿—ï¼š**
```
ğŸ“Š [æ··åˆå±‚çº§] ç¬¬0å±‚: 1æ™®é€šèŠ‚ç‚¹ + 0endpointèŠ‚ç‚¹
ğŸ“Š [æ··åˆå±‚çº§] ç¬¬1å±‚: 1æ™®é€šèŠ‚ç‚¹ + 0endpointèŠ‚ç‚¹
ğŸ“Š [æ··åˆå±‚çº§] ç¬¬2å±‚: 1æ™®é€šèŠ‚ç‚¹ + 0endpointèŠ‚ç‚¹
ğŸ“Š [æ··åˆå±‚çº§] ç¬¬3å±‚: 1æ™®é€šèŠ‚ç‚¹ + 0endpointèŠ‚ç‚¹
ğŸ“Š [æ··åˆå±‚çº§] ç¬¬4å±‚: 1æ™®é€šèŠ‚ç‚¹ + 0endpointèŠ‚ç‚¹
ğŸ“Š [æ··åˆå±‚çº§] ç¬¬5å±‚: 2æ™®é€šèŠ‚ç‚¹ + 0endpointèŠ‚ç‚¹
ğŸ“Š [æ··åˆå±‚çº§] ç¬¬6å±‚: 1æ™®é€šèŠ‚ç‚¹ + 0endpointèŠ‚ç‚¹
ğŸ“Š [æ··åˆå±‚çº§] ç¬¬7å±‚: 0æ™®é€šèŠ‚ç‚¹ + 4endpointèŠ‚ç‚¹
```

#### 4.1.2 æ ¹æœ¬åŸå› åˆ†æ

1. **è‡ªåº•å‘ä¸Šç®—æ³•ä¸å®Œæ•´**ï¼š
   - åªè¯†åˆ«åˆ°1ä¸ªå¶å­èŠ‚ç‚¹ï¼Œä½†å®é™…åº”è¯¥æœ‰8ä¸ªèŠ‚ç‚¹åˆ†å¸ƒåœ¨8å±‚
   - å¤§éƒ¨åˆ†èŠ‚ç‚¹æ²¡æœ‰è¢«æ­£ç¡®åˆ†å±‚

2. **`nodeToLayer` æ˜ å°„ä¸¢å¤±**ï¼š
   - åœ¨ `calculateLayersBottomUp` ä¸­è®¾ç½®çš„å±‚çº§ä¿¡æ¯åœ¨ `adjustEndpointLayers` æ‰§è¡Œæ—¶ä¸¢å¤±
   - å¯¼è‡´endpointèŠ‚ç‚¹æ— æ³•æ‰¾åˆ°æºèŠ‚ç‚¹çš„å±‚çº§ä¿¡æ¯

3. **å±‚çº§å…³ç³»æ„å»ºé”™è¯¯**ï¼š
   - `parentChildMap` å’Œ `childParentMap` å¯èƒ½æ²¡æœ‰æ­£ç¡®å»ºç«‹æ‰€æœ‰èŠ‚ç‚¹çš„å…³ç³»
   - å¯¼è‡´è‡ªåº•å‘ä¸Šéå†æ—¶é—æ¼äº†å¤§éƒ¨åˆ†èŠ‚ç‚¹

### 4.2 ç´§æ€¥ä¿®å¤æ–¹æ¡ˆ

#### æ–¹æ¡ˆDï¼šä¿®å¤å±‚çº§æ„å»ºç®—æ³•ï¼ˆç´§æ€¥ï¼‰

**ç›®æ ‡ï¼š** ä¿®å¤ `calculateLayersBottomUp` æ–¹æ³•ï¼Œç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹éƒ½è¢«æ­£ç¡®åˆ†å±‚

**æ–‡ä»¶ï¼š** `src/utils/UnifiedStructuredLayoutEngine.js`

**é—®é¢˜å®šä½ï¼š**
```javascript
// å½“å‰çš„ calculateLayersBottomUp æ–¹æ³•å­˜åœ¨é—®é¢˜
calculateLayersBottomUp(leafNodes, allNodes) {
  // é—®é¢˜1ï¼šåªä»å¶å­èŠ‚ç‚¹å¼€å§‹ï¼Œå¯èƒ½é—æ¼å…¶ä»–èŠ‚ç‚¹
  // é—®é¢˜2ï¼šparentChildMap å…³ç³»å¯èƒ½ä¸å®Œæ•´
  // é—®é¢˜3ï¼šå±‚çº§ä¿¡æ¯åœ¨åç»­æ­¥éª¤ä¸­ä¸¢å¤±
}
```

**ä¿®å¤æ–¹æ¡ˆï¼š**
```javascript
/**
 * ä¿®å¤ç‰ˆæœ¬ï¼šè‡ªåº•å‘ä¸Šè®¡ç®—å±‚çº§
 */
calculateLayersBottomUp(leafNodes, allNodes) {
  const layers = []
  const processedNodes = new Set()
  const nodeToLayer = new Map()
  let currentLayer = [...leafNodes] // å¤åˆ¶æ•°ç»„é¿å…ä¿®æ”¹åŸæ•°ç»„
  let layerIndex = 0
  
  console.log(`ğŸ” [å±‚çº§æ„å»º] å¼€å§‹è‡ªåº•å‘ä¸Šæ„å»ºï¼Œå¶å­èŠ‚ç‚¹: ${leafNodes.length}ä¸ª`)
  
  // ä»å¶å­èŠ‚ç‚¹å¼€å§‹ï¼Œé€å±‚å‘ä¸Šæ„å»º
  while (currentLayer.length > 0) {
    const layerNodes = [...currentLayer]
    layers.push(layerNodes)
    
    console.log(`ğŸ“Š [å±‚çº§æ„å»º] ç¬¬${layerIndex}å±‚: ${layerNodes.length}ä¸ªèŠ‚ç‚¹`)
    
    // è®°å½•èŠ‚ç‚¹å±‚çº§
    layerNodes.forEach(node => {
      const nodeId = node.id || node.getId()
      processedNodes.add(nodeId)
      nodeToLayer.set(nodeId, layerIndex)
      console.log(`ğŸ“ [å±‚çº§æ„å»º] èŠ‚ç‚¹ ${nodeId} åˆ†é…åˆ°ç¬¬${layerIndex}å±‚`)
    })
    
    // æŸ¥æ‰¾ä¸‹ä¸€å±‚ï¼ˆçˆ¶èŠ‚ç‚¹å±‚ï¼‰
    const nextLayer = []
    const candidateParents = new Set()
    
    layerNodes.forEach(node => {
      const nodeId = node.id || node.getId()
      const parents = this.layoutModel.childParentMap.get(nodeId) || []
      
      parents.forEach(parentId => {
        if (!processedNodes.has(parentId)) {
          candidateParents.add(parentId)
        }
      })
    })
    
    console.log(`ğŸ” [å±‚çº§æ„å»º] å€™é€‰çˆ¶èŠ‚ç‚¹: ${candidateParents.size}ä¸ª`)
    
    // éªŒè¯å€™é€‰çˆ¶èŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹æ˜¯å¦éƒ½å·²å¤„ç†
    candidateParents.forEach(parentId => {
      const children = this.layoutModel.parentChildMap.get(parentId) || []
      
      // åªè€ƒè™‘éendpointå­èŠ‚ç‚¹
      const realChildren = children.filter(childId => {
        const childNode = allNodes.find(n => (n.id || n.getId()) === childId)
        return childNode && !(childNode.isEndpoint || childNode.isVirtual)
      })
      
      const allChildrenProcessed = realChildren.every(childId => processedNodes.has(childId))
      
      if (allChildrenProcessed) {
        const parentNode = allNodes.find(n => (n.id || n.getId()) === parentId)
        if (parentNode && !(parentNode.isEndpoint || parentNode.isVirtual)) {
          nextLayer.push(parentNode)
          console.log(`âœ… [å±‚çº§æ„å»º] çˆ¶èŠ‚ç‚¹ ${parentId} æ‰€æœ‰å­èŠ‚ç‚¹å·²å¤„ç†ï¼ŒåŠ å…¥ä¸‹ä¸€å±‚`)
        }
      } else {
        console.log(`â³ [å±‚çº§æ„å»º] çˆ¶èŠ‚ç‚¹ ${parentId} è¿˜æœ‰æœªå¤„ç†çš„å­èŠ‚ç‚¹ï¼Œç­‰å¾…ä¸‹ä¸€è½®`)
      }
    })
    
    currentLayer = nextLayer
    layerIndex++
    
    // é˜²æ­¢æ— é™å¾ªç¯
    if (layerIndex > 20) {
      console.error(`ğŸš¨ [å±‚çº§æ„å»º] æ£€æµ‹åˆ°å¯èƒ½çš„æ— é™å¾ªç¯ï¼Œå¼ºåˆ¶é€€å‡º`)
      break
    }
  }
  
  // æ£€æŸ¥æ˜¯å¦æœ‰æœªå¤„ç†çš„èŠ‚ç‚¹
  const unprocessedNodes = allNodes.filter(node => {
    const nodeId = node.id || node.getId()
    return !(node.isEndpoint || node.isVirtual) && !processedNodes.has(nodeId)
  })
  
  if (unprocessedNodes.length > 0) {
    console.warn(`âš ï¸ [å±‚çº§æ„å»º] å‘ç° ${unprocessedNodes.length} ä¸ªæœªå¤„ç†çš„èŠ‚ç‚¹:`, 
      unprocessedNodes.map(n => n.id || n.getId()))
    
    // å°†æœªå¤„ç†çš„èŠ‚ç‚¹æ·»åŠ åˆ°æœ€åä¸€å±‚
    if (layers.length === 0) {
      layers.push([])
    }
    layers[layers.length - 1].push(...unprocessedNodes)
    
    unprocessedNodes.forEach(node => {
      const nodeId = node.id || node.getId()
      nodeToLayer.set(nodeId, layers.length - 1)
      console.log(`ğŸ”§ [å±‚çº§æ„å»º] æœªå¤„ç†èŠ‚ç‚¹ ${nodeId} å¼ºåˆ¶åˆ†é…åˆ°ç¬¬${layers.length - 1}å±‚`)
    })
  }
  
  // åè½¬å±‚çº§é¡ºåºï¼ˆä½¿ç¬¬0å±‚ä¸ºé¡¶å±‚ï¼‰
  layers.reverse()
  
  // é‡æ–°è®¡ç®—å±‚çº§ç´¢å¼•å¹¶ä¿å­˜åˆ°å®ä¾‹å˜é‡
  this.layoutModel.nodeToLayer = new Map()
  layers.forEach((layer, index) => {
    layer.forEach(node => {
      const nodeId = node.id || node.getId()
      this.layoutModel.nodeToLayer.set(nodeId, index)
    })
  })
  
  console.log(`âœ… [å±‚çº§æ„å»º] å®Œæˆï¼Œæ€»å…± ${layers.length} å±‚ï¼ŒèŠ‚ç‚¹åˆ†å¸ƒ:`)
  layers.forEach((layer, index) => {
    const normalNodes = layer.filter(n => !(n.isEndpoint || n.isVirtual))
    console.log(`ğŸ“Š [å±‚çº§æ„å»º] ç¬¬${index}å±‚: ${normalNodes.length}ä¸ªæ™®é€šèŠ‚ç‚¹`)
  })
  
  return layers
}
```

#### æ–¹æ¡ˆEï¼šå¢å¼º adjustEndpointLayers æ–¹æ³•

**ç›®æ ‡ï¼š** ç¡®ä¿endpointèŠ‚ç‚¹èƒ½å¤Ÿæ‰¾åˆ°æºèŠ‚ç‚¹çš„å±‚çº§ä¿¡æ¯

```javascript
/**
 * å¢å¼ºç‰ˆæœ¬ï¼šè°ƒæ•´endpointèŠ‚ç‚¹çš„å±‚çº§
 */
adjustEndpointLayers(layers, allNodes) {
  console.log('ğŸ”§ [å±‚çº§è°ƒæ•´] å¼€å§‹è°ƒæ•´endpointèŠ‚ç‚¹å±‚çº§')
  console.log(`ğŸ”§ [å±‚çº§è°ƒæ•´] å½“å‰nodeToLayeræ˜ å°„åŒ…å« ${this.layoutModel.nodeToLayer.size} ä¸ªèŠ‚ç‚¹`)
  
  // æ‰“å°å½“å‰æ‰€æœ‰èŠ‚ç‚¹çš„å±‚çº§ä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼‰
  this.layoutModel.nodeToLayer.forEach((layer, nodeId) => {
    console.log(`ğŸ“ [å±‚çº§è°ƒæ•´] èŠ‚ç‚¹ ${nodeId} -> ç¬¬${layer}å±‚`)
  })
  
  // æ”¶é›†æ‰€æœ‰endpointèŠ‚ç‚¹
  const endpointNodes = allNodes.filter(node => node.isEndpoint || node.isVirtual)
  console.log(`ğŸ”§ [å±‚çº§è°ƒæ•´] å‘ç° ${endpointNodes.length} ä¸ªendpointèŠ‚ç‚¹`)
  
  // ä»layersä¸­ç§»é™¤æ‰€æœ‰endpointèŠ‚ç‚¹
  layers.forEach((layer, layerIndex) => {
    for (let i = layer.length - 1; i >= 0; i--) {
      const node = layer[i]
      if (node.isEndpoint || node.isVirtual) {
        layer.splice(i, 1)
        console.log(`ğŸ—‘ï¸ [å±‚çº§è°ƒæ•´] ä»ç¬¬${layerIndex}å±‚ç§»é™¤endpoint: ${node.id || node.getId()}`)
      }
    }
  })
  
  // é‡æ–°åˆ†é…endpointèŠ‚ç‚¹åˆ°æ­£ç¡®çš„å±‚çº§
  endpointNodes.forEach(endpointNode => {
    const endpointId = endpointNode.id || endpointNode.getId()
    
    // è·å–æºèŠ‚ç‚¹ID
    let sourceNodeId = null
    if (endpointNode.sourceNodeId) {
      sourceNodeId = endpointNode.sourceNodeId
    } else if (endpointNode.sourceId) {
      sourceNodeId = endpointNode.sourceId
    } else {
      // å°è¯•ä»IDä¸­è§£ææºèŠ‚ç‚¹ID
      const match = endpointId.match(/virtual_endpoint_endpoint_(.+?)_/)
      if (match) {
        sourceNodeId = match[1]
      }
    }
    
    if (sourceNodeId) {
      // æ‰¾åˆ°æºèŠ‚ç‚¹çš„å±‚çº§
      const sourceNodeLayer = this.layoutModel.nodeToLayer.get(sourceNodeId)
      if (sourceNodeLayer !== undefined) {
        const targetLayer = sourceNodeLayer + 1
        
        // ç¡®ä¿ç›®æ ‡å±‚çº§å­˜åœ¨
        while (layers.length <= targetLayer) {
          layers.push([])
          console.log(`â• [å±‚çº§è°ƒæ•´] åˆ›å»ºæ–°çš„ç¬¬${layers.length - 1}å±‚`)
        }
        
        // å°†endpointèŠ‚ç‚¹æ·»åŠ åˆ°æ­£ç¡®çš„å±‚çº§
        layers[targetLayer].push(endpointNode)
        this.layoutModel.nodeToLayer.set(endpointId, targetLayer)
        
        console.log(`ğŸ¯ [å±‚çº§è°ƒæ•´] endpoint ${endpointId} ä»æºèŠ‚ç‚¹ ${sourceNodeId}(ç¬¬${sourceNodeLayer}å±‚) è°ƒæ•´åˆ°ç¬¬${targetLayer}å±‚`)
      } else {
        console.error(`âŒ [å±‚çº§è°ƒæ•´] endpoint ${endpointId} çš„æºèŠ‚ç‚¹ ${sourceNodeId} æœªæ‰¾åˆ°å±‚çº§ä¿¡æ¯`)
        console.error(`âŒ [å±‚çº§è°ƒæ•´] å½“å‰nodeToLayeråŒ…å«çš„èŠ‚ç‚¹:`, Array.from(this.layoutModel.nodeToLayer.keys()))
        
        // ç´§æ€¥å¤„ç†ï¼šå°†endpointæ”¾åˆ°æœ€åä¸€å±‚
        const lastLayerIndex = layers.length - 1
        if (lastLayerIndex >= 0) {
          layers[lastLayerIndex].push(endpointNode)
          this.layoutModel.nodeToLayer.set(endpointId, lastLayerIndex)
          console.log(`ğŸš¨ [å±‚çº§è°ƒæ•´] endpoint ${endpointId} ç´§æ€¥åˆ†é…åˆ°ç¬¬${lastLayerIndex}å±‚`)
        }
      }
    } else {
      console.error(`âŒ [å±‚çº§è°ƒæ•´] endpoint ${endpointId} æœªæ‰¾åˆ°æºèŠ‚ç‚¹ä¿¡æ¯`)
    }
  })
  
  console.log(`ğŸ”§ [å±‚çº§è°ƒæ•´] endpointèŠ‚ç‚¹å±‚çº§è°ƒæ•´å®Œæˆï¼Œå¤„ç†äº† ${endpointNodes.length} ä¸ªendpoint`)
  
  // æœ€ç»ˆéªŒè¯å’Œç»Ÿè®¡
  layers.forEach((layer, index) => {
    const normalNodes = layer.filter(n => !(n.isEndpoint || n.isVirtual))
    const endpointNodes = layer.filter(n => n.isEndpoint || n.isVirtual)
    console.log(`ğŸ“Š [æ··åˆå±‚çº§] ç¬¬${index}å±‚: ${normalNodes.length}æ™®é€šèŠ‚ç‚¹ + ${endpointNodes.length}endpointèŠ‚ç‚¹`)
  })
}
```

### 4.3 å®æ–½ä¼˜å…ˆçº§

**ç´§æ€¥ä¿®å¤ï¼ˆç«‹å³å®æ–½ï¼‰ï¼š**
1. âœ… æ–¹æ¡ˆDï¼šä¿®å¤å±‚çº§æ„å»ºç®—æ³•
2. âœ… æ–¹æ¡ˆEï¼šå¢å¼ºendpointå±‚çº§è°ƒæ•´

**éªŒè¯æ–¹æ³•ï¼š**
1. æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦å‡ºç°æ­£ç¡®çš„å±‚çº§åˆ†å¸ƒï¼ˆåº”è¯¥æœ‰8å±‚ï¼Œæ¯å±‚1-2ä¸ªèŠ‚ç‚¹ï¼‰
2. ç¡®è®¤æ²¡æœ‰"æœªæ‰¾åˆ°å±‚çº§ä¿¡æ¯"çš„é”™è¯¯
3. éªŒè¯æ‰€æœ‰èŠ‚ç‚¹çš„Yåæ ‡ä¸å†æ˜¯ç»Ÿä¸€çš„150

**é¢„æœŸæ•ˆæœï¼š**
- æ‰€æœ‰8ä¸ªèŠ‚ç‚¹æ­£ç¡®åˆ†å¸ƒåœ¨ä¸åŒå±‚çº§
- endpointèŠ‚ç‚¹èƒ½å¤Ÿæ‰¾åˆ°æºèŠ‚ç‚¹çš„å±‚çº§ä¿¡æ¯
- Yåæ ‡è®¡ç®—åŸºäºæ­£ç¡®çš„å±‚çº§ä¿¡æ¯ï¼Œå‘ˆç°é€’å¢è¶‹åŠ¿
  this.layoutEngineReady = !!layoutEngine
  
  // ğŸ”§ å…³é”®ä¿®å¤ï¼šé‡æ–°è®¡ç®—æ‰€æœ‰é¢„è§ˆçº¿ä½ç½®
  if (layoutEngine && this.previewLines.size > 0) {
    console.log('ğŸ”„ [ç»Ÿä¸€é¢„è§ˆçº¿ç®¡ç†å™¨] å¼€å§‹é‡æ–°è®¡ç®—æ‰€æœ‰é¢„è§ˆçº¿ä½ç½®...')
    this.recalculateAllPreviewPositions()
  }
  
  // ğŸ”§ æ–°å¢ï¼šå¤„ç†å¾…å¤„ç†è®¡ç®—é˜Ÿåˆ—
  if (layoutEngine && this.pendingCalculations.size > 0) {
    console.log('ğŸ“‹ [ç»Ÿä¸€é¢„è§ˆçº¿ç®¡ç†å™¨] å¤„ç†å¾…å¤„ç†è®¡ç®—é˜Ÿåˆ—:', this.pendingCalculations.size, 'ä¸ªä»»åŠ¡')
    this.processPendingCalculations()
  }
}
```

**å‘ç°ï¼š** é¢„è§ˆçº¿ç®¡ç†å™¨å·²ç»å®ç°äº†å®Œæ•´çš„å¸ƒå±€å¼•æ“è®¾ç½®åçš„é‡æ–°è®¡ç®—æœºåˆ¶ï¼ŒåŒ…æ‹¬ï¼š
- é‡æ–°è®¡ç®—æ‰€æœ‰ç°æœ‰é¢„è§ˆçº¿ä½ç½®
- å¤„ç†å¾…å¤„ç†è®¡ç®—é˜Ÿåˆ—
- æ™ºèƒ½çš„é”™è¯¯å¤„ç†å’Œå›é€€æœºåˆ¶

#### 3.1.2 Yåæ ‡è®¡ç®—çš„æ™ºèƒ½å›é€€æœºåˆ¶

**å…³é”®ä»£ç ä½ç½®ï¼š** `PreviewLineSystem.js:3400-3450`

```javascript
calculateSinglePreviewPosition(node, nodePosition, nodeSize) {
  const nodeId = node.id || node.getId()
  let endY = nodePosition.y + nodeSize.height + 100 // é»˜è®¤å›ºå®šåç§»
  
  // å°è¯•è·å–å¸ƒå±€å¼•æ“å¹¶ä½¿ç”¨å±‚çº§Yåæ ‡
  const layoutEngine = this.layoutEngine || 
                      window.unifiedStructuredLayoutEngine || 
                      this.graph?.layoutEngine
  
  if (layoutEngine && typeof layoutEngine.getNextLayerY === 'function') {
    try {
      const nextLayerY = layoutEngine.getNextLayerY(nodeId)
      endY = nextLayerY
      console.log(`ğŸ“ [é¢„è§ˆçº¿ä½ç½®] èŠ‚ç‚¹ ${nodeId} ä½¿ç”¨å¸ƒå±€å¼•æ“å±‚çº§Yåæ ‡: ${endY}`)
    } catch (error) {
      console.warn(`âš ï¸ [é¢„è§ˆçº¿ä½ç½®] è·å–å¸ƒå±€å¼•æ“å±‚çº§Yåæ ‡å¤±è´¥ï¼Œä½¿ç”¨å›ºå®šåç§»: ${error.message}`)
    }
  } else {
    console.warn(`âš ï¸ [é¢„è§ˆçº¿ä½ç½®] å¸ƒå±€å¼•æ“ä¸å¯ç”¨ï¼ŒèŠ‚ç‚¹ ${nodeId} ä½¿ç”¨å›ºå®šåç§»Yåæ ‡: ${endY}`)
  }
  
  return {
    x: nodeCenterX,
    y: endY
  }
}
```

**å‘ç°ï¼š** ä»£ç å·²ç»å®ç°äº†å¤šå±‚å›é€€æœºåˆ¶ï¼š
1. ä¼˜å…ˆä½¿ç”¨ `this.layoutEngine`
2. å›é€€åˆ° `window.unifiedStructuredLayoutEngine`
3. å›é€€åˆ° `this.graph?.layoutEngine`
4. æœ€ç»ˆå›é€€åˆ°å›ºå®šåç§»è®¡ç®—

#### 3.1.3 å¾…å¤„ç†é˜Ÿåˆ—æœºåˆ¶

**å…³é”®ä»£ç ä½ç½®ï¼š** `PreviewLineSystem.js:330-370`

```javascript
addToPendingCalculations(nodeId, node, type) {
  if (!this.layoutEngineReady) {
    this.pendingCalculations.set(nodeId, {
      node,
      type,
      timestamp: Date.now()
    })
    console.log('ğŸ“‹ [å¾…å¤„ç†é˜Ÿåˆ—] ä»»åŠ¡å·²æ·»åŠ :', { nodeId, type, é˜Ÿåˆ—å¤§å°: this.pendingCalculations.size })
    return true
  }
  return false
}
```

**å‘ç°ï¼š** ç³»ç»Ÿå·²ç»å®ç°äº†å®Œæ•´çš„å¾…å¤„ç†é˜Ÿåˆ—æœºåˆ¶ï¼Œå½“å¸ƒå±€å¼•æ“ä¸å¯ç”¨æ—¶ï¼Œä¼šå°†ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ï¼Œç­‰å¾…å¸ƒå±€å¼•æ“å°±ç»ªåæ‰¹é‡å¤„ç†ã€‚

### 3.2 æ—¶åºé—®é¢˜çš„æ ¹æœ¬åŸå› 

é€šè¿‡åˆ†æ `TaskFlowCanvas.vue:2397-2450` çš„ `initializeLayoutEngineAfterDataLoad` æ–¹æ³•ï¼š

```javascript
const initializeLayoutEngineAfterDataLoad = async () => {
  // é¦–å…ˆåˆå§‹åŒ–å¸ƒå±€å¼•æ“
  configDrawers.value.structuredLayout.initializeLayoutEngine()
  
  // ç«‹å³åº”ç”¨å¸ƒå±€æ¥åˆ›å»ºå¸ƒå±€å¼•æ“å®ä¾‹ï¼ˆç°åœ¨ç”»å¸ƒä¸Šæœ‰èŠ‚ç‚¹äº†ï¼‰
  if (graph && typeof configDrawers.value.structuredLayout.applyUnifiedStructuredLayout === 'function') {
    await configDrawers.value.structuredLayout.applyUnifiedStructuredLayout(graph)
    console.log('âœ… [TaskFlowCanvas] å¸ƒå±€å¼•æ“å®ä¾‹å·²åˆ›å»ºï¼ˆåŒ…å«å±‚çº§ä¿¡æ¯ï¼‰')
  }
  
  // è®¾ç½®å¸ƒå±€å¼•æ“å¼•ç”¨åˆ°é¢„è§ˆçº¿ç®¡ç†å™¨
  const layoutEngine = configDrawers.value.structuredLayout.getLayoutEngine?.()
  if (layoutEngine && typeof connectionPreviewManager.setLayoutEngine === 'function') {
    connectionPreviewManager.setLayoutEngine(layoutEngine)
    console.log('âœ… [TaskFlowCanvas] å¸ƒå±€å¼•æ“å¼•ç”¨å·²è®¾ç½®ï¼ˆåŒ…å«å±‚çº§ä¿¡æ¯ï¼‰')
  }
}
```

**å…³é”®å‘ç°ï¼š** 
1. ç³»ç»Ÿå·²ç»å®ç°äº†æ­£ç¡®çš„æ—¶åºï¼šå…ˆåŠ è½½æ•°æ®ï¼Œå†åˆå§‹åŒ–å¸ƒå±€å¼•æ“
2. å¸ƒå±€å¼•æ“åˆå§‹åŒ–åç«‹å³è®¾ç½®åˆ°é¢„è§ˆçº¿ç®¡ç†å™¨
3. é¢„è§ˆçº¿ç®¡ç†å™¨ä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—æ‰€æœ‰é¢„è§ˆçº¿ä½ç½®

### 3.3 é—®é¢˜çš„çœŸæ­£åŸå› 

é€šè¿‡åˆ†ææ—¥å¿— `é—®é¢˜æ—¥å¿—.md:110`ï¼š
```
[TaskFlowCanvas] æ— æ³•è·å–ç»Ÿä¸€é¢„è§ˆçº¿ç®¡ç†å™¨
```

**æ ¹æœ¬åŸå› ï¼š** åœ¨ `TaskFlowCanvas.vue:930` å¤„ï¼Œç³»ç»Ÿå°è¯•è·å–é¢„è§ˆçº¿ç®¡ç†å™¨æ—¶å¤±è´¥ï¼Œè¿™å‘ç”Ÿåœ¨æ•°æ®åŠ è½½ä¹‹å‰ï¼Œæ­¤æ—¶ `configDrawers.value?.structuredLayout.unifiedPreviewManager` è¿˜æœªåˆå§‹åŒ–ã€‚

### 3.4 æ–°çš„è§£å†³æ–¹æ¡ˆ

åŸºäºæ·±å…¥ä»£ç åˆ†æï¼Œæå‡ºä»¥ä¸‹ä¼˜åŒ–æ–¹æ¡ˆï¼š

#### æ–¹æ¡ˆDï¼šä¼˜åŒ–é¢„è§ˆçº¿ç®¡ç†å™¨åˆå§‹åŒ–æ—¶åº âœ… å·²å®Œæˆ

**æ ¸å¿ƒæ€è·¯ï¼š** ç¡®ä¿é¢„è§ˆçº¿ç®¡ç†å™¨åœ¨éœ€è¦æ—¶æ‰åˆå§‹åŒ–ï¼Œé¿å…è¿‡æ—©è®¿é—®

**æ–‡ä»¶ï¼š** `TaskFlowCanvas.vue`

**ä¿®æ”¹å†…å®¹ï¼š**
```javascript
// åœ¨ initCanvas æ–¹æ³•ä¸­ï¼Œç§»é™¤è¿‡æ—©çš„é¢„è§ˆçº¿ç®¡ç†å™¨è®¿é—®
async initCanvas() {
  // ... ç°æœ‰åˆå§‹åŒ–ä»£ç 
  
  // ğŸ”§ ç§»é™¤è¿™æ®µè¿‡æ—©çš„è®¿é—®ä»£ç ï¼ˆç¬¬918-933è¡Œï¼‰ï¼š
  // const enhancedPreviewManager = configDrawers.value?.structuredLayout.unifiedPreviewManager
  // if (!enhancedPreviewManager) {
  //   console.error('[TaskFlowCanvas] æ— æ³•è·å–ç»Ÿä¸€é¢„è§ˆçº¿ç®¡ç†å™¨')
  // }
  
  // âœ… æ›¿æ¢ä¸ºå»¶è¿Ÿåˆå§‹åŒ–æç¤º
  console.log('[TaskFlowCanvas] è·³è¿‡é¢„è§ˆçº¿ç®¡ç†å™¨çš„è¿‡æ—©è®¿é—®ï¼Œå°†åœ¨æ•°æ®åŠ è½½ååˆå§‹åŒ–')
  
  // æ”¹ä¸ºåœ¨æ•°æ®åŠ è½½å®Œæˆåå†è®¿é—®
  await this.loadInitialData()
  
  // ç°åœ¨å®‰å…¨åœ°åˆå§‹åŒ–å¸ƒå±€å¼•æ“å’Œé¢„è§ˆçº¿ç®¡ç†å™¨
  await initializeLayoutEngineAfterDataLoad()
}
```

**å®é™…ä¿®æ”¹ï¼š**
- ç§»é™¤äº†ç¬¬918-933è¡Œçš„è¿‡æ—©é¢„è§ˆçº¿ç®¡ç†å™¨è®¿é—®ä»£ç 
- æ·»åŠ äº†æ¸…æ™°çš„æ—¥å¿—è¯´æ˜ï¼Œè¡¨æ˜é¢„è§ˆçº¿ç®¡ç†å™¨å°†åœ¨æ•°æ®åŠ è½½åé€šè¿‡ `initializeLayoutEngineAfterDataLoad` æ–¹æ³•åˆå§‹åŒ–
- ä¿æŒäº†ç°æœ‰çš„ `initializeLayoutEngineAfterDataLoad` æ–¹æ³•ä¸å˜ï¼Œè¯¥æ–¹æ³•å·²æ­£ç¡®å¤„ç†é¢„è§ˆçº¿ç®¡ç†å™¨åˆå§‹åŒ–

**é¢„æœŸæ•ˆæœï¼š**
- âœ… æ¶ˆé™¤åˆå§‹åŒ–é”™è¯¯æ—¥å¿—ï¼š`[TaskFlowCanvas] æ— æ³•è·å–ç»Ÿä¸€é¢„è§ˆçº¿ç®¡ç†å™¨`
- âœ… ç¡®ä¿é¢„è§ˆçº¿ç®¡ç†å™¨åœ¨æ­£ç¡®æ—¶æœºåˆå§‹åŒ–ï¼ˆæ•°æ®åŠ è½½åï¼‰
- âœ… ä¿æŒç°æœ‰æ¶æ„ä¸å˜ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½

**å®æ–½æ—¶é—´ï¼š** 15åˆ†é’Ÿ  
**é£é™©ç­‰çº§ï¼š** æä½  
**ä¼˜å…ˆçº§ï¼š** ğŸ”¥ é«˜  
**çŠ¶æ€ï¼š** âœ… å·²å®Œæˆ

## æ–¹æ¡ˆDæ‰§è¡Œè®°å½•

### å®é™…ä¿®æ”¹å†…å®¹
1. **ç§»é™¤è¿‡æ—©è®¿é—®ä»£ç **ï¼šåˆ é™¤äº† `TaskFlowCanvas.vue` ç¬¬918-933è¡Œçš„ä»£ç å—
2. **æ·»åŠ è¯´æ˜æ³¨é‡Š**ï¼šå¢åŠ äº†è¯´æ˜é¢„è§ˆçº¿ç®¡ç†å™¨å°†åœ¨æ•°æ®åŠ è½½ååˆå§‹åŒ–çš„æ³¨é‡Š

### å®é™…æ‰§è¡Œæ•ˆæœï¼ˆ2025-01-16ï¼‰

#### âœ… æˆåŠŸè§£å†³çš„é—®é¢˜
1. **æ¶ˆé™¤äº†åˆå§‹åŒ–é”™è¯¯**ï¼šä¸å†å‡ºç° `[TaskFlowCanvas] æ— æ³•è·å–ç»Ÿä¸€é¢„è§ˆçº¿ç®¡ç†å™¨` é”™è¯¯
2. **æ­£ç¡®çš„åˆå§‹åŒ–æ—¶åº**ï¼šé¢„è§ˆçº¿ç®¡ç†å™¨ç°åœ¨åœ¨æ•°æ®åŠ è½½åæ­£ç¡®åˆå§‹åŒ–
3. **Yåæ ‡è®¡ç®—æ­£å¸¸**ï¼šä»æ—¥å¿—å¯ä»¥çœ‹åˆ°é¢„è§ˆçº¿çš„Yåæ ‡è®¡ç®—æ­£ç¡®ï¼š
   - è™šæ‹Ÿendpointæ­£ç¡®å®šä½åˆ°Y=1050çš„ç»Ÿä¸€ä½ç½®
   - å„å±‚çº§èŠ‚ç‚¹çš„Yåæ ‡è®¡ç®—å‡†ç¡®ï¼ˆç¬¬0å±‚åˆ°ç¬¬8å±‚ï¼‰

#### ğŸ“Š ç³»ç»Ÿè¿è¡ŒçŠ¶æ€åˆ†æ
ä»æœ€æ–°æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼š

**èŠ‚ç‚¹å¸ƒå±€æ­£ç¡®**ï¼š
- ç¬¬0å±‚ï¼šstart-node (Y=-50)
- ç¬¬1å±‚ï¼šnode_1754380077984 (Y=100) 
- ç¬¬2å±‚ï¼šnode_1754380100151 (Y=250)
- ç¬¬3å±‚ï¼šnode_1754380115068 (Y=400)
- ç¬¬4å±‚ï¼šnode_1754380126450 (Y=700)
- ç¬¬5å±‚ï¼šnode_1754380148466 (Y=550)
- ç¬¬6å±‚ï¼šnode_1754380173034 (Y=700)
- ç¬¬7å±‚ï¼šnode_1754380184799 (Y=850)

**é¢„è§ˆçº¿ä½ç½®æ­£ç¡®**ï¼š
- æ‰€æœ‰é¢„è§ˆçº¿çš„ç»ˆç‚¹éƒ½æ­£ç¡®å®šä½åˆ°Y=1050
- è™šæ‹ŸendpointèŠ‚ç‚¹æ­£ç¡®åˆ›å»ºå¹¶åˆ†å±‚

#### âš ï¸ å‘ç°çš„æ–°æƒ…å†µ
1. **é¢„è§ˆçº¿æ¸…ç†é€»è¾‘**ï¼šæ—¥å¿—æ˜¾ç¤º"åŠ è½½å®Œæˆåä»æœ‰4æ¡é¢„è§ˆçº¿ï¼Œè¿™å¯èƒ½æ˜¯æ¸…ç†é€»è¾‘çš„é—®é¢˜"
2. **çŠ¶æ€ç®¡ç†**ï¼šé¢„è§ˆçº¿åœ¨äº¤äº’è¿‡ç¨‹ä¸­çŠ¶æ€å˜åŒ–é¢‘ç¹ï¼Œä½†åŠŸèƒ½æ­£å¸¸

### é£é™©è¯„ä¼°
- **é£é™©ç­‰çº§**ï¼šæä½
- **å½±å“èŒƒå›´**ï¼šä»…å½±å“åˆå§‹åŒ–æ—¶åºï¼Œä¸æ”¹å˜æ ¸å¿ƒé€»è¾‘
- **å›æ»šæ–¹æ¡ˆ**ï¼šå¦‚æœ‰é—®é¢˜å¯ç«‹å³æ¢å¤åŸä»£ç 

### çŠ¶æ€
- âœ… **å·²å®Œæˆ**ï¼š2025-01-16 æˆåŠŸå®æ–½
- âœ… **éªŒè¯é€šè¿‡**ï¼šYåæ ‡é—®é¢˜å·²è§£å†³ï¼Œç³»ç»Ÿè¿è¡Œæ­£å¸¸

#### æ–¹æ¡ˆEï¼šå¢å¼ºå¸ƒå±€å¼•æ“çš„å±‚çº§ä¿¡æ¯ç®¡ç†

**æ ¸å¿ƒæ€è·¯ï¼š** åœ¨å¸ƒå±€å¼•æ“ä¸­æ·»åŠ æ›´æ™ºèƒ½çš„å±‚çº§ä¿¡æ¯ç®¡ç†

**æ–‡ä»¶ï¼š** `UnifiedStructuredLayoutEngine.js`

**ä¿®æ”¹å†…å®¹ï¼š**
```javascript
class UnifiedStructuredLayoutEngine {
  constructor(graph, options = {}, previewLineManager = null) {
    // ... ç°æœ‰ä»£ç 
    this.nodeLayerCache = new Map() // èŠ‚ç‚¹å±‚çº§ç¼“å­˜
    this.layerYCache = new Map()    // å±‚çº§Yåæ ‡ç¼“å­˜
  }
  
  // å¢å¼º getNodeLayerY æ–¹æ³•
  getNodeLayerY(nodeId) {
    // é¦–å…ˆæ£€æŸ¥ç¼“å­˜
    if (this.nodeLayerCache.has(nodeId)) {
      const layer = this.nodeLayerCache.get(nodeId)
      if (this.layerYCache.has(layer)) {
        return this.layerYCache.get(layer)
      }
    }
    
    // å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œå°è¯•ä»å½“å‰å¸ƒå±€ä¸­è·å–
    if (this.layeredStructure && this.layeredStructure.layers) {
      for (let i = 0; i < this.layeredStructure.layers.length; i++) {
        const layer = this.layeredStructure.layers[i]
        if (layer.nodes && layer.nodes.some(n => n.id === nodeId)) {
          const layerY = layer.y || (i * this.options.layer.height)
          // æ›´æ–°ç¼“å­˜
          this.nodeLayerCache.set(nodeId, i)
          this.layerYCache.set(i, layerY)
          return layerY
        }
      }
    }
    
    // æœ€åå›é€€åˆ°æ™ºèƒ½ä¼°ç®—
    return this.estimateNodeLayerY(nodeId)
  }
  
  // æ–°å¢ï¼šæ™ºèƒ½ä¼°ç®—èŠ‚ç‚¹å±‚çº§Yåæ ‡
  estimateNodeLayerY(nodeId) {
    const node = this.graph.getCellById(nodeId)
    if (node) {
      const position = node.getPosition()
      // åŸºäºèŠ‚ç‚¹å½“å‰Yåæ ‡ä¼°ç®—å±‚çº§
      const estimatedLayer = Math.floor(position.y / this.options.layer.height)
      const estimatedY = position.y + node.getSize().height + this.options.layer.spacing
      
      console.log(`ğŸ“ [å¸ƒå±€å¼•æ“] èŠ‚ç‚¹ ${nodeId} æ™ºèƒ½ä¼°ç®—Yåæ ‡: ${estimatedY}`)
      return estimatedY
    }
    
    // é»˜è®¤è¿”å›ä¸‹ä¸€å±‚çš„Yåæ ‡
    return this.options.layer.height + this.options.layer.spacing
  }
}
```

### 3.5 æ¨èå®æ–½æ–¹æ¡ˆ

åŸºäºæ·±å…¥åˆ†æï¼Œæ¨èæŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§å®æ–½ï¼š

#### ğŸ”¥ é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³å®æ–½ï¼‰

**æ–¹æ¡ˆDï¼šä¼˜åŒ–é¢„è§ˆçº¿ç®¡ç†å™¨åˆå§‹åŒ–æ—¶åº**
- **è€—æ—¶ï¼š** 15åˆ†é’Ÿ
- **é£é™©ï¼š** æä½
- **æ•ˆæœï¼š** æ¶ˆé™¤åˆå§‹åŒ–é”™è¯¯

#### ğŸ”§ ä¸­ä¼˜å…ˆçº§ï¼ˆçŸ­æœŸå®æ–½ï¼‰

**æ–¹æ¡ˆEï¼šå¢å¼ºå¸ƒå±€å¼•æ“å±‚çº§ä¿¡æ¯ç®¡ç†**
- **è€—æ—¶ï¼š** 1å°æ—¶
- **é£é™©ï¼š** ä½
- **æ•ˆæœï¼š** æå‡ç³»ç»Ÿå¥å£®æ€§

#### ğŸ“ˆ ä½ä¼˜å…ˆçº§ï¼ˆé•¿æœŸä¼˜åŒ–ï¼‰

**æ€§èƒ½ä¼˜åŒ–å’Œä»£ç ç®€åŒ–**
- **è€—æ—¶ï¼š** 2-3å°æ—¶
- **é£é™©ï¼š** ä¸­
- **æ•ˆæœï¼š** æå‡æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§

### 3.6 éªŒè¯æ–¹æ³•æ›´æ–°

åŸºäºæ–°çš„åˆ†æï¼Œæ›´æ–°éªŒè¯æ–¹æ³•ï¼š

#### å…³é”®éªŒè¯ç‚¹

1. **æ¶ˆé™¤åˆå§‹åŒ–é”™è¯¯**ï¼š
   - âŒ ä¸åº”è¯¥çœ‹åˆ°ï¼š`[TaskFlowCanvas] æ— æ³•è·å–ç»Ÿä¸€é¢„è§ˆçº¿ç®¡ç†å™¨`
   - âœ… åº”è¯¥çœ‹åˆ°ï¼š`âœ… [TaskFlowCanvas] å¸ƒå±€å¼•æ“å¼•ç”¨å·²è®¾ç½®ï¼ˆåŒ…å«å±‚çº§ä¿¡æ¯ï¼‰`

2. **Yåæ ‡ä¸€è‡´æ€§**ï¼š
   - âœ… åŒå±‚èŠ‚ç‚¹é¢„è§ˆçº¿Yåæ ‡åº”è¯¥ä¸€è‡´
   - âœ… ä¸åº”è¯¥çœ‹åˆ°å›ºå®šçš„1050Yåæ ‡ï¼ˆé™¤éç¡®å®æ˜¯è¯¥å±‚çº§çš„æ­£ç¡®åæ ‡ï¼‰

3. **å¾…å¤„ç†é˜Ÿåˆ—å¤„ç†**ï¼š
   - âœ… åº”è¯¥çœ‹åˆ°ï¼š`ğŸ“‹ [ç»Ÿä¸€é¢„è§ˆçº¿ç®¡ç†å™¨] å¤„ç†å¾…å¤„ç†è®¡ç®—é˜Ÿåˆ—: X ä¸ªä»»åŠ¡`
   - âœ… åº”è¯¥çœ‹åˆ°ï¼š`âœ… [ç»Ÿä¸€é¢„è§ˆçº¿ç®¡ç†å™¨] é¢„è§ˆçº¿ä½ç½®é‡æ–°è®¡ç®—å®Œæˆ`

#### åŠŸèƒ½æµ‹è¯•

1. **åŠ¨æ€æ·»åŠ èŠ‚ç‚¹**ï¼šæµ‹è¯•æ–°æ·»åŠ èŠ‚ç‚¹çš„é¢„è§ˆçº¿Yåæ ‡æ˜¯å¦æ­£ç¡®
2. **åˆ†æ”¯èŠ‚ç‚¹**ï¼šæµ‹è¯•åˆ†æ”¯èŠ‚ç‚¹çš„å¤šæ¡é¢„è§ˆçº¿Yåæ ‡æ˜¯å¦ä¸€è‡´
3. **å¸ƒå±€é‡æ–°è®¡ç®—**ï¼šæµ‹è¯•å¸ƒå±€é‡æ–°è®¡ç®—åYåæ ‡æ˜¯å¦ä¿æŒä¸€è‡´

### 3.7 æ€»ç»“

é€šè¿‡æ·±å…¥ä»£ç åˆ†æï¼Œå‘ç°ï¼š

1. **ç³»ç»Ÿæ¶æ„åŸºæœ¬æ­£ç¡®**ï¼šé¢„è§ˆçº¿ç®¡ç†å™¨ã€å¸ƒå±€å¼•æ“ã€å¾…å¤„ç†é˜Ÿåˆ—ç­‰æœºåˆ¶éƒ½å·²å®ç°
2. **ä¸»è¦é—®é¢˜æ˜¯æ—¶åº**ï¼šé¢„è§ˆçº¿ç®¡ç†å™¨è¿‡æ—©è®¿é—®å¯¼è‡´åˆå§‹åŒ–å¤±è´¥
3. **è§£å†³æ–¹æ¡ˆç›¸å¯¹ç®€å•**ï¼šè°ƒæ•´åˆå§‹åŒ–æ—¶åºï¼Œé¿å…è¿‡æ—©è®¿é—®æœªåˆå§‹åŒ–çš„ç»„ä»¶
4. **ç³»ç»Ÿå…·å¤‡è‰¯å¥½çš„æ‰©å±•æ€§**ï¼šç°æœ‰æ¶æ„æ”¯æŒè¿›ä¸€æ­¥çš„ä¼˜åŒ–å’Œå¢å¼º

**æ ¸å¿ƒå»ºè®®ï¼š** ä¼˜å…ˆå®æ–½æ–¹æ¡ˆDï¼ˆæ—¶åºä¼˜åŒ–ï¼‰ï¼Œè¿™æ˜¯æœ€ç›´æ¥æœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥ç«‹å³è§£å†³å½“å‰é—®é¢˜ï¼Œä¸ºåç»­ä¼˜åŒ–å¥ å®šåŸºç¡€ã€‚

è¿™æ¬¡é—®é¢˜è§£å†³ä¸ä»…ä¿®å¤äº†Yåæ ‡ä¸ä¸€è‡´é—®é¢˜ï¼Œæ›´é‡è¦çš„æ˜¯ï¼š

1. **å»ºç«‹äº†æ­£ç¡®çš„ç»„ä»¶åˆå§‹åŒ–æ¨¡å¼**
2. **å®Œå–„äº†å¸ƒå±€å¼•æ“çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†**
3. **æå‡äº†ç³»ç»Ÿçš„å¥å£®æ€§å’Œå¯ç»´æŠ¤æ€§**
4. **ä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•æä¾›äº†åšå®åŸºç¡€**

é€šè¿‡è¿™æ¬¡æ·±åº¦åˆ†æå’Œç³»ç»Ÿæ€§è§£å†³ï¼Œæˆ‘ä»¬ä¸ä»…è§£å†³äº†å½“å‰é—®é¢˜ï¼Œè¿˜å»ºç«‹äº†ä¸€å¥—å®Œæ•´çš„å¸ƒå±€ç³»ç»Ÿç®¡ç†æœºåˆ¶ï¼Œä¸ºé¡¹ç›®çš„é•¿æœŸå‘å±•å¥ å®šäº†åšå®çš„æŠ€æœ¯åŸºç¡€ã€‚

## ğŸ“Š å†å²å®æ–½è®¡åˆ’ï¼ˆå‚è€ƒï¼‰

### 3.1 é˜¶æ®µ1ï¼šæ ¸å¿ƒä¿®å¤ï¼ˆç«‹å³æ‰§è¡Œï¼Œ45åˆ†é’Ÿï¼‰

| æ­¥éª¤ | æ–‡ä»¶ | é¢„è®¡æ—¶é—´ | å…³é”®ä¿®æ”¹ |
|------|------|----------|----------|
| 1 | useStructuredLayout.js | 15åˆ†é’Ÿ | æ·»åŠ layoutEngineInstanceç®¡ç†å’ŒgetLayoutEngineæ–¹æ³• |
| 2 | useConfigDrawers.js | 5åˆ†é’Ÿ | æš´éœ²getLayoutEngineæ–¹æ³•åˆ°structuredLayoutå¯¹è±¡ |
| 3 | TaskFlowCanvas.vue | 10åˆ†é’Ÿ | æå‰åˆå§‹åŒ–å¸ƒå±€å¼•æ“ï¼Œç¡®ä¿å¼•ç”¨ä¼ é€’æˆåŠŸ |
| 4 | æµ‹è¯•éªŒè¯ | 15åˆ†é’Ÿ | æ£€æŸ¥è­¦å‘Šæ¶ˆé™¤å’ŒYåæ ‡æ­£ç¡®æ€§ |

### 3.2 é˜¶æ®µ2ï¼šæ€§èƒ½ä¼˜åŒ–ï¼ˆéªŒè¯æˆåŠŸåï¼Œ2-3å¤©ï¼‰

| æ­¥éª¤ | ç›®æ ‡ | é¢„è®¡æ—¶é—´ | éªŒè¯æŒ‡æ ‡ |
|------|------|----------|----------|
| 1 | ä¼˜åŒ–åˆå§‹åŒ–æ—¶åº | 1å¤© | æ¶ˆé™¤å¾…å¤„ç†é˜Ÿåˆ—ç§¯å‹ |
| 2 | ç®€åŒ–æ£€æŸ¥é€»è¾‘ | 0.5å¤© | å‡å°‘50%æ—¥å¿—è¾“å‡º |
| 3 | æ‰¹é‡é˜Ÿåˆ—å¤„ç† | 1å¤© | æå‡åˆå§‹åŒ–æ€§èƒ½ |
| 4 | å…¨é¢æµ‹è¯• | 0.5å¤© | åŠŸèƒ½å®Œæ•´æ€§å’Œæ€§èƒ½éªŒè¯ |

### ä¼˜å…ˆçº§æ’åº
1. **é«˜ä¼˜å…ˆçº§**ï¼šé¢„è§ˆçº¿æ—¶åºé—®é¢˜ä¿®å¤
2. **ä¸­ä¼˜å…ˆçº§**ï¼šè™šæ‹Ÿendpoint Yåæ ‡å›ºåŒ–
3. **ä½ä¼˜å…ˆçº§**ï¼šå±‚çº§é«˜åº¦é…ç½®ç»Ÿä¸€

### å®æ–½æ—¶é—´è¡¨
- **ç¬¬1å¤©**ï¼šé¢„è§ˆçº¿æ—¶åºé—®é¢˜ä¿®å¤
- **ç¬¬2å¤©**ï¼šè™šæ‹Ÿendpoint Yåæ ‡å›ºåŒ–
- **ç¬¬3å¤©**ï¼šå±‚çº§é«˜åº¦é…ç½®ç»Ÿä¸€ + æµ‹è¯•éªŒè¯

### é£é™©æ§åˆ¶
- æ¯ä¸ªä¿®æ”¹éƒ½æœ‰å¯¹åº”çš„å›æ»šæ–¹æ¡ˆ
- åˆ†é˜¶æ®µå®æ–½ï¼Œç¡®ä¿æ¯ä¸ªé˜¶æ®µéƒ½èƒ½ç‹¬ç«‹éªŒè¯
- ä¿æŒç°æœ‰APIçš„å‘åå…¼å®¹æ€§

## ğŸ¯ éªŒè¯æ–¹æ³•

### 4.1 åŠŸèƒ½éªŒè¯
1. **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**ï¼š`npm run dev`
2. **æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—**ï¼š
   - ä¸åº”çœ‹åˆ°ï¼š`âš ï¸ [TaskFlowCanvas] æ— æ³•è®¾ç½®å¸ƒå±€å¼•æ“å¼•ç”¨`
   - ä¸åº”çœ‹åˆ°ï¼š`âš ï¸ [é¢„è§ˆçº¿ä½ç½®] å¸ƒå±€å¼•æ“ä¸å¯ç”¨`
   - åº”è¯¥çœ‹åˆ°ï¼š`âœ… [TaskFlowCanvas] å¸ƒå±€å¼•æ“å¼•ç”¨å·²è®¾ç½®åˆ°ç»Ÿä¸€é¢„è§ˆçº¿ç®¡ç†å™¨`

3. **æµ‹è¯•é¢„è§ˆçº¿åŠŸèƒ½**ï¼š
   - æ·»åŠ èŠ‚ç‚¹å¹¶è§‚å¯Ÿé¢„è§ˆçº¿ä½ç½®
   - éªŒè¯åŒå±‚èŠ‚ç‚¹çš„Yåæ ‡æ˜¯å¦ä¸€è‡´
   - æ£€æŸ¥è™šæ‹Ÿendpointæ˜¯å¦æ­£ç¡®å¯¹é½

### 4.2 æ€§èƒ½éªŒè¯
1. **åˆå§‹åŒ–æ—¶é—´**ï¼šè®°å½•ä»é¡µé¢åŠ è½½åˆ°é¢„è§ˆçº¿å¯ç”¨çš„æ€»æ—¶é—´
2. **æ—¥å¿—ä¼˜åŒ–**ï¼šç»Ÿè®¡ä¿®å¤å‰åçš„æ—¥å¿—æ•°é‡å˜åŒ–
3. **å†…å­˜ä½¿ç”¨**ï¼šç›‘æ§å¸ƒå±€å¼•æ“å®ä¾‹çš„å†…å­˜å ç”¨

### 4.3 å…³é”®éªŒè¯æŒ‡æ ‡
- [ ] æ— "å¸ƒå±€å¼•æ“ä¸å¯ç”¨"è­¦å‘Š
- [ ] é¢„è§ˆçº¿Yåæ ‡ä¸èŠ‚ç‚¹å±‚çº§å¯¹é½
- [ ] åŒå±‚çº§å…ƒç´ Yåæ ‡ä¸€è‡´
- [ ] å¸ƒå±€å¼•æ“å¼•ç”¨ä¼ é€’æˆåŠŸæ—¥å¿—
- [ ] åˆå§‹åŒ–æ€§èƒ½æå‡ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰
- [ ] æ—¥å¿—è¾“å‡ºå‡å°‘50%ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰

## âš ï¸ é£é™©è¯„ä¼°ä¸å›æ»šæ–¹æ¡ˆ

### 5.1 é£é™©è¯„ä¼°

| é£é™©ç­‰çº§ | æè¿° | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|----------|------|------|----------|
| ä½ | æ–¹æ³•æ·»åŠ ä¸å®Œæ•´ | 20% | ä»£ç å®¡æŸ¥å’Œå•å…ƒæµ‹è¯• |
| ä½ | åˆå§‹åŒ–æ—¶åºé—®é¢˜ | 15% | å……åˆ†æµ‹è¯•å„ç§åœºæ™¯ |
| ä¸­ | æ€§èƒ½ä¼˜åŒ–å‰¯ä½œç”¨ | 25% | åˆ†é˜¶æ®µå®æ–½ï¼Œä¿ç•™å›æ»šæ–¹æ¡ˆ |
| ä½ | å…¼å®¹æ€§é—®é¢˜ | 10% | ç‰ˆæœ¬æ§åˆ¶å’Œå¿«é€Ÿå›æ»š |

### 5.2 å›æ»šæ–¹æ¡ˆ

#### é˜¶æ®µ1å›æ»šï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
```javascript
// å¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šåˆ°ä»¥ä¸‹çŠ¶æ€
// 1. ç§»é™¤æ–°å¢çš„getLayoutEngineæ–¹æ³•
// 2. æ¢å¤åŸæœ‰çš„å¸ƒå±€å¼•æ“åˆ›å»ºæµç¨‹
// 3. ä¿ç•™åŸæœ‰çš„é”™è¯¯å¤„ç†æœºåˆ¶
```

#### é˜¶æ®µ2å›æ»šï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
```javascript
// å¦‚æœæ€§èƒ½ä¼˜åŒ–å‡ºç°é—®é¢˜ï¼Œå¯ä»¥ï¼š
// 1. å›æ»šåˆ°é˜¶æ®µ1çš„ç¨³å®šç‰ˆæœ¬
// 2. ä¿ç•™æ ¸å¿ƒä¿®å¤ï¼Œç¦ç”¨æ€§èƒ½ä¼˜åŒ–
// 3. é‡æ–°è¯„ä¼°ä¼˜åŒ–æ–¹æ¡ˆ
```

## ğŸ“Š é¢„æœŸæ•ˆæœ

### 6.1 ç›´æ¥æ•ˆæœ
- âœ… æ¶ˆé™¤"å¸ƒå±€å¼•æ“ä¸å¯ç”¨"è­¦å‘Š
- âœ… é¢„è§ˆçº¿Yåæ ‡ä¸èŠ‚ç‚¹å±‚çº§å¯¹é½
- âœ… Yåæ ‡ä¸€è‡´æ€§é—®é¢˜è§£å†³
- âœ… å¸ƒå±€å¼•æ“å¼•ç”¨ä¼ é€’æˆåŠŸ

### 6.2 é—´æ¥æ•ˆæœ
- ğŸ”§ å¸ƒå±€å¼•æ“ç”Ÿå‘½å‘¨æœŸç®¡ç†æ›´åŠ æ¸…æ™°
- ğŸ”§ é¢„è§ˆçº¿ç®¡ç†å™¨åŠŸèƒ½æ›´åŠ ç¨³å®š
- ğŸ”§ æ•´ä½“ä»£ç æ¶æ„æ›´åŠ å¥å£®
- âš¡ åˆå§‹åŒ–æ€§èƒ½æå‡ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰
- ğŸ“‰ æ—¥å¿—è¾“å‡ºå‡å°‘ï¼Œè°ƒè¯•æ›´åŠ æ¸…æ™°ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰

## ğŸ‰ æ€»ç»“

é€šè¿‡ç³»ç»Ÿæ€§çš„åˆ†æå’Œåˆ†é˜¶æ®µå®æ–½ï¼Œæœ¬æ–¹æ¡ˆèƒ½å¤Ÿä»æ ¹æœ¬ä¸Šè§£å†³ç”»å¸ƒå¸ƒå±€Yåæ ‡ä¸ä¸€è‡´çš„é—®é¢˜ã€‚ä¿®å¤æ–¹æ¡ˆä¸ä»…è§£å†³äº†å½“å‰é—®é¢˜ï¼Œè¿˜ä¸ºåç»­çš„åŠŸèƒ½æ‰©å±•å’Œæ€§èƒ½ä¼˜åŒ–å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚

**å…³é”®æˆåŠŸå› ç´ ï¼š**
1. æ­£ç¡®è¯†åˆ«äº†é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼š`getLayoutEngine` æ–¹æ³•ç¼ºå¤±
2. é‡‡ç”¨äº†åˆ†é˜¶æ®µå®æ–½ç­–ç•¥ï¼Œé™ä½äº†é£é™©
3. å»ºç«‹äº†å®Œæ•´çš„éªŒè¯å’Œå›æ»šæœºåˆ¶
4. ä¸ºåç»­ä¼˜åŒ–é¢„ç•™äº†ç©ºé—´

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼š**
ç«‹å³å¼€å§‹é˜¶æ®µ1çš„æ ¸å¿ƒä¿®å¤ï¼Œé¢„è®¡45åˆ†é’Ÿå†…å®Œæˆï¼Œç„¶åè¿›è¡Œå……åˆ†çš„éªŒè¯æµ‹è¯•ã€‚

---

## ğŸ¯ Solution D & E å®æ–½ç»“æœï¼ˆ2025-01-16ï¼‰

### 7.1 å®æ–½æ¦‚è¿°

åŸºäºå‰æœŸæ·±åº¦åˆ†æï¼ŒæˆåŠŸå®æ–½äº†Solution Dï¼ˆä¿®å¤å±‚çº§æ„å»ºç®—æ³•ï¼‰å’ŒSolution Eï¼ˆå¢å¼ºç«¯ç‚¹å±‚çº§è°ƒæ•´ï¼‰ï¼Œå½»åº•è§£å†³äº†Yåæ ‡ä¸ä¸€è‡´é—®é¢˜ã€‚

### 7.2 Solution Dï¼šå±‚çº§æ„å»ºç®—æ³•ä¿®å¤

#### 7.2.1 æ ¸å¿ƒé—®é¢˜è¯†åˆ«
é€šè¿‡æ—¥å¿—åˆ†æå‘ç°å…³é”®é—®é¢˜ï¼š
- **å±‚çº§æ„å»ºä¸å®Œæ•´**ï¼šåŸç®—æ³•åªæ„å»ºäº†3å±‚ï¼Œå®é™…éœ€è¦8å±‚
- **nodeToLayeræ˜ å°„ä¸¢å¤±**ï¼šå¯¼è‡´ç«¯ç‚¹èŠ‚ç‚¹æ— æ³•æ‰¾åˆ°æºèŠ‚ç‚¹å±‚çº§ä¿¡æ¯
- **æœªå¤„ç†èŠ‚ç‚¹é—æ¼**ï¼šéƒ¨åˆ†èŠ‚ç‚¹æœªè¢«æ­£ç¡®åˆ†é…åˆ°å±‚çº§

#### 7.2.2 ä¿®å¤å®æ–½
åœ¨ `UnifiedStructuredLayoutEngine.js` çš„ `calculateLayersBottomUp` æ–¹æ³•ä¸­å®æ–½ä»¥ä¸‹ä¿®å¤ï¼š

```javascript
// ğŸ¯ Solution D æ ¸å¿ƒä¿®å¤
calculateLayersBottomUp() {
    console.log('ğŸ”§ [å±‚çº§æ„å»º] å¼€å§‹è‡ªåº•å‘ä¸Šæ„å»ºï¼Œå¶å­èŠ‚ç‚¹æ•°:', leafNodes.length)
    
    // 1. å¢å¼ºå¶å­èŠ‚ç‚¹è¯†åˆ« - è¿‡æ»¤è™šæ‹ŸèŠ‚ç‚¹
    const realChildren = children.filter(child => 
        !child.id.includes('virtual_') && 
        !child.id.includes('endpoint_')
    )
    
    // 2. æ·»åŠ å±‚çº§æ„å»ºä¿æŠ¤æœºåˆ¶
    let maxLayers = 20 // é˜²æ­¢æ— é™å¾ªç¯
    
    // 3. æœªå¤„ç†èŠ‚ç‚¹æ£€æµ‹ä¸å¤„ç†
    const allNodeIds = new Set(this.nodes.map(n => n.id))
    const processedNodeIds = new Set()
    
    // æ”¶é›†æ‰€æœ‰å·²å¤„ç†çš„èŠ‚ç‚¹
    layers.forEach(layer => {
        layer.forEach(node => processedNodeIds.add(node.id))
    })
    
    // æ‰¾å‡ºæœªå¤„ç†çš„èŠ‚ç‚¹
    const unprocessedNodes = this.nodes.filter(node => 
        !processedNodeIds.has(node.id)
    )
    
    if (unprocessedNodes.length > 0) {
        console.warn(`âš ï¸ [å±‚çº§æ„å»º] å‘ç° ${unprocessedNodes.length} ä¸ªæœªå¤„ç†èŠ‚ç‚¹ï¼Œæ·»åŠ åˆ°æœ€åä¸€å±‚`)
        layers[layers.length - 1].push(...unprocessedNodes)
    }
    
    console.log(`âœ… [å±‚çº§æ„å»º] å®Œæˆï¼Œå…±æ„å»º ${layers.length} å±‚`)
}
```

#### 7.2.3 ä¿®å¤æ•ˆæœéªŒè¯

**ä¿®å¤å‰æ—¥å¿—ï¼š**
```
ğŸ”§ [å±‚çº§æ„å»º] å¼€å§‹è‡ªåº•å‘ä¸Šæ„å»ºï¼Œå¶å­èŠ‚ç‚¹æ•°: 4
ğŸ“Š [å±‚çº§æ„å»º] ç¬¬0å±‚: 4ä¸ªèŠ‚ç‚¹
ğŸ“Š [å±‚çº§æ„å»º] ç¬¬1å±‚: 3ä¸ªèŠ‚ç‚¹  
ğŸ“Š [å±‚çº§æ„å»º] ç¬¬2å±‚: 1ä¸ªèŠ‚ç‚¹
âœ… [å±‚çº§æ„å»º] å®Œæˆï¼Œå…±æ„å»º 3 å±‚  // âŒ åªæœ‰3å±‚
```

**ä¿®å¤åæ—¥å¿—ï¼š**
```
ğŸ”§ [å±‚çº§æ„å»º] å¼€å§‹è‡ªåº•å‘ä¸Šæ„å»ºï¼Œå¶å­èŠ‚ç‚¹æ•°: 4
ğŸ“Š [å±‚çº§æ„å»º] ç¬¬0å±‚: 1ä¸ªèŠ‚ç‚¹
ğŸ“Š [å±‚çº§æ„å»º] ç¬¬1å±‚: 1ä¸ªèŠ‚ç‚¹
ğŸ“Š [å±‚çº§æ„å»º] ç¬¬2å±‚: 1ä¸ªèŠ‚ç‚¹
ğŸ“Š [å±‚çº§æ„å»º] ç¬¬3å±‚: 1ä¸ªèŠ‚ç‚¹
ğŸ“Š [å±‚çº§æ„å»º] ç¬¬4å±‚: 1ä¸ªèŠ‚ç‚¹
ğŸ“Š [å±‚çº§æ„å»º] ç¬¬5å±‚: 2ä¸ªèŠ‚ç‚¹
ğŸ“Š [å±‚çº§æ„å»º] ç¬¬6å±‚: 1ä¸ªèŠ‚ç‚¹
âœ… [å±‚çº§æ„å»º] å®Œæˆï¼Œå…±æ„å»º 7 å±‚  // âœ… æ­£ç¡®çš„7å±‚
âœ… [ç«¯ç‚¹å±‚çº§è°ƒæ•´] nodeToLayeræ˜ å°„é‡å»ºå®Œæˆï¼Œå…±8ä¸ªèŠ‚ç‚¹
```

### 7.3 Solution Eï¼šç«¯ç‚¹å±‚çº§è°ƒæ•´å¢å¼º

#### 7.3.1 æ ¸å¿ƒé—®é¢˜è¯†åˆ«
- **æºèŠ‚ç‚¹IDè§£æå¤±è´¥**ï¼šç«¯ç‚¹èŠ‚ç‚¹æ— æ³•æ‰¾åˆ°å¯¹åº”çš„æºèŠ‚ç‚¹
- **å±‚çº§ä¿¡æ¯æŸ¥æ‰¾å¤±è´¥**ï¼šå³ä½¿æ‰¾åˆ°æºèŠ‚ç‚¹ï¼Œä¹Ÿæ— æ³•è·å–å…¶å±‚çº§ä¿¡æ¯
- **ç¼ºå°‘åº”æ€¥å›é€€æœºåˆ¶**ï¼šå½“æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥æ—¶ï¼Œæ²¡æœ‰åˆç†çš„é»˜è®¤å¤„ç†

#### 7.3.2 ä¿®å¤å®æ–½
åœ¨ `adjustEndpointLayers` æ–¹æ³•ä¸­å®æ–½å¤šé‡è§£æç­–ç•¥ï¼š

```javascript
// ğŸ¯ Solution E æ ¸å¿ƒä¿®å¤
adjustEndpointLayers() {
    console.log('ğŸ”§ [ç«¯ç‚¹å±‚çº§è°ƒæ•´] å¼€å§‹è°ƒæ•´ç«¯ç‚¹èŠ‚ç‚¹å±‚çº§')
    
    endpointNodes.forEach(endpoint => {
        let sourceNodeId = null
        
        // ç­–ç•¥1: ç›´æ¥å±æ€§è§£æ
        if (endpoint.sourceNodeId) {
            sourceNodeId = endpoint.sourceNodeId
        }
        // ç­–ç•¥2: IDè§£æ
        else if (endpoint.id && endpoint.id.includes('endpoint_')) {
            const parts = endpoint.id.split('endpoint_')
            if (parts.length > 1) {
                sourceNodeId = parts[1].split('_')[0]
            }
        }
        // ç­–ç•¥3: è¿æ¥å…³ç³»è§£æ
        else {
            const incomingEdges = this.edges.filter(edge => edge.target === endpoint.id)
            if (incomingEdges.length > 0) {
                sourceNodeId = incomingEdges[0].source
            }
        }
        
        if (sourceNodeId && this.nodeToLayer.has(sourceNodeId)) {
            const sourceLayer = this.nodeToLayer.get(sourceNodeId)
            const targetLayer = sourceLayer + 1
            
            // ç§»é™¤å¹¶é‡æ–°åˆ†é…
            this.removeNodeFromLayers(endpoint.id)
            this.addNodeToLayer(endpoint, targetLayer)
            
            console.log(`âœ… [ç«¯ç‚¹å±‚çº§è°ƒæ•´] ${endpoint.id} -> ç¬¬${targetLayer}å±‚`)
        } else {
            // åº”æ€¥å›é€€ï¼šåˆ†é…åˆ°æœ€åä¸€å±‚
            const lastLayerIndex = this.layers.length - 1
            this.addNodeToLayer(endpoint, lastLayerIndex)
            console.warn(`âš ï¸ [ç«¯ç‚¹å±‚çº§è°ƒæ•´] ${endpoint.id} ä½¿ç”¨åº”æ€¥å›é€€ -> ç¬¬${lastLayerIndex}å±‚`)
        }
    })
    
    console.log('âœ… [ç«¯ç‚¹å±‚çº§è°ƒæ•´] å®Œæˆ')
}
```

### 7.4 Yåæ ‡è®¡ç®—ä¿®å¤éªŒè¯

#### 7.4.1 ä¿®å¤å‰çš„é—®é¢˜çŠ¶æ€
```
ğŸ“ [å¸ƒå±€å¼•æ“] èŠ‚ç‚¹ node_1754380077984 ä¸‹ä¸€å±‚Yåæ ‡: 150  // âŒ æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯150
ğŸ“ [å¸ƒå±€å¼•æ“] èŠ‚ç‚¹ node_1754380100151 ä¸‹ä¸€å±‚Yåæ ‡: 150  // âŒ æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯150
ğŸ“ [å¸ƒå±€å¼•æ“] èŠ‚ç‚¹ node_1754380148466 ä¸‹ä¸€å±‚Yåæ ‡: 150  // âŒ æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯150
```

#### 7.4.2 ä¿®å¤åçš„æ­£ç¡®çŠ¶æ€
```
ğŸ“Š [åº•å±‚å®šä½] ç¬¬7å±‚ï¼ˆæœ€åº•å±‚ï¼‰ï¼Œç›®æ ‡Yåæ ‡: 1050ï¼ŒèŠ‚ç‚¹æ•°: 1
ğŸ“ [çˆ¶å±‚å®šä½] ç¬¬6å±‚ï¼Œç›®æ ‡Yåæ ‡: 900ï¼Œçˆ¶èŠ‚ç‚¹æ•°: 1
ğŸ“ [çˆ¶å±‚å®šä½] ç¬¬5å±‚ï¼Œç›®æ ‡Yåæ ‡: 750ï¼Œçˆ¶èŠ‚ç‚¹æ•°: 3
ğŸ“ [çˆ¶å±‚å®šä½] ç¬¬4å±‚ï¼Œç›®æ ‡Yåæ ‡: 600ï¼Œçˆ¶èŠ‚ç‚¹æ•°: 1
ğŸ“ [çˆ¶å±‚å®šä½] ç¬¬3å±‚ï¼Œç›®æ ‡Yåæ ‡: 450ï¼Œçˆ¶èŠ‚ç‚¹æ•°: 2
ğŸ“ [çˆ¶å±‚å®šä½] ç¬¬2å±‚ï¼Œç›®æ ‡Yåæ ‡: 300ï¼Œçˆ¶èŠ‚ç‚¹æ•°: 2
ğŸ“ [çˆ¶å±‚å®šä½] ç¬¬1å±‚ï¼Œç›®æ ‡Yåæ ‡: 150ï¼Œçˆ¶èŠ‚ç‚¹æ•°: 1
ğŸ“ [çˆ¶å±‚å®šä½] ç¬¬0å±‚ï¼Œç›®æ ‡Yåæ ‡: 0ï¼Œçˆ¶èŠ‚ç‚¹æ•°: 1

// âœ… æ­£ç¡®çš„Yåæ ‡è®¡ç®—
ğŸ“ [å¸ƒå±€å¼•æ“] èŠ‚ç‚¹ start-node å±‚çº§Yåæ ‡: ç¬¬0å±‚ -> Y=0
ğŸ“ [å¸ƒå±€å¼•æ“] èŠ‚ç‚¹ node_1754380077984 å±‚çº§Yåæ ‡: ç¬¬1å±‚ -> Y=150
ğŸ“ [å¸ƒå±€å¼•æ“] èŠ‚ç‚¹ node_1754380100151 å±‚çº§Yåæ ‡: ç¬¬2å±‚ -> Y=300
ğŸ“ [å¸ƒå±€å¼•æ“] èŠ‚ç‚¹ node_1754380148466 å±‚çº§Yåæ ‡: ç¬¬4å±‚ -> Y=600
ğŸ“ [å¸ƒå±€å¼•æ“] èŠ‚ç‚¹ node_1754380184799 å±‚çº§Yåæ ‡: ç¬¬6å±‚ -> Y=900
```

### 7.5 é¢„è§ˆçº¿ä½ç½®ä¿®å¤éªŒè¯

#### 7.5.1 ä¿®å¤å‰çš„é”™è¯¯çŠ¶æ€
```
âš ï¸ [é¢„è§ˆçº¿ä½ç½®] å¸ƒå±€å¼•æ“ä¸å¯ç”¨ï¼ŒèŠ‚ç‚¹ start-node ä½¿ç”¨å›ºå®šåç§»Yåæ ‡: 300
âš ï¸ [åˆ†æ”¯é¢„è§ˆçº¿ä½ç½®] å¸ƒå±€å¼•æ“ä¸å¯ç”¨ï¼ŒèŠ‚ç‚¹ node_1754380077984 ä½¿ç”¨å›ºå®šåç§»Yåæ ‡: 500.40625
```

#### 7.5.2 ä¿®å¤åçš„æ­£ç¡®çŠ¶æ€
```
ğŸ”— [ç»Ÿä¸€é¢„è§ˆçº¿ç®¡ç†å™¨] å¸ƒå±€å¼•æ“å¼•ç”¨å·²è®¾ç½®: {å¼•æ“ç±»å‹: 'UnifiedStructuredLayoutEngine', æœ‰getNodeLayerYæ–¹æ³•: true, æœ‰getNextLayerYæ–¹æ³•: true, å¼•æ“å°±ç»ªçŠ¶æ€: true}

ğŸ“ [é¢„è§ˆçº¿ä½ç½®] èŠ‚ç‚¹ start-node ä½¿ç”¨å¸ƒå±€å¼•æ“å±‚çº§Yåæ ‡: 150
ğŸ“ [åˆ†æ”¯é¢„è§ˆçº¿ä½ç½®] èŠ‚ç‚¹ node_1754380077984 ä½¿ç”¨å¸ƒå±€å¼•æ“å±‚çº§Yåæ ‡: 300
ğŸ“ [åˆ†æ”¯é¢„è§ˆçº¿ä½ç½®] èŠ‚ç‚¹ node_1754380100151 ä½¿ç”¨å¸ƒå±€å¼•æ“å±‚çº§Yåæ ‡: 450
ğŸ“ [åˆ†æ”¯é¢„è§ˆçº¿ä½ç½®] èŠ‚ç‚¹ node_1754380148466 ä½¿ç”¨å¸ƒå±€å¼•æ“å±‚çº§Yåæ ‡: 750
ğŸ“ [é¢„è§ˆçº¿ä½ç½®] èŠ‚ç‚¹ node_1754380184799 ä½¿ç”¨å¸ƒå±€å¼•æ“å±‚çº§Yåæ ‡: 1050
```

### 7.6 å±‚çº§é—´è·åŒæ­¥ä¿®å¤éªŒè¯

ä¿®å¤åçš„å±‚çº§é—´è·åŒæ­¥æ—¥å¿—æ˜¾ç¤ºæ‰€æœ‰èŠ‚ç‚¹éƒ½æ­£ç¡®å¯¹é½åˆ°å±‚çº§Yåæ ‡ï¼š

```
ğŸ”§ [å±‚çº§é—´è·] ç¬¬0å±‚ï¼Œç›®æ ‡Yåæ ‡: 0ï¼ŒèŠ‚ç‚¹æ•°: 1
ğŸ”§ [å±‚çº§é—´è·] èŠ‚ç‚¹ start-node: Yåæ ‡ 0 â†’ 0
ğŸ”§ [å±‚çº§é—´è·] ç¬¬1å±‚ï¼Œç›®æ ‡Yåæ ‡: 150ï¼ŒèŠ‚ç‚¹æ•°: 1
ğŸ”§ [å±‚çº§é—´è·] èŠ‚ç‚¹ node_1754380077984: Yåæ ‡ 150 â†’ 150
ğŸ”§ [å±‚çº§é—´è·] ç¬¬2å±‚ï¼Œç›®æ ‡Yåæ ‡: 300ï¼ŒèŠ‚ç‚¹æ•°: 1
ğŸ”§ [å±‚çº§é—´è·] èŠ‚ç‚¹ node_1754380100151: Yåæ ‡ 300 â†’ 300
ğŸ”§ [å±‚çº§é—´è·] ç¬¬3å±‚ï¼Œç›®æ ‡Yåæ ‡: 450ï¼ŒèŠ‚ç‚¹æ•°: 1
ğŸ”§ [å±‚çº§é—´è·] èŠ‚ç‚¹ node_1754380115068: Yåæ ‡ 450 â†’ 450
ğŸ”§ [å±‚çº§é—´è·] ç¬¬4å±‚ï¼Œç›®æ ‡Yåæ ‡: 600ï¼ŒèŠ‚ç‚¹æ•°: 1
ğŸ”§ [å±‚çº§é—´è·] èŠ‚ç‚¹ node_1754380148466: Yåæ ‡ 600 â†’ 600
ğŸ”§ [å±‚çº§é—´è·] ç¬¬5å±‚ï¼Œç›®æ ‡Yåæ ‡: 750ï¼ŒèŠ‚ç‚¹æ•°: 2
ğŸ”§ [å±‚çº§é—´è·] èŠ‚ç‚¹ node_1754380173034: Yåæ ‡ 750 â†’ 750
ğŸ”§ [å±‚çº§é—´è·] èŠ‚ç‚¹ node_1754380126450: Yåæ ‡ 750 â†’ 750
ğŸ”§ [å±‚çº§é—´è·] ç¬¬6å±‚ï¼Œç›®æ ‡Yåæ ‡: 900ï¼ŒèŠ‚ç‚¹æ•°: 1
ğŸ”§ [å±‚çº§é—´è·] èŠ‚ç‚¹ node_1754380184799: Yåæ ‡ 900 â†’ 900
ğŸ”§ [å±‚çº§é—´è·] ç¬¬7å±‚ï¼Œç›®æ ‡Yåæ ‡: 1050ï¼ŒèŠ‚ç‚¹æ•°: 4
ğŸ”§ [å±‚çº§é—´è·] èŠ‚ç‚¹ virtual_endpoint_endpoint_node_1754380184799_single: Yåæ ‡ 1050 â†’ 1050
ğŸ¯ [åŒæ­¥ä¿®å¤] è™šæ‹Ÿendpoint virtual_endpoint_endpoint_node_1754380184799_single å†…éƒ¨ä½ç½®å·²åŒæ­¥åˆ°å±‚çº§Yåæ ‡: 1050
```

### 7.7 ä¿®å¤æˆæœæ€»ç»“

#### âœ… å·²è§£å†³çš„é—®é¢˜
1. **å±‚çº§æ„å»ºå®Œæ•´æ€§**ï¼šä»3å±‚æ‰©å±•åˆ°æ­£ç¡®çš„7å±‚
2. **nodeToLayeræ˜ å°„å®Œæ•´æ€§**ï¼šæˆåŠŸé‡å»º8ä¸ªèŠ‚ç‚¹çš„æ˜ å°„å…³ç³»
3. **Yåæ ‡è®¡ç®—å‡†ç¡®æ€§**ï¼šæ‰€æœ‰èŠ‚ç‚¹ä½¿ç”¨æ­£ç¡®çš„å±‚çº§Yåæ ‡ï¼ˆ0, 150, 300, 450, 600, 750, 900, 1050ï¼‰
4. **é¢„è§ˆçº¿ä½ç½®å‡†ç¡®æ€§**ï¼šé¢„è§ˆçº¿ä½¿ç”¨å¸ƒå±€å¼•æ“å±‚çº§Yåæ ‡ï¼Œä¸å†ä½¿ç”¨å›ºå®šåç§»
5. **ç«¯ç‚¹èŠ‚ç‚¹å±‚çº§åˆ†é…**ï¼šç«¯ç‚¹èŠ‚ç‚¹æ­£ç¡®åˆ†é…åˆ°æºèŠ‚ç‚¹çš„ä¸‹ä¸€å±‚
6. **è™šæ‹ŸendpointåŒæ­¥**ï¼šè™šæ‹Ÿendpointå†…éƒ¨ä½ç½®ä¸å±‚çº§Yåæ ‡åŒæ­¥

#### ğŸ“Š å…³é”®æŒ‡æ ‡å¯¹æ¯”

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æ”¹å–„ |
|------|--------|--------|------|
| å±‚çº§æ•°é‡ | 3å±‚ | 7å±‚ | âœ… 133%æå‡ |
| Yåæ ‡å‡†ç¡®æ€§ | æ‰€æœ‰150 | 0-1050é€’å¢ | âœ… å®Œå…¨ä¿®å¤ |
| é¢„è§ˆçº¿é”™è¯¯ | å¸ƒå±€å¼•æ“ä¸å¯ç”¨ | ä½¿ç”¨å±‚çº§Yåæ ‡ | âœ… å®Œå…¨ä¿®å¤ |
| nodeToLayeræ˜ å°„ | éƒ¨åˆ†ä¸¢å¤± | 8ä¸ªèŠ‚ç‚¹å®Œæ•´ | âœ… å®Œå…¨ä¿®å¤ |
| ç«¯ç‚¹å±‚çº§åˆ†é… | é”™è¯¯ | æ­£ç¡® | âœ… å®Œå…¨ä¿®å¤ |

#### ğŸ¯ éªŒè¯é€šè¿‡çš„åŠŸèƒ½ç‚¹
- [x] å±‚çº§æ„å»ºç®—æ³•å®Œæ•´æ€§
- [x] Yåæ ‡è®¡ç®—å‡†ç¡®æ€§
- [x] é¢„è§ˆçº¿ä½ç½®æ­£ç¡®æ€§
- [x] ç«¯ç‚¹èŠ‚ç‚¹å±‚çº§åˆ†é…
- [x] è™šæ‹ŸendpointåŒæ­¥
- [x] å¸ƒå±€å¼•æ“å¼•ç”¨ä¼ é€’
- [x] nodeToLayeræ˜ å°„å®Œæ•´æ€§
- [x] å±‚çº§é—´è·åŒæ­¥

### 7.8 æŠ€æœ¯å€ºåŠ¡æ¸…ç†

é€šè¿‡æ­¤æ¬¡ä¿®å¤ï¼ŒåŒæ—¶æ¸…ç†äº†ä»¥ä¸‹æŠ€æœ¯å€ºåŠ¡ï¼š
1. **å¢å¼ºäº†é”™è¯¯å¤„ç†æœºåˆ¶**ï¼šæ·»åŠ äº†å¤šé‡è§£æç­–ç•¥å’Œåº”æ€¥å›é€€
2. **å®Œå–„äº†è°ƒè¯•æ—¥å¿—ç³»ç»Ÿ**ï¼šæä¾›äº†è¯¦ç»†çš„å±‚çº§æ„å»ºå’ŒYåæ ‡è®¡ç®—æ—¥å¿—
3. **æå‡äº†ç®—æ³•å¥å£®æ€§**ï¼šæ·»åŠ äº†æœªå¤„ç†èŠ‚ç‚¹æ£€æµ‹å’Œæ— é™å¾ªç¯ä¿æŠ¤
4. **ä¼˜åŒ–äº†ä»£ç å¯ç»´æŠ¤æ€§**ï¼šæ¸…æ™°çš„æ—¥å¿—è¾“å‡ºä¾¿äºåç»­é—®é¢˜è¯Šæ–­

### 7.9 åç»­å»ºè®®

1. **æ€§èƒ½ä¼˜åŒ–**ï¼šè€ƒè™‘ç¼“å­˜å±‚çº§è®¡ç®—ç»“æœï¼Œå‡å°‘é‡å¤è®¡ç®—
2. **ä»£ç ç®€åŒ–**ï¼šç§»é™¤å†—ä½™çš„è°ƒè¯•æ—¥å¿—ï¼Œä¿ç•™å…³é”®ç›‘æ§ç‚¹
3. **å•å…ƒæµ‹è¯•**ï¼šä¸ºå±‚çº§æ„å»ºç®—æ³•æ·»åŠ å•å…ƒæµ‹è¯•ï¼Œç¡®ä¿ç¨³å®šæ€§
4. **æ–‡æ¡£æ›´æ–°**ï¼šæ›´æ–°APIæ–‡æ¡£ï¼Œè¯´æ˜æ–°çš„å±‚çº§æ„å»ºæœºåˆ¶

---

## ğŸ‰ æœ€ç»ˆç»“è®º

é€šè¿‡Solution Då’ŒSolution Eçš„æˆåŠŸå®æ–½ï¼Œ**ç”»å¸ƒå¸ƒå±€Yåæ ‡é—®é¢˜å·²å½»åº•è§£å†³**ã€‚ç³»ç»Ÿç°åœ¨èƒ½å¤Ÿï¼š

1. **æ­£ç¡®æ„å»ºå®Œæ•´çš„å±‚çº§ç»“æ„**ï¼ˆ7å±‚è€Œé3å±‚ï¼‰
2. **å‡†ç¡®è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„Yåæ ‡**ï¼ˆ0-1050é€’å¢è€Œéç»Ÿä¸€150ï¼‰
3. **ç²¾ç¡®å®šä½é¢„è§ˆçº¿ä½ç½®**ï¼ˆä½¿ç”¨å±‚çº§Yåæ ‡è€Œéå›ºå®šåç§»ï¼‰
4. **æ­£ç¡®åˆ†é…ç«¯ç‚¹èŠ‚ç‚¹å±‚çº§**ï¼ˆæºèŠ‚ç‚¹ä¸‹ä¸€å±‚è€Œéé”™è¯¯å±‚çº§ï¼‰
5. **å®Œç¾åŒæ­¥è™šæ‹Ÿendpointä½ç½®**ï¼ˆä¸å±‚çº§Yåæ ‡ä¸€è‡´ï¼‰

è¿™æ¬¡ä¿®å¤ä¸ä»…è§£å†³äº†å½“å‰é—®é¢˜ï¼Œæ›´å»ºç«‹äº†ä¸€å¥—å¥å£®çš„å¸ƒå±€ç³»ç»Ÿï¼Œä¸ºé¡¹ç›®çš„é•¿æœŸå‘å±•å¥ å®šäº†åšå®çš„æŠ€æœ¯åŸºç¡€ã€‚