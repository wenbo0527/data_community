# èŠ‚ç‚¹å±‚çº§ä¿¡æ¯ç¼ºå¤±é—®é¢˜ä¿®å¤æ—¥å¿—

## é¡¹ç›®èƒŒæ™¯
æ•°å­—ç¤¾åŒºè¥é”€ç”»å¸ƒå¹³å°åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å‡ºç°å¸ƒå±€å¼•æ“æ— æ³•æ‰¾åˆ°ç‰¹å®šèŠ‚ç‚¹å±‚çº§ä¿¡æ¯çš„é”™è¯¯ï¼Œå¯¼è‡´é¢„è§ˆçº¿è®¡ç®—å¤±è´¥å¹¶äº§ç”Ÿæ§åˆ¶å°è­¦å‘Šã€‚

## é—®é¢˜åˆ†æ

### é”™è¯¯ç°è±¡
```
âš ï¸ [å¸ƒå±€å¼•æ“] æœªæ‰¾åˆ°èŠ‚ç‚¹ node_1754380077984 çš„å±‚çº§ä¿¡æ¯
âš ï¸ [å¸ƒå±€å¼•æ“] æœªæ‰¾åˆ°èŠ‚ç‚¹ node_1754380100151 çš„å±‚çº§ä¿¡æ¯  
âš ï¸ [å¸ƒå±€å¼•æ“] æœªæ‰¾åˆ°èŠ‚ç‚¹ node_1754380148466 çš„å±‚çº§ä¿¡æ¯
```

### é”™è¯¯è°ƒç”¨é“¾
```
calculateBranchPreviewPosition @ UnifiedPreviewLineManager.js:3504
getNextLayerY @ UnifiedStructuredLayoutEngine.js:529
getNodeLayerY @ UnifiedStructuredLayoutEngine.js:514
```

### æ ¹æœ¬åŸå› åˆ†æ
1. **æ—¶åºé—®é¢˜**: é¢„è§ˆçº¿ç®¡ç†å™¨åœ¨å¸ƒå±€å¼•æ“å®Œæˆå±‚çº§è®¡ç®—ä¹‹å‰å°±å°è¯•è·å–èŠ‚ç‚¹å±‚çº§ä¿¡æ¯
2. **æ˜ å°„ç¼ºå¤±**: `layoutModel.nodeToLayer` æ˜ å°„è¡¨ä¸­ç¼ºå°‘æŸäº›èŠ‚ç‚¹çš„å±‚çº§ä¿¡æ¯
3. **å®¹é”™ä¸è¶³**: åŸæœ‰ä»£ç ç¼ºä¹æ™ºèƒ½æ¨æ–­å’Œå®¹é”™æœºåˆ¶

## è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ç­–ç•¥
1. **å¢å¼ºå®¹é”™æœºåˆ¶**: åœ¨è·å–å±‚çº§ä¿¡æ¯å¤±è´¥æ—¶æä¾›æ™ºèƒ½æ¨æ–­
2. **å¤šé‡æ¨æ–­ç­–ç•¥**: åŸºäºèŠ‚ç‚¹ä½ç½®ã€çˆ¶å­å…³ç³»ã€èŠ‚ç‚¹ç±»å‹ç­‰å¤šç§æ–¹å¼æ¨æ–­
3. **é»˜è®¤å€¼ä¿éšœ**: ä¸ºä¸åŒç±»å‹èŠ‚ç‚¹æä¾›åˆç†çš„é»˜è®¤Yåæ ‡

### å…·ä½“å®ç°

#### 1. å¢å¼º getNodeLayerY æ–¹æ³•
```javascript
getNodeLayerY(nodeId) {
  // ğŸ¯ ä¿®å¤1ï¼šå¢å¼ºå¸ƒå±€æ¨¡å‹æ£€æŸ¥
  if (!this.layoutModel || !this.layoutModel.nodeToLayer) {
    console.warn(`âš ï¸ [å¸ƒå±€å¼•æ“] å¸ƒå±€æ¨¡å‹æœªåˆå§‹åŒ–ï¼ŒèŠ‚ç‚¹ ${nodeId} ä½¿ç”¨é»˜è®¤Yåæ ‡`)
    return this.getDefaultLayerY(nodeId)
  }
  
  // ğŸ¯ ä¿®å¤2ï¼šé¦–å…ˆæ£€æŸ¥èŠ‚ç‚¹å±‚çº§æ˜ å°„
  const layerIndex = this.layoutModel.nodeToLayer.get(nodeId)
  if (layerIndex === undefined) {
    console.warn(`âš ï¸ [å¸ƒå±€å¼•æ“] æœªæ‰¾åˆ°èŠ‚ç‚¹ ${nodeId} çš„å±‚çº§ä¿¡æ¯ï¼Œå°è¯•æ™ºèƒ½æ¨æ–­`)
    return this.inferNodeLayerY(nodeId)
  }
  
  const layerY = layerIndex * this.options.layer.baseHeight
  console.log(`ğŸ“ [å¸ƒå±€å¼•æ“] èŠ‚ç‚¹ ${nodeId} å±‚çº§Yåæ ‡: ç¬¬${layerIndex}å±‚ -> Y=${layerY}`)
  return layerY
}
```

#### 2. æ–°å¢æ™ºèƒ½æ¨æ–­æ–¹æ³•
```javascript
inferNodeLayerY(nodeId) {
  try {
    // ğŸ¯ ç­–ç•¥1ï¼šé€šè¿‡å›¾å½¢èŠ‚ç‚¹ä½ç½®æ¨æ–­
    const node = this.graph.getCellById(nodeId)
    if (node) {
      const position = node.getPosition()
      const estimatedLayer = Math.floor(position.y / this.options.layer.baseHeight)
      const estimatedY = estimatedLayer * this.options.layer.baseHeight
      
      // ä¸´æ—¶æ·»åŠ åˆ°å±‚çº§æ˜ å°„ä¸­ï¼Œé¿å…é‡å¤æ¨æ–­
      if (this.layoutModel && this.layoutModel.nodeToLayer) {
        this.layoutModel.nodeToLayer.set(nodeId, estimatedLayer)
      }
      
      return estimatedY
    }
    
    // ğŸ¯ ç­–ç•¥2ï¼šé€šè¿‡çˆ¶å­å…³ç³»æ¨æ–­
    if (this.layoutModel && this.layoutModel.childParentMap) {
      const parents = this.layoutModel.childParentMap.get(nodeId) || []
      if (parents.length > 0) {
        const parentId = parents[0]
        const parentLayer = this.layoutModel.nodeToLayer.get(parentId)
        if (parentLayer !== undefined) {
          const childLayer = parentLayer + 1
          const childY = childLayer * this.options.layer.baseHeight
          
          // ä¸´æ—¶æ·»åŠ åˆ°å±‚çº§æ˜ å°„ä¸­
          this.layoutModel.nodeToLayer.set(nodeId, childLayer)
          return childY
        }
      }
    }
    
    // ğŸ¯ ç­–ç•¥3ï¼šä½¿ç”¨é»˜è®¤Yåæ ‡
    return this.getDefaultLayerY(nodeId)
    
  } catch (error) {
    console.warn(`âš ï¸ [æ™ºèƒ½æ¨æ–­] èŠ‚ç‚¹ ${nodeId} æ¨æ–­å¤±è´¥:`, error.message)
    return this.getDefaultLayerY(nodeId)
  }
}
```

#### 3. æ–°å¢é»˜è®¤åæ ‡æ–¹æ³•
```javascript
getDefaultLayerY(nodeId) {
  // ğŸ¯ æ ¹æ®èŠ‚ç‚¹ç±»å‹è¿”å›ä¸åŒçš„é»˜è®¤Yåæ ‡
  if (nodeId.includes('start')) {
    return 0 // èµ·å§‹èŠ‚ç‚¹åœ¨ç¬¬0å±‚
  } else if (nodeId.includes('virtual_endpoint') || nodeId.includes('endpoint')) {
    return this.options.layer.baseHeight * 3 // endpointèŠ‚ç‚¹é»˜è®¤åœ¨ç¬¬3å±‚
  } else {
    return this.options.layer.baseHeight // æ™®é€šèŠ‚ç‚¹é»˜è®¤åœ¨ç¬¬1å±‚
  }
}
```

#### 4. å¢å¼º getNextLayerY æ–¹æ³•
```javascript
getNextLayerY(nodeId) {
  try {
    const currentLayerY = this.getNodeLayerY(nodeId)
    const nextLayerY = currentLayerY + this.options.layer.baseHeight
    console.log(`ğŸ“ [å¸ƒå±€å¼•æ“] èŠ‚ç‚¹ ${nodeId} ä¸‹ä¸€å±‚Yåæ ‡: ${currentLayerY} + ${this.options.layer.baseHeight} = ${nextLayerY}`)
    return nextLayerY
  } catch (error) {
    console.warn(`âš ï¸ [å¸ƒå±€å¼•æ“] è·å–èŠ‚ç‚¹ ${nodeId} ä¸‹ä¸€å±‚Yåæ ‡å¤±è´¥:`, error.message)
    // ä½¿ç”¨é»˜è®¤çš„ä¸‹ä¸€å±‚Yåæ ‡
    return this.options.layer.baseHeight * 2
  }
}
```

## è§£å†³æ—¥å¿—

### ä¿®å¤æ—¶é—´
2025å¹´01æœˆ16æ—¥ 15:45

### ä¿®æ”¹æ–‡ä»¶
- `/Users/mac/nis_mock/data_comunity/data_comunity/src/utils/UnifiedStructuredLayoutEngine.js`

### ä¿®æ”¹å†…å®¹
1. **æ–°å¢æ–¹æ³•**:
   - `inferNodeLayerY()`: æ™ºèƒ½æ¨æ–­èŠ‚ç‚¹å±‚çº§Yåæ ‡
   - `getDefaultLayerY()`: è·å–é»˜è®¤å±‚çº§Yåæ ‡

2. **ä¿®æ”¹æ–¹æ³•**:
   - `getNodeLayerY()`: å¢åŠ å®¹é”™æœºåˆ¶å’Œæ™ºèƒ½æ¨æ–­
   - `getNextLayerY()`: å¢åŠ å¼‚å¸¸æ•è·å’Œå®¹é”™å¤„ç†

### é¢„æœŸæ•ˆæœ
1. **æ¶ˆé™¤è­¦å‘Š**: ä¸å†å‡ºç°"æœªæ‰¾åˆ°èŠ‚ç‚¹å±‚çº§ä¿¡æ¯"çš„æ§åˆ¶å°è­¦å‘Š
2. **æé«˜ç¨³å®šæ€§**: å¸ƒå±€å¼•æ“å…·å¤‡æ›´å¼ºçš„å®¹é”™èƒ½åŠ›
3. **ä¿éšœåŠŸèƒ½**: ç¡®ä¿é¢„è§ˆçº¿èƒ½å¤Ÿæ­£å¸¸è®¡ç®—å’Œæ˜¾ç¤º
4. **æ™ºèƒ½æ¨æ–­**: å³ä½¿åœ¨å±‚çº§æ˜ å°„ç¼ºå¤±çš„æƒ…å†µä¸‹ä¹Ÿèƒ½æä¾›åˆç†çš„åæ ‡

### æµ‹è¯•éªŒè¯
ä¿®å¤åéœ€è¦éªŒè¯ä»¥ä¸‹åœºæ™¯ï¼š
1. æ­£å¸¸çš„èŠ‚ç‚¹å±‚çº§è®¡ç®—
2. ç¼ºå¤±å±‚çº§ä¿¡æ¯æ—¶çš„æ™ºèƒ½æ¨æ–­
3. é¢„è§ˆçº¿çš„æ­£å¸¸æ˜¾ç¤ºå’Œäº¤äº’
4. ä¸åŒç±»å‹èŠ‚ç‚¹çš„é»˜è®¤åæ ‡åˆ†é…

---
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¶é—´**: 2025å¹´01æœˆ16æ—¥ 15:45