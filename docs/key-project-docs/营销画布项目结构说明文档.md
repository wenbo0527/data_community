# 营销画布项目结构说明文档

## 📋 项目概述

本项目是一个基于 Vue 3 + Vite + X6 的营销任务流程画布系统，提供可视化的营销流程设计、编辑和管理功能。

## 🏗️ 技术栈

- **前端框架**: Vue 3 (Composition API)
- **构建工具**: Vite
- **图形引擎**: AntV X6
- **状态管理**: Vuex
- **路由管理**: Vue Router
- **UI组件**: Arco Design
- **开发语言**: JavaScript + TypeScript

## 📁 营销画布核心目录结构

```
├── src/                       # 源代码目录
│   ├── pages/marketing/       # 营销画布页面
│   │   └── tasks/            # 营销任务模块
│   │       ├── index.vue     # 任务列表页面
│   │       ├── create.vue    # 任务创建页面
│   │       └── components/   # 画布组件
│   │           ├── TaskFlowCanvas.vue      # 主画布组件
│   │           ├── CanvasManualControls.vue # 画布手动控制
│   │           ├── FlowNode.vue           # 流程节点组件
│   │           ├── NodeConfigDrawer.vue   # 节点配置抽屉
│   │           ├── NodeTypeSelector.vue   # 节点类型选择器
│   │           └── PresetSlot.vue        # 预设插槽组件
│   ├── composables/          # 组合式函数
│   │   ├── useBaseDrawer.js         # 基础抽屉逻辑
│   │   ├── useConfigDrawers.js      # 配置抽屉逻辑
│   │   ├── useStartNodeForm.js      # 开始节点表单逻辑
│   │   ├── useStructuredLayout.js   # 结构化布局逻辑
│   │   └── useX6Events.js          # X6 事件处理逻辑
│   ├── config/               # 配置文件
│   │   ├── SnapConfig.js            # 吸附配置
│   │   ├── canvasAutomationConfig.js # 画布自动化配置
│   │   └── menuConfig.js            # 菜单配置
│   ├── constants/            # 常量定义
│   │   ├── startNodeConfig.js       # 开始节点配置
│   │   └── startNodeConfig.ts       # TypeScript 版本
│   ├── store/                # 状态管理
│   │   ├── index.js                 # Store 主文件
│   │   └── modules/                 # Store 模块
│   ├── styles/               # 样式文件
│   │   ├── enhanced-canvas-styles.css    # 增强画布样式
│   │   ├── enhanced-node-styles.css      # 增强节点样式
│   │   └── enhanced-toolbar-styles.css   # 增强工具栏样式
│   ├── types/                # TypeScript 类型定义
│   │   ├── canvas.d.ts                  # 画布类型
│   │   ├── connectionPreview.js/ts      # 连接预览类型
│   │   ├── nodeDrawerConfig.js/ts       # 节点抽屉配置类型
│   │   ├── startNodeConfig.js/ts        # 开始节点配置类型
│   │   ├── steps.js/ts                  # 步骤类型
│   │   └── taskflow.js                  # 任务流类型
│   └── utils/                # 工具函数
│       ├── CanvasPanZoomManager.js      # 画布平移缩放管理器
│       ├── CoordinateSystemManager.js   # 坐标系管理器
│       ├── DragSnapLogger.js            # 拖拽吸附日志器
│       ├── EdgeOverlapManager.js        # 边重叠管理器
│       ├── EndNodeConfig.js             # 结束节点配置
│       ├── NodeConfigManager.js         # 节点配置管理器
│       ├── SmartCacheManager.js         # 智能缓存管理器
│       ├── UnifiedPreviewLineManager.js # 统一预览线管理器
│       ├── UnifiedStructuredLayoutEngine.js # 统一结构化布局引擎
│       ├── branchSpacingConfig.js       # 分支间距配置
│       ├── calculations.js/ts           # 计算工具
│       ├── canvasConfig.js              # 画布配置
│       ├── canvasValidation.js          # 画布验证
│       ├── connectionConfigFactory.js   # 连接配置工厂
│       ├── enhancedCanvasValidation.js  # 增强画布验证
│       ├── enhancedErrorHandler.js      # 增强错误处理器
│       ├── export.js/ts                 # 导出工具
│       ├── nodeConnectionHelper.js      # 节点连接助手
│       ├── nodeTypes.js                 # 节点类型定义
│       ├── performanceUtils.js          # 性能工具
│       ├── portConfigFactory.js         # 端口配置工厂
│       ├── previewConfig.js             # 预览配置
│       ├── taskStorage.js               # 任务存储
│       ├── uiOptimizationConfig.js      # UI 优化配置
│       ├── verticalLayoutConfig.js      # 垂直布局配置
│       └── x6Config.js                  # X6 配置
├── package.json              # 项目依赖配置
├── vite.config.js           # Vite 构建配置
├── tsconfig.json            # TypeScript 配置
└── README.md                # 项目说明文档
```

## 🎯 营销画布核心功能模块

### 1. 画布系统 (Canvas System)
- **<mcfile name="TaskFlowCanvas.vue" path="src/pages/marketing/tasks/components/TaskFlowCanvas.vue"></mcfile>**: 主画布组件，基于 X6 实现
- **<mcfile name="CanvasPanZoomManager.js" path="src/utils/CanvasPanZoomManager.js"></mcfile>**: 画布平移和缩放管理
- **<mcfile name="CoordinateSystemManager.js" path="src/utils/CoordinateSystemManager.js"></mcfile>**: 坐标系统管理
- **<mcfile name="canvasConfig.js" path="src/utils/canvasConfig.js"></mcfile>**: 画布基础配置

### 2. 节点系统 (Node System)
- **<mcfile name="FlowNode.vue" path="src/pages/marketing/tasks/components/FlowNode.vue"></mcfile>**: 流程节点组件
- **<mcfile name="NodeConfigManager.js" path="src/utils/NodeConfigManager.js"></mcfile>**: 节点配置管理
- **<mcfile name="nodeTypes.js" path="src/utils/nodeTypes.js"></mcfile>**: 节点类型定义
- **<mcfile name="NodeConfigDrawer.vue" path="src/pages/marketing/tasks/components/NodeConfigDrawer.vue"></mcfile>**: 节点配置抽屉

### 3. 连接系统 (Connection System)
- **<mcfile name="UnifiedPreviewLineManager.js" path="src/utils/UnifiedPreviewLineManager.js"></mcfile>**: 统一预览线管理
- **<mcfile name="EdgeOverlapManager.js" path="src/utils/EdgeOverlapManager.js"></mcfile>**: 连线重叠处理
- **<mcfile name="nodeConnectionHelper.js" path="src/utils/nodeConnectionHelper.js"></mcfile>**: 节点连接助手
- **<mcfile name="connectionConfigFactory.js" path="src/utils/connectionConfigFactory.js"></mcfile>**: 连接配置工厂

### 4. 布局系统 (Layout System)
- **<mcfile name="UnifiedStructuredLayoutEngine.js" path="src/utils/UnifiedStructuredLayoutEngine.js"></mcfile>**: 统一结构化布局引擎
- **<mcfile name="useStructuredLayout.js" path="src/composables/useStructuredLayout.js"></mcfile>**: 布局组合式函数
- **<mcfile name="verticalLayoutConfig.js" path="src/utils/verticalLayoutConfig.js"></mcfile>**: 垂直布局配置
- **<mcfile name="branchSpacingConfig.js" path="src/utils/branchSpacingConfig.js"></mcfile>**: 分支间距配置

### 5. 交互系统 (Interaction System)
- **<mcfile name="DragSnapLogger.js" path="src/utils/DragSnapLogger.js"></mcfile>**: 拖拽吸附日志
- **<mcfile name="SnapConfig.js" path="src/config/SnapConfig.js"></mcfile>**: 吸附配置
- **<mcfile name="useX6Events.js" path="src/composables/useX6Events.js"></mcfile>**: X6 事件处理

### 6. 数据持久化系统 (Data Persistence System)
- **<mcfile name="taskStorage.js" path="src/utils/taskStorage.js"></mcfile>**: 任务存储管理
- **<mcfile name="export.js" path="src/utils/export.js"></mcfile>**: 导出工具
- **<mcfile name="SmartCacheManager.js" path="src/utils/SmartCacheManager.js"></mcfile>**: 智能缓存管理

## 📊 核心业务流程

### 1. 画布初始化流程
```
App.vue → TaskFlowCanvas.vue → X6 Graph 初始化 → 加载节点和连接
```

### 2. 节点创建流程
```
NodeTypeSelector → 选择节点类型 → 创建节点实例 → 添加到画布 → 配置节点属性
```

### 3. 连接创建流程
```
拖拽开始 → 预览线显示 → 连接目标确认 → 创建正式连接 → 清理预览线
```

### 4. 布局应用流程
```
触发布局 → 计算节点位置 → 应用位置变更 → 重新计算连接路径 → 渲染完成
```

### 5. 保存流程 (Save Process)
```
用户触发保存 → 收集画布数据 → 数据验证 → 本地存储/API保存 → 保存确认
```
**核心实现**:
- <mcsymbol name="exportData" filename="TaskFlowCanvas.vue" path="src/pages/marketing/tasks/components/TaskFlowCanvas.vue" startline="3853" type="function"></mcsymbol>: 导出画布数据
- <mcsymbol name="saveTask" filename="taskStorage.js" path="src/utils/taskStorage.js" startline="33" type="function"></mcsymbol>: 保存任务到本地存储

### 6. 加载流程 (Load Process)
```
选择任务 → 获取任务数据 → 数据验证 → 清空画布 → 重建节点和连接 → 渲染完成
```
**核心实现**:
- <mcsymbol name="loadCanvasData" filename="TaskFlowCanvas.vue" path="src/pages/marketing/tasks/components/TaskFlowCanvas.vue" startline="3870" type="function"></mcsymbol>: 加载画布数据
- <mcsymbol name="getTaskById" filename="taskStorage.js" path="src/utils/taskStorage.js" startline="23" type="function"></mcsymbol>: 根据ID获取任务

### 7. 发布流程 (Publish Process)
```
任务验证 → 配置检查 → 生成发布包 → 状态更新 → 发布确认 → 监控部署
```
**核心实现**:
- <mcsymbol name="exportTasks" filename="taskStorage.js" path="src/utils/taskStorage.js" startline="107" type="function"></mcsymbol>: 导出任务数据
- 画布导出功能: 支持PNG、JPG、SVG格式导出

## 🔧 开发指南

### 启动项目
```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 构建生产版本
npm run build
```

### 开发规范

#### 1. 组件开发
- 使用 Vue 3 Composition API
- 组件文件使用 PascalCase 命名
- 组合式函数使用 `use` 前缀

#### 2. 工具函数开发
- 工具函数放在 `src/utils/` 目录
- 使用 ES6 模块导入导出
- 添加详细的 JSDoc 注释

#### 3. 样式开发
- 使用 CSS 模块或 scoped 样式
- 遵循 BEM 命名规范
- 响应式设计优先

#### 4. 状态管理
- 使用 Vuex 进行全局状态管理
- 按功能模块拆分 store
- 使用 mutations 修改状态

## 🛠️ 关键技术点

### 1. X6 图形引擎集成
- 自定义节点和边的渲染
- 事件监听和处理
- 插件系统的使用

### 2. 预览线系统
- 实时预览连接效果
- 智能路径计算
- 多分支连接支持

### 3. 布局算法
- Dagre 自动布局
- 手动布局调整
- 布局方向切换

### 4. 数据持久化
- 本地存储 (LocalStorage)
- 任务导入导出
- 版本控制和备份

### 5. 性能优化
- 智能缓存机制
- 防抖和节流
- 虚拟滚动支持

## 💾 数据存储结构

### 任务数据结构
```javascript
{
  id: "task_001",
  name: "营销活动A",
  description: "描述信息",
  createTime: "2024-12-01 10:00:00",
  updateTime: "2024-12-01 15:30:00",
  version: 1,
  status: "draft", // draft, published, archived
  canvasData: {
    nodes: [
      {
        id: "node_001",
        type: "start",
        label: "开始",
        position: { x: 100, y: 100 },
        data: { /* 节点配置数据 */ },
        config: { /* 节点样式配置 */ }
      }
    ],
    connections: [
      {
        id: "connection_001",
        source: "node_001",
        target: "node_002",
        sourcePort: "out",
        targetPort: "in"
      }
    ]
  }
}
```

## 📝 注意事项

1. **坐标系统**: 项目使用多种坐标系，注意坐标转换
2. **内存管理**: 及时清理 X6 实例和事件监听器
3. **性能监控**: 关注大量节点时的渲染性能
4. **数据一致性**: 确保保存和加载数据的完整性
5. **版本兼容**: 处理不同版本任务数据的兼容性

## 🚀 扩展开发

### 添加新节点类型
1. 在 <mcfile name="nodeTypes.js" path="src/utils/nodeTypes.js"></mcfile> 中定义节点类型
2. 在 <mcfile name="NodeConfigManager.js" path="src/utils/NodeConfigManager.js"></mcfile> 中添加配置逻辑
3. 创建对应的配置组件
4. 更新 <mcfile name="NodeTypeSelector.vue" path="src/pages/marketing/tasks/components/NodeTypeSelector.vue"></mcfile>

### 添加新布局算法
1. 在 <mcfile name="UnifiedStructuredLayoutEngine.js" path="src/utils/UnifiedStructuredLayoutEngine.js"></mcfile> 中实现算法
2. 在 <mcfile name="useStructuredLayout.js" path="src/composables/useStructuredLayout.js"></mcfile> 中添加调用接口
3. 更新布局配置文件

### 扩展存储功能
1. 在 <mcfile name="taskStorage.js" path="src/utils/taskStorage.js"></mcfile> 中添加新的存储方法
2. 实现云端同步功能
3. 添加协作编辑支持

---

**文档版本**: v2.0  
**最后更新**: 2024年12月  
**维护者**: 前端开发团队