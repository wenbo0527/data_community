# ç¬¬ä¸‰å±‚èŠ‚ç‚¹é‡å é—®é¢˜ä¿®å¤æ—¥å¿—

**é—®é¢˜å‘ç°æ—¶é—´ï¼š** 2025å¹´1æœˆ16æ—¥  
**é—®é¢˜ç±»å‹ï¼š** å¸ƒå±€å¼•æ“æ··åˆå±‚çº§èŠ‚ç‚¹é‡å   
**å½±å“èŒƒå›´ï¼š** ç”»å¸ƒå¸ƒå±€ç³»ç»Ÿçš„ç¬¬ä¸‰å±‚èŠ‚ç‚¹ä½ç½®è®¡ç®—  

## é¡¹ç›®èƒŒæ™¯

è¯¥é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäºJavaScriptçš„ç”»å¸ƒå¸ƒå±€ç³»ç»Ÿï¼Œä½¿ç”¨ç»Ÿä¸€ç»“æ„åŒ–å¸ƒå±€å¼•æ“ï¼ˆUnifiedStructuredLayoutEngineï¼‰æ¥ç®¡ç†èŠ‚ç‚¹çš„å±‚çº§åˆ†å¸ƒå’Œä½ç½®è®¡ç®—ã€‚ç³»ç»Ÿæ”¯æŒæ™®é€šèŠ‚ç‚¹å’ŒendpointèŠ‚ç‚¹çš„æ··åˆå¸ƒå±€ã€‚

## é—®é¢˜åˆ†æ

### é—®é¢˜ç°è±¡

ç”¨æˆ·æŠ¥å‘Šç¬¬ä¸‰å±‚å‡ºç°èŠ‚ç‚¹é‡å é—®é¢˜ï¼š

```
ğŸ“Š [å±‚çº§æ„å»º] ç¬¬3å±‚: 1ä¸ªèŠ‚ç‚¹ ['node_1754380115068'] 
ğŸ¯ [å±‚çº§è°ƒæ•´] endpoint virtual_endpoint_endpoint_node_1754380100151_unmatch_default ä»æºèŠ‚ç‚¹ node_1754380100151(ç¬¬2å±‚) è°ƒæ•´åˆ°ç¬¬3å±‚ 
ğŸ“Š [æ··åˆå±‚çº§] ç¬¬3å±‚: 1æ™®é€šèŠ‚ç‚¹ + 1endpointèŠ‚ç‚¹ 
ğŸ“ [çˆ¶å±‚å®šä½] ç¬¬3å±‚ï¼Œç›®æ ‡Yåæ ‡: 450ï¼Œçˆ¶èŠ‚ç‚¹æ•°: 2 
ğŸ”§ [å•å±‚ä¼˜åŒ–] ç¬¬3å±‚ä¼˜åŒ–å®Œæˆï¼Œè°ƒæ•´ 1 æ¬¡ 
```

### æ ¹æœ¬åŸå› åˆ†æ

1. **Xåæ ‡åˆ†é…ä¸å®Œæ•´**
   - æ™®é€šèŠ‚ç‚¹ `node_1754380115068` é€šè¿‡ `calculateParentLayerPositions` åŸºäºå­èŠ‚ç‚¹ä½ç½®è®¡ç®—Xåæ ‡
   - endpointèŠ‚ç‚¹ `virtual_endpoint_endpoint_node_1754380100151_unmatch_default` æ²¡æœ‰å­èŠ‚ç‚¹ï¼Œå¯¼è‡´Xåæ ‡è®¡ç®—è¢«è·³è¿‡
   - ä¸¤ä¸ªèŠ‚ç‚¹å¯èƒ½è¢«åˆ†é…åˆ°ç›¸åŒæˆ–æ¥è¿‘çš„Xåæ ‡ä½ç½®

2. **æ··åˆå±‚çº§å¤„ç†é€»è¾‘ç¼ºé™·**
   - `calculateParentLayerPositions` æ–¹æ³•åªå¤„ç†æœ‰å­èŠ‚ç‚¹çš„èŠ‚ç‚¹
   - æ— å­èŠ‚ç‚¹çš„èŠ‚ç‚¹ï¼ˆé€šå¸¸æ˜¯endpointèŠ‚ç‚¹ï¼‰è¢«å¿½ç•¥ï¼Œå¯¼è‡´ä½ç½®ä¿¡æ¯ç¼ºå¤±
   - é‡å è§£å†³æœºåˆ¶æ— æ³•å¤„ç†ä½ç½®ä¿¡æ¯ä¸å®Œæ•´çš„èŠ‚ç‚¹

3. **ä½ç½®åŒæ­¥æœºåˆ¶ä¸å®Œå–„**
   - endpointèŠ‚ç‚¹çš„å†…éƒ¨ä½ç½®ä¸å¸ƒå±€å¼•æ“è®¡ç®—çš„ä½ç½®ä¸åŒæ­¥
   - ç¼ºä¹å¯¹å­¤ç«‹èŠ‚ç‚¹çš„ä¸“é—¨å¤„ç†é€»è¾‘

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šå¢å¼ºçˆ¶å±‚ä½ç½®è®¡ç®—

**ç›®æ ‡ï¼š** ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹éƒ½èƒ½è·å¾—æ­£ç¡®çš„Xåæ ‡åˆ†é…

**å®ç°ï¼š**

```javascript
calculateParentLayerPositions(parentLayer, positions, layerIndex, layerStructure) {
  // ğŸ¯ å…³é”®ä¿®å¤ï¼šåˆ†åˆ«å¤„ç†æœ‰å­èŠ‚ç‚¹å’Œæ— å­èŠ‚ç‚¹çš„èŠ‚ç‚¹
  const nodesWithChildren = []
  const nodesWithoutChildren = []
  
  // åˆ†ç±»èŠ‚ç‚¹
  parentLayer.forEach(parentNode => {
    const children = layerStructure.parentChildMap.get(parentId) || []
    const childPositions = children
      .map(childId => positions.get(childId))
      .filter(pos => pos !== undefined)
    
    if (childPositions.length > 0) {
      nodesWithChildren.push({ node: parentNode, childPositions })
    } else {
      nodesWithoutChildren.push(parentNode)
    }
  })
  
  // ç¬¬ä¸€æ­¥ï¼šå¤„ç†æœ‰å­èŠ‚ç‚¹çš„èŠ‚ç‚¹
  nodesWithChildren.forEach(({ node, childPositions }) => {
    const parentX = this.calculateOptimalParentPosition(childPositions)
    // è®¾ç½®ä½ç½®ä¿¡æ¯...
  })
  
  // ç¬¬äºŒæ­¥ï¼šå¤„ç†æ— å­èŠ‚ç‚¹çš„èŠ‚ç‚¹ï¼ˆé€šå¸¸æ˜¯endpointèŠ‚ç‚¹ï¼‰
  if (nodesWithoutChildren.length > 0) {
    // è·å–å·²åˆ†é…ä½ç½®çš„èŠ‚ç‚¹Xåæ ‡èŒƒå›´
    const existingPositions = Array.from(positions.values())
      .filter(pos => pos.layerIndex === layerIndex)
      .map(pos => pos.x)
    
    let startX = 0
    if (existingPositions.length > 0) {
      const maxX = Math.max(...existingPositions)
      startX = maxX + this.options.node.preferredSpacing
    }
    
    // ä¸ºæ— å­èŠ‚ç‚¹çš„èŠ‚ç‚¹åˆ†é…Xåæ ‡
    nodesWithoutChildren.forEach((node, index) => {
      const nodeX = startX + index * this.options.node.preferredSpacing
      // è®¾ç½®ä½ç½®ä¿¡æ¯å¹¶åŒæ­¥endpointå†…éƒ¨ä½ç½®...
    })
  }
}
```

### æ–¹æ¡ˆäºŒï¼šå¢å¼ºé‡å è§£å†³æœºåˆ¶

**ç›®æ ‡ï¼š** æä¾›æ›´è¯¦ç»†çš„é‡å æ£€æµ‹å’Œè§£å†³æ—¥å¿—

**å®ç°ï¼š**

```javascript
resolveNodeOverlaps(layerNodes, positions) {
  // è¿‡æ»¤æœ‰æ•ˆèŠ‚ç‚¹
  const validNodes = layerNodes.filter(node => {
    const nodeId = node.id || node.getId()
    const pos = positions.get(nodeId)
    if (!pos) {
      console.warn(`âš ï¸ [é‡å è§£å†³] èŠ‚ç‚¹ ${nodeId} åœ¨positionsä¸­ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤„ç†`)
      return false
    }
    return true
  })
  
  // æŒ‰Xåæ ‡æ’åºå¹¶æ‰“å°è°ƒè¯•ä¿¡æ¯
  const sortedNodes = validNodes.sort((a, b) => {
    const aPos = positions.get(a.id || a.getId())
    const bPos = positions.get(b.id || b.getId())
    return aPos.x - bPos.x
  })
  
  console.log(`ğŸ“Š [é‡å è§£å†³] æ’åºåçš„èŠ‚ç‚¹:`, sortedNodes.map(node => {
    const nodeId = node.id || node.getId()
    const pos = positions.get(nodeId)
    return `${nodeId}(${node.isEndpoint ? 'endpoint' : 'normal'}, x=${pos.x.toFixed(1)})`
  }))
  
  // æ£€æŸ¥å¹¶è°ƒæ•´é‡å ï¼ŒåŒæ—¶åŒæ­¥endpointå†…éƒ¨ä½ç½®
  for (let i = 1; i < sortedNodes.length; i++) {
    // é‡å æ£€æµ‹å’Œè°ƒæ•´é€»è¾‘...
    if (actualSpacing < requiredSpacing) {
      // è°ƒæ•´ä½ç½®å¹¶åŒæ­¥endpointå†…éƒ¨ä½ç½®
      if (currentNode.isEndpoint && currentNode.setPosition) {
        currentNode.setPosition({ x: currentPos.x, y: currentPos.y })
      }
    }
  }
}
```

## è§£å†³æ—¥å¿—

### 2025å¹´1æœˆ16æ—¥ - åˆæ­¥ä¿®å¤

1. **é—®é¢˜è¯†åˆ«**
   - é€šè¿‡æ—¥å¿—åˆ†æå‘ç°ç¬¬ä¸‰å±‚åŒæ—¶åŒ…å«æ™®é€šèŠ‚ç‚¹å’ŒendpointèŠ‚ç‚¹
   - ç¡®è®¤Xåæ ‡åˆ†é…é€»è¾‘å­˜åœ¨ç¼ºé™·

2. **ä»£ç ä¿®æ”¹**
   - ä¿®æ”¹ `calculateParentLayerPositions` æ–¹æ³•ï¼Œå¢åŠ å¯¹æ— å­èŠ‚ç‚¹çš„èŠ‚ç‚¹çš„å¤„ç†
   - å¢å¼º `resolveNodeOverlaps` æ–¹æ³•ï¼Œæ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—å’Œendpointä½ç½®åŒæ­¥

3. **ä¿®å¤æ•ˆæœ**
   - âœ… ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹éƒ½èƒ½è·å¾—æ­£ç¡®çš„Xåæ ‡åˆ†é…
   - âœ… å­¤ç«‹èŠ‚ç‚¹ï¼ˆæ— å­èŠ‚ç‚¹çš„endpointï¼‰è·å¾—ä¸“é—¨çš„ä½ç½®è®¡ç®—é€»è¾‘
   - âœ… å¢å¼ºé‡å æ£€æµ‹å’Œè§£å†³æœºåˆ¶çš„å¯è§‚æµ‹æ€§
   - âœ… æ”¹å–„endpointèŠ‚ç‚¹çš„ä½ç½®åŒæ­¥æœºåˆ¶

## é¢„æœŸæ•ˆæœ

1. **ç›´æ¥æ•ˆæœ**
   - ğŸ¯ ç¬¬ä¸‰å±‚èŠ‚ç‚¹é‡å é—®é¢˜å¾—åˆ°è§£å†³
   - ğŸ“ æ‰€æœ‰èŠ‚ç‚¹éƒ½èƒ½è·å¾—æ­£ç¡®çš„Xåæ ‡åˆ†é…
   - ğŸ”„ endpointèŠ‚ç‚¹çš„å†…éƒ¨ä½ç½®ä¸å¸ƒå±€å¼•æ“ä¿æŒåŒæ­¥
   - ğŸ“Š æä¾›è¯¦ç»†çš„ä½ç½®è®¡ç®—å’Œé‡å è§£å†³æ—¥å¿—

2. **é—´æ¥æ•ˆæœ**
   - ğŸ”§ æå‡æ··åˆå±‚çº§çš„å¸ƒå±€ç¨³å®šæ€§
   - ğŸ›¡ï¸ å¢å¼ºå¯¹å­¤ç«‹èŠ‚ç‚¹çš„å¤„ç†èƒ½åŠ›
   - ğŸ“ˆ æ”¹å–„å¸ƒå±€å¼•æ“çš„å¯è°ƒè¯•æ€§
   - âš¡ å‡å°‘å› ä½ç½®è®¡ç®—é”™è¯¯å¯¼è‡´çš„å¸ƒå±€é—®é¢˜

## æµ‹è¯•éªŒè¯

### éªŒè¯è¦ç‚¹

1. **ç¬¬ä¸‰å±‚èŠ‚ç‚¹åˆ†å¸ƒ**
   - ç¡®è®¤æ™®é€šèŠ‚ç‚¹å’ŒendpointèŠ‚ç‚¹éƒ½æœ‰æ­£ç¡®çš„Xåæ ‡
   - éªŒè¯èŠ‚ç‚¹é—´è·ç¬¦åˆæœ€å°é—´è·è¦æ±‚

2. **ä½ç½®åŒæ­¥**
   - ç¡®è®¤endpointèŠ‚ç‚¹çš„å†…éƒ¨ä½ç½®ä¸å¸ƒå±€å¼•æ“è®¡ç®—çš„ä½ç½®ä¸€è‡´
   - éªŒè¯é¢„è§ˆçº¿çš„ç»ˆç‚¹ä½ç½®æ­£ç¡®

3. **æ—¥å¿—è¾“å‡º**
   - ç¡®è®¤é‡å è§£å†³è¿‡ç¨‹æœ‰è¯¦ç»†çš„æ—¥å¿—è®°å½•
   - éªŒè¯å­¤ç«‹èŠ‚ç‚¹çš„å¤„ç†æ—¥å¿—æ­£ç¡®è¾“å‡º

### æµ‹è¯•åœºæ™¯

1. **åŸºæœ¬åœºæ™¯**ï¼šç¬¬ä¸‰å±‚åŒ…å«1ä¸ªæ™®é€šèŠ‚ç‚¹å’Œ1ä¸ªendpointèŠ‚ç‚¹
2. **å¤æ‚åœºæ™¯**ï¼šç¬¬ä¸‰å±‚åŒ…å«å¤šä¸ªæ™®é€šèŠ‚ç‚¹å’Œå¤šä¸ªendpointèŠ‚ç‚¹
3. **è¾¹ç•Œåœºæ™¯**ï¼šç¬¬ä¸‰å±‚åªåŒ…å«endpointèŠ‚ç‚¹ï¼ˆæ— æ™®é€šèŠ‚ç‚¹ï¼‰

## æ€»ç»“

æœ¬æ¬¡ä¿®å¤ä¸»è¦è§£å†³äº†æ··åˆå±‚çº§ä¸­èŠ‚ç‚¹é‡å çš„é—®é¢˜ï¼Œé€šè¿‡å¢å¼ºçˆ¶å±‚ä½ç½®è®¡ç®—å’Œé‡å è§£å†³æœºåˆ¶ï¼Œç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹éƒ½èƒ½è·å¾—æ­£ç¡®çš„ä½ç½®åˆ†é…ã€‚ä¿®å¤åçš„ç³»ç»Ÿèƒ½å¤Ÿæ›´å¥½åœ°å¤„ç†æ™®é€šèŠ‚ç‚¹å’ŒendpointèŠ‚ç‚¹çš„æ··åˆå¸ƒå±€ï¼Œæå‡äº†å¸ƒå±€å¼•æ“çš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚