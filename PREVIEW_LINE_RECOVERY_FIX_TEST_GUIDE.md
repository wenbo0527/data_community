# 预览线恢复问题修复测试指南

## 修复内容

### 问题描述
删除节点时，预览线管理器会被多次触发，包括对拖拽提示点（drag-hint）和预览相关节点的处理，导致不必要的预览线恢复逻辑执行。同时，连接检查逻辑在删除过程中存在时序问题。

### 根本原因
1. **拖拽提示点删除触发恢复**：删除主节点时，相关的拖拽提示点也会被删除，每次删除都会触发预览线恢复逻辑
2. **预览相关节点处理**：预览线本身的组件（如预览边、提示点）被删除时也会触发恢复逻辑
3. **重复处理**：同一个删除操作可能触发多次恢复检查
4. **连接检查时序问题**：在 `shouldCreatePreviewLine` 方法中，`hasExistingConnections` 检查时没有排除即将被删除的边，导致判断不准确

### 修复方案

#### 1. 节点类型过滤
**文件**: `src/utils/UnifiedPreviewLineManager.js`

**修改内容**:
```javascript
// 检查是否是拖拽提示点或预览相关节点
const nodeData = node.getData() || {}
const nodeType = nodeData.type
const isDragHint = nodeData.isDragHint || nodeType === 'drag-hint'
const isPreviewRelated = nodeData.isUnifiedPreview || nodeData.isPersistentPreview || 
                        nodeData.isPreview || nodeType === 'unified-preview-line'

if (isDragHint || isPreviewRelated) {
  console.log('🗑️ [统一预览线管理器] 跳过拖拽提示点或预览相关节点的删除处理:', {
    nodeId: node.id,
    nodeType: nodeType,
    isDragHint: isDragHint,
    isPreviewRelated: isPreviewRelated
  })
  return
}
```

#### 2. 过滤逻辑说明
- **拖拽提示点过滤**：`isDragHint` 或 `type === 'drag-hint'`
- **预览相关节点过滤**：
  - `isUnifiedPreview`：统一预览线节点
  - `isPersistentPreview`：持久预览线节点
  - `isPreview`：一般预览节点
  - `type === 'unified-preview-line'`：预览线类型节点

## 测试步骤

### 1. 基础删除测试

#### 测试场景 1：单节点删除（无预览线恢复）
1. **操作**：创建一个简单的流程：开始节点 → 节点A
2. **操作**：删除节点A
3. **预期结果**：
   - ✅ 节点A被成功删除
   - ✅ 开始节点的预览线被恢复
   - ✅ 控制台日志中只有一次预览线恢复处理
   - ✅ 没有拖拽提示点的删除处理日志

#### 测试场景 2：有预览线的节点删除
1. **操作**：创建流程：开始节点 → 节点A，节点A有预览线
2. **操作**：删除节点A
3. **预期结果**：
   - ✅ 节点A和其预览线被删除
   - ✅ 开始节点的预览线被恢复
   - ✅ 拖拽提示点删除不触发恢复逻辑

### 2. 复杂场景测试

#### 测试场景 3：分支节点删除
1. **操作**：创建有分支的流程：开始节点 → 分支节点 → 多个子节点
2. **操作**：删除分支节点
3. **预期结果**：
   - ✅ 分支节点及其子节点被删除
   - ✅ 开始节点的预览线被正确恢复
   - ✅ 每个分支的拖拽提示点删除不触发额外的恢复逻辑

#### 测试场景 4：级联删除
1. **操作**：创建链式流程：开始节点 → 节点A → 节点B → 节点C
2. **操作**：删除节点A（触发级联删除）
3. **预期结果**：
   - ✅ 节点A、B、C被级联删除
   - ✅ 开始节点的预览线被恢复
   - ✅ 只有主节点的删除触发恢复逻辑，拖拽提示点删除被跳过

### 3. 日志验证

#### 正常删除的日志序列（修复后）
```
[TaskFlowCanvas] 开始删除单个节点: node_xxx
[统一预览线管理器] 节点删除事件开始处理: node_xxx
[统一预览线管理器] 调用预览线恢复方法
[统一预览线管理器] 开始检查节点删除后的预览线恢复
[统一预览线管理器] 恢复源节点的预览线
```

#### 应该被跳过的日志（修复后）
```
✅ [统一预览线管理器] 跳过拖拽提示点或预览相关节点的删除处理: hint_unified_preview_xxx
✅ [统一预览线管理器] 跳过拖拽提示点或预览相关节点的删除处理: unified_preview_xxx
```

#### 不应该出现的日志（修复前的问题）
```
❌ [统一预览线管理器] 节点删除事件开始处理: hint_unified_preview_xxx
❌ [统一预览线管理器] 调用预览线恢复方法 (针对拖拽提示点)
❌ [统一预览线管理器] 开始检查节点删除后的预览线恢复: hint_unified_preview_xxx
```

### 4. 性能测试

#### 测试场景 5：大量节点删除
1. **操作**：创建包含10个节点的复杂流程
2. **操作**：删除根节点（触发大量级联删除）
3. **预期结果**：
   - ✅ 删除操作快速完成
   - ✅ 预览线恢复逻辑只针对真实节点执行
   - ✅ 拖拽提示点删除不消耗额外性能

#### 性能指标
- **删除响应时间**：应该比修复前更快
- **日志数量**：预览线恢复相关日志应该显著减少
- **内存使用**：避免不必要的预览线创建和销毁

## 验证方法

### 1. 控制台日志检查
打开浏览器开发者工具，观察删除操作时的日志输出：

**修复成功的标志**：
- 看到 `跳过拖拽提示点或预览相关节点的删除处理` 日志
- 预览线恢复逻辑只针对真实业务节点执行
- 没有针对 `hint_` 开头节点的恢复处理

### 2. 功能完整性检查
- 删除节点后，上游节点的预览线能正确恢复
- 预览线的交互功能正常（拖拽、连接等）
- 没有遗留的预览线组件

### 3. 性能监控
- 删除操作的响应速度
- 浏览器内存使用情况
- 页面渲染性能

## 故障排除

### 如果仍然看到拖拽提示点的恢复处理
1. **检查节点数据**：确认拖拽提示点的 `type` 或 `isDragHint` 属性设置正确
2. **检查过滤条件**：确认过滤逻辑覆盖所有预览相关节点类型
3. **检查事件顺序**：确认过滤逻辑在重复处理检查之前执行

### 如果预览线恢复功能失效
1. **检查过滤范围**：确认没有误过滤真实业务节点
2. **检查节点类型**：确认业务节点的类型不在过滤列表中
3. **检查恢复逻辑**：确认预览线恢复的核心逻辑没有被影响

### 如果性能没有改善
1. **检查日志输出**：确认拖拽提示点删除确实被跳过
2. **检查其他性能瓶颈**：可能存在其他影响性能的因素
3. **监控内存使用**：确认没有内存泄漏

## 相关文件

### 修改的文件
- `src/utils/UnifiedPreviewLineManager.js` - 添加节点类型过滤逻辑

### 相关文档
- `PREVIEW_LINE_TIMING_FIX.md` - 预览线时序问题修复
- `DELETE_BUTTON_FIX_TEST_GUIDE.md` - 删除按钮修复指南

## 预期收益

1. **性能提升**：减少不必要的预览线恢复处理，提高删除操作响应速度
2. **日志清洁**：减少冗余的日志输出，便于问题排查
3. **逻辑清晰**：明确区分业务节点和预览组件的处理逻辑
4. **稳定性增强**：避免预览组件删除引起的意外副作用

---

**测试完成标准**：删除节点时，拖拽提示点和预览相关节点的删除不再触发预览线恢复逻辑，但真实业务节点的预览线恢复功能正常工作。