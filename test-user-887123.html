<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·887123ä¸“é¡¹æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .data-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .status-info { background-color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç”¨æˆ·887123ä¸“é¡¹æµ‹è¯•</h1>
        
        <div class="test-section info">
            <h3>ğŸ“Š æµ‹è¯•æ§åˆ¶é¢æ¿</h3>
            <button onclick="testUserData()">ğŸš€ æµ‹è¯•ç”¨æˆ·æ•°æ®è·å–</button>
            <button onclick="testRenderLogic()">ğŸ­ æµ‹è¯•æ¸²æŸ“é€»è¾‘</button>
            <button onclick="openCustomer360()">ğŸ“„ æ‰“å¼€Customer360é¡µé¢</button>
            <button onclick="testMemoryIssue()">ğŸ§  æµ‹è¯•å†…å­˜é—®é¢˜</button>
            <button onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“ˆ æµ‹è¯•çŠ¶æ€</h3>
            <div id="test-status">
                <div><span class="status-indicator status-info"></span>ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ æµ‹è¯•æ—¥å¿—</h3>
            <div id="log-output" class="log-output">ç­‰å¾…æµ‹è¯•ç»“æœ...
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š ç”¨æˆ·æ•°æ®</h3>
            <div id="data-display" class="data-display">ç­‰å¾…æ•°æ®åŠ è½½...
            </div>
        </div>
    </div>

    <script type="module">
        let logOutput = document.getElementById('log-output');
        let testStatus = document.getElementById('test-status');
        let dataDisplay = document.getElementById('data-display');
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}\n`;
            logOutput.textContent += logEntry;
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            const statusClass = `status-${type}`;
            testStatus.innerHTML = `<div><span class="status-indicator ${statusClass}"></span>${message}</div>`;
        }
        
        function displayData(data, title = 'æ•°æ®') {
            const dataStr = JSON.stringify(data, null, 2);
            dataDisplay.innerHTML = `<h4>${title}</h4><pre>${dataStr}</pre>`;
        }
        
        window.clearAll = function() {
            logOutput.textContent = '';
            dataDisplay.innerHTML = 'ç­‰å¾…æ•°æ®åŠ è½½...';
            updateStatus('å·²æ¸…ç©º', 'info');
        }
        
        // æµ‹è¯•ç”¨æˆ·æ•°æ®è·å–
        window.testUserData = async function() {
            addLog('ğŸš€ å¼€å§‹æµ‹è¯•ç”¨æˆ·887123æ•°æ®è·å–...');
            updateStatus('æ­£åœ¨æµ‹è¯•æ•°æ®è·å–...', 'warning');
            
            try {
                // åŠ¨æ€å¯¼å…¥APIå‡½æ•°
                addLog('ğŸ“¦ å¯¼å…¥APIæ¨¡å—...');
                const { fetchUserInfo } = await import('./src/mock/customer360.ts');
                addLog('âœ… APIæ¨¡å—å¯¼å…¥æˆåŠŸ');
                
                // æµ‹è¯•APIè°ƒç”¨
                addLog('ğŸ“ è°ƒç”¨ fetchUserInfo("887123")...');
                const startTime = performance.now();
                const result = await fetchUserInfo('887123');
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);
                
                addLog(`âœ… APIè°ƒç”¨å®Œæˆï¼Œè€—æ—¶: ${duration}ms`);
                addLog(`ğŸ“Š è¿”å›æ•°æ®ç±»å‹: ${typeof result}`);
                addLog(`ğŸ“Š æ•°æ®æ˜¯å¦ä¸ºnull: ${result === null}`);
                addLog(`ğŸ“Š æ•°æ®æ˜¯å¦ä¸ºundefined: ${result === undefined}`);
                
                if (result) {
                    if (result.error) {
                        addLog(`âŒ APIè¿”å›é”™è¯¯: ${result.error}`);
                        addLog(`âŒ é”™è¯¯æ¶ˆæ¯: ${result.message}`);
                        updateStatus('APIè¿”å›é”™è¯¯', 'error');
                        displayData(result, 'APIé”™è¯¯å“åº”');
                    } else {
                        addLog('âœ… APIè¿”å›æ­£å¸¸æ•°æ®');
                        addLog(`ğŸ“Š æ•°æ®é”®: ${Object.keys(result).join(', ')}`);
                        
                        // æ£€æŸ¥å…³é”®å­—æ®µ
                        const checks = {
                            'basicInfo': !!result.basicInfo,
                            'name': !!result.basicInfo?.name,
                            'age': !!result.basicInfo?.age,
                            'phone': !!result.basicInfo?.phone,
                            'depositProducts': Array.isArray(result.depositProducts),
                            'loanProducts': Array.isArray(result.loanProducts),
                            'creditsList': Array.isArray(result.creditsList),
                            'loanRecords': Array.isArray(result.loanRecords),
                            'quotaAdjustHistory': Array.isArray(result.quotaAdjustHistory)
                        };
                        
                        addLog('ğŸ” å…³é”®å­—æ®µæ£€æŸ¥:');
                        Object.entries(checks).forEach(([key, value]) => {
                            addLog(`  ${key}: ${value ? 'âœ…' : 'âŒ'}`);
                        });
                        
                        // æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
                        if (result.basicInfo) {
                            addLog('ğŸ‘¤ ç”¨æˆ·åŸºæœ¬ä¿¡æ¯:');
                            addLog(`  å§“å: ${result.basicInfo.name}`);
                            addLog(`  å¹´é¾„: ${result.basicInfo.age}`);
                            addLog(`  æ€§åˆ«: ${result.basicInfo.gender}`);
                            addLog(`  æ‰‹æœº: ${result.basicInfo.phone}`);
                            addLog(`  å®¢æˆ·å·: ${result.basicInfo.customerNo}`);
                        }
                        
                        // æ˜¾ç¤ºäº§å“ä¿¡æ¯
                        addLog('ğŸ¦ äº§å“ä¿¡æ¯:');
                        addLog(`  å­˜æ¬¾äº§å“: ${result.depositProducts?.length || 0} ä¸ª`);
                        addLog(`  è´·æ¬¾äº§å“: ${result.loanProducts?.length || 0} ä¸ª`);
                        addLog(`  å¾ä¿¡è®°å½•: ${result.creditsList?.length || 0} æ¡`);
                        addLog(`  è´·æ¬¾è®°å½•: ${result.loanRecords?.length || 0} æ¡`);
                        addLog(`  é¢åº¦è°ƒæ•´: ${result.quotaAdjustHistory?.length || 0} æ¡`);
                        
                        updateStatus('æ•°æ®è·å–æˆåŠŸ', 'success');
                        displayData(result, 'ç”¨æˆ·887123å®Œæ•´æ•°æ®');
                    }
                } else {
                    addLog('âŒ APIè¿”å›nullæˆ–undefined');
                    updateStatus('APIè¿”å›ç©ºæ•°æ®', 'error');
                }
                
            } catch (error) {
                addLog(`âŒ æ•°æ®è·å–å¼‚å¸¸: ${error.message}`);
                addLog(`âŒ é”™è¯¯å †æ ˆ: ${error.stack}`);
                updateStatus('æ•°æ®è·å–å¤±è´¥', 'error');
                displayData({ error: error.message, stack: error.stack }, 'APIè°ƒç”¨å¼‚å¸¸');
            }
        }
        
        // æµ‹è¯•æ¸²æŸ“é€»è¾‘
        window.testRenderLogic = async function() {
            addLog('ğŸ­ å¼€å§‹æµ‹è¯•æ¸²æŸ“é€»è¾‘...');
            updateStatus('æ­£åœ¨æµ‹è¯•æ¸²æŸ“é€»è¾‘...', 'warning');
            
            try {
                // è·å–ç”¨æˆ·æ•°æ®
                const { fetchUserInfo } = await import('./src/mock/customer360.ts');
                const userInfo = await fetchUserInfo('887123');
                
                // æ¨¡æ‹ŸVueç»„ä»¶çš„çŠ¶æ€
                let loading = true;
                let error = null;
                
                addLog('ğŸ“Š åˆå§‹çŠ¶æ€:');
                addLog(`  loading: ${loading}`);
                addLog(`  userInfo: ${userInfo ? 'æœ‰æ•°æ®' : 'null'}`);
                addLog(`  error: ${error}`);
                
                // æ¨¡æ‹Ÿæ•°æ®è·å–å®Œæˆ
                loading = false;
                
                addLog('ğŸ“Š æ•°æ®è·å–åçŠ¶æ€:');
                addLog(`  loading: ${loading}`);
                addLog(`  userInfo: ${userInfo ? (userInfo.error ? 'é”™è¯¯å¯¹è±¡' : 'æ­£å¸¸æ•°æ®') : 'null'}`);
                addLog(`  error: ${error}`);
                
                // æ¨¡æ‹Ÿæ¡ä»¶æ¸²æŸ“é€»è¾‘
                addLog('ğŸ­ æ¡ä»¶æ¸²æŸ“åˆ¤æ–­:');
                if (loading) {
                    addLog('  â†’ åº”è¯¥æ˜¾ç¤º: åŠ è½½çŠ¶æ€ (a-spin)');
                } else if (userInfo && userInfo.error) {
                    addLog('  â†’ åº”è¯¥æ˜¾ç¤º: é”™è¯¯é¡µé¢');
                    addLog(`    é”™è¯¯ç±»å‹: ${userInfo.error}`);
                    addLog(`    é”™è¯¯æ¶ˆæ¯: ${userInfo.message}`);
                } else if (!userInfo) {
                    addLog('  â†’ åº”è¯¥æ˜¾ç¤º: æ— æ•°æ®çŠ¶æ€');
                } else {
                    addLog('  â†’ åº”è¯¥æ˜¾ç¤º: ä¸»è¦å†…å®¹');
                    addLog('    åŒ…å«: å®¢æˆ·æ¦‚è§ˆå¡ç‰‡ã€äº§å“ä¿¡æ¯æ¨¡å—ç­‰');
                }
                
                // æ£€æŸ¥è®¡ç®—å±æ€§
                if (userInfo && !userInfo.error) {
                    addLog('ğŸ§® è®¡ç®—å±æ€§æ£€æŸ¥:');
                    
                    // æ¨¡æ‹ŸselfProductDataè®¡ç®—å±æ€§
                    const selfProducts = userInfo.depositProducts || [];
                    addLog(`  selfProducts: ${selfProducts.length} ä¸ª`);
                    
                    // æ¨¡æ‹ŸloanProductDataè®¡ç®—å±æ€§
                    const loanProducts = userInfo.loanProducts || [];
                    addLog(`  loanProducts: ${loanProducts.length} ä¸ª`);
                    
                    // æ¨¡æ‹ŸcreditDataè®¡ç®—å±æ€§
                    const creditData = userInfo.creditsList || [];
                    addLog(`  creditData: ${creditData.length} æ¡`);
                    
                    // æ¨¡æ‹ŸloanDataè®¡ç®—å±æ€§
                    const loanData = userInfo.loanRecords || [];
                    addLog(`  loanData: ${loanData.length} æ¡`);
                    
                    // æ¨¡æ‹ŸadjustmentDataè®¡ç®—å±æ€§
                    const adjustmentData = userInfo.quotaAdjustHistory || [];
                    addLog(`  adjustmentData: ${adjustmentData.length} æ¡`);
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®æ˜¾ç¤º
                    const hasAnyData = selfProducts.length > 0 || loanProducts.length > 0 || 
                                     creditData.length > 0 || loanData.length > 0 || adjustmentData.length > 0;
                    
                    addLog(`  æ˜¯å¦æœ‰æ•°æ®å¯æ˜¾ç¤º: ${hasAnyData ? 'æ˜¯' : 'å¦'}`);
                    
                    if (!hasAnyData) {
                        addLog('  âš ï¸ è­¦å‘Š: æ‰€æœ‰æ•°æ®æ•°ç»„éƒ½ä¸ºç©ºï¼Œé¡µé¢å¯èƒ½æ˜¾ç¤ºä¸ºç©ºç™½');
                    }
                }
                
                updateStatus('æ¸²æŸ“é€»è¾‘æµ‹è¯•å®Œæˆ', 'success');
                
            } catch (error) {
                addLog(`âŒ æ¸²æŸ“é€»è¾‘æµ‹è¯•å¤±è´¥: ${error.message}`);
                updateStatus('æ¸²æŸ“é€»è¾‘æµ‹è¯•å¤±è´¥', 'error');
            }
        }
        
        // æ‰“å¼€Customer360é¡µé¢
        window.openCustomer360 = function() {
            addLog('ğŸ“„ æ‰“å¼€Customer360é¡µé¢...');
            const url = '/discovery/customer360/887123';
            const newWindow = window.open(url, '_blank');
            
            if (newWindow) {
                addLog('âœ… é¡µé¢å·²åœ¨æ–°çª—å£ä¸­æ‰“å¼€');
                addLog(`ğŸ”— URL: ${url}`);
                updateStatus('é¡µé¢å·²æ‰“å¼€', 'success');
                
                // ç›‘å¬é¡µé¢åŠ è½½äº‹ä»¶
                newWindow.addEventListener('load', () => {
                    addLog('âœ… é¡µé¢åŠ è½½å®Œæˆ');
                });
                
                newWindow.addEventListener('error', (e) => {
                    addLog(`âŒ é¡µé¢åŠ è½½é”™è¯¯: ${e.message}`);
                });
            } else {
                addLog('âŒ æ— æ³•æ‰“å¼€é¡µé¢ï¼ˆå¯èƒ½è¢«å¼¹çª—æ‹¦æˆªï¼‰');
                updateStatus('é¡µé¢æ‰“å¼€å¤±è´¥', 'error');
            }
        }
        
        // æµ‹è¯•å†…å­˜é—®é¢˜
        window.testMemoryIssue = function() {
            addLog('ğŸ§  å¼€å§‹æµ‹è¯•å†…å­˜é—®é¢˜...');
            updateStatus('æ­£åœ¨æ£€æŸ¥å†…å­˜é—®é¢˜...', 'warning');
            
            // æ£€æŸ¥EventEmitterç›‘å¬å™¨
            addLog('ğŸ” æ£€æŸ¥EventEmitterç›‘å¬å™¨...');
            
            // æ¨¡æ‹Ÿå¤šæ¬¡APIè°ƒç”¨ï¼Œçœ‹æ˜¯å¦ä¼šç´¯ç§¯ç›‘å¬å™¨
            let callCount = 0;
            const maxCalls = 10;
            
            const testMultipleCalls = async () => {
                try {
                    const { fetchUserInfo } = await import('./src/mock/customer360.ts');
                    
                    for (let i = 0; i < maxCalls; i++) {
                        callCount++;
                        addLog(`ğŸ“ ç¬¬${callCount}æ¬¡APIè°ƒç”¨...`);
                        
                        const result = await fetchUserInfo('887123');
                        
                        if (result && !result.error) {
                            addLog(`âœ… ç¬¬${callCount}æ¬¡è°ƒç”¨æˆåŠŸ`);
                        } else {
                            addLog(`âŒ ç¬¬${callCount}æ¬¡è°ƒç”¨å¤±è´¥`);
                        }
                        
                        // æ£€æŸ¥å†…å­˜ä½¿ç”¨
                        if (performance.memory) {
                            const memory = performance.memory;
                            const usedMB = (memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
                            addLog(`ğŸ“Š å†…å­˜ä½¿ç”¨: ${usedMB} MB`);
                        }
                        
                        // çŸ­æš‚å»¶è¿Ÿ
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    addLog('âœ… å¤šæ¬¡è°ƒç”¨æµ‹è¯•å®Œæˆ');
                    updateStatus('å†…å­˜æµ‹è¯•å®Œæˆ', 'success');
                    
                } catch (error) {
                    addLog(`âŒ å†…å­˜æµ‹è¯•å¤±è´¥: ${error.message}`);
                    updateStatus('å†…å­˜æµ‹è¯•å¤±è´¥', 'error');
                }
            };
            
            testMultipleCalls();
        }
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºåˆå§‹ä¿¡æ¯
        addLog('ğŸ‰ ç”¨æˆ·887123ä¸“é¡¹æµ‹è¯•å·¥å…·å·²åŠ è½½');
        addLog('ğŸ’¡ ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•');
        addLog('ğŸ¯ ä¸“é—¨é’ˆå¯¹ç”¨æˆ·ID: 887123');
    </script>
</body>
</html>