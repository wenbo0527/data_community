# 预览线问题深度排查方案

## 问题现状分析

### 当前症状
- ✅ 单元测试通过：NodeMethodValidator工具类功能正常
- ✅ 模拟环境测试通过：节点验证和安全包装器创建成功
- ❌ 实际应用失效：预览线仍然无法正常创建和显示
- ❌ 控制台错误：`sourceNode.getData is not a function`

### 问题分析
测试环境与实际运行环境存在差异，说明问题可能出现在：
1. **X6图形库集成层面**：实际X6节点对象与模拟对象行为不一致
2. **异步时序问题**：节点添加、初始化、方法调用的时序不匹配
3. **状态管理问题**：节点状态在传递过程中丢失或变化
4. **模块加载问题**：NodeMethodValidator未正确集成到实际流程中

## 深度排查计划

### 第一阶段：画布初始化流程分析

#### 1.1 X6画布初始化流程梳理
- [ ] 分析TaskFlowCanvas.vue中的画布初始化代码
- [ ] 检查useCanvasNodes.js中的节点管理逻辑
- [ ] 验证x6Config.js中的图形配置是否正确
- [ ] 确认Graph实例创建和节点注册流程

#### 1.2 PreviewLineSystem集成点分析
- [ ] 检查PreviewLineSystem在画布中的初始化时机
- [ ] 验证PreviewLineSystem与X6 Graph的绑定关系
- [ ] 分析事件监听器注册是否成功
- [ ] 确认模块依赖加载顺序

### 第二阶段：节点生命周期追踪

#### 2.1 节点创建流程追踪
- [ ] 在addNodeToGraph方法中添加详细日志
- [ ] 追踪X6节点从创建到添加到图中的完整流程
- [ ] 验证节点数据结构在各个阶段的完整性
- [ ] 检查节点方法在不同阶段的可用性

#### 2.2 预览线创建时机分析
- [ ] 分析node:added事件触发时机
- [ ] 检查createPreviewLinesForExistingNodes调用时机
- [ ] 验证节点配置状态检查逻辑
- [ ] 确认异步延迟处理是否足够

### 第三阶段：实际运行环境调试

#### 3.1 运行时节点对象分析
- [ ] 在实际环境中打印节点对象结构
- [ ] 对比实际节点与测试节点的差异
- [ ] 检查节点原型链和方法继承
- [ ] 验证X6版本兼容性问题

#### 3.2 NodeMethodValidator集成验证
- [ ] 确认NodeMethodValidator在实际环境中是否被正确调用
- [ ] 验证安全包装器在实际节点上的效果
- [ ] 检查验证结果是否正确传递
- [ ] 分析包装器节点是否能正常工作

### 第四阶段：错误定位和修复

#### 4.1 错误源头定位
- [ ] 使用浏览器调试工具设置断点
- [ ] 追踪`sourceNode.getData is not a function`错误的确切位置
- [ ] 分析错误发生时的调用栈
- [ ] 确定节点对象在哪个环节失效

#### 4.2 修复方案制定
- [ ] 根据错误源头制定针对性修复方案
- [ ] 考虑X6版本升级或降级
- [ ] 评估是否需要重构节点管理逻辑
- [ ] 制定渐进式修复策略

## 排查工具和方法

### 调试工具
1. **浏览器开发者工具**
   - Console面板：查看错误日志和调试输出
   - Sources面板：设置断点和单步调试
   - Network面板：检查模块加载情况

2. **自定义调试工具**
   - 节点对象检查器：实时分析节点结构
   - 预览线状态监控器：追踪预览线创建过程
   - 事件流追踪器：监控X6事件触发

### 日志策略
1. **分层日志**
   - 🔧 系统级：模块加载、初始化
   - 📊 业务级：节点操作、预览线创建
   - 🐛 调试级：详细的对象状态和方法调用

2. **关键检查点**
   - Graph初始化完成
   - 节点添加到图中
   - PreviewLineSystem初始化
   - 预览线创建请求
   - 节点方法验证结果

## 预期成果

### 短期目标（1-2天）
- 定位`sourceNode.getData is not a function`错误的根本原因
- 确认NodeMethodValidator是否在实际环境中生效
- 制定具体的修复方案

### 中期目标（3-5天）
- 实现稳定的预览线创建功能
- 完善错误处理和容错机制
- 优化节点验证和包装逻辑

### 长期目标（1-2周）
- 建立完善的预览线系统测试覆盖
- 优化性能和用户体验
- 形成可维护的代码架构

## 风险评估

### 高风险项
- X6版本兼容性问题可能需要大量重构
- 异步时序问题可能影响整体架构设计

### 中风险项
- 节点状态管理可能需要重新设计
- 预览线渲染逻辑可能需要优化

### 低风险项
- 日志和调试工具的添加
- 错误处理机制的完善

## 执行计划

### 第1天：环境分析
- 上午：画布初始化流程分析
- 下午：PreviewLineSystem集成点分析

### 第2天：节点追踪
- 上午：节点创建流程追踪
- 下午：预览线创建时机分析

### 第3天：实际调试
- 上午：运行时节点对象分析
- 下午：NodeMethodValidator集成验证

### 第4天：错误定位
- 上午：错误源头定位
- 下午：修复方案制定

### 第5天：实施修复
- 全天：根据排查结果实施修复方案

---

**注意：此方案需要人工确认后再开始实施，确保排查方向正确且不影响现有功能。**