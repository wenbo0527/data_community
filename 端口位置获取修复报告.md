# 端口位置获取修复报告

## 问题描述

在重绘总结日志功能中，端口位置信息显示为 `绝对位置(NaN, NaN), 相对位置(0, 0)`，无法正确获取端口的实际位置。

## 问题分析

### 原始问题
- `node.getPortProp(port.id, 'position')` 返回的是端口配置对象，而非直接的坐标值
- 端口位置需要根据配置信息（如 `position.name` 和 `position.args`）进行计算
- 原代码直接使用配置对象的 `x` 和 `y` 属性，导致获取到 `undefined` 值

### 端口配置结构
```javascript
// 端口配置示例
{
  name: 'bottom',  // 端口位置类型：top, bottom, left, right
  args: {
    x: '50%',      // X轴位置（百分比或像素值）
    y: 0,          // Y轴位置
    dx: 0,         // X轴偏移
    dy: 0          // Y轴偏移
  }
}
```

## 修复方案

### 1. 端口位置计算逻辑
根据端口配置的 `name` 属性，实现不同位置类型的坐标计算：

- **bottom**: 端口在节点底部
  - `portX = size.width * xPercent + dx`
  - `portY = size.height + dy`

- **top**: 端口在节点顶部
  - `portX = size.width * xPercent + dx`
  - `portY = dy`

- **left**: 端口在节点左侧
  - `portX = dx`
  - `portY = size.height * yPercent + dy`

- **right**: 端口在节点右侧
  - `portX = size.width + dx`
  - `portY = size.height * yPercent + dy`

### 2. 百分比处理
支持百分比形式的位置参数：
```javascript
const xPercent = typeof args.x === 'string' && args.x.includes('%') ? 
  parseFloat(args.x) / 100 : 0.5
```

### 3. 绝对位置计算
```javascript
absoluteX = position.x + portX
absoluteY = position.y + portY
```

## 修复内容

### 修复前代码
```javascript
const portPosition = node.getPortProp(port.id, 'position')
const portInfo = {
  position: portPosition ? {
    x: Math.round(portPosition.x),
    y: Math.round(portPosition.y)
  } : null,
  absolutePosition: portPosition ? {
    x: Math.round(position.x + portPosition.x),
    y: Math.round(position.y + portPosition.y)
  } : null
}
```

### 修复后代码
```javascript
const portConfig = node.getPortProp(port.id, 'position') || {}

// 计算端口的实际位置
let portX = 0, portY = 0
let absoluteX = position.x, absoluteY = position.y

if (portConfig.name === 'bottom') {
  const args = portConfig.args || {}
  const xPercent = typeof args.x === 'string' && args.x.includes('%') ? 
    parseFloat(args.x) / 100 : 0.5
  portX = size.width * xPercent + (args.dx || 0)
  portY = size.height + (args.dy || 0)
  absoluteX = position.x + portX
  absoluteY = position.y + portY
}
// ... 其他位置类型的处理

const portInfo = {
  config: portConfig.name || 'unknown',
  position: {
    x: Math.round(portX),
    y: Math.round(portY)
  },
  absolutePosition: {
    x: Math.round(absoluteX),
    y: Math.round(absoluteY)
  }
}
```

## 修复效果

### 1. 正确的位置信息
- 端口相对位置：相对于节点的偏移坐标
- 端口绝对位置：在画布上的实际坐标
- 端口配置信息：显示端口的位置类型（top/bottom/left/right）

### 2. 增强的日志输出
```
🔌 [重绘总结] 输入端口位置详情:
  1. 输入端口 (in) 在节点 node_xxx: 绝对位置(1042, 105), 相对位置(0, 50), 配置: left

🔌 [重绘总结] 输出端口位置详情:
  1. 输出端口 (out) 在节点 node_xxx: 绝对位置(1092, 155), 相对位置(50, 100), 配置: bottom
```

## 技术要点

### 1. 端口配置解析
- 正确解析端口的 `position` 配置对象
- 处理不同的位置类型（top/bottom/left/right）
- 支持百分比和像素值的混合使用

### 2. 坐标系统
- 相对坐标：相对于节点左上角的偏移
- 绝对坐标：在整个画布坐标系中的位置
- 考虑节点的位置和尺寸

### 3. 容错处理
- 处理缺失的配置信息
- 提供默认值避免计算错误
- 确保数值的有效性

## 验证方法

1. **启动开发服务器**
   ```bash
   npm run dev
   ```

2. **访问画布页面**
   - 打开 `http://localhost:5175/`
   - 进入营销任务画布

3. **触发布局切换**
   - 切换布局方向（TB ↔ LR）
   - 观察控制台的重绘总结日志

4. **检查端口位置**
   - 确认端口位置不再显示 `NaN`
   - 验证相对位置和绝对位置的合理性
   - 检查端口配置信息的正确性

## 应用场景

1. **布局调试**：准确了解端口在不同布局方向下的位置
2. **连接线优化**：基于准确的端口位置优化连接线路径
3. **交互增强**：为端口相关的交互功能提供精确的位置信息
4. **质量保证**：通过位置信息验证布局的正确性

## 注意事项

1. **布局方向适配**：不同布局方向下端口配置可能不同
2. **节点类型差异**：不同类型节点的端口配置可能有所差异
3. **动态更新**：节点移动或调整大小时需要重新计算端口位置
4. **性能考虑**：大量节点时端口位置计算的性能影响

## 总结

通过修复端口位置获取逻辑，重绘总结日志现在能够：
- ✅ 正确显示端口的相对位置和绝对位置
- ✅ 提供端口配置信息（top/bottom/left/right）
- ✅ 支持不同布局方向下的端口位置计算
- ✅ 增强布局调试和质量分析的准确性

这个修复确保了重绘总结日志功能的完整性和准确性，为后续的布局优化和调试提供了可靠的数据支持。