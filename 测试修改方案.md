# 营销画布测试代码修改方案

## 1. 问题分析

### 1.1 预览线endpoint坐标测试覆盖情况

**当前测试覆盖的场景：**
- ✅ 基础预览线起始坐标计算（coordinate-consistency.test.ts:219-261）
- ✅ 预览线路径坐标转换（coordinate-consistency.test.ts:231-248）
- ✅ 端口位置计算（coordinate-consistency.test.ts:249-261）
- ✅ 预览线终点计算（SnapCoordinateSystem.test.js:393-441）
- ✅ 拖拽提示点创建（SnapCoordinateSystem.test.js:415-441）

**缺失的关键测试场景：**
- ❌ 手动布局模式下移动节点后预览线endpoint刷新
- ❌ 移动画布新建节点时预览线刷新位置一致性
- ❌ 吸附时预览线连接到in端口的坐标准确性
- ❌ 拖拽过程中预览线endpoint实时更新
- ❌ 不同节点类型的endpoint坐标计算差异

### 1.2 节点类型使用情况

**当前测试中的节点类型混用问题：**
- 旧系统节点类型：INPUT、PROCESSING、OUTPUT（workflowNodeTypes.js）
- 营销画布节点类型：start、audience-split、event-split、sms、ai-call、manual-call、ab-test、wait、end（nodeTypes.js）

**需要更新的测试文件：**
- WorkflowEditor.test.js（使用INPUT、PROCESSING）
- workflow-editor.test.js（使用NodeType.INPUT、NodeType.FILTER）
- workflowNodeTypes.test.js（测试旧节点类型定义）
- WorkflowEditor.integration.test.js（可能涉及节点类型）

## 2. 修改方案

### 2.1 预览线endpoint坐标测试增强

#### 2.1.1 新增测试文件：`preview-line-endpoint.test.ts`

```typescript
/**
 * 预览线endpoint坐标专项测试
 * 重点测试手动布局、画布移动、吸附连接等场景下的坐标一致性
 */

// 测试用例结构：
// 1. 手动布局模式下的endpoint坐标测试
//    - 移动节点后预览线endpoint刷新
//    - 节点位置变化时endpoint坐标同步
//    - 多个预览线同时刷新的坐标一致性
// 
// 2. 画布移动场景下的endpoint坐标测试
//    - 画布平移后新建节点的预览线位置
//    - 画布缩放后endpoint坐标计算
//    - 画布变换后预览线路径重计算
//
// 3. 吸附连接到in端口的坐标测试
//    - 吸附检测时endpoint到in端口的距离计算
//    - 吸附完成后预览线endpoint精确连接
//    - 不同节点大小下in端口位置计算
//
// 4. 拖拽过程中endpoint实时更新测试
//    - 拖拽开始时endpoint初始位置
//    - 拖拽过程中endpoint跟随鼠标
//    - 拖拽结束时endpoint最终位置确认
```

#### 2.1.2 增强现有测试文件

**coordinate-consistency.test.ts 增强：**
- 添加手动布局模式下的预览线endpoint测试
- 添加画布变换后的坐标一致性测试
- 添加吸附到in端口的精确坐标测试

**DragInteractionManager.test.ts 增强：**
- 添加拖拽过程中预览线endpoint更新测试
- 添加吸附时endpoint坐标修正测试

### 2.2 营销画布节点类型测试更新

#### 2.2.1 节点类型分类

**开始节点（start）：**
- 特性：只有输出端口，无输入端口
- 连接规则：只能作为连接的起点
- 特殊测试：验证无法连接到start节点的输入端口

**分支节点（audience-split、event-split、ab-test）：**
- 特性：一个输入端口，多个输出端口
- 连接规则：支持多分支输出
- 特殊测试：验证多分支预览线创建和管理

**结束节点（end）：**
- 特性：只有输入端口，无输出端口
- 连接规则：只能作为连接的终点
- 特殊测试：验证无法从end节点创建输出连接

**普通节点（sms、ai-call、manual-call、wait）：**
- 特性：一个输入端口，一个输出端口
- 连接规则：标准的单输入单输出
- 特殊测试：验证标准连接流程

#### 2.2.2 需要更新的测试文件

**1. 更新 DragInteractionManager.test.ts**
```typescript
// 替换节点类型使用
// 旧：createMockNode('test-node',