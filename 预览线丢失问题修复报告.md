# 预览线丢失问题修复报告

## 问题描述

在点击布局切换后，预览线在重绘总结日志中显示数量为0，但实际上预览线应该存在。

### 问题现象
- 画布初始化时：显示有1条预览线（图形）和1个预览线实例
- 布局切换后：重绘总结显示预览线数量为0条
- 实际情况：预览线仍然存在，但没有被正确识别和统计

## 问题分析

### 根本原因
`logRedrawSummary` 函数中的预览线识别逻辑不完整，缺少对统一预览线管理器创建的预览线的识别。

### 技术细节

#### 1. 预览线数据标识
统一预览线管理器创建的预览线使用以下数据标识：
```javascript
data: {
  type: 'unified-preview-line',
  isUnifiedPreview: true,  // 关键标识字段
  sourceNodeId: sourceNode.id,
  previewType: type,
  branchId: branchId,
  // ... 其他字段
}
```

#### 2. 原有识别逻辑
```javascript
// 修复前的识别条件
if (edgeData.isPersistentPreview || edgeData.isPreview || edge.id.includes('preview')) {
  edgesSummary.previews.push(edgeInfo)
} else {
  edgesSummary.connections.push(edgeInfo)
}
```

#### 3. 问题所在
原有识别条件缺少对 `isUnifiedPreview` 字段的检查，导致统一预览线管理器创建的预览线被错误地归类为普通连接线。

## 修复方案

### 修复内容
在 `useStructuredLayout.js` 文件的 `logRedrawSummary` 函数中，更新预览线识别逻辑：

```javascript
// 修复后的识别条件
if (edgeData.isPersistentPreview || edgeData.isPreview || edgeData.isUnifiedPreview || edge.id.includes('preview')) {
  edgesSummary.previews.push(edgeInfo)
} else {
  edgesSummary.connections.push(edgeInfo)
}
```

### 修复位置
- 文件：`src/composables/useStructuredLayout.js`
- 函数：`logRedrawSummary`
- 行数：约1807行

## 修复效果

### 修复前
```
🔗 [重绘总结] 连接线统计:
  ├─ 普通连接: 0 条
  ├─ 预览线: 0 条  ← 错误统计
  └─ 总计: 0 条
```

### 修复后（预期）
```
🔗 [重绘总结] 连接线统计:
  ├─ 普通连接: 0 条
  ├─ 预览线: 1 条  ← 正确统计
  └─ 总计: 1 条
```

## 技术要点

### 1. 预览线类型支持
修复后的识别逻辑支持多种类型的预览线：
- `isPersistentPreview`：持久预览线
- `isPreview`：普通预览线
- `isUnifiedPreview`：统一预览线管理器创建的预览线
- ID包含'preview'：基于命名的预览线

### 2. 向后兼容性
修复保持了对现有预览线类型的完全兼容，只是增加了对新类型的支持。

### 3. 统计准确性
确保重绘总结日志能够准确反映画布中所有类型预览线的数量和状态。

## 验证方法

1. 启动开发服务器
2. 打开任务流编辑器
3. 创建节点并生成预览线
4. 点击布局切换按钮
5. 查看控制台中的重绘总结日志
6. 确认预览线数量统计正确

## 相关文件

- **修复文件**：`src/composables/useStructuredLayout.js`
- **预览线管理器**：`src/utils/UnifiedPreviewLineManager.js`
- **预览线状态**：`src/utils/previewStates.js`

## 应用场景

此修复适用于以下场景：
- 布局方向切换后的状态验证
- 预览线数量统计和调试
- 画布状态监控和日志记录
- 预览线管理器的功能验证

## 总结

通过添加对 `isUnifiedPreview` 字段的识别，修复了预览线在重绘总结日志中统计不准确的问题，确保了日志信息的完整性和准确性，为后续的调试和监控提供了可靠的数据基础。