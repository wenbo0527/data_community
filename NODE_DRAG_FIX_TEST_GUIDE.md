# 节点拖拽边引用错误修复测试指南

## 🎯 测试目标

验证节点拖拽过程中边引用错误的修复效果，确保：
1. 拖拽节点时不再出现 "Edge's source node with id xxx not exists" 错误
2. 预览线在拖拽过程中正确更新
3. 节点删除后相关预览线被正确清理
4. 系统整体稳定性提升

## 🔧 修复内容回顾

### 1. 增强节点验证
- ✅ 添加 `validateNodeForPreview` 方法
- ✅ 验证节点存在性、数据完整性
- ✅ 跳过预览线节点，避免循环创建

### 2. 优化拖拽处理
- ✅ 在 `handleNodeMove` 中添加节点验证
- ✅ 实现防抖处理（16ms间隔，约60fps）
- ✅ 添加错误捕获和日志记录

### 3. 安全的预览线更新
- ✅ 改进 `updatePersistentPreviewPosition` 方法
- ✅ 使用 `safeRemovePersistentPreviewsForNode` 安全删除
- ✅ 延迟创建新预览线（50ms延迟）
- ✅ 二次验证节点存在性

### 4. 增强预览线创建
- ✅ 改进 `createPersistentSinglePreview` 方法
- ✅ 检查预览线是否已存在
- ✅ 验证节点连接状态
- ✅ 完整的错误处理

### 5. 资源管理
- ✅ 添加 `moveUpdateTimer` 定时器管理
- ✅ 在 `destroy` 方法中清理定时器
- ✅ 防止内存泄漏

## 📋 测试步骤

### 测试1：基础拖拽测试
1. **操作**：
   - 打开任务创建页面
   - 添加2-3个不同类型的节点
   - 拖拽每个节点到不同位置

2. **预期结果**：
   - ✅ 控制台无 "Edge's source node not exists" 错误
   - ✅ 预览线跟随节点正确移动
   - ✅ 拖拽过程流畅，无卡顿

3. **检查点**：
   ```javascript
   // 控制台应显示：
   // 🖱️ [ConnectionPreview] 开始拖拽节点: nodeId nodeType
   // ✅ [ConnectionPreview] 已安全删除 X 条预览线
   // ✅ [ConnectionPreview] 创建单一预览线成功: nodeId_single
   ```

### 测试2：快速拖拽测试
1. **操作**：
   - 快速连续拖拽同一个节点
   - 在拖拽过程中快速移动鼠标

2. **预期结果**：
   - ✅ 防抖机制生效，避免频繁更新
   - ✅ 无边引用错误
   - ✅ 最终预览线位置正确

3. **检查点**：
   ```javascript
   // 控制台应显示防抖日志，更新频率约60fps
   ```

### 测试3：节点删除后拖拽测试
1. **操作**：
   - 添加多个节点
   - 删除其中一个节点
   - 立即拖拽其他节点

2. **预期结果**：
   - ✅ 删除的节点预览线被完全清理
   - ✅ 拖拽其他节点时无错误
   - ✅ 预览线引用正确

### 测试4：分支节点拖拽测试
1. **操作**：
   - 添加分流节点（audience-split）
   - 拖拽分流节点到不同位置

2. **预期结果**：
   - ✅ 多条分支预览线正确更新
   - ✅ 无边引用错误
   - ✅ 分支标签正确显示

### 测试5：边缘情况测试
1. **操作**：
   - 在拖拽过程中快速删除节点
   - 同时拖拽多个节点（如果可能）
   - 在预览线创建过程中进行其他操作

2. **预期结果**：
   - ✅ 系统稳定，无崩溃
   - ✅ 错误被正确捕获和处理
   - ✅ 资源正确清理

## 🔍 调试信息

### 关键日志标识
```javascript
// 节点验证
⚠️ [ConnectionPreview] 拖拽的节点无效，跳过处理
⚠️ [ConnectionPreview] 节点不在图中
⚠️ [ConnectionPreview] 节点数据不存在

// 预览线管理
🧹 [ConnectionPreview] 安全删除节点预览线
✅ [ConnectionPreview] 已安全删除 X 条预览线
✅ [ConnectionPreview] 创建单一预览线成功
❌ [ConnectionPreview] 创建单一预览线失败

// 拖拽处理
🖱️ [ConnectionPreview] 开始拖拽节点
📍 [ConnectionPreview] 节点移动完成
❌ [ConnectionPreview] 更新预览线位置失败
```

### 性能监控
```javascript
// 在浏览器控制台执行：
console.time('drag-performance')
// 执行拖拽操作
console.timeEnd('drag-performance')

// 检查内存使用：
performance.memory
```

## ✅ 成功指标

### 功能指标
- [ ] 拖拽过程中无边引用错误
- [ ] 预览线正确跟随节点移动
- [ ] 节点删除后预览线完全清理
- [ ] 分支节点预览线正确处理
- [ ] 系统整体稳定性良好

### 性能指标
- [ ] 拖拽响应时间 < 16ms（60fps）
- [ ] 内存使用稳定，无泄漏
- [ ] CPU使用率合理
- [ ] 预览线创建/删除效率高

### 用户体验指标
- [ ] 拖拽操作流畅自然
- [ ] 视觉反馈及时准确
- [ ] 无明显卡顿或延迟
- [ ] 错误恢复能力强

## 🚨 失败处理

### 如果仍有边引用错误
1. 检查 `validateNodeForPreview` 方法是否被正确调用
2. 确认节点删除时预览线是否完全清理
3. 检查防抖定时器是否正常工作
4. 验证图对象的状态一致性

### 如果性能问题
1. 调整防抖间隔时间（当前16ms）
2. 优化预览线创建/删除逻辑
3. 检查是否有内存泄漏
4. 考虑批量操作优化

### 如果预览线显示异常
1. 检查预览线位置计算逻辑
2. 验证节点数据的完整性
3. 确认样式配置是否正确
4. 检查Z-index层级设置

## 📊 测试报告模板

```markdown
## 节点拖拽修复测试报告

**测试时间**: [日期时间]
**测试环境**: [浏览器版本]
**测试人员**: [姓名]

### 测试结果
- [ ] 基础拖拽测试: 通过/失败
- [ ] 快速拖拽测试: 通过/失败  
- [ ] 删除后拖拽测试: 通过/失败
- [ ] 分支节点测试: 通过/失败
- [ ] 边缘情况测试: 通过/失败

### 发现的问题
1. [问题描述]
2. [问题描述]

### 性能数据
- 拖拽响应时间: [X]ms
- 内存使用: [X]MB
- CPU使用率: [X]%

### 建议
[改进建议]
```

通过这个全面的测试指南，可以系统性地验证节点拖拽边引用错误的修复效果，确保系统的稳定性和用户体验。