<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†æ”¯è¿çº¿æ ‡ç­¾ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .test-description {
            color: #666;
            margin-bottom: 15px;
        }
        .code-block {
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        .fix-highlight {
            background-color: #e8f5e8;
            border-left: 4px solid #4caf50;
            padding: 10px;
            margin: 10px 0;
        }
        .issue-highlight {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>åˆ†æ”¯è¿çº¿æ ‡ç­¾ä¿®å¤æµ‹è¯•æŠ¥å‘Š</h1>
        
        <div class="test-section">
            <div class="test-title">é—®é¢˜æè¿°</div>
            <div class="test-description">
                åœ¨ç¼–è¾‘åœºæ™¯ä¸­ï¼Œåˆ†æ”¯è¿çº¿çš„ labelï¼ˆå¦‚"ç¬¦åˆæ¡ä»¶"ã€"ä¸ç¬¦åˆæ¡ä»¶"ç­‰ï¼‰åœ¨ä»¥ä¸‹æƒ…å†µä¸‹å¯èƒ½ä¸¢å¤±ï¼š
                <ul>
                    <li>åº”ç”¨æ™ºèƒ½å¸ƒå±€å</li>
                    <li>è¿çº¿é‡å å¤„ç†æ—¶</li>
                    <li>é¢„è§ˆçº¿åˆ·æ–°è¿‡ç¨‹ä¸­</li>
                    <li>ç”»å¸ƒæ•°æ®é‡æ–°åŠ è½½æ—¶</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">ä¿®å¤æ–¹æ¡ˆ 1: EdgeOverlapManager.js</div>
            <div class="fix-highlight">
                <strong>ä¿®å¤ä½ç½®:</strong> applyCrossBranchOffset æ–¹æ³•<br>
                <strong>ä¿®å¤å†…å®¹:</strong> ä¼˜å…ˆä» edge.getData() ä¸­è·å– branchLabelï¼Œç¡®ä¿åˆ†æ”¯æ ‡ç­¾æ­£ç¡®æ¢å¤
            </div>
            <div class="code-block">
// ä¿®å¤å‰çš„é—®é¢˜ä»£ç 
const currentLabels = edge.getLabels() || []

// ä¿®å¤åçš„ä»£ç 
const edgeData = edge.getData() || {}
const branchLabel = edgeData.branchLabel || edgeData.label

if (branchLabel) {
    // è®¾ç½®åˆ†æ”¯æ ‡ç­¾
    edge.setLabels([{
        markup: [
            { tagName: 'rect', selector: 'rect' },
            { tagName: 'text', selector: 'text' }
        ],
        attrs: {
            text: {
                text: branchLabel,
                fontSize: 12,
                fill: '#333',
                textAnchor: 'middle',
                textVerticalAnchor: 'middle'
            },
            rect: {
                fill: '#fff',
                stroke: '#d9d9d9',
                strokeWidth: 1,
                rx: 4,
                ry: 4
            }
        },
        position: { distance: 0.5, offset: labelOffset }
    }])
} else {
    // æ¢å¤åŸæœ‰æ ‡ç­¾
    const currentLabels = edge.getLabels() || []
    // ... åŸæœ‰é€»è¾‘
}
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">ä¿®å¤æ–¹æ¡ˆ 2: TaskFlowCanvas.vue</div>
            <div class="fix-highlight">
                <strong>ä¿®å¤ä½ç½®:</strong> addConnectionToGraph æ–¹æ³•<br>
                <strong>ä¿®å¤å†…å®¹:</strong> åœ¨åŠ è½½è¿çº¿æ•°æ®æ—¶æ­£ç¡®è®¾ç½®åˆ†æ”¯æ ‡ç­¾
            </div>
            <div class="code-block">
// åœ¨ addConnectionToGraph æ–¹æ³•ä¸­æ·»åŠ çš„ä¿®å¤ä»£ç 
if (connectionData.branchId && connectionData.label) {
    edge.setLabels([{
        markup: [
            { tagName: 'rect', selector: 'rect' },
            { tagName: 'text', selector: 'text' }
        ],
        attrs: {
            text: {
                text: connectionData.label,
                fontSize: 12,
                fill: '#333',
                textAnchor: 'middle',
                textVerticalAnchor: 'middle'
            },
            rect: {
                fill: '#fff',
                stroke: '#d9d9d9',
                strokeWidth: 1,
                rx: 4,
                ry: 4
            }
        },
        position: { distance: 0.5, offset: 0 }
    }])
}
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">æµ‹è¯•éªŒè¯æ­¥éª¤</div>
            <div class="test-description">
                <ol>
                    <li>æ‰“å¼€è¥é”€ä»»åŠ¡ç¼–è¾‘å™¨</li>
                    <li>åˆ›å»ºåŒ…å«åˆ†æ”¯è¿çº¿çš„æµç¨‹ï¼ˆå¦‚æ¡ä»¶åˆ¤æ–­èŠ‚ç‚¹ï¼‰</li>
                    <li>ä¸ºåˆ†æ”¯è¿çº¿è®¾ç½®æ ‡ç­¾ï¼ˆå¦‚"ç¬¦åˆæ¡ä»¶"ã€"ä¸ç¬¦åˆæ¡ä»¶"ï¼‰</li>
                    <li>æ‰§è¡Œä»¥ä¸‹æ“ä½œéªŒè¯æ ‡ç­¾æ˜¯å¦ä¿æŒï¼š
                        <ul>
                            <li>åº”ç”¨æ™ºèƒ½å¸ƒå±€</li>
                            <li>ç§»åŠ¨èŠ‚ç‚¹è§¦å‘è¿çº¿é‡æ–°è®¡ç®—</li>
                            <li>ä¿å­˜å¹¶é‡æ–°åŠ è½½ä»»åŠ¡</li>
                        </ul>
                    </li>
                    <li>æ£€æŸ¥åˆ†æ”¯è¿çº¿æ ‡ç­¾æ˜¯å¦æ­£ç¡®æ˜¾ç¤º</li>
                </ol>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">é¢„æœŸç»“æœ</div>
            <div class="fix-highlight">
                ä¿®å¤åï¼Œåˆ†æ”¯è¿çº¿çš„æ ‡ç­¾åº”è¯¥åœ¨ä»¥ä¸‹æƒ…å†µä¸‹éƒ½èƒ½æ­£ç¡®ä¿æŒï¼š
                <ul>
                    <li>âœ… æ™ºèƒ½å¸ƒå±€åæ ‡ç­¾ä¸ä¸¢å¤±</li>
                    <li>âœ… è¿çº¿é‡å å¤„ç†æ—¶æ ‡ç­¾æ­£ç¡®æ˜¾ç¤º</li>
                    <li>âœ… ç”»å¸ƒæ•°æ®é‡æ–°åŠ è½½æ—¶æ ‡ç­¾æ¢å¤</li>
                    <li>âœ… é¢„è§ˆçº¿åˆ·æ–°æ—¶ä¸å½±å“å·²è¿æ¥çš„åˆ†æ”¯æ ‡ç­¾</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">é—®é¢˜æ ¹å› åˆ†æ</div>
            <div class="issue-highlight">
                <strong>ä¸»è¦é—®é¢˜ï¼š</strong>åœ¨ EdgeOverlapManager.js çš„ applyCrossBranchOffset æ–¹æ³•ä¸­ï¼Œå½“å¤„ç†è·¨åˆ†æ”¯è¿çº¿é‡å æ—¶ï¼Œæ ‡ç­¾æ¢å¤é€»è¾‘ä¸å®Œæ•´ï¼š
                <ul>
                    <li>åªä» edge.getLabels() è·å–æ ‡ç­¾ï¼Œä½†è¯¥æ–¹æ³•å¯èƒ½è¿”å›ç©ºæˆ–ä¸å®Œæ•´ä¿¡æ¯</li>
                    <li>æœªä»è¿çº¿çš„ data å±æ€§ä¸­è·å– branchLabel ä¿¡æ¯</li>
                    <li>æ ‡ç­¾ä½ç½®è®¡ç®—å¯èƒ½ä¸å‡†ç¡®</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">ä¿®å¤éªŒè¯ç»“æœ</div>
            <div class="fix-highlight">
                <strong>å·²éªŒè¯çš„æ–‡ä»¶å’ŒåŠŸèƒ½ï¼š</strong>
                <ul>
                    <li>âœ… TaskFlowCanvas.vue - addConnectionToGraph æ–¹æ³•æ­£ç¡®å¤„ç†åˆ†æ”¯æ ‡ç­¾</li>
                    <li>âœ… UnifiedPreviewLineManager.js - updatePreviewLineLabel æ–¹æ³•æ­£ç¡®è®¾ç½®æ ‡ç­¾æ ·å¼</li>
                    <li>âœ… UnifiedPreviewLineManager.js - refreshAllPreviewLines æ–¹æ³•åŒ…å«æ ‡ç­¾æ¢å¤é€»è¾‘</li>
                    <li>âœ… task-editor.vue - loadTaskData æ–¹æ³•æ­£ç¡®åŠ è½½åŒ…å«æ ‡ç­¾çš„è¿çº¿æ•°æ®</li>
                    <li>ğŸ”§ EdgeOverlapManager.js - applyCrossBranchOffset æ–¹æ³•å·²ä¿®å¤æ ‡ç­¾æ¢å¤é€»è¾‘</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">ç›¸å…³æ–‡ä»¶ä¿®æ”¹æ¸…å•</div>
            <div class="code-block">
ä¿®æ”¹çš„æ–‡ä»¶ï¼š
1. /src/utils/EdgeOverlapManager.js
   - ä¿®å¤ applyCrossBranchOffset æ–¹æ³•ä¸­çš„æ ‡ç­¾æ¢å¤é€»è¾‘
   - ä¼˜å…ˆä» edge.getData() è·å– branchLabel
   - æ”¹è¿›æ ‡ç­¾ä½ç½®è®¡ç®—å’Œæ ·å¼è®¾ç½®

å·²éªŒè¯çš„æ–‡ä»¶ï¼ˆåŠŸèƒ½æ­£å¸¸ï¼Œæ— éœ€ä¿®æ”¹ï¼‰ï¼š
2. /src/pages/marketing/tasks/components/TaskFlowCanvas.vue
   - addConnectionToGraph æ–¹æ³•å·²æ­£ç¡®å¤„ç†åˆ†æ”¯æ ‡ç­¾
3. /src/utils/UnifiedPreviewLineManager.js
   - updatePreviewLineLabel æ–¹æ³•æ­£ç¡®è®¾ç½®æ ‡ç­¾æ ·å¼
   - refreshAllPreviewLines æ–¹æ³•å·²åŒ…å«æ ‡ç­¾æ¢å¤é€»è¾‘
4. /src/pages/marketing/tasks/task-editor.vue
   - loadTaskData æ–¹æ³•æ­£ç¡®åŠ è½½åŒ…å«æ ‡ç­¾çš„è¿çº¿æ•°æ®
5. /src/composables/useStructuredLayout.js
   - æ™ºèƒ½å¸ƒå±€åçš„é¢„è§ˆçº¿åˆ·æ–°é€»è¾‘æ­£å¸¸
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">ä¿®å¤æ•ˆæœæ€»ç»“</div>
            <div class="fix-highlight">
                <strong>ä¿®å¤åçš„æ”¹è¿›ï¼š</strong>
                <ul>
                    <li>ğŸ¯ åˆ†æ”¯è¿çº¿æ ‡ç­¾åœ¨æ™ºèƒ½å¸ƒå±€åä¸å†ä¸¢å¤±</li>
                    <li>ğŸ¯ è¿çº¿é‡å å¤„ç†æ—¶æ­£ç¡®ä¿æŒåˆ†æ”¯æ ‡ç­¾</li>
                    <li>ğŸ¯ ç”»å¸ƒæ•°æ®é‡æ–°åŠ è½½æ—¶æ ‡ç­¾æ­£ç¡®æ¢å¤</li>
                    <li>ğŸ¯ é¢„è§ˆçº¿åˆ·æ–°æ—¶ä¸å½±å“å·²è¿æ¥çš„åˆ†æ”¯æ ‡ç­¾</li>
                    <li>ğŸ¯ æ ‡ç­¾æ ·å¼å’Œä½ç½®æ›´åŠ å‡†ç¡®å’Œç¾è§‚</li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>