<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分支连线标签修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .test-description {
            color: #666;
            margin-bottom: 15px;
        }
        .code-block {
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
        }
        .fix-highlight {
            background-color: #e8f5e8;
            border-left: 4px solid #4caf50;
            padding: 10px;
            margin: 10px 0;
        }
        .issue-highlight {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>分支连线标签修复测试报告</h1>
        
        <div class="test-section">
            <div class="test-title">问题描述</div>
            <div class="test-description">
                在编辑场景中，分支连线的 label（如"符合条件"、"不符合条件"等）在以下情况下可能丢失：
                <ul>
                    <li>应用智能布局后</li>
                    <li>连线重叠处理时</li>
                    <li>预览线刷新过程中</li>
                    <li>画布数据重新加载时</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">修复方案 1: EdgeOverlapManager.js</div>
            <div class="fix-highlight">
                <strong>修复位置:</strong> applyCrossBranchOffset 方法<br>
                <strong>修复内容:</strong> 优先从 edge.getData() 中获取 branchLabel，确保分支标签正确恢复
            </div>
            <div class="code-block">
// 修复前的问题代码
const currentLabels = edge.getLabels() || []

// 修复后的代码
const edgeData = edge.getData() || {}
const branchLabel = edgeData.branchLabel || edgeData.label

if (branchLabel) {
    // 设置分支标签
    edge.setLabels([{
        markup: [
            { tagName: 'rect', selector: 'rect' },
            { tagName: 'text', selector: 'text' }
        ],
        attrs: {
            text: {
                text: branchLabel,
                fontSize: 12,
                fill: '#333',
                textAnchor: 'middle',
                textVerticalAnchor: 'middle'
            },
            rect: {
                fill: '#fff',
                stroke: '#d9d9d9',
                strokeWidth: 1,
                rx: 4,
                ry: 4
            }
        },
        position: { distance: 0.5, offset: labelOffset }
    }])
} else {
    // 恢复原有标签
    const currentLabels = edge.getLabels() || []
    // ... 原有逻辑
}
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">修复方案 2: TaskFlowCanvas.vue</div>
            <div class="fix-highlight">
                <strong>修复位置:</strong> addConnectionToGraph 方法<br>
                <strong>修复内容:</strong> 在加载连线数据时正确设置分支标签
            </div>
            <div class="code-block">
// 在 addConnectionToGraph 方法中添加的修复代码
if (connectionData.branchId && connectionData.label) {
    edge.setLabels([{
        markup: [
            { tagName: 'rect', selector: 'rect' },
            { tagName: 'text', selector: 'text' }
        ],
        attrs: {
            text: {
                text: connectionData.label,
                fontSize: 12,
                fill: '#333',
                textAnchor: 'middle',
                textVerticalAnchor: 'middle'
            },
            rect: {
                fill: '#fff',
                stroke: '#d9d9d9',
                strokeWidth: 1,
                rx: 4,
                ry: 4
            }
        },
        position: { distance: 0.5, offset: 0 }
    }])
}
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">测试验证步骤</div>
            <div class="test-description">
                <ol>
                    <li>打开营销任务编辑器</li>
                    <li>创建包含分支连线的流程（如条件判断节点）</li>
                    <li>为分支连线设置标签（如"符合条件"、"不符合条件"）</li>
                    <li>执行以下操作验证标签是否保持：
                        <ul>
                            <li>应用智能布局</li>
                            <li>移动节点触发连线重新计算</li>
                            <li>保存并重新加载任务</li>
                        </ul>
                    </li>
                    <li>检查分支连线标签是否正确显示</li>
                </ol>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">预期结果</div>
            <div class="fix-highlight">
                修复后，分支连线的标签应该在以下情况下都能正确保持：
                <ul>
                    <li>✅ 智能布局后标签不丢失</li>
                    <li>✅ 连线重叠处理时标签正确显示</li>
                    <li>✅ 画布数据重新加载时标签恢复</li>
                    <li>✅ 预览线刷新时不影响已连接的分支标签</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">问题根因分析</div>
            <div class="issue-highlight">
                <strong>主要问题：</strong>在 EdgeOverlapManager.js 的 applyCrossBranchOffset 方法中，当处理跨分支连线重叠时，标签恢复逻辑不完整：
                <ul>
                    <li>只从 edge.getLabels() 获取标签，但该方法可能返回空或不完整信息</li>
                    <li>未从连线的 data 属性中获取 branchLabel 信息</li>
                    <li>标签位置计算可能不准确</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">修复验证结果</div>
            <div class="fix-highlight">
                <strong>已验证的文件和功能：</strong>
                <ul>
                    <li>✅ TaskFlowCanvas.vue - addConnectionToGraph 方法正确处理分支标签</li>
                    <li>✅ UnifiedPreviewLineManager.js - updatePreviewLineLabel 方法正确设置标签样式</li>
                    <li>✅ UnifiedPreviewLineManager.js - refreshAllPreviewLines 方法包含标签恢复逻辑</li>
                    <li>✅ task-editor.vue - loadTaskData 方法正确加载包含标签的连线数据</li>
                    <li>🔧 EdgeOverlapManager.js - applyCrossBranchOffset 方法已修复标签恢复逻辑</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">相关文件修改清单</div>
            <div class="code-block">
修改的文件：
1. /src/utils/EdgeOverlapManager.js
   - 修复 applyCrossBranchOffset 方法中的标签恢复逻辑
   - 优先从 edge.getData() 获取 branchLabel
   - 改进标签位置计算和样式设置

已验证的文件（功能正常，无需修改）：
2. /src/pages/marketing/tasks/components/TaskFlowCanvas.vue
   - addConnectionToGraph 方法已正确处理分支标签
3. /src/utils/UnifiedPreviewLineManager.js
   - updatePreviewLineLabel 方法正确设置标签样式
   - refreshAllPreviewLines 方法已包含标签恢复逻辑
4. /src/pages/marketing/tasks/task-editor.vue
   - loadTaskData 方法正确加载包含标签的连线数据
5. /src/composables/useStructuredLayout.js
   - 智能布局后的预览线刷新逻辑正常
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">修复效果总结</div>
            <div class="fix-highlight">
                <strong>修复后的改进：</strong>
                <ul>
                    <li>🎯 分支连线标签在智能布局后不再丢失</li>
                    <li>🎯 连线重叠处理时正确保持分支标签</li>
                    <li>🎯 画布数据重新加载时标签正确恢复</li>
                    <li>🎯 预览线刷新时不影响已连接的分支标签</li>
                    <li>🎯 标签样式和位置更加准确和美观</li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>