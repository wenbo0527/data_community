# 横版画布快速布局功能使用指南

## 🚀 功能概述

横版画布新增**快速布局**功能，这是一个专为横版画布设计的轻量级布局工具，具有以下特点：

- ✅ **仅重排节点位置**：不改变现有的端口绑定和连线关系
- ✅ **基于端口索引分行**：利用`out-0`、`out-1`等端口索引自然对齐
- ✅ **LR方向拓扑分层**：从左到右的层次化布局
- ✅ **高性能**：O(n)时间复杂度，支持大规模节点快速布局
- ✅ **平滑动画**：300ms过渡动画，用户体验流畅

## 📋 使用步骤

### 1. 打开横版画布
导航到横版营销画布页面，确保画布中有一些节点（可以手动添加或从模板创建）。

### 2. 点击"快速布局"按钮
在工具栏中找到**⚡快速布局**按钮（位于"统一布局"按钮左侧），点击即可执行布局。

### 3. 查看布局效果
系统会自动：
- 按照连接关系进行拓扑分层
- 同一父节点的子节点按端口索引自然分行
- 添加平滑的过渡动画
- 自动适配内容到视口

## 🎯 布局规则

### 列分布（X轴）
```
第0列: 根节点 (x = 100)
第1列: 第一层子节点 (x = 350) 
第2列: 第二层子节点 (x = 600)
第n列: x = 100 + n * 250
```

### 行分布（Y轴）
基于端口索引的自然分布：
```javascript
// event-split 节点示例
// 端口: out-0 (YES), out-1 (NO)
// 自然分布：
// out-0 -> 第0行 (y = 200)
// out-1 -> 第1行 (y = 400)

// crowd-split 节点示例  
// 端口: out-0, out-1, out-2, out-3
// 自然分布：
// out-0 -> 第0行 (y = 150)
// out-1 -> 第1行 (y = 300)
// out-2 -> 第2行 (y = 450)
// out-3 -> 第3行 (y = 600)
```

## 🧪 测试功能

### 快速测试
点击页面顶部的**"测试快速布局"**按钮，系统会：
1. 运行单元测试验证布局算法
2. 执行性能测试（100节点）
3. 对当前画布节点执行实际布局

### 手动测试
1. 添加几个不同类型的节点（开始、事件分流、人群分流等）
2. 手动连接它们创建复杂结构
3. 点击"快速布局"按钮
4. 观察布局效果是否符合预期

## ⚡ 性能特点

- **时间复杂度**：O(n)，n为节点数量
- **空间复杂度**：O(n)，用于存储临时数据结构
- **动画性能**：使用X6原生transition API，60fps流畅动画
- **内存优化**：及时清理临时数据，无内存泄漏

## 🔧 技术实现

### 核心算法
```javascript
class HorizontalQuickLayout {
  execute(graph) {
    // 1. 构建拓扑层次（BFS）
    const layers = this.buildTopologyLayers(nodes, edges);
    
    // 2. 计算位置（基于端口索引）
    const positions = this.calculatePositions(layers, nodes);
    
    // 3. 应用位置（仅修改节点坐标）
    await this.applyPositions(graph, positions);
  }
}
```

### 关键特性
1. **保持绑定关系**：不修改端口配置和连线关系
2. **端口索引映射**：`out-0` -> 第0行，`out-1` -> 第1行
3. **居中对齐**：每列内节点垂直居中对齐
4. **平滑过渡**：300ms缓动动画

## 📁 文件结构

```
src/pages/marketing/tasks/horizontal/
├── utils/
│   ├── quickLayout.js              # 快速布局核心算法
│   └── __tests__/
│       └── quickLayout.test.js     # 测试用例
├── index.vue                       # 横版画布主页面
└── components/
    └── CanvasToolbar.vue           # 工具栏组件（已集成快速布局按钮）
```

## 🎨 使用示例

### 创建测试场景
```javascript
// 1. 添加开始节点
const startNode = {
  type: 'start',
  position: { x: 100, y: 200 }
}

// 2. 添加事件分流节点
const eventSplitNode = {
  type: 'event-split',
  position: { x: 300, y: 200 }
}

// 3. 添加两个分支节点
const yesNode = {
  type: 'custom',
  position: { x: 500, y: 150 }
}

const noNode = {
  type: 'custom', 
  position: { x: 500, y: 250 }
}

// 4. 连接它们
connect(startNode, eventSplitNode)
connect(eventSplitNode, yesNode) // out-0
connect(eventSplitNode, noNode)  // out-1
```

### 执行布局
```javascript
// 点击工具栏的"快速布局"按钮
// 或使用代码调用
await quickLayout.execute(graph)
```

### 预期结果
```
布局前（混乱）：
    [start]     [event-split]
                   \     \
                  [yes]  [no]

布局后（整齐）：
[start] → [event-split] → [end]
             ↓        ↓
           [yes]    [no]
```

## 🔍 调试技巧

### 控制台日志
布局过程中会输出详细日志：
```
[HorizontalQuickLayout] 开始执行快速布局
[HorizontalQuickLayout] 拓扑分层完成，层数: 3
[HorizontalQuickLayout] 快速布局完成
```

### 性能监控
使用测试功能可以查看性能数据：
```
⚡ [性能] 100节点布局耗时: 45.23ms
```

## 🐛 常见问题

### Q: 布局后节点重叠？
A: 检查是否有节点没有正确配置端口，或者列间距设置过小。

### Q: 布局效果不理想？
A: 可以调整`columnSpacing`和`rowHeight`参数，或使用"统一布局"作为替代方案。

### Q: 动画卡顿？
A: 对于大量节点（>500），可以关闭动画或减少节点数量。

## 📞 技术支持

如遇到问题，请检查浏览器控制台日志，或联系开发团队获取支持。