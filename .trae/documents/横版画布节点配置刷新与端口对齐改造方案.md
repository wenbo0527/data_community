# 横版画布节点配置刷新与端口对齐改造方案

## 问题复盘
- 症状：节点配置后标题/内容未刷新，右侧 out 端口数量与位置未更新（与文档不一致）。
- 现状：
  - 抽屉确认后触发 `graph.trigger('node:config-updated')`（useConfigDrawers.js）。
  - 页面监听并调用 `updateNodeFromConfig(node, type, config)`。
  - `updateNodeFromConfig` 仅 `setProp('ports', ports)` 与 `setMarkup/Attrs`，未做端口“移除+新增”，X6 不一定立即重算端口，导致端口未对齐或数量未更新。
  - 行文本 y 基线基于顶部偏移，未与行中点对齐；左侧 `in` 默认居中于整节点，未对齐到内容区中心。

## 目标
- 严格按文档进行“标题行 + 内容行”映射；
- 基于映射行数重建端口数量（`out-i`）并精准对齐到各行中点；
- 左侧 `in` 端口对齐到“内容区中心”；
- 抽屉确认后，节点样式与端口即时刷新且保持现有连接的正确性。

## 节点统一策略
- 普通节点一律视为“单分支分流节点”（初始化为 1 入 1 出）：
  - `in`：对齐到内容区的垂直中心；
  - `out-0`：对齐到唯一内容行的垂直中点；
- 分流类节点（`crowd-split/event-split/ab-test`）依据配置行数生成 `out-0..out-n`；
- 非分流节点如 `start/end/manual-call/wait` 亦统一遵循“标题 + 内容区”的定位范式，便于行驱动布局与端口对齐。

## 更新流设计
1. 抽屉确认（useConfigDrawers.js）
   - 保存配置到节点：`node.setData({ isConfigured: true, config })`。
   - 触发：`graph.trigger('node:config-updated', { node, nodeType, config })`。
2. 页面处理（horizontal/index.vue）
   - 监听 `node:config-updated` → 调用 `updateNodeFromConfig(node, nodeType, config)`。
3. 节点刷新（updateNodeFromConfig）
   - 映射内容行：`buildDisplayLines(nodeType, config)`（兼容 crowd-split / ab-test 等分支字段）。
   - 计算尺寸：`height = headerHeight + contentPadding + rows.length * rowHeight + padding`。
   - 计算行中点：`verticalOffsets[i] = headerHeight + contentPadding + i * rowHeight + rowHeight/2`。
   - 计算内容区中心：`inCenter = headerHeight + contentPadding + (rows.length * rowHeight)/2`。
   - 端口重建：
     - 移除旧端口：`node.getPorts().forEach(p => node.removePort(p.id))`。
     - 设置分组：`node.setProp('ports/groups', groups)`。
     - 新增 in：`addPort({ id: 'in', group: 'in', args: { dy: inCenter - height/2 } })`。
     - 新增 out-i：对每个行中点 `dy = verticalOffsets[i] - height/2` → `addPort({ id: 'out-i', group: 'out', args: { dy } })`。
   - 标题/内容渲染：
     - 标题文本优先 `config.nodeName`；
     - 行文本 y 采用行中点基础，加入 `baselineAdjust`（例如 `+5`）。
   - 更新：`node.resize(width, height)`、`node.setMarkup(markup)`、`node.setAttrs(attrs)`、`node.setProp('label', '')`。

## 端口对齐与尺寸计算
- 常量：`headerHeight`、`rowHeight`、`contentPadding`、`baselineAdjust`、`nodeWidth`。
- 高度：`height = headerHeight + contentPadding + rows.length * rowHeight + contentPadding`。
- 偏移：
  - `verticalOffsets[i] = headerHeight + contentPadding + i * rowHeight + rowHeight/2`；
  - `inVerticalOffset = headerHeight + contentPadding + (rows.length * rowHeight)/2`；
  - 传入工厂：`createHorizontalPortConfig(outCount, { verticalOffsets, nodeHeight: height, inVerticalOffset })`。

## 端口重建策略（X6）
- 先清空端口（逐个 `removePort`），再新增，避免 `setProp('ports', ...)` 不生效；
- 端口 ID 保持稳定命名：`in`、`out-0..out-n`；减少重绘后连接中断风险；
- 端口组连接约束保留：`in` 只作为 `target`，`out` 只作为 `source`。

## 代码改动点
- 文件：`src/pages/marketing/tasks/horizontal/index.vue`
  - `buildDisplayLines` 增强字段兼容：
    - crowd-split 支持 `crowdLayers/branches/splitCount` 并追加“否则”；
    - ab-test 支持 `branches/variants/versions` 显示 `{name}：{percentage|ratio}%`；
    - manual-call 补充 `description`；wait 使用 `value+unit`；start 使用 `taskType/targetAudience`。
  - `updateNodeFromConfig`：
    - 使用 `config.nodeName || getNodeLabel(nodeType)`；
    - 计算 `verticalOffsets/inCenter`；
    - 端口重建（移除旧端口 + 新增 in/out-i，`dy` 对齐）；
    - 行文本 y 改为 `行中点 + baselineAdjust`。
  - `createRectNode`：
    - 初始 ports 也传入 `nodeHeight` 与 `inVerticalOffset`，保证初次绘制对齐。
- 文件：`src/pages/marketing/tasks/horizontal/utils/portConfigFactoryHorizontal.js`
  - 接口：`createHorizontalPortConfig(outCount, { includeIn, outIds, verticalOffsets, nodeHeight, inVerticalOffset })`；
  - 实现：
    - `in` 使用 `dy = inVerticalOffset - nodeHeight/2`；
    - `out-i` 使用 `dy = verticalOffsets[i] - nodeHeight/2`。

## 连接与兼容性处理
- 当分支减少导致某些 `out-i` 不再存在时，现有连接自动断开为正常；如需保留，可在 `nodeConfigManager` 中添加迁移策略映射旧端口至最近有效端口；
- 若端口热重建导致边定位异常：可在重建后调用 `edge.setSource/Target` 强制刷新（通常不需要）。

## 测试与验收
- 单元测试（vitest）：
  - 为 `updateNodeFromConfig` 构造不同配置（crowd-split, event-split, ab-test）验证：
    - `node.getPorts()` 个数正确，包含 `in` 与每行对应 `out-i`；
    - 每个 `out-i.args.dy` 与行中点差值符合 `dy = v - height/2`；
    - 标题文本为 `config.nodeName` 或类型标签；
  - 事件流：模拟 `node:config-updated`，断言 `updateNodeFromConfig` 被调用。
- 预览验收：
  - 修改抽屉配置（增减分支、调整名称/比例），节点内容刷新，右侧端口数量与位置随之更新；
  - 左侧 `in` 位于内容区中心；
  - start/end 无“更多”图标，其他节点显示图标并可操作。

## 风险与回退
- 文本基线在不同浏览器存在微差异：通过 `baselineAdjust` 可微调；必要时改用 `dominant-baseline`；
- X6 端口 `dy`/`y` 兼容：如个别主题要求使用 `y`，可在工厂中降级为 `y: verticalOffsets[i]`（同时移除 `nodeHeight`）进行比对测试；
- 如出现端口热重建导致边定位异常，可临时启用强制刷新策略并记录日志，回归后关闭。

## 执行计划（里程碑）
1. 里程碑 A：端口工厂对齐能力
   - 修改 `portConfigFactoryHorizontal.js` 支持 `nodeHeight/inVerticalOffset` 并统一使用 `dy`；
   - 验证多行对齐与单行节点稳定性。
2. 里程碑 B：节点刷新与行驱动布局
   - 增强 `buildDisplayLines` 的字段映射；
   - 重构 `updateNodeFromConfig`：移除 + 新增端口、行文本按中点对齐；
   - 初始创建 `createRectNode` 同步上述策略。
3. 里程碑 C：测试与验收
   - 编写针对性单元测试覆盖三类节点；
   - 运行并修复可能的偏差；
   - 预览验收与交互核对。

## 校验清单（开发者自测）
- 抽屉确认后：标题/内容刷新与端口数量/位置更新；
- 单行节点：`in` 端口居内容区中心，`out-0` 居内容行中点；
- 多行分流：`out-i` 与各行中点一一对应；
- 连接保持：端口 ID 稳定，已有连线在有效端口上保持；
- 主题兼容：`dy` 与 `y` 方案在不同主题表现一致或差异可接受。
- 症状：节点配置后标题/内容未刷新，右侧 out 端口数量与位置未更新（与文档不一致）。
- 现状：
  - 抽屉确认后触发 `graph.trigger('node:config-updated')`（useConfigDrawers.js）。
  - 页面监听并调用 `updateNodeFromConfig(node, type, config)`。
  - `updateNodeFromConfig` 仅 `setProp('ports', ports)` 与 `setMarkup/Attrs`，未做端口“移除+新增”，X6 不一定立即重算端口，导致端口未对齐或数量未更新。
  - 行文本 y 基线基于顶部偏移，未与行中点对齐；左侧 `in` 默认居中于整节点，未对齐到内容区中心。

## 目标
- 严格按文档进行“标题行 + 内容行”映射；
- 基于映射行数重建端口数量（out-i）并精准对齐到各行中点；
- 左侧 `in` 端口对齐到“内容区中心”；
- 抽屉确认后，节点样式与端口即时刷新且保持现有连接的正确性。

## 更新流设计
1. 抽屉确认（useConfigDrawers.js）
   - 保存配置到节点：`node.setData({ isConfigured: true, config })`。
   - 触发：`graph.trigger('node:config-updated', { node, nodeType, config })`。
2. 页面处理（horizontal/index.vue）
   - 监听 `node:config-updated` → 调用 `updateNodeFromConfig(node, nodeType, config)`。
3. 节点刷新（updateNodeFromConfig）
   - 映射内容行：`buildDisplayLines(nodeType, config)`（增补 crowd-split/ab-test 兼容分支字段）。
   - 计算尺寸：`height = headerHeight + contentPadding + rows.length * rowHeight + padding`。
   - 计算行中点：`verticalOffsets[i] = headerHeight + contentPadding + i * rowHeight + rowHeight/2`。
   - 计算内容区中心：`inCenter = headerHeight + contentPadding + (rows.length * rowHeight)/2`。
   - 端口重建：
     - 移除旧端口：`node.getPorts().forEach(p => node.removePort(p.id))`。
     - 设置分组：`node.setProp('ports/groups', groups)`。
     - 新增 in：`addPort({ id: 'in', group: 'in', args: { dy: inCenter - height/2 } })`。
     - 新增 out-i：对每个行中点 `dy = verticalOffsets[i] - height/2` → `addPort({ id: 'out-i', group: 'out', args: { dy } })`。
   - 标题/内容渲染：
     - 标题文本优先 `config.nodeName`；
     - 行文本 y 采用行中点基础，加入 `baselineAdjust`（例如 `+5`）
   - 更新：`node.resize(width, height)`、`node.setMarkup(markup)`、`node.setAttrs(attrs)`、`node.setProp('label', '')`。

## 代码改动点
- 文件：`src/pages/marketing/tasks/horizontal/index.vue`
  - `buildDisplayLines` 增强字段兼容：
    - crowd-split 支持 `crowdLayers/branches/splitCount` 并追加“否则”；
    - ab-test 支持 `branches/variants/versions` 显示 `{name}：{percentage|ratio}%`；
    - manual-call 补充 `description`；wait 使用 `value+unit`；start 使用 `taskType/targetAudience`。
  - `updateNodeFromConfig`：
    - 使用 `config.nodeName || getNodeLabel(nodeType)`。
    - 计算 `verticalOffsets/inCenter`。
    - 端口重建（移除旧端口 + 新增 in/out-i）。
    - 行文本 y 改为 `行中点 + baselineAdjust`。
  - `createRectNode`：
    - 初始 ports 也传入 `nodeHeight` 与 `inVerticalOffset`，保证初次绘制对齐。
- 文件：`src/pages/marketing/tasks/horizontal/utils/portConfigFactoryHorizontal.js`
  - 接口：`createHorizontalPortConfig(outCount, { includeIn, outIds, verticalOffsets, nodeHeight, inVerticalOffset })`。
  - 实现：
    - in 使用 `dy = inVerticalOffset - nodeHeight/2`；
    - out-i 使用 `dy = verticalOffset[i] - nodeHeight/2`。

## 连接与兼容性处理
- 端口 ID 保持稳定命名：`out-0..out-n`；减少重绘后连接中断风险。
- 当分支减少导致某些 `out-i` 不再存在时，现有连接自动断开为正常；如需保留，可在 `nodeConfigManager` 中添加迁移策略映射旧端口至最近有效端口。

## 测试与验收
- 单元测试（vitest）：
  - 为 `updateNodeFromConfig` 构造不同配置（crowd-split, event-split, ab-test）验证：
    - `node.getPorts()` 个数正确，包含 `in` 与每行对应 `out-i`；
    - 每个 `out-i.args.dy` 与行中点差值符合 `dy = v - height/2`；
    - 标题文本为 `config.nodeName` 或类型标签；
  - 事件流：模拟 `node:config-updated`，断言 `updateNodeFromConfig` 被调用。
- 预览验证：
  - 修改抽屉配置（增减分支、调整名称/比例），节点内容刷新，右侧端口数量与位置随之更新；
  - 左侧 `in` 位于内容区中心；
  - start/end 无“更多”图标，其他节点显示图标并可操作。

## 风险与回退
- 文本基线在不同浏览器存在微差异：通过 `baselineAdjust` 可微调；必要时改用 `dominant-baseline`。
- X6 端口 `dy`/`y` 兼容：如个别主题要求使用 `y`，可在工厂中降级为 `y: verticalOffsets[i]`（同时移除 `nodeHeight`）进行比对测试。
- 若端口热重建导致边定位异常：可在重建后调用 `edge.setSource/Target` 强制刷新（通常不需要）。

## 执行计划
1. 修改 `portConfigFactoryHorizontal.js` 支持 `nodeHeight/inVerticalOffset` 并使用 `dy` 对齐。
2. 增强 `buildDisplayLines` 的字段兼容，实现与文档一致的映射。
3. 重构 `updateNodeFromConfig`，改为“移除 + 新增”端口的刷新方式，并对齐行文本。
4. 初始创建 `createRectNode` 同步使用上述对齐策略，确保首次绘制正确。
5. 编写针对性单元测试覆盖三类节点；运行并修复可能的偏差。

请确认以上方案，确认后我将按上述步骤进行代码改造与测试。
