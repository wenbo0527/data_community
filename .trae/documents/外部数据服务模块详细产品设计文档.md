# 外部数据服务模块详细产品设计文档

## 1. 模块定位与目标

### 1.1 定位
外部数据服务模块是外部数据生命周期管理的服务执行层，承担外部数据服务的统一申请、任务管理和结果展示职能，实现外数服务的标准化申请和全流程跟踪。

### 1.2 核心目标
- 建立统一的外数服务申请入口
- 实现外数服务任务的全程跟踪
- 提供标准化的服务申请流程
- 支撑外数服务的结果展示和查询
- 实现服务申请的可视化管理

## 2. 功能架构设计

### 2.1 核心功能矩阵

#### 2.1.1 服务申请管理
**功能描述**：统一管理外部数据服务的申请和配置

**详细功能点**：
- **在线数据明细申请**
  - 在线调用外部数据API接口
  - 支持外名、身份证、手机号等信息输入
  - 实时返回数据结果
  - 支持业务处理逻辑集成

- **外置数据回溯申请**
  - 历史数据回溯申请
  - 支持指定时间范围查询
  - 批量数据处理能力
  - 异步任务处理机制

- **全量变量回溯申请**
  - 过往历史数据全量回溯
  - 变量范围选择（全部/自定义）
  - 执行周期配置（每日跟跑/一次性）
  - 历史回溯区间设置
  - 样本范围定义

- **风险合规外数查询**
  - 客户风险合规相关数据查询
  - 支持身份证号查询模式
  - 支持批量回溯模式
  - 时间筛选功能
  - 查询确认列表生成

- **陪跑变量回溯申请**
  - 陪跑服务申请创建
  - 多步骤申请流程（基本信息→数据产品→场景选择→信贷产品）
  - 数据量分配和配置
  - 场景化数据配置

#### 2.1.2 任务查询管理
**功能描述**：提供任务状态的实时查询和跟踪

**详细功能点**：
- **任务列表展示**
  - 申请任务列表展示
  - 任务状态实时更新
  - 任务分类筛选
  - 任务搜索功能

- **任务状态跟踪**
  - 任务进度实时显示
  - 状态变更历史记录
  - 任务执行时间线
  - 异常状态预警

- **任务详情查看**
  - 任务参数详情展示
  - 执行日志查看
  - 结果预览功能
  - 失败原因分析

#### 2.1.3 结果展示管理
**功能描述**：统一展示服务申请的结果和数据

**详细功能点**：
- **结果列表展示**
  - 申请结果列表
  - 结果状态标识
  - 结果数据统计
  - 结果导出功能

- **结果详情查看**
  - 详细结果数据展示
  - 数据质量报告
  - 结果对比分析
  - 历史结果查询

- **结果数据管理**
  - 结果数据下载
  - 数据格式转换
  - 结果分享功能
  - 数据有效期管理

### 2.2 服务架构设计

#### 2.2.1 服务流程架构
```
服务申请 → 任务创建 → 任务执行 → 结果生成 → 结果展示
```

**各阶段职责**：
- **服务申请**：用户提交服务申请，配置申请参数
- **任务创建**：系统创建执行任务，分配资源
- **任务执行**：执行具体的数据服务任务
- **结果生成**：处理执行结果，生成报告数据
- **结果展示**：向用户展示执行结果和详细数据

#### 2.2.2 任务状态流转
```
待执行 → 执行中 → 已完成 → 结果展示
```

**状态说明**：
- **待执行**：任务已创建，等待执行
- **执行中**：任务正在执行中
- **已完成**：任务执行完成，结果已生成
- **结果展示**：结果已展示给用户

## 3. 用户界面设计

### 3.1 主要页面设计

#### 3.1.1 服务申请总览页
**页面布局**：
- **服务卡片区域**
  - 6种服务类型卡片展示
  - 服务描述和说明
  - 快速申请入口
  - 服务状态标识

- **快速操作区**
  - 统一申请入口
  - 任务查询入口
  - 结果查看入口
  - 帮助文档链接

#### 3.1.2 全量变量回溯申请页
**功能分区**：
- **申请列表**
  - 已创建申请展示
  - 添加新申请入口
  - 申请状态显示

- **申请配置区**
  - 变量范围选择
  - 执行周期配置
  - 历史回溯区间设置
  - 样本范围定义

- **申请说明区**
  - 申请说明文本框
  - 字数统计和限制
  - 申请提交按钮

#### 3.1.3 陪跑服务创建页
**信息架构**：
- **步骤导航**
  - 5步骤流程展示
  - 当前步骤高亮
  - 步骤状态标识

- **表单内容区**
  - 基本信息配置
  - 数据产品选择
  - 场景配置
  - 信贷产品配置

- **操作控制区**
  - 上一步/下一步按钮
  - 表单验证提示
  - 提交确认按钮

#### 3.1.4 任务查询页
**监控面板**：
- **任务列表**
  - 任务卡片展示
  - 任务状态筛选
  - 任务搜索功能
  - 批量操作按钮

- **任务详情**
  - 任务参数展示
  - 执行进度显示
  - 结果预览区域
  - 操作记录查看

### 3.2 可视化设计

#### 3.2.1 卡片组件
- **服务申请卡片**
  - 统一卡片样式设计
  - 服务类型图标
  - 服务描述文字
  - 申请状态标识

- **任务展示卡片**
  - 任务基本信息
  - 进度条显示
  - 状态标识图标
  - 操作按钮组

#### 3.2.2 表单组件
- **申请表单**
  - 分组表单设计
  - 步骤化填写流程
  - 实时验证反馈
  - 错误提示优化

- **配置表单**
  - 参数配置面板
  - 动态表单生成
  - 联动配置选项
  - 配置预览功能

## 4. 数据模型设计

### 4.1 核心实体

#### 4.1.1 服务申请（ServiceApplication）
```typescript
interface ServiceApplication {
  id: string;                     // 申请ID
  applicationCode: string;        // 申请编码
  serviceType: ServiceType;         // 服务类型
  serviceName: string;            // 服务名称
  applicant: User;                // 申请人
  department: string;             // 申请部门
  applicationTime: Date;        // 申请时间
  status: ApplicationStatus;    // 申请状态
  parameters: Record<string, any>; // 申请参数
  description: string;            // 申请说明
  taskId: string;               // 关联任务ID
  createdAt: Date;                // 创建时间
  updatedAt: Date;                // 更新时间
}
```

#### 4.1.2 执行任务（ExecutionTask）
```typescript
interface ExecutionTask {
  id: string;                     // 任务ID
  taskCode: string;             // 任务编码
  applicationId: string;          // 关联申请ID
  taskType: TaskType;           // 任务类型
  status: TaskStatus;           // 任务状态
  parameters: Record<string, any>; // 任务参数
  progress: number;             // 执行进度
  startTime: Date;                // 开始时间
  endTime: Date;                  // 结束时间
  executionLog: string[];       // 执行日志
  resultData: Record<string, any>; // 结果数据
  errorMessage: string;         // 错误信息
  createdAt: Date;                // 创建时间
  updatedAt: Date;                // 更新时间
}
```

#### 4.1.3 服务结果（ServiceResult）
```typescript
interface ServiceResult {
  id: string;                     // 结果ID
  resultCode: string;           // 结果编码
  taskId: string;               // 关联任务ID
  resultType: ResultType;       // 结果类型
  data: Record<string, any>;    // 结果数据
  dataSize: number;             // 数据大小
  fileUrl: string;              // 文件地址
  status: ResultStatus;         // 结果状态
  qualityScore: number;         // 质量评分
  expireTime: Date;             // 过期时间
  downloadCount: number;        // 下载次数
  createdAt: Date;                // 创建时间
}
```

#### 4.1.4 陪跑配置（AccompanyConfig）
```typescript
interface AccompanyConfig {
  id: string;                     // 配置ID
  workId: string;               // 工单ID
  name: string;                 // 配置名称
  cacheTime: string;            // 缓存时间
  days: number;               // 天数
  periods: number;              // 期数
  description: string;            // 描述说明
  periodDays: number[];         // 周期天数
  creditProducts: CreditProduct[]; // 信贷产品配置
  dataProducts: DataProduct[];  // 数据产品配置
  status: ConfigStatus;         // 配置状态
  createdBy: User;                // 创建人
  createdAt: Date;                // 创建时间
  updatedAt: Date;                // 更新时间
}
```

### 4.2 关联关系
- 申请与任务：1:1（一个申请对应一个任务）
- 任务与结果：1:1（一个任务对应一个结果）
- 申请与配置：1:N（一个申请有多个配置）
- 配置与产品：1:N（一个配置包含多个产品）

## 5. 业务流程设计

### 5.1 服务申请流程
1. **选择服务类型**：用户选择需要申请的服务类型
2. **填写申请信息**：填写服务申请的基本信息和参数
3. **配置服务参数**：根据服务类型配置具体的参数
4. **提交申请**：提交服务申请，系统创建任务
5. **任务执行**：系统执行创建的任务
6. **结果展示**：任务执行完成后展示结果

### 5.2 任务执行流程
1. **任务接收**：接收用户提交的服务申请
2. **参数验证**：验证申请参数的合法性
3. **任务创建**：创建执行任务，分配资源
4. **任务调度**：调度任务到执行队列
5. **任务执行**：执行具体的数据服务任务
6. **结果处理**：处理执行结果，生成报告
7. **结果存储**：存储执行结果和相关数据

### 5.3 结果展示流程
1. **结果查询**：用户查询任务执行结果
2. **权限验证**：验证用户查看结果的权限
3. **数据获取**：获取存储的执行结果数据
4. **结果展示**：向用户展示执行结果
5. **数据下载**：支持用户下载结果数据
6. **历史记录**：记录用户的查看和下载历史

## 6. 集成接口设计

### 6.1 内部接口
- **服务申请接口**：服务申请的提交和管理
- **任务查询接口**：任务状态的查询和跟踪
- **结果展示接口**：执行结果的获取和展示
- **配置管理接口**：陪跑配置的创建和管理

### 6.2 外部接口
- **数据服务接口**：外部数据服务的实际调用
- **文件存储接口**：结果文件的存储和管理
- **消息通知接口**：任务状态变更的通知
- **权限验证接口**：用户权限的验证和授权

## 7. 性能与扩展性设计

### 7.1 性能指标
- 服务申请响应时间：< 1s
- 任务创建响应时间：< 500ms
- 结果查询响应时间：< 500ms
- 并发申请处理能力：1000 QPS

### 7.2 扩展性设计
- **水平扩展**：支持服务实例的水平扩展
- **负载均衡**：支持多种负载均衡策略
- **缓存优化**：多级缓存提升性能
- **异步处理**：支持异步任务执行和通知

## 8. 安全与合规设计

### 8.1 数据安全
- **访问控制**：基于角色的服务访问控制
- **数据加密**：传输和存储数据的加密
- **审计日志**：完整的服务调用审计
- **敏感数据保护**：敏感数据的脱敏处理

### 8.2 合规要求
- **服务合规**：符合行业服务标准
- **数据合规**：符合数据保护法规
- **审计要求**：满足内外部审计要求
- **隐私保护**：保护用户隐私数据

## 9. 实施计划

### 9.1 第一阶段（MVP）
- 基础服务申请功能
- 简单任务查询
- 基本结果展示
- 基础陪跑服务

### 9.2 第二阶段（增强版）
- 高级服务申请
- 任务状态跟踪
- 结果详情展示
- 陪跑配置优化

### 9.3 第三阶段（完整版）
- 完整服务流程
- 智能任务调度
- 结果分析功能
- 企业级集成

## 10. 成功指标

### 10.1 使用指标
- 服务申请成功率：> 99%
- 任务执行成功率：> 95%
- 结果查询响应时间：< 500ms
- 用户满意度：> 4.5分（5分制）

### 10.2 业务指标
- 服务申请效率：提升80%
- 任务处理效率：提升70%
- 结果展示效率：改善60%
- 运营成本降低：减少40%

## 11. 状态机与任务编排

### 11.1 任务状态机
```
Created → Validating → Queued → Running → Succeeded
                           ↘ Failed → Retrying → Running
                           ↘ Cancelled
                           ↘ Archived
```
- **Created**：申请已接收，待校验
- **Validating**：参数合法性与权限校验
- **Queued**：进入执行队列，等待资源
- **Running**：执行中（可细分：准备、调用、回写、生成）
- **Succeeded**：执行成功，结果可用
- **Failed**：执行失败，记录原因并可重试
- **Retrying**：按退避策略重试中
- **Cancelled**：人工取消或超时取消
- **Archived**：结果归档完成

### 11.2 编排与幂等
- **幂等键**：`applicationCode` + 参数摘要（哈希）
- **重试策略**：指数退避（初始2s，最大2min，最多5次）
- **并发控制**：同一`applicationCode`串行执行，跨申请限流
- **补偿机制**：部分步骤失败支持补偿任务（结果回写、文件归档）

## 12. 接口契约与错误码

### 12.1 统一响应结构
`{ code: string, message: string, data?: any, traceId: string }`

### 12.2 REST 接口
- **申请**：
  - `POST /api/external/service/applications` 创建申请
  - `GET /api/external/service/applications` 查询申请列表
  - `GET /api/external/service/applications/{id}` 申请详情
- **任务**：
  - `POST /api/external/service/tasks` 创建任务（由申请触发）
  - `GET /api/external/service/tasks` 任务列表（状态筛选）
  - `GET /api/external/service/tasks/{id}` 任务详情与进度
  - `POST /api/external/service/tasks/{id}/cancel` 取消任务
- **结果**：
  - `GET /api/external/service/results` 结果列表
  - `GET /api/external/service/results/{id}` 结果详情
  - `POST /api/external/service/results/{id}/archive` 归档结果

### 12.3 错误码
- `SRV-4001` 参数校验失败
- `SRV-4031` 权限不足/租户隔离拒绝
- `SRV-4041` 资源不存在（申请/任务/结果）
- `SRV-4091` 幂等冲突（重复提交）
- `SRV-5001` 外部接口调用失败
- `SRV-5002` 结果生成失败
- `SRV-5003` 存储归档失败

## 13. 结果存储与归档

### 13.1 存储分层
- **热存储**：最近7天任务结果（便于快速访问）
- **温存储**：30-180天结果（文件+索引）
- **冷归档**：> 180天结果（对象存储+元数据最小集）

### 13.2 文件与格式
- **格式**：CSV/Parquet/JSON（依据数据量与用途）
- **命名**：`{applicationCode}/{taskId}/{resultCode}_{ts}.{ext}`
- **校验**：哈希校验与大小校验，存储完成后回写索引

### 13.3 保留与清理
- **保留策略**：按服务类型与合规等级设保留时间
- **清理任务**：定时清理过期数据，保留审计索引

## 14. 权限模型与租户隔离

### 14.1 角色与资源
- **角色**：管理员、申请人、执行人、审计员、访客
- **资源**：申请、任务、结果、文件、配置
- **操作**：创建、查看、下载、取消、归档、管理

### 14.2 隔离策略
- **租户隔离**：按部门/项目进行数据与操作隔离
- **范围授权**：资源基于所属部门/项目进行授权与校验

## 15. SLA、监控与运维

### 15.1 SLA 目标
- 申请响应 < 1s
- 任务启动 < 30s（非拥塞）
- 任务成功率 > 95%
- 结果可用性 > 99.9%

### 15.2 监控与告警
- **监控项**：队列长度、失败率、平均时延、接口超时、下载失败率
- **告警等级**：Info/Warning/Critical，关键失败自动建单
- **可视化**：运维仪表板（队列、失败、SLA、近24h趋势）

## 16. 审计与合规
- **审计**：关键操作与访问记录（下载、取消、归档、权限变更）
- **隐私**：敏感数据脱敏与访问控制，下载申请需审批
- **合规**：对外部接口数据保留与跨境传输遵循法规

## 17. 性能优化策略
- **缓存**：申请列表与任务列表分页缓存（短期）
- **批处理**：批量回溯按分片并行与断点续传
- **流式**：大结果支持流式下载与断点续传
- **索引**：结果元数据索引优化（时间/类型/申请人）

## 18. 实施里程碑与风险

### 18.1 里程碑
- M1：统一入口与申请管理上线
- M2：任务状态机与队列化执行完善
- M3：结果展示与归档打通
- M4：权限与审计、SLA运维仪表完善

### 18.2 风险与缓解
- 外部接口不稳定 → 重试与降级、供应商多活
- 大结果下载拥塞 → 流控与分片下载
- 合规审批耗时 → 预审流程与模板化申请

## 19. 术语表
- **队列化**：任务进入消息队列等待执行
- **断点续传**：中断后继续下载/上传剩余部分
- **分片并行**：将大任务分割为多个并行子任务
