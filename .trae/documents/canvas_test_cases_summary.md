# 预览线相关测试案例说明文档

## 文档说明

本文档为营销画布预览线功能的测试案例说明文档，用于指导测试案例的设计、开发和验证。文档涵盖预览线的生成、吸附、转化、恢复等核心功能的详细测试场景。

### 预览线生命周期

预览线在营销画布中经历完整的生命周期，包括生成、刷新、转化三个核心阶段：

### 布局引擎与预览线协调机制

#### 当前协调机制分析
系统采用**分离式协调**模式，布局引擎和预览线管理器相对独立运行，通过以下机制进行协调：

1. **引用传递机制**
   - 预览线管理器持有布局引擎引用：`this.layoutEngine`
   - 布局引擎持有预览线管理器引用：`this.previewLineManager`
   - 通过`setLayoutEngine()`方法建立双向引用关系

2. **时序协调机制**
   - 布局引擎完成层级计算后通知预览线管理器：`notifyPreviewManagerReady()`
   - 预览线管理器等待布局引擎就绪后处理待处理队列：`processPendingCalculations()`
   - 布局完成后触发预览线位置重新计算：`recalculateAllPreviewPositions()`

3. **位置同步机制**
   - 布局引擎提供层级Y坐标查询：`getNodeLayerY()`, `getNextLayerY()`
   - 预览线管理器调用布局引擎方法获取准确的终点位置
   - 布局引擎执行后主动更新预览线终点位置：`updatePreviewEndpointPosition()`

#### 潜在冲突点分析

1. **终点位置计算冲突**
   - **问题**: 布局引擎计算预览线终点位置时，预览线管理器可能同时进行位置更新
   - **影响**: 可能导致预览线终点位置不一致或闪烁
   - **风险等级**: 中等

2. **状态同步延迟**
   - **问题**: 布局引擎更新完成与预览线刷新之间存在时间差
   - **影响**: 短暂的视觉不一致，用户体验受影响
   - **风险等级**: 低

3. **重复计算问题**
   - **问题**: 布局引擎和预览线管理器可能重复计算相同的位置信息
   - **影响**: 性能开销增加，特别是在大型画布中
   - **风险等级**: 低

#### 优化建议

**方案一：增强现有协调机制（推荐）**
- 在布局引擎中增加预览线状态锁定机制
- 布局计算期间暂停预览线自主刷新
- 布局完成后统一触发预览线更新

**方案二：集成式管理**
- 将预览线终点计算完全集成到布局引擎中
- 布局引擎直接管理预览线的终点位置
- 预览线管理器专注于预览线的创建和交互逻辑

**方案三：事件驱动协调**
- 建立统一的事件总线系统
- 布局引擎和预览线管理器通过事件进行通信
- 确保状态变更的原子性和一致性

#### 1. 预览线生成（Generation）

**生成条件**：
- 节点必须明确标记为已配置状态（`isConfigured: true`）
- 节点类型为分支节点（如人群分流、AB实验、事件分流等）
- 节点不是结束节点或预览线相关节点
- 通过 `shouldCreatePreviewLine` 方法的完整验证

**生成过程**：
1. **节点配置验证**：检查节点的 `isConfigured` 字段状态
2. **数据更新重试**：通过重试机制确保节点数据同步
3. **节点同步等待**：调用 `waitForNodeSync` 确保节点状态一致
4. **预览线创建检查**：验证是否满足创建条件
5. **分支数计算**：根据节点配置计算需要创建的预览线数量
6. **预览线实例化**：通过 `createPreviewLineAfterConfig` 方法创建预览线实例

**核心方法**：`createPreviewLineAfterConfig`、`shouldCreatePreviewLine`

#### 2. 预览线刷新（Refresh）

**刷新触发条件**：
- 节点位置发生变化
- 画布布局引擎更新
- 节点配置状态改变
- 拖拽操作过程中的实时更新

**刷新过程**：
1. **节点有效性验证**：确认源节点和目标节点仍然有效
2. **布局引擎就绪检查**：等待布局引擎完成计算
3. **旧预览线实例清理**：移除过期的预览线实例
4. **待处理队列管理**：将更新任务加入处理队列
5. **分支预览线位置更新**：
   - 端口位置刷新
   - 路径点重新计算
   - 路由器配置更新
   - 视觉样式同步

**核心方法**：`updatePreviewLinePosition`、`reevaluateNodePreviewLines`

#### 3. 预览线转化（Transformation）

**转化触发条件**：
- 预览线终点成功吸附到目标节点
- 用户完成拖拽操作并释放鼠标
- 吸附距离在配置的阈值范围内（默认30像素）
- 目标节点为有效的可连接节点

**转化过程**：
1. **吸附检测**：计算预览线终点与目标节点的距离
2. **连接验证**：确认目标节点可以接受连接
3. **预览线隐藏**：隐藏或移除对应的预览线实例
4. **连接线创建**：创建正式的节点连接关系
5. **状态转换**：更新节点连接状态和拖拽状态
6. **视觉反馈清理**：清除高亮效果和临时视觉元素

**转化后恢复机制**：
- **节点连接后**：隐藏特定分支的预览线，保留其他分支
- **节点断开连接后**：重新创建对应分支的预览线
- **源节点预览线恢复**：清理已有预览线，重新评估并创建

**核心方法**：连接创建相关方法、`handleEdgeRemoved`（连接移除处理）

### 预览线状态变更触发条件

预览线的状态变更由多种事件和条件触发，系统通过事件监听和状态检查机制实现精确的状态管理：

#### 1. 节点配置相关触发条件

**节点配置完成触发**：
- **触发事件**：`onNodeConfigured` 方法调用
- **触发条件**：
  - 节点的 `isConfigured` 字段从 `false/undefined` 变为 `true`
  - 节点配置数据发生实质性变更
  - 分支节点的分流条件或规则配置完成
- **状态变更**：
  - 更新节点配置状态为已配置
  - 创建新的节点数据对象
  - 触发数据更新验证及重试逻辑
  - 延迟触发预览线重新评估（`reevaluateNodePreviewLines`）

**节点配置状态检查**：
- **检查方法**：`shouldCreatePreviewLine`
- **检查条件**：
  - 节点不为空且不是结束节点
  - 节点不是预览线相关节点
  - 强制更新模式或连接检查通过
  - 节点配置状态验证通过
- **自动修复逻辑**：检查并修复 `isConfigured` 字段状态
- **数据刷新验证**：确保节点数据与配置状态一致

#### 2. 节点连接相关触发条件

**节点连接建立触发**：
- **触发事件**：节点间成功建立连接
- **触发条件**：
  - 预览线终点成功吸附到目标节点
  - 吸附距离在阈值范围内（默认30像素）
  - 目标节点为有效的可连接节点
- **状态变更**：
  - 隐藏或移除对应分支的预览线
  - 保留其他未连接分支的预览线
  - 更新节点连接状态
  - 重置拖拽状态

**节点连接断开触发**：
- **触发事件**：`handleEdgeRemoved` 方法调用
- **触发条件**：
  - 用户删除现有连接线
  - 连接关系被程序性移除
  - 节点被删除导致连接断开
- **状态变更**：
  - 跳过预览线删除操作
  - 清理连接缓存数据
  - 重新创建对应分支的预览线
  - 恢复源节点的预览线显示

#### 3. 拖拽交互相关触发条件

**拖拽开始触发**：
- **触发事件**：预览线终点鼠标按下事件
- **触发条件**：
  - 鼠标在预览线终点区域按下
  - 预览线处于可拖拽状态
  - 事件冒泡被正确阻止
- **状态变更**：
  - 设置全局拖拽状态
  - 初始化拖拽位置坐标
  - 启动拖拽视觉反馈

**拖拽过程触发**：
- **触发事件**：`handleGlobalMouseMove` 方法调用
- **触发条件**：
  - 处于拖拽状态中
  - 鼠标位置发生变化
  - 坐标转换计算完成
- **状态变更**：
  - 实时更新拖拽位置
  - 检测吸附目标节点
  - 更新视觉高亮效果
  - 刷新预览线终点位置

**拖拽结束触发**：
- **触发事件**：`handleGlobalMouseUp` 或右键点击事件
- **触发条件**：
  - 鼠标释放或右键点击
  - 拖拽操作完成
  - 吸附检测完成
- **状态变更**：
  - 结束拖拽状态
  - 清除视觉反馈效果
  - 根据吸附结果创建连接或恢复预览线
  - 重置拖拽相关状态

#### 4. 画布布局相关触发条件

**布局更新触发**：
- **触发事件**：画布布局引擎更新
- **触发条件**：
  - 节点位置发生变化
  - 画布缩放或平移操作
  - 布局引擎重新计算完成
- **状态变更**：
  - 触发预览线位置刷新（`updatePreviewLinePosition`）
  - 重新计算端口位置和路径点
  - 更新路由器配置
  - 同步视觉样式

**画布交互触发**：
- **触发事件**：`handleBlankMouseUp`、`handleContextMenu`
- **触发条件**：
  - 用户在画布空白区域操作
  - 右键菜单事件触发
  - 需要取消当前拖拽操作
- **状态变更**：
  - 重置全局拖拽状态
  - 取消拖拽操作（`cancelDrag`）
  - 清除高亮效果
  - 恢复预览线原始状态

**核心触发方法**：`onNodeConfigured`、`shouldCreatePreviewLine`、`handleEdgeRemoved`、`handleGlobalMouseMove`、`handleGlobalMouseUp`、`cancelDrag`

## 测试范围

本文档专注于预览线相关功能的测试，包括：
- 分支节点配置完成后的预览线生成
- 预览线吸附功能
- 预览线转化成连接线
- 删除连接节点后预览线恢复
- 预览线重叠处理

## 测试案例编号规则

- **TC-BN-XXX**: 分支节点相关测试案例
- **TC-SNAP-XXX**: 吸附功能相关测试案例  
- **TC-CONN-XXX**: 连接转化相关测试案例
- **TC-RESTORE-XXX**: 预览线恢复相关测试案例
- **TC-OVERLAP-XXX**: 预览线重叠相关测试案例

## 测试文件分类

### 1. 预览线相关测试

#### 1.1 预览线终点拖拽吸附功能测试
**文件**: `src/tests/tdd-preview-line-snap.test.js`

**测试覆盖范围**:
- ✅ 预览线终点拖拽事件处理
  - 鼠标按下事件的正确处理
  - **右键点击结束拖拽并判断吸附** (已修正)
  - 事件冒泡的阻止机制
  - 预览线实例的查找逻辑

- ✅ 节点吸附检测算法
  - 吸附距离内节点的正确检测
  - 未配置节点的过滤逻辑
  - 距离计算的准确性
  - 最佳吸附位置的选择

- ✅ 坐标系转换准确性
  - 画布坐标到屏幕坐标的转换
  - 拖拽过程中坐标的实时更新
  - 坐标转换的一致性验证

- ✅ 吸附距离阈值配置
  - 配置值的正确读取（默认30像素）
  - 边界距离的准确判断
  - 阈值配置的有效性验证

- ✅ 拖拽状态管理
  - 拖拽开始时状态的正确设置
  - 拖拽过程中状态的维护
  - 拖拽结束时状态的清理

- ✅ 视觉反馈和高亮显示
  - 吸附目标节点的高亮显示
  - 高亮效果的正确清除
  - 视觉反馈的及时更新

- ✅ 连接创建验证
  - 成功吸附后连接的创建
  - 拖拽结束时连接逻辑的处理
  - 连接参数的正确传递

- ✅ 综合场景测试
  - 完整拖拽吸附流程的端到端测试
  - 多个拖拽位置的连续测试
  - 状态转换的完整性验证

#### 1.2 预览线初始化时机测试
**文件**: `src/tests/tdd-preview-line-initialization.test.js`

**测试覆盖范围**:
- ✅ 全节点类型的预览线创建检查
  - 开始节点：拒绝为未明确配置的start节点创建预览线
  - 等待节点：拒绝为未明确配置的wait节点创建预览线
  - AI外呼节点：拒绝为未明确配置的ai-call节点创建预览线
  - 人工典型节点：拒绝为未明确配置的manual节点创建预览线
  - 短信节点：拒绝为未明确配置的sms节点创建预览线
  - AB实验节点：拒绝为未明确配置的ab-test节点创建预览线
  - 人群分流节点：拒绝为未明确配置的audience-split节点创建预览线
  - 事件分流节点：拒绝为未明确配置的event-split节点创建预览线
  - 权益节点：拒绝为未明确配置的benefit节点创建预览线

- ✅ 严格禁止自动修复逻辑
  - **明确规定：系统不应该包含任何自动修复逻辑，以避免增加项目复杂性**
  - shouldNodeBeConfigured方法不应该自动修复任何节点的配置状态
  - 配置检查应该是纯粹的状态验证，不包含任何修改操作
  - 所有节点配置必须通过明确的用户操作完成

- ✅ isConfigured字段更新逻辑判断
  - 测试isConfigured字段从undefined到true的状态变化
  - 测试isConfigured字段从false到true的状态变化
  - 测试isConfigured字段从true到false的状态变化
  - 验证字段更新后预览线的正确重新评估
  - 确保字段更新触发相应的预览线创建或删除操作

- ✅ 严格的配置检查逻辑
  - 只有明确标记为已配置(isConfigured: true)的节点才应该创建预览线
  - isConfigured字段缺失(undefined)时应该视为未配置
  - isConfigured字段为false时应该视为未配置
  - 配置检查必须是实时的，不依赖缓存状态

- ✅ 配置完成事件监听机制
  - 提供配置完成事件监听接口
  - 配置完成后触发预览线重新评估
  - 支持批量配置更新的事件处理

#### 1.3 通用预览线节点测试

**测试覆盖范围**:
- ✅ 预览线节点有效性验证
  - 当源节点存在时，预览线视为有效节点
  - 预览线必须有明确的起始节点引用
  - 预览线的生命周期与源节点绑定
  - 源节点删除时，相关预览线自动清理

- ✅ 预览线终点拖拽和吸附功能
  - 预览线终点支持鼠标拖拽操作
  - 拖拽过程中提供实时视觉反馈
  - 支持拖拽到目标节点进行吸附
  - 吸附成功后自动转换为正式连接线
  - 拖拽取消时预览线恢复原始状态

#### 1.4 分支节点配置完成后预览线生成测试
**文件**: `src/tests/preview-line-branch-configuration.test.js`

**测试案例说明**:

**TC-BN-001: 人群分流节点配置完成后预览线生成**
- **前置条件**: 画布中存在人群分流节点，节点处于未配置状态
- **测试步骤**: 
  1. 完成人群分流节点的分流条件配置
  2. 设置分流比例和目标人群
  3. 保存节点配置
- **预期结果**: 
  - 节点配置完成后自动生成对应数量的预览线
  - 每条预览线对应一个分流分支
  - 预览线起点连接到人群分流节点的out端口
  - 预览线具有不同的视觉标识区分分支

**TC-BN-002: AB实验节点配置完成后预览线生成**
- **前置条件**: 画布中存在AB实验节点，节点处于未配置状态
- **测试步骤**:
  1. 配置AB实验的实验组和对照组
  2. 设置实验分流比例
  3. 完成实验参数配置并保存
- **预期结果**:
  - 自动生成两条预览线（实验组和对照组）
  - 预览线带有分支标识（A组、B组）
  - 预览线颜色或样式有所区分
  - 预览线生成位置准确对应节点out端口

**TC-BN-003: 事件分流节点配置完成后预览线生成**
- **前置条件**: 画布中存在事件分流节点，节点处于未配置状态
- **测试步骤**:
  1. 配置事件触发条件
  2. 设置分流规则和条件
  3. 保存节点配置
- **预期结果**:
  - 根据配置的分流条件数量生成对应预览线
  - 每条预览线对应一个事件分流条件
  - 预览线显示条件标签或标识
  - 预览线生成后立即可进行拖拽操作

**TC-BN-004: 分支节点配置变更时预览线动态调整**
- **前置条件**: 分支节点已配置并生成预览线
- **测试步骤**:
  1. 修改分支节点的分流条件
  2. 增加或减少分支数量
  3. 保存配置变更
- **预期结果**:
  - 预览线数量根据新配置动态调整
  - 多余的预览线被自动删除
  - 新增的预览线被自动创建
  - 现有连接不受影响，仅调整未连接的预览线

### 2. 拖拽交互相关测试

#### 2.1 拖拽交互管理器测试
**文件**: `src/tests/interaction/DragInteractionManager.test.ts`

**测试覆盖范围**:
- ✅ 初始化测试
  - 正确初始化DragInteractionManager
  - 注册必要的事件监听器

- ✅ 节点拖拽功能
  - 开始节点拖拽
  - 支持拖拽开始节点
  - 支持拖拽分支节点
  - 支持拖拽结束节点
  - 更新节点拖拽位置
  - 结束节点拖拽

### 3. 吸附功能相关测试

#### 3.1 预览线吸附功能测试
**文件**: `src/tests/preview-line-snap.test.js`

**测试案例说明**:

**TC-SNAP-001: 预览线拖拽接近节点时的吸附检测**
- **前置条件**: 画布中存在预览线和目标节点
- **测试步骤**:
  1. 拖拽预览线终点接近目标节点
  2. 当距离小于吸附阈值时观察吸附效果
  3. 继续拖拽验证吸附跟随效果
- **预期结果**:
  - 预览线终点在吸附范围内自动吸附到节点in端口
  - 吸附时显示视觉反馈（高亮、颜色变化等）
  - 吸附状态下预览线终点跟随节点移动
  - 吸附距离阈值配置生效

**TC-SNAP-002: 节点拖拽接近预览线时的吸附检测**
- **前置条件**: 画布中存在节点和预览线
- **测试步骤**:
  1. 拖拽节点接近预览线终点
  2. 当距离达到吸附条件时观察吸附效果
  3. 验证吸附后的连接状态
- **预期结果**:
  - 节点in端口自动吸附到预览线终点
  - 吸附时节点和预览线都有视觉反馈
  - 吸附完成后预览线终点精确连接到节点in端口
  - 吸附过程流畅无卡顿

**TC-SNAP-003: 多个节点同时在吸附范围内的优先级处理**
- **前置条件**: 画布中存在一条预览线和多个相邻节点
- **测试步骤**:
  1. 拖拽预览线到多个节点的吸附范围内
  2. 观察吸附目标的选择逻辑
  3. 验证吸附优先级规则
- **预期结果**:
  - 优先吸附距离最近的节点
  - 同等距离时按照节点类型优先级吸附
  - 只有一个节点显示吸附反馈
  - 吸附目标切换时有平滑过渡

**TC-SNAP-004: 吸附状态下的取消操作**
- **前置条件**: 预览线已吸附到目标节点
- **测试步骤**:
  1. 将已吸附的预览线拖拽离开吸附范围
  2. 观察吸附状态的取消过程
  3. 验证预览线恢复自由状态
- **预期结果**:
  - 拖拽超出吸附范围时自动取消吸附
  - 吸附视觉反馈立即消失
  - 预览线恢复为自由拖拽状态
  - 取消吸附过程无延迟

**TC-SNAP-005: 分支节点的多端口吸附处理**
- **前置条件**: 画布中存在分支节点（具有多个in端口）
- **测试步骤**:
  1. 拖拽预览线接近分支节点的不同in端口
  2. 验证各个端口的吸附检测
  3. 测试端口间的吸附切换
- **预期结果**:
  - 每个in端口都能正确检测吸附
  - 吸附到最近的可用in端口
  - 端口间切换时有明确的视觉指示
  - 已占用端口不参与吸附检测

#### 3.2 节点吸附预览线测试
**文件**: `src/tests/interaction/NodeSnapToPreviewLine.test.js`

**测试覆盖范围**:
- ✅ 节点拖拽靠近预览线的吸附检测
  - 检测拖拽节点与预览线的距离
  - 在吸附距离内时触发吸附效果
  - 选择最近的一条预览线进行吸附
  - **限制：仅吸附1条预览线，避免多重吸附**

- ✅ 节点到预览线的转换逻辑
  - 吸附成功后将预览线转换为正式连接线
  - 保持原有预览线的起始节点和分支信息
  - 更新连接线的终点为被拖拽的节点
  - 清理原预览线的视觉元素

- ✅ 吸附过程的视觉反馈
  - 节点接近预览线时的高亮效果
  - 预览线在吸附范围内的样式变化
  - 吸附成功时的动画效果
  - 吸附失败时的恢复动画

#### 3.3 预览线吸附节点测试
**文件**: `src/tests/interaction/PreviewLineSnapToNode.test.js`

**测试覆盖范围**:
- ✅ 预览线终点拖拽到节点的吸附检测
  - 检测预览线终点与目标节点的距离
  - 进入吸附距离后触发吸附效果
  - 支持吸附到节点的输入端口

- ✅ 预览线到连接线的转换逻辑
  - 吸附成功后将预览线转换为正式连接线
  - 建立起始节点与目标节点的连接关系
  - 更新连接线的终点坐标为目标节点端口
  - 清理预览线的临时状态

- ✅ 吸附目标节点的验证
  - 验证目标节点是否支持连接
  - 检查节点的输入端口可用性
  - 避免重复连接和循环连接
  - 验证连接的业务逻辑合法性

#### 3.4 吸附功能通用测试
**文件**: `src/tests/SnapCoordinateSystem.test.js`

**测试覆盖范围**:
- ✅ 吸附距离阈值配置
  - 验证配置有效性（默认30像素）
  - 合并配置
  - 根据上下文调整配置

- ✅ 坐标系转换测试
  - 坐标验证缓存的工作机制
  - 缓存过期逻辑

- ✅ 吸附检测算法优化
  - 检测吸附目标的初始用例
  - 跳过特殊节点
  - 应用坐标修正
  - 空图形处理
  - 重叠节点处理
  - 极大坐标值处理
  - 负坐标值处理

- ✅ 性能测试
  - 坐标验证缓存性能
  - 大量节点时的吸附性能

- ✅ 边界情况测试
  - 各种边界条件处理

- ✅ 集成测试
  - 完整吸附流程
  - 多分支预览线处理

### 4. 预览线转化成连接线测试

#### 4.1 预览线转连接线核心功能测试
**文件**: `src/tests/preview-line-to-connection.test.js`

**测试案例说明**:

**TC-CONN-001: 预览线吸附成功后自动转化为连接线**
- **前置条件**: 画布中存在预览线和目标节点
- **测试步骤**:
  1. 拖拽预览线终点到目标节点的吸附范围内
  2. 释放鼠标完成吸附操作
  3. 观察预览线转化过程
- **预期结果**:
  - 预览线立即转化为正式连接线
  - 连接线样式从预览状态变为正常状态
  - 连接线两端精确连接到源节点out端口和目标节点in端口
  - 转化过程有平滑的视觉过渡效果

**TC-CONN-002: 分支预览线转化为连接线时的分支标识保持**
- **前置条件**: 分支节点已配置并生成带标识的预览线
- **测试步骤**:
  1. 拖拽带有分支标识的预览线到目标节点
  2. 完成吸附操作
  3. 验证转化后的连接线
- **预期结果**:
  - 连接线保持原有的分支标识
  - 分支标签正确显示在连接线上
  - 连接线颜色或样式与分支类型匹配
  - 分支信息在连接线属性中正确记录

**TC-CONN-003: 预览线转化失败时的回滚处理**
- **前置条件**: 画布中存在预览线和不兼容的目标节点
- **测试步骤**:
  1. 尝试将预览线连接到不兼容的节点
  2. 或在连接过程中触发验证失败
  3. 观察系统的处理方式
- **预期结果**:
  - 转化失败时预览线保持原状
  - 显示明确的错误提示信息
  - 预览线可以继续进行其他操作
  - 不会产生无效的连接线

**TC-CONN-004: 多条预览线同时转化的处理**
- **前置条件**: 分支节点存在多条预览线
- **测试步骤**:
  1. 快速将多条预览线连接到不同目标节点
  2. 观察转化过程的并发处理
  3. 验证所有连接线的正确性
- **预期结果**:
  - 所有预览线都能正确转化为连接线
  - 转化过程不会相互干扰
  - 每条连接线都保持独立的属性
  - 转化完成后画布状态一致

**TC-CONN-005: 预览线转化后的数据持久化**
- **前置条件**: 预览线成功转化为连接线
- **测试步骤**:
  1. 完成预览线到连接线的转化
  2. 保存画布状态
  3. 重新加载画布
- **预期结果**:
  - 连接线信息正确保存到数据模型
  - 重新加载后连接线正确显示
  - 连接关系在工作流数据中正确记录
  - 分支信息等属性完整保存

#### 4.2 坐标一致性集成测试
**文件**: `src/tests/integration/coordinate-consistency.test.ts`

**测试覆盖范围**:
- ✅ 预览线终点坐标精确连接验证
  - 预览线终点精确连接到目标节点in端口坐标
  - 拖拽过程中正确计算预览线到in端口的坐标
  - 预览线终点坐标的实时更新和同步
  - 坐标转换过程中的精度保持

- ✅ 预览线终点坐标校验增强
  - 预览线创建时终点坐标的准确性验证
  - 预览线拖拽过程中终点坐标的连续性检查
  - 预览线吸附时终点坐标的精确对齐
  - 多分支预览线终点坐标的独立验证

### 5. 删除连接节点后恢复预览线测试

#### 5.1 连接线删除后预览线恢复功能测试
**文件**: `src/tests/connection-delete-preview-restore.test.js`

**测试案例说明**:

**TC-RESTORE-001: 删除普通节点连接后预览线恢复**
- **前置条件**: 画布中存在已连接的普通节点（开始节点→AI外呼节点）
- **测试步骤**:
  1. 选中并删除目标节点（AI外呼节点）
  2. 观察源节点的连接状态变化
  3. 验证预览线的恢复情况
- **预期结果**:
  - 连接线立即被删除
  - 源节点的out端口自动生成预览线
  - 预览线样式恢复为未连接状态
  - 预览线可以正常进行拖拽操作

**TC-RESTORE-002: 删除分支节点连接后多预览线恢复**
- **前置条件**: 分支节点（人群分流）的多个分支已连接到不同目标节点
- **测试步骤**:
  1. 删除其中一个已连接的目标节点
  2. 观察分支节点的连接状态
  3. 验证对应分支预览线的恢复
- **预期结果**:
  - 只有被删除节点对应的连接线被移除
  - 该分支自动恢复为预览线状态
  - 其他分支的连接状态不受影响
  - 恢复的预览线保持原有的分支标识

**TC-RESTORE-003: 删除连接线后预览线恢复**
- **前置条件**: 画布中存在已建立的连接线
- **测试步骤**:
  1. 直接选中并删除连接线
  2. 观察源节点和目标节点的状态变化
  3. 验证预览线的恢复情况
- **预期结果**:
  - 连接线被成功删除
  - 源节点的out端口恢复预览线
  - 目标节点的in端口变为可连接状态
  - 预览线恢复后可以重新进行连接操作

**TC-RESTORE-004: 批量删除节点后预览线批量恢复**
- **前置条件**: 画布中存在多个已连接的节点
- **测试步骤**:
  1. 框选多个已连接的目标节点
  2. 执行批量删除操作
  3. 观察所有受影响源节点的状态
- **预期结果**:
  - 所有相关连接线被删除
  - 所有受影响的源节点都恢复预览线
  - 预览线恢复过程不会相互干扰
  - 批量恢复后所有预览线都可正常操作

**TC-RESTORE-005: 删除中间节点后连接链路的预览线恢复**
- **前置条件**: 存在连接链路（节点A→节点B→节点C）
- **测试步骤**:
  1. 删除中间节点B
  2. 观察节点A和节点C的状态变化
  3. 验证预览线恢复情况
- **预期结果**:
  - 节点A的out端口恢复预览线
  - 节点C的in端口变为可连接状态
  - 两条连接线都被正确删除
  - 节点A的预览线可以直接连接到节点C

**TC-RESTORE-006: 分支节点部分连接删除后的预览线状态管理**
- **前置条件**: 分支节点有3个分支，其中2个已连接，1个保持预览线状态
- **测试步骤**:
  1. 删除其中一个已连接的目标节点
  2. 观察分支节点的整体状态
  3. 验证所有分支的显示状态
- **预期结果**:
  - 被删除连接对应的分支恢复为预览线
  - 原有的预览线分支保持不变
  - 剩余的连接分支状态正常
  - 分支节点总是保持至少一条预览线可见

### 6. 工作流编辑器相关测试

#### 4.1 工作流编辑器组件测试
**文件**: `src/tests/components/WorkflowEditor.test.js`

**测试覆盖范围**:
- ✅ 组件初始化
  - 正确渲染工作流编辑器
  - 正确初始化图形画布

- ✅ 工具栏功能
  - 各种工具栏操作

- ✅ 工作流操作
  - 工作流的基本操作

- ✅ 节点操作
  - 节点的创建、编辑、删除等操作

- ✅ 数据输出节点测试
  - 数据输出相关功能

- ✅ Monaco代码编辑器测试
  - 代码编辑功能

- ✅ 数据源配置测试
  - 数据源相关配置

- ✅ 增强调试功能测试
  - 节点级调试
  - 全流程调试
  - 调试状态可视化
  - 调试断点功能
  - 调试日志和错误信息
  - 调试数据查看
  - 调试模式切换

### 6. 预览线重叠处理测试

#### 6.1 预览线重叠检测测试
**文件**: `src/tests/preview-line-overlap.test.js`

**测试覆盖范围**:
- ✅ 预览线重叠检测算法
  - 检测两条预览线是否存在路径重叠
  - 计算重叠区域的长度和位置
  - 识别完全重叠和部分重叠的情况
  - 处理多条预览线同时重叠的复杂场景

- ✅ 重叠预览线的视觉处理
  - 重叠预览线的样式差异化显示
  - 重叠区域的特殊标识和高亮
  - 重叠预览线的层级管理
  - 鼠标悬停时的重叠预览线区分

- ✅ 重叠预览线的交互处理
  - 点击重叠区域时的预览线选择逻辑
  - 拖拽重叠预览线时的优先级处理
  - 重叠预览线的独立操作支持
  - 重叠状态下的吸附行为优化

#### 6.2 预览线重叠优化测试
**文件**: `src/tests/preview-line-overlap-optimization.test.js`

**测试覆盖范围**:
- ✅ 自动避让算法测试
  - 新建预览线时自动避开已有预览线
  - 基于最短路径的智能路由算法
  - 预览线路径的动态调整机制
  - 避让过程中的性能优化

- ✅ 重叠预览线的合并处理
  - 相同起终点预览线的合并逻辑
  - 合并后预览线的标识和区分
  - 合并预览线的拆分操作
  - 合并状态的持久化管理

- ✅ 重叠场景的性能测试
  - 大量预览线重叠时的渲染性能
  - 重叠检测算法的时间复杂度优化
  - 重叠处理的内存使用效率
  - 实时重叠检测的响应速度

### 7. 其他相关测试

#### 5.1 综合预览线测试
**文件**: `src/tests/audience-split-preview-line-comprehensive.test.js`
- 人群分流节点的综合预览线测试

#### 5.2 统一预览线重构测试
**文件**: `src/tests/unified-preview-line-refactor.test.js`
- 预览线重构相关测试

#### 5.3 工作流节点测试
**文件**: `src/tests/WorkflowNode.test.js`
- 工作流节点的基础功能测试

## 测试覆盖情况分析

### 已覆盖的功能模块

1. **预览线管理** ✅
   - 预览线创建、删除、更新逻辑
   - 不同节点类型的预览线生成策略
   - 预览线初始化时机控制

2. **拖拽交互** ✅
   - 节点拖拽的完整生命周期
   - 拖拽状态管理
   - 拖拽事件处理

3. **吸附功能** ✅
   - 吸附检测算法
   - 吸附距离阈值配置
   - 吸附目标选择逻辑

4. **坐标系统** ✅
   - 坐标转换的准确性
   - 坐标缓存机制
   - 坐标一致性验证

5. **视觉反馈** ✅
   - 高亮显示效果
   - 预览线样式管理
   - 状态可视化

6. **事件处理** ✅
   - 鼠标事件处理
   - 键盘事件处理
   - 事件冒泡控制

### 可能的测试缺口

1. **画布挂载相关测试** ⚠️
   - 画布组件的挂载和卸载测试较少
   - 画布生命周期管理测试不足

2. **性能测试** ⚠️
   - 大量节点时的拖拽性能测试
   - 复杂预览线场景的性能测试

3. **边界条件测试** ⚠️
   - 极端坐标值的处理
   - 画布边界的拖拽行为

## 总结

项目在预览线、拖拽、吸附等核心功能方面有较为完善的测试覆盖，特别是在功能逻辑和交互行为方面。建议优先补充画布挂载生命周期相关的测试，以确保画布组件在各种场景下的稳定性。

---

**文档生成时间**: 2024年12月  
**测试框架**: Vitest  
**覆盖范围**: 预览线、拖拽、吸附、坐标系统、画布交互