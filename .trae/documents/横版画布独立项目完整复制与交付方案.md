## 可行性评估

* 当前子应用状态：已具备画布核心（X6+vue-shape、端口布局、工具栏、历史、选择、边插入与右键、调试/统计、MiniMap、保存回传）、任务列表页（搜索/过滤/统计、编辑/查看/新建/删除/发布）。

* 尚存耦合：部分功能仍通过 `@host` 引用宿主组件/组合函数（如 `CanvasToolbar/CanvasHistoryPanel/CanvasDebugPanel/CanvasStatisticsPanel/TaskFlowConfigDrawers/NodeTypeSelector/ConnectionContextMenu/useConfigDrawers/useCanvasHistory` 等），以及预览线拖拽全过程的事件绑定尚未完全本地化。

* 结论：可完整复制为独立项目；需要将所有 `@host` 依赖迁入子项目本地模块，并本地化预览线系统与性能模块。

## 独立项目结构

* 根目录

  * `package.json`（Vue3+Vite5、vue-router4、@arco-design/web-vue、@antv/x6 + x6-vue-shape + history/selection/minimap 插件）

  * `vite.config.ts`（别名 `@` -> `src`，SVG/CSS 配置）

  * `index.html`（挂载点 `#app`）

  * `README.md`（项目说明）

  * `docs/`（使用文档、二次开发指引、消息协议说明、架构与模块关系）

* `src/`

  * `main.ts`（Arco 注册、图标注册、路由挂载）

  * `router.ts`（`/tasks` 列表、`/editor` 画布）

  * `pages/`

    * `tasks/TasksList.vue`（完整列表功能：搜索过滤、统计、编辑/查看/新建/删除/发布）

    * `editor/App.vue`（横版画布页面）

  * `components/`

    * `nodes/BaseNode.vue`

    * `toolbar/CanvasToolbar.vue`

    * `history/CanvasHistoryPanel.vue`

    * `debug/CanvasDebugPanel.vue`

    * `statistics/CanvasStatisticsPanel.vue`

    * `canvas/NodeTypeSelector.vue`

    * `canvas/ConnectionContextMenu.vue`

    * `task/TaskFlowConfigDrawers.vue`

  * `pages/horizontal/`

    * `HorizontalNode.vue`

    * `createVueShapeNode.js`

    * `styles/nodeStyles.js`

    * `utils/portConfigFactoryHorizontal.js`

    * `utils/quickLayout.js`（HorizontalQuickLayout）

    * `services/CanvasController.js`、`services/EventService.js`

  * `composables/`

    * `useGraphInstance.js`、`useConfigDrawers.js`、`useCanvasHistory.js`

    * `usePreviewLine.js`（拖拽创建/吸附/转换/清理，删除恢复）

    * `canvas/unified/EdgeTypes.js`

  * `utils/`

    * `nodeTypes.js`（统一节点文案/颜色）

    * `taskStorage.js`（localStorage 持久化，支持独立与嵌入模式）

* `tests/`（画布交互、预览线、列表操作的单测/E2E）

## 去宿主化改造点

* 移除所有 `@host` 引用，改为本地 `@/` 模块；复制宿主涉及的组件与组合函数到子项目。

* 统一 `nodeTypes.js` 与 `node样式`，确保视觉与文案与原版一致。

* 绑定预览线拖拽全流程事件：端口 `mouseenter/mousedown/mousemove/mouseup` → `usePreviewLine` 的 `create/convert/remove`，引入 `PortConfigurationFactory`、`InPortSnapDetector`，实现吸附与校验、去重与转换。

* 性能监控：接入空间索引/批处理/缓存优化（在 `usePreviewLine` 内开启），提供配置开关。

* 历史与快捷键：保留 X6 History 插件与 `useCanvasHistory` 的状态同步与快捷键绑定。

## 运行模式与消息协议

* 独立运行模式（默认）：

  * 任务列表读写 `taskStorage`，新建后跳转 `/editor?mode=edit&id=...&version=...`；保存写回本地。

* 嵌入模式（iframe，可选）：

  * 宿主 ↔ 子应用消息：

    * 子应用请求：`query-tasks/query-stats/create-task/delete-task/publish-task/unpublish-task`

    * 子应用编辑器：`init/ready/save`（载入与保存）

  * 文档提供示例宿主桥接代码与接口说明。

## 文档交付

* `README.md`：项目背景、功能概览、快速开始、构建与部署、常见问题。

* `docs/usage.md`：

  * 安装与运行（独立/嵌入）

  * 路由说明（`/tasks`、`/editor`）与参数表（`mode/id/version`）

  * 任务数据结构（`nodes/connections/type/config`）

* `docs/integration.md`：宿主消息协议与示例代码、跨域注意事项、Iframe 集成与回调约定。

* `docs/canvas.md`：画布架构、端口布局与节点渲染、预览线系统与性能优化、历史与工具栏。

* `docs/changelog.md`：版本与差异说明。

## 测试与验收

* 功能验收：

  * 列表页：搜索过滤、统计、编辑/查看/新建/删除/发布

  * 画布：添加节点、抽屉配置更新、历史撤销重做、边插入与右键、最小地图、调试/统计面板

  * 预览线：拖拽吸附与转换、去重、删除恢复

* 自动化：

  * 单元测试：节点/连接生成、`usePreviewLine` 核心逻辑

  * E2E：列表→编辑→保存→回列表联动

## 实施步骤

1. 复制并本地化所有组件与组合函数（去除 `@host`）
2. 完成预览线拖拽事件绑定与性能模块接入
3. 统一 `nodeTypes`、样式与图标注册
4. 完善任务列表（独立+嵌入兼容）与 `taskStorage`
5. 补充文档与示例宿主桥接代码
6. 添加基本单测与 E2E 场景，验证核心链路
7. 构建与发布（`vite build`），输出 `dist/` 与文档

## 风险与注意

* 依赖版本一致性（Vue/X6/Arco）；确认 x6 插件版本匹配

* 预览线事件绑定复杂度与性能开关默认值

* 独立与嵌入模式的数据源差异：localStorage 与消息桥接的边界

## 交付物

* 独立可运行项目仓库（含 `src/`、`docs/`、`tests/`）

* 可选 NPM 包（如需作为组件库形式嵌入）

* 文档与示例代码完整齐备

