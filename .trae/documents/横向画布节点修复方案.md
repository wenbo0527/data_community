# æ¨ªå‘ç”»å¸ƒèŠ‚ç‚¹ä¿®å¤æ–¹æ¡ˆ

## æ¦‚è¿°

åŸºäºç¬¦åˆæ€§è¯„ä¼°æŠ¥å‘Šï¼Œåˆ¶å®šå…·ä½“çš„ä»£ç ä¿®å¤æ–¹æ¡ˆï¼Œç¡®ä¿æ¨ªå‘ç”»å¸ƒèŠ‚ç‚¹å®ç°å®Œå…¨ç¬¦åˆè®¾è®¡è§„èŒƒã€‚

## 1. BaseNodeç»„ä»¶ä¿®å¤

### 1.1 æ ·å¼ä¿®æ­£

**æ–‡ä»¶**: `src/components/nodes/BaseNode.vue`

```vue
<style scoped>
.base-node {
  position: relative;
  width: 100%;
  height: 100%;
  background: #FFFFFF;  /* ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚ */
  border: 1px solid #E5E7EB;  /* ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚1px */
  border-radius: 8px;
  display: flex;
  flex-direction: column;
  box-shadow: 0 2px 6px rgba(0,0,0,.08);
  transition: all .2s ease;
  cursor: grab;
}

.node-header {
  display: flex;
  align-items: center;
  height: 36px;
  padding: 0 12px;
  background: #F8FAFC;  /* ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚ */
  border-bottom: 1px solid #E5E7EB;  /* ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚ */
  border-radius: 8px 8px 0 0;  /* ä¿®æ­£ï¼šä¸ä¸»ä½“åœ†è§’ä¸€è‡´ */
  flex-shrink: 0;
}

.node-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  padding: 12px;  /* ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚12px */
  gap: 0;  /* ä¿®æ­£ï¼šä½¿ç”¨å›ºå®šè¡Œé«˜ï¼Œä¸è®¾gap */
  overflow: hidden;
}
</style>
```

### 1.2 å›¾æ ‡æ ·å¼ä¿®æ­£

```vue
<style scoped>
.node-icon {
  width: 28px;  /* ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚28px */
  height: 20px;  /* ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚20px */
  line-height: 20px;
  text-align: center;
  border-radius: 6px;  /* ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚6px */
  background: #14B8A6;  /* ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚è“ç»¿è‰² */
  color: #fff;
  font-size: 12px;  /* ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚12px */
  font-weight: 600;
  margin-right: 8px;
}

.node-title {
  flex: 1;
  font-size: 13px;  /* ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚13px */
  color: #111827;  /* ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚ */
  font-weight: 600;  /* ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚ç²—ä½“ */
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
</style>
```

## 2. HorizontalNodeç»„ä»¶ä¿®å¤

### 2.1 å†…å®¹åŒºå¸ƒå±€ä¿®æ­£

**æ–‡ä»¶**: `src/pages/marketing/tasks/horizontal/HorizontalNode.vue`

```vue
<template>
  <BaseNode
    :node-type="nodeType"
    :selected="selected"
    :hover="hover"
    :disabled="disabled"
  >
    <template #icon>
      <span class="node-icon">{{ iconText }}</span>
    </template>
    <template #title>{{ headerTitle }}</template>

    <!-- å†…å®¹åŒºï¼šä½¿ç”¨è§„èŒƒè¦æ±‚çš„è¡Œé«˜32px -->
    <div class="horizontal-node__content">
      <!-- è¾“å…¥ç«¯å£æŒ‡ç¤ºå™¨ -->
      <div v-if="showIn" class="port-indicator port-indicator--in">
        <span class="port-indicator__label">{{ inLabel }}</span>
      </div>
      <!-- è¾“å‡ºç«¯å£æŒ‡ç¤ºå™¨ï¼šæ¯è¡Œ32pxé«˜åº¦ -->
      <div 
        v-for="(text, idx) in outRows" 
        :key="idx"
        class="port-indicator port-indicator--out"
      >
        <span class="port-indicator__label">{{ text }}</span>
      </div>
    </div>
  </BaseNode>
</template>
```

### 2.2 æ ·å¼ä¿®æ­£

```vue
<style scoped>
.horizontal-node__content {
  display: flex;
  flex-direction: column;
  /* ä¿®æ­£ï¼šç§»é™¤gapï¼Œä½¿ç”¨å›ºå®šè¡Œé«˜32px */
  padding: 12px;  /* ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚12px */
}

/* ç«¯å£æŒ‡ç¤ºå™¨æ ·å¼ - è§„èŒƒè¦æ±‚32pxè¡Œé«˜ */
.port-indicator {
  display: flex;
  align-items: center;
  height: 32px;  /* ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚32px */
  padding: 0 16px;  /* ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚x=16pxèµ·å§‹ä½ç½® */
  font-size: 13px;  /* ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚13px */
  position: relative;
  /* ä¿®æ­£ï¼šæ·»åŠ æ–‡æœ¬æ ·å¼ */
  color: #111827;
  text-align: start;  /* å·¦å¯¹é½ */
}

.port-indicator--in {
  background: transparent;  /* ä¿®æ­£ï¼šä¸éœ€è¦èƒŒæ™¯è‰² */
  border: none;  /* ä¿®æ­£ï¼šä¸éœ€è¦è¾¹æ¡† */
  color: #111827;  /* ä¿®æ­£ï¼šè§„èŒƒæ–‡æœ¬é¢œè‰² */
}

.port-indicator--out {
  background: transparent;  /* ä¿®æ­£ï¼šä¸éœ€è¦èƒŒæ™¯è‰² */
  border: none;  /* ä¿®æ­£ï¼šä¸éœ€è¦è¾¹æ¡† */
  color: #111827;  /* ä¿®æ­£ï¼šè§„èŒƒæ–‡æœ¬é¢œè‰² */
}

.port-indicator__label {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  /* ä¿®æ­£ï¼šç¡®ä¿æ–‡æœ¬åŸºçº¿æ­£ç¡® */
  line-height: 32px;  /* ä¸å®¹å™¨é«˜åº¦ä¸€è‡´ */
}
</style>
```

## 3. æ ·å¼å¸¸é‡ä¿®æ­£

### 3.1 ä¿®æ­£nodeStyles.js

**æ–‡ä»¶**: `src/pages/marketing/tasks/horizontal/styles/nodeStyles.js`

```javascript
// åŸºç¡€å°ºå¯¸å¸¸é‡
export const NODE_DIMENSIONS = {
  WIDTH: 280,
  MIN_HEIGHT: 96,
  HEADER_HEIGHT: 36,
  ROW_HEIGHT: 32,
  CONTENT_PADDING: 12,
  ICON_SIZE: { width: 28, height: 20 },  // ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚28Ã—20
  ICON_RADIUS: 6,  // ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚6px
  MENU_DOT_SIZE: 3,
  PORT_RADIUS: 4
}

// é¢œè‰²å¸¸é‡ - ä¿®æ­£ä¸ºè§„èŒƒè¦æ±‚
export const COLORS = {
  // èŠ‚ç‚¹ä¸»ä½“
  BODY_FILL: '#FFFFFF',
  BODY_STROKE: '#E5E7EB',  // ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚#E5E7EB
  BODY_STROKE_WIDTH: 1,     // ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚1px
  BODY_RADIUS: 8,
  
  // æ ‡é¢˜åŒº
  HEADER_FILL: '#F8FAFC',   // ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚#F8FAFC
  HEADER_STROKE: '#E5E7EB', // ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚#E5E7EB
  HEADER_STROKE_WIDTH: 1,   // ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚1px
  
  // å›¾æ ‡
  ICON_FILL: '#14B8A6',     // ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚#14B8A6
  ICON_STROKE: '#14B8A6',   // ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚#14B8A6
  ICON_TEXT: '#FFFFFF',
  
  // æ–‡æœ¬
  TITLE_TEXT: '#111827',    // ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚#111827
  CONTENT_TEXT: '#111827',  // ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚#111827
  MENU_DOT: '#6B7280',
  
  // ç«¯å£
  PORT_STROKE: '#4C78FF',
  PORT_FILL_IN: '#FFFFFF',
  PORT_FILL_OUT: '#4C78FF',
  PORT_STROKE_WIDTH: 1.5
}

// å­—ä½“å¸¸é‡
export const TYPOGRAPHY = {
  // å›¾æ ‡æ–‡æœ¬
  ICON_FONT_SIZE: 12,       // ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚12px
  ICON_TEXT_ANCHOR: 'middle',
  
  // æ ‡é¢˜æ–‡æœ¬
  TITLE_FONT_SIZE: 13,      // ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚13px
  TITLE_FONT_WEIGHT: 600,   // ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚ç²—ä½“
  TITLE_TEXT_ANCHOR: 'start',
  
  // å†…å®¹æ–‡æœ¬
  CONTENT_FONT_SIZE: 13,    // ä¿®æ­£ï¼šè§„èŒƒè¦æ±‚13px
  CONTENT_TEXT_ANCHOR: 'start',
  CONTENT_BASELINE_ADJUST: 5  // è§†è§‰è°ƒæ•´ï¼Œç¡®ä¿æ–‡æœ¬å±…ä¸­
}
```

## 4. ç«¯å£é…ç½®ä¼˜åŒ–

### 4.1 ç®€åŒ–ç«¯å£å¸ƒå±€å™¨

**æ–‡ä»¶**: `src/pages/marketing/tasks/horizontal/index.vue`

```javascript
// ç®€åŒ–ç«¯å£å¸ƒå±€å™¨æ³¨å†Œ
onMounted(async () => {
  // æ³¨å†Œç®€åŒ–çš„ç«¯å£å¸ƒå±€å™¨
  try {
    Graph.registerPortLayout('simple-right-y', (ports, args) => {
      const h = args?.bbox?.height || 0
      const w = args?.bbox?.width || 0
      
      return (ports || []).map(p => {
        const a = p?.args || {}
        const y = a.y || (h / 2 + (a.dy || 0))
        return { position: { x: w, y } }
      })
    })
    
    Graph.registerPortLayout('simple-left-y', (ports, args) => {
      const h = args?.bbox?.height || 0
      
      return (ports || []).map(p => {
        const a = p?.args || {}
        const y = a.y || (h / 2 + (a.dy || 0))
        return { position: { x: 0, y } }
      })
    })
  } catch {}
})
```

### 4.2 ä¿®æ­£ç«¯å£é…ç½®

**æ–‡ä»¶**: `src/pages/marketing/tasks/horizontal/utils/portConfigFactoryHorizontal.js`

```javascript
// ä¿®æ­£ç«¯å£ç»„é…ç½®
const groups = {
  in: {
    position: 'left',
    layout: { name: 'simple-left-y' },  // ä½¿ç”¨ç®€åŒ–å¸ƒå±€å™¨
    // ... å…¶ä»–é…ç½®ä¸å˜
  },
  out: {
    position: 'right',
    layout: { name: 'simple-right-y' },  // ä½¿ç”¨ç®€åŒ–å¸ƒå±€å™¨
    // ... å…¶ä»–é…ç½®ä¸å˜
  }
}
```

## 5. æ•°æ®æµç®€åŒ–

### 5.1 BaseNodeå¢å¼º

**æ–‡ä»¶**: `src/components/nodes/BaseNode.vue`

```vue
<script setup>
import { buildDisplayLines } from '@/pages/marketing/tasks/horizontal/createVueShapeNode.js'

// æ·»åŠ è®¡ç®—å±æ€§
const displayLines = computed(() => {
  return buildDisplayLines(props.nodeType, props.config)
})

const contentHeight = computed(() => {
  return displayLines.value.length * 32  // 32pxè¡Œé«˜
})
</script>
```

### 5.2 ç®€åŒ–HorizontalNode

```vue
<script setup>
// ç®€åŒ–è®¡ç®—å±æ€§
const outRows = computed(() => {
  // ç›´æ¥è¿”å›displayLinesï¼Œä¸å†é‡å¤è®¡ç®—
  return props.config?.displayLines || []
})
</script>
```

## 6. ä¿®å¤éªŒè¯

### 6.1 åˆ›å»ºéªŒè¯å‡½æ•°

**æ–‡ä»¶**: `src/pages/marketing/tasks/horizontal/index.vue`

```javascript
// æ·»åŠ ä¿®å¤éªŒè¯å‡½æ•°
const validateNodeCompliance = () => {
  console.log('ğŸ” [åˆè§„éªŒè¯] å¼€å§‹éªŒè¯èŠ‚ç‚¹å®ç°...')
  
  // éªŒè¯æ ·å¼å¸¸é‡
  const styles = {
    width: NODE_DIMENSIONS.WIDTH,
    headerHeight: NODE_DIMENSIONS.HEADER_HEIGHT,
    rowHeight: NODE_DIMENSIONS.ROW_HEIGHT,
    contentPadding: NODE_DIMENSIONS.CONTENT_PADDING,
    colors: {
      headerFill: COLORS.HEADER_FILL,
      bodyStroke: COLORS.BODY_STROKE,
      iconFill: COLORS.ICON_FILL,
      titleText: COLORS.TITLE_TEXT,
      contentText: COLORS.CONTENT_TEXT
    }
  }
  
  console.log('ğŸ“ æ ·å¼å¸¸é‡éªŒè¯:', styles)
  
  // éªŒè¯è®¡ç®—é€»è¾‘
  const testRows = ['æµ‹è¯•è¡Œ1', 'æµ‹è¯•è¡Œ2', 'æµ‹è¯•è¡Œ3']
  const testHeight = Math.max(
    NODE_DIMENSIONS.MIN_HEIGHT,
    NODE_DIMENSIONS.HEADER_HEIGHT + 
    NODE_DIMENSIONS.CONTENT_PADDING + 
    testRows.length * NODE_DIMENSIONS.ROW_HEIGHT + 
    12
  )
  
  console.log('ğŸ“ é«˜åº¦è®¡ç®—éªŒè¯:', {
    rows: testRows.length,
    calculatedHeight: testHeight,
    expectedMinHeight: NODE_DIMENSIONS.MIN_HEIGHT
  })
  
  // éªŒè¯ç«¯å£ä½ç½®
  const contentCenter = NODE_DIMENSIONS.HEADER_HEIGHT + NODE_DIMENSIONS.CONTENT_PADDING + 
                       (testRows.length * NODE_DIMENSIONS.ROW_HEIGHT) / 2
  const rowPositions = testRows.map((_, i) => 
    NODE_DIMENSIONS.HEADER_HEIGHT + NODE_DIMENSIONS.CONTENT_PADDING + 
    i * NODE_DIMENSIONS.ROW_HEIGHT + Math.floor(NODE_DIMENSIONS.ROW_HEIGHT / 2)
  )
  
  console.log('ğŸ”Œ ç«¯å£ä½ç½®éªŒè¯:', {
    contentCenter,
    rowPositions,
    baselineAdjust: TYPOGRAPHY.CONTENT_BASELINE_ADJUST
  })
  
  console.log('âœ… [åˆè§„éªŒè¯] éªŒè¯å®Œæˆ')
}

// åœ¨æµ‹è¯•æŒ‰é’®ä¸­æ·»åŠ éªŒè¯
const testNodeStyleValidation = () => {
  // ç°æœ‰éªŒè¯é€»è¾‘...
  validateNodeCompliance()  // æ·»åŠ åˆè§„éªŒè¯
}
```

## 7. æµ‹è¯•ç”¨ä¾‹

### 7.1 åˆ›å»ºæµ‹è¯•ç”¨ä¾‹

**æ–‡ä»¶**: `src/pages/marketing/tasks/horizontal/__tests__/nodeCompliance.test.js`

```javascript
import { describe, it, expect } from 'vitest'
import { NODE_DIMENSIONS, COLORS, TYPOGRAPHY } from '../styles/nodeStyles.js'
import { buildDisplayLines } from '../createVueShapeNode.js'

describe('èŠ‚ç‚¹åˆè§„æ€§æµ‹è¯•', () => {
  it('åº”è¯¥ä½¿ç”¨æ­£ç¡®çš„å°ºå¯¸å¸¸é‡', () => {
    expect(NODE_DIMENSIONS.WIDTH).toBe(280)
    expect(NODE_DIMENSIONS.HEADER_HEIGHT).toBe(36)
    expect(NODE_DIMENSIONS.ROW_HEIGHT).toBe(32)
    expect(NODE_DIMENSIONS.CONTENT_PADDING).toBe(12)
    expect(NODE_DIMENSIONS.MIN_HEIGHT).toBe(96)
  })
  
  it('åº”è¯¥ä½¿ç”¨æ­£ç¡®çš„é¢œè‰²å¸¸é‡', () => {
    expect(COLORS.HEADER_FILL).toBe('#F8FAFC')
    expect(COLORS.BODY_STROKE).toBe('#E5E7EB')
    expect(COLORS.ICON_FILL).toBe('#14B8A6')
    expect(COLORS.TITLE_TEXT).toBe('#111827')
    expect(COLORS.CONTENT_TEXT).toBe('#111827')
  })
  
  it('åº”è¯¥æ­£ç¡®è®¡ç®—èŠ‚ç‚¹é«˜åº¦', () => {
    const rows = ['è¡Œ1', 'è¡Œ2', 'è¡Œ3']
    const expectedHeight = Math.max(
      NODE_DIMENSIONS.MIN_HEIGHT,
      NODE_DIMENSIONS.HEADER_HEIGHT + 
      NODE_DIMENSIONS.CONTENT_PADDING + 
      rows.length * NODE_DIMENSIONS.ROW_HEIGHT + 
      12
    )
    
    expect(expectedHeight).toBe(180) // 36 + 12 + 3*32 + 12 = 180
  })
  
  it('åº”è¯¥æ­£ç¡®è®¡ç®—ç«¯å£ä½ç½®', () => {
    const rows = ['è¡Œ1', 'è¡Œ2']
    const contentCenter = NODE_DIMENSIONS.HEADER_HEIGHT + NODE_DIMENSIONS.CONTENT_PADDING + 
                         (rows.length * NODE_DIMENSIONS.ROW_HEIGHT) / 2
    
    expect(contentCenter).toBe(60) // 36 + 12 + 64/2 = 60
    
    const rowPositions = rows.map((_, i) => 
      NODE_DIMENSIONS.HEADER_HEIGHT + NODE_DIMENSIONS.CONTENT_PADDING + 
      i * NODE_DIMENSIONS.ROW_HEIGHT + Math.floor(NODE_DIMENSIONS.ROW_HEIGHT / 2)
    )
    
    expect(rowPositions).toEqual([68, 100]) // 36 + 12 + 0*32 + 16 = 68, 36 + 12 + 1*32 + 16 = 100
  })
})
```

## 8. éƒ¨ç½²æ£€æŸ¥æ¸…å•

### 8.1 ä¿®å¤éªŒè¯æ¸…å•

- [ ] BaseNodeç»„ä»¶æ ·å¼ä¿®æ­£å®Œæˆ
- [ ] HorizontalNodeç»„ä»¶å¸ƒå±€ä¿®æ­£å®Œæˆ
- [ ] æ ·å¼å¸¸é‡æ›´æ–°å®Œæˆ
- [ ] ç«¯å£é…ç½®ä¼˜åŒ–å®Œæˆ
- [ ] æ•°æ®æµç®€åŒ–å®Œæˆ
- [ ] éªŒè¯å‡½æ•°å®ç°å®Œæˆ
- [ ] æµ‹è¯•ç”¨ä¾‹ç¼–å†™å®Œæˆ

### 8.2 è§†è§‰éªŒè¯æ¸…å•

- [ ] èŠ‚ç‚¹å®½åº¦280pxç¡®è®¤
- [ ] æ ‡é¢˜åŒºé«˜åº¦36pxç¡®è®¤
- [ ] æ ‡é¢˜åŒºèƒŒæ™¯è‰²#F8FAFCç¡®è®¤
- [ ] å›¾æ ‡28Ã—20pxï¼Œåœ†è§’6pxç¡®è®¤
- [ ] å†…å®¹åŒº12pxå†…è¾¹è·ç¡®è®¤
- [ ] è¡Œé«˜32pxç¡®è®¤
- [ ] ç«¯å£4pxåŠå¾„ç¡®è®¤
- [ ] æ–‡æœ¬13pxï¼Œé¢œè‰²#111827ç¡®è®¤

### 8.3 åŠŸèƒ½éªŒè¯æ¸…å•

- [ ] èŠ‚ç‚¹åˆ›å»ºåŠŸèƒ½æ­£å¸¸
- [ ] é…ç½®æ›´æ–°åŠŸèƒ½æ­£å¸¸
- [ ] ç«¯å£é™„ç€ä½ç½®æ­£ç¡®
- [ ] è¿æ¥è§„åˆ™éªŒè¯æ­£å¸¸
- [ ] äº¤äº’çŠ¶æ€æ ·å¼æ­£ç¡®
- [ ] æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡

## 9. æ€»ç»“

æœ¬ä¿®å¤æ–¹æ¡ˆé’ˆå¯¹ç¬¦åˆæ€§è¯„ä¼°ä¸­å‘ç°çš„é—®é¢˜ï¼Œæä¾›äº†å…·ä½“çš„ä»£ç ä¿®æ”¹æ–¹æ¡ˆã€‚é€šè¿‡ä¿®æ­£BaseNodeç»„ä»¶æ ·å¼ã€ä¼˜åŒ–HorizontalNodeå¸ƒå±€ã€æ›´æ–°æ ·å¼å¸¸é‡ã€ç®€åŒ–ç«¯å£é…ç½®ç­‰æ­¥éª¤ï¼Œç¡®ä¿æ¨ªå‘ç”»å¸ƒèŠ‚ç‚¹å®ç°å®Œå…¨ç¬¦åˆè®¾è®¡è§„èŒƒã€‚

ä¿®å¤å®Œæˆåï¼Œé¢„æœŸè¾¾åˆ°ï¼š
- è§†è§‰æ ·å¼100%ç¬¦åˆè§„èŒƒ
- å¸ƒå±€ç»“æ„100%ç¬¦åˆè§„èŒƒ
- ç«¯å£é™„ç€100%ç¬¦åˆè§„èŒƒ
- äº¤äº’è¡Œä¸º100%ç¬¦åˆè§„èŒƒ

æ‰€æœ‰ä¿®æ”¹éƒ½åŒ…å«è¯¦ç»†çš„ä»£ç ç¤ºä¾‹å’ŒéªŒè¯æœºåˆ¶ï¼Œç¡®ä¿ä¿®å¤è´¨é‡å’Œå¯ç»´æŠ¤æ€§ã€‚