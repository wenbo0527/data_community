## 页面目标
- 承载结算任务的发起、进度跟踪、结果展示与报告导出，形成结算域的标准工作台。
- 参考“外数效果评估列表页”（`/exploration/external-data-evaluation/list`）的结构：工具栏筛选 + 列表 + 创建任务 + 任务状态/进度 + 操作区。

## 页面结构与路由
- 列表页：`/risk/budget/settlement`
  - 顶部工具栏：筛选与操作
  - 结算任务列表：状态、进度、金额、差异等核心列
  - 创建结算任务：抽屉/弹窗
- 任务详情页（可用抽屉或独立页）：`/risk/budget/settlement/task/:id`
  - 步骤进度、日志、结算明细与差异预览
- 结算报告页：`/risk/budget/settlement/report/:id`
  - 报告摘要、明细表、差异图、导出/分享/下载

## 功能模块
### 工具栏（列表页顶部）
- 筛选条件：`供应商`、`合同`、`结算周期`（年/季/月 + 对应时间）、`状态`（待执行/执行中/已完成/失败/已取消）、`创建人`
- 操作按钮：`发起结算`、`刷新`、`导出任务列表（CSV/XLSX）`

### 结算任务列表
- 核心列（参考评估列表页风格）：
  - `任务编号`（可复制）
  - `供应商` / `合同名称`
  - `结算周期`（年/季/月 + 时间标签）
  - `预算金额`、`实际金额`
  - `差异金额`、`差异率`（`(实际-预算)/预算`）
  - `状态`（标签）
  - `进度`（进度条 + 百分比）
  - `创建人`、`创建时间`
  - `操作`：`查看`、`生成报告`、`更新数据`、`取消任务`、`下载报告`
- 空态与加载：支持空态占位与骨架屏（Skeleton）

### 发起结算（创建任务）
- 创建入口：列表页上的`发起结算`按钮
- 表单字段：
  - 基础信息：`供应商`（必选）、`合同`（多选/单选）、`结算粒度`（年/季/月）、`结算时间`（如 2025、2025-Q2、2025-01）
  - 数据源选择：`预算快照版本`、`实际数据版本/账期`（下拉）
  - 规则选项：`严格对齐`（对账严格模式）、`包含税费`、`允许小额误差`（阈值输入）
  - 备注说明：文本域
- 提交行为：创建任务 → 返回列表并显示`执行中`状态

### 任务执行与状态
- 状态机：`pending` → `running` → `succeeded` / `failed` / `canceled`
- 步骤流（在详情页/抽屉中展示）：
  1. 数据锁定（预算/实际快照）
  2. 差异计算（金额、比率、科目/维度）
  3. 审核校验（规则/阈值）
  4. 报告生成（摘要 + 明细）
  5. 数据更新（写回合同/预算域）
- 进度与日志：展示每一步的时间与结果摘要，失败时列出错误信息

### 结算报告
- 报告页内容：
  - 顶部摘要卡：`预算金额`、`实际金额`、`差异金额`、`差异率`、`结算周期`、`供应商/合同`
  - 明细表：按科目/维度列出差异（支持筛选/搜索/导出）
  - 图表：差异构成饼图、结算趋势折线（可选）
  - 操作：`下载PDF`、`导出Excel`、`复制链接`
- 列表页操作“生成报告”直接跳转报告页，或在详情抽屉内提供“生成并查看”按钮

### 数据更新
- 更新范围：
  - 合同域：`writtenOffAmount` 增加/调整；结算状态标注；结算记录追加
  - 预算域：必要时同步执行金额/剩余预算（可配置）
- 安全机制：
  - 写入前弹窗确认（展示差异汇总）
  - 支持“试运行”不写入，仅生成报告
  - 写入后支持“回滚”到上一个快照（记录版本号）

## 数据模型（前端）
- `SettlementTask`：
  - `id`、`supplier`、`contractIds`、`granularity`、`timeLabel`
  - `budgetSnapshotId`、`actualSnapshotId`
  - `status`、`progress`（0–100）、`createdBy`、`createdAt`
  - `summary`：`budgetAmount`、`actualAmount`、`diffAmount`、`diffRate`
- `SettlementReport`：
  - `id`、`taskId`、`title`
  - `summary`（同上）
  - `items`（明细：维度、预算、实际、差异、备注）
  - `charts`（可选：构成/趋势）
  - `createdAt`、`downloadUrl`
- `SettlementItem`：
  - `dimension`（合同/供应商/科目/平台等）、`budget`、`actual`、`diff`、`diffRate`、`comment`

## API（占位设计）
- 任务：
  - `GET /api/settlements/tasks?page&pageSize&supplier&status&timeLabel`
  - `POST /api/settlements/tasks`（创建）
  - `GET /api/settlements/tasks/:id`（详情 + 步骤 +日志）
  - `POST /api/settlements/tasks/:id/cancel`
  - `POST /api/settlements/tasks/:id/update`（写回数据）
- 报告：
  - `POST /api/settlements/tasks/:id/report`（生成报告）
  - `GET /api/settlements/reports/:id`（报告详情）
  - `GET /api/settlements/reports/:id/download?type=pdf|xlsx`
- 快照与字典：
  - `GET /api/settlements/snapshots?type=budget|actual`
  - `GET /api/contracts?supplier&status`（用于选择合同）

## 交互与组件（Arco）
- 列表：`a-table`（状态标签、进度条、操作列）
- 工具栏：`a-form`（筛选）、`a-button`（发起结算/导出/刷新）
- 创建任务：`a-drawer` 或 `a-modal`（表单 + 校验）
- 详情：`a-drawer` + `a-steps` + `a-list`（日志）
- 报告：`a-card` + `a-statistic` + `a-table` + 图表组件（可用 ECharts）

## 权限与审计
- 发起结算：仅允许具备`结算管理员`角色
- 数据更新：需要二次确认（弹窗）与操作审计记录
- 取消任务：限制在`pending/running`状态下

## 错误与边界
- 预算/实际数据缺失：提示并禁止创建任务
- 差异率异常：提示与标红；允许继续生成报告但默认不写回
- 报告生成失败：保留任务，支持重试

## 验收标准
- 能筛选与浏览结算任务，发起结算并生成报告
- 能在报告页查看明细并导出，数据写回有确认与结果提示
- 任务状态流转正确，进度与日志可见

## 实施里程碑
- M1（列表与创建）：列表页、创建任务、状态流转假数据、报告占位
- M2（报告与写回）：结算报告详情与导出、写回逻辑、回滚机制
- M3（图表与性能）：差异图表、分页与性能优化、接口联调
