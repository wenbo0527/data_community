# 元数据管理模块升级方案（数据注册升级）

## 背景与目标
- 背景：当前“数据发现”中的“数据注册/资产管理”已具备表管理、外数管理、指标管理、变量管理、资产批量管理等页面能力，但以“注册”为中心，缺少围绕业务模块的统一元数据治理与跨库资产关联能力。
- 目标：升级为“元数据管理模块”，在现有页面基础上引入“业务模块管理”，支持按“组织架构（部门）+ 业务场景”创建多级业务模块，新增“虚拟组”跨部门、跨场景灵活划分，并实现跨数据库（Hive/Doris）将资产（库表/指标）、资源（加工表/API）关联至同一业务模块；模块启用/禁用/编辑/删除同步至统一权限系统。

## 范围与入口
- 统一入口：`/discovery/asset-management`（页面卡片跳转已存在，参考 `src/pages/discovery/asset-management/index.vue:12-61,195-197`）
- 页面范围：
  - 表管理：`http://localhost:5174/discovery/asset-management/table-management`（路由定义 `src/router/index.js:316-320`）
  - 外数管理：`http://localhost:5174/discovery/asset-management/external-data-management`（路由定义 `src/router/index.js:328-332`）
  - 指标管理：`http://localhost:5174/discovery/asset-management/metric-management`（路由定义 `src/router/index.js:334-338`）
  - 变量管理：`http://localhost:5174/discovery/asset-management/variable-management`（路由定义 `src/router/index.js:340-344`）
  - 资产批量管理：`http://localhost:5174/discovery/asset-management/batch-asset-management`（路由定义 `src/router/index.js:393-397`）
- 新增范围：业务模块管理（物理模块 + 虚拟组），作为“元数据管理”一级页面，与上述页面协同。

## 现状评估（代码快照）
- 路由与导航
  - 发现模块在主路由已注册资产管理子路由，覆盖表/外数/指标/变量/批量管理等（`src/router/index.js:316-403`）。
  - 资产管理入口页提供模块卡片导航（`src/pages/discovery/asset-management/index.vue:66-148,195-197`）。
- 表管理（注册/列表/跳转）
  - 列表与创建弹窗、注册表单跳转（`src/pages/discovery/asset-management/table-management/index.vue:1-135,330-333`）。
  - 表详情跳转复用数据地图详情（`src/router/index.js:151-158`）。
- 外数管理（外部数据与采购项目）
  - Tab结构，包含外部数据与采购项目，并支持供应商管理与文件上传（`src/pages/discovery/asset-management/external-data-management/index.vue:30-243,245-470,1013-1120,1121-1175`）。
  - 采购登记页面跳转（`src/pages/discovery/asset-management/external-data-management/index.vue:485-487`，对应路由 `src/router/index.js:399-403`）。
- 指标管理（业务核心/监管 + 批量上传）
  - 支持搜索筛选、版本历史、批量上传模板（`src/pages/discovery/asset-management/metric-management/index.vue:1-173,220-273,276-347,378-446,449-491,772-847`）。
  - 新建/编辑/查看跳转（`src/pages/discovery/asset-management/metric-management/index.vue:616-627,699-705`，对应路由 `src/router/index.js:373-391`）。
- 变量管理（列表/创建/详情）
  - 列表、筛选、导入更新（`src/pages/variable-management/index.vue:66-122,123-174,176-215,217-265,293-352,354-371,382-390,394-471`）。
  - 详情页含技术口径与版本信息（`src/pages/discovery/asset-management/variable-management/VariableDetail.vue:20-166,169-232,235-244,266-321,323-365`，路由 `src/router/index.js:346-371`）。
- 权限系统（统一权限）
  - 权限检查与冲突检测工具、Mock接口（`src/views/management/permission/utils.js:182-225`, `src/views/management/permission/mock.js:549-585`）。
  - 路由层面存在权限守卫相关工具引用（`src/router/index.js:10-13`）。
- 数据现状结论
  - 页面结构完整，数据以前端 Mock/静态为主，尚未形成对“业务模块”的统一元数据关系与权限联动。

## 总体架构设计
- 概览
  - 元数据域模型：围绕“业务模块”为中心，统一管理资产、资源与跨库标识。
  - 统一权限联动：模块状态变更 → 权限系统同步 → 资产与资源授权透传。
- 元数据模型
  - BusinessModule（业务模块）
    - 字段：`id`, `name`, `type`（`physical`/`virtual`），`organizationId`，`organizationPath[]`，`scenarioId`，`parentId`，`status`（`enabled`/`disabled`），`tags[]`，`description`，`createdBy`，`createdAt`，`updatedAt`
    - 说明：物理模块按“组织架构（部门）+ 业务场景”形成多级结构；虚拟组不受组织/场景限制（可选），支持跨部门跨场景。
  - Asset（资产）
    - 表：`engine`（`hive`/`doris`…），`catalog`，`schema`，`table`，`displayName`，`domain`，`owner`，`status`
    - 指标：`code`，`type`（业务核心/监管），`businessDomain`/`regulatoryCategory`，`owners`，`version*`，`status`
    - 变量：`code`，`type`，`dataSource`，`technicalCaliber`，`queryCode`，`version*`，`status`
  - Resource（资源）
    - 加工表：`engine`，`schema`，`table`，`jobId`/`pipelineId`，`frequency`，`status`
    - API：`endpoint`，`method`，`provider`，`price`，`status`
  - 关联关系
    - 模块-资产表：`module_asset_map(moduleId, assetType, assetId, engine?, bindProps?)`
    - 模块-资源表：`module_resource_map(moduleId, resourceType, resourceId, bindProps?)`
    - 说明：允许同一资产/资源关联至多个模块（含虚拟组）。

## 前端页面与路由方案
- 新增页面：业务模块管理
  - 路由：`/discovery/asset-management/module-management`
  - 结构：
    - 左侧：模块树（物理模块/虚拟组两棵树或统一树 + 标签过滤）
    - 右侧：详情区 Tabs（资产、资源、成员/权限、配置、变更历史）
    - 操作：新建模块（选择物理/虚拟、层级/父模块、组织/场景）、启用/禁用、编辑、删除、批量关联资产/资源
  - 交互：
    - 搜索模块、过滤（组织、场景、状态、标签）
    - “关联资产/资源”支持跨库检索（Hive/Doris），批量选择与回填
- 现有页面增强
  - 表管理/指标管理/变量管理/外数管理：详情页增加“关联业务模块/虚拟组”操作区（弹窗选择模块、支持多选、展示已关联列表）
  - 资产批量管理：新增“批量关联模块”操作类型，支持按筛选结果批量绑定。
- 导航整合
  - `资产管理`入口页新增“业务模块管理”卡片；或将“资产管理”标题升级为“元数据管理”，模块卡片包含“业务模块管理”与原有子模块。

## 接口设计（示例）
- 业务模块
  - `GET /api/metadata/modules/tree?type=physical|virtual`
  - `POST /api/metadata/modules`（创建：支持选父模块/组织/场景/虚拟）
  - `PUT /api/metadata/modules/{id}`（编辑）
  - `PATCH /api/metadata/modules/{id}/status`（启用/禁用）
  - `DELETE /api/metadata/modules/{id}`（删除，含关联校验）
  - `GET /api/metadata/modules/{id}`（详情，含资产/资源计数与最近变更）
- 关联（资产/资源）
  - `POST /api/metadata/modules/{id}/assets:bind`（body：`[{ assetType, assetId, engine?, bindProps? }]`）
  - `POST /api/metadata/modules/{id}/assets:unbind`
  - `POST /api/metadata/modules/{id}/resources:bind` / `:unbind`
  - 检索：`GET /api/metadata/search?type=table|metric|variable|external&engine=...&q=...`
- 权限同步
  - `POST /api/permission/modules/sync`（body：`{ moduleId, action: 'enable'|'disable'|'edit'|'delete' }`）
  - 触发点：模块状态变更、模块删除、模块编辑（组织/场景/成员变更）

## 权限联动策略
- 触发
  - 启用模块：创建对应权限资源节点（模块维度），并为已绑定资产/资源创建授权策略（只读/写入可配）。
  - 禁用模块：冻结模块维度的权限，并同步冻结资产/资源的模块级授权。
  - 编辑模块：组织/场景调整 → 重新计算可见范围与默认授权；成员变更 → 更新角色绑定。
  - 删除模块：清理模块维度权限与模块-资产/资源关联映射。
- 前端集成
  - 在模块管理页面提交操作后，串行调用模块接口与权限同步接口（失败重试与回滚提示）。
  - 可复用权限工具组件与冲突检测（参考 `src/views/management/permission/utils.js:182-225`, `src/views/management/permission/mock.js:549-585`）。

## 跨库绑定与统一标识
- 标识规范：`engine.catalog.schema.table`（Hive/Doris）统一抽象为 `engine` + `namespace(schema)` + `name(table)`。
- 绑定策略：
  - 资产（表/指标/变量）与资源（加工表/API）均允许多模块绑定。
  - 虚拟组绑定不受组织/场景限制，可配置有效期与回收策略（满足临时性或特定需求）。
- 检索与选择：
  - 资产批量管理与模块管理中均提供跨库检索与选择器，统一校验有效性。

## 数据迁移与兼容
- 路由与导航
  - 保持现有路径不变，新增“模块管理”路由与入口，不破坏现有页面。
- 现有数据
  - 前端 Mock 数据逐步替换为后端 API；新增模块绑定字段在各详情页以非必填形式呈现，平滑过渡。
- 回滚策略
  - 模块管理为新增模块，与现有页面逻辑独立；出现问题可临时隐藏入口卡片，不影响既有功能。

## 实施计划
- 阶段1（1周）：页面与路由搭建
  - 新建“业务模块管理”页面与路由
  - 统一搜索与绑定交互组件
  - 入口页新增卡片与文案调整为“元数据管理”
- 阶段2（2周）：后端 API 对接与权限联动
  - 模块 CRUD 与权限同步接口接入
  - 资产/资源绑定接口与跨库检索接入
  - 详情页新增“关联模块”区域
- 阶段3（1周）：批量操作与虚拟组治理
  - 批量关联模块能力（从资产批量管理页触发）
  - 虚拟组有效期、标签策略与可视标识
- 阶段4（0.5周）：联调与验收
  - 权限联动回归测试与失败回滚验证
  - 元数据一致性与跨库绑定边界场景验收

## 验收标准
- 页面与路由
  - 可访问上述五个资产页面与“业务模块管理”，导航一致、权限守卫有效。
- 业务模块
  - 支持按“组织架构（部门）+ 业务场景”创建多级模块；虚拟组可跨部门/跨场景创建。
  - 模块启用/禁用/编辑/删除，权限系统同步成功（含失败提示与重试）。
- 关联能力
  - 跨库（Hive/Doris）将资产（库表/指标）、资源（加工表/API）关联至同一模块；虚拟组模块也可关联。
  - 资产详情页展示与编辑已关联模块；批量管理页支持批量绑定。
- 数据一致性与性能
  - 绑定、检索、权限联动在1000条资产规模下无显著卡顿；操作反馈<1s（后端API不抖动时）。

## 风险与规避
- 权限同步失败：前端串行提交 + 明确回滚提示；后台触发补偿任务。
- 组织/场景数据源异步更新：模块创建时拉取快照并存档，后续编辑与权限再同步。
- 跨库标识不统一：严格遵循 `engine + namespace + name` 规范，后端校验并返回规范化标识。

## 备注（代码参考）
- 资产管理入口页：`src/pages/discovery/asset-management/index.vue:12-61,66-148,195-197`
- 表管理：`src/pages/discovery/asset-management/table-management/index.vue:1-135,330-333`
- 外数管理：`src/pages/discovery/asset-management/external-data-management/index.vue:30-243,245-470,485-487,1013-1120`
- 指标管理：`src/pages/discovery/asset-management/metric-management/index.vue:1-173,616-627,699-705,772-847`
- 变量管理列表：`src/pages/variable-management/index.vue:66-122,382-390`
- 变量详情：`src/pages/discovery/asset-management/variable-management/VariableDetail.vue:20-166,266-321`
- 路由注册（发现模块）：`src/router/index.js:316-403`
- 权限工具：`src/views/management/permission/utils.js:182-225`, `src/views/management/permission/mock.js:549-585`

