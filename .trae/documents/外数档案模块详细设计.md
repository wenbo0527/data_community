# 外数档案模块详细设计

## 页面与路由
- 档案列表页：`src/pages/external-data-archive/index.vue`
- 风险域入口：`/risk/external-data/archive`
- 相关导航目标：技术详情（`/external-data-v1/list`）、效果评估（`/exploration/external-data-evaluation/list`）、预算管理（`/risk/budget-overview`）、数据服务（`/risk/external-data/service`）

## 数据模型与 Store
- 外数 Store：`src/store/modules/external-data.ts`（产品列表、预警、燃尽数据、评估引用与任务中心）
- 合同 Store：`src/store/modules/contract.ts`（供应商与合同，用于到期提醒与结算协同）

## 交互与功能
- 跨模块跳转封装：
  - 使用封装方法 `goWithQuery(path, extra)`，在页面内用于导航：
    - `src/pages/external-data-archive/index.vue:75–79,102,128,134,179`
    - 点击“查看评估”“查看监控”分别调用：`src/pages/external-data-archive/index.vue:437–441`
  - 约定 query 参数：`archiveId`、`from='archive'`、`product`、`tab`（例如跳技术详情携带 `tab='detail'`）。
- 编辑抽屉与保存：
  - 打开编辑：`openEdit(record)` → `src/pages/external-data-archive/index.vue:415–425`
  - 保存编辑：`saveEdit()` → `src/pages/external-data-archive/index.vue:426–431`
  - 抽屉 UI 结构与表单：`src/pages/external-data-archive/index.vue:412–431`
- 列表展示与操作列：
  - 操作列包含“编辑档案”“查看评估”“查看监控”按钮：`src/pages/external-data-archive/index.vue:174–209,201`
- 顶部工具栏与导航：
  - 工作台式导航区：`src/pages/external-data-archive/index.vue:70–110`

## 统计与提醒
- 合同到期 Top5（按剩余天数升序）：计算与标签：`src/pages/external-data-archive/index.vue:386–393`
- 评估摘要（最近一次评估的得分与时间）：`src/pages/external-data-archive/index.vue:395–403`

## 与其他模块的协作
- 到评估中心：`viewEvaluation(record)` 将 `product` 透传：`src/pages/external-data-archive/index.vue:437–439`
- 到监控视图：`viewMonitor(record)` 将 `product` 透传：`src/pages/external-data-archive/index.vue:440–442`
- 到预算总览与服务管理：统一使用 `goWithQuery` 封装。

## 权限与状态
- 生命周期状态标签与展示：`src/pages/external-data-archive/index.vue:375–379,432–435`
- 供应商信息与信用评级：`src/pages/external-data-archive/index.vue:380–384`

## 统一跳转协议
- 协议参数：`archiveId`、`from`、`product`、`tab`
- 典型用法：
  - 查看技术详情：`src/pages/external-data-archive/index.vue:75,134,179`
  - 查看评估：`src/pages/external-data-archive/index.vue:128,437–439`
  - 查看监控：`src/pages/external-data-archive/index.vue:441`

## 后续迭代点
- 将评估结果的标签与评分写回档案项（新增字段与写回 API）。
- 编辑抽屉扩展“使用场景”与“合规状态”字段，并写回服务管理与监控域。
- 统一错误上报与操作日志，便于跨模块追踪。

## 设计原则与交互规范（基于 Arco Design）
- 工具栏与操作聚合：顶部工作台式工具栏统一承载刷新、导出、筛选；操作采用 `a-button/a-select/a-input`。
- 一致的反馈与保护：保存/跳转/删除均显示 `Message`；删除使用 `a-popconfirm`；编辑抽屉提供保存中 `loading` 态。
- 空/错/权限：列表空态 `a-empty`，加载骨架 `a-skeleton`，错误提示 `Message.error`，禁用控件附带 `a-tooltip` 原因。
- 渐进展示：编辑抽屉分节折叠（基础信息/使用场景/合规/备注），避免信息过载。

## 详细事件与状态流（档案页）
- 刷新数据：
  - 事件：`onArchiveRefresh`；组件：`a-button`；行为：调用 `store.fetchProducts()` 与相关 Store；反馈：`Message.success('已刷新档案数据')`。
  - 失败：网络异常 → `Message.error('刷新失败')`；按钮 `loading` 复位，保留上一次数据。
- 导出列表：
  - 事件：`onArchiveExport`；组件：`a-button`；行为：生成 CSV/JSON 并下载；反馈：`Message.success('已导出')`；错误 → `Message.error`。
- 编辑抽屉：
  - 打开：`onArchiveEditOpen(record)` → 设置 `editTarget` 与填充表单；参考：`src/pages/external-data-archive/index.vue:415–425`。
  - 保存：`onArchiveEditSave(form)` → 写回 `usageScene` 等字段；参考：`426–431`；成功 `Message.success('保存成功')`；校验失败高亮错误字段。
  - 取消：`onArchiveEditCancel` → 关闭抽屉并提示 `Message.info('已取消编辑')`。
- 跳转技术详情/评估/监控：
  - 事件：`onJumpToTechDetail/onJumpToEvaluation/onJumpToMonitor`；封装方法：`goWithQuery(path, extra)`；参考：`75–79,128,134,179,437–441`；成功 `Message.info`；失败 `Message.error`。
- 操作列：
  - 编辑档案：`onRowEdit(record)` → 打开抽屉；参考：`174–209,201`。
  - 查看评估：`onRowViewEvaluation(record)` → 跳评估列表并携带 `product`；参考：`437–439`。
  - 查看监控：`onRowViewMonitor(record)` → 跳监控页；参考：`440–442`。

## 组件映射与状态
- 列表：`a-table`（分页、筛选、排序），空态/加载/错误统一；操作列使用 `a-space + a-button(type='text')`。
- 抽屉：`a-drawer` 包含 `a-form`；校验规则与 `Message` 反馈；保存按钮 `loading`。
- 工具栏：`a-space` 内布置筛选与动作；提供 `Reset` 与 `Search` 按钮，状态互斥。
