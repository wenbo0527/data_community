# 营销画布 - 横版工作流版本前端优化需求文档（数据结构兼容版）

## 变更摘要
- 开始节点仅展示：任务类型、目标人群
- AB 实验节点展示：各分支流量占比（百分比）
- 权益节点展示：权益包名称（权益名称）
- 节点样式参考：`tos-alisg-i-84wi3idyod-sg/sg/7472291080147584008/image/1762934883692_s49dk3zx5r0_png_350x266`
- 画布数据格式完全兼容 `/marketing/tasks` 页面使用的原版画布数据结构（仅前端展示优化，不改变契约）

## 1. 数据结构兼容要求
- 统一画布数据结构（参考原版）
  - CanvasData：`{ nodes: BaseNode[], connections: Connection[] }`
  - 节点（BaseNode）：`id`, `type`, `x`, `y`, `label?`, `data?`, `ports?`（src/pages/marketing/tasks/types/core.ts:30）
  - 端口（NodePort）：`id`, `type ('input'|'output')`, `position ('top'|'right'|'bottom'|'left')`（types/core.ts:75）
  - 连接（Connection）：`id`, `sourceId`, `targetId`, `sourcePortId?`, `targetPortId?`, `data?`（types/core.ts:112）
- 导入/导出接口对齐
  - 画布组件导出：`getCanvasData() -> { nodes, connections }`（src/pages/marketing/tasks/components/TaskFlowCanvasRefactored.vue:3318）
  - 画布组件导入：`loadCanvasData(data)` 逐项加载节点与连接（TaskFlowCanvasRefactored.vue:3337,3356）
- 列表/编辑页契约示例
  - 列表页示例结构：`canvasData: { nodes: [...], connections: [...] }`（src/pages/marketing/tasks/index.vue:191,202）
  - 编辑页加载写入并传递至画布：`canvasRef.loadCanvasData(canvasData)`（src/pages/marketing/tasks/task-editor.vue:606）

## 2. 横版与原版的映射规则
- 节点字段
  - `id`：字符串（唯一）
  - `type`/`nodeType`：与原版一致（如 `start`, `audience-split`, `event-split`, `sms`, `ai-call`, `manual-call`, `ab-test`, `wait`, `benefit`；src/utils/nodeTypes.js:11）
  - 位置：`x`, `y`（原版直接使用坐标；兼容 `getPosition()`）
  - `label`：可选标题（保持原有用法）
  - `data`：包含 `isConfigured` 与具体 `config`（横版写回逻辑已使用此结构：src/pages/marketing/tasks/horizontal/index.vue:289-305）
  - `ports`：保留对象结构（`groups` + `items`），横版为左进右出（horizontal/utils/portConfigFactoryHorizontal.js:6,21）；原版上下布局可继续识别
- 连接字段
  - `id`：字符串唯一
  - 源/目标：兼容 `sourceId/targetId` 或 `{ cell, port }` 形态（横版使用 `{ cell, port }` 加端口 ID）
  - 端口：`sourcePortId`/`targetPortId`（如 `in`, `out-0`），与原版可选端口字段兼容（types/core.ts:112）
- 校验与预览线
  - 保持原版发布校验输入 `{ nodes, connections }`，如需自动补 `end` 节点可沿用 `previewLines`（src/utils/enhancedCanvasValidation.js）

## 3. 节点展示规范（抽屉配置 → 节点内渲染）
- 通用规则
  - 长方形节点；左侧 1 个 `in` 端口（左侧中点）；右侧 `out-*` 与展示行对齐
  - 文本逐行，端口对齐行中点；高度随有效行数自适应
  - 长文本截断与悬停完整提示
- 开始节点（start）
  - 展示：`任务类型(config.taskType)`、`目标人群(config.targetAudience[])`
  - 不展示：进入日期/频率/去重天数/推送上限/优先级（仍保留在 `config`）
  - 右侧单 `out`
- 人群分流（crowd-split）
  - 行：`命中：{crowdName}`（遍历 `config.crowdLayers`）
  - 行：`否则：{config.unmatchBranch.name}`（固定未命中）
  - 端口：`out-0..out-n` 与行序一致
- 事件分流（event-split）
  - 类型：`eventType`（`custom` → `自定义事件：{customEventName}`）
  - 条件：`eventCondition`（可选）
  - 行1：`命中：{yesLabel || '是'}` → `out-0`
  - 行2：`等待 {timeout} 分钟未命中` → `out-1`
- AB 实验（ab-test）
  - 行：`{branch.name}：{branch.percentage}%`（每分支一行，右侧端口与行对齐）
  - 名称：`experimentName`（标题区）
  - 描述：`description`（可选）
- AI 外呼（ai-call）
  - 行：`触达任务ID：{taskId}`
- 短信（sms）
  - 行：`短信模板：{smsTemplate}`（中文标签）
- 人工外呼（manual-call）
  - 行：`配置ID：{configId}`；`description` 可选
- 等待（wait）
  - 行：`等待：{value} {unit}`（分钟/小时/天）
- 权益（benefit）
  - 行：`权益包名称：{benefitName}`（必显）
  - 可选：`benefitType/benefitAmount/有效期`（次要信息）

## 4. 连线与交互（保持原版契约）
- 手动连线：不自动生成预览线与连接线；用户从 `out` 端口拖拽；每 `out` 仅 1 条（index.vue:133-141）
- 方向限制：`out -> in` 且目标在右侧（index.vue:115-131）
- 悬停边工具与插入：保留；插入分流默认保留至 `out-0`（index.vue:268-271）
- 右键删除连接线：新增 `edge:contextmenu` 事件处理（仅前端交互增强）
- 节点级联删除：沿线性链路删除（下游入度=1，出度<=1），分支/共享结构终止

## 5. 发布校验（沿用原版）
- 规则：所有 `out-*` 端口必须存在连接
- 失败反馈：阻止发布，高亮端口并提示节点/端口ID
- 可选：传入 `previewLines` 以自动补全 `end` 节点（enhancedCanvasValidation）

## 6. 示例数据（兼容原版 Schema）
- 节点示例（AB 实验）：
```json
{
  "id": "ab-123",
  "type": "ab-test",
  "x": 540,
  "y": 160,
  "label": "AB实验分流",
  "ports": { "groups": { "in": {}, "out": {} }, "items": [{"id":"in","group":"in"},{"id":"out-0","group":"out"},{"id":"out-1","group":"out"}] },
  "data": {
    "isConfigured": true,
    "config": {
      "experimentName": "首页文案AB",
      "description": "文案对点击率影响测试",
      "branches": [
        {"id":"branch_1","name":"对照组","percentage":50,"label":"A"},
        {"id":"branch_2","name":"实验组","percentage":50,"label":"B"}
      ]
    }
  }
}
```
- 连接示例：
```json
{ "id": "e1", "sourceId": "start", "targetId": "ab-123", "sourcePortId": "out", "targetPortId": "in" }
{ "id": "e2", "sourceId": "ab-123", "targetId": "sms-1", "sourcePortId": "out-0", "targetPortId": "in" }
{ "id": "e3", "sourceId": "ab-123", "targetId": "benefit-2", "sourcePortId": "out-1", "targetPortId": "in" }
```
- 列表/编辑页读取示例：`{ nodes: [...], connections: [...] }`（index.vue:191,202；task-editor.vue:606）

## 7. 视觉与样式
- 标题/内容分层，行距统一（24–28），端口与行中点对齐
- 长文本截断+悬停提示；颜色与圆角与参考图一致（现 `rx/ry` 为 `8`）

## 8. 验收标准
- 展示：节点字段渲染准确；分流类端口与行对齐；开始节点仅显示两项；AB 显示百分比；权益显示权益包名称
- 交互：手动连线、插入、删除、级联删除符合预期
- 校验：发布时未连满阻止并精确提示
- 兼容：导入/导出数据结构与原版一致；可在编辑页/列表页无缝读取与保存

## 9. 风险与兼容
- HTML/foreignObject 渲染与端口对齐需验证；可回退 SVG 文本方案
- 分支动态调整导致端口/连线更新复杂度提升；需统一更新策略与防抖

## 10. 实施建议
- 建立“配置→展示行→端口”映射层（纯函数），为各节点类型生成展示行与端口对齐信息
- 保持 `node.data`、`ports`、`connection.*PortId` 字段契约不变；使用 `getCanvasData/loadCanvasData` 接口对接原版
- 增加 `edge:contextmenu` 删除与发布校验；实现线性链路级联删除

确认后，我将基于该兼容方案在横版页面中落地展示与交互优化，并验证与 `/marketing/tasks` 的数据互通。

## 11. 目标与范围（合并版）
- 目标：打造横版工作流画布的产品级体验，统一节点呈现、交互规则与服务集成，保证与 `/marketing/tasks` 的数据互通。
- 范围：节点结构、类型图标与标题行、更多（⋯）菜单、端口与连接、抽屉配置、删除策略、发布校验、性能与兼容。

## 12. 节点卡片结构（标题行 + 内容行）
- 标题行：左侧类型图标 + 标题文本（优先使用 `config.nodeName`）；右上角显示“⋯”更多菜单（除 `start/end` 外）。
- 内容行：逐行展示核心信息；分流类节点每分支一行；右侧 `out-i` 与对应行的中点对齐；左侧中点为 `in` 端口。
- 尺寸：宽度 `280`，高度 = 标题高度 + 内容行数 × 行高（建议 `24–28`）；长文本截断并在悬停时显示完整提示。
- 代码参考：
  - 节点悬停显示“⋯”按钮：`src/pages/marketing/tasks/horizontal/index.vue:210`。
  - “更多菜单”容器与按钮：`src/pages/marketing/tasks/horizontal/index.vue:24,30,481,485,488,504,511`。

## 13. 节点标题/内容映射表（抽屉配置 → 展示行）
- start：标题“开始”；内容行：`任务类型：{taskType}`、`目标人群：{targetAudience}`；右侧单 `out`；不显示“⋯”。
- audience-split：标题“人群分流”；内容行：`命中：{crowdName}`×N；最后一行固定：`否则：{unmatchBranch.name}`；右侧端口 `out-0..out-n` 与行序一致。
- event-split：标题“事件分流”；内容行：`命中：{yesLabel||'是'}`（`out-0`）、`等待 {timeout} 分钟未命中`（`out-1`）。
- ab-test：标题“AB实验”或实验名；内容行：`{branch.name}：{branch.percentage}%`×N；可选描述不挂端口。
- ai-call：标题“AI外呼”；内容行：`触达任务ID：{taskId}`；右侧单 `out`。
- sms：标题“短信触达”；内容行：`短信模板：{smsTemplate}`；右侧单 `out`。
- manual-call：标题“人工外呼”；内容行：`配置ID：{configId}`；右侧单 `out`。
- wait：标题“等待”；内容行：`等待：{value} {unit}`；右侧单 `out`。
- benefit：标题“权益”；内容行：`权益包名称：{benefitName}`；右侧单 `out`。
- end：标题“结束”；不显示“⋯”；不挂端口。

## 14. 类型图标清单（建议）
- `start: IconPlayCircle`，`audience-split: IconUserGroup`，`event-split: IconCalendarClock`，`ab-test: IconBranch`。
- `sms: IconMessage`，`email: IconMail`，`wechat: IconWechat`，`ai-call: IconRobot`，`manual-call: IconPhone`。
- `wait: IconTime`，`benefit: IconGift`，`end: IconStopCircle`。
- 位置与样式：标题左侧 16–18px；与文本间距 8–10px；颜色轻度区分主题。

## 15. 端口与连接交互（横向规则）
- 方向限制：仅允许 `out → in`，且目标节点必须位于源节点右侧。
- 单端口限制：同一 `out` 端口仅允许一条连接；同一目标 `in` 端口仅允许一条连接。
- 连接线交互：
  - 悬停显示删除与“+”插入按钮：`src/pages/marketing/tasks/horizontal/index.vue:168`。
  - 右键删除连接线：`src/pages/marketing/tasks/horizontal/index.vue:202`。
- 校验实现：`validateConnection` 中完成方向与唯一性校验：`src/pages/marketing/tasks/horizontal/index.vue:133`。
- 端口配置（横向左进右出）：`src/pages/marketing/tasks/horizontal/utils/portConfigFactoryHorizontal.js:6,21`；调用处：`src/pages/marketing/tasks/horizontal/index.vue:277,412`。

## 16. 抽屉配置与打开逻辑
- 统一入口：`useConfigDrawers.openConfigDrawer(type, node, data)`。
- 打开时机：
  - 点击节点打开抽屉：`src/pages/marketing/tasks/horizontal/index.vue:223,226`。
  - 拖拽创建后自动打开：`src/pages/marketing/tasks/horizontal/index.vue:336,477`。
- 处理函数：
-  - 打开：`src/pages/marketing/tasks/composables/canvas/useConfigDrawers.js:84`。
-  - 确认：`src/pages/marketing/tasks/composables/canvas/useConfigDrawers.js:201`。
-  - 取消：`src/pages/marketing/tasks/composables/canvas/useConfigDrawers.js:315`。
- 抽屉容器组件：`src/pages/marketing/tasks/horizontal/index.vue:40,55`。

## 17. 删除策略（级联）
- 级联规则：沿下游“线性链路”（目标入度 = 1、出度 ≤ 1）向前删除；遇到分支或共享节点终止。
- 入口：右键节点触发级联删除：`src/pages/marketing/tasks/horizontal/index.vue:206,207`。
- 实现：`deleteNodeCascade(startId)`：`src/pages/marketing/tasks/horizontal/index.vue:433`。
- 更多菜单删除：`src/pages/marketing/tasks/horizontal/index.vue:504`。

## 18. 发布校验与错误态
- 规则：所有 `out-*` 端口必须存在连接；返回 `{ nodeId, portId }` 问题清单。
- 实现：`validateAllOutPortsConnected()`：`src/pages/marketing/tasks/horizontal/index.vue:527`。
- UI 提示：阻止发布、高亮端口并定位问题节点（与原版校验契合）。

## 19. 验收用例
- 展示：各节点字段渲染准确；分流类端口与行对齐；开始/结束不显示“⋯”。
- 交互：点击打开抽屉；`out→in` 连线成功；连接线悬停出现工具；右键连接线删除生效。
- 更多菜单：重命名、复制、删除可用（引用：`src/pages/marketing/tasks/horizontal/index.vue:481,488,511,504`）。
- 校验：发布时未连满阻止并提示问题端口；问题清单包含节点ID与端口ID。
- 兼容：导入/导出结构与原版一致；列表/编辑页均能无缝使用。

## 20. 性能与指标
- 大图性能：100+ 节点场景下保持交互流畅；必要时回退为纯 SVG 文本以保证端口对齐稳定性。
- 优化手段：渲染缓存、布局防抖、批量样式更新、网格对齐与坐标换算优化。

## 21. 风险与回退
- foreignObject 文本与端口对齐兼容风险；回退为纯 SVG 文本渲染。
- 类型枚举与端口工厂一致性风险；统一 `nodeTypes` 与端口配置工厂，避免命名不一致。
- 分支动态调整导致端口与连线更新复杂；统一更新策略与防抖保护。

## 22. 实施里程碑
- 阶段1（渲染层）：完成标题/内容分层与端口对齐；通过示例节点验收。
- 阶段2（交互层）：连线方向与唯一性校验、连接线工具、右键删除与级联删除。
- 阶段3（抽屉接入）：统一 `openConfigDrawer` 与配置写回；驱动展示行与端口重建。
- 阶段4（发布校验与验收）：完善校验与问题清单；执行验收用例并出具结论。

## 23. 关键代码引用
- 连接校验与方向限制：`src/pages/marketing/tasks/horizontal/index.vue:133`。
- 悬停工具与“+”插入：`src/pages/marketing/tasks/horizontal/index.vue:168,180-197`。
- 右键删除连接线：`src/pages/marketing/tasks/horizontal/index.vue:202`。
- 节点点击打开抽屉：`src/pages/marketing/tasks/horizontal/index.vue:223,226`。
- 端口配置工厂（横向）：`src/pages/marketing/tasks/horizontal/utils/portConfigFactoryHorizontal.js:6,21`。
- 抽屉系统：`src/pages/marketing/tasks/composables/canvas/useConfigDrawers.js:84,201,315`；容器使用：`src/pages/marketing/tasks/horizontal/index.vue:40,55`。
- 级联删除：`src/pages/marketing/tasks/horizontal/index.vue:206,433`。
- 更多菜单功能：`src/pages/marketing/tasks/horizontal/index.vue:24,30,481,488,504,511`。

## 24. 设计文档（遵循重构原则）

### 24.1 设计原则对齐
- 单一职责：每个服务只承担一种职责，不跨界实现布局、事件、状态等。
- 消除降级：不使用兜底降级路径，采用前置条件校验与依赖注入。
- 服务化架构：以 Graph、PreviewLine、Layout、Event、State 五大服务为核心。
- 模块化与复用：组件仅负责展示与交互，业务逻辑在服务层实现。
- 向后兼容：保留 `CanvasData` 契约，提供适配器和渐进式迁移路径。

### 24.2 架构总览
- CanvasController（横版页面内）：负责服务装配、依赖注入、生命周期与事件绑定。
- 服务层：
  - GraphService：节点与边的增删改查、查询。
  - PreviewLineService：预览线创建、更新、删除、验证、清理。
  - LayoutService：水平布局计算与节点定位，结合统一结构化布局引擎。
  - EventService：图事件接入与分发，调用服务层完成业务处理。
  - StateService：页面状态存取与持久化，导入导出 `CanvasData`。

### 24.3 服务接口定义

```ts
interface GraphService {
  addNode(data: BaseNode): string
  updateNode(id: string, updates: Partial<BaseNode>): void
  removeNode(id: string): void
  addEdge(data: Connection): string
  updateEdge(id: string, updates: Partial<Connection>): void
  removeEdge(id: string): void
  getNode(id: string): BaseNode | null
  getAllNodes(): BaseNode[]
  getAllEdges(): Connection[]
}

interface PreviewLineService {
  createPreviewLine(sourceId: string, targetId?: string): string
  updatePreviewLine(id: string, updates: object): void
  removePreviewLine(id: string): void
  validatePreviewLine(data: object): boolean
  cleanupInvalidPreviewLines(): number
}

interface LayoutService {
  calculateLayout(nodes: BaseNode[], edges: Connection[], options?: object): object
  positionNodes(nodes: BaseNode[], layoutResult: object): void
  optimizeLayout(currentLayout: object): object
}

interface EventService {
  bindGraphEvents(graph: any): void
  handleNodeClick(nodeId: string): void
  handleEdgeContextMenu(edgeId: string): void
  handleBlankClick(point: { x: number; y: number }): void
}

interface StateService {
  getState<T = any>(key: string): T
  setState(key: string, value: any): void
  updateState(updates: Record<string, any>): void
  saveCanvas(): CanvasData
  loadCanvas(data: CanvasData): void
}
```

### 24.4 依赖注入与装配
- CanvasController 构造时注入 Graph 实例与工具类引用。
- 服务层通过构造函数接收依赖，不使用 `window.*` 全局访问。
- 事件绑定通过 EventService 统一注册到 X6 图实例。

### 24.5 数据契约与类型
- CanvasData：`{ nodes: BaseNode[], connections: Connection[] }`。
- BaseNode：`{ id, type, x, y, label?, data: { isConfigured, config }, ports }`。
- Connection：`{ id, sourceId, targetId, sourcePortId?, targetPortId? }`。
- NodeType：与现有 `src/utils/nodeTypes.js` 一致，保持兼容。

### 24.6 交互流程设计
- 节点选择器：左上角停靠显示；点击或拖拽生成节点；拖拽落点由 GraphService 负责添加节点。
- 节点点击：EventService 调用 `useConfigDrawers.openConfigDrawer` 打开抽屉。
- 连接线：`validateConnection` 由 EventService 调用 GraphService 查询并校验唯一性与方向。
- 右键删除：统一由 EventService 分发到 GraphService 删除边与级联删除节点。

### 24.7 校验设计
- 连接校验：方向 `out→in`、目标在右侧、端口唯一性。实现参考 `horizontal/index.vue:133`。
- 发布校验：所有 `out-*` 必须连线，返回 `{ nodeId, portId }`。实现参考 `horizontal/index.vue:527`。
- 预览线验证：使用 ValidationUtils 校验坐标与节点位置尺寸。

### 24.8 适配与迁移策略
- 适配器：在横版页面中以 CanvasController 包装现有逻辑，逐步切换到服务层方法。
- 渐进式：优先替换事件接入与校验路径，其次替换节点与边操作，最后替换布局调用。
- 兼容性：保留 `getCanvasData/loadCanvasData` 接口以兼容编辑页与列表页。

### 24.9 测试策略
- 单元测试：服务层方法的输入输出与错误路径；覆盖率目标 Graph/PreviewLine/Layout ≥95%。
- 集成测试：事件触发到节点/边/抽屉的联动；连接校验与删除策略。
- 端到端测试：横版页面核心交互流程；发布校验失败与提示正确性。

### 24.10 性能策略
- 渲染缓存与防抖：节点行重建与端口重建采用批量更新与防抖。
- 回退策略：在 foreignObject 对齐存在兼容性时回退到纯 SVG 文本方案。
- 布局优化：复用统一结构化布局引擎的增量布局与网格对齐。

### 24.11 风险与回退
- 类型枚举与端口工厂不一致导致连接异常，统一从 `nodeTypes` 与横向端口工厂生成。
- 分支调整引发连线错配，采用统一更新策略与批量校验保护。
- 预览线系统未注入，严格依赖注入并在装配时校验初始化状态。

### 24.12 实施计划
- 阶段1：事件接入与校验路径服务化；保留现有 UI。
- 阶段2：节点与边操作切换到 GraphService；完善删除策略。
- 阶段3：抽屉与状态管理接入 StateService；配置写回驱动展示行与端口。
- 阶段4：布局切换到 LayoutService；完成端到端测试与验收。

### 24.13 关键实现映射
- 事件接入：`edge:mouseenter/leave/contextmenu`、`node:click`、`blank:click` 映射到 EventService。
- 节点与边操作：`createRectNode`、`graph.addNode/addEdge/removeEdge` 映射到 GraphService。
- 抽屉系统：`useConfigDrawers.openConfigDrawer/handleConfigConfirm/handleConfigCancel` 由 EventService 与 StateService 驱动。
- 布局与端口：横向端口工厂与结构化布局引擎由 LayoutService 统一调用。

## 25. 架构能力与集成（融合版补充）
- NodeCreationService：节点创建与初始化；校验与生成配置对象；端口配置（PortConfigurationFactory）。
- NodeStyleService：主题样式、状态样式（选中/悬停/禁用/错误）；批量样式更新。
- NodeCoordinateService：坐标计算、布局与碰撞避让、网格对齐（可复用水平布局策略）。
- NodeDeletionService：清理连接、预览线、配置与删除节点；支撑级联删除策略。
- NodeConfigService：打开/保存节点配置；与抽屉 UI 对接（横版接入 `useConfigDrawers`）。
- 端口配置一致性：统一节点类型枚举，修复端口工厂中的缺失类型与命名不一致问题。

## 26. 补充关键引用（融合版）
- 横版页面初始化与连接校验：`src/pages/marketing/tasks/horizontal/index.vue:86-146, 115-141`。
- 连接删除与插入：`src/pages/marketing/tasks/horizontal/index.vue:179, 149-177, 262-271`。
- 抽屉系统横版接入：`src/pages/marketing/tasks/horizontal/index.vue:18, 194, 332, 447`。
- 原版导入/导出接口：`src/pages/marketing/tasks/components/TaskFlowCanvasRefactored.vue:3318,3337`。
