## 目标
- 将“费用核算、外部对账、确认核销”统一到结算流程中，形成可导航的阶段化页面与数据流。
- 保留现有“发起结算、任务列表、子任务进度、报告下载”能力，补齐缺失的阶段功能并与合同/预算域打通。

## 现状与主要缺口
- 路由与菜单：已提供 `/risk/budget/settlement` 和阶段入口 `?stage=costing|reconcile|writeoff`（src/config/menuConfig.js:523-545），页面未解析 `stage` 切换视图（src/modules/budget/pages/Settlement.vue:396-413）。
- 发起结算：供应商多选，与“仅支持单选”的目标不一致（src/modules/budget/pages/Settlement.vue:129-141,269-271）；未支持按供应商的“产品筛选与剔除”。
- 费用核算：底层计算具备（固定/阶梯/按量，src/modules/budget/utils/costing.ts），但无页面化展示与确认；“特殊计费”未实现（src/modules/budget/api/pricingArchive.ts:1-10）。
- 外部对账：无对账单上传、解析、差异比对与编辑流程。
- 确认核销：现有核销入口与结算任务未联动，且不按产品/合同维度分笔核销（src/pages/budget/components/BudgetVerificationPanel.vue）。
- 报告：当前导出为摘要 JSON，缺少固定字段明细（供应商、产品、用量、计费方式、规则、实际费用）。

## 总体架构调整
- Settlement 主页面保留“工具栏、发起结算弹窗、任务列表”，新增阶段化子组件：
  - CostingPanel（费用核算）
  - ReconcilePanel（外部对账）
  - WriteoffPanel（确认核销）
- 统一数据模型：对齐定价档案与合同定价映射，补齐 `'special'` 类型；引入“账单行”统一结构用于核算、对账与核销。
- 将结算任务（src/modules/budget/api/settlement.ts）扩展为带阶段状态与结果快照的实体，支撑报告与核销写回。

## 详细实现方案
### 阶段路由与视图
- 读取 `route.query.stage`，默认 `index`，支持 `costing|reconcile|writeoff`，在 Settlement.vue 中切换渲染。
- 菜单点击与面包屑保持现状（src/config/menuConfig.js）。

### 发起结算优化
- 供应商选择调整为“单选”，并依据供应商加载其关联的外数产品清单，提供“产品剔除”能力。
- 保留合同多选以约束核销可用预算；在子任务里按供应商分组仍可用（src/modules/budget/pages/Settlement.vue:314-335）。

### 费用核算阶段（固定→阶梯→特殊）
- 接入 `generateBillLines` 生成账单行，按类型分组：
  - 固定费用：表格展示“产品名称、单价、调用量、系统费用”，支持“单独确认/批量确认”。
  - 阶梯定价：单产品视图展示“阶梯规则、实际用量、公式与结果”，逐个确认后加载下一个。
  - 特殊计费：账单行生成时不自动计算金额（amount 置 0），在 UI 手动填写并确认；为定价档案增加 `'special'` 样例与字段（如 `formula`, `remark`）。
- 确认后形成“核算完成快照”，进入下一阶段。

### 外部对账阶段
- 上传外部对账单（CSV/Excel），解析为账单行结构，含：用量、单价、总费用、税率、币种。
- 系统账单 vs 外部账单逐产品比对：
  - 显示“我方调用量/单价/总费用 vs 外部对账单数据”。
  - 若一致，点击“确认采用费用”；若不一致，允许编辑最终费用并填写差异说明。
- 所有产品完成确认/编辑后，生成“对账结果快照”，进入核销阶段。

### 确认核销阶段
- 按“外数产品”维度展示待核销总费用；列出所有可核销合同（状态为“生效”且剩余预算>0），按“剩余可核销费用”倒序。
- 分笔核销操作：选择合同、输入本次核销金额（≤合同剩余、≤产品待核销），点击“确认核销”，实时扣减合同剩余预算并生成核销记录（合同编号、金额、剩余）。
- 若未覆盖全部费用，重复分笔直至抵扣完成；产品标记“核销完成”，跳转下一个产品，直至全部完成。
- 完成后更新结算任务阶段为“已完成”，支持报告生成与下载。

### 报告生成
- 统一生成《费用报告》固定字段：供应商名称、外数产品名称、调用量、计费方式（固定/阶梯/特殊）、计费规则、实际费用。
- 报告来源包括：核算快照、对账最终费用、核销记录；支持 JSON/CSV 导出。

### 数据模型与服务扩展
- 定价档案 `Pricing` 增加 `'special'` 类型示例；`costing.ts` 增加 `'special'` 分支（不自动计价，UI 填写）。
- 结算任务 `SettlementTask` 增加阶段字段、核算/对账/核销的结果快照与报告元数据。
- 与合同域（Pinia store: src/modules/budget/stores/contract.ts）打通：核销扣减写回 `remainingAmount` 或附加核销流水；后端上线前先内存态模拟。

## 组件与文件清单
- Settlement.vue：解析 `stage`，注入并渲染阶段组件；保持“发起结算/列表/详情”现有能力。
- 新增组件：
  - pages/settlement/CostingPanel.vue：分类核算视图与确认交互；调用 `generateBillLines`。
  - pages/settlement/ReconcilePanel.vue：`<a-upload>` 上传并解析对账单；逐产品比对与编辑。
  - pages/settlement/WriteoffPanel.vue：可核销合同列表、分笔核销、生成核销记录与写回。
- 服务与工具：
  - api/pricingArchive.ts：增加 `'special'` 类型样例与字段；map 查询函数维持不变。
  - utils/costing.ts：新增 `'special'` 分支，产出待填金额的账单行。
  - api/settlement.ts：增加阶段与快照字段、报告元数据；保持创建/完成/取消接口。

## 验收标准
- 阶段入口可用：菜单点击 `费用核算/外部对账/确认核销` 正确切换阶段视图。
- 费用核算：固定/阶梯/特殊三类可完整核算与确认；特殊计费支持手动填入。
- 外部对账：上传解析成功，逐产品比对与编辑，最终费用可落账为快照。
- 确认核销：按产品维度完成分笔核销、实时扣减合同预算并生成记录；全部产品完成后任务状态更新为已完成。
- 报告：包含指定的固定字段，内容来源一致且数据闭环。

## 测试与验证
- 单元测试：
  - 阶梯计费计算正确性（边界/超档/精度）。
  - 对账差异合并规则（一致、编辑覆盖）。
  - 分笔核销约束（额度校验、扣减正确）。
- 端到端流程：从“发起结算（单选供应商+产品剔除）→核算→对账→核销→报告下载”。

## 风险与应对
- 特殊计费规则多样：首版以“手动金额”为准，后续迭代引入公式化配置。
- 对账单格式差异：首版支持 CSV/Excel（约定模板），解析失败给出错误提示与示例模板下载。
- 数据一致性：后端未联通前，内存态与 Pinia 写回可能与真实预算域不同步；上线后切换实际接口。

## 迭代顺序
1) 阶段路由与视图接入
2) 费用核算页面化与 `'special'` 类型支持
3) 外部对账上传与比对
4) 确认核销分笔与写回
5) 报告生成与导出
