# é¢„è§ˆçº¿ç³»ç»Ÿä»£ç è¯„ä¼°æŠ¥å‘Š

## 1. æ¨¡å—æ¦‚è¿°

### 1.1 æ¨¡å—åŸºæœ¬ä¿¡æ¯
- **æ¨¡å—åç§°**: é¢„è§ˆçº¿ç³»ç»Ÿ
- **ä¸»è¦åŠŸèƒ½**: ç®¡ç†ç”»å¸ƒä¸­çš„é¢„è§ˆçº¿åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤å’ŒéªŒè¯
- **æ¨¡å—å¤æ‚åº¦**: é«˜
- **ç»´æŠ¤éš¾åº¦**: é«˜

### 1.2 ä¸»è¦èŒè´£
- é¢„è§ˆçº¿çš„åˆ›å»ºå’Œç®¡ç†
- é¢„è§ˆçº¿åˆ°è¿æ¥çº¿çš„è½¬æ¢
- é¢„è§ˆçº¿æœ‰æ•ˆæ€§éªŒè¯å’Œæ¸…ç†
- é¢„è§ˆçº¿çŠ¶æ€ç›‘æ§å’Œç»Ÿè®¡
- æ€§èƒ½ä¼˜åŒ–å’Œæ‰¹å¤„ç†

### 1.3 æ¶‰åŠçš„æ–‡ä»¶åˆ—è¡¨
```
composables/canvas/usePreviewLine.js                    # ä¸»è¦é¢„è§ˆçº¿ç®¡ç† (1,720è¡Œ)
composables/canvas/unified/UnifiedEdgeManager.js        # ç»Ÿä¸€è¾¹ç®¡ç†å™¨ (1,400+è¡Œ)
utils/preview-line/PreviewLineSystem.js                 # æ–°ç‰ˆé¢„è§ˆçº¿ç³»ç»Ÿ
utils/preview-line/core/PortConfigurationFactory.js     # ç«¯å£é…ç½®å·¥å‚
utils/preview-line/core/ConnectionCreationController.js # è¿æ¥åˆ›å»ºæ§åˆ¶å™¨
utils/preview-line/algorithms/InPortSnapDetector.js     # ç«¯å£å¸é™„æ£€æµ‹
utils/preview-line/performance/SpatialIndexOptimizer.js # ç©ºé—´ç´¢å¼•ä¼˜åŒ–å™¨
utils/preview-line/performance/BatchProcessor.js        # æ‰¹å¤„ç†å™¨
utils/preview-line/performance/CacheManager.js          # ç¼“å­˜ç®¡ç†å™¨
```

## 2. æ™ºèƒ½é™çº§å…œåº•é€»è¾‘åˆ†æ

### 2.1 æ ¸å¿ƒé™çº§é€»è¾‘æ¸…å•

#### A. é¢„è§ˆçº¿ç³»ç»Ÿå¤šé‡ç­–ç•¥é€‰æ‹©
**ä½ç½®**: usePreviewLine.js:1231-1262
```javascript
// è§¦å‘é¢„è§ˆçº¿ç®¡ç†å™¨æ¸…ç†ï¼ˆé›†æˆPreviewLineSystemï¼‰
const triggerPreviewLineCleanup = withPerformanceMonitoring(async () => {
  // ä¼˜å…ˆä½¿ç”¨æ–°çš„PreviewLineSystem
  if (window.previewLineSystem) {
    console.log('ğŸ§¹ [PreviewLine] è§¦å‘æ–°é¢„è§ˆçº¿ç³»ç»Ÿæ¸…ç†æ— æ•ˆæ•°æ®...')
    if (typeof window.previewLineSystem.validateAndCleanupDuplicates === 'function') {
      await window.previewLineSystem.validateAndCleanupDuplicates()
    }
  } else if (window.previewLineManager) {
    console.log('ğŸ§¹ [PreviewLine] è§¦å‘æ—§é¢„è§ˆçº¿ç®¡ç†å™¨æ¸…ç†æ— æ•ˆæ•°æ®...')
    if (typeof window.previewLineManager.validateAndCleanupDuplicates === 'function') {
      await window.previewLineManager.validateAndCleanupDuplicates()
    }
  } else {
    // æ‰‹åŠ¨æ¸…ç†é€»è¾‘
    console.log('ğŸ§¹ [PreviewLine] ä½¿ç”¨å†…ç½®æ¸…ç†é€»è¾‘...')
    await validatePreviewLines()
  }
}, 'è§¦å‘é¢„è§ˆçº¿æ¸…ç†')
```

**é—®é¢˜åˆ†æ**:
- ä¾èµ–å…¨å±€å˜é‡æ£€æŸ¥æ¥é€‰æ‹©å®ç°
- ä¸‰é‡é™çº§ç­–ç•¥å¢åŠ å¤æ‚åº¦
- ä¸åŒç­–ç•¥å¯èƒ½äº§ç”Ÿä¸ä¸€è‡´çš„ç»“æœ
- éš¾ä»¥é¢„æµ‹å®é™…æ‰§è¡Œçš„é€»è¾‘

**è§¦å‘æ¡ä»¶**: å…¨å±€é¢„è§ˆçº¿ç³»ç»Ÿå®ä¾‹ä¸å­˜åœ¨æˆ–æ–¹æ³•ä¸å¯ç”¨
**å½±å“èŒƒå›´**: é¢„è§ˆçº¿æ¸…ç†åŠŸèƒ½
**å¿…è¦æ€§è¯„ä¼°**: ä½ - åº”è¯¥ä½¿ç”¨ä¾èµ–æ³¨å…¥æ›¿ä»£å…¨å±€å˜é‡æ£€æŸ¥

#### B. é…ç½®æŠ½å±‰é¢„è§ˆçº¿åˆ›å»ºé™çº§
**ä½ç½®**: useConfigDrawers.js:226-255
```javascript
// ğŸ¯ ä¿®å¤ï¼šæ­£ç¡®è·å–é¢„è§ˆçº¿ç³»ç»Ÿå®ä¾‹
// ä¼˜å…ˆä»å…¨å±€windowå¯¹è±¡è·å–ï¼Œç¡®ä¿è·å–åˆ°æ­£ç¡®åˆå§‹åŒ–çš„å®ä¾‹
let previewLineSystem = null
let unifiedPreviewManager = null

// æ–¹æ¡ˆ1ï¼šä»å…¨å±€windowå¯¹è±¡è·å–PreviewLineSystemï¼ˆæœ€å¯é ï¼‰
if (window.previewLineSystem && typeof window.previewLineSystem.createPreviewLinesForExistingNodes === 'function') {
  previewLineSystem = window.previewLineSystem
  console.log('[useConfigDrawers] âœ“ ä½¿ç”¨å…¨å±€PreviewLineSystem')
} 
// æ–¹æ¡ˆ2ï¼šä»å…¨å±€windowå¯¹è±¡è·å–UnifiedPreviewManagerï¼ˆå¤‡é€‰ï¼‰
else if (window.unifiedPreviewManager && typeof window.unifiedPreviewManager.createPreviewLinesForExistingNodes === 'function') {
  unifiedPreviewManager = window.unifiedPreviewManager
  console.log('[useConfigDrawers] âœ“ ä½¿ç”¨å…¨å±€UnifiedPreviewManager')
}
// æ–¹æ¡ˆ3ï¼šä»propsè·å–ï¼ˆæœ€åå¤‡é€‰ï¼‰
else if (props.previewLineManager && typeof props.previewLineManager.createPreviewLinesForExistingNodes === 'function') {
  unifiedPreviewManager = props.previewLineManager
  console.log('[useConfigDrawers] âœ“ ä½¿ç”¨propsä¸­çš„é¢„è§ˆçº¿ç®¡ç†å™¨')
}
```

**é—®é¢˜åˆ†æ**:
- å¤šé‡è·å–ç­–ç•¥å¢åŠ å¤æ‚åº¦
- ä¾èµ–å…¨å±€å˜é‡å’Œpropsçš„æ··åˆç­–ç•¥
- ç¼ºä¹æ˜ç¡®çš„ä¾èµ–ç®¡ç†
- ä¸åŒè·å–æ–¹å¼å¯èƒ½å¯¼è‡´è¡Œä¸ºä¸ä¸€è‡´

**è§¦å‘æ¡ä»¶**: é¦–é€‰çš„é¢„è§ˆçº¿ç³»ç»Ÿå®ä¾‹ä¸å¯ç”¨
**å½±å“èŒƒå›´**: é…ç½®åé¢„è§ˆçº¿åˆ›å»º
**å¿…è¦æ€§è¯„ä¼°**: ä½ - åº”è¯¥ä½¿ç”¨ç»Ÿä¸€çš„ä¾èµ–æ³¨å…¥æœºåˆ¶

#### C. é¢„è§ˆçº¿æ¢å¤é”™è¯¯å¤„ç†é™çº§
**ä½ç½®**: usePreviewLine.js:1460-1502
```javascript
try {
  // æ£€æŸ¥æºèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ä¸”å·²é…ç½®
  const sourceNode = graph.getCellById(sourceNodeId)
  if (!sourceNode) {
    addWarning(`æ— æ³•æ¢å¤é¢„è§ˆçº¿ï¼šæºèŠ‚ç‚¹ä¸å­˜åœ¨ ${sourceNodeId}`)
    return { restored: 0, errors: ['æºèŠ‚ç‚¹ä¸å­˜åœ¨'] }
  }

  const sourceData = sourceNode.getData() || {}
  const nodeType = sourceData.nodeType || sourceData.type
  const isNodeConfigured = sourceData.isConfigured || nodeType === 'start'
  
  // ... æ¢å¤é€»è¾‘
} catch (error) {
  console.error(`âŒ [PreviewLine] é¢„è§ˆçº¿æ¢å¤å¤±è´¥: ${sourceNodeId}`, error)
  addError(`é¢„è§ˆçº¿æ¢å¤å¤±è´¥: ${sourceNodeId}`, error)
  return { restored: 0, errors: [error.message] }
}
```

**é—®é¢˜åˆ†æ**:
- å¼‚å¸¸æ•è·åè¿”å›é”™è¯¯ä¿¡æ¯è€ŒéæŠ›å‡ºå¼‚å¸¸
- é”™è¯¯å¤„ç†æ©ç›–äº†çœŸæ­£çš„é—®é¢˜
- ç¼ºä¹é”™è¯¯åˆ†ç±»å’Œæ¢å¤æœºåˆ¶
- è°ƒç”¨è€…æ— æ³•åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯

**è§¦å‘æ¡ä»¶**: é¢„è§ˆçº¿æ¢å¤è¿‡ç¨‹ä¸­ä»»ä½•å¼‚å¸¸
**å½±å“èŒƒå›´**: é¢„è§ˆçº¿æ¢å¤åŠŸèƒ½
**å¿…è¦æ€§è¯„ä¼°**: ä¸­ - éœ€è¦æ”¹è¿›é”™è¯¯å¤„ç†ç­–ç•¥

#### D. ç»Ÿä¸€è¾¹ç®¡ç†å™¨é‡å¤æ£€æŸ¥é™çº§
**ä½ç½®**: UnifiedEdgeManager.js:569-602
```javascript
// é¢„è§ˆçº¿é‡å¤æ£€æŸ¥ï¼ˆæ£€æŸ¥ç›¸åŒæºèŠ‚ç‚¹å’Œåˆ†æ”¯çš„é¢„è§ˆçº¿ï¼‰
if (edgeData.type === EdgeTypes.PREVIEW) {
  const sourceId = edgeData.source?.nodeId
  const branchId = edgeData.branchId || edgeData.branch?.id
  
  const existingPreview = Array.from(this.previewLines.values()).find(preview => {
    const matchesSource = preview.source.nodeId === sourceId
    const matchesBranch = branchId ? preview.branch?.id === branchId : !preview.branch?.id
    return matchesSource && matchesBranch
  })
  
  if (existingPreview) {
    console.warn('âš ï¸ [ç»Ÿä¸€è¾¹ç®¡ç†å™¨] æ£€æµ‹åˆ°é‡å¤é¢„è§ˆçº¿:', {
      sourceId,
      branchId,
      existingId: existingPreview.id
    })
    
    // é™çº§å¤„ç†ï¼šåˆ é™¤æ—§çš„é¢„è§ˆçº¿ï¼Œåˆ›å»ºæ–°çš„
    await this.removePreviewLine(existingPreview.id)
  }
}
```

**é—®é¢˜åˆ†æ**:
- æ£€æµ‹åˆ°é‡å¤æ—¶è‡ªåŠ¨åˆ é™¤æ—§é¢„è§ˆçº¿
- å¯èƒ½å¯¼è‡´ç”¨æˆ·æ“ä½œçš„æ„å¤–ç»“æœ
- ç¼ºä¹ç”¨æˆ·ç¡®è®¤æœºåˆ¶
- é™çº§é€»è¾‘å¯èƒ½æ©ç›–æ•°æ®ä¸€è‡´æ€§é—®é¢˜

**è§¦å‘æ¡ä»¶**: åˆ›å»ºé‡å¤çš„é¢„è§ˆçº¿
**å½±å“èŒƒå›´**: é¢„è§ˆçº¿åˆ›å»ºåŠŸèƒ½
**å¿…è¦æ€§è¯„ä¼°**: ä¸­ - éœ€è¦æ”¹è¿›é‡å¤å¤„ç†ç­–ç•¥

### 2.2 é™çº§é€»è¾‘ç»Ÿè®¡

| é™çº§ç±»å‹ | æ•°é‡ | ä»£ç è¡Œæ•° | å¤æ‚åº¦ | ç§»é™¤éš¾åº¦ |
|----------|------|----------|--------|----------|
| å¤šé‡ç­–ç•¥é€‰æ‹© | 6ä¸ª | ~180è¡Œ | é«˜ | é«˜ |
| å¼‚å¸¸æ•è·é™çº§ | 8ä¸ª | ~120è¡Œ | ä¸­ | ä¸­ |
| é‡å¤å¤„ç†é™çº§ | 4ä¸ª | ~80è¡Œ | ä¸­ | ä¸­ |
| å…¨å±€å˜é‡æ£€æŸ¥ | 10ä¸ª | ~150è¡Œ | é«˜ | é«˜ |

**æ€»è®¡**: 28ä¸ªé™çº§é€»è¾‘ç‚¹ï¼Œçº¦530è¡Œä»£ç 

## 3. åŠŸèƒ½é‡å¤å’Œå†—ä½™åˆ†æ

### 3.1 é¢„è§ˆçº¿åˆ›å»ºåŠŸèƒ½é‡å¤

#### é‡å¤å®ç°æ¸…å•
1. **usePreviewLine.js** - `createPreviewLineInternal`
2. **UnifiedEdgeManager.js** - `createPreviewLine`
3. **PreviewLineSystem.js** - `createPreviewLine`
4. **TaskFlowCanvasRefactored.vue** - å†…è”é¢„è§ˆçº¿åˆ›å»ºé€»è¾‘

#### åŠŸèƒ½é‡å åˆ†æ
```javascript
// usePreviewLine.js ä¸­çš„å®ç°
const createPreviewLineInternal = async (sourceNodeId, options = {}) => {
  // åˆ›å»ºé¢„è§ˆçº¿é€»è¾‘
  const previewLineData = {
    id: generateId(),
    type: 'preview',
    source: sourceNodeId,
    branchId: options.branchId,
    // ...
  }
}

// UnifiedEdgeManager.js ä¸­çš„å®ç°
async createPreviewLine(sourceNodeId, options = {}) {
  const previewData = {
    type: EdgeTypes.PREVIEW,
    source: { nodeId: sourceNodeId, port: options.sourcePort || 'out' },
    target: null,
    state: PreviewStates.INTERACTIVE,
    // ...
  }
}
```

**é‡å¤åº¦è¯„ä¼°**: é«˜ - 4ä¸ªä¸åŒçš„é¢„è§ˆçº¿åˆ›å»ºå®ç°
**æ¥å£ä¸ä¸€è‡´**: å‚æ•°æ ¼å¼å’Œè¿”å›å€¼æ ¼å¼ä¸ç»Ÿä¸€
**å»ºè®®ä¿ç•™**: PreviewLineSystem.createPreviewLine ä½œä¸ºå”¯ä¸€å®ç°

### 3.2 é¢„è§ˆçº¿éªŒè¯åŠŸèƒ½é‡å¤

#### é‡å¤å®ç°æ¸…å•
1. **usePreviewLine.js** - `validatePreviewLines`
2. **UnifiedEdgeManager.js** - å†…ç½®éªŒè¯é€»è¾‘
3. **PreviewLineSystem.js** - `validateAndCleanupDuplicates`
4. **TaskFlowCanvasRefactored.vue** - `checkPreviewLineValidity`

#### åŠŸèƒ½é‡å åˆ†æ
```javascript
// usePreviewLine.js ä¸­çš„éªŒè¯
const validatePreviewLines = withPerformanceMonitoring(async () => {
  const allEdges = graph.getEdges()
  const previewEdges = allEdges.filter(edge => isPreviewLine(edge))
  
  for (const edge of previewEdges) {
    const validation = validatePreviewLineData(edge)
    if (!validation.isValid) {
      // æ¸…ç†æ— æ•ˆé¢„è§ˆçº¿
    }
  }
}, 'éªŒè¯é¢„è§ˆçº¿')

// UnifiedEdgeManager.js ä¸­çš„éªŒè¯
validatePreviewLine(previewData) {
  if (!previewData.source?.nodeId) {
    return { isValid: false, errors: ['ç¼ºå°‘æºèŠ‚ç‚¹'] }
  }
  // æ›´å¤šéªŒè¯é€»è¾‘...
}
```

**é‡å¤åº¦è¯„ä¼°**: é«˜ - 4ä¸ªä¸åŒçš„éªŒè¯å®ç°
**éªŒè¯æ ‡å‡†ä¸ä¸€è‡´**: ä¸åŒå®ç°ä½¿ç”¨ä¸åŒçš„éªŒè¯è§„åˆ™
**å»ºè®®ä¿ç•™**: PreviewLineSystem.validateAndCleanupDuplicates ä½œä¸ºå”¯ä¸€å®ç°

### 3.3 é¢„è§ˆçº¿åˆ é™¤åŠŸèƒ½é‡å¤

#### é‡å¤å®ç°æ¸…å•
1. **usePreviewLine.js** - `removePreviewLineInternal`
2. **UnifiedEdgeManager.js** - `removePreviewLine` å’Œ `removePreviewLines`
3. **PreviewLineSystem.js** - `removePreviewLine`

#### åŠŸèƒ½é‡å åˆ†æ
- å•ä¸ªé¢„è§ˆçº¿åˆ é™¤: 3ä¸ªä¸åŒå®ç°
- æ‰¹é‡é¢„è§ˆçº¿åˆ é™¤: 2ä¸ªä¸åŒå®ç°
- æ¡ä»¶åˆ é™¤: 3ä¸ªä¸åŒå®ç°

**é‡å¤åº¦è¯„ä¼°**: é«˜ - åˆ é™¤åŠŸèƒ½åœ¨å¤šä¸ªåœ°æ–¹é‡å¤å®ç°
**å»ºè®®ä¿ç•™**: PreviewLineSystem ä¸­çš„åˆ é™¤æ–¹æ³•ä½œä¸ºå”¯ä¸€å®ç°

### 3.4 é¢„è§ˆçº¿æŸ¥è¯¢åŠŸèƒ½é‡å¤

#### é‡å¤å®ç°æ¸…å•
1. **usePreviewLine.js** - `getPreviewLineByNode`, `getPreviewLinesByNode`
2. **UnifiedEdgeManager.js** - `hasPreviewLine`, `hasExistingPreviewLine`
3. **PreviewLineSystem.js** - æŸ¥è¯¢ç›¸å…³æ–¹æ³•

#### åŠŸèƒ½é‡å åˆ†æ
```javascript
// usePreviewLine.js
const getPreviewLinesByNode = (nodeId) => {
  return Array.from(previewLines.values()).filter(preview => 
    preview.source === nodeId || preview.target === nodeId
  )
}

// UnifiedEdgeManager.js
hasPreviewLine(sourceNodeId, branchId = null) {
  return Array.from(this.previewLines.values()).some(preview => {
    const matchesSource = preview.source.nodeId === sourceNodeId
    const matchesBranch = branchId !== null ? 
      preview.branch?.id === branchId : true
    return matchesSource && matchesBranch
  })
}
```

**é‡å¤åº¦è¯„ä¼°**: ä¸­ - æŸ¥è¯¢é€»è¾‘éƒ¨åˆ†é‡å¤ï¼Œä½†æ¥å£ä¸åŒ
**å»ºè®®ä¿ç•™**: ç»Ÿä¸€åˆ° PreviewLineService ä¸­

## 4. ä»£ç è´¨é‡è¯„ä¼°

### 4.1 å¤æ‚åº¦åˆ†æ

#### æ–‡ä»¶å¤æ‚åº¦ç»Ÿè®¡
| æ–‡ä»¶å | è¡Œæ•° | å‡½æ•°æ•°é‡ | åœˆå¤æ‚åº¦ | è¯„çº§ |
|--------|------|----------|----------|------|
| usePreviewLine.js | 1,720 | 45+ | é«˜ | æé«˜ |
| UnifiedEdgeManager.js | 1,400+ | 35+ | é«˜ | æé«˜ |
| PreviewLineSystem.js | 800+ | 25+ | ä¸­ | é«˜ |

#### å…³é”®å‡½æ•°å¤æ‚åº¦
| å‡½æ•°å | è¡Œæ•° | åœˆå¤æ‚åº¦ | è¯„çº§ |
|--------|------|----------|------|
| createPreviewLineInternal | 80+ | 12+ | é«˜ |
| validatePreviewLines | 100+ | 15+ | æé«˜ |
| convertPreviewToConnection | 90+ | 10+ | é«˜ |
| triggerPreviewLineCleanup | 60+ | 8+ | ä¸­ |

### 4.2 å¯ç»´æŠ¤æ€§è¯„ä¼°

#### ä»£ç ç»„ç»‡
- **æ¨¡å—åŒ–ç¨‹åº¦**: å·® - åŠŸèƒ½åˆ†æ•£åœ¨å¤šä¸ªæ–‡ä»¶ä¸­
- **æ¥å£ä¸€è‡´æ€§**: å·® - ç›¸åŒåŠŸèƒ½çš„æ¥å£ä¸ç»Ÿä¸€
- **ä¾èµ–ç®¡ç†**: å·® - å¤§é‡ä½¿ç”¨å…¨å±€å˜é‡

#### é”™è¯¯å¤„ç†
- **é”™è¯¯å¤„ç†ç­–ç•¥**: ä¸ä¸€è‡´ - æœ‰äº›æŠ›å‡ºå¼‚å¸¸ï¼Œæœ‰äº›è¿”å›é”™è¯¯å¯¹è±¡
- **é”™è¯¯ä¿¡æ¯**: ä¸€èˆ¬ - éƒ¨åˆ†é”™è¯¯ä¿¡æ¯ä¸å¤Ÿè¯¦ç»†
- **é”™è¯¯æ¢å¤**: å·® - ç¼ºä¹æœ‰æ•ˆçš„é”™è¯¯æ¢å¤æœºåˆ¶

#### æ€§èƒ½è€ƒè™‘
- **ç¼“å­˜æœºåˆ¶**: å­˜åœ¨ä½†ä¸ç»Ÿä¸€
- **æ‰¹å¤„ç†**: éƒ¨åˆ†å®ç°
- **å†…å­˜ç®¡ç†**: ä¸€èˆ¬ - å­˜åœ¨å†…å­˜æ³„æ¼é£é™©

### 4.3 æµ‹è¯•è¦†ç›–æƒ…å†µ

#### å•å…ƒæµ‹è¯•
- **æµ‹è¯•è¦†ç›–ç‡**: ä¼°è®¡ < 40%
- **æµ‹è¯•è´¨é‡**: ä¸­ - ä¸»è¦æµ‹è¯•åŸºç¡€åŠŸèƒ½
- **è¾¹ç•Œæƒ…å†µæµ‹è¯•**: ä¸è¶³

#### é›†æˆæµ‹è¯•
- **ç»„ä»¶é›†æˆæµ‹è¯•**: éƒ¨åˆ†å­˜åœ¨
- **ç³»ç»Ÿé›†æˆæµ‹è¯•**: ç¼ºå¤±
- **æ€§èƒ½æµ‹è¯•**: ç¼ºå¤±

## 5. æ¶æ„é—®é¢˜åˆ†æ

### 5.1 èŒè´£è¾¹ç•Œä¸æ¸…

#### é—®é¢˜æè¿°
é¢„è§ˆçº¿ç›¸å…³åŠŸèƒ½åˆ†æ•£åœ¨å¤šä¸ªæ–‡ä»¶ä¸­ï¼ŒèŒè´£è¾¹ç•Œæ¨¡ç³Šï¼š
- usePreviewLine.js: ç»„åˆå¼API + ä¸šåŠ¡é€»è¾‘
- UnifiedEdgeManager.js: è¾¹ç®¡ç† + é¢„è§ˆçº¿ç®¡ç†
- PreviewLineSystem.js: æ–°ç‰ˆé¢„è§ˆçº¿ç³»ç»Ÿ
- å„ç§å·¥å…·ç±»: è¾…åŠ©åŠŸèƒ½

#### å½±å“è¯„ä¼°
- **ç»´æŠ¤å›°éš¾**: ä¿®æ”¹åŠŸèƒ½éœ€è¦åŒæ—¶ä¿®æ”¹å¤šä¸ªæ–‡ä»¶
- **æµ‹è¯•å›°éš¾**: éš¾ä»¥è¿›è¡Œå•å…ƒæµ‹è¯•
- **åŠŸèƒ½å†²çª**: ä¸åŒå®ç°å¯èƒ½äº§ç”Ÿå†²çª

### 5.2 ä¾èµ–å…³ç³»æ··ä¹±

#### å¾ªç¯ä¾èµ–é—®é¢˜
```javascript
// usePreviewLine.js ä¾èµ– PreviewLineSystem
import { PreviewLineSystem } from '../../../../../utils/preview-line/PreviewLineSystem.js'

// PreviewLineSystem å¯èƒ½ä¾èµ– usePreviewLine çš„æŸäº›åŠŸèƒ½
// å½¢æˆæ½œåœ¨çš„å¾ªç¯ä¾èµ–
```

#### å…¨å±€çŠ¶æ€ä¾èµ–
- å¤§é‡ä½¿ç”¨ `window.previewLineSystem`
- ç»„ä»¶é—´é€šè¿‡å…¨å±€å˜é‡é€šä¿¡
- ç¼ºä¹æ˜ç¡®çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

### 5.3 æ¥å£ä¸ä¸€è‡´

#### é—®é¢˜è¡¨ç°
```javascript
// usePreviewLine.js æ¥å£
createPreviewLine(sourceNodeId, options)

// UnifiedEdgeManager.js æ¥å£
createPreviewLine(sourceNodeId, options = {})

// PreviewLineSystem.js æ¥å£
createPreviewLine(sourceId, targetId, options)
```

#### å½±å“è¯„ä¼°
- **ä½¿ç”¨å›°éš¾**: å¼€å‘è€…éœ€è¦è®°ä½ä¸åŒçš„æ¥å£
- **é‡æ„å›°éš¾**: æ¥å£ä¸ä¸€è‡´å¯¼è‡´é‡æ„å¤æ‚
- **é”™è¯¯é£é™©**: æ¥å£æ··ç”¨å¯èƒ½å¯¼è‡´è¿è¡Œæ—¶é”™è¯¯

## 6. é‡æ„å»ºè®®

### 6.1 ç»Ÿä¸€é¢„è§ˆçº¿æœåŠ¡è®¾è®¡

#### æ ¸å¿ƒæœåŠ¡æ¶æ„
```javascript
// PreviewLineService - å”¯ä¸€çš„é¢„è§ˆçº¿æœåŠ¡
export class PreviewLineService {
  constructor(graphService, stateService, eventService) {
    this.graphService = graphService
    this.stateService = stateService
    this.eventService = eventService
    this.previewLines = new Map()
  }
  
  // ç»Ÿä¸€çš„é¢„è§ˆçº¿åˆ›å»ºæ¥å£
  async createPreviewLine(sourceNodeId, options = {}) {
    // é¢„æ£€æŸ¥
    this.validateCreateParams(sourceNodeId, options)
    
    // åˆ›å»ºé¢„è§ˆçº¿
    const previewLine = this.buildPreviewLine(sourceNodeId, options)
    
    // æ·»åŠ åˆ°å›¾å½¢
    await this.addToGraph(previewLine)
    
    // æ›´æ–°çŠ¶æ€
    this.updateState(previewLine)
    
    // å‘å¸ƒäº‹ä»¶
    this.eventService.emit('previewLine:created', previewLine)
    
    return previewLine
  }
  
  // ç»Ÿä¸€çš„é¢„è§ˆçº¿éªŒè¯æ¥å£
  async validatePreviewLines() {
    const results = []
    
    for (const [id, previewLine] of this.previewLines) {
      const validation = this.validateSinglePreviewLine(previewLine)
      if (!validation.isValid) {
        await this.removePreviewLine(id)
        results.push({ id, action: 'removed', errors: validation.errors })
      }
    }
    
    return results
  }
}
```

#### ä¾èµ–æ³¨å…¥é…ç½®
```javascript
// æœåŠ¡å®¹å™¨é…ç½®
const container = new DIContainer()
container.register('graphService', GraphService)
container.register('stateService', StateService)
container.register('eventService', EventService)
container.register('previewLineService', PreviewLineService, [
  'graphService', 
  'stateService', 
  'eventService'
])
```

### 6.2 é™çº§é€»è¾‘æ¶ˆé™¤ç­–ç•¥

#### é˜¶æ®µä¸€: ä¾èµ–æ³¨å…¥æ›¿ä»£å…¨å±€å˜é‡
```javascript
// æ”¹è¿›å‰
if (window.previewLineSystem) {
  await window.previewLineSystem.validateAndCleanupDuplicates()
} else if (window.previewLineManager) {
  await window.previewLineManager.validateAndCleanupDuplicates()
} else {
  await validatePreviewLines()
}

// æ”¹è¿›å
export default {
  setup() {
    const previewLineService = inject('previewLineService')
    
    const validatePreviewLines = async () => {
      return await previewLineService.validatePreviewLines()
    }
    
    return { validatePreviewLines }
  }
}
```

#### é˜¶æ®µäºŒ: é¢„æ£€æŸ¥æ›¿ä»£å¼‚å¸¸æ•è·
```javascript
// æ”¹è¿›å‰
try {
  const sourceNode = graph.getCellById(sourceNodeId)
  if (!sourceNode) {
    return { restored: 0, errors: ['æºèŠ‚ç‚¹ä¸å­˜åœ¨'] }
  }
  // æ¢å¤é€»è¾‘...
} catch (error) {
  return { restored: 0, errors: [error.message] }
}

// æ”¹è¿›å
class PreviewLineService {
  async restorePreviewLine(sourceNodeId) {
    // é¢„æ£€æŸ¥
    const validation = this.validateRestoreParams(sourceNodeId)
    if (!validation.isValid) {
      throw new PreviewLineError('Invalid restore parameters', validation.errors)
    }
    
    // æ‰§è¡Œæ¢å¤
    return await this.performRestore(sourceNodeId)
  }
  
  validateRestoreParams(sourceNodeId) {
    const errors = []
    
    if (!sourceNodeId) {
      errors.push('æºèŠ‚ç‚¹IDä¸èƒ½ä¸ºç©º')
    }
    
    const sourceNode = this.graphService.getNode(sourceNodeId)
    if (!sourceNode) {
      errors.push('æºèŠ‚ç‚¹ä¸å­˜åœ¨')
    }
    
    return {
      isValid: errors.length === 0,
      errors
    }
  }
}
```

#### é˜¶æ®µä¸‰: ç»Ÿä¸€é”™è¯¯å¤„ç†
```javascript
// é¢„è§ˆçº¿ä¸“ç”¨é”™è¯¯ç±»
export class PreviewLineError extends Error {
  constructor(message, details = {}) {
    super(message)
    this.name = 'PreviewLineError'
    this.details = details
  }
}

// ç»Ÿä¸€é”™è¯¯å¤„ç†å™¨
export class PreviewLineErrorHandler {
  handle(error, context) {
    if (error instanceof PreviewLineError) {
      this.handlePreviewLineError(error, context)
    } else {
      this.handleGenericError(error, context)
    }
  }
  
  handlePreviewLineError(error, context) {
    console.error(`é¢„è§ˆçº¿é”™è¯¯: ${error.message}`, error.details)
    
    // é€šçŸ¥ç”¨æˆ·
    this.notifyUser(error.message)
    
    // è®°å½•é”™è¯¯
    this.logError(error, context)
  }
}
```

### 6.3 æ¥å£ç»Ÿä¸€åŒ–è®¾è®¡

#### ç»Ÿä¸€çš„é¢„è§ˆçº¿æ¥å£
```typescript
// é¢„è§ˆçº¿æœåŠ¡æ¥å£å®šä¹‰
interface IPreviewLineService {
  // åˆ›å»ºé¢„è§ˆçº¿
  createPreviewLine(sourceNodeId: string, options?: PreviewLineOptions): Promise<PreviewLine>
  
  // æ›´æ–°é¢„è§ˆçº¿
  updatePreviewLine(id: string, updates: Partial<PreviewLine>): Promise<PreviewLine>
  
  // åˆ é™¤é¢„è§ˆçº¿
  removePreviewLine(id: string): Promise<boolean>
  
  // æ‰¹é‡åˆ é™¤
  removePreviewLines(filter: PreviewLineFilter): Promise<number>
  
  // æŸ¥è¯¢é¢„è§ˆçº¿
  getPreviewLine(id: string): PreviewLine | null
  getPreviewLinesByNode(nodeId: string): PreviewLine[]
  
  // éªŒè¯é¢„è§ˆçº¿
  validatePreviewLines(): Promise<ValidationResult[]>
  
  // è½¬æ¢ä¸ºè¿æ¥çº¿
  convertToConnection(id: string, targetNodeId: string): Promise<Connection>
}

// ç»Ÿä¸€çš„æ•°æ®æ¨¡å‹
interface PreviewLine {
  id: string
  sourceNodeId: string
  targetNodeId?: string
  branchId?: string
  branchLabel?: string
  state: PreviewLineState
  style: PreviewLineStyle
  metadata: PreviewLineMetadata
}
```

## 7. å®æ–½è®¡åˆ’

### 7.1 ç¬¬ä¸€é˜¶æ®µ: æ¥å£ç»Ÿä¸€å’ŒæœåŠ¡åˆ›å»º (1-2å‘¨)

#### ä»»åŠ¡æ¸…å•
- [ ] è®¾è®¡ç»Ÿä¸€çš„é¢„è§ˆçº¿æœåŠ¡æ¥å£
- [ ] åˆ›å»º PreviewLineService æ ¸å¿ƒç±»
- [ ] å®ç°ä¾èµ–æ³¨å…¥å®¹å™¨
- [ ] è¿ç§»æ ¸å¿ƒé¢„è§ˆçº¿åŠŸèƒ½

#### è¾“å‡ºç‰©
- PreviewLineService å®ç°
- ç»Ÿä¸€çš„æ¥å£å®šä¹‰
- ä¾èµ–æ³¨å…¥é…ç½®
- åŸºç¡€åŠŸèƒ½è¿ç§»

### 7.2 ç¬¬äºŒé˜¶æ®µ: é™çº§é€»è¾‘ç§»é™¤ (1-2å‘¨)

#### ä»»åŠ¡æ¸…å•
- [ ] ç§»é™¤æ‰€æœ‰å…¨å±€å˜é‡æ£€æŸ¥
- [ ] æ›¿æ¢å¤šé‡ç­–ç•¥é€‰æ‹©ä¸ºå•ä¸€å®ç°
- [ ] æ”¹è¿›é”™è¯¯å¤„ç†æœºåˆ¶
- [ ] ç»Ÿä¸€éªŒè¯å’Œæ¸…ç†é€»è¾‘

#### è¾“å‡ºç‰©
- æ¸…ç†åçš„ä»£ç 
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- æ”¹è¿›çš„éªŒè¯æœºåˆ¶
- é™çº§é€»è¾‘ç§»é™¤æŠ¥å‘Š

### 7.3 ç¬¬ä¸‰é˜¶æ®µ: åŠŸèƒ½æ•´åˆå’Œä¼˜åŒ– (1å‘¨)

#### ä»»åŠ¡æ¸…å•
- [ ] æ•´åˆé‡å¤çš„åŠŸèƒ½å®ç°
- [ ] ä¼˜åŒ–æ€§èƒ½å’Œå†…å­˜ä½¿ç”¨
- [ ] å®Œå–„æµ‹è¯•è¦†ç›–
- [ ] æ›´æ–°æ–‡æ¡£å’Œç±»å‹å®šä¹‰

#### è¾“å‡ºç‰©
- æ•´åˆåçš„åŠŸèƒ½å®ç°
- æ€§èƒ½ä¼˜åŒ–æŠ¥å‘Š
- å®Œæ•´çš„æµ‹è¯•å¥—ä»¶
- æ›´æ–°çš„æŠ€æœ¯æ–‡æ¡£

### 7.4 ç¬¬å››é˜¶æ®µ: é›†æˆæµ‹è¯•å’ŒéªŒè¯ (1å‘¨)

#### ä»»åŠ¡æ¸…å•
- [ ] è¿›è¡Œå…¨é¢çš„é›†æˆæµ‹è¯•
- [ ] éªŒè¯åŠŸèƒ½å®Œæ•´æ€§
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] ç”¨æˆ·éªŒæ”¶æµ‹è¯•

#### è¾“å‡ºç‰©
- é›†æˆæµ‹è¯•æŠ¥å‘Š
- åŠŸèƒ½éªŒè¯æŠ¥å‘Š
- æ€§èƒ½æµ‹è¯•ç»“æœ
- ç”¨æˆ·éªŒæ”¶ç»“æœ

## 8. é£é™©è¯„ä¼°å’Œç¼“è§£æªæ–½

### 8.1 ä¸»è¦é£é™©

#### åŠŸèƒ½å›å½’é£é™©
- **é£é™©æè¿°**: é‡æ„å¯èƒ½å¯¼è‡´æŸäº›é¢„è§ˆçº¿åŠŸèƒ½å¤±æ•ˆ
- **å½±å“ç¨‹åº¦**: é«˜
- **å‘ç”Ÿæ¦‚ç‡**: ä¸­
- **ç¼“è§£æªæ–½**: å»ºç«‹å®Œæ•´çš„å›å½’æµ‹è¯•å¥—ä»¶

#### æ€§èƒ½å½±å“é£é™©
- **é£é™©æè¿°**: ç»Ÿä¸€æœåŠ¡å¯èƒ½å½±å“é¢„è§ˆçº¿æ“ä½œæ€§èƒ½
- **å½±å“ç¨‹åº¦**: ä¸­
- **å‘ç”Ÿæ¦‚ç‡**: ä½
- **ç¼“è§£æªæ–½**: è¿›è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•å’Œä¼˜åŒ–

#### é›†æˆå¤æ‚æ€§é£é™©
- **é£é™©æè¿°**: ä¸å…¶ä»–æ¨¡å—çš„é›†æˆå¯èƒ½å‡ºç°é—®é¢˜
- **å½±å“ç¨‹åº¦**: é«˜
- **å‘ç”Ÿæ¦‚ç‡**: ä¸­
- **ç¼“è§£æªæ–½**: åˆ†é˜¶æ®µé›†æˆï¼Œæ¯ä¸ªé˜¶æ®µéƒ½è¿›è¡Œå……åˆ†æµ‹è¯•

### 8.2 ç¼“è§£æªæ–½

#### æ¸è¿›å¼é‡æ„
- ä¿ç•™æ—§å®ç°ä½œä¸ºå¤‡ä»½
- ä½¿ç”¨åŠŸèƒ½å¼€å…³æ§åˆ¶æ–°æ—§å®ç°
- åˆ†æ¨¡å—é€æ­¥è¿ç§»

#### å…¨é¢æµ‹è¯•è¦†ç›–
- å»ºç«‹å•å…ƒæµ‹è¯•å¥—ä»¶
- è¿›è¡Œé›†æˆæµ‹è¯•
- å»ºç«‹æ€§èƒ½ç›‘æ§

#### ç›‘æ§å’Œå›æ»š
- å»ºç«‹å®æ—¶ç›‘æ§ç³»ç»Ÿ
- å‡†å¤‡å¿«é€Ÿå›æ»šæœºåˆ¶
- åˆ¶å®šåº”æ€¥å“åº”æµç¨‹

## 9. é¢„æœŸæ”¶ç›Š

### 9.1 çŸ­æœŸæ”¶ç›Š (1-2ä¸ªæœˆ)
- **ä»£ç å¤æ‚åº¦é™ä½**: 60%+
- **ç»´æŠ¤æ•ˆç‡æå‡**: 40%+
- **Bugä¿®å¤é€Ÿåº¦æå‡**: 50%+

### 9.2 é•¿æœŸæ”¶ç›Š (6ä¸ªæœˆ)
- **æ–°åŠŸèƒ½å¼€å‘æ•ˆç‡æå‡**: 70%+
- **ç³»ç»Ÿç¨³å®šæ€§æå‡**: 80%+
- **æµ‹è¯•è¦†ç›–ç‡æå‡**: 90%+

### 9.3 æŠ€æœ¯å€ºåŠ¡å‡å°‘
- **é™çº§é€»è¾‘**: å®Œå…¨æ¶ˆé™¤
- **åŠŸèƒ½é‡å¤**: å‡å°‘95%+
- **æ¥å£ä¸ä¸€è‡´**: å®Œå…¨è§£å†³

## 10. ç»“è®º

é¢„è§ˆçº¿ç³»ç»Ÿå½“å‰å­˜åœ¨ä¸¥é‡çš„æ¶æ„é—®é¢˜ï¼š

1. **æ™ºèƒ½é™çº§é€»è¾‘è¿‡å¤š**: 28ä¸ªé™çº§é€»è¾‘ç‚¹ï¼Œçº¦530è¡Œä»£ç 
2. **åŠŸèƒ½é‡å¤ä¸¥é‡**: é¢„è§ˆçº¿åˆ›å»ºã€éªŒè¯ã€åˆ é™¤éƒ½æœ‰å¤šé‡å®ç°
3. **æ¥å£ä¸ä¸€è‡´**: ç›¸åŒåŠŸèƒ½çš„æ¥å£å‚æ•°å’Œè¿”å›å€¼ä¸ç»Ÿä¸€
4. **ä¾èµ–å…³ç³»æ··ä¹±**: å¤§é‡ä½¿ç”¨å…¨å±€å˜é‡ï¼Œç¼ºä¹æ˜ç¡®çš„ä¾èµ–ç®¡ç†

**å»ºè®®ç«‹å³å¯åŠ¨é‡æ„è®¡åˆ’**ï¼Œé‡‡ç”¨ç»Ÿä¸€çš„ PreviewLineService æ¶æ„ï¼Œæ¶ˆé™¤æ‰€æœ‰æ™ºèƒ½é™çº§é€»è¾‘ï¼Œå»ºç«‹æ¸…æ™°çš„æœåŠ¡è¾¹ç•Œã€‚é‡æ„å·¥ä½œé¢„è®¡éœ€è¦ 4-6 å‘¨æ—¶é—´ï¼Œä½†å°†æ˜¾è‘—æå‡ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§ã€å¯æµ‹è¯•æ€§å’Œç¨³å®šæ€§ã€‚

é‡æ„çš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š**å»ºç«‹å”¯ä¸€ã€å¯é ã€å¯é¢„æµ‹çš„é¢„è§ˆçº¿ç®¡ç†æœåŠ¡**ï¼Œå½»åº•æ¶ˆé™¤æ™ºèƒ½é™çº§å…œåº•é€»è¾‘ï¼Œå®ç°"ä¸€ä¸ªåŠŸèƒ½ä¸€ä¸ªå®ç°"çš„æ¶æ„åŸåˆ™ã€‚