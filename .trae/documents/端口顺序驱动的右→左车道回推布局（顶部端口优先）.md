## 目标补充

* 分支节点的子分支按“端口顺序”排布：顶部端口对应的分支车道在上方，其次从上到下依次排列。

* 保持既有约束：不改变连线（`router: 'normal'` + `connector: 'smooth'`），不写 `edge.vertices`，布局后统一清理控制点。

## 关键策略

* 端口顺序来源

  * 从分支节点的 `ports.items` 中提取 `group === 'out'` 的端口；

  * 端口排序规则：

    1. 优先按端口的 `position`（`top > right/left > bottom`，顶部优先）；
    2. 再按端口的几何纵坐标（如可取到 `port.getBBox().y` 或通过节点 `getBBox()` + 已知偏移）；
    3. 最后按端口 id 的数字序（`out-0 < out-1 < ...`）作为兜底。

* 子分支映射

  * 从分支节点到子节点的边读取 `sourcePortId`（`edge.getSourcePortId()`）；

  * 将每条边映射到其端口的排序位置，生成稳定的“子分支顺序”。

* 车道种子

  * 右端（叶子层）车道仍按 `laneOrder`（可选 `idNumeric/portOrder/typePriority`）锁定；

  * 左端（首层分支头）建立“端口顺序驱动”的车道种子：按上述子分支顺序为首层分支头的每个出边分配独立车道，并禁止后续覆写。

* 右→左回推

  * 自右层向左层逐列回推车道，父节点取“子车道多数”；若父为种子头，则直接继承端口顺序车道（不覆写）。

## 实施步骤

1. 新增工具函数

* `getBranchPortOrder(node)`：返回分支节点的 `out` 端口按“顶部优先+纵坐标+id数字序”的有序数组 `[portId]`。

* `getChildrenByPortOrder(node, edges)`：

  * 找出以该节点为 `source.cell` 的所有边；

  * 用 `edge.getSourcePortId()` 得到端口；

  * 按 `getBranchPortOrder(node)` 将子节点 id 排成稳定顺序。

1. 双向车道种子

* 右端种子：叶子层按 `laneOrder` 锁定；

* 左端种子：对第一层分支头，调用 `getChildrenByPortOrder` 获取子分支顺序，依序分配 `laneId=0..N-1`；记录 `seedHeads = Set(headIds)` 及 `seedLaneOfChild`，回推时遇到这些节点不覆写。

1. 右→左车道回推

* 从最大 `rank` 向左迭代：

  * 普通节点：多数子车道；

  * 种子头或其直接子：保持端口顺序的车道映射（顶端端口对应的分支在上方）。

1. 坐标计算

* 动态间距：

  * 计算节点最大宽高 `maxW/maxH`：

    * `colSpacing = Math.max(280, maxW + 40)`，`laneGapY = Math.max(240, maxH + 20)`；

* 坐标：

  * `x = startX + rank * colSpacing`；

  * `y = startY + laneId * laneGapY`；同层同车道用 `rowOffset(±16)` 轻微位移去重。

1. 应用与清理

* 批量 `node.position(x, y)`；遍历 `edges` `setVertices([])`；连线保持平滑。

## 代码改动点

* `src/pages/marketing/tasks/horizontal/utils/quickLayout.js`

  * 新增：`getBranchPortOrder(node)` / `getChildrenByPortOrder(node, edges)`

  * 在 `executeRightToLeftLaneLayout` 中：

    * 计算 `rankOf` 与 `sinks`；

    * 建立右端车道种子；

    * 识别“首层分支头”，按端口顺序建立左端车道种子，记录 `seedHeads` 与 `seedLaneOfChild`；

    * 右→左合并回推时优先遵循种子映射；

    * 动态计算 `colSpacing/laneGapY`；应用坐标与清理控制点。

* `index.vue` 快速布局入口：

  * 调用 `executeRightToLeftLaneLayout(graph, { startX: 80, startY: 120, colSpacing: 280, laneGapY: 240, rowOffset: 16, laneOrder: 'portOrder' })`

## 参数

* `laneOrder`: `portOrder`（默认）| `idNumeric` | `typePriority`

* `startX/startY`, `colSpacing`, `laneGapY`, `rowOffset`

## 验证

* 分支节点的“顶部端口”对应的子分支居上，其他端口按“上→下”顺序依次排列；

* 同一分支跨层保持同一水平线，不交叉；

* 横向各层整齐对齐；连线平滑且无控制点。

