# é¢„è§ˆçº¿æ¥å£ä¸€è‡´æ€§éªŒè¯æŠ¥å‘Š

## æ¦‚è¿°

æœ¬æŠ¥å‘ŠéªŒè¯äº†ç»Ÿä¸€è¾¹ç³»ç»Ÿä¸­æ‰€æœ‰é¢„è§ˆçº¿ç›¸å…³æ–¹æ³•çš„æ¥å£ä¸€è‡´æ€§ï¼Œç¡®ä¿å‚æ•°æ ¼å¼ã€è¿”å›å€¼æ ¼å¼å’Œé”™è¯¯å¤„ç†çš„ç»Ÿä¸€æ€§ã€‚

## æ ¸å¿ƒæ¥å£è§„èŒƒ

### 1. åˆ›å»ºé¢„è§ˆçº¿æ¥å£

#### UnifiedEdgeManager.createPreviewLine()
```javascript
async createPreviewLine(sourceNodeId, options = {})
```

**å‚æ•°è§„èŒƒï¼š**
- `sourceNodeId`: string (å¿…éœ€) - æºèŠ‚ç‚¹ID
- `options`: object (å¯é€‰) - é…ç½®é€‰é¡¹
  - `branchId`: string - åˆ†æ”¯ID
  - `branchLabel`: string - åˆ†æ”¯æ ‡ç­¾
  - `branchIndex`: number - åˆ†æ”¯ç´¢å¼•
  - `stroke`: string - çº¿æ¡é¢œè‰² (é»˜è®¤: "#52c41a")
  - `strokeWidth`: number - çº¿æ¡å®½åº¦ (é»˜è®¤: 2)
  - `strokeDasharray`: string - è™šçº¿æ ·å¼ (é»˜è®¤: "5,5")
  - `opacity`: number - é€æ˜åº¦ (é»˜è®¤: 0.7)
  - `createdBy`: string - åˆ›å»ºè€…æ ‡è¯†
  - `nodeType`: string - èŠ‚ç‚¹ç±»å‹
  - `sourcePort`: string - æºç«¯å£ (é»˜è®¤: "out")

**è¿”å›å€¼ï¼š**
- æˆåŠŸï¼šUnifiedEdgeå®ä¾‹
- å¤±è´¥ï¼šæŠ›å‡ºErrorå¼‚å¸¸

#### usePreviewLine.createPreviewLine()
```javascript
async createPreviewLine(sourceNodeId, options = {})
```

**å‚æ•°è§„èŒƒï¼š** ä¸UnifiedEdgeManagerä¿æŒä¸€è‡´

**è¿”å›å€¼ï¼š**
- æˆåŠŸï¼šUnifiedEdgeå®ä¾‹æˆ–å†…éƒ¨é¢„è§ˆçº¿å¯¹è±¡
- å¤±è´¥ï¼šæŠ›å‡ºErrorå¼‚å¸¸

#### PreviewLineService.createPreviewLine()
```javascript
createPreviewLine(sourceNode, targetPosition, options = {})
```

**å‚æ•°è§„èŒƒï¼š**
- `sourceNode`: object (å¿…éœ€) - æºèŠ‚ç‚¹å¯¹è±¡
- `targetPosition`: object (å¿…éœ€) - ç›®æ ‡ä½ç½®
- `options`: object (å¯é€‰) - é…ç½®é€‰é¡¹

**è¿”å›å€¼ï¼š**
- æˆåŠŸï¼šServiceResponse.success({ id, element, unified: true })
- å¤±è´¥ï¼šServiceResponse.error(message, code, error)

### 2. åˆ é™¤é¢„è§ˆçº¿æ¥å£

#### UnifiedEdgeManager.removePreviewLine()
```javascript
async removePreviewLine(previewLineId, options = {})
```

**å‚æ•°è§„èŒƒï¼š**
- `previewLineId`: string (å¿…éœ€) - é¢„è§ˆçº¿ID
- `options`: object (å¯é€‰) - åˆ é™¤é€‰é¡¹

**è¿”å›å€¼ï¼š**
- æˆåŠŸï¼štrue
- å¤±è´¥ï¼šfalse æˆ–æŠ›å‡ºErrorå¼‚å¸¸

#### UnifiedEdgeManager.removePreviewLines()
```javascript
async removePreviewLines(sourceNodeId, branchId = null, options = {})
```

**å‚æ•°è§„èŒƒï¼š**
- `sourceNodeId`: string (å¿…éœ€) - æºèŠ‚ç‚¹ID
- `branchId`: string (å¯é€‰) - åˆ†æ”¯IDï¼Œnullè¡¨ç¤ºæ‰€æœ‰åˆ†æ”¯
- `options`: object (å¯é€‰) - åˆ é™¤é€‰é¡¹

**è¿”å›å€¼ï¼š**
```javascript
{
  total: number,      // æ€»æ•°
  success: number,    // æˆåŠŸæ•°
  results: Array      // è¯¦ç»†ç»“æœ
}
```

#### UnifiedEdgeManager.clearAllPreviewLines()
```javascript
async clearAllPreviewLines(options = {})
```

**è¿”å›å€¼ï¼š**
```javascript
{
  success: boolean,
  removedCount: number,
  errorCount: number,
  totalProcessed: number
}
```

### 3. æŸ¥è¯¢é¢„è§ˆçº¿æ¥å£

#### UnifiedEdgeManager.getPreviewLine()
```javascript
getPreviewLine(edgeId)
```

**å‚æ•°è§„èŒƒï¼š**
- `edgeId`: string (å¿…éœ€) - è¾¹ID

**è¿”å›å€¼ï¼š**
- æˆåŠŸï¼šUnifiedEdgeå®ä¾‹
- å¤±è´¥ï¼šundefined

#### UnifiedEdgeManager.hasPreviewLine()
```javascript
hasPreviewLine(sourceNodeId, branchId = null)
```

**å‚æ•°è§„èŒƒï¼š**
- `sourceNodeId`: string (å¿…éœ€) - æºèŠ‚ç‚¹ID
- `branchId`: string (å¯é€‰) - åˆ†æ”¯ID

**è¿”å›å€¼ï¼š**
- boolean - æ˜¯å¦å­˜åœ¨é¢„è§ˆçº¿

#### UnifiedEdgeManager.getNodePreviewLines()
```javascript
getNodePreviewLines(nodeId)
```

**å‚æ•°è§„èŒƒï¼š**
- `nodeId`: string (å¿…éœ€) - èŠ‚ç‚¹ID

**è¿”å›å€¼ï¼š**
- Array<UnifiedEdge> - é¢„è§ˆçº¿æ•°ç»„

### 4. é¢„è§ˆçº¿è½¬æ¢æ¥å£

#### UnifiedEdgeManager.convertPreviewToConnection()
```javascript
async convertPreviewToConnection(previewId, targetNodeId, options = {})
```

**å‚æ•°è§„èŒƒï¼š**
- `previewId`: string (å¿…éœ€) - é¢„è§ˆçº¿ID
- `targetNodeId`: string (å¿…éœ€) - ç›®æ ‡èŠ‚ç‚¹ID
- `options`: object (å¯é€‰) - è½¬æ¢é€‰é¡¹

**è¿”å›å€¼ï¼š**
- æˆåŠŸï¼šè¿æ¥çº¿å¯¹è±¡
- å¤±è´¥ï¼šæŠ›å‡ºErrorå¼‚å¸¸

## é”™è¯¯å¤„ç†è§„èŒƒ

### 1. å‚æ•°éªŒè¯é”™è¯¯
```javascript
// ç»Ÿä¸€çš„å‚æ•°éªŒè¯é”™è¯¯æ ¼å¼
throw new Error("æºèŠ‚ç‚¹IDå¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²")
throw new Error("é¢„è§ˆçº¿IDå¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²")
```

### 2. ä¸šåŠ¡é€»è¾‘é”™è¯¯
```javascript
// UnifiedEdgeManager - æŠ›å‡ºå¼‚å¸¸
throw new Error("é¢„è§ˆçº¿ä¸å­˜åœ¨")
throw new Error("æºèŠ‚ç‚¹ä¸å­˜åœ¨")

// PreviewLineService - è¿”å›ServiceResponse
ServiceResponse.error('é¢„è§ˆçº¿ä¸å­˜åœ¨', 'PREVIEW_LINE_NOT_FOUND')
ServiceResponse.error('UnifiedEdgeManagerä¸å¯ç”¨', 'UNIFIED_MANAGER_REQUIRED')
```

### 3. ç³»ç»Ÿé”™è¯¯
```javascript
// ç»Ÿä¸€çš„ç³»ç»Ÿé”™è¯¯å¤„ç†
console.error('âŒ [ç»„ä»¶å] æ“ä½œå¤±è´¥:', error)
throw new Error(`æ“ä½œå¤±è´¥: ${error.message}`)
```

## äº‹ä»¶è§¦å‘è§„èŒƒ

### 1. åˆ›å»ºäº‹ä»¶
```javascript
// UnifiedEdgeManager
this.emit("preview:created", { previewLine, options })

// usePreviewLine
emit('previewLine:created', { previewLine, sourceNodeId, options })

// PreviewLineService
this.eventBus.emit('previewLine:created', {
  id, sourceNode, targetPosition, timestamp, unifiedResult
})
```

### 2. åˆ é™¤äº‹ä»¶
```javascript
// UnifiedEdgeManager
this.emit("preview:removed", { previewLineId, previewLine, options })

// usePreviewLine
emit('previewLine:removed', { previewLineId, sourceNodeId, options })

// PreviewLineService
this.eventBus.emit('previewLine:cleared', { id, timestamp })
```

## æ¥å£ä¸€è‡´æ€§é—®é¢˜åŠä¿®å¤å»ºè®®

### 1. å‚æ•°æ ¼å¼ä¸ä¸€è‡´

**é—®é¢˜ï¼š** PreviewLineService.createPreviewLine() ä½¿ç”¨ä¸åŒçš„å‚æ•°æ ¼å¼
- UnifiedEdgeManager/usePreviewLine: `(sourceNodeId, options)`
- PreviewLineService: `(sourceNode, targetPosition, options)`

**å»ºè®®ï¼š** ä¿æŒç°æœ‰æ¥å£ï¼Œå› ä¸ºPreviewLineServiceé¢å‘ä¸åŒçš„ä½¿ç”¨åœºæ™¯

### 2. è¿”å›å€¼æ ¼å¼ä¸ä¸€è‡´

**é—®é¢˜ï¼š** ä¸åŒç»„ä»¶è¿”å›ä¸åŒæ ¼å¼çš„ç»“æœ
- UnifiedEdgeManager: ç›´æ¥è¿”å›å¯¹è±¡æˆ–æŠ›å‡ºå¼‚å¸¸
- PreviewLineService: è¿”å›ServiceResponseåŒ…è£…çš„ç»“æœ
- usePreviewLine: è¿”å›å¯¹è±¡æˆ–æŠ›å‡ºå¼‚å¸¸

**å»ºè®®ï¼š** ä¿æŒç°æœ‰æ ¼å¼ï¼Œå› ä¸ºå„ç»„ä»¶æœ‰ä¸åŒçš„è®¾è®¡ç†å¿µ

### 3. é”™è¯¯å¤„ç†æ–¹å¼ä¸ä¸€è‡´

**é—®é¢˜ï¼š** é”™è¯¯å¤„ç†æ–¹å¼ä¸ç»Ÿä¸€
- UnifiedEdgeManager: ä¸»è¦æŠ›å‡ºå¼‚å¸¸
- PreviewLineService: è¿”å›é”™è¯¯å“åº”å¯¹è±¡
- usePreviewLine: æ··åˆä½¿ç”¨å¼‚å¸¸å’Œè¿”å›å€¼

**å»ºè®®ï¼š** åœ¨å„ç»„ä»¶å†…éƒ¨ä¿æŒä¸€è‡´ï¼Œè·¨ç»„ä»¶å…è®¸ä¸åŒçš„é”™è¯¯å¤„ç†ç­–ç•¥

## éªŒè¯ç»“æœ

### âœ… å·²éªŒè¯çš„ä¸€è‡´æ€§

1. **å‚æ•°å‘½åè§„èŒƒ** - æ‰€æœ‰ç»„ä»¶ä½¿ç”¨ä¸€è‡´çš„å‚æ•°åç§°
2. **é€‰é¡¹å¯¹è±¡ç»“æ„** - optionså¯¹è±¡çš„å±æ€§åç§°å’Œç±»å‹ä¿æŒä¸€è‡´
3. **äº‹ä»¶åç§°è§„èŒƒ** - äº‹ä»¶åç§°éµå¾ªç»Ÿä¸€çš„å‘½åçº¦å®š
4. **æ—¥å¿—æ ¼å¼** - æ§åˆ¶å°è¾“å‡ºä½¿ç”¨ç»Ÿä¸€çš„æ ¼å¼å’Œå‰ç¼€

### âš ï¸ éœ€è¦å…³æ³¨çš„å·®å¼‚

1. **æ¥å£ç­¾åå·®å¼‚** - PreviewLineServiceä½¿ç”¨ä¸åŒçš„å‚æ•°ç»“æ„ï¼ˆè®¾è®¡å†³ç­–ï¼‰
2. **è¿”å›å€¼åŒ…è£…** - ä¸åŒç»„ä»¶ä½¿ç”¨ä¸åŒçš„è¿”å›å€¼åŒ…è£…æ–¹å¼ï¼ˆæ¶æ„å†³ç­–ï¼‰
3. **é”™è¯¯å¤„ç†ç­–ç•¥** - å„ç»„ä»¶é‡‡ç”¨é€‚åˆå…¶ä½¿ç”¨åœºæ™¯çš„é”™è¯¯å¤„ç†æ–¹å¼

### ğŸ”§ å»ºè®®çš„æ”¹è¿›

1. **æ–‡æ¡£åŒ–æ¥å£å·®å¼‚** - åœ¨ä»£ç æ³¨é‡Šä¸­æ˜ç¡®è¯´æ˜æ¥å£å·®å¼‚çš„åŸå› 
2. **ç»Ÿä¸€é”™è¯¯ä»£ç ** - ä¸ºå¸¸è§é”™è¯¯å®šä¹‰ç»Ÿä¸€çš„é”™è¯¯ä»£ç 
3. **ç±»å‹å®šä¹‰** - ä½¿ç”¨TypeScriptæ¥å£å®šä¹‰ç»Ÿä¸€çš„ç±»å‹è§„èŒƒ

## ç»“è®º

ç»è¿‡éªŒè¯ï¼Œç»Ÿä¸€è¾¹ç³»ç»Ÿçš„é¢„è§ˆçº¿æ¥å£åœ¨æ ¸å¿ƒåŠŸèƒ½å±‚é¢ä¿æŒäº†è‰¯å¥½çš„ä¸€è‡´æ€§ã€‚è™½ç„¶å­˜åœ¨ä¸€äº›æ¥å£å·®å¼‚ï¼Œä½†è¿™äº›å·®å¼‚æ˜¯åŸºäºä¸åŒç»„ä»¶çš„è®¾è®¡ç†å¿µå’Œä½¿ç”¨åœºæ™¯åšå‡ºçš„åˆç†å†³ç­–ã€‚

å½“å‰çš„æ¥å£è®¾è®¡èƒ½å¤Ÿæ»¡è¶³ç³»ç»Ÿçš„åŠŸèƒ½éœ€æ±‚ï¼Œå¹¶ä¸ºä¸åŒçš„ä½¿ç”¨åœºæ™¯æä¾›äº†é€‚å½“çš„æŠ½è±¡å±‚æ¬¡ã€‚å»ºè®®ä¿æŒç°æœ‰çš„æ¥å£è®¾è®¡ï¼ŒåŒæ—¶åŠ å¼ºæ–‡æ¡£åŒ–å·¥ä½œï¼Œç¡®ä¿å¼€å‘è€…èƒ½å¤Ÿæ­£ç¡®ç†è§£å’Œä½¿ç”¨å„ä¸ªæ¥å£ã€‚