# 统一事件系统重构总结报告

本文档为营销画布统一事件系统（UnifiedEventBus/CanvasEventBus/CanvasEventSystem）的重构评估与落地方案，涵盖现状梳理、目标与范围、事件命名规范与映射策略、兼容层与治理机制、自动化测试体系、风险与回滚、里程碑与度量，以及实施建议。目标是在不引入回归的前提下完成事件系统的统一，并为后续功能迭代提供稳定的基础设施。

## 一、背景与目标
- 当前代码存在多套事件系统并存（预览线自有 EventManager、UnifiedEventBus、CanvasEventBus/CanvasEventSystem），导致事件命名、数据载荷、订阅/触发 API 不一致。
- 目标是在统一事件总线下实现标准化事件类型（CanvasEventTypes）、强校验（EventTypeValidator）、可观测性（统计与日志）、以及面向未来的扩展能力。
- 保持向后兼容：通过兼容层（适配器/桥接）让旧事件名与旧 API 在迁移期间继续可用，渐进替换，降低回归风险。

## 二、现状梳理（关键模块与使用情况）
- 统一事件常量：`src/core/CanvasEventTypes.ts` 定义标准事件与分类（CANVAS、NODE、CONNECTION、DATA、ERROR 等）。
- 事件校验：`src/core/EventTypeValidator.ts` 提供事件类型和数据负载的预检查与规则管理。
- 总线实现：`src/core/CanvasEventBus.ts`（基于 UnifiedEventBus）暴露 `on/once/off/emit/emitAsync`，强制使用 `canvas:` 命名空间。
- 预览线模块：`src/utils/preview-line/*` 存在自建 `EventManager` 与 `StateManager`、`StateSynchronizer`，发射旧事件名（如 `state:*`、`sync:*`、`broadcast:*`）。
- 页面集成：`TaskFlowCanvasRefactored.vue`、`useCanvasLifecycle.js` 等对统一总线进行监听与清理，混合使用旧/新事件。

当前迁移进展（已完成）：
- `StateManager.js`：替换内部事件管理为统一总线适配层，新增事件映射与兼容接口，关键事件映射到 `CanvasEventTypes`（如 `state:changed`→`canvas:state-changed`、`state:sync`→`canvas:state-updated`、`state:reset`→`history:cleared`）。
- `StateSynchronizer.js`：移除内部 `EventManager` 依赖，接入 `CanvasEventSystem.eventBus`，实现旧事件→标准事件映射（如 `sync:completed`→`canvas:state-updated`、`broadcast:received`→`data:import-completed`、`sync:timeout`→`error:network-timeout`、`conflict:resolved`→`error:operation-conflict-resolved`）。
- `preview-line/events/EventManager.js`：增加统一总线转发与事件名称映射，兼容旧 API 并统一输出到标准事件体系。
- 测试：新增并通过 `state-synchronizer-event-mapping.test.js`、`state-manager-event-mapping.test.js`；原有 `state-synchronizer-event-mapping.test.js` 用例均已通过。

## 三、重构范围与阶段性目标
- 范围：预览线系统（StateManager、StateSynchronizer、EventManager、PreviewLineSystem）、页面生命周期钩子、管理器与验证器、核心总线集成层。
- 阶段目标：
  1) 打通事件通路：所有旧事件通过兼容层成功路由到统一总线；测试均通过。
  2) 渐进替换：逐模块将发射点和监听点改用标准事件常量与 `CanvasEventSystem.eventBus`。
  3) 清理与下线：当旧事件使用量趋近 0，移除兼容层并更新文档与变更日志。

## 四、事件命名规范与映射策略
- 统一规范：事件采用 `category:event-name` 格式，关键画布事件强制 `canvas:` 前缀；用 `CanvasEventTypes` 作为唯一来源，避免字符串硬编码。
- 典型映射（旧 → 新）：
  - `state:changed` → `canvas:state-changed`
  - `state:sync` → `canvas:state-updated`
  - `state:reset` → `history:cleared`
  - `connection:registered` → `connection:added`
  - `connection:unregistered` → `connection:removed`
  - `sync:completed` → `canvas:state-updated`
  - `sync:error` → `error:occurred`
  - `sync:timeout` → `error:network-timeout`
  - `broadcast:received` → `data:import-completed`
  - `conflict:resolved` → `error:operation-conflict-resolved`
- 校验与约束：发射前调用 `EventTypeValidator` 进行类型与数据校验；超出载荷大小、缺失必填字段、类型不匹配视为失败或警告（严格模式可配置）。

## 五、兼容层策略与治理机制
- 适配接口：提供与旧 `EventManager` 一致的 `on/once/off/emit` API，内部统一转发到 `CanvasEventSystem.eventBus`，并进行事件名映射。
- 监控与告警：兼容层统计旧事件使用量、触发频次、警告（例如非标准事件名、无效负载），为治理与下线提供数据支持。
- 下线准则：
  - 代码检索与测试确认：仓库内不再出现旧事件名或旧 API 调用；
  - 运行期观测为零：旧事件使用量为 0，持续至少一个发布周期；
  - 测试稳定：核心与回归测试在标准事件下全部通过；
  - 文档与版本：迁移说明、变更日志与版本升级到位。

## 六、自动化测试体系（Vitest）
- 测试分层：
  - 单元测试：事件映射与适配层接口（`on/once/off`）行为；数据校验规则（EventTypeValidator）；兼容层日志与统计。
  - 集成测试：模块内事件流（StateManager、StateSynchronizer、EventManager、PreviewLineSystem）与统一总线的交互；竞争与冲突检测；异常处理路径。
  - 端到端（按需）：关键用户操作触发的事件链路（节点创建、连接、撤销/重做、预览线拖拽）是否按标准事件发射并被正确消费。
- 命名与目录：
  - `src/tests/preview-line/state/state-manager-event-mapping.test.js`
  - `src/tests/preview-line/state/state-synchronizer-event-mapping.test.js`
  - 后续：`src/tests/preview-line/events/event-manager-bridge.test.js`、`src/tests/core/event-type-validator-rules.test.ts`
- 覆盖重点：
  - 旧事件名触发 → 统一总线收到标准事件；
  - 直接通过总线发射标准事件 → 旧订阅能接收（兼容层）；
  - 超时、错误、冲突等边界路径；
  - 数据负载必填字段与类型校验；
  - 取消订阅、一次性订阅的正确性。
- 质量门槛：
  - 关键路径覆盖率 ≥ 85%；
  - 每次发射的事件类型均通过校验；
  - 基准性能测试（事件处理耗时）不劣化。

## 七、风险与回滚
- 风险：
  - 一次性替换触发大范围回归；旧特性（通配符/优先级/命名空间）行为改变；数据载荷不兼容导致处理失败。
- 缓解：
  - 兼容层先行、渐进迁移；测试前置与分层；灰度发布与监控；启用详细日志。
- 回滚策略：
  - 保留旧 EventManager 与映射配置开关；出现异常时快速切回旧通路；
  - 维持旧测试用例与新用例并行，便于定位差异。

## 八、里程碑与度量
- 里程碑：
  1) 完成兼容层与核心映射上线，关键测试通过；
  2) 逐模块替换监听与发射，事件校验规则落地；
  3) 兼容层使用量清零，完成下线与文档更新。
- 度量：
  - 事件类型覆盖度；旧事件使用量趋势；校验失败/警告计数；性能指标（事件处理耗时、队列长度）。

## 九、实施建议（操作指南）
- 代码实践：
  - 统一从 `CanvasEventTypes` 引用事件常量；拒绝直接字符串常量；
  - 发射前调用校验器；对失败进行降级或中止；
  - 兼容层内打日志与统计，便于治理。
- 迁移顺序：
  1) 保持兼容层可用，保障旧事件通路稳定；
  2) 以模块为单位替换发射/监听，先核心（StateManager/StateSynchronizer/PreviewLineSystem），再外围（页面、工具类、插件）；
  3) 每次替换配套新增测试用例与文档更新；
  4) 完成后进行一轮性能与回归测试。
- 文档与变更管理：
  - 更新《统一事件系统API文档》《统一事件管理重构方案》《canvas-migration-plan.md》与测试文档；
  - 在发布说明中明确事件重命名与兼容策略；
  - 标注旧事件与 API 的废弃时间线。

## 十、兼容层移除标准（验收）
- 仓库内无旧事件与旧 API 引用；
- 线上监控显示旧事件使用量为 0，至少 1 个版本周期；
- 自动化测试与性能基线均稳定；
- 文档与变更日志完整，并完成版本号提升。

---

结论：通过兼容层与统一事件命名规范、严格校验和完善的自动化测试体系，可以以低风险方式完成统一事件系统的重构。建议采用分阶段、可观测、可回滚的渐进式迁移策略，确保在研发期保持稳定，并为后续功能扩展提供坚实基础。