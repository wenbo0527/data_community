## 结论与可行性
- 项目中已引入 `@antv/layout` 并解构 `DagreLayout`（`src/pages/marketing/tasks/composables/canvas/useStructuredLayout.js:8–11`），且页面组件日志明确期望“原生Dagre布局”。
- 未检测到 X6 布局插件使用，现有快速布局为自研。将其替换/并行接入原生 Dagre 完全可行。
- 您希望“不是 Top-Down（TB）”、“而是横向展开”、“每一行（每一层）连线中段对齐成直线”。Dagre 的分层（rank）正好满足横向 LR 层级，节点自动排布为列，边通过路由可实现层间水平段对齐。

## 目标
- 使用原生 Dagre（rankdir: 'LR'）做横向分层，按层（rank）排列节点。
- 不保留持久控制点，连接线整体平滑、层间水平段对齐。
- 与现有工具栏交互保持一致（方向切换、居中适配）。

## 方案设计
### 1) Dagre 参数
- `rankdir: 'LR'`：从左到右分层。
- `nodesep`：节点间横向间距，建议 140–200（结合当前视觉）。
- `ranksep`：层间纵向间距，建议 160–220（防止边挤压）。
- `ranker: 'longest-path'`（默认即可），保证层级稳定性；必要时可测 `network-simplex`。
- 节点尺寸：使用真实 `bbox`（`node.getBBox()`）传给 Dagre，避免端口对齐偏差。

### 2) 接入点与流程
- 在 `useStructuredLayout.js` 新增 `applyDagreLayout(graph, { rankdir: 'LR', nodesep, ranksep })`：
  1. 采集 `graph.getNodes()/getEdges()`，构建 Dagre 输入（id、高宽、边 source/target）。
  2. 执行 `new DagreLayout(options).layout({ nodes, edges })` 获取坐标。
  3. 批量 `node.setPosition(x,y)` 应用坐标；不设置 `edge.vertices`。
  4. 居中/适配：仅居中，不改变缩放（保持当前逻辑）。
- 工具栏“布局方向”切换到 LR 时调用 `applyDagreLayout`；TB 时可继续使用现有（或同样用 Dagre `rankdir: 'TB'`）。

### 3) 连线路由与对齐
- 全局连接配置保持：`connector: 'smooth'`（圆润拐角）。
- 路由：优先 `orth`，并设置方向约束：
  - LR：`startDirections: ['right']`、`endDirections: ['left']`（`useStructuredLayout.js:351–366`已有动态函数原型）。
- 层间水平段对齐：依赖 Dagre 的 rank 坐标，`orth` 路由在两层间自然形成水平段；如需更严格的“同一 y 基线”，可增设自定义路由器（仅运行态返回路径点，不持久化顶点）：
  - `row-align (可选)`：根据源/目标 rank 的 y 值计算公共水平线 y，路由返回 `[sx, sy] → [sx, y] → [tx, y] → [tx, ty]`，由 `smooth` 圆角化拐点；不设置 `edge.vertices`，不会产生控制柄。

### 4) 不生成控制点
- 明确不调用 `edge.setVertices([...])`；所有路径由路由计算得出，页面无持久控制柄。

### 5) 兼容与回退
- 若某些节点无尺寸或端口异常，Dagre 将仍给出坐标；对异常节点做日志与就近落位回退。
- 边路由失败回退到 `router: 'normal'` + `connector: 'smooth'`，保持平滑无控制柄。

## 代码触点（仅列举，不改动）
- 入口：`src/pages/marketing/tasks/horizontal/index.vue:2800`（调用布局）
- 布局 Composable：`src/pages/marketing/tasks/composables/canvas/useStructuredLayout.js`（已引入 Dagre）
- 动态方向配置：`useStructuredLayout.js:351–366`（路由方向约束）

## 验证
- 场景：多分支、多层；
- 检查点：
  - 横向分层稳定（LR），每层对齐；
  - 层间水平段统一（视觉直线）；
  - 无控制柄残留；
  - 快速布局后拖拽添加节点，坐标无偏移（继续使用 `graph.pageToLocal`）。

## 交付
- 新增 `applyDagreLayout` 实现并接入方向切换与快速布局入口；
- 保持现有视觉与交互；
- 提供配置项（nodesep/ranksep）与开关（是否使用 `row-align` 路由）。

确认后我将基于上述方案接入原生 Dagre 布局并完成验证。