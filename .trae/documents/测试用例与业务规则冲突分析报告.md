# 测试用例与业务规则冲突分析报告

## 1. 概述

本报告分析了现有测试用例与用户提供的业务规则之间的冲突，涵盖节点连接规则、预览线管理和统一布局算法三个核心领域。通过详细的代码审查和测试用例分析，识别出多个关键冲突点并提供相应的修复建议。

## 2. 业务规则总结

### 2.1 节点规则

* **开始节点**：有且只有1个分支，和一个out没有in

* **结束节点**：只有in没有out

* **可配置分支节点**：只有人群分流、事件分流和AB实验节点存在可配置的分支

### 2.2 预览线规则

* **创建条件**：所有预览线都需要节点配置完成后生成

* **删除逻辑**：当1条预览线连接到节点后转化成连接线，需要删除对应预览线

* **节点吸附**：拖动节点吸附预览线时，只能自动完成1个最近的预览线吸附

* **拖拽规则**：拖拽预览线endpoint时，终点可以挂载到非开始节点外任意节点的in端口

### 2.3 统一布局算法规则

* **分层逻辑**：节点自顶向下分层，每个节点的层级为其上游节点层级最大值+1

* **坐标规则**：同一层内Y节点一致，不同层间层中心的X保持一致

* **布局策略**：基于叶子节点和父子节点坐标进行统一布局，父子节点内需要居中对齐

## 3. 冲突分析

### 3.1 统一布局算法测试冲突

#### 3.1.1 冲突描述

**文件**：`src/tests/tdd-unified-layout-algorithm.test.js`

**主要冲突**：

1. **水平布局验证逻辑错误**：测试用例中仍在验证X坐标的递增关系，与垂直分层布局要求冲突
2. **层级计算逻辑缺失**：缺少基于上游节点层级最大值+1的层级计算验证
3. **Y坐标一致性验证不足**：同层节点Y坐标一致性验证逻辑不完整

#### 3.1.2 具体问题点

```javascript
// 错误的验证逻辑示例（第200-250行）
expect(startNodeCall[1].x).toBeLessThan(audienceSplitCall[1].x) // 错误：基于X坐标

// 应该改为垂直分层验证
expect(startNodeCall[1].y).toBeLessThan(audienceSplitCall[1].y) // 正确：基于Y坐标
```

#### 3.1.3 影响分析

* **测试有效性**：当前测试无法正确验证垂直分层布局算法

* **开发指导**：错误的测试可能误导开发者实现水平布局逻辑

* **质量保证**：无法确保布局算法符合业务需求

### 3.2 预览线初始化测试冲突

#### 3.2.1 冲突描述

**文件**：`src/tests/tdd-preview-line-initialization.test.js`

**主要冲突**：

1. **完成检查不严格**：存在自动修复逻辑，与"配置完成后生成"规则冲突
2. **isConfigured字段处理**：测试中发现自动修复逻辑会忽略明确的false标记

#### 3.2.2 具体问题点

```javascript
// 问题：自动修复逻辑（第120-140行）
if (data.isConfigured === undefined && hasLayers) {
  node.setData({ ...data, isConfigured: true }) // 自动修复，违反业务规则
  return true
}
```

#### 3.2.3 影响分析

* **业务逻辑违反**：未配置节点可能错误生成预览线

* **用户体验**：用户可能看到不应该存在的预览线

* **数据一致性**：节点配置状态可能被意外修改

### 3.3 节点连接规则测试冲突

#### 3.3.1 冲突描述

**相关文件**：

* `src/tests/start-node-preview-line.test.js`

* `src/tests/audience-split-preview-line-comprehensive.test.js`

**主要冲突**：

1. **开始节点分支限制**：测试未严格验证开始节点只能有1个分支的规则
2. **结束节点连接限制**：缺少结束节点只有in没有out的验证
3. **可配置分支节点范围**：测试覆盖范围可能超出人群分流、事件分流、AB实验三种节点

#### 3.3.2 具体问题点

```javascript
// 缺少的验证逻辑示例
// 应该验证开始节点最大输出连接数为1
expect(startNodeConfig.maxOutputs).toBe(1)

// 应该验证结束节点不能有输出连接
expect(endNodeConfig.maxOutputs).toBe(0)
```

#### 3.3.3 影响分析

* **连接规则违反**：可能允许不符合业务规则的连接

* **流程完整性**：错误的连接可能导致流程逻辑错误

* **用户操作限制**：缺少必要的操作约束

### 3.4 预览线拖拽和吸附测试冲突

#### 3.4.1 冲突描述

**相关文件**：`src/tests/NodeConnectionOptimizer.test.ts`

**主要冲突**：

1. **吸附数量限制**：缺少"只能自动完成1个最近的预览线吸附"的验证
2. **拖拽目标限制**：缺少"终点可以挂载到非开始节点外任意节点的in端口"的验证

#### 3.4.2 影响分析

* **交互行为**：可能允许不符合规则的多重吸附

* **连接限制**：可能允许连接到开始节点的in端口

## 4. 修复建议

### 4.1 统一布局算法测试修复

#### 4.1.1 立即修复项

1. **移除水平布局验证**：将所有基于X坐标递增的验证改为基于Y坐标的垂直分层验证
2. **添加层级计算验证**：实现基于上游节点层级最大值+1的层级计算测试
3. **完善Y坐标一致性验证**：确保同层节点Y坐标一致性检查

#### 4.1.2 测试用例重构

```javascript
// 修复示例
describe('垂直分层布局验证', () => {
  it('应该确保开始节点在最顶层', () => {
    // 验证开始节点Y坐标最小
    expect(startNodeY).toBeLessThan(allOtherNodesY)
  })
  
  it('应该确保同层节点Y坐标一致', () => {
    // 验证同层节点Y坐标差值在容差范围内
    expect(Math.abs(node1Y - node2Y)).toBeLessThan(tolerance)
  })
})
```

### 4.2 预览线初始化测试修复

#### 4.2.1 移除自动修复逻辑

```javascript
// 修复前（错误）
if (data.isConfigured === undefined && hasLayers) {
  node.setData({ ...data, isConfigured: true })
  return true
}

// 修复后（正确）
if (data.isConfigured !== true) {
  return false // 严格检查，不进行自动修复
}
```

#### 4.2.2 严格配置检查

1. **明确配置状态**：只有`isConfigured === true`才允许创建预览线
2. **移除自动修复**：删除所有自动修复逻辑
3. **增强测试覆盖**：添加边界情况测试

### 4.3 节点连接规则测试增强

#### 4.3.1 添加连接限制验证

```javascript
describe('节点连接规则验证', () => {
  it('开始节点应该只允许1个输出连接', () => {
    expect(startNodeConfig.maxOutputs).toBe(1)
    expect(startNodeConfig.maxInputs).toBe(0)
  })
  
  it('结束节点应该只允许输入连接', () => {
    expect(endNodeConfig.maxInputs).toBeGreaterThan(0)
    expect(endNodeConfig.maxOutputs).toBe(0)
  })
  
  it('只有特定节点类型支持可配置分支', () => {
    const branchableTypes = ['audience-split', 'event-split', 'ab-test']
    expect(branchableTypes).toContain(nodeType)
  })
})
```

### 4.4 预览线交互测试增强

#### 4.4.1 添加吸附和拖拽限制

```javascript
describe('预览线交互规则验证', () => {
  it('应该只允许吸附最近的1个预览线', () => {
    // 验证吸附数量限制
    expect(attachedPreviewLines.length).toBeLessThanOrEqual(1)
  })
  
  it('应该禁止连接到开始节点的in端口', () => {
    // 验证拖拽目标限制
    expect(canConnectToStartNodeInput).toBe(false)
  })
})
```

## 5. 实施计划

### 5.1 第一阶段：统一布局算法修复（优先级：高）

* **时间估计**：2-3天

* **主要任务**：

  1. 修复所有水平布局验证逻辑
  2. 实现垂直分层验证
  3. 添加层级计算测试
  4. 完善Y坐标一致性验证

### 5.2 第二阶段：预览线初始化修复（优先级：高）

* **时间估计**：1-2天

* **主要任务**：

  1. 移除自动修复逻辑
  2. 实现严格配置检查
  3. 更新相关测试用例

### 5.3 第三阶段：节点连接规则增强（优先级：中）

* **时间估计**：2-3天

* **主要任务**：

  1. 添加连接限制验证
  2. 实现分支节点类型检查
  3. 完善边界情况测试

### 5.4 第四阶段：预览线交互增强（优先级：中）

* **时间估计**：1-2天

* **主要任务**：

  1. 实现吸附数量限制
  2. 添加拖拽目标验证
  3. 完善交互测试覆盖

## 6. 风险评估

### 6.1 技术风险

* **回归风险**：修复可能影响现有功能

* **测试覆盖**：新增测试可能发现更多问题

* **性能影响**：严格检查可能影响性能

### 6.2 业务风险

* **用户体验**：修复过程中可能暂时影响用户操作

* **功能完整性**：严格规则可能限制某些操作

### 6.3 缓解措施

* **分阶段实施**：按优先级分阶段修复，降低风险

* **充分测试**：每个阶段完成后进行全面测试

* **回滚准备**：准备快速回滚方案

## 7. 成功指标

### 7.1 测试指标

* **测试通过率**：所有修复的测试用例通过率达到100%

* **覆盖率提升**：业务规则覆盖率达到90%以上

* **回归测试**：现有功能测试通过率保持100%

### 7.2 功能指标

* **布局正确性**：垂直分层布局完全符合业务规则

* **预览线行为**：严格按照配置状态生成预览线

* **连接限制**：所有节点连接严格遵循业务规则

### 7.3 质量指标

* **代码质量**：测试代码清晰、可维护

* **文档完整性**：修复过程和结果有完整文档记录

* **知识传递**：团队成员理解新的业务规则和实现

## 8. 总结

通过详细的冲突分析，我们识别出现有测试用例与业务规则之间存在多个关键冲突点。这些冲突主要集中在统一布局算法的验证逻辑、预览线初始化的配置检查、节点连接规则的限制验证等方面。

建议按照优先级分阶段进行修复，首先解决影响核心功能的统一布局算法和预览线初始化问题，然后完善节点连接规则和预览线交互的验证。通过系统性的修复，可以确保测试用例完全符合业务规则，提高代码质量和用户体验。
