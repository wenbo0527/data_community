# 无效预览线清理功能实现文档

## 功能概述

在预览线恢复过程中，系统现在会自动检查并删除无效预览线。无效预览线定义为：**存在源节点但目标节点不存在的预览线**。

## 实现详情

### 1. 新增核心方法

#### `cleanupInvalidPreviewLines()`
- **功能**: 检查并删除画布上的无效预览线
- **返回值**: 清理的无效预览线数量
- **检查逻辑**:
  - 遍历所有预览线实例
  - 验证源节点存在性（源节点不存在的情况由 `cleanupOrphanedPreviewLines` 处理）
  - 检查单一预览线的目标节点是否存在
  - 检查分支预览线的目标节点是否存在
  - 标记并清理无效预览线
  - 为仍需要预览线的源节点重新创建预览线

### 2. 集成到预览线恢复流程

#### 在 `restorePreviewLinesAfterNodeDeletion` 方法中
```javascript
// 🎯 新增：在恢复预览线之前，先检查并清理无效预览线
console.log('🧹 [统一预览线管理器] 节点删除后检查无效预览线')
const cleanedInvalidCount = this.cleanupInvalidPreviewLines()
```

#### 在 `ensureAllBranchesRestored` 方法中
```javascript
// 🎯 新增：在分支恢复前检查无效预览线
if (isAfterNodeDeletion) {
  console.log('🧹 [分支完整性检查] 节点删除后检查无效预览线:', node.id)
  this.cleanupInvalidPreviewLines()
}
```

### 3. 详细日志记录

系统会记录以下日志信息：
- 🧹 开始检查无效预览线
- 🗑️ 发现无效预览线（目标节点不存在）
- 🗑️ 发现无效分支预览线（目标节点不存在）
- 🧹 清理无效预览线
- 🔄 重新创建预览线
- ✅ 清理完成统计

## 工作流程

### 节点删除后的预览线恢复流程

1. **触发**: 节点被删除
2. **调用**: `restorePreviewLinesAfterNodeDeletion`
3. **清理缓存**: 强制刷新连接状态缓存
4. **🆕 检查无效预览线**: 调用 `cleanupInvalidPreviewLines`
5. **恢复预览线**: 为需要的源节点恢复预览线
6. **分支完整性检查**: 调用 `ensureAllBranchesRestored`
7. **🆕 再次检查**: 在分支恢复前再次检查无效预览线

### 无效预览线检查逻辑

```
遍历所有预览线实例
├── 获取源节点
├── 源节点不存在？ → 跳过（由其他方法处理）
├── 检查单一预览线
│   └── 目标节点不存在？ → 标记为无效
├── 检查分支预览线
│   └── 任一分支目标节点不存在？ → 标记为无效
└── 执行清理并重新创建必要的预览线
```

## 解决的问题

1. **目标节点被删除后的残留预览线**: 当下游节点被删除时，指向该节点的预览线会变成无效状态
2. **分支预览线的目标节点失效**: 分支预览线的目标节点被删除后的清理
3. **预览线状态不一致**: 确保预览线状态与实际节点状态保持一致
4. **内存泄漏**: 及时清理无效的预览线实例，避免内存泄漏

## 测试验证

创建了测试文件 `tests/invalid-preview-line-cleanup.test.js` 来验证功能：
- 测试节点删除后的无效预览线清理
- 测试分支完整性检查中的无效预览线处理
- 验证方法调用流程的正确性

## 性能优化

- **按需检查**: 只在节点删除后的恢复过程中执行检查
- **批量处理**: 收集所有无效预览线后批量清理
- **智能重建**: 只为确实需要预览线的节点重新创建
- **详细日志**: 提供完整的操作日志便于调试

## 兼容性

- 与现有的 `cleanupOrphanedPreviewLines` 方法互补
- 不影响正常的预览线创建和管理流程
- 保持向后兼容性

## 总结

通过实现无效预览线清理功能，系统现在能够：
- ✅ 自动检测并清理目标节点不存在的预览线
- ✅ 在预览线恢复过程中确保数据一致性
- ✅ 提供详细的清理日志便于调试
- ✅ 智能重建必要的预览线
- ✅ 提升系统稳定性和可维护性

这个功能特别适用于删除人群分流下游节点时，确保上游分支预览线能够正确恢复显示，同时清理指向已删除节点的无效预览线。