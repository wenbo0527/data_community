# 外数评估模块详细设计

## 页面与路由
- 列表页：`src/pages/exploration/ExternalDataEvaluationList.vue`（/exploration/external-data-evaluation/list）
- 详情页：`src/pages/exploration/ExternalDataEvaluationDetail.vue`（查看/编辑/发布/归档/删除）
- 编辑页：`src/pages/exploration/ExternalDataEvaluationEdit.vue`
- 创建页：`src/pages/exploration/CreateExternalDataEvaluationPage.vue`
- 任务进度：`src/pages/exploration/TaskProgressPage.vue`

## 数据来源与 API
- 评估 API：`src/api/external/evaluation.js`（列表、详情、创建、发布、归档、产品查询）
- Store：`src/store/modules/external-data.ts`（评估列表与详情的缓存与引用）

## 详情页核心函数与行号
- 保存报告：`src/pages/exploration/ExternalDataEvaluationDetail.vue:674–714`
- 发布报告：`src/pages/exploration/ExternalDataEvaluationDetail.vue:717–745`
- 归档报告：`src/pages/exploration/ExternalDataEvaluationDetail.vue:775–808`
- 删除报告：`src/pages/exploration/ExternalDataEvaluationDetail.vue:810–844`
- 挂载加载详情：`src/pages/exploration/ExternalDataEvaluationDetail.vue:846–849`
- 图表渲染与可选图表：`src/pages/exploration/ExternalDataEvaluationDetail.vue:665–672`（数据源选择），以及更早处的渲染逻辑

## 列表页到详情的导航
- 典型跳转：`router.push({ name: 'externalDataEvaluationDetail', params: { id } })`（列表页中定义）
- 档案页传入 `product` 场景：`src/pages/external-data-archive/index.vue:437–439`，可在列表页根据 `query.product` 进行过滤与定位。

## 指标与口径
- 报告基础信息：产品、分析时段、样本量、生成时间（详情页：`src/pages/exploration/ExternalDataEvaluationDetail.vue:747–765`）
- 评分与结论：由各模块内容汇总，发布后进入可见状态。

## 与其他模块的协作
- 与档案的协同：
  - 评估发布/归档后，将标签与评分回写至档案项（需在 Store/API 层补充写回逻辑）。
- 与预算的协同：
  - 评估结论映射预算健康度与预警阈值，推动预算监控与结算流程（监控页/预算页展示）。
- 与服务的协同：
  - 评估结论驱动服务策略（调用参数、目标额度、平台选择），并将服务结果反哺评估数据。

## 错误处理与状态管理
- 保存/发布/归档/删除均使用 `fetch` 与 `Message` 提示（见上述行号）。
- `isEditMode` 控制编辑态，`modifiedModules` 跟踪被修改模块（详情页内）。

## 后续迭代点
- 在评估详情保存/发布/归档后，统一触发事件写回档案与预算域。
- 增加图表类型与指标口径设置面板，支持自定义监控阈值。

## 设计原则与交互规范（基于 Arco Design）
- 列表与筛选：使用 `a-table + a-form` 筛选区，支持搜索、排序、分页；空态 `a-empty`；加载 `a-skeleton`。
- 详情编辑：`a-form` 分节折叠；保存/发布/归档/删除均有 `Popconfirm`/`Message` 与按钮 `loading`；状态变更后禁用相应控件。
- 图表交互：提供图表类型切换、数据区间选择与下载；错误数据提示与重试入口。
- 返回与导航：`a-button` 返回列表，保留筛选条件；从档案页进入时高亮 `product` 过滤。

## 详细事件与状态流（评估域）
- 列表筛选与导航：
  - 事件：`onEvaluationFilterApply(filters)`；`onEvaluationReset`；`onEvaluationGoDetail(id)`。
  - 反馈：应用筛选显示 `loading`；成功 `Message.success('筛选已更新')`；路由跳转失败 `Message.error`。
- 详情保存：
  - 事件：`onEvaluationSave(editData)`；行号：`src/pages/exploration/ExternalDataEvaluationDetail.vue:674–714`；成功 `Message.success('报告保存成功')`；失败 `Message.error`。
  - 校验：`a-form` 规则；错误字段滚动定位与标红。
- 发布：
  - 事件：`onEvaluationPublish`；行号：`717–745`；成功 `Message.success('报告发布成功')` 并锁定编辑区域；失败 `Message.error`。
- 归档与删除：
  - 事件：`onEvaluationArchive/onEvaluationDelete`；行号：`775–808, 810–844`；均用 `Popconfirm`；成功后返回列表并提示。
- 图表：
  - 事件：`onChartTypeChange/onRangeChange`；渲染失败 `Message.error('图表渲染失败')` 并提供重试；导出 `onChartExport` 成功提示。

## 组件映射与状态
- 列表：`a-table`；筛选：`a-form + a-select/a-input/a-date-picker`；详情：`a-card + a-form + a-tabs/a-collapse`；弹窗：`a-modal/a-popconfirm`；按钮：`a-button`。
- 加载/空/错误：`a-spin/a-skeleton/a-empty`；通知：`Message/Notification`。
