# ç”»å¸ƒä¸»æµç¨‹æ ¸å¿ƒåŠŸèƒ½åˆ†ææŠ¥å‘Š

## 1. ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### 1.1 TaskFlowCanvasRefactored æ•´ä½“æ¶æ„

è¥é”€ç”»å¸ƒç³»ç»Ÿé‡‡ç”¨ç»„ä»¶åŒ–ã€æœåŠ¡åŒ–çš„æ¶æ„è®¾è®¡ï¼Œå®ç°äº†é«˜åº¦æ¨¡å—åŒ–å’Œå¯ç»´æŠ¤æ€§ï¼š

#### ğŸ¯ æ ¸å¿ƒç»„ä»¶å±‚æ¬¡ç»“æ„
```mermaid
graph TD
    A[TaskFlowCanvasRefactored.vue] --> B[æœåŠ¡ç®¡ç†å™¨å±‚]
    B --> C[GraphService - å›¾å½¢æ“ä½œæœåŠ¡]
    B --> D[LayoutService - å¸ƒå±€æœåŠ¡]
    B --> E[EventService - äº‹ä»¶æœåŠ¡]
    
    A --> F[çŠ¶æ€ç®¡ç†å±‚]
    F --> G[useCanvasState - ç”»å¸ƒçŠ¶æ€]
    F --> H[useCanvasEvents - äº‹ä»¶å¤„ç†]
    
    A --> I[ç³»ç»Ÿç»„ä»¶å±‚]
    I --> J[UnifiedEdgeManager - ç»Ÿä¸€è¾¹ç®¡ç†]
    I --> K[PreviewLineSystem - é¢„è§ˆçº¿ç³»ç»Ÿ]
    I --> L[PanZoomManager - ç¼©æ”¾ç®¡ç†]
    I --> M[EdgeOverlapManager - è¾¹é‡å ç®¡ç†]
    
    A --> N[UIç»„ä»¶å±‚]
    N --> O[CanvasMinimap - å°åœ°å›¾]
    N --> P[NodeSelector - èŠ‚ç‚¹é€‰æ‹©å™¨]
    N --> Q[ConfigDrawers - é…ç½®æŠ½å±‰]
```

#### ğŸ”§ å…³é”®æ¶æ„ç‰¹æ€§

**æœåŠ¡ç®¡ç†å™¨æ¨¡å¼**:
```javascript
// æœåŠ¡æ³¨å†Œä¸ä¾èµ–ç®¡ç†
canvasServiceManager
  .register('GraphService', GraphServiceAdapter, {
    dependencies: [],
    config: { graph: graph.value }
  })
  .register('LayoutService', LayoutServiceAdapter, {
    dependencies: ['GraphService'],
    config: { graph: graph.value, eventBus: globalEventBus }
  })
```

**å“åº”å¼çŠ¶æ€ç®¡ç†**:
```javascript
// æ ¸å¿ƒçŠ¶æ€å®šä¹‰
const canvasContainer = ref(null)
const isGraphReady = ref(false)
const isInitializing = ref(false)
const nodes = ref([])
const connections = ref([])
```

**äº‹ä»¶é©±åŠ¨æ¶æ„**:
```javascript
// äº‹ä»¶å‘å°„å™¨å®šä¹‰
const emit = defineEmits([
  'canvas-initialized',
  'canvas-reset',
  'node-delete-requested',
  'preview-line-moved',
  'preview-line-clicked'
])
```

### 1.2 åˆå§‹åŒ–æµç¨‹æ¶æ„

#### ä¸²è¡ŒåŒ–åˆå§‹åŒ–è®¾è®¡
```mermaid
sequenceDiagram
    participant DOM as DOMå®¹å™¨
    participant Systems as åŸºç¡€ç³»ç»Ÿ
    participant Graph as X6å›¾å½¢å¼•æ“
    participant Services as æœåŠ¡å±‚
    participant Data as æ•°æ®åŠ è½½
    participant UI as UIæ¸²æŸ“
    
    DOM->>Systems: 1. DOMå‡†å¤‡å®Œæˆ
    Systems->>Graph: 2. åˆå§‹åŒ–åŸºç¡€ç³»ç»Ÿ
    Graph->>Services: 3. åˆ›å»ºGraphå®ä¾‹
    Services->>Data: 4. åˆå§‹åŒ–æœåŠ¡å±‚
    Data->>UI: 5. ç³»ç»ŸéªŒè¯
    UI->>UI: 6. åŠ è½½åˆå§‹æ•°æ®
```

## 2. æ ¸å¿ƒæµç¨‹åˆ†æ

### 2.1 åˆå§‹åŒ–æµç¨‹

#### ğŸš€ å®Œæ•´åˆå§‹åŒ–åºåˆ—ï¼ˆå·²ä¿®å¤é™çº§æœºåˆ¶ï¼‰

**ç¬¬1æ­¥ï¼šDOMå‡†å¤‡**
```javascript
// ç­‰å¾…DOMå®Œå…¨å‡†å¤‡
await nextTick()

// éªŒè¯DOMå®¹å™¨
if (!canvasContainer.value) {
  throw new Error('ç”»å¸ƒå®¹å™¨DOMæœªå‡†å¤‡å°±ç»ª')
}
```

**ç¬¬2æ­¥ï¼šåŸºç¡€ç³»ç»Ÿç»„ä»¶åˆå§‹åŒ–**
```javascript
const initializeSystems = () => {
  try {
    // åˆå§‹åŒ–å…¨å±€äº‹ä»¶æ€»çº¿
    if (!globalEventBus) {
      globalEventBus = new EventBus()
    }
    
    // åˆå§‹åŒ–æœåŠ¡ç®¡ç†å™¨
    if (!canvasServiceManager) {
      canvasServiceManager = new CanvasServiceManager()
    }
    
    console.log('[TaskFlowCanvas] âœ… åŸºç¡€ç³»ç»Ÿç»„ä»¶åˆå§‹åŒ–å®Œæˆ')
  } catch (error) {
    console.error('[TaskFlowCanvas] åŸºç¡€ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error)
    throw error
  }
}
```

**ç¬¬3æ­¥ï¼šGraphå®ä¾‹åˆ›å»º**
```javascript
// åˆ›å»ºX6å›¾å½¢å®ä¾‹
if (!graph.value) {
  graph.value = createGraph(canvasContainer.value, {
    background: { color: '#f8f9fa' },
    grid: { visible: true, size: 20 },
    selecting: { enabled: true, multiple: true },
    connecting: { 
      snap: { radius: 20 },
      allowBlank: false,
      allowLoop: false,
      allowMulti: false
    }
  })
  
  isGraphReady.value = true
}
```

**ç¬¬4æ­¥ï¼šç»Ÿä¸€è¾¹ç®¡ç†ç³»ç»Ÿåˆå§‹åŒ–ï¼ˆå·²ç§»é™¤é™çº§æœºåˆ¶ï¼‰**
```javascript
const initializeGraphDependentSystems = async (graphInstance) => {
  const initSteps = [
    {
      name: 'UnifiedEdgeManager',
      init: async () => {
        if (!unifiedEdgeManager) {
          unifiedEdgeManager = new UnifiedEdgeManager({
            graph: graphInstance,
            enablePreviewLines: true,
            snapThreshold: 20
          })
          await unifiedEdgeManager.initialize()
          
          // UnifiedEdgeManagerå†…éƒ¨ç®¡ç†PreviewLineSystemï¼Œä¸éœ€è¦ç›´æ¥æš´éœ²
          console.log('[TaskFlowCanvas] âœ“ UnifiedEdgeManager å·²åˆå§‹åŒ–ï¼Œå†…éƒ¨ç®¡ç† PreviewLineSystem')
        }
        
        // è®¾ç½®åˆ°å…¨å±€windowå¯¹è±¡
        if (typeof window !== 'undefined') {
          window.unifiedEdgeManager = unifiedEdgeManager
          console.log('[TaskFlowCanvas] âœ“ UnifiedEdgeManager å·²è®¾ç½®åˆ°å…¨å±€ window å¯¹è±¡')
        }
      },
      required: true  // å°†UnifiedEdgeManagerè®¾ä¸ºå¿…éœ€ç»„ä»¶
    }
  ]
  
  // ä¸²è¡Œæ‰§è¡Œåˆå§‹åŒ–æ­¥éª¤
  for (const step of initSteps) {
    try {
      await step.init()
    } catch (error) {
      console.error(`[TaskFlowCanvas] ${step.name} åˆå§‹åŒ–å¤±è´¥:`, error)
      
      if (step.required) {
        throw new Error(`å¿…éœ€ç»„ä»¶ ${step.name} åˆå§‹åŒ–å¤±è´¥: ${error.message}`)
      }
    }
  }
}
```

**ç¬¬5æ­¥ï¼šæœåŠ¡å±‚åˆå§‹åŒ–**
```javascript
// æ³¨å†Œæ ¸å¿ƒæœåŠ¡
canvasServiceManager
  .register('GraphService', GraphServiceAdapter, {
    dependencies: [],
    config: { graph: graph.value }
  })
  .register('LayoutService', LayoutServiceAdapter, {
    dependencies: ['GraphService'],
    config: { graph: graph.value, eventBus: globalEventBus }
  })

// åˆå§‹åŒ–æ‰€æœ‰æœåŠ¡
await canvasServiceManager.initializeAll()
```

**ç¬¬6æ­¥ï¼šæ•°æ®åŠ è½½ä¸éªŒè¯**
```javascript
// ç³»ç»ŸéªŒè¯
const validationResult = await validateCanvasState()
if (!validationResult.isValid) {
  throw new Error(`ç³»ç»ŸéªŒè¯å¤±è´¥: ${validationResult.issues.join(', ')}`)
}

// ä¸²è¡ŒåŠ è½½åˆå§‹æ•°æ®
if (props.initialNodes && props.initialNodes.length > 0) {
  await loadInitialData()
}
```

#### ğŸ”§ åˆå§‹åŒ–é”™è¯¯å¤„ç†æœºåˆ¶

```javascript
try {
  // åˆå§‹åŒ–æµç¨‹
  await initializationPromise
} catch (error) {
  console.error('[TaskFlowCanvas] ç»„ä»¶åˆå§‹åŒ–å¤±è´¥:', error)
  Message.error(`ç”»å¸ƒåˆå§‹åŒ–å¤±è´¥: ${error.message}`)
  
  // å…³é”®ä¿®å¤ï¼šåˆå§‹åŒ–å¤±è´¥æ—¶é‡ç½®çŠ¶æ€
  isGraphReady.value = false
  if (state && state.isInitializing) {
    state.isInitializing.value = false
  }
}
```

### 2.2 æ•°æ®åŠ è½½æµç¨‹

#### ğŸ“¥ loadCanvasData æ ¸å¿ƒå®ç°

```javascript
loadCanvasData: async (data) => {
  const graphService = canvasServiceManager?.get('GraphService')
  if (graphService && graphService.isReady()) {
    return await graphService.loadGraphData(data)
  }
  
  console.error('[TaskFlowCanvas] GraphService ä¸å¯ç”¨æˆ–æœªå°±ç»ª')
  throw new Error('GraphService ä¸å¯ç”¨æˆ–æœªå°±ç»ªï¼Œæ— æ³•åŠ è½½ç”»å¸ƒæ•°æ®')
}
```

#### ğŸ“Š èŠ‚ç‚¹åŠ è½½æœºåˆ¶

```javascript
// æ‰¹é‡æ·»åŠ èŠ‚ç‚¹åˆ°å›¾å½¢
const addNodesToGraph = async (nodeDataList) => {
  const addedNodes = []
  
  for (const nodeData of nodeDataList) {
    try {
      const addedNode = await addNodeToGraph(nodeData)
      if (addedNode) {
        addedNodes.push(addedNode)
        
        // æ›´æ–°çŠ¶æ€
        addNodeToState(nodeData)
        
        // è§¦å‘é¢„è§ˆçº¿åˆ›å»º
        if (shouldCreatePreviewLines(nodeData)) {
          await createNodePreviewLines(nodeData.id)
        }
      }
    } catch (error) {
      console.error(`èŠ‚ç‚¹æ·»åŠ å¤±è´¥: ${nodeData.id}`, error)
    }
  }
  
  return addedNodes
}
```

#### ğŸ”— è¿æ¥åŠ è½½æœºåˆ¶

```javascript
// æ‰¹é‡æ·»åŠ è¿æ¥åˆ°å›¾å½¢
const addConnectionsToGraph = async (connectionDataList) => {
  const addedConnections = []
  
  for (const connectionData of connectionDataList) {
    try {
      const addedConnection = await addConnectionToGraph(connectionData)
      if (addedConnection) {
        addedConnections.push(addedConnection)
        
        // æ›´æ–°çŠ¶æ€
        addConnectionToState(connectionData)
      }
    } catch (error) {
      console.error(`è¿æ¥æ·»åŠ å¤±è´¥: ${connectionData.id}`, error)
    }
  }
  
  return addedConnections
}
```

### 2.3 é¢„è§ˆçº¿è°ƒç”¨åˆè§„æ€§ä¿®å¤ï¼ˆé‡è¦æ›´æ–°ï¼‰

#### ğŸ”§ ä¿®å¤èƒŒæ™¯
åœ¨ç”»å¸ƒä¸»æµç¨‹æ ¸å¿ƒåŠŸèƒ½åˆ†æä¸­å‘ç°äº†é¢„è§ˆçº¿è°ƒç”¨åˆè§„æ€§é—®é¢˜ï¼Œå­˜åœ¨å¤šä¸ªé™çº§æœºåˆ¶å’Œç›´æ¥è°ƒç”¨PreviewLineSystemçš„æƒ…å†µï¼Œè¿åäº†ç»Ÿä¸€æ ¸å¿ƒåŠŸèƒ½è§„èŒƒã€‚

#### âœ… ä¿®å¤å†…å®¹

**1. ç§»é™¤æ‰€æœ‰é™çº§æœºåˆ¶**
```javascript
// ä¿®å¤å‰ï¼šå­˜åœ¨é™çº§é€»è¾‘
if (unifiedEdgeManager && unifiedEdgeManager.createPreviewLine) {
  // ä½¿ç”¨UnifiedEdgeManager
} else {
  // é™çº§åˆ°PreviewLineSystem - å·²ç§»é™¤
  console.log('[TaskFlowCanvas] âš ï¸ UnifiedEdgeManagerä¸å¯ç”¨ï¼Œé™çº§åˆ°PreviewLineSystem')
}

// ä¿®å¤åï¼šå¼ºåˆ¶ä½¿ç”¨UnifiedEdgeManager
if (!unifiedEdgeManager) {
  console.error('[TaskFlowCanvas] âŒ UnifiedEdgeManagerä¸å¯ç”¨ï¼Œæ— æ³•ç”Ÿæˆé¢„è§ˆçº¿')
  throw new Error('UnifiedEdgeManager æœªåˆå§‹åŒ–ï¼Œæ— æ³•ç”Ÿæˆé¢„è§ˆçº¿')
}
```

**2. ç»Ÿä¸€é¢„è§ˆçº¿åˆ›å»ºæ¥å£**
```javascript
// ä¿®å¤åï¼šæ‰€æœ‰é¢„è§ˆçº¿åˆ›å»ºå¿…é¡»é€šè¿‡UnifiedEdgeManager
const createPreviewLine = async (sourceNodeId, targetPosition, options = {}) => {
  if (!unifiedEdgeManager) {
    throw new Error('UnifiedEdgeManager æœªåˆå§‹åŒ–')
  }
  
  try {
    const result = await unifiedEdgeManager.createPreviewLine(sourceNodeId, {
      targetPosition,
      ...options
    })
    
    console.log('[TaskFlowCanvas] âœ… UnifiedEdgeManageré¢„è§ˆçº¿åˆ›å»ºæˆåŠŸ:', result)
    return result
  } catch (error) {
    console.error('[TaskFlowCanvas] âŒ UnifiedEdgeManageré¢„è§ˆçº¿åˆ›å»ºå¤±è´¥:', error)
    throw error
  }
}
```

**3. ç»Ÿä¸€é¢„è§ˆçº¿æ•°æ®è·å–**
```javascript
// ä¿®å¤å‰ï¼šå¤æ‚çš„é™çº§é€»è¾‘
const getPreviewLines = () => {
  const previewManager = canvasRef.value
  if (previewManager && previewManager.getActivePreviewLines) {
    return previewManager.getActivePreviewLines()
  } else if (previewManager && previewManager.previewLines) {
    // å¤æ‚çš„PreviewLineSysteméå†é€»è¾‘ - å·²ç§»é™¤
  }
}

// ä¿®å¤åï¼šç»Ÿä¸€æ¥å£
const getPreviewLines = () => {
  if (!window.unifiedEdgeManager) {
    console.error('[create.vue] âŒ UnifiedEdgeManagerä¸å¯ç”¨')
    throw new Error('UnifiedEdgeManager ä¸å¯ç”¨')
  }
  
  try {
    const previewLines = window.unifiedEdgeManager.getAllPreviewLines()
    console.log('[create.vue] âœ… æˆåŠŸè·å–é¢„è§ˆçº¿æ•°æ®:', previewLines.length)
    return previewLines
  } catch (error) {
    console.error('[create.vue] âŒ è·å–é¢„è§ˆçº¿æ•°æ®å¤±è´¥:', error)
    throw error
  }
}
```

**4. ç»Ÿä¸€é¢„è§ˆçº¿æ¸…ç†æ¥å£**
```javascript
// ä¿®å¤åï¼šç»Ÿä¸€æ¸…ç†æ¥å£
const clearPreviewLines = () => {
  if (!window.unifiedEdgeManager) {
    console.error('[create.vue] âŒ UnifiedEdgeManagerä¸å¯ç”¨')
    throw new Error('UnifiedEdgeManager ä¸å¯ç”¨')
  }
  
  try {
    window.unifiedEdgeManager.clearConnectedPreviewLines()
    console.log('[create.vue] âœ… é¢„è§ˆçº¿æ¸…ç†æˆåŠŸ')
  } catch (error) {
    console.error('[create.vue] âŒ é¢„è§ˆçº¿æ¸…ç†å¤±è´¥:', error)
    throw error
  }
}
```

**5. ç§»é™¤å…¨å±€PreviewLineSystemæš´éœ²**
```javascript
// ä¿®å¤å‰ï¼šæš´éœ²PreviewLineSystemåˆ°å…¨å±€
window.previewLineSystem = previewLineSystem
state.previewLineSystem.value = previewLineSystem

// ä¿®å¤åï¼šåªæš´éœ²UnifiedEdgeManager
window.unifiedEdgeManager = unifiedEdgeManager
// PreviewLineSystemä½œä¸ºUnifiedEdgeManagerçš„å†…éƒ¨ç»„ä»¶ï¼Œä¸ç›´æ¥æš´éœ²
```

#### ğŸ¯ ä¿®å¤æ•ˆæœ
- âœ… å®Œå…¨ç§»é™¤äº†æ‰€æœ‰é™çº§æœºåˆ¶
- âœ… å¼ºåˆ¶æ‰€æœ‰é¢„è§ˆçº¿æ“ä½œé€šè¿‡UnifiedEdgeManager
- âœ… ç»Ÿä¸€äº†é¢„è§ˆçº¿APIè°ƒç”¨æ¥å£
- âœ… æé«˜äº†ç³»ç»Ÿçš„ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§
- âœ… ç¬¦åˆé¢„è§ˆçº¿ç»Ÿä¸€æ ¸å¿ƒåŠŸèƒ½è§„èŒƒ

### 2.4 æ•°æ®ä¿å­˜æµç¨‹

#### ğŸ’¾ getCanvasData æ•°æ®è·å–

```javascript
getCanvasData: () => {
  const graphService = canvasServiceManager?.get('GraphService')
  if (graphService && graphService.isReady()) {
    return graphService.getGraphData()
  }
  return {
    nodes: nodes?.value || [],
    connections: connections?.value || []
  }
}
```

#### ğŸ” ä¿å­˜å‰æ•°æ®æ ¡éªŒ

```javascript
// create.vue ä¸­çš„ä¿å­˜é€»è¾‘
const saveDraft = async () => {
  try {
    isSaving.value = true
    
    // è·å–ç”»å¸ƒæ•°æ®
    const canvasData = canvasRef.value?.getCanvasData()
    
    // åŸºç¡€æ ¡éªŒï¼ˆå¯¹äºä¿å­˜ï¼Œåªåšè½»é‡çº§æ ¡éªŒï¼‰
    const validationResult = validateForSave({
      ...taskForm,
      canvasData
    })
    
    if (!validationResult.isValid) {
      // å¯¹äºä¿å­˜ï¼Œå³ä½¿æœ‰é”™è¯¯ä¹Ÿåªæ˜¾ç¤ºè­¦å‘Šï¼Œä¸é˜»æ­¢ä¿å­˜
      Message.warning(`ä¿å­˜æˆåŠŸï¼Œä½†å­˜åœ¨é—®é¢˜ï¼š${validationResult.errors.join(', ')}`)
    }
    
    const taskData = {
      ...taskForm,
      canvasData,
      status: 'draft',
      updateTime: new Date().toLocaleString('zh-CN'),
      creator: 'å½“å‰ç”¨æˆ·'
    }
    
    // æ¨¡æ‹Ÿä¿å­˜å»¶è¿Ÿ
    await new Promise(resolve => setTimeout(resolve, 1000))
    
    // ä¿å­˜æˆåŠŸ
    taskStatus.value = 'draft'
    hasUnsavedChanges.value = false
    
  } catch (error) {
    Message.error('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•')
  } finally {
    isSaving.value = false
  }
}
```

#### ğŸ“‹ ä¿å­˜æ•°æ®ç»“æ„

```javascript
// æ ‡å‡†ä¿å­˜æ•°æ®æ ¼å¼
const saveDataStructure = {
  // åŸºæœ¬ä¿¡æ¯
  name: taskForm.name,
  type: taskForm.type,
  description: taskForm.description,
  
  // ç”»å¸ƒæ•°æ®
  canvasData: {
    nodes: [
      {
        id: 'node_1',
        type: 'start',
        position: { x: 100, y: 100 },
        data: { nodeType: 'start', config: {} }
      }
    ],
    connections: [
      {
        id: 'connection_1',
        source: { nodeId: 'node_1', port: 'out' },
        target: { nodeId: 'node_2', port: 'in' }
      }
    ]
  },
  
  // å…ƒæ•°æ®
  status: 'draft',
  updateTime: '2024-01-01 12:00:00',
  creator: 'å½“å‰ç”¨æˆ·'
}
```

### 2.4 å‘å¸ƒæµç¨‹

#### ğŸš€ publishTask å®Œæ•´å‘å¸ƒé€»è¾‘

```javascript
const publishTask = async () => {
  if (isPublishing.value) return

  try {
    isPublishing.value = true
    
    // 1. åŸºç¡€å‚æ•°éªŒè¯
    if (!taskForm.name) {
      Message.error('è¯·è¾“å…¥ä»»åŠ¡åç§°')
      return
    }
    if (!taskForm.type) {
      Message.error('è¯·é€‰æ‹©ä»»åŠ¡ç±»å‹')
      return
    }
    
    // 2. è·å–ç”»å¸ƒæ•°æ®
    const canvasData = canvasRef.value?.getCanvasData()
    if (!canvasData) {
      Message.error('æ— æ³•è·å–ç”»å¸ƒæ•°æ®')
      return
    }
    
    // 3. è·å–é¢„è§ˆçº¿ä¿¡æ¯ï¼ˆç”¨äºè‡ªåŠ¨è¡¥å……ç»“æŸèŠ‚ç‚¹ï¼‰
    let previewLines = []
    try {
      const previewManager = canvasRef.value?.previewManager
      
      if (previewManager && previewManager.getActivePreviewLines) {
        previewLines = previewManager.getActivePreviewLines()
      } else if (previewManager && previewManager.previewLines) {
        // å¤„ç†PreviewLineSystemæ ¼å¼
        previewLines = extractPreviewLinesFromSystem(previewManager, canvasData.nodes)
      }
    } catch (error) {
      previewLines = []
    }
    
    // 4. å‘å¸ƒå‰å®Œæ•´æ ¡éªŒ
    const validationResult = validateForPublish({
      ...taskForm,
      canvasData
    }, { autoFix: true, previewLines })
    
    if (!validationResult.isValid) {
      // æ˜¾ç¤ºè¯¦ç»†çš„æ ¡éªŒé”™è¯¯ä¿¡æ¯
      const errorMessage = formatPublishValidationMessage(validationResult)
      
      Modal.error({
        title: 'å‘å¸ƒå¤±è´¥',
        content: errorMessage,
        width: 600,
        okText: 'ç¡®å®š'
      })
      return
    }

    // 5. è‡ªåŠ¨ä¿®å¤ç¡®è®¤
    if (validationResult.autoFixApplied) {
      const confirmMessage = formatPublishValidationMessage(validationResult)
      
      const confirmed = await new Promise((resolve) => {
        Modal.confirm({
          title: 'å‘å¸ƒç¡®è®¤',
          content: confirmMessage + '\n\næ˜¯å¦æ¥å—è‡ªåŠ¨ä¿®å¤å¹¶ç»§ç»­å‘å¸ƒï¼Ÿ',
          width: 600,
          onOk: () => resolve(true),
          onCancel: () => resolve(false)
        })
      })

      if (!confirmed) {
        return
      }

      // åº”ç”¨è‡ªåŠ¨ä¿®å¤çš„æ•°æ®åˆ°ç”»å¸ƒ
      if (validationResult.fixedData && validationResult.fixedData.canvasData) {
        canvasRef.value?.loadCanvasData(validationResult.fixedData.canvasData)
        
        // æ¸…ç†é¢„è§ˆçº¿å¹¶é‡æ–°ç»“æ„åŒ–å¸ƒå±€
        await refreshCanvasAfterAutoFix()
      }
    }

    // 6. æ‰§è¡Œå‘å¸ƒ
    const taskData = {
      ...taskForm,
      canvasData: validationResult.fixedData?.canvasData || canvasData,
      status: 'published',
      publishTime: new Date().toLocaleString('zh-CN'),
      creator: 'å½“å‰ç”¨æˆ·'
    }
    
    // æ¨¡æ‹Ÿå‘å¸ƒå»¶è¿Ÿ
    await new Promise(resolve => setTimeout(resolve, 1500))
    
    // å‘å¸ƒæˆåŠŸ
    taskStatus.value = 'published'
    Message.success('å‘å¸ƒæˆåŠŸ')
    hasUnsavedChanges.value = false
    
  } catch (error) {
    Message.error('å‘å¸ƒå¤±è´¥ï¼Œè¯·é‡è¯•')
  } finally {
    isPublishing.value = false
  }
}
```

#### ğŸ”§ è‡ªåŠ¨ä¿®å¤æœºåˆ¶

```javascript
// é¢„è§ˆçº¿ä¿¡æ¯æå–
const extractPreviewLinesFromSystem = (previewManager, nodes) => {
  const previewLines = []
  
  previewManager.previewLines.forEach((previewInstance, nodeId) => {
    const node = nodes.find(n => n.id === nodeId)
    if (node && previewInstance) {
      if (Array.isArray(previewInstance)) {
        // åˆ†æ”¯é¢„è§ˆçº¿å¤„ç†
        previewInstance.forEach((instance, branchIndex) => {
          if (instance.line) {
            previewLines.push({
              id: instance.line.id || `preview_${nodeId}_${branchIndex}`,
              sourceNodeId: nodeId,
              branchId: instance.branchId,
              branchIndex: branchIndex,
              branchLabel: instance.branchLabel,
              position: instance.endPosition || { 
                x: node.position.x + 200, 
                y: node.position.y + 100 
              }
            })
          }
        })
      } else {
        // å•ä¸€é¢„è§ˆçº¿å¤„ç†
        if (previewInstance.line) {
          previewLines.push({
            id: previewInstance.line.id || `preview_${nodeId}`,
            sourceNodeId: nodeId,
            position: previewInstance.endPosition || { 
              x: node.position.x + 200, 
              y: node.position.y + 100 
            }
          })
        }
      }
    }
  })
  
  return previewLines
}

// è‡ªåŠ¨ä¿®å¤åç”»å¸ƒåˆ·æ–°
const refreshCanvasAfterAutoFix = async () => {
  try {
    const previewManager = canvasRef.value?.previewManager
    
    if (previewManager) {
      // æ¸…ç†å·²è¿æ¥çš„é¢„è§ˆçº¿
      if (previewManager.clearConnectedPreviewLines) {
        previewManager.clearConnectedPreviewLines()
      } else if (previewManager.refreshAllPreviewLines) {
        previewManager.refreshAllPreviewLines()
      }
    }
    
    // è§¦å‘é‡æ–°å¸ƒå±€
    if (canvasRef.value?.triggerLayout) {
      canvasRef.value.triggerLayout()
    }
    
    Message.success('å·²è‡ªåŠ¨è¡¥å……ç»“æŸèŠ‚ç‚¹å¹¶ä¼˜åŒ–å¸ƒå±€')
  } catch (error) {
    console.error('è‡ªåŠ¨ä¿®å¤ååˆ·æ–°å¤±è´¥:', error)
  }
}
```

## 3. å…³é”®æ¥å£è§„èŒƒ

### 3.1 ç”»å¸ƒæ ¸å¿ƒæ¥å£

#### ğŸ¯ defineExpose æš´éœ²æ¥å£

```javascript
defineExpose({
  // æ ¸å¿ƒå›¾å½¢å®ä¾‹
  graph,
  
  // èŠ‚ç‚¹æ“ä½œæ¥å£
  addNode: (nodeTypeOrData, position) => {
    // å…¼å®¹ä¸¤ç§è°ƒç”¨æ–¹å¼
    if (typeof nodeTypeOrData === 'string' && position) {
      return addNode(nodeTypeOrData, position)  // æ‹–æ‹½åˆ›å»ºæ¨¡å¼
    } else if (typeof nodeTypeOrData === 'object') {
      const graphService = canvasServiceManager?.get('GraphService')
      return graphService?.addNode(nodeTypeOrData) || addNodeToGraph(nodeTypeOrData)
    }
  },
  
  // è¿æ¥æ“ä½œæ¥å£
  addConnection: (connectionData) => {
    const graphService = canvasServiceManager?.get('GraphService')
    return graphService?.addConnection(connectionData) || addConnectionToGraph(connectionData)
  },
  
  // æ•°æ®æ“ä½œæ¥å£
  getCanvasData: () => {
    const graphService = canvasServiceManager?.get('GraphService')
    return graphService?.getGraphData() || {
      nodes: nodes?.value || [],
      connections: connections?.value || []
    }
  },
  
  loadCanvasData: async (data) => {
    const graphService = canvasServiceManager?.get('GraphService')
    if (graphService && graphService.isReady()) {
      return await graphService.loadGraphData(data)
    }
    throw new Error('GraphService ä¸å¯ç”¨æˆ–æœªå°±ç»ª')
  },
  
  // ç”»å¸ƒæ“ä½œæ¥å£
  clearCanvas,
  resetCanvas,
  validateCanvasState,
  waitForInitialization
})
```

### 3.2 æœåŠ¡æ¥å£è§„èŒƒ

#### ğŸ”§ GraphService æ¥å£å®šä¹‰

```javascript
interface GraphService {
  // èŠ‚ç‚¹æ“ä½œ
  addNode(nodeData: NodeData): Promise<Node>
  removeNode(nodeId: string): Promise<boolean>
  updateNode(nodeId: string, data: Partial<NodeData>): Promise<Node>
  
  // è¿æ¥æ“ä½œ
  addConnection(connectionData: ConnectionData): Promise<Connection>
  removeConnection(connectionId: string): Promise<boolean>
  
  // æ•°æ®æ“ä½œ
  getGraphData(): CanvasData
  loadGraphData(data: CanvasData): Promise<boolean>
  
  // çŠ¶æ€æŸ¥è¯¢
  isReady(): boolean
}
```

#### ğŸ¨ LayoutService æ¥å£å®šä¹‰

```javascript
interface LayoutService {
  // å¸ƒå±€æ‰§è¡Œ
  executeLayout(layoutType: string, options?: LayoutOptions): Promise<boolean>
  
  // å¸ƒå±€é…ç½®
  setLayoutConfig(config: LayoutConfig): void
  getLayoutConfig(): LayoutConfig
  
  // çŠ¶æ€æŸ¥è¯¢
  isReady(): boolean
}
```

### 3.3 äº‹ä»¶æ¥å£è§„èŒƒ

#### ğŸ“¡ äº‹ä»¶å‘å°„è§„èŒƒ

```javascript
// ç”»å¸ƒäº‹ä»¶å®šä¹‰
const canvasEvents = [
  'canvas-initialized',    // ç”»å¸ƒåˆå§‹åŒ–å®Œæˆ
  'canvas-reset',         // ç”»å¸ƒé‡ç½®
  'node-delete-requested', // èŠ‚ç‚¹åˆ é™¤è¯·æ±‚
  'preview-line-moved',   // é¢„è§ˆçº¿ç§»åŠ¨
  'preview-line-clicked', // é¢„è§ˆçº¿ç‚¹å‡»
  'auto-connection-created' // è‡ªåŠ¨è¿æ¥åˆ›å»º
]

// äº‹ä»¶æ•°æ®æ ¼å¼
interface CanvasEvent {
  type: string
  data: any
  timestamp: number
  source: string
}
```

## 4. æœåŠ¡ç®¡ç†å™¨æ¶æ„

### 4.1 CanvasServiceManager è®¾è®¡

#### ğŸ—ï¸ æœåŠ¡æ³¨å†Œæœºåˆ¶

```javascript
class CanvasServiceManager {
  constructor() {
    this.services = new Map()
    this.dependencies = new Map()
    this.initializationOrder = []
  }
  
  // æœåŠ¡æ³¨å†Œ
  register(name, ServiceClass, options = {}) {
    const serviceConfig = {
      name,
      ServiceClass,
      dependencies: options.dependencies || [],
      config: options.config || {},
      instance: null,
      initialized: false
    }
    
    this.services.set(name, serviceConfig)
    this.dependencies.set(name, options.dependencies || [])
    
    return this // æ”¯æŒé“¾å¼è°ƒç”¨
  }
  
  // æ‰¹é‡åˆå§‹åŒ–
  async initializeAll() {
    // è®¡ç®—åˆå§‹åŒ–é¡ºåºï¼ˆæ‹“æ‰‘æ’åºï¼‰
    this.initializationOrder = this.calculateInitOrder()
    
    // æŒ‰é¡ºåºåˆå§‹åŒ–æœåŠ¡
    for (const serviceName of this.initializationOrder) {
      await this.initializeService(serviceName)
    }
  }
  
  // å•ä¸ªæœåŠ¡åˆå§‹åŒ–
  async initializeService(name) {
    const serviceConfig = this.services.get(name)
    if (!serviceConfig || serviceConfig.initialized) {
      return
    }
    
    // ç¡®ä¿ä¾èµ–æœåŠ¡å·²åˆå§‹åŒ–
    for (const depName of serviceConfig.dependencies) {
      await this.initializeService(depName)
    }
    
    // åˆ›å»ºæœåŠ¡å®ä¾‹
    serviceConfig.instance = new serviceConfig.ServiceClass(serviceConfig.config)
    
    // åˆå§‹åŒ–æœåŠ¡
    if (serviceConfig.instance.initialize) {
      await serviceConfig.instance.initialize()
    }
    
    serviceConfig.initialized = true
  }
}
```

#### ğŸ”„ ä¾èµ–è§£æç®—æ³•

```javascript
// æ‹“æ‰‘æ’åºè®¡ç®—åˆå§‹åŒ–é¡ºåº
calculateInitOrder() {
  const visited = new Set()
  const visiting = new Set()
  const order = []
  
  const visit = (serviceName) => {
    if (visiting.has(serviceName)) {
      throw new Error(`æ£€æµ‹åˆ°å¾ªç¯ä¾èµ–: ${serviceName}`)
    }
    
    if (visited.has(serviceName)) {
      return
    }
    
    visiting.add(serviceName)
    
    const dependencies = this.dependencies.get(serviceName) || []
    for (const dep of dependencies) {
      visit(dep)
    }
    
    visiting.delete(serviceName)
    visited.add(serviceName)
    order.push(serviceName)
  }
  
  for (const serviceName of this.services.keys()) {
    visit(serviceName)
  }
  
  return order
}
```

### 4.2 æœåŠ¡é€‚é…å™¨æ¨¡å¼

#### ğŸ”Œ GraphServiceAdapter å®ç°

```javascript
class GraphServiceAdapter {
  constructor(config) {
    this.graph = config.graph
    this.initialized = false
  }
  
  async initialize() {
    if (!this.graph) {
      throw new Error('Graphå®ä¾‹æœªæä¾›')
    }
    this.initialized = true
  }
  
  isReady() {
    return this.initialized && this.graph
  }
  
  // èŠ‚ç‚¹æ“ä½œé€‚é…
  async addNode(nodeData) {
    if (!this.isReady()) {
      throw new Error('GraphServiceæœªå°±ç»ª')
    }
    
    return this.graph.addNode(nodeData)
  }
  
  // æ•°æ®æ“ä½œé€‚é…
  getGraphData() {
    if (!this.isReady()) {
      throw new Error('GraphServiceæœªå°±ç»ª')
    }
    
    return {
      nodes: this.graph.getNodes().map(node => node.getData()),
      connections: this.graph.getEdges().map(edge => edge.getData())
    }
  }
  
  async loadGraphData(data) {
    if (!this.isReady()) {
      throw new Error('GraphServiceæœªå°±ç»ª')
    }
    
    // æ¸…ç©ºç°æœ‰æ•°æ®
    this.graph.clearCells()
    
    // åŠ è½½èŠ‚ç‚¹
    if (data.nodes) {
      for (const nodeData of data.nodes) {
        await this.addNode(nodeData)
      }
    }
    
    // åŠ è½½è¿æ¥
    if (data.connections) {
      for (const connectionData of data.connections) {
        await this.addConnection(connectionData)
      }
    }
    
    return true
  }
}
```

## 5. é¢„è§ˆçº¿è°ƒç”¨åˆè§„æ€§åˆ†æ

### 5.1 å½“å‰è°ƒç”¨æ¨¡å¼åˆ†æ

#### âŒ å‘ç°çš„ä¸åˆè§„è°ƒç”¨

**é—®é¢˜1ï¼šç›´æ¥è°ƒç”¨PreviewLineSystem**
```javascript
// åœ¨TaskFlowCanvasRefactored.vueä¸­å‘ç°
if (!previewLineSystem) {
  previewLineSystem = new PreviewLineSystem(graphInstance)
  previewLineSystem.init()
}

// é—®é¢˜ï¼šåº”è¯¥é€šè¿‡UnifiedEdgeManagerç»Ÿä¸€ç®¡ç†
```

**é—®é¢˜2ï¼šæ··åˆä½¿ç”¨å¤šä¸ªé¢„è§ˆçº¿æ¥å£**
```javascript
// create.vueä¸­çš„é¢„è§ˆçº¿è·å–
const previewManager = canvasRef.value?.previewManager

if (previewManager && previewManager.getActivePreviewLines) {
  previewLines = previewManager.getActivePreviewLines()
} else if (previewManager && previewManager.previewLines) {
  // ç›´æ¥è®¿é—®PreviewLineSystemçš„å†…éƒ¨å±æ€§
  previewLines = []
  previewManager.previewLines.forEach((previewInstance, nodeId) => {
    // å¤æ‚çš„æ•°æ®æå–é€»è¾‘
  })
}

// é—®é¢˜ï¼šåº”è¯¥ä½¿ç”¨ç»Ÿä¸€çš„æ¥å£è·å–é¢„è§ˆçº¿æ•°æ®
```

**é—®é¢˜3ï¼šç¼ºå°‘ç»Ÿä¸€çš„é¢„è§ˆçº¿ç®¡ç†å…¥å£**
```javascript
// å½“å‰åˆå§‹åŒ–ä¸­åŒæ—¶åˆ›å»ºå¤šä¸ªç®¡ç†å™¨
unifiedEdgeManager = new UnifiedEdgeManager({...})
previewLineSystem = new PreviewLineSystem(graphInstance)

// é—®é¢˜ï¼šåº”è¯¥åªé€šè¿‡UnifiedEdgeManagerä½œä¸ºå”¯ä¸€å…¥å£
```

### 5.2 åˆè§„æ€§æ”¹è¿›å»ºè®®

#### âœ… æ¨èçš„åˆè§„è°ƒç”¨æ¨¡å¼

**æ”¹è¿›1ï¼šç»Ÿä¸€é¢„è§ˆçº¿åˆ›å»ºå…¥å£**
```javascript
// å½“å‰ä¸åˆè§„ä»£ç 
if (shouldCreatePreviewLines(nodeData)) {
  await createNodePreviewLines(nodeData.id)
}

// æ¨èåˆè§„ä»£ç 
if (shouldCreatePreviewLines(nodeData)) {
  await unifiedEdgeManager.createPreviewLine(nodeData.id, {
    branchCount: getBranchCount(nodeData),
    style: getPreviewLineStyle(nodeData.type)
  })
}
```

**æ”¹è¿›2ï¼šç»Ÿä¸€é¢„è§ˆçº¿æ•°æ®è·å–**
```javascript
// å½“å‰ä¸åˆè§„ä»£ç 
const previewManager = canvasRef.value?.previewManager
if (previewManager && previewManager.previewLines) {
  previewManager.previewLines.forEach((previewInstance, nodeId) => {
    // å¤æ‚çš„æ•°æ®æå–é€»è¾‘
  })
}

// æ¨èåˆè§„ä»£ç 
const unifiedEdgeManager = canvasRef.value?.unifiedEdgeManager
if (unifiedEdgeManager) {
  const previewLines = unifiedEdgeManager.getAllPreviewLines()
  // ä½¿ç”¨æ ‡å‡†åŒ–çš„é¢„è§ˆçº¿æ•°æ®ç»“æ„
}
```

**æ”¹è¿›3ï¼šç»Ÿä¸€é¢„è§ˆçº¿æ¸…ç†**
```javascript
// å½“å‰ä¸åˆè§„ä»£ç 
if (previewManager.clearConnectedPreviewLines) {
  previewManager.clearConnectedPreviewLines()
} else if (previewManager.refreshAllPreviewLines) {
  previewManager.refreshAllPreviewLines()
}

// æ¨èåˆè§„ä»£ç 
await unifiedEdgeManager.cleanupNodePreviewLines(nodeId)
// æˆ–æ‰¹é‡æ¸…ç†
await unifiedEdgeManager.batchCleanupPreviewLines(nodeIds)
```

### 5.3 æ¶æ„é‡æ„å»ºè®®

#### ğŸ”§ ç»Ÿä¸€ç®¡ç†å™¨é›†æˆæ–¹æ¡ˆ

```javascript
// æ¨èçš„åˆå§‹åŒ–æµç¨‹
const initializeGraphDependentSystems = async (graphInstance) => {
  // åªåˆå§‹åŒ–UnifiedEdgeManagerä½œä¸ºå”¯ä¸€å…¥å£
  if (!unifiedEdgeManager) {
    unifiedEdgeManager = new UnifiedEdgeManager({
      graph: graphInstance,
      enablePreviewLines: true,
      snapThreshold: 20,
      // å†…éƒ¨è‡ªåŠ¨ç®¡ç†PreviewLineSystemå’ŒPreviewLineService
      autoInitializeSubSystems: true
    })
    
    await unifiedEdgeManager.initialize()
    
    // è®¾ç½®å…¨å±€è®¿é—®
    window.unifiedEdgeManager = unifiedEdgeManager
  }
}
```

#### ğŸ“‹ æ ‡å‡†åŒ–æ¥å£ä½¿ç”¨

```javascript
// æ¨èçš„ç”»å¸ƒæ¥å£æš´éœ²
defineExpose({
  // ç»Ÿä¸€çš„é¢„è§ˆçº¿æ“ä½œæ¥å£
  createPreviewLine: (sourceNodeId, options) => 
    unifiedEdgeManager?.createPreviewLine(sourceNodeId, options),
    
  removePreviewLine: (previewId) => 
    unifiedEdgeManager?.removePreviewLine(previewId),
    
  getPreviewLines: (nodeId) => 
    unifiedEdgeManager?.getNodePreviewLines(nodeId),
    
  cleanupPreviewLines: (nodeId) => 
    unifiedEdgeManager?.cleanupNodePreviewLines(nodeId),
    
  // ç»Ÿä¸€çš„è¿æ¥æ“ä½œæ¥å£
  createConnection: (sourceNodeId, targetNodeId, options) => 
    unifiedEdgeManager?.createConnection(sourceNodeId, targetNodeId, options),
    
  convertPreviewToConnection: (previewId, targetNodeId) => 
    unifiedEdgeManager?.convertPreviewToConnection(previewId, targetNodeId)
})
```

### 5.4 åˆè§„æ€§æ£€æŸ¥æ¸…å•

#### âœ… å¿…é¡»éµå¾ªçš„è§„èŒƒ

1. **ç»Ÿä¸€å…¥å£åŸåˆ™**
   - âœ… æ‰€æœ‰é¢„è§ˆçº¿æ“ä½œå¿…é¡»é€šè¿‡UnifiedEdgeManager
   - âŒ ç¦æ­¢ç›´æ¥è°ƒç”¨PreviewLineSystemæˆ–PreviewLineService
   - âŒ ç¦æ­¢ç›´æ¥è®¿é—®é¢„è§ˆçº¿å†…éƒ¨å±æ€§

2. **æ ‡å‡†åŒ–æ¥å£åŸåˆ™**
   - âœ… ä½¿ç”¨ç»Ÿä¸€çš„æ•°æ®ç»“æ„å’Œå“åº”æ ¼å¼
   - âœ… éµå¾ªServiceResponseè§„èŒƒ
   - âŒ ç¦æ­¢ä½¿ç”¨éæ ‡å‡†çš„æ•°æ®æ ¼å¼

3. **é”™è¯¯å¤„ç†åŸåˆ™**
   - âœ… ä½¿ç”¨ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
   - âœ… æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œæ¢å¤å»ºè®®
   - âŒ ç¦æ­¢é™é»˜å¤±è´¥

4. **æ€§èƒ½ä¼˜åŒ–åŸåˆ™**
   - âœ… ä½¿ç”¨æ‰¹é‡æ“ä½œæ¥å£
   - âœ… åˆ©ç”¨ç¼“å­˜æœºåˆ¶
   - âŒ ç¦æ­¢é¢‘ç¹çš„å•ä¸ªæ“ä½œ

## 6. æ€»ç»“ä¸å»ºè®®

### 6.1 å½“å‰æ¶æ„ä¼˜åŠ¿

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šé‡‡ç”¨ç»„ä»¶åŒ–ã€æœåŠ¡åŒ–æ¶æ„ï¼ŒèŒè´£åˆ†ç¦»æ¸…æ™°
2. **å“åº”å¼çŠ¶æ€ç®¡ç†**ï¼šä½¿ç”¨Vue 3 Composition APIï¼ŒçŠ¶æ€ç®¡ç†é«˜æ•ˆ
3. **é”™è¯¯å¤„ç†æœºåˆ¶**ï¼šå®Œå–„çš„é”™è¯¯æ•è·å’Œæ¢å¤æœºåˆ¶
4. **æœåŠ¡ç®¡ç†å™¨æ¨¡å¼**ï¼šç»Ÿä¸€çš„æœåŠ¡æ³¨å†Œå’Œä¾èµ–ç®¡ç†

### 6.2 éœ€è¦æ”¹è¿›çš„é—®é¢˜

1. **é¢„è§ˆçº¿è°ƒç”¨ä¸è§„èŒƒ**ï¼šå­˜åœ¨å¤šä¸ªå…¥å£ï¼Œç¼ºä¹ç»Ÿä¸€ç®¡ç†
2. **æ¥å£ä¸€è‡´æ€§ä¸è¶³**ï¼šä¸åŒåœºæ™¯ä½¿ç”¨ä¸åŒçš„æ¥å£è°ƒç”¨æ–¹å¼
3. **æ•°æ®æ ¼å¼ä¸ç»Ÿä¸€**ï¼šé¢„è§ˆçº¿æ•°æ®æå–é€»è¾‘å¤æ‚ä¸”é‡å¤

### 6.3 æ”¹è¿›å»ºè®®

1. **ç»Ÿä¸€é¢„è§ˆçº¿ç®¡ç†**ï¼šå°†æ‰€æœ‰é¢„è§ˆçº¿æ“ä½œè¿ç§»åˆ°UnifiedEdgeManager
2. **æ ‡å‡†åŒ–æ¥å£**ï¼šåˆ¶å®šç»Ÿä¸€çš„æ¥å£è§„èŒƒå’Œæ•°æ®æ ¼å¼
3. **ç®€åŒ–è°ƒç”¨é€»è¾‘**ï¼šå‡å°‘æ¡ä»¶åˆ¤æ–­ï¼Œæä¾›ä¸€è‡´çš„è°ƒç”¨ä½“éªŒ
4. **å®Œå–„æ–‡æ¡£**ï¼šè¡¥å……æ¥å£æ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹

é€šè¿‡ä»¥ä¸Šæ”¹è¿›ï¼Œå¯ä»¥æ˜¾è‘—æå‡ç”»å¸ƒç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§ã€ç¨³å®šæ€§å’Œå¼€å‘æ•ˆç‡ã€‚

## 7. èŠ‚ç‚¹ç±»å‹å®šä¹‰ç»Ÿä¸€ä¿®å¤

### 7.1 ä¿®å¤èƒŒæ™¯

åœ¨ç³»ç»Ÿåˆ†æè¿‡ç¨‹ä¸­å‘ç°äº†ä¸¥é‡çš„èŠ‚ç‚¹ç±»å‹å®šä¹‰ä¸ä¸€è‡´é—®é¢˜ï¼š

#### ğŸš¨ å‘ç°çš„é—®é¢˜
1. **èŠ‚ç‚¹ç±»å‹å®šä¹‰ä¸ç»Ÿä¸€**ï¼šä¸åŒæ–‡ä»¶ä¸­æ”¯æŒçš„èŠ‚ç‚¹ç±»å‹åˆ—è¡¨ä¸ä¸€è‡´
2. **ä¸åº”æ”¯æŒçš„èŠ‚ç‚¹ç±»å‹**ï¼šä»£ç ä¸­åŒ…å«äº† `email`ã€`wechat`ã€`condition` ç­‰ä¸åº”è¯¥æ”¯æŒçš„èŠ‚ç‚¹
3. **è¿‡æ—¶çš„æ–‡æ¡£è®¾è®¡**ï¼šæ–‡æ¡£ä¸­å­˜åœ¨ `NodePortService` ç­‰æœªå®ç°çš„è®¾è®¡
4. **æµ‹è¯•ä¸å®ç°ä¸åŒ¹é…**ï¼šæµ‹è¯•æ–‡ä»¶ä¸­çš„èŠ‚ç‚¹ç±»å‹ä¸å®é™…ä»£ç å®šä¹‰ä¸ç¬¦

#### ğŸ“Š é—®é¢˜åˆ†æè¡¨
| æ–‡ä»¶ | email | wechat | condition | çŠ¶æ€ |
|------|-------|--------|-----------|------|
| **NodeTypeSupport.test.js** | âŒ | âŒ | âŒ | âœ… æ­£ç¡® |
| **useCanvasNodes.js** | âŒ | âŒ | âœ… | âš ï¸ éœ€ä¿®å¤ |
| **nodeTypes.js** | âœ… | âœ… | âœ… | âŒ éœ€ä¿®å¤ |
| **PortConfigurationFactory.js** | âœ… | âŒ | âœ… | âš ï¸ éœ€ä¿®å¤ |

### 7.2 ä¿®å¤å†…å®¹

#### âœ… å·²ä¿®å¤çš„æ–‡ä»¶

**1. æ ¸å¿ƒèŠ‚ç‚¹å®šä¹‰æ–‡ä»¶**
- **`nodeTypes.js`** - ç§»é™¤äº† `email`ã€`wechat`ã€`condition` èŠ‚ç‚¹å®šä¹‰
- **`useCanvasNodes.js`** - ç»Ÿä¸€äº† `SUPPORTED_NODE_TYPES` åˆ—è¡¨
- **`PortConfigurationFactory.js`** - ç§»é™¤äº†ä¸æ”¯æŒèŠ‚ç‚¹ç±»å‹çš„ç«¯å£é…ç½®

**2. ç±»å‹å®šä¹‰æ–‡ä»¶**
- **`canvas.d.ts`** - æ›´æ–°äº† `NodeType` æšä¸¾ï¼Œç§»é™¤ä¸æ”¯æŒçš„ç±»å‹
- **`useConfigDrawers.js`** - ç§»é™¤äº†ä¸æ”¯æŒèŠ‚ç‚¹çš„é…ç½®æ˜ å°„
- **`TaskFlowConfigDrawers.vue`** - æ¸…ç†äº†ä¸å­˜åœ¨çš„ç»„ä»¶å¼•ç”¨

**3. å¸ƒå±€å’Œå·¥å…·ç±»**
- **`NodeFilter.js`** - ä¿®å¤äº†èŠ‚ç‚¹å±‚çº§ä¼˜å…ˆçº§å®šä¹‰
- **`LayerUtils.js`** - ç»Ÿä¸€äº†å±‚çº§ç´¢å¼•ä¸­çš„èŠ‚ç‚¹ç±»å‹
- **`PositionUtils.js`** - ä¿®å¤äº†èŠ‚ç‚¹é‡è¦æ€§æƒé‡è®¡ç®—

**4. ç¤ºä¾‹å’Œæµ‹è¯•æ–‡ä»¶**
- **`index.vue`** - å°†ç¤ºä¾‹ä¸­çš„ `email` èŠ‚ç‚¹æ›¿æ¢ä¸º `sms`
- **`ValidationUtils.js`** - ç§»é™¤äº†å¯¹ä¸æ”¯æŒèŠ‚ç‚¹ç±»å‹çš„éªŒè¯
- **æµ‹è¯•æ–‡ä»¶** - è¡¥å……äº†ç¼ºå¤±çš„ `getNodeShapeByType` å‡½æ•°

### 7.3 ä¿®å¤ç»“æœ

#### ğŸ¯ ç»Ÿä¸€åçš„æ­£ç¡®èŠ‚ç‚¹ç±»å‹åˆ—è¡¨

```javascript
const SUPPORTED_NODE_TYPES = [
  'start',           // å¼€å§‹èŠ‚ç‚¹
  'audience-split',  // äººç¾¤åˆ†æµ
  'event-split',     // äº‹ä»¶åˆ†æµ
  'sms',             // çŸ­ä¿¡è§¦è¾¾
  'ai-call',         // AIå¤–å‘¼
  'manual-call',     // äººå·¥å¤–å‘¼
  'ab-test',         // ABå®éªŒ
  'wait',            // ç­‰å¾…èŠ‚ç‚¹
  'end'              // ç»“æŸèŠ‚ç‚¹
]
```

#### ğŸ“‹ èŠ‚ç‚¹ç±»å‹ç‰¹æ€§è¯´æ˜

| èŠ‚ç‚¹ç±»å‹ | ä¸­æ–‡åç§° | è¾“å…¥ç«¯å£ | è¾“å‡ºç«¯å£ | æœ€å¤§è¾“å‡ºè¿æ¥ |
|----------|----------|----------|----------|--------------|
| `start` | å¼€å§‹èŠ‚ç‚¹ | âŒ | âœ… | 1 |
| `audience-split` | äººç¾¤åˆ†æµ | âœ… | âœ… | åŠ¨æ€ |
| `event-split` | äº‹ä»¶åˆ†æµ | âœ… | âœ… | 2 |
| `sms` | çŸ­ä¿¡è§¦è¾¾ | âœ… | âœ… | 1 |
| `ai-call` | AIå¤–å‘¼ | âœ… | âœ… | 1 |
| `manual-call` | äººå·¥å¤–å‘¼ | âœ… | âœ… | 1 |
| `ab-test` | ABå®éªŒ | âœ… | âœ… | 2 |
| `wait` | ç­‰å¾…èŠ‚ç‚¹ | âœ… | âœ… | 1 |
| `end` | ç»“æŸèŠ‚ç‚¹ | âœ… | âŒ | 0 |

### 7.4 æ–‡æ¡£æ›´æ–°

#### ğŸ—‘ï¸ ç§»é™¤çš„è¿‡æ—¶å†…å®¹
1. **NodePortService ç›¸å…³è®¾è®¡** - æ ‡è®°ä¸ºæœªå®ç°çš„è¿‡æ—¶è®¾è®¡
2. **ä¸æ”¯æŒèŠ‚ç‚¹ç±»å‹çš„é…ç½®è¯´æ˜** - æ¸…ç†äº†ç›¸å…³æ–‡æ¡£
3. **é”™è¯¯çš„ç¤ºä¾‹ä»£ç ** - æ›´æ–°äº†æ‰€æœ‰ç¤ºä¾‹ä½¿ç”¨æ­£ç¡®çš„èŠ‚ç‚¹ç±»å‹

#### ğŸ“ æ›´æ–°çš„æ–‡æ¡£å†…å®¹
1. **ç«¯å£é…ç½®è¯´æ˜** - åæ˜ å®é™…çš„ `PortConfigurationFactory` å®ç°
2. **èŠ‚ç‚¹ç±»å‹æ”¯æŒåˆ—è¡¨** - ä¸æµ‹è¯•æ–‡ä»¶å®Œå…¨ä¸€è‡´
3. **API æ¥å£æ–‡æ¡£** - ç§»é™¤äº†ä¸å­˜åœ¨çš„æœåŠ¡æ¥å£

### 7.5 å½±å“è¯„ä¼°

#### ğŸ‰ ç§¯æå½±å“

**1. ä»£ç ä¸€è‡´æ€§æå‡**
- âœ… æ‰€æœ‰æ–‡ä»¶ä¸­çš„èŠ‚ç‚¹ç±»å‹å®šä¹‰å®Œå…¨ç»Ÿä¸€
- âœ… æ¶ˆé™¤äº†ä¸åŒæ¨¡å—é—´çš„ç±»å‹å†²çª
- âœ… æé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§

**2. åŠŸèƒ½ç¨³å®šæ€§å¢å¼º**
- âœ… é¿å…äº†ä¸æ”¯æŒèŠ‚ç‚¹ç±»å‹çš„é”™è¯¯åˆ›å»º
- âœ… å‡å°‘äº†è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥é”™è¯¯
- âœ… æå‡äº†ç”»å¸ƒç³»ç»Ÿçš„å¯é æ€§

**3. å¼€å‘ä½“éªŒæ”¹å–„**
- âœ… ç»Ÿä¸€çš„èŠ‚ç‚¹ç±»å‹å®šä¹‰ä¾¿äºå¼€å‘è€…ç†è§£
- âœ… æ¸…æ™°çš„æ–‡æ¡£å‡å°‘äº†å­¦ä¹ æˆæœ¬
- âœ… ä¸€è‡´çš„æ¥å£æé«˜äº†å¼€å‘æ•ˆç‡

**4. æµ‹è¯•è¦†ç›–å®Œæ•´**
- âœ… æµ‹è¯•æ–‡ä»¶ä¸å®é™…ä»£ç å®Œå…¨åŒ¹é…
- âœ… æ¶ˆé™¤äº†æµ‹è¯•ä¸å®ç°çš„ä¸ä¸€è‡´
- âœ… æé«˜äº†æµ‹è¯•çš„å¯ä¿¡åº¦

#### ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

| æ–¹é¢ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **èŠ‚ç‚¹ç±»å‹ä¸€è‡´æ€§** | âŒ 4ä¸ªæ–‡ä»¶å®šä¹‰ä¸åŒ | âœ… å®Œå…¨ç»Ÿä¸€ |
| **ä¸æ”¯æŒèŠ‚ç‚¹å¤„ç†** | âŒ å¯èƒ½é”™è¯¯åˆ›å»º | âœ… å®Œå…¨é˜»æ­¢ |
| **æ–‡æ¡£å‡†ç¡®æ€§** | âŒ åŒ…å«è¿‡æ—¶è®¾è®¡ | âœ… åæ˜ å®é™…å®ç° |
| **æµ‹è¯•å¯é æ€§** | âŒ ä¸å®ç°ä¸åŒ¹é… | âœ… å®Œå…¨åŒ¹é… |

### 7.6 åç»­å»ºè®®

#### ğŸ”§ ç»´æŠ¤å»ºè®®
1. **ä¸¥æ ¼çš„ç±»å‹æ£€æŸ¥** - åœ¨æ·»åŠ æ–°èŠ‚ç‚¹ç±»å‹æ—¶ï¼Œç¡®ä¿æ‰€æœ‰ç›¸å…³æ–‡ä»¶åŒæ­¥æ›´æ–°
2. **è‡ªåŠ¨åŒ–æµ‹è¯•** - å¢åŠ èŠ‚ç‚¹ç±»å‹ä¸€è‡´æ€§çš„è‡ªåŠ¨åŒ–æ£€æŸ¥
3. **æ–‡æ¡£åŒæ­¥** - å»ºç«‹æ–‡æ¡£ä¸ä»£ç çš„åŒæ­¥æ›´æ–°æœºåˆ¶
4. **ä»£ç å®¡æŸ¥** - åœ¨ä»£ç å®¡æŸ¥ä¸­é‡ç‚¹æ£€æŸ¥èŠ‚ç‚¹ç±»å‹ç›¸å…³çš„ä¿®æ”¹

#### ğŸš€ æœªæ¥ä¼˜åŒ–
1. **ç±»å‹å®šä¹‰ä¸­å¿ƒåŒ–** - è€ƒè™‘åˆ›å»ºç»Ÿä¸€çš„èŠ‚ç‚¹ç±»å‹å¸¸é‡æ–‡ä»¶
2. **é…ç½®éªŒè¯ä¸­é—´ä»¶** - æ·»åŠ èŠ‚ç‚¹ç±»å‹é…ç½®çš„è¿è¡Œæ—¶éªŒè¯
3. **å¼€å‘å·¥å…·æ”¯æŒ** - æä¾›èŠ‚ç‚¹ç±»å‹çš„ TypeScript ç±»å‹æç¤º
4. **ç›‘æ§å‘Šè­¦** - æ·»åŠ ä¸æ”¯æŒèŠ‚ç‚¹ç±»å‹çš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

## 8. ç«¯å£ä½ç½®è®¡ç®—ä¸èŠ‚ç‚¹æ ·å¼åˆ†æ

### 8.1 ç«¯å£ä½ç½®éœ€æ±‚ç¡®è®¤

æ ¹æ®ç”¨æˆ·è¦æ±‚ï¼Œç«¯å£éœ€è¦å±•ç¤ºåœ¨èŠ‚ç‚¹çš„**é¡¶ç«¯å’Œåº•ç«¯**ï¼š
- **è¾“å…¥ç«¯å£ï¼ˆinï¼‰**ï¼šä½äºèŠ‚ç‚¹é¡¶ç«¯
- **è¾“å‡ºç«¯å£ï¼ˆoutï¼‰**ï¼šä½äºèŠ‚ç‚¹åº•ç«¯

### 8.2 å½“å‰ç«¯å£ä½ç½®å®ç°åˆ†æ

#### ğŸ” ç«¯å£é…ç½®ä»£ç æ£€æŸ¥

**1. nodeTypes.js ä¸­çš„ç«¯å£å®šä¹‰**
```javascript
// å½“å‰çš„ç«¯å£ç»„é…ç½®
ports: {
  groups: {
    out: {
      position: 'bottom',  // âœ… æ­£ç¡®ï¼šè¾“å‡ºç«¯å£åœ¨åº•éƒ¨
      attrs: {
        circle: {
          r: 6,
          magnet: true,
          stroke: '#5F95FF',
          strokeWidth: 2,
          fill: '#fff'
        }
      }
    }
  }
}
```

**2. PortConfigurationFactory.js ä¸­çš„ç«¯å£é…ç½®**
```javascript
// é»˜è®¤ç«¯å£é…ç½®
const typeConfig = this.nodeTypeConfigs.get(nodeType) || {
  hasOutPort: true,
  hasInPort: true,
  outPortName: 'out',
  inPortName: 'in',
  maxOutConnections: 1,
  maxInConnections: 1
}
```

#### âš ï¸ å‘ç°çš„ç«¯å£ä½ç½®é—®é¢˜

**é—®é¢˜1ï¼šç¼ºå°‘è¾“å…¥ç«¯å£çš„ä½ç½®å®šä¹‰**
- å½“å‰åªå®šä¹‰äº†è¾“å‡ºç«¯å£ï¼ˆbottomï¼‰
- ç¼ºå°‘è¾“å…¥ç«¯å£ï¼ˆtopï¼‰çš„ä½ç½®é…ç½®

**é—®é¢˜2ï¼šç«¯å£åæ ‡è®¡ç®—ä¸å®Œæ•´**
```javascript
// PortCoordinateDebugger.js ä¸­çš„è®¡ç®—é€»è¾‘
calculateActualPortCoordinates(nodeDebugData, positionConfig) {
  const { nodePosition, nodeSize, shape } = nodeDebugData
  // éœ€è¦è¡¥å……é¡¶ç«¯å’Œåº•ç«¯çš„ç²¾ç¡®åæ ‡è®¡ç®—
}
```

### 8.3 ç«¯å£ä½ç½®ä¿®å¤å»ºè®®

#### ğŸ”§ å®Œæ•´çš„ç«¯å£é…ç½®æ–¹æ¡ˆ

```javascript
// æ¨èçš„å®Œæ•´ç«¯å£é…ç½®
ports: {
  groups: {
    // è¾“å…¥ç«¯å£ç»„ - ä½äºèŠ‚ç‚¹é¡¶ç«¯
    in: {
      position: 'top',
      attrs: {
        circle: {
          r: 6,
          magnet: true,
          stroke: '#52C41A',
          strokeWidth: 2,
          fill: '#fff',
          style: {
            visibility: 'visible'
          }
        }
      }
    },
    // è¾“å‡ºç«¯å£ç»„ - ä½äºèŠ‚ç‚¹åº•ç«¯
    out: {
      position: 'bottom',
      attrs: {
        circle: {
          r: 6,
          magnet: true,
          stroke: '#5F95FF',
          strokeWidth: 2,
          fill: '#fff',
          style: {
            visibility: 'visible'
          }
        }
      }
    }
  },
  items: [
    // è¾“å…¥ç«¯å£é¡¹
    { 
      group: 'in', 
      id: 'in',
      attrs: {
        circle: {
          r: 6,
          magnet: true,
          stroke: '#52C41A',
          strokeWidth: 2,
          fill: '#fff'
        }
      }
    },
    // è¾“å‡ºç«¯å£é¡¹
    { 
      group: 'out', 
      id: 'out',
      attrs: {
        circle: {
          r: 6,
          magnet: true,
          stroke: '#5F95FF',
          strokeWidth: 2,
          fill: '#fff'
        }
      }
    }
  ]
}
```

#### ğŸ“ ç²¾ç¡®çš„ç«¯å£åæ ‡è®¡ç®—

```javascript
// æ¨èçš„ç«¯å£åæ ‡è®¡ç®—é€»è¾‘
calculatePortCoordinates(nodePosition, nodeSize, portType) {
  const { x, y } = nodePosition
  const { width, height } = nodeSize
  
  switch (portType) {
    case 'in':
      // è¾“å…¥ç«¯å£ï¼šèŠ‚ç‚¹é¡¶ç«¯ä¸­å¿ƒ
      return {
        x: x + width / 2,
        y: y
      }
    case 'out':
      // è¾“å‡ºç«¯å£ï¼šèŠ‚ç‚¹åº•ç«¯ä¸­å¿ƒ
      return {
        x: x + width / 2,
        y: y + height
      }
    default:
      return { x: x + width / 2, y: y + height / 2 }
  }
}
```

### 8.4 ç«¯å£æ ·å¼ä¸èŠ‚ç‚¹å…³ç³»

#### ğŸ¨ è§†è§‰è®¾è®¡è§„èŒƒ

**1. ç«¯å£é¢œè‰²åŒºåˆ†**
- **è¾“å…¥ç«¯å£**ï¼šç»¿è‰²ç³»ï¼ˆ#52C41Aï¼‰è¡¨ç¤ºæ¥æ”¶
- **è¾“å‡ºç«¯å£**ï¼šè“è‰²ç³»ï¼ˆ#5F95FFï¼‰è¡¨ç¤ºè¾“å‡º

**2. ç«¯å£å¤§å°è§„èŒƒ**
- **åŠå¾„**ï¼š6pxï¼Œç¡®ä¿è¶³å¤Ÿçš„ç‚¹å‡»åŒºåŸŸ
- **è¾¹æ¡†**ï¼š2pxï¼Œæä¾›æ¸…æ™°çš„è§†è§‰è¾¹ç•Œ

**3. ç«¯å£çŠ¶æ€æ ·å¼**
```javascript
// ç«¯å£çŠ¶æ€æ ·å¼å®šä¹‰
const portStates = {
  normal: {
    fill: '#fff',
    stroke: '#5F95FF',
    strokeWidth: 2
  },
  hover: {
    fill: '#e6f7ff',
    stroke: '#1890ff',
    strokeWidth: 3
  },
  connected: {
    fill: '#5F95FF',
    stroke: '#5F95FF',
    strokeWidth: 2
  }
}
```

#### ğŸ”— ç«¯å£ä¸è¿æ¥çº¿çš„å…³ç³»

**1. è¿æ¥èµ·ç‚¹å’Œç»ˆç‚¹**
- è¿æ¥çº¿ä»æºèŠ‚ç‚¹çš„**è¾“å‡ºç«¯å£**ï¼ˆåº•ç«¯ï¼‰å¼€å§‹
- è¿æ¥çº¿åˆ°ç›®æ ‡èŠ‚ç‚¹çš„**è¾“å…¥ç«¯å£**ï¼ˆé¡¶ç«¯ï¼‰ç»“æŸ

**2. é¢„è§ˆçº¿çš„ç«¯å£å¸é™„**
```javascript
// é¢„è§ˆçº¿ç«¯å£å¸é™„é€»è¾‘
const snapToPort = (mousePosition, targetNode) => {
  const inputPortPosition = calculatePortCoordinates(
    targetNode.position, 
    targetNode.size, 
    'in'
  )
  
  const distance = calculateDistance(mousePosition, inputPortPosition)
  
  if (distance <= SNAP_THRESHOLD) {
    return {
      snapped: true,
      position: inputPortPosition,
      portType: 'in'
    }
  }
  
  return { snapped: false }
}
```

é€šè¿‡ä»¥ä¸Šç«¯å£ä½ç½®å’Œæ ·å¼çš„è§„èŒƒåŒ–ï¼Œå¯ä»¥ç¡®ä¿ç”»å¸ƒä¸Šçš„èŠ‚ç‚¹ç«¯å£æ­£ç¡®æ˜¾ç¤ºåœ¨é¡¶ç«¯å’Œåº•ç«¯ï¼Œå¹¶æä¾›è‰¯å¥½çš„è§†è§‰åé¦ˆå’Œäº¤äº’ä½“éªŒã€‚