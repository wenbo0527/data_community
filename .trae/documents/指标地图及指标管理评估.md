# 指标地图及指标管理评估（最终版）

## 概述
- 本评估基于当前代码库（Vue 3 + Vite + AntV X6 + Vuex + Vue Router + Arco Design，TS/JS）对指标相关类型、页面与 Mock 数据的实际结构进行梳理，并形成一致性方案。
- 本版将方案中的字段命名统一为：
  - “分类/监管大类” → “指标域”
  - “业务域/报表名称” → “归属场景”
- 同时支持在指标详情页切换版本，并在分享链接中包含所选版本参数。

## 现状评估（代码与类型）
- 类型文件 `src/types/metrics.ts`：
  - `MetricType`、`RegulatoryCategory` 枚举及标签映射存在。
  - `MetricVersion`、`ReportBinding`、`BatchRegistrationItem`、`MetricItem` 等接口已定义，但 **Mock 数据中的 `versions` 结构与类型定义存在不完全一致**（如 `version/date/createdAt/status` 字段混用）。
- 页面使用情况：
  - 指标地图详情页 `src/pages/discovery/metrics-map/detail.vue` 展示指标名称、编号、分类/域、负责人、统计周期、报表信息与版本历史；存在 `shareUrl` 计算属性。
  - 指标地图列表页 `src/pages/discovery/metrics-map/index.vue` 在筛选项和动态列中使用“分类/监管大类”和“业务域/报表名称”文案。
  - 统一指标页面 `src/pages/discovery/unified-metrics/index.vue` 在详情、表格列、表单与校验文案中使用“业务域”“报表名称”等字段。

## 统一模型与字段调整
- 字段命名调整：
  - 将所有页面展示与表头文案中“分类/监管大类”统一为“指标域”。
  - 将所有页面展示与表头文案中“业务域/报表名称”统一为“归属场景”。
- 版本切换支持：
  - 在指标详情页版本历史卡片增加版本下拉选择（优先选中 `status=active` 的版本；若无，则选中最新一条），并使分享链接 `shareUrl` 携带 `version` 查询参数。
  - 若通过 URL 携带 `version` 参数访问详情页，则根据参数选择对应版本。

## Mock 数据更新建议
- 统一 `MetricItem.versions` 的结构，建议采用：
  - `version: string`（版本号或版本日期的规范化字符串）
  - `description?: string`
  - `status?: 'active' | 'draft' | 'archived'`
  - `creator?: string`
  - `createdAt?: string`（ISO 或 yyyy-MM-dd）
  - `effectiveFrom?: string` / `effectiveTo?: string`
- 负责人字段：
  - 业务指标：沿用 `owner`（或 `businessOwner`），并补齐 `technicalOwner`（如存在技术对接人）。
  - 监管指标：优先使用 `businessOwner` + `technicalOwner`，在统一展示时聚合为“负责人”。
- 归属场景：
  - 业务指标使用 `businessDomain` 作为归属场景。
  - 监管指标使用 `reportName`（若有位置描述，可放入 `reportInfo`）。
- 枚举一致性：确保 `RegulatoryCategory` 与标签映射在 Mock 数据中引用一致。

## 页面改动清单（已实施）
- 指标地图详情页 `metrics-map/detail.vue`：
  - 文案调整：将“分类/监管大类”→“指标域”，“业务域/报表名称”→“归属场景”。
  - 新增版本切换：在“版本历史”卡片加入下拉选择 `a-select`，并计算 `currentVersion`；`shareUrl` 包含 `version` 参数。
  - 初始版本选择：优先选择 `status='active'`；否则选最新一条；若 URL 有 `version`，优先按参数匹配。
- 指标地图列表页 `metrics-map/index.vue`：
  - 筛选项与占位文案：统一为“选择指标域”“全部指标域”“选择归属场景”“全部归属场景”。
  - 动态列标题：统一为“指标域”“归属场景”。
- 统一指标页面 `unified-metrics/index.vue`：
  - 详情展示：
    - 业务指标将原“分类/业务域”拆分为两行：“指标域”（展示 `category`）与“归属场景”（展示 `businessDomain`）。
    - 监管指标将“分类/监管大类”改为“指标域”（展示监管大类标签），并新增“归属场景”（展示 `reportName`）。
  - 列标题与表单文案：
    - 列标题“业务域”改为“归属场景”。
    - 表单项“业务域”“报表名称”在文案上统一为“归属场景”（占位与校验消息同步更新）。

## 验证路径
- 指标地图详情页：
  - 访问任意指标详情，确认“指标域”“归属场景”文案显示正确。
  - 在“版本历史”卡片选择不同版本，确认分享链接 `?version=` 参数随选择变更，并能复制链接。
- 指标地图列表页：
  - 打开列表，确认筛选框与表格列标题已统一为“指标域/归属场景”。
- 统一指标页面：
  - 查看详情卡片与表格列标题，确认文案已统一。
  - 打开新建/编辑表单，确认表单项与校验提示为“归属场景”。

## 后续建议
- 若需要彻底统一数据层：
  - 将“归属场景”抽象为一个字段，并在业务/监管场景下由不同来源填充（`businessDomain` 或 `reportName`）。
  - 在详情页引入“活动版本”概念，允许版本内容驱动 SQL/定义的展示差异（当前仅在分享链接中携带版本）。
- 补齐真实数据源中的版本字段，以获得最佳展示与筛选体验。

## 页面合并与路由规范（计划）
- 统一入口：`/discovery/asset-management/metric-management/:id/edit`。
  - 新建：`id=create`，示例：`/discovery/asset-management/metric-management/create/edit`。
  - 编辑：`id=<metricId>`，示例：`/discovery/asset-management/metric-management/1/edit`。
- 路由参数：保留可选 `:mode?`，但规范仅使用 `edit`，避免 `new`/`create` 的多模式混用。
- 跳转来源：统一指标页的“新建指标”按钮与列表中的“编辑”操作均跳转到上述路径。

## 编辑页与详情页一致性（核对项）
- 字段一致：确保编辑页与详情页均按统一文案展示——“指标域”“归属场景”“负责人”“统计周期”“报表信息”“版本历史”。
- 版本一致：编辑页沿用 `MetricVersion` 结构（`version/description/status/creator/createdAt/effectiveFrom/effectiveTo`），支持选择与查看历史；详情页保持只读展示。
- 文案一致：
  - “分类/监管大类”统一为“指标域”。
  - “业务域/报表名称”统一为“归属场景”。
- 展示差异：
  - 详情页：只读卡片 + 分享链接（`shareUrl` 携带 `version`）。
  - 编辑页：表单可编辑，取消分享链接展示，改为保存/校验提示。
- 校验与占位：编辑页的占位与校验消息统一为“归属场景”，与详情页文案保持一致。

## 编辑页 SQL 输入框样式（计划）
- 涉及字段：`加工逻辑`（对应 `metricDetail.processingLogic`）与 `查询代码`（对应 `metricDetail.queryCode`）。
- 展示方案：
  - 输入组件统一采用 `a-textarea`，设置等宽字体（monospace）、`rows` 合理高度、`max-length` 与计数器开启。
  - 语法高亮：如已有代码高亮组件，优先在预览态使用；若暂缺，使用 `a-typography` 的 `pre/code` 样式呈现只读预览。
  - 交互结构：在编辑页将两处 SQL 放入 `a-collapse` 分组；每组提供“编辑/预览”切换（可用 `a-tabs` 或按钮切换）。
  - 辅助信息：在标题下补充简要说明与期望输入规范（如必须为可执行 SQL，约束关键字等）。
  - 滚动与尺寸：限定最大高度，开启滚动；长文本时保持性能与可读性。
- 详情页保持只读展示，不引入编辑交互；如需预览，统一采用只读 `code` 区块。

## 接入与验收
- 路由验收：
  - 访问 `http://localhost:5174/discovery/asset-management/metric-management/1/edit`，确认编辑页可正常加载并与详情页字段一致。
  - 新建入口 `http://localhost:5174/discovery/asset-management/metric-management/create/edit`，确认表单初始为空、版本块隐藏或仅显示占位。
- 一致性验收：核对“指标域/归属场景/负责人/统计周期/报表信息/版本历史”在编辑与详情页的文案与字段映射一致。
- SQL 区块验收：编辑页的 `加工逻辑` 与 `查询代码` 采用统一样式；详情页两处保持只读显示，与编辑页内容一致。
- 回归项：详情页版本选择与分享链接仍可用；编辑页取消分享链接展示。

—— 完 ————
