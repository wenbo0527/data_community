# 横版营销画布需求设计（融合版）

## 变更摘要
- 融合“数据结构兼容版”的产品需求与“节点核心功能分析报告”的架构与服务能力。
- 节点统一“标题行 + 内容行”呈现；标题含类型图标与更多（⋯）菜单，非 start/end 显示。
- 支持从 `out` 端口拖拽到 `in` 端口建立连接；右键连接线删除。
- 继续保持与 `/marketing/tasks` 原版画布的数据契约完全一致，仅前端展示与交互优化。

## 1. 目标与范围
- 目标：构建横版工作流画布的产品级体验，统一节点呈现、交互规则与服务集成，保证数据互通。
- 范围：节点结构、类型图标、更多菜单、端口与连接、抽屉配置、删除、发布校验、性能与兼容。

## 2. 数据结构兼容
- CanvasData：`{ nodes: BaseNode[], connections: Connection[] }`（src/pages/marketing/tasks/types/core.ts:30,112）。
- 节点：`{ id, type, x, y, label?, data: { isConfigured, config }, ports }`；端口保持 `groups + items`。
- 连接：`{ id, sourceId, targetId, sourcePortId?, targetPortId? }`。
- 导入/导出对齐：`getCanvasData/loadCanvasData`（TaskFlowCanvasRefactored.vue:3318,3337）。

## 3. 架构能力与集成（来自“核心功能分析报告”）
- NodeCreationService：节点创建与初始化；校验与生成配置对象；端口配置（PortConfigurationFactory）。
- NodeStyleService：主题样式、状态样式（选中/悬停/禁用/错误）；批量样式更新。
- NodeCoordinateService：坐标计算、布局与碰撞避让、网格对齐（水平布局策略可复用）。
- NodeDeletionService：清理连接、预览线、配置与删除节点；支撑级联删除策略。
- NodeConfigService：打开/保存节点配置；与抽屉 UI 对接（横版接入 useConfigDrawers）。
- 端口配置一致性：统一节点类型枚举，修复 PortConfigurationFactory 中缺失类型；避免命名不一致。

## 4. 节点卡片结构（产品化）
- 标题行：类型图标 + 标题文本（优先 `config.nodeName`）；右上角“⋯”菜单（非 start/end）。
- 内容行：逐行信息；分流类每分支一行；右侧 `out-i` 与行中点对齐；左侧中点 `in` 端口。
- 尺寸：宽度 `280`；高度 = 标题 + 内容行数 × 行高（建议 `24–28`）；文本截断 + 悬停提示。

## 5. 节点展示映射（抽屉配置 → 内容行）
- start：标题“开始”；内容：`任务类型：{taskType}`、`目标人群：{targetAudience}`；右侧单 `out`；无更多菜单。
- audience-split：标题“人群分流”；内容：`命中：{crowdName}`×N，最后 `否则：{unmatchBranch.name}`；每行右侧一个 `out-i`。
- event-split：标题“事件分流”；内容：`命中：{yesLabel||'是'}`、`等待 {timeout} 分钟未命中`；`out-0`/`out-1`。
- ab-test：标题“AB实验”/实验名；内容：`{branch.name}：{branch.percentage}%`×N；可选描述不挂端口。
- ai-call：标题“AI外呼”；内容：`触达任务ID：{taskId}`；右侧单 `out`。
- sms：标题“短信触达”；内容：`短信模板：{smsTemplate}`；右侧单 `out`。
- manual-call：标题“人工外呼”；内容：`配置ID：{configId}`；右侧单 `out`。
- wait：标题“等待”；内容：`等待：{value} {unit}`；右侧单 `out`。
- benefit：标题“权益”；内容：`权益包名称：{benefitName}`；右侧单 `out`。
- end：标题“结束”；内容可空；不显示更多菜单；不挂端口。

## 6. 类型图标映射
- 建议图标：`start: IconPlayCircle`、`audience-split: IconUserGroup`、`event-split: IconCalendarClock`、`ab-test: IconBranch`、`sms: IconMessage`、`email: IconMail`、`wechat: IconWechat`、`ai-call: IconRobot`、`manual-call: IconPhone`、`wait: IconTime`、`benefit: IconGift`、`end: IconStopCircle`。
- 展示：标题左侧 16–18px；与文本间距 8–10px；颜色轻度区分主题。

## 7. 端口与连接交互
- 手动连线：从 `out` 拖拽到 `in` 建立连接；保留横向方向限制与 `out` 单连接限制（horizontal/index.vue:115-141）。
- 删除连接：右键连接线触发删除（horizontal/index.vue:179）。
- 插入节点：连接线上“+”插入；分流默认保留至 `out-0`（horizontal/index.vue:268-271）。

## 8. 抽屉配置与打开逻辑
- 统一调用 `useConfigDrawers.openConfigDrawer(type, node, data)`（useConfigDrawers.js:84）。
- 点击节点打开抽屉；拖拽创建后自动打开；确认/取消由抽屉系统处理（useConfigDrawers.js:201,315）。

## 9. 删除策略
- 级联删除：沿下游“线性链路”（目标入度=1、出度<=1）删除；遇到分支或共享节点终止。
- 清理连接与节点；优先移除边再移除节点；联动预览线清理（NodeDeletionService）。

## 10. 发布校验
- 规则：所有 `out` 端口必须存在连接；阻止发布并返回 `{ nodeId, portId }` 问题清单。
- 兼容增强校验：可选 `previewLines` 自动补 `end` 节点（enhancedCanvasValidation.js）。

## 11. 视觉规范
- 标题/内容分层；行距统一；端口与行中点精准对齐；圆角 `rx/ry=8`；文本截断+悬停提示。

## 12. 验收标准
- 展示：标题/内容呈现准确；分流类端口与行对齐；开始/结束无更多菜单；图标正确。
- 交互：点击打开抽屉；`out→in` 连线成功；右键连接删除；更多菜单操作有效（重命名、复制、删除）。
- 兼容与性能：数据契约不变；100+ 节点交互流畅。

## 13. 风险与兼容
- HTML/foreignObject 与端口对齐兼容性；必要时回退纯 SVG 文本。
- 分支动态调整导致端口与连线更新复杂度；需统一更新策略与防抖。
- 类型枚举统一：修复 PortConfigurationFactory 与类型定义不一致，避免后续兼容问题。

## 14. 实施建议
- 渲染层：拆分标题分组与内容分组；标题分组承载图标与菜单；内容分组负责行文本与端口定位。
- 抽屉：统一 `openConfigDrawer`；配置写回驱动内容行与端口重建。
- 连接：保留横向方向与 `out` 单连接限制；启用 `edge:contextmenu` 删除。
- 类型统一：建立统一常量与验证；修复 PortConfigurationFactory 的缺失类型与过时枚举。

## 15. 附录（关键引用）
- 横版页面初始化与连接校验：src/pages/marketing/tasks/horizontal/index.vue:86-146, 115-141。
- 连接删除与插入：horizontal/index.vue:179, 149-177, 262-271。
- 抽屉系统：useConfigDrawers.js:84, 201, 315；横版接入：horizontal/index.vue:18, 194, 332, 447。
- 端口配置工厂（横向）：horizontal/utils/portConfigFactoryHorizontal.js:6,21。
- 原版导入/导出：TaskFlowCanvasRefactored.vue:3318, 3337。

如确认以上融合版的结构与内容，我将把该设计合并到现有需求文档，并继续补充每个节点类型的字段到“标题行/内容行”的精细映射表与图标方案清单。