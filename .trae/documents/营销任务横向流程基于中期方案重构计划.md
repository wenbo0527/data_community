## 重构目标
- 统一节点端口方向：`out` 在右侧、`in` 在左侧（全局一致）
- 引入“标题区+内容区”节点结构：内容区内以 Vue 组件形式声明输入/输出组件，端口数量与位置由组件自动推导，彻底解决端口与配置分支不一致问题
- 直接重构相似功能模块，去除重复的图初始化与端口生成逻辑
- 基于现有代码结构渐进迁移，保持现有功能：按文本行对齐端口、仅允许 `out→in` 连接、水平布局

## 当前结构与关键位置
- 图与端口在页面内直接实现：`src/pages/marketing/tasks/horizontal/index.vue:395–506`（Graph 初始化与 `registerPortLayout('fixed-right-y'/'fixed-left-y')`）
- 节点与端口创建：
  - 端口工厂：`src/pages/marketing/tasks/horizontal/utils/portConfigFactoryHorizontal.js:34–168`
  - 端口配置应用与重建：`src/pages/marketing/tasks/horizontal/index.vue:1280–1506`
  - 连接校验：`src/pages/marketing/tasks/horizontal/index.vue:410–452`
- 通用画布与端口：
  - 基础图配置：`src/pages/marketing/tasks/utils/canvas/x6Config.js:7–90`
  - 通用连接配置：`src/pages/marketing/tasks/utils/canvas/x6Config.js:101–180`
  - 端口组示例（上下布局，需统一为左右）：`src/pages/marketing/tasks/utils/canvas/x6Config.js:218–240`
- 可复用画布组件：
  - `src/pages/marketing/tasks/components/TaskFlowCanvas.vue:441–655`（Graph 初始化、连接点计算）
  - `src/pages/marketing/tasks/components/TaskFlowCanvasRefactored.vue:1228–1271`（端口配置工厂）
- 其他节点定义示例（需要统一左右）：
  - `src/pages/marketing/tasks/composables/canvas/useNodeManager.js:65–83`（底部 `out`）
  - `src/utils/nodeTypes.js:28–64`（底部 `out`）

## 修改方式确认
- 横版页面为唯一目标，无需兼容上下端口，一次性统一为左右布局
- 节点结构升级为“标题区+内容区”：内容区内以 Vue 组件形式声明输入/输出组件，端口数量与位置由组件自动推导，彻底解决端口与配置分支不一致问题
- 保留并上移“端口布局注册”到通用初始化组合，页面不再重复注册
- 把连接校验与连接点计算合并到通用配置，去重各页面的相似实现
- 页面层只负责数据与交互，图逻辑收敛到 `composables`/`utils`

## 实施步骤
### 步骤 0：建立“标题区+内容区”节点基组件
- 新建 `src/components/nodes/BaseNode.vue`：提供 `<header>`（标题区）与 `<main>`（内容区）插槽，统一节点外壳样式与交互态
- 新建 `src/components/nodes/InPort.vue`、`OutPort.vue`：
  - 自动在自身 `mounted` 时通过 `graph.addPort` 注册端口，端口 ID 与组件 `data-port-id` 保持一致
  - 暴露 `data-port-group='in|out'`、`data-row-index` 供 X6 识别，无需再算 `dy`
- 内容区采用 Flex 列布局，输出组件按配置顺序自上而下自然排列，组件中心即端口中心
- **内容文字展示改造**：
  - 原 `buildDisplayLines()` 返回的字符串数组（`rows`）不再直接生成 `row-${i}` 的 SVG `<text>`
  - 改为由 `OutPort` 组件内部渲染 `<span class="port-label">`，文字即组件文本，自动与端口对齐
  - 需同步更新：`buildDisplayLines` → 提供分支名称数组；节点组件 → 遍历数组渲染对应数量的 `OutPort`

### 步骤 1：收敛图初始化与端口布局注册
- 在 `src/pages/marketing/tasks/composables/useCanvasCore.js:41–125` 扩展通用 Graph 初始化：
  - 注册左右端口布局：`fixed-right-y` 与 `fixed-left-y`（从 `horizontal/index.vue:476–506` 迁移）
  - 合并连接配置：使用 `x6Config.getConnectingConfig()` 并统一 `validateConnection` 为 `out→in`
- 页面如 `horizontal/index.vue` 改用通用组合初始化，删除本地重复配置

### 步骤 2：统一端口方向与组（仅左右）
- 以 `portConfigFactoryHorizontal.js:34–168` 为标准：
  - 统一 `ports.groups.in` 到左侧、`ports.groups.out` 到右侧（无需兼容上下，直接替换）
- 废弃基于文本行的 `dy/rowIndex` 计算（`horizontal/index.vue:1469–1506`），改为由 `OutPort` 组件自身中心坐标自动注册端口

### 步骤 3：抽象端口工厂与转换
- 将端口工厂（水平）与 X6 端口转换封装：
  - 工厂：`portConfigFactoryHorizontal.js`（保留）
  - 转换：`useNodePorts.js:176–207`（标准化 `ports.items` 的 `group/args`）
- 其他页面与组件统一使用该组合，删除本地自定义 `ports.items` 构建

### 步骤 4：连接规则与交互一致化
- 在通用连接配置中强制：
  - 仅允许 `source.port.group==='out'` 且 `target.port.group==='in'`
  - 同一端口单连接、禁止自连接、保持水平关系（参考 `horizontal/index.vue:410–452`）
- 连接点计算收敛到 `TaskFlowCanvas.vue:531–607` 的实现，支持左右端口位置的精准 `x/y`

### 步骤 5：废弃旧节点定义，全面切换到新组件
- 删除 `useNodeManager.js:65–83`、`nodeTypes.js:28–64` 等旧节点定义
- 所有营销任务节点统一用 `vue-shape` 渲染，内部使用 `BaseNode` + `InPort`/`OutPort` 组合，端口数量与分支强一致
- **同步移除旧内容文字相关代码**：
  - 删除 `index.vue:760–770` 处 `markup` 数组中动态生成的 `row-${i}` SVG `<text>`
  - 删除 `index.vue:845–861` 处 `attrs` 中针对 `row-${i}` 的文本样式配置
  - 删除 `rebuildPortsFromDOM` 中依赖 `row-${i}` DOM 测量的逻辑（`1465–1471` 行）
  - 后续文字完全由 `OutPort` 组件内部渲染，不再依赖 SVG 文本节点

### 步骤 6：回归与验证
- 手动用例：
  - 添加多节点，检查 `out` 端口位于右、`in` 位于左
  - 只能 `out→in` 连线；同端口只能一条线；禁止自连
  - 文本行变化导致端口 `dy` 正确更新并保持在内容区域
- 自动化测试用例（新增）：
  1. **组件渲染一致性**
     - `BaseNode` 快照：标题区文字、内容区插槽、交互态样式与旧 SVG 节点像素级一致
     - `OutPort` 数量断言：给定分支配置，渲染出的组件数与 `rows.length` 相等
  2. **端口自动注册**
     - `InPort/OutPort` 挂载后，图实例中对应端口 ID 存在且 `group` 正确
     - 端口位置与组件中心坐标误差 ≤1 px（DOM 测量 vs `getBBox`）
  3. **连接规则**
     - 单元测试：`validateConnection` 只接受 `out→in`，拒绝自连、反向、多连
     - 集成测试：拖拽连线时，非法端口高亮为红色，合法端口为蓝色
  4. **数据兼容**
     - 老数据（仅 `outCount`）首次打开，自动渲染等量默认 `OutPort`，文字为“分支 1/2/3...”
     - 保存后再加载，配置与组件数保持一致，无丢失或多余端口
  5. **性能基准**
     - 100 个节点、300 个 `OutPort` 组件，首次渲染 ≤800 ms，内存占用 ≤60 MB
     - 滚动虚拟化后，视口外节点 DOM 节点数 ≤10 个
- 调试断言（运行时）：
  - 若 `OutPort` 挂载后 16 ms 内未检测到端口注册，控制台报错并高亮组件边框
  - 若分支数与组件数不一致，自动触发 `debugger` 断点，方便开发阶段快速定位

## 风险与兼容（仅针对横版页面，无历史页面负担）
- 风险1：当前仅存在横版页面，无需兼容上下端口；一次性统一为左右即可
- 风险2：新“输出组件”数量必须与现有 `outCount` 保持一致
  - 兼容策略：首次渲染时若缺失组件数据，则根据 `outCount` 自动生成等量的“默认输出组件”，确保老数据无缝展示
- 风险3：节点内 Vue 组件增多可能影响性能
  - 兼容策略：仅可视区域内的节点渲染真实组件，其余用空占位（虚拟化）

## 交付与变更范围（横版页面专属）
- 新增：`src/components/nodes/BaseNode.vue`、`InPort.vue`、`OutPort.vue`
- 主要修改：`horizontal/index.vue`、`useCanvasCore.js`、`x6Config.js`
- 清理删除：
  - `useNodeManager.js:65–83`、`nodeTypes.js:28–64` 等旧节点定义
  - `index.vue` 中 `row-${i}` SVG `<text>` 相关 `markup/attrs/DOM 测量` 代码段
- 结果：横版页面所有节点统一使用“标题区+内容区”结构，端口数量与分支配置强一致，样式扩展仅需改动 Vue 组件，无需再改 JS

如确认以上方案，我将按上述步骤开始代码重构并逐步提交修改。