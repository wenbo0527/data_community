# 外部数据服务模块详细设计

## 页面与组件
- 总览页：`src/pages/external-data-service/index.vue`（路由：/external-data-service 与风险域聚合入口）
- 组件：
  - 服务申请：`src/pages/external-data-service/components/ServiceApplication.vue`
  - 任务查询：`src/pages/external-data-service/components/TaskQuery.vue`
  - 结果展示：`src/pages/external-data-service/components/ResultDisplay.vue`
  - 陪伴服务：`src/pages/external-data-service/components/AccompanyService.vue`

## 路由与菜单
- 顶层入口与风险域聚合：`src/router/index.js` 对应 `external-data-service` 与 `/risk/external-data/service`
- 菜单项位于：`src/config/menuConfig.js` 的风险域与探索域分组下

## 数据模型与 API
- 任务与查询 API：`src/api/external/index.ts`、`src/api/external/task.ts`
- Store：`src/store/modules/external-data.ts`（任务中心与产品/评估/监控的共享数据源）

## 关键交互与行为
- 服务申请与审批流：在 `ServiceApplication.vue` 中进行表单录入与状态管理（提交后写入任务中心）。
- 任务查询与重试：在 `TaskQuery.vue` 中支持按产品/平台/时间过滤与重试策略。
- 结果展示：在 `ResultDisplay.vue` 中按报告/表格/图表形式呈现，并支持导出。
- 陪伴服务：在 `AccompanyService.vue` 中提供咨询与场景建议。

## 与其他模块的协作
- 与档案：
  - 档案页调整使用场景后，服务申请模板联动（通过统一跳转协议携带 `archiveId`、`product`）。
- 与评估：
  - 服务结果反哺评估数据（作为新的评估样本或监控数据源），在评估详情中呈现。
- 与监控：
  - 任务结果更新监控数据源，驱动燃尽与预警（监控页 `onMounted` 加载流程：`src/pages/exploration/external-data-analysis/external-data-monitor.vue:322–372`）。

## 统一跳转协议
- 由档案页封装方法传递：`src/pages/external-data-archive/index.vue:75–79,102,128,134,179,437–441`
- 统一参数：`archiveId`、`from`、`product`、`tab`

## 错误处理与观测
- 采用一致的 `Message` 通知与错误上报通道；任务查询页支持重试/取消。
- 后续可接入统一埋点与日志收集，追踪服务可用性与调用链路。

## 迭代与落地
- 打通服务结果到评估与监控的写回流程（Store 层事件触发）。
- 丰富任务状态机与失败恢复策略（指数退避重试、断点续传）。

## 设计原则与交互规范（基于 Arco Design）
- 明确的流程指引：服务申请使用步骤化表单（分步或分节），显示校验与进度；任务查询提供清晰筛选与状态标识。
- 即时与可见反馈：提交/重试/取消动作均显示 `Message` 与按钮 `loading`；长耗时操作展示 `Spin` 或进度条。
- 空/错/权限：查询为空显示 `a-empty`；错误 `Message.error` 并提供重试；无权限按钮禁用并配 Tooltip。
- 导出与审计：结果展示支持导出（CSV/JSON）并记录日志，下载失败提示重试。

## 详细事件与状态流（服务域）
- 服务申请：
  - 事件：`onServiceApplyOpen` 打开表单；`onServiceApplySubmit(form)` 提交；成功 `Message.success('已提交服务申请')` 并新增任务；失败 `Message.error`。
  - 校验：`a-form` 校验规则，错误字段标红并滚动定位；提交按钮 `loading`。
- 任务查询：
  - 事件：`onTaskFilterApply(filters)` 应用筛选；`onTaskReset` 重置；`onTaskRetry(id)`；`onTaskCancel(id)`；状态机：`pending/running/succeeded/failed/canceled`。
  - 反馈：操作后 `Message.success/info/error`；列表按钮根据状态禁用或显示进度。
- 结果展示：
  - 事件：`onResultView(id)` 加载报告/图表；`onResultExport(id, type)` 下载；成功 `Message.success('已导出')`；失败 `Message.error`。
- 陪伴服务：
  - 事件：`onConsultOpen` 打开咨询；`onConsultSubmit` 提交沟通需求；成功 `Message.success('已提交')`。

## 组件映射与状态
- 表单：`a-form` + 规则 + `Message`；列表：`a-table` + 状态标签；筛选：`a-select/a-input/a-date-picker`；按钮：`a-button`；弹窗：`a-modal/a-popconfirm`；抽屉：`a-drawer`。
- 加载/空/错误：`a-spin/a-skeleton/a-empty`；通知：`Message/Notification`；图表：结合 ECharts 或内置组件。
