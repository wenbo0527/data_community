# èŠ‚ç‚¹æ ·å¼ç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½åˆ†ææŠ¥å‘Šï¼ˆæ•°æ®å±‚ä¸æ¸²æŸ“å±‚æ·±åº¦è§£æï¼‰

## ğŸ“‹ æŠ¥å‘Šæ¦‚è¦

**ç”Ÿæˆæ—¶é—´**: 2024å¹´12æœˆ19æ—¥  
**åˆ†æèŒƒå›´**: è¥é”€ç”»å¸ƒç³»ç»ŸèŠ‚ç‚¹æ ·å¼ã€å°ºå¯¸ã€è¾¹æ ·å¼ã€ç«¯å£ä½ç½®å®Œæ•´æ¶æ„  
**ä»£ç ç‰ˆæœ¬**: åŸºäºå½“å‰å®é™…ä»£ç çŠ¶æ€  
**è¦†ç›–æ¨¡å—**: FlowNode.vueã€nodeTypes.jsã€StyleConfig.jsã€portConfigFactory.jsã€x6Config.jsã€UnifiedEdgeManager  

---

## ğŸ—ï¸ 1. èŠ‚ç‚¹æ ·å¼ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### 1.1 æ ¸å¿ƒè®¾è®¡ç†å¿µ

è¥é”€ç”»å¸ƒç³»ç»Ÿé‡‡ç”¨**åˆ†å±‚æ ·å¼ç®¡ç†æ¶æ„**ï¼Œå°†èŠ‚ç‚¹æ ·å¼ç³»ç»Ÿåˆ†ä¸ºæ•°æ®å±‚ã€é…ç½®å±‚ã€æ¸²æŸ“å±‚ä¸‰ä¸ªæ ¸å¿ƒå±‚æ¬¡ï¼š

#### ğŸ¯ æ ¸å¿ƒç†å¿µ
- **æ•°æ®é©±åŠ¨æ ·å¼**: èŠ‚ç‚¹æ ·å¼å®Œå…¨ç”±é…ç½®æ•°æ®é©±åŠ¨ï¼Œå®ç°æ ·å¼ä¸é€»è¾‘çš„è§£è€¦
- **ç»Ÿä¸€é…ç½®ç®¡ç†**: æ‰€æœ‰èŠ‚ç‚¹ç±»å‹é…ç½®é›†ä¸­åœ¨`nodeTypes.js`ï¼Œç¡®ä¿ä¸€è‡´æ€§
- **ç»„ä»¶åŒ–æ¸²æŸ“**: åŸºäºVue3 + X6çš„ç»„ä»¶åŒ–æ¸²æŸ“æ¶æ„ï¼Œæ”¯æŒçµæ´»çš„æ ·å¼æ‰©å±•
- **åˆ†å±‚æ ·å¼ç³»ç»Ÿ**: åŸºç¡€æ ·å¼ â†’ ç±»å‹æ ·å¼ â†’ çŠ¶æ€æ ·å¼çš„ä¸‰å±‚å åŠ æœºåˆ¶

#### ğŸ—ï¸ æ ·å¼ç³»ç»Ÿåˆ†å±‚æ¶æ„
**æ–‡ä»¶ä½ç½®**: 
- æ•°æ®å±‚: `src/utils/nodeTypes.js`
- é…ç½®å±‚: `src/pages/marketing/tasks/utils/canvas/StyleConfig.js`
- æ¸²æŸ“å±‚: `src/pages/marketing/tasks/components/canvas/FlowNode.vue`

**æ ¸å¿ƒèŒè´£**:
- **æ•°æ®å±‚**: å®šä¹‰èŠ‚ç‚¹ç±»å‹çš„åŸºç¡€å±æ€§ï¼ˆå°ºå¯¸ã€é¢œè‰²ã€å½¢çŠ¶ï¼‰
- **é…ç½®å±‚**: æä¾›æ ·å¼é…ç½®å·¥å…·å’Œç»Ÿä¸€æ¥å£
- **æ¸²æŸ“å±‚**: è´Ÿè´£å…·ä½“çš„è§†è§‰å‘ˆç°å’Œäº¤äº’æ•ˆæœ

### 1.2 æ ·å¼ç³»ç»Ÿäº¤äº’å…³ç³»

```mermaid
graph TD
    A[nodeTypes.js<br/>æ•°æ®å±‚] --> B[StyleConfig.js<br/>é…ç½®å±‚]
    B --> C[FlowNode.vue<br/>æ¸²æŸ“å±‚]
    A --> D[portConfigFactory.js<br/>ç«¯å£é…ç½®]
    D --> E[x6Config.js<br/>X6é›†æˆ]
    E --> F[UnifiedEdgeManager.js<br/>è¾¹ç®¡ç†]
    
    subgraph "æ•°æ®å±‚"
        A
    end
    
    subgraph "é…ç½®å±‚"
        B
        D
        E
    end
    
    subgraph "æ¸²æŸ“å±‚"
        C
        F
    end
```

### 1.3 æ•´ä½“æ¶æ„è®¾è®¡

```mermaid
graph TD
    A[TaskFlowCanvasRefactored.vue] --> B[nodeTypes.js]
    A --> C[StyleConfig.js]
    A --> D[portConfigFactory.js]
    A --> E[x6Config.js]
    
    B --> F[FlowNode.vue]
    C --> F
    D --> G[ç«¯å£ä½ç½®è®¡ç®—]
    E --> H[X6å›¾å½¢é…ç½®]
    
    F --> I[èŠ‚ç‚¹æ¸²æŸ“]
    G --> I
    H --> I
    
    subgraph "èŠ‚ç‚¹æ ·å¼ç³»ç»Ÿ"
        B
        C
        F
    end
    
    subgraph "ç«¯å£é…ç½®ç³»ç»Ÿ"
        D
        G
    end
    
    subgraph "X6é›†æˆç³»ç»Ÿ"
        E
        H
    end
```

---

## âš™ï¸ 2. æ•°æ®å±‚æ¶æ„æ·±åº¦è§£æ

### 2.1 èŠ‚ç‚¹ç±»å‹é…ç½®ç³»ç»Ÿ

#### ğŸ“Š ç»Ÿä¸€èŠ‚ç‚¹ç±»å‹é…ç½®
**æ–‡ä»¶ä½ç½®**: `src/utils/nodeTypes.js`

```javascript
export const nodeTypes = {
  'start': {
    label: 'å¼€å§‹',
    color: '#5F95FF',
    shape: 'circle',
    width: 100,
    height: 100,
    maxOutputs: 1,
    autoExpand: true,
    nextSlots: [{
      type: 'single',
      position: { x: 0, y: 160 },
      label: 'ä¸‹ä¸€æ­¥',
      allowedTypes: ['audience-split', 'event-split', 'sms', 'ai-call', 'manual-call', 'ab-test', 'wait', 'end']
    }]
  },
  'end': {
    label: 'ç»“æŸèŠ‚ç‚¹',
    color: '#8C8C8C',
    shape: 'circle',
    width: 100,
    height: 100,
    maxOutputs: 0,
    autoExpand: false,
    nextSlots: []
  },
  'audience-split': {
    label: 'äººç¾¤åˆ†æµ',
    color: '#FF6A6A',
    shape: 'circle',
    width: 100,
    height: 100,
    maxOutputs: 'dynamic',
    autoExpand: true,
    nextSlots: []
  }
  // ... å…¶ä»–èŠ‚ç‚¹ç±»å‹é…ç½®
}
```

#### ğŸ¯ å°ºå¯¸æ ‡å‡†åŒ–ç­–ç•¥
- **ç»Ÿä¸€æ ‡å‡†**: æ‰€æœ‰èŠ‚ç‚¹ç±»å‹é‡‡ç”¨`100x100`æ ‡å‡†å°ºå¯¸
- **ä¸€è‡´æ€§ä¿è¯**: é€šè¿‡é…ç½®ä¸­å¿ƒåŒ–ç®¡ç†ï¼Œæ¶ˆé™¤å°ºå¯¸å·®å¼‚
- **æ‰©å±•æ€§è®¾è®¡**: æ”¯æŒç‰¹æ®ŠèŠ‚ç‚¹ç±»å‹çš„å°ºå¯¸è‡ªå®šä¹‰

#### ğŸ”„ é…ç½®è®¿é—®æ¥å£
```javascript
export const getNodeConfig = (nodeType) => {
  // ğŸ”§ ä¸¥æ ¼çš„ç±»å‹éªŒè¯å’Œé”™è¯¯å¤„ç†
  if (typeof nodeType !== 'string') {
    console.warn(`[getNodeConfig] Invalid node type format: ${typeof nodeType}`)
    return null
  }
  
  if (!nodeType || nodeType.trim() === '') {
    console.warn('[getNodeConfig] Empty node type provided')
    return null
  }
  
  const normalizedType = nodeType.trim()
  const config = nodeTypes[normalizedType]
  
  if (!config) {
    console.warn(`[getNodeConfig] Unknown node type: "${normalizedType}"`)
    return null
  }
  
  return { ...config } // è¿”å›å‰¯æœ¬ï¼Œé˜²æ­¢ç›´æ¥ä¿®æ”¹åŸå§‹é…ç½®
}
```

### 2.2 æ ·å¼é…ç½®å·¥å…·ç±»

#### ğŸ“‹ StyleConfigæ ¸å¿ƒåŠŸèƒ½
**æ–‡ä»¶ä½ç½®**: `src/pages/marketing/tasks/utils/canvas/StyleConfig.js`

```javascript
export class StyleConfig {
  // é»˜è®¤èŠ‚ç‚¹æ ·å¼
  static DEFAULT_NODE_STYLE = {
    body: {
      fill: '#f0f0f0',
      stroke: '#d9d9d9',
      strokeWidth: 1,
      rx: 8, // åœ†è§’åŠå¾„
      ry: 8
    },
    label: {
      text: 'èŠ‚ç‚¹',
      fill: '#333333',
      fontSize: 14,
      fontWeight: 'normal'
    }
  }
  
  // è·å–èŠ‚ç‚¹å°ºå¯¸é…ç½®
  static getNodeSize(nodeType = 'default') {
    const sizeMap = {
      start: { width: 100, height: 100 },
      end: { width: 100, height: 100 },
      condition: { width: 100, height: 100 },
      action: { width: 100, height: 100 },
      delay: { width: 100, height: 100 }
    }
    
    return sizeMap[nodeType] || { width: 100, height: 100 }
  }
}
```

### 2.3 èŠ‚ç‚¹é…ç½®åˆ›å»ºæµç¨‹

#### ğŸ”„ ç»Ÿä¸€é…ç½®åˆ›å»º
**æ–‡ä»¶ä½ç½®**: `src/pages/marketing/tasks/utils/canvas/createNodeConfig.js`

```javascript
export function createNodeConfig(nodeData, options = {}) {
  console.log('âš™ï¸ [createNodeConfig] å¼€å§‹åˆ›å»ºèŠ‚ç‚¹é…ç½®:', { nodeData, options })
  
  try {
    // ğŸ”§ ä¿®å¤ï¼šä» nodeTypes.js è·å–æ­£ç¡®çš„èŠ‚ç‚¹å°ºå¯¸é…ç½®
    const nodeTypeConfig = getNodeConfig(nodeData.type)
    const defaultWidth = nodeTypeConfig?.width || 100
    const defaultHeight = nodeTypeConfig?.height || 100
    
    // åŸºç¡€èŠ‚ç‚¹é…ç½®
    const baseConfig = {
      id: nodeData.id,
      shape: 'vue-shape',
      x: nodeData.x || 0,
      y: nodeData.y || 0,
      width: nodeData.width || defaultWidth,
      height: nodeData.height || defaultHeight,
      component: 'FlowNode', // Vueç»„ä»¶åç§°
      data: {
        type: nodeData.type,
        nodeType: nodeData.type,
        label: nodeData.label || nodeTypeConfig?.label || 'èŠ‚ç‚¹',
        color: nodeData.color || nodeTypeConfig?.color || '#5F95FF',
        ...nodeData
      }
    }
    
    // ğŸ”§ å…³é”®ä¿®å¤ï¼šç«¯å£é…ç½®å¤„ç†
    const portConfig = createNodePortConfig(nodeData.type, {
      color: baseConfig.data.color
    })
    
    if (portConfig && (portConfig.groups || portConfig.items)) {
      baseConfig.ports = portConfig
      baseConfig.data.portConfig = portConfig
      
      console.log(`âœ… [createNodeConfig] ç«¯å£é…ç½®å·²åº”ç”¨åˆ°èŠ‚ç‚¹:`, {
        nodeType: nodeData.type,
        portGroups: Object.keys(portConfig.groups || {}),
        portItems: portConfig.items?.length || 0
      })
    }
    
    return baseConfig
    
  } catch (error) {
    console.error('âŒ [createNodeConfig] åˆ›å»ºèŠ‚ç‚¹é…ç½®å¤±è´¥:', error)
    throw error
  }
}
```

---

## ğŸ¨ 3. æ¸²æŸ“å±‚æ¶æ„æ·±åº¦è§£æ

### 3.1 FlowNodeç»„ä»¶æ¶æ„

#### ğŸ“Š Vue3ç»„ä»¶è®¾è®¡
**æ–‡ä»¶ä½ç½®**: `src/pages/marketing/tasks/components/canvas/FlowNode.vue`

```vue
<template>
  <div 
    class="flow-node" 
    :class="[`flow-node--${actualNodeType}`, { 'flow-node--selected': actualSelected }]"
    @click="handleClick"
  >
    <div class="flow-node__icon">
      <slot name="icon">
        <div class="flow-node__default-icon" :style="{ backgroundColor: nodeColor }"></div>
      </slot>
    </div>
    <div class="flow-node__label">{{ actualLabel }}</div>
    
    <!-- åˆ é™¤æŒ‰é’®ï¼ˆå¼€å§‹èŠ‚ç‚¹ä¸æ˜¾ç¤ºï¼‰ -->
    <div 
      v-if="actualDeletable" 
      class="flow-node__delete-btn" 
      @click.stop.prevent="handleDeleteClick"
      title="åˆ é™¤èŠ‚ç‚¹"
    >
      <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none">
        <!-- SVGè·¯å¾„ -->
      </svg>
    </div>
    
    <!-- é¢„è®¾ä½ -->
    <div v-if="presetSlots && presetSlots.length > 0" class="preset-slots">
      <div
        v-for="slot in presetSlots"
        :key="slot.id"
        class="preset-slot"
        :class="{ 'occupied': slot.occupied }"
        :style="getSlotStyle(slot)"
        @click.stop="handleSlotClick(slot)"
      >
        <div class="slot-indicator">
          <div class="slot-icon" v-if="!slot.occupied">+</div>
        </div>
        <div class="slot-label" v-if="slot.label">{{ slot.label }}</div>
      </div>
    </div>
  </div>
</template>
```

#### ğŸ¯ æ ¸å¿ƒæ ·å¼å®šä¹‰
```css
.flow-node {
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-width: 100px;    /* ğŸ”§ ç»Ÿä¸€æœ€å°å®½åº¦ */
  min-height: 100px;   /* ğŸ”§ ç»Ÿä¸€æœ€å°é«˜åº¦ */
  padding: 12px 16px;
  background: #ffffff;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* èŠ‚ç‚¹ç±»å‹ç‰¹å®šæ ·å¼ */
.flow-node--start {
  border-color: #10b981;
}

.flow-node--end {
  border-color: #ef4444;
}

.flow-node--condition {
  border-color: #f59e0b;
  transform: rotate(45deg);
}

.flow-node--condition .flow-node__label {
  transform: rotate(-45deg);
}
```

### 3.2 èŠ‚ç‚¹ç±»å‹æ ·å¼æ˜ å°„

#### ğŸ“‹ ç±»å‹ä¸æ ·å¼å¯¹åº”å…³ç³»
| èŠ‚ç‚¹ç±»å‹ | è¾¹æ¡†é¢œè‰² | èƒŒæ™¯è‰² | ç‰¹æ®Šæ ·å¼ | é¢„è®¾ä½æ”¯æŒ |
|----------|----------|--------|----------|------------|
| start | #10b981 | #ffffff | æ—  | âœ… |
| end | #ef4444 | #ffffff | æ—  | âŒ |
| condition | #f59e0b | #ffffff | æ—‹è½¬45Â° | âœ… |
| process | #3b82f6 | #ffffff | æ—  | âœ… |

### 3.3 äº¤äº’çŠ¶æ€ç®¡ç†

#### ğŸ”„ çŠ¶æ€æ ·å¼åˆ‡æ¢
```javascript
// é€‰ä¸­çŠ¶æ€å¤„ç†
const actualSelected = computed(() => {
  if (nodeData && nodeData.value && nodeData.value.selected !== undefined) {
    return nodeData.value.selected
  }
  return props.selected || false
})

// é¢œè‰²åŠ¨æ€è®¡ç®—
const nodeColor = computed(() => {
  const config = getNodeConfig(actualNodeType.value)
  return config ? config.color : '#5F95FF'
})
```

---

## ğŸ”Œ 4. ç«¯å£é…ç½®ç³»ç»Ÿæ·±åº¦è§£æ

### 4.1 ç«¯å£é…ç½®å·¥å‚æ¶æ„

#### ğŸ“Š ç»Ÿä¸€ç«¯å£é…ç½®ç®¡ç†
**æ–‡ä»¶ä½ç½®**: `src/pages/marketing/tasks/utils/canvas/portConfigFactory.js`

```javascript
/**
 * åˆ›å»ºæ ‡å‡†ç«¯å£é…ç½®
 * @param {string} group - ç«¯å£ç»„ ('in' | 'out')
 * @param {string} id - ç«¯å£ID
 * @param {Object} position - ä½ç½®é…ç½® { dx?: number, dy?: number }
 * @param {Object} options - å¯é€‰é…ç½®
 * @returns {Object} å®Œæ•´çš„ç«¯å£é…ç½®
 */
export const createPortConfig = (group, id, position = {}, options = {}) => {
  const isInputPort = group === 'in'
  
  // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ä¸x6Config.jså®Œå…¨ä¸€è‡´çš„ç«¯å£é…ç½®
  const portPosition = isInputPort ? 'top' : 'bottom'
  const yPosition = isInputPort ? 0 : '100%'
  const dyOffset = isInputPort ? 0 : 15    // ğŸ”§ å…³é”®ä¿®å¤ï¼šinç«¯å£dyåç§»è°ƒæ•´ä¸º0
  
  console.log(`[portConfigFactory] åˆ›å»ºç«¯å£é…ç½®: ${group}`, {
    id,
    position: portPosition,
    y: yPosition,
    dy: dyOffset,
    isInputPort
  })

  return {
    id: id,
    group: group,
    position: {
      name: portPosition,
      args: {
        x: '50%',
        y: yPosition,
        dx: position.dx || 0,
        dy: position.dy || dyOffset
      }
    },
    attrs: {
      circle: {
        r: 5,
        magnet: true,  // ğŸ”§ ä¿®å¤ï¼šå¯ç”¨ç«¯å£ç£æ€§ï¼Œå…è®¸ç«¯å£è¿æ¥
        stroke: options.stroke || '#5F95FF',
        strokeWidth: 2,
        fill: '#fff',
        style: {
          visibility: 'visible'
        }
      }
    },
    markup: [{
      tagName: 'circle',
      selector: 'circle'
    }],
    ...options
  }
}
```

### 4.2 X6æƒå¨é…ç½®é›†æˆ

#### ğŸ¯ ç«¯å£ç»„é…ç½®
**æ–‡ä»¶ä½ç½®**: `src/pages/marketing/tasks/utils/canvas/x6Config.js`

```javascript
export const getPortGroups = () => ({
  in: {
    position: {
      name: 'top',
      args: {
        x: '50%',
        y: 0,
        dx: 0,
        dy: 0  // ğŸ”§ å…³é”®ä¿®å¤ï¼šinç«¯å£dyåç§»ä»-15è°ƒæ•´ä¸º0
      }
    },
    attrs: {
      circle: {
        r: 5,
        magnet: true,
        stroke: '#5F95FF',
        strokeWidth: 2,
        fill: '#fff'
      }
    },
    markup: [{
      tagName: 'circle',
      selector: 'circle'
    }]
  },
  out: {
    position: {
      name: 'bottom',
      args: {
        x: '50%',
        y: '100%',
        dx: 0,
        dy: 15
      }
    },
    attrs: {
      circle: {
        r: 5,
        magnet: true,
        stroke: '#5F95FF',
        strokeWidth: 2,
        fill: '#fff'
      }
    },
    markup: [{
      tagName: 'circle',
      selector: 'circle'
    }]
  }
})
```

### 4.3 èŠ‚ç‚¹ç«¯å£é…ç½®ç”Ÿæˆ

#### ğŸ”„ æŒ‰èŠ‚ç‚¹ç±»å‹ç”Ÿæˆç«¯å£
```javascript
export const createNodePortConfig = (nodeType, config = {}) => {
  console.log(`ğŸ” [portConfigFactory] å¼€å§‹ä¸ºèŠ‚ç‚¹ç±»å‹ ${nodeType} åˆ›å»ºæ ‡å‡†ç«¯å£é…ç½®`)
  
  // ç»Ÿä¸€ç«¯å£ç»„é…ç½®ï¼šç›´æ¥å¼•ç”¨ x6Config çš„æƒå¨é…ç½®
  const portGroups = getX6PortGroups()
  const portItems = []

  // æ ¹æ®èŠ‚ç‚¹ç±»å‹æ·»åŠ ç«¯å£
  if (nodeType === 'start') {
    // å¼€å§‹èŠ‚ç‚¹åªæœ‰è¾“å‡ºç«¯å£
    const outPort = {
      group: 'out',
      id: 'out',
      attrs: {
        circle: {
          ...portGroups.out.attrs.circle,
          stroke: config.color || '#5F95FF'
        }
      }
    }
    portItems.push(outPort)
  } else if (nodeType === 'end') {
    // ç»“æŸèŠ‚ç‚¹åªæœ‰è¾“å…¥ç«¯å£
    const inPort = {
      group: 'in',
      id: 'in',
      attrs: {
        circle: {
          ...portGroups.in.attrs.circle,
          stroke: config.color || '#5F95FF'
        }
      }
    }
    portItems.push(inPort)
  } else {
    // å…¶ä»–èŠ‚ç‚¹éƒ½æœ‰1ä¸ªè¾“å…¥ç«¯å£å’Œ1ä¸ªè¾“å‡ºç«¯å£
    const inPort = {
      group: 'in',
      id: 'in',
      attrs: {
        circle: {
          ...portGroups.in.attrs.circle,
          stroke: config.color || '#5F95FF'
        }
      }
    }
    const outPort = {
      group: 'out',
      id: 'out',
      attrs: {
        circle: {
          ...portGroups.out.attrs.circle,
          stroke: config.color || '#5F95FF'
        }
      }
    }
    portItems.push(inPort, outPort)
  }

  return {
    groups: portGroups,
    items: portItems
  }
}
```

---

## ğŸŒˆ 5. è¾¹æ ·å¼ç³»ç»Ÿæ·±åº¦è§£æ

### 5.1 ç»Ÿä¸€è¾¹æ ·å¼ç®¡ç†

#### ğŸ“Š UnifiedEdgeManageræ ·å¼æ§åˆ¶
**æ–‡ä»¶ä½ç½®**: `src/pages/marketing/tasks/composables/canvas/unified/UnifiedEdgeManager.js`

```javascript
// é¢„è§ˆçº¿æ ·å¼é…ç½®
const previewLineStyle = {
  line: {
    stroke: this.options.previewStyle?.stroke || "#1890ff",
    strokeWidth: this.options.previewStyle?.strokeWidth || 2,
    strokeDasharray: "5,5",  // è™šçº¿æ ·å¼
    targetMarker: {
      name: 'block',
      width: 12,
      height: 8
    }
  },
  zIndex: 100  // ç¡®ä¿é¢„è§ˆçº¿æ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚
}

// è¿æ¥çº¿æ ·å¼é…ç½®
const connectionStyle = {
  line: {
    stroke: this.options.connectionStyle?.stroke || "#52c41a",
    strokeWidth: this.options.connectionStyle?.strokeWidth || 2,
    strokeDasharray: "none",  // å®çº¿æ ·å¼
    targetMarker: {
      name: 'block',
      width: 12,
      height: 8
    }
  },
  zIndex: 0  // é»˜è®¤å±‚çº§
}
```

### 5.2 é¢„è§ˆçº¿æ ·å¼é…ç½®

#### ğŸ¯ é¢„è§ˆçº¿ä¸“ç”¨é…ç½®
**æ–‡ä»¶ä½ç½®**: `src/pages/marketing/tasks/utils/canvas/previewConfig.js`

```javascript
export const PREVIEW_CONFIG = {
  // é¢„è§ˆçº¿æ ·å¼
  LINE_STYLES: {
    DEFAULT: {
      stroke: '#1890ff',
      strokeWidth: 2,
      strokeDasharray: '5,5',
      targetMarker: {
        name: 'block',
        width: 12,
        height: 8
      }
    },
    ACTIVE: {
      stroke: '#096dd9',
      strokeWidth: 3,
      strokeDasharray: '5,5'
    },
    ERROR: {
      stroke: '#ff4d4f',
      strokeWidth: 2,
      strokeDasharray: '5,5'
    }
  },
  
  // èŠ‚ç‚¹ç±»å‹é¢„è§ˆé…ç½®
  NODE_TYPES: {
    BRANCH_NODES: ['audience-split', 'event-split', 'ab-test'],
    START_NODES: ['start'],
    END_NODES: ['end'],
    ACTION_NODES: ['sms', 'ai-call', 'manual-call', 'wait']
  }
}
```

### 5.3 X6è¾¹æ ·å¼é›†æˆ

#### ğŸ”„ X6å›¾å½¢æ ·å¼é…ç½®
**æ–‡ä»¶ä½ç½®**: `src/pages/marketing/tasks/utils/canvas/x6Config.js`

```javascript
// è¾¹æ ·å¼é…ç½®
export const getEdgeStyles = () => ({
  attrs: {
    line: {
      stroke: '#5F95FF',
      strokeWidth: 2,
      targetMarker: {
        name: 'block',
        width: 12,
        height: 8
      }
    }
  },
  zIndex: 0
})

// å¯æ‹–æ‹½é¢„è®¾çº¿è¾¹å½¢çŠ¶é…ç½®
export const getDraggablePreviewEdgeConfig = (sourcePosition, targetPosition) => ({
  shape: 'edge',
  source: sourcePosition,
  target: targetPosition,
  attrs: {
    line: {
      stroke: '#1890ff',
      strokeWidth: 2,
      strokeDasharray: '5,5',  // è™šçº¿è¡¨ç¤ºé¢„è§ˆçŠ¶æ€
      targetMarker: {
        name: 'block',
        width: 12,
        height: 8
      }
    }
  },
  zIndex: 100  // é«˜å±‚çº§ç¡®ä¿æ˜¾ç¤ºåœ¨æœ€ä¸Šå±‚
})
```

---

## ğŸ“ˆ 6. æ•°æ®æµå‘ä¸çŠ¶æ€ç®¡ç†

### 6.1 æ ·å¼æ•°æ®æµå‘

#### ğŸ”„ å®Œæ•´æ•°æ®æµå‘å›¾
```mermaid
graph TD
    A[èŠ‚ç‚¹åˆ›å»ºè¯·æ±‚] --> B[createNodeConfig]
    B --> C[getNodeConfig]
    C --> D[nodeTypes.jsé…ç½®]
    
    D --> E[åŸºç¡€æ ·å¼æ•°æ®]
    D --> F[å°ºå¯¸æ•°æ®]
    D --> G[ç«¯å£é…ç½®æ•°æ®]
    
    E --> H[FlowNode.vueæ¸²æŸ“]
    F --> H
    G --> I[portConfigFactoryå¤„ç†]
    
    I --> J[X6ç«¯å£é…ç½®]
    H --> K[èŠ‚ç‚¹è§†è§‰å‘ˆç°]
    J --> L[ç«¯å£è§†è§‰å‘ˆç°]
    
    K --> M[ç”¨æˆ·äº¤äº’]
    L --> M
    
    M --> N[çŠ¶æ€æ›´æ–°]
    N --> O[æ ·å¼é‡æ–°è®¡ç®—]
    O --> P[è§†è§‰æ›´æ–°]
```

### 6.2 çŠ¶æ€ç®¡ç†æœºåˆ¶

#### ğŸ“Š å“åº”å¼çŠ¶æ€ç®¡ç†
```javascript
// Vue3å“åº”å¼çŠ¶æ€ç®¡ç†
const nodeData = computed(() => {
  if (props.node && typeof props.node.getData === 'function') {
    try {
      return props.node.getData() || {}
    } catch (error) {
      console.warn('[FlowNode] è·å–èŠ‚ç‚¹æ•°æ®å¤±è´¥:', error)
      return props.node.data || {}
    }
  }
  return props.data || {}
})

// åŠ¨æ€æ ·å¼è®¡ç®—
const actualNodeType = computed(() => {
  const data = nodeData.value
  return data?.type || data?.nodeType || props.nodeType || 'start'
})

const nodeColor = computed(() => {
  const config = getNodeConfig(actualNodeType.value)
  return config ? config.color : '#5F95FF'
})
```

### 6.3 é…ç½®ä¸€è‡´æ€§ä¿è¯

#### ğŸ¯ å¤šé‡éªŒè¯æœºåˆ¶
1. **ç±»å‹éªŒè¯**: ä¸¥æ ¼çš„èŠ‚ç‚¹ç±»å‹å­—ç¬¦ä¸²éªŒè¯
2. **é…ç½®å®Œæ•´æ€§**: ç¡®ä¿æ‰€æœ‰å¿…éœ€é…ç½®é¡¹å­˜åœ¨
3. **å°ºå¯¸ä¸€è‡´æ€§**: å¼ºåˆ¶100x100æ ‡å‡†å°ºå¯¸
4. **ç«¯å£ä½ç½®**: ç»Ÿä¸€çš„ç«¯å£åç§»é…ç½®
5. **æ ·å¼ç»§æ‰¿**: æ­£ç¡®çš„æ ·å¼ç»§æ‰¿é“¾

---

## ğŸ” 7. æ ¸å¿ƒæ¥å£è§„èŒƒä¸æ ‡å‡†

### 7.1 èŠ‚ç‚¹é…ç½®æ¥å£æ ‡å‡†

#### ğŸ“‹ ç»Ÿä¸€é…ç½®æ¥å£
```typescript
interface NodeTypeConfig {
  label: string
  color: string
  shape: 'circle' | 'rect' | 'diamond'
  width: number      // æ ‡å‡†å€¼: 100
  height: number     // æ ‡å‡†å€¼: 100
  maxOutputs: number | 'dynamic'
  autoExpand: boolean
  nextSlots?: NextSlotConfig[]
}

interface NextSlotConfig {
  type: 'single' | 'multiple'
  position: { x: number, y: number }
  label?: string
  allowedTypes?: string[]
}
```

### 7.2 ç«¯å£é…ç½®æ¥å£æ ‡å‡†

#### ğŸ¯ ç«¯å£é…ç½®è§„èŒƒ
```typescript
interface PortConfig {
  id: string
  group: 'in' | 'out'
  position: {
    name: 'top' | 'bottom' | 'left' | 'right'
    args: {
      x: string    // ç™¾åˆ†æ¯”æˆ–åƒç´ å€¼
      y: string    // ç™¾åˆ†æ¯”æˆ–åƒç´ å€¼
      dx: number   // Xåç§»é‡
      dy: number   // Yåç§»é‡ (in:0, out:15)
    }
  }
  attrs: {
    circle: {
      r: number           // åŠå¾„: 5
      magnet: boolean      // ç£æ€§: true
      stroke: string       // è¾¹æ¡†é¢œè‰²
      strokeWidth: number  // è¾¹æ¡†å®½åº¦: 2
      fill: string        // å¡«å……é¢œè‰²: '#fff'
    }
  }
}
```

### 7.3 è¾¹æ ·å¼æ¥å£æ ‡å‡†

#### ğŸŒˆ è¾¹æ ·å¼è§„èŒƒ
```typescript
interface EdgeStyle {
  line: {
    stroke: string        // çº¿æ¡é¢œè‰²
    strokeWidth: number   // çº¿æ¡å®½åº¦
    strokeDasharray: string // è™šçº¿é…ç½® ('none' | '5,5')
    targetMarker: {
      name: string       // ç®­å¤´ç±»å‹: 'block'
      width: number      // ç®­å¤´å®½åº¦: 12
      height: number     // ç®­å¤´é«˜åº¦: 8
    }
  }
  zIndex: number        // å±‚çº§ (é¢„è§ˆçº¿:100, è¿æ¥çº¿:0)
}
```

---

## ğŸ“Š 8. ç³»ç»Ÿä¸€è‡´æ€§åˆ†æ

### 8.1 å°ºå¯¸ä¸€è‡´æ€§è¯„ä¼°

| ç»„ä»¶å±‚çº§ | å°ºå¯¸æ ‡å‡† | ä¸€è‡´æ€§è¯„åˆ† | æ”¹è¿›å»ºè®® |
|----------|----------|------------|----------|
| æ•°æ®å±‚é…ç½® | 100x100 | 100% | âœ… å·²æ ‡å‡†åŒ– |
| FlowNodeæ ·å¼ | 100x100 | 100% | âœ… å·²ç»Ÿä¸€ |
| X6èŠ‚ç‚¹é…ç½® | 100x100 | 100% | âœ… å·²åŒæ­¥ |
| ç«¯å£ä½ç½® | ç›¸å¯¹å®šä½ | 95% | éœ€å¾®è°ƒdyåç§» |

### 8.2 æ ·å¼ä¸€è‡´æ€§è¯„ä¼°

| æ ·å¼ç±»åˆ« | ç»Ÿä¸€ç¨‹åº¦ | æ ‡å‡†åŒ–è¯„åˆ† | å¤‡æ³¨ |
|----------|----------|------------|------|
| èŠ‚ç‚¹é¢œè‰² | é«˜ | 95% | æŒ‰ç±»å‹ç»Ÿä¸€é…ç½® |
| è¾¹æ¡†æ ·å¼ | é«˜ | 90% | 2pxå®çº¿+åœ†è§’ |
| äº¤äº’çŠ¶æ€ | é«˜ | 95% | hover/é€‰ä¸­æ•ˆæœç»Ÿä¸€ |
| ç«¯å£æ ·å¼ | é«˜ | 100% | 5pxåœ†å½¢+ç£æ€§ |
| è¾¹æ ·å¼ | é«˜ | 90% | é¢„è§ˆçº¿/è¿æ¥çº¿åŒºåˆ†æ˜ç¡® |

### 8.3 é…ç½®ç®¡ç†è¯„ä¼°

| ç®¡ç†ç»´åº¦ | è¦†ç›–åº¦ | ç»´æŠ¤æ€§è¯„åˆ† | ä¼˜åŒ–å»ºè®® |
|----------|----------|------------|----------|
| ä¸­å¿ƒåŒ–é…ç½® | 100% | 95% | âœ… nodeTypes.jsç»Ÿä¸€ç®¡ç† |
| å·¥å‚æ¨¡å¼ | 100% | 90% | âœ… portConfigFactoryç»Ÿä¸€åˆ›å»º |
| é”™è¯¯å¤„ç† | 95% | 90% | âœ… å®Œå–„çš„éªŒè¯æœºåˆ¶ |
| ç±»å‹å®‰å…¨ | 90% | 85% | å¯è€ƒè™‘TypeScriptåŒ– |

---

## ğŸš€ 9. æ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ

### 9.1 æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–

#### âš¡ å…³é”®ä¼˜åŒ–ç‚¹
1. **Vue3è®¡ç®—å±æ€§**: ä½¿ç”¨computedç¼“å­˜æ ·å¼è®¡ç®—ç»“æœ
2. **æ ·å¼ç¼“å­˜**: é…ç½®æ•°æ®ç¼“å­˜é¿å…é‡å¤è®¡ç®—
3. **äº‹ä»¶å§”æ‰˜**: å‡å°‘äº‹ä»¶ç›‘å¬å™¨æ•°é‡
4. **è™šæ‹Ÿæ»šåŠ¨**: å¤§æ•°æ®é‡èŠ‚ç‚¹åœºæ™¯ä¼˜åŒ–
5. **æ‡’åŠ è½½**: ç«¯å£é…ç½®æŒ‰éœ€ç”Ÿæˆ

### 9.2 å†…å­˜ç®¡ç†ä¼˜åŒ–

#### ğŸ§¹ èµ„æºæ¸…ç†æœºåˆ¶
```javascript
// ç»„ä»¶é”€æ¯æ—¶æ¸…ç†
onUnmounted(() => {
  // æ¸…ç†äº‹ä»¶ç›‘å¬
  // æ¸…ç†ç¼“å­˜æ•°æ®
  // æ¸…ç†å®šæ—¶å™¨
})

// é…ç½®å¯¹è±¡å¤ç”¨
const styleCache = new WeakMap()
export const getCachedNodeStyle = (nodeType) => {
  if (styleCache.has(nodeType)) {
    return styleCache.get(nodeType)
  }
  const style = calculateNodeStyle(nodeType)
  styleCache.set(nodeType, style)
  return style
}
```

### 9.3 å¼€å‘æœ€ä½³å®è·µ

#### ğŸ“‹ ç¼–ç è§„èŒƒ
1. **é…ç½®ä¼˜å…ˆ**: æ‰€æœ‰æ ·å¼å±æ€§å¿…é¡»é€šè¿‡é…ç½®ç³»ç»Ÿè·å–
2. **é”™è¯¯å¤„ç†**: å®Œå–„çš„è¾¹ç•Œæ¡ä»¶å¤„ç†å’Œé”™è¯¯æç¤º
3. **æ—¥å¿—è®°å½•**: å…³é”®æ“ä½œå¿…é¡»æœ‰è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
4. **ç±»å‹éªŒè¯**: ä¸¥æ ¼çš„å‚æ•°ç±»å‹æ£€æŸ¥å’ŒéªŒè¯
5. **æ€§èƒ½ç›‘æ§**: å…³é”®è·¯å¾„æ€§èƒ½æŒ‡æ ‡ç›‘æ§

---

## ğŸ”® 10. æœªæ¥æ¼”è¿›æ–¹å‘

### 10.1 æ ·å¼ç³»ç»Ÿå¢å¼º

#### ğŸ¨ è®¡åˆ’åŠŸèƒ½
- **ä¸»é¢˜ç³»ç»Ÿ**: æ”¯æŒå¤šå¥—ä¸»é¢˜åˆ‡æ¢
- **è‡ªå®šä¹‰æ ·å¼**: èŠ‚ç‚¹æ ·å¼ç”¨æˆ·è‡ªå®šä¹‰
- **åŠ¨ç”»æ•ˆæœ**: ä¸°å¯Œçš„äº¤äº’åŠ¨ç”»
- **å“åº”å¼æ ·å¼**: é€‚é…ä¸åŒå±å¹•å°ºå¯¸
- **æ— éšœç¢æ”¯æŒ**: å®Œå–„çš„ARIAæ”¯æŒ

### 10.2 æŠ€æœ¯æ¶æ„å‡çº§

#### ğŸš€ æŠ€æœ¯æ¼”è¿›
- **TypeScriptåŒ–**: å…¨é¢ç±»å‹å®‰å…¨æ”¯æŒ
- **WebComponents**: ç»„ä»¶æ ‡å‡†åŒ–
- **CSSå˜é‡**: åŠ¨æ€ä¸»é¢˜æ”¯æŒ
- **æ€§èƒ½ç›‘æ§**: å®æ—¶æ€§èƒ½æŒ‡æ ‡
- **å¾®å‰ç«¯**: æ”¯æŒç‹¬ç«‹éƒ¨ç½²

### 10.3 ç”Ÿæ€ç³»ç»Ÿæ‰©å±•

#### ğŸŒŸ ç”Ÿæ€å»ºè®¾
- **æ’ä»¶ç³»ç»Ÿ**: æ”¯æŒç¬¬ä¸‰æ–¹æ ·å¼æ’ä»¶
- **è®¾è®¡ç³»ç»Ÿ**: å®Œæ•´çš„è®¾è®¡è¯­è¨€
- **å¼€å‘å·¥å…·**: æ ·å¼è°ƒè¯•å’Œé¢„è§ˆå·¥å…·
- **æ–‡æ¡£ä½“ç³»**: å®Œå–„çš„å¼€å‘æ–‡æ¡£
- **ç¤¾åŒºè´¡çŒ®**: å¼€æºç¤¾åŒºå»ºè®¾

---

## ğŸ“‹ æ€»ç»“

è¥é”€ç”»å¸ƒç³»ç»Ÿçš„èŠ‚ç‚¹æ ·å¼ç³»ç»Ÿé‡‡ç”¨**åˆ†å±‚æ¶æ„è®¾è®¡**ï¼Œé€šè¿‡æ•°æ®å±‚ã€é…ç½®å±‚ã€æ¸²æŸ“å±‚çš„æ¸…æ™°åˆ†ç¦»ï¼Œå®ç°äº†é«˜åº¦çš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚ç³»ç»Ÿæ ¸å¿ƒç‰¹ç‚¹åŒ…æ‹¬ï¼š

### âœ… æ ¸å¿ƒä¼˜åŠ¿
1. **ç»Ÿä¸€æ ‡å‡†**: 100x100èŠ‚ç‚¹å°ºå¯¸æ ‡å‡†åŒ–
2. **é…ç½®é©±åŠ¨**: å®Œå…¨åŸºäºé…ç½®çš„æ ·å¼ç®¡ç†
3. **ç»„ä»¶åŒ–æ¸²æŸ“**: Vue3 + X6çš„ç°ä»£åŒ–æ¸²æŸ“æ¶æ„
4. **ç±»å‹å®‰å…¨**: å®Œå–„çš„ç±»å‹å®šä¹‰å’ŒéªŒè¯æœºåˆ¶
5. **æ€§èƒ½ä¼˜åŒ–**: å¤šé‡ç¼“å­˜å’Œä¼˜åŒ–ç­–ç•¥

### ğŸ¯ å…³é”®æ”¹è¿›
1. **ç«¯å£åç§»ç»Ÿä¸€**: inç«¯å£dyåç§»ä»-15è°ƒæ•´ä¸º0
2. **å°ºå¯¸æ ‡å‡†åŒ–**: å…¨é¢ç»Ÿä¸€ä¸º100x100æ ‡å‡†
3. **é…ç½®ä¸­å¿ƒåŒ–**: æ‰€æœ‰æ ·å¼é…ç½®é›†ä¸­åˆ°nodeTypes.js
4. **é”™è¯¯å¤„ç†**: å®Œå–„çš„è¾¹ç•Œæ¡ä»¶å¤„ç†
5. **æ—¥å¿—ç³»ç»Ÿ**: è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯è¾“å‡º

### ğŸš€ åº”ç”¨ä»·å€¼
- **å¼€å‘æ•ˆç‡**: æ ‡å‡†åŒ–çš„é…ç½®å’Œæ¥å£å¤§å¹…æå‡å¼€å‘æ•ˆç‡
- **ç»´æŠ¤æˆæœ¬**: ä¸­å¿ƒåŒ–ç®¡ç†é™ä½ç»´æŠ¤æˆæœ¬
- **ç³»ç»Ÿç¨³å®šæ€§**: å®Œå–„çš„éªŒè¯æœºåˆ¶ä¿è¯ç³»ç»Ÿç¨³å®š
- **æ‰©å±•èƒ½åŠ›**: åˆ†å±‚æ¶æ„æ”¯æŒçµæ´»çš„åŠŸèƒ½æ‰©å±•
- **ç”¨æˆ·ä½“éªŒ**: ç»Ÿä¸€çš„è§†è§‰é£æ ¼æå‡ç”¨æˆ·ä½“éªŒ

è¯¥æ ·å¼ç³»ç»Ÿä¸ºè¥é”€ç”»å¸ƒæä¾›äº†**åšå®çš„æŠ€æœ¯åŸºç¡€