# 风险域「特征中心—模型注册—模型回溯」完整方案评估

更新时间：2025-12-02

## 背景与目标
- 打通从「特征沉淀 → 模型注册 → 历史回溯」的闭环，统一数据契约、版本管理与执行链路。
- 面向产品：降低配置门槛、提升可见性与复现性；面向工程：契约驱动、DAG 编排、版本固化、可观测与审计。

## 范围与术语
- 特征中心：风险域离线特征的注册与维护，统一表元信息与字段属性。
- 模型注册：平台模型/本地模型统一落地，固化版本、入参绑定与 UDF。
- 模型回溯：以模型版本为核心，对历史样本执行模型，支持依赖上游模型输出的链式回溯。

## 产品方案综述
- 统一对象结构：
  - 特征对象：字段元信息（中文名、类型、默认值、加工逻辑、分类、上线时间）、所属表元信息（主键、分区）。
  - 模型对象：`name/code/serviceName/version`、`inputs/outputs`（类型/描述）、`pkFields`、`udfDefinition`、状态（上线/归档）。
  - 回溯任务：执行快照（样本表/模式/时间窗）、依赖图（DAG：节点与边）、入参映射（来源：样本/特征/上游输出）、执行配置（并发/重试/超时）、结果与日志。
- 三页统一交互：Collapse/Tab/Table；“新建”统一 a-dropdown 或主按钮；“详情”统一三页签（配置/进度/结果）。
- 自动化与校验：同名自动匹配、必要项强校验、依赖一致性检查（循环/版本/时间窗/主键）。

## 用户体验设计
- 特征中心（feature-center）：
  - 列表页：已注册优先、未注册可折叠；统计卡片（已注册/未注册数量）。
  - 快速注册：选择表后批量补全中文名、数据类型、默认值、加工逻辑、分类；支持 CSV 模板导入。
  - 元数据维护：编辑表类型/主键/分区；统一契约供模型与回溯引用。
- 模型注册（model-register）：
  - 平台模型拉取：选择服务/版本后自动填充基础信息、IO、`pkFields`。禁止手动新增 IO，仅做特征绑定。
  - 入参绑定：模型入参与特征中心已注册特征同名自动匹配；未匹配项手动选择；固化到版本。
  - 版本管理：同一模型支持“新建版本”，版本号自增；版本关联入参绑定与 UDF 快照。
- 模型回溯（model-backtrack）：
  - 基础信息：选择模式（单次/周期）、数据源/库/表；单次默认不强制观测日期，周期需要时间窗。
  - 必填映射：按模型 `pkFields ∪ cert_no` 生成必填列表，样本表同名自动匹配；未匹配项需补齐。
  - 入参匹配：目标为“特征中心已注册特征”（而非原始样本字段）；同名自动、手动可选；支持来源标记（样本/特征/上游输出）。
  - 依赖模型（完整版）：配置上游模型及版本，将下游入参映射到上游输出；详情页展示依赖图与节点级进度。

## 数据契约（Schema）
- 特征 Schema：
  - 字段：`{name, cnName, dataType, defaultValue, processingLogic, level1, level2, table, primaryKey, partitionFields, onlineTime, status}`
  - 表元：`{name, type, primaryKey, partitionFields, description}`
- 模型 Schema（平台/本地统一）：
  - 基础：`{serviceName|code, name, version, description, status}`
  - IO：`inputs:[{name,type,description}]`、`outputs:[{name,type,description}]`
  - 关键：`pkFields:[]`、`udfDefinition:{udfName, language, code}`
- 回溯任务 Schema：
  - 基础：`{mode, sourceType, dbName, tableName, table, dateRange, observeDate?}`
  - 映射：`requiredFieldMappings:[{field,target}]`、`inputMappings:[{input,target,source}]`
  - 依赖图：`nodes:[{id,serviceName,version,inputs,outputs}]`、`edges:[{from,to,mapping:[{fromOutput,toInput}]}]`
  - 执行：`{concurrency,retryPolicy,timeout}`
  - 结果：`{total,success,failed,samples:[{idx,output}],metrics}`

## 执行架构（DAG 编排）
- 建图：根据依赖模型配置形成 DAG；检查环路与非法依赖。
- 排序：拓扑排序；支持节点级并发（无依赖冲突时）。
- 输入：
  - 样本字段/特征中心/上游输出缓存三类来源统一适配到模型入参契约。
  - 时间窗对齐策略：统一主键（`pkFields` 与 `cert_no`）及观测日/分区字段对齐。
- 计算与落地：
  - 执行结果按主键+时间窗缓存在中间存储（或临时表）；供下游节点引用。
  - 高频上游输出沉淀为特征（可选），缩短链路与成本。
- 容错：节点级重试/超时；失败策略可选“跳过节点”或“终止任务”。

## 版本与复现
- 版本固定：依赖图中每个节点必须选择明确版本，记录到任务快照。
- 契约校验：类型/名称一致性；不一致给出转换建议（例如 cast）。
- 复跑与审计：详情页支持按快照复跑；日志含参数摘要、耗时、错误栈供审计。

## 可观测性与治理
- 详情页可视化：
  - 配置页签：显示样本源、映射、依赖图与版本。
  - 进度页签：按 DAG 节点展示状态与耗时；失败节点可查看错误。
  - 结果页签：统计指标与样例输出；支持筛选维度（节点/样本）。
- 治理规则：
  - 最大链路深度与节点数限制；超过阈值需审批或拆分任务。
  - 黑名单组合与循环依赖禁止；权限控制（模型/特征访问）。

## API 设计（前端 Mock 对齐）
- 特征中心：`listTables`、`getTableColumns`、`getTableMeta/setTableMeta`、`getRegisteredFields/getUnregisteredFields`、`batchRegisterFields`、`listDatabases/listTablesByDb`
- 模型注册：`listPlatformModels`、`getPlatformModel`、`downloadPlatformModelFile`、`createModelVersion`
- 模型回溯：`createBacktrack`、`getBacktracks`、`getBacktrackDetail`、`stopBacktrack`（完整版增加 `validateDependencies/estimateCost/previewMappings`）

## 页面改造与组件复用
- 统一使用 Arco 组件：`a-form/a-table/a-collapse/a-tabs/a-select/a-cascader/a-dropdown`
- 结构模板：四段结构（模型注册/回溯），三页签（详情页）。
- 统一交互：
  - “新建”入口一致；多页面统一“配置→校验→预览→提交”的节奏。
  - 移除无效操作（回溯不展示报告、批量、表格设置）。

## 现状与差距
- 已落地：
  - 回溯创建页：独立必填映射、入参匹配使用特征中心；日志增强；Mock 持久化（列表/详情/停止）。
  - 模型注册页：平台模型拉取与 `pkFields`，入参/出参统一；版本自增接口。
  - 特征中心：快速注册与批量导入；表元编辑；注册字段扩展属性持久化。
- 待补齐：
  - 依赖模型配置与 DAG 执行模拟；契约校验与时间窗对齐；任务成本评估与提示；特征沉淀向导。

## 风险与缓解
- 链路过深与性能：提供成本评估与预计算/沉淀建议，限制最大深度。
- 版本不兼容：引入契约校验与转换建议；执行前阻断不兼容配置。
- 数据一致性：统一主键与时间窗对齐；缺失与外连接策略明确。
- 权限与合规：按模型/特征授权；日志审计与敏感数据屏蔽。

## 里程碑与交付
- 第 1 周：契约统一与页面一致（已部分完成）。
- 第 2 周：依赖模型配置与 DAG 模拟；预检查与错误提示。
- 第 3 周：特征沉淀向导与成本评估；页面指引与引导。
- 第 4 周：治理与审计；权限与风险控制规则落地。

## 成本与收益评估
- 成本：页面改造（低）、契约与校验（中）、DAG 执行与缓存（中高）、治理与审计（中）。
- 收益：
  - 产品：配置更快、复现更稳、可视化更清晰。
  - 工程：契约化降低耦合、可观测提升定位效率、缓存沉淀降低执行成本。

## KPI 与监控
- 体验：入参自动匹配率、必填映射一次通过率、配置用时。
- 稳定：任务失败率、平均耗时、最长链路耗时、重试成功率。
- 复现：版本固定率、复跑一致性。
- 成本：缓存命中率、单位样本执行耗时与资源占用。

## 结论
方案以“契约统一 + DAG 编排 + 版本固化 + 可观测治理”为核心，能够在现有 Mock 与页面基础上平滑迭代到“完整版本”，既满足复杂回溯（含模型间依赖），又保持体验与工程可维护性。后续按里程碑逐步增强依赖配置、校验与成本评估，即可落地稳定的链式回溯能力。

