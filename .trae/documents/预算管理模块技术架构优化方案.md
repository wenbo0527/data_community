# 预算管理模块技术架构优化方案

## 1. 当前架构分析

### 1.1 现有架构问题
```
当前架构：
Vue3 + ArcoDesign + Pinia + MockJS
├── 问题1：数据模型过于简单，缺少关联关系
├── 问题2：无图表库，数据可视化能力缺失
├── 问题3：业务逻辑分散，缺少统一计算引擎
├── 问题4：预警机制不完整，缺少规则引擎
└── 问题5：性能优化考虑不足，无缓存机制
```

### 1.2 架构优化目标
- **数据完整性**：建立完整的数据模型和关联关系
- **可视化能力**：集成专业图表库，实现丰富的数据展示
- **业务智能**：构建预警规则引擎和计算框架
- **性能优化**：实现数据缓存和异步加载机制
- **用户体验**：优化交互设计和响应速度

## 2. 技术栈选型与升级

### 2.1 图表可视化方案

#### 推荐方案：Apache ECharts 5.4+
```typescript
// 安装依赖
npm install echarts vue-echarts

// 主要优势：
// 1. 丰富的图表类型（折线、柱状、饼图、仪表盘等）
// 2. 强大的交互能力（缩放、拖拽、数据筛选）
// 3. 优秀的性能表现（Canvas渲染，大数据量支持）
// 4. 完善的文档和社区支持
```

#### 备选方案：Chart.js 4.0+
```typescript
// 安装依赖
npm install chart.js vue-chartjs

// 适用场景：
// 1. 轻量级图表需求
// 2. 简单配置场景
// 3. 对包大小敏感的项目
```

### 2.2 数据计算引擎

#### 方案：集中式计算服务
```typescript
// src/composables/useBudgetCalculations.ts
export function useBudgetCalculations() {
  // 预算执行率计算
  const calculateExecutionRate = (used: number, total: number): number => {
    return total > 0 ? Number(((used / total) * 100).toFixed(2)) : 0;
  };

  // 预算偏差率计算
  const calculateVarianceRate = (actual: number, planned: number): number => {
    return planned > 0 ? Number(((actual - planned) / planned * 100).toFixed(2)) : 0;
  };

  // 成本增长率计算
  const calculateGrowthRate = (current: number, previous: number): number => {
    return previous > 0 ? Number(((current - previous) / previous * 100).toFixed(2)) : 0;
  };

  // 预算健康度评分
  const calculateHealthScore = (budget: Budget): number => {
    const executionRate = calculateExecutionRate(budget.usedAmount, budget.totalAmount);
    const remainingRatio = (budget.totalAmount - budget.usedAmount) / budget.totalAmount;
    
    let score = 100;
    
    // 执行率评分（理想执行率70-90%）
    if (executionRate > 90) score -= 20;
    else if (executionRate < 70) score -= (70 - executionRate) * 0.5;
    
    // 剩余预算评分
    if (remainingRatio < 0.1) score -= 30;
    else if (remainingRatio < 0.2) score -= 10;
    
    return Math.max(0, score);
  };

  return {
    calculateExecutionRate,
    calculateVarianceRate,
    calculateGrowthRate,
    calculateHealthScore
  };
}
```

### 2.3 预警规则引擎

#### 方案：可配置规则引擎
```typescript
// src/composables/useWarningRules.ts
export interface WarningRule {
  id: string;
  name: string;
  type: AlertType;
  level: AlertLevel;
  condition: (data: any) => boolean;
  message: (data: any) => string;
  enabled: boolean;
}

export function useWarningRules() {
  // 预警规则定义
  const warningRules = ref<WarningRule[]>([
    {
      id: 'budget-insufficient',
      name: '预算余额不足',
      type: AlertType.BUDGET_INSUFFICIENT,
      level: AlertLevel.CRITICAL,
      condition: (budget: Budget) => {
        return budget.remainingAmount < budget.totalAmount * 0.1;
      },
      message: (budget: Budget) => {
        return `预算余额不足：${budget.budgetName} 剩余 ${formatCurrency(budget.remainingAmount)}，低于预算总额的10%`;
      },
      enabled: true
    },
    {
      id: 'budget-overrun',
      name: '超预算',
      type: AlertType.BUDGET_OVERRUN,
      level: AlertLevel.CRITICAL,
      condition: (budget: Budget) => {
        return budget.usedAmount > budget.totalAmount;
      },
      message: (budget: Budget) => {
        return `超预算警告：${budget.budgetName} 已使用 ${formatCurrency(budget.usedAmount)}，超过预算金额`;
      },
      enabled: true
    },
    {
      id: 'cost-abnormal',
      name: '成本异常波动',
      type: AlertType.COST_ABNORMAL,
      level: AlertLevel.WARNING,
      condition: (costData: CostData) => {
        const growthRate = calculateGrowthRate(costData.current, costData.previous);
        return Math.abs(growthRate) > 50;
      },
      message: (costData: CostData) => {
        const growthRate = calculateGrowthRate(costData.current, costData.previous);
        return `成本异常波动：${costData.category} 成本增长 ${growthRate}%，超过50%阈值`;
      },
      enabled: true
    },
    {
      id: 'contract-expiring',
      name: '合同即将到期',
      type: AlertType.CONTRACT_EXPIRING,
      level: AlertLevel.INFO,
      condition: (contract: Contract) => {
        const daysUntilExpiry = differenceInDays(new Date(contract.endDate), new Date());
        return daysUntilExpiry <= 30 && daysUntilExpiry > 0;
      },
      message: (contract: Contract) => {
        const daysUntilExpiry = differenceInDays(new Date(contract.endDate), new Date());
        return `合同即将到期：${contract.contractName} 将在${daysUntilExpiry}天后到期`;
      },
      enabled: true
    }
  ]);

  // 执行预警检查
  const checkWarnings = (data: any, dataType: string): AlertRecord[] => {
    const alerts: AlertRecord[] = [];
    
    warningRules.value
      .filter(rule => rule.enabled && isApplicableRule(rule, dataType))
      .forEach(rule => {
        if (rule.condition(data)) {
          alerts.push(createAlertRecord(rule, data));
        }
      });
    
    return alerts;
  };

  // 创建预警记录
  const createAlertRecord = (rule: WarningRule, data: any): AlertRecord => {
    return {
      id: generateId(),
      alertType: rule.type,
      alertLevel: rule.level,
      title: rule.name,
      content: rule.message(data),
      relatedObjectId: data.id,
      relatedObjectType: data.__type || 'unknown',
      isRead: false,
      createdAt: new Date(),
      validUntil: addDays(new Date(), getValidityDays(rule.level))
    };
  };

  return {
    warningRules,
    checkWarnings,
    createAlertRecord
  };
}
```

## 3. 数据模型重构

### 3.1 完整数据模型定义

#### 核心实体模型
```typescript
// src/types/budget.ts
export interface Budget {
  id: string;
  budgetName: string;
  budgetYear: number;
  budgetType: BudgetType;
  department: Department;
  totalAmount: number;
  usedAmount: number;
  remainingAmount: number;
  executionRate: number;
  status: BudgetStatus;
  healthScore: number;
  version: number;
  createdBy: User;
  createdAt: Date;
  validFrom: Date;
  validTo: Date;
  items: BudgetItem[];
  alerts: AlertRecord[];
}

export interface BudgetItem {
  id: string;
  budgetId: string;
  itemCode: string;
  itemName: string;
  parentId?: string;
  itemType: ItemType;
  plannedAmount: number;
  actualAmount: number;
  variance: number;
  varianceRate: number;
  costCenter: CostCenter;
  supplier?: Supplier;
  children?: BudgetItem[];
}

export interface CostRecord {
  id: string;
  costType: CostType;
  amount: number;
  currency: string;
  costDate: Date;
  department: Department;
  supplier: Supplier;
  budgetItem?: BudgetItem;
  contract?: Contract;
  description: string;
  createdBy: User;
  createdAt: Date;
}

export interface Contract {
  id: string;
  contractNumber: string;
  contractName: string;
  supplier: Supplier;
  contractAmount: number;
  paidAmount: number;
  remainingAmount: number;
  startDate: Date;
  endDate: Date;
  status: ContractStatus;
  paymentTerms: string;
  dataProducts: DataProduct[];
  settlements: Settlement[];
  createdAt: Date;
  updatedAt: Date;
}

export interface Settlement {
  id: string;
  settlementNumber: string;
  contractId: string;
  supplier: Supplier;
  settlementPeriod: DateRange;
  originalAmount: number;
  adjustedAmount: number;
  finalAmount: number;
  adjustmentReason?: string;
  status: SettlementStatus;
  items: SettlementItem[];
  differences: SettlementDifference[];
  createdAt: Date;
  confirmedAt?: Date;
  confirmedBy?: User;
}

export interface AlertRecord {
  id: string;
  alertType: AlertType;
  alertLevel: AlertLevel;
  title: string;
  content: string;
  relatedObjectId: string;
  relatedObjectType: string;
  isRead: boolean;
  readAt?: Date;
  createdAt: Date;
  validUntil: Date;
}
```

### 3.2 枚举类型定义
```typescript
export enum BudgetType {
  ANNUAL = 'annual',
  ROLLING = 'rolling',
  PROJECT = 'project',
  DEPARTMENT = 'department'
}

export enum BudgetStatus {
  DRAFT = 'draft',
  PENDING = 'pending',
  APPROVED = 'approved',
  ACTIVE = 'active',
  COMPLETED = 'completed',
  CANCELLED = 'cancelled'
}

export enum AlertType {
  BUDGET_INSUFFICIENT = 'budget_insufficient',
  BUDGET_OVERRUN = 'budget_overrun',
  COST_ABNORMAL = 'cost_abnormal',
  CONTRACT_EXPIRING = 'contract_expiring',
  SETTLEMENT_DIFFERENCE = 'settlement_difference'
}

export enum AlertLevel {
  INFO = 'info',
  WARNING = 'warning',
  CRITICAL = 'critical',
  EMERGENCY = 'emergency'
}
```

## 4. 组件架构重构

### 4.1 图表组件设计

#### 预算执行仪表盘组件
```vue
<!-- src/pages/budget-management/components/charts/ExecutionGauge.vue -->
<template>
  <div class="execution-gauge">
    <v-chart :option="chartOption" :autoresize="true" />
    <div class="gauge-info">
      <div class="gauge-value">{{ executionRate }}%</div>
      <div class="gauge-label">执行率</div>
      <div class="gauge-status" :class="statusClass">
        {{ statusText }}
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue';
import { use } from 'echarts/core';
import { CanvasRenderer } from 'echarts/renderers';
import { GaugeChart } from 'echarts/charts';
import { GraphicComponent } from 'echarts/components';
import VChart from 'vue-echarts';

use([CanvasRenderer, GaugeChart, GraphicComponent]);

interface Props {
  executionRate: number;
  size?: number;
}

const props = withDefaults(defineProps<Props>(), {
  size: 200
});

const statusClass = computed(() => {
  if (props.executionRate >= 90) return 'status-danger';
  if (props.executionRate >= 70) return 'status-warning';
  return 'status-success';
});

const statusText = computed(() => {
  if (props.executionRate >= 90) return '超预算';
  if (props.executionRate >= 70) return '正常';
  return '执行偏低';
});

const chartOption = computed(() => ({
  series: [
    {
      type: 'gauge',
      startAngle: 180,
      endAngle: 0,
      center: ['50%', '75%'],
      radius: '90%',
      min: 0,
      max: 100,
      splitNumber: 8,
      axisLine: {
        lineStyle: {
          width: 6,
          color: [
            [0.25, '#7CFFB2'],
            [0.5, '#58D9F9'],
            [0.75, '#FDDD60'],
            [1, '#FF6E76']
          ]
        }
      },
      pointer: {
        icon: 'path://M12.8,0.7l12,40.1H0.7L12.8,0.7z',
        length: '12%',
        width: 20,
        offsetCenter: [0, '-60%'],
        itemStyle: {
          color: 'auto'
        }
      },
      axisTick: {
        length: 12,
        lineStyle: {
          color: 'auto',
          width: 2
        }
      },
      splitLine: {
        length: 20,
        lineStyle: {
          color: 'auto',
          width: 5
        }
      },
      axisLabel: {
        color: '#464646',
        fontSize: 12,
        distance: -60,
        formatter: '{value}%'
      },
      title: {
        offsetCenter: [0, '-10%'],
        fontSize: 12,
        color: '#999'
      },
      detail: {
        fontSize: 24,
        offsetCenter: [0, '-35%'],
        valueAnimation: true,
        formatter: '{value}%',
        color: 'auto'
      },
      data: [
        {
          value: props.executionRate,
          name: '执行率'
        }
      ]
    }
  ]
}));
</script>
```

#### 预算趋势图组件
```vue
<!-- src/pages/budget-management/components/charts/BudgetTrendChart.vue -->
<template>
  <div class="budget-trend-chart">
    <v-chart :option="chartOption" :autoresize="true" />
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue';
import { use } from 'echarts/core';
import { CanvasRenderer } from 'echarts/renderers';
import { LineChart } from 'echarts/charts';
import { GridComponent, TooltipComponent, LegendComponent, TitleComponent } from 'echarts/components';
import VChart from 'vue-echarts';

use([CanvasRenderer, LineChart, GridComponent, TooltipComponent, LegendComponent, TitleComponent]);

interface Props {
  data: TrendData[];
  height?: number;
}

const props = withDefaults(defineProps<Props>(), {
  height: 300
});

const chartOption = computed(() => ({
  title: {
    text: '预算执行趋势',
    left: 'center'
  },
  tooltip: {
    trigger: 'axis',
    axisPointer: {
      type: 'cross'
    },
    formatter: (params: any[]) => {
      const date = params[0].axisValue;
      let html = `<div style="font-weight: bold; margin-bottom: 5px;">${date}</div>`;
      params.forEach(param => {
        html += `<div style="display: flex; align-items: center;">
          <span style="display: inline-block; width: 10px; height: 10px; background-color: ${param.color}; margin-right: 5px;"></span>
          <span>${param.seriesName}: ${param.value.toLocaleString()}万元</span>
        </div>`;
      });
      return html;
    }
  },
  legend: {
    data: ['预算金额', '实际金额', '执行率'],
    bottom: 0
  },
  grid: {
    left: '3%',
    right: '4%',
    bottom: '15%',
    containLabel: true
  },
  xAxis: {
    type: 'category',
    data: props.data.map(item => item.month),
    axisLabel: {
      formatter: (value: string) => {
        return value.substring(5); // 显示MM-DD格式
      }
    }
  },
  yAxis: [
    {
      type: 'value',
      name: '金额(万元)',
      position: 'left',
      axisLabel: {
        formatter: '{value}万'
      }
    },
    {
      type: 'value',
      name: '执行率(%)',
      position: 'right',
      max: 100,
      axisLabel: {
        formatter: '{value}%'
      }
    }
  ],
  series: [
    {
      name: '预算金额',
      type: 'line',
      data: props.data.map(item => item.budget),
      smooth: true,
      itemStyle: {
        color: '#1890ff'
      },
      lineStyle: {
        width: 2
      }
    },
    {
      name: '实际金额',
      type: 'line',
      data: props.data.map(item => item.actual),
      smooth: true,
      itemStyle: {
        color: '#52c41a'
      },
      lineStyle: {
        width: 2
      }
    },
    {
      name: '执行率',
      type: 'line',
      yAxisIndex: 1,
      data: props.data.map(item => item.executionRate),
      smooth: true,
      itemStyle: {
        color: '#faad14'
      },
      lineStyle: {
        width: 2,
        type: 'dashed'
      }
    }
  ]
}));
</script>
```

### 4.2 卡片组件设计

#### 预警信息卡片组件
```vue
<!-- src/pages/budget-management/components/cards/WarningAlertCard.vue -->
<template>
  <div class="warning-alert-card" :class="severityClass">
    <div class="alert-header">
      <div class="alert-icon">
        <component :is="iconComponent" />
      </div>
      <div class="alert-title">{{ alert.title }}</div>
      <div class="alert-time">{{ formatTime(alert.createdAt) }}</div>
    </div>
    <div class="alert-content">
      {{ alert.content }}
    </div>
    <div class="alert-footer">
      <a-button type="text" size="small" @click="markAsRead">
        标记已读
      </a-button>
      <a-button type="text" size="small" @click="viewDetails">
        查看详情
      </a-button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed } from 'vue';
import { IconInfoCircle, IconExclamationCircle, IconCloseCircle, IconCheckCircle } from '@arco-design/web-vue/es/icon';

interface Props {
  alert: AlertRecord;
}

const props = defineProps<Props>();
const emit = defineEmits(['mark-as-read', 'view-details']);

const severityClass = computed(() => {
  switch (props.alert.alertLevel) {
    case AlertLevel.EMERGENCY:
      return 'alert-emergency';
    case AlertLevel.CRITICAL:
      return 'alert-critical';
    case AlertLevel.WARNING:
      return 'alert-warning';
    default:
      return 'alert-info';
  }
});

const iconComponent = computed(() => {
  switch (props.alert.alertLevel) {
    case AlertLevel.EMERGENCY:
    case AlertLevel.CRITICAL:
      return IconCloseCircle;
    case AlertLevel.WARNING:
      return IconExclamationCircle;
    default:
      return IconInfoCircle;
  }
});

const formatTime = (time: Date): string => {
  const now = new Date();
  const diff = now.getTime() - new Date(time).getTime();
  const minutes = Math.floor(diff / (1000 * 60));
  const hours = Math.floor(diff / (1000 * 60 * 60));
  
  if (minutes < 60) {
    return `${minutes}分钟前`;
  } else if (hours < 24) {
    return `${hours}小时前`;
  } else {
    return new Date(time).toLocaleDateString();
  }
};

const markAsRead = () => {
  emit('mark-as-read', props.alert.id);
};

const viewDetails = () => {
  emit('view-details', props.alert);
};
</script>

<style scoped lang="less">
.warning-alert-card {
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 12px;
  border: 1px solid;
  
  &.alert-emergency {
    background-color: #ffe4e6;
    border-color: #f53f3f;
    color: #cf1322;
  }
  
  &.alert-critical {
    background-color: #fff4e6;
    border-color: #ff7d00;
    color: #d46b08;
  }
  
  &.alert-warning {
    background-color: #fffbe6;
    border-color: #fadc19;
    color: #d48806;
  }
  
  &.alert-info {
    background-color: #e6f7ff;
    border-color: #1890ff;
    color: #0050b3;
  }
  
  .alert-header {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    
    .alert-icon {
      margin-right: 8px;
      font-size: 16px;
    }
    
    .alert-title {
      flex: 1;
      font-weight: 500;
      font-size: 14px;
    }
    
    .alert-time {
      font-size: 12px;
      opacity: 0.7;
    }
  }
  
  .alert-content {
    font-size: 13px;
    line-height: 1.5;
    margin-bottom: 12px;
  }
  
  .alert-footer {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }
}
</style>
```

## 5. 状态管理优化

### 5.1 Pinia Store重构

#### 完整的Budget Store
```typescript
// src/stores/budget.ts
import { defineStore } from 'pinia';
import { computed, ref } from 'vue';
import type { Budget, BudgetItem, CostRecord, Contract, Settlement, AlertRecord } from '@/types/budget';
import { useBudgetCalculations } from '@/composables/useBudgetCalculations';
import { useWarningRules } from '@/composables/useWarningRules';

export const useBudgetStore = defineStore('budget', () => {
  // 状态
  const budgets = ref<Budget[]>([]);
  const costRecords = ref<CostRecord[]>([]);
  const contracts = ref<Contract[]>([]);
  const settlements = ref<Settlement[]>([]);
  const alertRecords = ref<AlertRecord[]>([]);
  const departments = ref<Department[]>([]);
  const suppliers = ref<Supplier[]>([]);
  
  const loading = ref(false);
  const error = ref<string | null>(null);

  // 组合式函数
  const { calculateExecutionRate, calculateHealthScore } = useBudgetCalculations();
  const { checkWarnings } = useWarningRules();

  // 计算属性
  const totalBudget = computed(() => 
    budgets.value.reduce((sum, budget) => sum + budget.totalAmount, 0)
  );
  
  const totalUsedBudget = computed(() => 
    budgets.value.reduce((sum, budget) => sum + budget.usedAmount, 0)
  );
  
  const overallExecutionRate = computed(() => 
    totalBudget.value > 0 ? calculateExecutionRate(totalUsedBudget.value, totalBudget.value) : 0
  );

  const activeAlerts = computed(() =>
    alertRecords.value.filter(alert => 
      !alert.isRead && new Date() < new Date(alert.validUntil)
    )
  );

  const criticalAlerts = computed(() =>
    activeAlerts.value.filter(alert => alert.alertLevel === AlertLevel.CRITICAL)
  );

  const expiringContracts = computed(() =>
    contracts.value.filter(contract => {
      const daysUntilExpiry = differenceInDays(new Date(contract.endDate), new Date());
      return daysUntilExpiry <= 30 && daysUntilExpiry > 0;
    })
  );

  // Actions
  async function fetchBudgets(params?: BudgetQueryParams): Promise<Budget[]> {
    loading.value = true;
    error.value = null;
    
    try {
      const response = await api.getBudgets(params);
      budgets.value = response.data.map((budget: any) => ({
        ...budget,
        executionRate: calculateExecutionRate(budget.usedAmount, budget.totalAmount),
        healthScore: calculateHealthScore(budget)
      }));
      
      // 检查预警
      checkAllWarnings();
      
      return budgets.value;
    } catch (err: any) {
      error.value = err.message;
      throw err;
    } finally {
      loading.value = false;
    }
  }

  async function createBudget(budgetData: BudgetCreateParams): Promise<Budget> {
    loading.value = true;
    error.value = null;
    
    try {
      const response = await api.createBudget(budgetData);
      const newBudget: Budget = {
        ...response.data,
        executionRate: 0,
        healthScore: 100,
        items: [],
        alerts: []
      };
      
      budgets.value.unshift(newBudget);
      return newBudget;
    } catch (err: any) {
      error.value = err.message;
      throw err;
    } finally {
      loading.value = false;
    }
  }

  async function updateBudgetExecution(budgetId: string, actualAmount: number): Promise<void> {
    const budget = budgets.value.find(b => b.id === budgetId);
    if (!budget) throw new Error('预算不存在');
    
    try {
      await api.updateBudgetExecution(budgetId, actualAmount);
      
      // 更新本地数据
      budget.usedAmount = actualAmount;
      budget.remainingAmount = budget.totalAmount - actualAmount;
      budget.executionRate = calculateExecutionRate(actualAmount, budget.totalAmount);
      budget.healthScore = calculateHealthScore(budget);
      
      // 重新检查预警
      checkBudgetWarnings(budget);
    } catch (err: any) {
      error.value = err.message;
      throw err;
    }
  }

  function checkBudgetWarnings(budget: Budget): void {
    // 清除旧的预警
    alertRecords.value = alertRecords.value.filter(alert => 
      !(alert.relatedObjectId === budget.id && alert.alertType.startsWith('budget'))
    );
    
    // 检查新的预警
    const alerts = checkWarnings(budget, 'budget');
    alerts.forEach(alert => {
      alertRecords.value.unshift(alert);
    });
  }

  function checkAllWarnings(): void {
    // 检查所有预算预警
    budgets.value.forEach(budget => {
      checkBudgetWarnings(budget);
    });
    
    // 检查合同到期预警
    contracts.value.forEach(contract => {
      const alerts = checkWarnings(contract, 'contract');
      alerts.forEach(alert => {
        alertRecords.value.unshift(alert);
      });
    });
  }

  function markAlertAsRead(alertId: string): void {
    const alert = alertRecords.value.find(a => a.id === alertId);
    if (alert) {
      alert.isRead = true;
      alert.readAt = new Date();
    }
  }

  function clearError(): void {
    error.value = null;
  }

  return {
    // 状态
    budgets,
    costRecords,
    contracts,
    settlements,
    alertRecords,
    departments,
    suppliers,
    loading,
    error,
    
    // 计算属性
    totalBudget,
    totalUsedBudget,
    overallExecutionRate,
    activeAlerts,
    criticalAlerts,
    expiringContracts,
    
    // Actions
    fetchBudgets,
    createBudget,
    updateBudgetExecution,
    markAlertAsRead,
    checkAllWarnings,
    clearError
  };
});
```

## 6. API接口设计

### 6.1 预算管理API
```typescript
// src/api/budget.ts
import type { 
  Budget, 
  BudgetItem, 
  CostRecord, 
  Contract, 
  Settlement, 
  AlertRecord,
  BudgetQueryParams,
  BudgetCreateParams 
} from '@/types/budget';

export const budgetApi = {
  // 预算管理
  getBudgets: (params?: BudgetQueryParams) => 
    request.get<PageResponse<Budget>>('/api/budget/budgets', { params }),
    
  getBudget: (id: string) => 
    request.get<Budget>(`/api/budget/budgets/${id}`),
    
  createBudget: (data: BudgetCreateParams) => 
    request.post<Budget>('/api/budget/budgets', data),
    
  updateBudget: (id: string, data: Partial<Budget>) => 
    request.put<Budget>(`/api/budget/budgets/${id}`, data),
    
  deleteBudget: (id: string) => 
    request.delete(`/api/budget/budgets/${id}`),
    
  updateBudgetExecution: (id: string, actualAmount: number) => 
    request.put<Budget>(`/api/budget/budgets/${id}/execution`, { actualAmount }),

  // 预算科目
  getBudgetItems: (budgetId: string) => 
    request.get<BudgetItem[]>(`/api/budget/budgets/${budgetId}/items`),
    
  createBudgetItem: (budgetId: string, data: Partial<BudgetItem>) => 
    request.post<BudgetItem>(`/api/budget/budgets/${budgetId}/items`, data),

  // 成本记录
  getCostRecords: (params?: CostQueryParams) => 
    request.get<PageResponse<CostRecord>>('/api/budget/costs', { params }),
    
  createCostRecord: (data: Partial<CostRecord>) => 
    request.post<CostRecord>('/api/budget/costs', data),

  // 合同管理
  getContracts: (params?: ContractQueryParams) => 
    request.get<PageResponse<Contract>>('/api/budget/contracts', { params }),
    
  getContract: (id: string) => 
    request.get<Contract>(`/api/budget/contracts/${id}`),
    
  createContract: (data: Partial<Contract>) => 
    request.post<Contract>('/api/budget/contracts', data),

  // 结算管理
  getSettlements: (params?: SettlementQueryParams) => 
    request.get<PageResponse<Settlement>>('/api/budget/settlements', { params }),
    
  getSettlement: (id: string) => 
    request.get<Settlement>(`/api/budget/settlements/${id}`),
    
  confirmSettlement: (id: string) => 
    request.put<Settlement>(`/api/budget/settlements/${id}/confirm`),

  // 预警管理
  getAlerts: (params?: AlertQueryParams) => 
    request.get<PageResponse<AlertRecord>>('/api/budget/alerts', { params }),
    
  markAlertAsRead: (id: string) => 
    request.put(`/api/budget/alerts/${id}/read`),
    
  deleteAlert: (id: string) => 
    request.delete(`/api/budget/alerts/${id}`)
};
```

## 7. 性能优化方案

### 7.1 数据缓存策略
```typescript
// src/composables/useDataCache.ts
export function useDataCache() {
  const cache = new Map<string, { data: any; timestamp: number; ttl: number }>();
  
  const setCache = (key: string, data: any, ttlMinutes: number = 5): void => {
    cache.set(key, {
      data,
      timestamp: Date.now(),
      ttl: ttlMinutes * 60 * 1000
    });
  };
  
  const getCache = (key: string): any | null => {
    const cached = cache.get(key);
    if (!cached) return null;
    
    const now = Date.now();
    if (now - cached.timestamp > cached.ttl) {
      cache.delete(key);
      return null;
    }
    
    return cached.data;
  };
  
  const clearCache = (key?: string): void => {
    if (key) {
      cache.delete(key);
    } else {
      cache.clear();
    }
  };
  
  return {
    setCache,
    getCache,
    clearCache
  };
}
```

### 7.2 虚拟滚动实现
```typescript
// 对于大数据量表格，实现虚拟滚动
const useVirtualScroll = (items: Ref<any[]>, itemHeight: number, containerHeight: number) => {
  const scrollTop = ref(0);
  const startIndex = ref(0);
  const endIndex = ref(0);
  const visibleCount = ref(Math.ceil(containerHeight / itemHeight));
  
  const visibleItems = computed(() => {
    return items.value.slice(startIndex.value, endIndex.value + 1);
  });
  
  const onScroll = (event: Event) => {
    const target = event.target as HTMLElement;
    scrollTop.value = target.scrollTop;
    
    startIndex.value = Math.floor(scrollTop.value / itemHeight);
    endIndex.value = startIndex.value + visibleCount.value + 1;
  };
  
  return {
    visibleItems,
    onScroll,
    scrollTop
  };
};
```

## 8. 错误处理与监控

### 8.1 全局错误处理
```typescript
// src/composables/useErrorHandler.ts
export function useErrorHandler() {
  const handleApiError = (error: any, context: string): void => {
    console.error(`[${context}] API Error:`, error);
    
    let message = '操作失败，请稍后重试';
    
    if (error.response) {
      // 服务器响应错误
      switch (error.response.status) {
        case 400:
          message = error.response.data.message || '请求参数错误';
          break;
        case 401:
          message = '未授权，请重新登录';
          // 跳转到登录页
          break;
        case 403:
          message = '没有权限执行此操作';
          break;
        case 404:
          message = '请求的资源不存在';
          break;
        case 500:
          message = '服务器内部错误';
          break;
        default:
          message = `服务器错误 (${error.response.status})`;
      }
    } else if (error.request) {
      // 网络错误
      message = '网络连接失败，请检查网络设置';
    } else {
      // 其他错误
      message = error.message || '未知错误';
    }
    
    // 显示错误消息
    Message.error({
      content: message,
      duration: 5000,
      closable: true
    });
    
    // 记录错误日志
    logError(error, context);
  };
  
  const logError = (error: any, context: string): void => {
    const errorLog = {
      timestamp: new Date().toISOString(),
      context,
      message: error.message,
      stack: error.stack,
      userAgent: navigator.userAgent,
      url: window.location.href
    };
    
    // 发送到日志服务
    console.error('Error Log:', errorLog);
  };
  
  return {
    handleApiError
  };
}
```

## 9. 部署与监控

### 9.1 性能监控指标
```typescript
// 关键性能指标
interface PerformanceMetrics {
  pageLoadTime: number;      // 页面加载时间
  apiResponseTime: number;   // API响应时间
  chartRenderTime: number;   // 图表渲染时间
  userInteractionTime: number; // 用户交互响应时间
}

// 性能监控实现
const trackPerformance = (): void => {
  // 页面加载时间
  window.addEventListener('load', () => {
    const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
    console.log('Page Load Time:', loadTime, 'ms');
  });
  
  // API响应时间监控
  const originalFetch = window.fetch;
  window.fetch = async (...args) => {
    const start = performance.now();
    const response = await originalFetch(...args);
    const end = performance.now();
    console.log(`API Response Time: ${end - start} ms`);
    return response;
  };
};
```

### 9.2 用户行为监控
```typescript
// 用户行为追踪
const trackUserBehavior = (): void => {
  // 页面访问追踪
  const trackPageView = (page: string): void => {
    console.log('Page View:', page, new Date().toISOString());
  };
  
  // 按钮点击追踪
  const trackButtonClick = (buttonName: string, context?: any): void => {
    console.log('Button Click:', buttonName, context);
  };
  
  // 错误追踪
  window.addEventListener('error', (event) => {
    console.error('JavaScript Error:', {
      message: event.message,
      filename: event.filename,
      lineno: event.lineno,
      colno: event.colno,
      timestamp: new Date().toISOString()
    });
  });
};
```

---

**总结**：本技术架构优化方案从图表可视化、数据模型、组件架构、状态管理、性能优化等多个维度，为预算管理模块提供了完整的技术升级路径。通过分阶段实施，可以显著提升系统的功能完整性、用户体验和性能表现。