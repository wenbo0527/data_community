# 标签表注册流程改造技术架构文档

## 1. 架构概述

### 1.1 整体架构
本改造方案采用前后端分离架构，基于Vue 3 + TypeScript + Arco Design技术栈，将原有的3步向导式标签表注册流程改造为特征中心风格的单页面交互模式。

### 1.2 技术栈
- **前端框架**：Vue 3.3+ (Composition API)
- **类型系统**：TypeScript 5.0+
- **UI组件库**：Arco Design Vue
- **状态管理**：Pinia
- **构建工具**：Vite
- **样式方案**：Less + CSS变量
- **路由管理**：Vue Router 4.x

### 1.3 架构原则
- **组件化**：高内聚、低耦合的组件设计
- **可复用性**：提取公共逻辑和组件
- **类型安全**：全面的TypeScript类型定义
- **性能优化**：懒加载、虚拟滚动、缓存策略
- **响应式**：适配多端设备和屏幕尺寸

## 2. 组件架构设计

### 2.1 页面级组件

#### 2.1.1 TagCenter.vue（标签中心主页面）
```typescript
interface TagCenterProps {}
interface TagCenterEmits {}
interface TagCenterSlots {}

// 主要职责
- 页面整体布局协调
- 子组件状态管理
- 抽屉组件控制
- 数据获取和分发
```

#### 2.1.2 组件职责划分
| 组件 | 职责 | 复杂度 |
|------|------|--------|
| TagCenterHeader | 页面头部、新建按钮下拉菜单 | 低 |
| TagStatsCards | 统计卡片展示、趋势计算 | 中 |
| TagFilterSection | 搜索筛选、表单控件 | 中 |
| TagTableList | 数据表格、分页、操作按钮 | 高 |
| QuickRegisterDrawer | 4步快速注册流程 | 高 |
| FormRegisterDrawer | 表单注册详细配置 | 高 |
| BatchImportDrawer | 批量导入表格编辑 | 中 |

### 2.2 组件通信架构

#### 2.2.1 Props/Emits模式
```typescript
// 父组件 → 子组件（Props）
interface ComponentProps {
  data: TagTable[]
  loading: boolean
  pagination: PaginationConfig
}

// 子组件 → 父组件（Emits）
interface ComponentEmits {
  'update:data': [data: TagTable[]]
  'page-change': [page: number]
  'search': [query: string]
}
```

#### 2.2.2 Provide/Inject模式
```typescript
// 在TagCenter中提供全局状态
const provideTagCenter = () => {
  provide('tagCenterState', {
    loading: readonly(loading),
    refresh: handleRefresh,
    openDrawer: handleOpenDrawer
  })
}

// 在子组件中注入使用
const injectTagCenter = () => {
  const tagCenter = inject('tagCenterState')
  return tagCenter
}
```

#### 2.2.3 事件总线模式
```typescript
// 使用mitt库实现事件总线
import mitt from 'mitt'

const emitter = mitt<{
  'tag:created': [tag: TagTable]
  'tag:updated': [tag: TagTable]
  'tag:deleted': [id: string]
  'drawer:close': [drawerType: string]
}>()
```

## 3. 状态管理架构

### 3.1 Pinia Store设计

#### 3.1.1 TagCenter Store
```typescript
// stores/tagCenter.ts
export const useTagCenterStore = defineStore('tagCenter', () => {
  // 状态定义
  const tagTables = ref<TagTable[]>([])
  const loading = ref(false)
  const pagination = ref<PaginationConfig>({
    current: 1,
    pageSize: 10,
    total: 0
  })
  
  const filterForm = ref<FilterForm>({
    name: '',
    status: '',
    category: '',
    dateRange: []
  })

  // 计算属性
  const stats = computed(() => ({
    total: tagTables.value.length,
    active: tagTables.value.filter(t => t.status === 'active').length,
    archived: tagTables.value.filter(t => t.status === 'archived').length
  }))

  // 方法
  const loadTagTables = async (params?: LoadParams) => {
    loading.value = true
    try {
      const response = await tagAPI.getTagTables(params)
      tagTables.value = response.data
      pagination.value.total = response.total
    } finally {
      loading.value = false
    }
  }

  const createTagTable = async (data: CreateTagTableDTO) => {
    const response = await tagAPI.createTagTable(data)
    tagTables.value.unshift(response.data)
    return response.data
  }

  const updateTagTable = async (id: string, data: UpdateTagTableDTO) => {
    const response = await tagAPI.updateTagTable(id, data)
    const index = tagTables.value.findIndex(t => t.id === id)
    if (index !== -1) {
      tagTables.value[index] = response.data
    }
    return response.data
  }

  const deleteTagTable = async (id: string) => {
    await tagAPI.deleteTagTable(id)
    const index = tagTables.value.findIndex(t => t.id === id)
    if (index !== -1) {
      tagTables.value.splice(index, 1)
    }
  }

  return {
    // 状态
    tagTables: readonly(tagTables),
    loading: readonly(loading),
    pagination: readonly(pagination),
    filterForm: readonly(filterForm),
    stats: readonly(stats),
    
    // 方法
    loadTagTables,
    createTagTable,
    updateTagTable,
    deleteTagTable
  }
})
```

### 3.2 状态分层架构
```
应用层状态（Pinia Store）
├── 业务状态（TagCenterStore）
├── UI状态（组件内部）
└── 临时状态（Drawer内部）

组件层状态（Composition API）
├── 响应式数据（ref/reactive）
├── 计算属性（computed）
└── 方法函数（function）
```

## 4. API接口设计

### 4.1 接口规范
```typescript
// 统一响应格式
interface ApiResponse<T> {
  success: boolean
  code: number
  message: string
  data: T
  timestamp: number
}

// 分页响应格式
interface PaginatedResponse<T> {
  data: T[]
  total: number
  current: number
  pageSize: number
  pages: number
}
```

### 4.2 标签表管理接口
```typescript
// api/tag.ts
export const tagAPI = {
  // 获取标签表列表
  getTagTables: (params?: GetTagTablesParams): Promise<ApiResponse<PaginatedResponse<TagTable>>> => {
    return request.get('/api/v1/tag-tables', { params })
  },

  // 创建标签表
  createTagTable: (data: CreateTagTableDTO): Promise<ApiResponse<TagTable>> => {
    return request.post('/api/v1/tag-tables', data)
  },

  // 更新标签表
  updateTagTable: (id: string, data: UpdateTagTableDTO): Promise<ApiResponse<TagTable>> => {
    return request.put(`/api/v1/tag-tables/${id}`, data)
  },

  // 删除标签表
  deleteTagTable: (id: string): Promise<ApiResponse<void>> => {
    return request.delete(`/api/v1/tag-tables/${id}`)
  },

  // 批量创建标签表
  batchCreateTagTables: (data: CreateTagTableDTO[]): Promise<ApiResponse<BatchCreateResult>> => {
    return request.post('/api/v1/tag-tables/batch', data)
  },

  // 获取数据源列表
  getDataSources: (): Promise<ApiResponse<DataSource[]>> => {
    return request.get('/api/v1/data-sources')
  },

  // 获取表字段信息
  getTableFields: (dataSourceId: string, tableName: string): Promise<ApiResponse<TableField[]>> => {
    return request.get(`/api/v1/data-sources/${dataSourceId}/tables/${tableName}/fields`)
  },

  // 检查主键唯一性
  checkPrimaryKeyUniqueness: (dataSourceId: string, tableName: string, fields: string[]): Promise<ApiResponse<UniquenessCheckResult>> => {
    return request.post('/api/v1/tag-tables/check-uniqueness', {
      dataSourceId,
      tableName,
      fields
    })
  }
}
```

### 4.3 数据模型定义
```typescript
// types/tag.ts
export interface TagTable {
  id: string
  name: string
  code: string
  description: string
  status: 'active' | 'archived'
  categories: string[]
  dataSource: string
  dataSourceId: string
  tableName: string
  primaryKey: string
  identityType: 'mobile' | 'device_id' | 'id_card' | 'card_no'
  primaryKeyFormat: string
  mappingRules: MappingRule[]
  enableMapping: boolean
  creator: string
  createTime: string
  updater: string
  updateTime: string
}

export interface MappingRule {
  id: string
  sourceField: string
  targetField: string
  algorithm: 'exact' | 'fuzzy' | 'similarity'
  threshold?: number
  enabled: boolean
}

export interface CreateTagTableDTO {
  name: string
  code: string
  description: string
  categories: string[]
  dataSourceId: string
  tableName: string
  primaryKey: string
  identityType: 'mobile' | 'device_id' | 'id_card' | 'card_no'
  primaryKeyFormat: string
  mappingRules: MappingRule[]
  enableMapping: boolean
}

export interface TableField {
  name: string
  type: string
  description: string
  nullable: boolean
  isPrimaryKey: boolean
}

export interface UniquenessCheckResult {
  score: number
  uniqueCount: number
  totalCount: number
  suggestion: string
}
```

## 5. 抽屉组件架构

### 5.1 QuickRegisterDrawer（快速注册）

#### 5.1.1 组件结构
```typescript
// components/QuickRegisterDrawer.vue
interface QuickRegisterDrawerProps {
  visible: boolean
  dataSourceId?: string
  tableName?: string
}

interface QuickRegisterDrawerEmits {
  'update:visible': [visible: boolean]
  'success': [data: TagTable]
  'error': [error: Error]
}
```

#### 5.1.2 步骤状态管理
```typescript
const currentStep = ref(1)
const stepData = reactive({
  // 步骤1：基础信息
  basic: {
    dataSourceId: '',
    tableName: '',
    tableType: '',
    primaryKey: '',
    partitionFields: [] as string[]
  },
  
  // 步骤2：字段校验
  fields: {
    registered: [] as TableField[],
    unregistered: [] as TableField[]
  },
  
  // 步骤3：批量注册
  registration: {
    selectedFields: [] as string[],
    fieldMappings: [] as FieldMapping[]
  },
  
  // 步骤4：确认提交
  confirm: {
    preview: {} as TagTablePreview
  }
})
```

### 5.2 FormRegisterDrawer（表单注册）

#### 5.2.1 表单结构
```typescript
const formModel = reactive<CreateTagTableDTO>({
  name: '',
  code: '',
  description: '',
  categories: [],
  dataSourceId: '',
  tableName: '',
  primaryKey: '',
  identityType: 'mobile',
  primaryKeyFormat: '',
  mappingRules: [],
  enableMapping: true
})

const formRules: FormRules = {
  name: [{ required: true, message: '请输入标签表名称' }],
  code: [{ required: true, message: '请输入标签表编码' }],
  dataSourceId: [{ required: true, message: '请选择数据源' }],
  tableName: [{ required: true, message: '请选择数据表' }],
  primaryKey: [{ required: true, message: '请选择主键字段' }]
}
```

#### 5.2.2 分组表单
```typescript
const formSections = computed(() => [
  {
    key: 'basic',
    title: '基本信息',
    fields: ['name', 'code', 'description', 'categories']
  },
  {
    key: 'dataSource',
    title: '数据源配置',
    fields: ['dataSourceId', 'tableName', 'primaryKey', 'identityType']
  },
  {
    key: 'mapping',
    title: 'IDMapping配置',
    fields: ['enableMapping', 'mappingRules']
  }
])
```

### 5.3 BatchImportDrawer（批量导入）

#### 5.3.1 表格编辑模式
```typescript
const importTable = ref<ImportRow[]>([])
const tableColumns = computed(() => [
  {
    title: '标签表名称',
    dataIndex: 'name',
    editable: true,
    rules: [{ required: true }]
  },
  {
    title: '标签表编码',
    dataIndex: 'code',
    editable: true,
    rules: [{ required: true, pattern: /^[a-zA-Z0-9_]+$/ }]
  },
  // ... 其他列配置
])
```

#### 5.3.2 数据验证
```typescript
const validateImportData = (): ValidationResult => {
  const errors: ValidationError[] = []
  
  importTable.value.forEach((row, index) => {
    // 必填项验证
    if (!row.name) {
      errors.push({ row: index, field: 'name', message: '标签表名称不能为空' })
    }
    
    // 编码格式验证
    if (row.code && !/^[a-zA-Z0-9_]+$/.test(row.code)) {
      errors.push({ row: index, field: 'code', message: '编码只能包含字母、数字和下划线' })
    }
    
    // 数据唯一性验证
    const duplicateCodes = findDuplicates(importTable.value.map(r => r.code))
    if (duplicateCodes.includes(row.code)) {
      errors.push({ row: index, field: 'code', message: '编码重复' })
    }
  })
  
  return {
    valid: errors.length === 0,
    errors
  }
}
```

## 6. 性能优化策略

### 6.1 组件懒加载
```typescript
// 路由级别的懒加载
const TagCenter = defineAsyncComponent(() => 
  import('@/pages/exploration/customer-center/tag-system/tag-center.vue')
)

// 抽屉组件的懒加载
const QuickRegisterDrawer = defineAsyncComponent(() => 
  import('@/components/QuickRegisterDrawer.vue')
)
```

### 6.2 虚拟滚动
```typescript
// 大数据量表格使用虚拟滚动
import { VirtualList } from '@arco-design/web-vue'

<template>
  <virtual-list
    :data="tagTables"
    :item-size="60"
    :height="600"
    #default="{ item }"
  >
    <tag-table-item :data="item" />
  </virtual-list>
</template>
```

### 6.3 防抖和节流
```typescript
// 搜索输入防抖
const debouncedSearch = useDebounce((query: string) => {
  loadTagTables({ name: query })
}, 300)

// 滚动事件节流
const throttledScroll = useThrottle((event: Event) => {
  handleScroll(event)
}, 100)
```

### 6.4 缓存策略
```typescript
// API响应缓存
const apiCache = new Map<string, { data: any; timestamp: number }>()

const cachedRequest = async (key: string, request: () => Promise<any>) => {
  const cached = apiCache.get(key)
  const now = Date.now()
  
  // 缓存有效期5分钟
  if (cached && now - cached.timestamp < 5 * 60 * 1000) {
    return cached.data
  }
  
  const data = await request()
  apiCache.set(key, { data, timestamp: now })
  return data
}
```

## 7. 错误处理架构

### 7.1 全局错误处理
```typescript
// composables/useErrorHandler.ts
export const useErrorHandler = () => {
  const handleError = (error: Error | AxiosError) => {
    if (isAxiosError(error)) {
      // HTTP错误处理
      const status = error.response?.status
      
      switch (status) {
        case 400:
          Message.error('请求参数错误')
          break
        case 401:
          Message.error('未授权，请重新登录')
          router.push('/login')
          break
        case 403:
          Message.error('没有权限执行此操作')
          break
        case 404:
          Message.error('请求的资源不存在')
          break
        case 500:
          Message.error('服务器内部错误')
          break
        default:
          Message.error('操作失败，请稍后重试')
      }
    } else {
      // 业务逻辑错误
      Message.error(error.message || '操作失败')
    }
  }
  
  return { handleError }
}
```

### 7.2 表单验证错误
```typescript
// composables/useFormValidation.ts
export const useFormValidation = () => {
  const validateForm = async (formRef: FormInstance): Promise<boolean> => {
    try {
      await formRef.validate()
      return true
    } catch (errors) {
      // 滚动到第一个错误字段
      const firstError = errors[0]
      const fieldElement = document.querySelector(`[data-field="${firstError.field}"]`)
      fieldElement?.scrollIntoView({ behavior: 'smooth', block: 'center' })
      
      return false
    }
  }
  
  return { validateForm }
}
```

## 8. 测试架构

### 8.1 单元测试
```typescript
// tests/components/TagTableList.test.ts
describe('TagTableList', () => {
  it('should render table with data', () => {
    const wrapper = mount(TagTableList, {
      props: {
        data: mockTagTables,
        loading: false
      }
    })
    
    expect(wrapper.find('.arco-table').exists()).toBe(true)
    expect(wrapper.findAll('.arco-table-tr')).toHaveLength(mockTagTables.length)
  })
  
  it('should emit page-change event', async () => {
    const wrapper = mount(TagTableList, {
      props: {
        data: mockTagTables,
        pagination: { current: 1, pageSize: 10, total: 100 }
      }
    })
    
    await wrapper.find('.arco-pagination-item-next').trigger('click')
    expect(wrapper.emitted('page-change')).toBeTruthy()
  })
})
```

### 8.2 集成测试
```typescript
// tests/integration/tagCenter.test.ts
describe('TagCenter Integration', () => {
  it('should create tag table successfully', async () => {
    // 模拟API响应
    mockCreateTagTable.mockResolvedValue({
      success: true,
      data: { id: '1', name: '测试标签表' }
    })
    
    const wrapper = mount(TagCenter)
    
    // 打开快速注册抽屉
    await wrapper.find('.quick-register-btn').trigger('click')
    
    // 填写表单
    await wrapper.find('[data-field="name"]').setValue('测试标签表')
    await wrapper.find('[data-field="code"]').setValue('test_tag')
    
    // 提交表单
    await wrapper.find('.submit-btn').trigger('click')
    
    // 验证结果
    await waitFor(() => {
      expect(wrapper.find('.success-message').exists()).toBe(true)
    })
  })
})
```

### 8.3 E2E测试
```typescript
// tests/e2e/tagCenter.spec.ts
test('complete tag table registration flow', async ({ page }) => {
  // 访问标签中心页面
  await page.goto('/exploration/customer-center/tag-system/tag-center')
  
  // 点击快速注册按钮
  await page.click('.quick-register-btn')
  
  // 等待抽屉打开
  await page.waitForSelector('.quick-register-drawer')
  
  // 填写基础信息
  await page.selectOption('[data-field="dataSource"]', '数据源1')
  await page.selectOption('[data-field="tableName"]', '表1')
  
  // 下一步
  await page.click('.next-step-btn')
  
  // 选择字段
  await page.click('[data-field="primaryKey"]')
  await page.click('.field-option:first-child')
  
  // 提交
  await page.click('.submit-btn')
  
  // 验证成功
  await page.waitForSelector('.success-message')
})
```

## 9. 部署架构

### 9.1 构建配置
```typescript
// vite.config.ts
export default defineConfig({
  build: {
    // 代码分割
    rollupOptions: {
      output: {
        manualChunks: {
          'vendor': ['vue', 'vue-router', 'pinia'],
          'arco': ['@arco-design/web-vue'],
          'utils': ['axios', 'dayjs', 'lodash-es']
        }
      }
    },
    
    // 压缩优化
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,
        drop_debugger: true
      }
    }
  },
  
  // 开发服务器配置
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true
      }
    }
  }
})
```

### 9.2 环境配置
```typescript
// .env.development
VITE_API_BASE_URL=http://localhost:8080/api
VITE_APP_TITLE=标签表注册中心
VITE_APP_ENV=development

// .env.production
VITE_API_BASE_URL=/api
VITE_APP_TITLE=标签表注册中心
VITE_APP_ENV=production
```

### 9.3 监控配置
```typescript
// monitoring/sentry.ts
import * as Sentry from '@sentry/vue'

export const initSentry = (app: App) => {
  Sentry.init({
    app,
    dsn: import.meta.env.VITE_SENTRY_DSN,
    environment: import.meta.env.VITE_APP_ENV,
    integrations: [
      new Sentry.BrowserTracing({
        routingInstrumentation: Sentry.vueRouterInstrumentation(router)
      })
    ],
    tracesSampleRate: 1.0
  })
}
```

## 10. 安全架构

### 10.1 权限控制
```typescript
// composables/usePermission.ts
export const usePermission = () => {
  const userStore = useUserStore()
  
  const hasPermission = (permission: string): boolean => {
    return userStore.permissions.includes(permission)
  }
  
  const canCreateTagTable = computed(() => {
    return hasPermission('tag:table:create')
  })
  
  const canUpdateTagTable = computed(() => {
    return hasPermission('tag:table:update')
  })
  
  const canDeleteTagTable = computed(() => {
    return hasPermission('tag:table:delete')
  })
  
  return {
    hasPermission,
    canCreateTagTable,
    canUpdateTagTable,
    canDeleteTagTable
  }
}
```

### 10.2 数据脱敏
```typescript
// utils/desensitization.ts
export const desensitizeData = (data: any, rules: DesensitizeRule[]): any => {
  return rules.reduce((result, rule) => {
    const value = get(result, rule.field)
    if (value) {
      set(result, rule.field, rule.handler(value))
    }
    return result
  }, cloneDeep(data))
}

// 使用示例
const desensitizeTagTable = (tagTable: TagTable): TagTable => {
  return desensitizor.desensitizeData(tagTable, [
    { field: 'creator', handler: desensitizor.desensitizeName },
    { field: 'dataSource', handler: desensitizor.desensitizeConnectionString }
  ])
}
```

### 10.3 输入验证
```typescript
// utils/validation.ts
export const createValidator = () => {
  const validateSQLInjection = (input: string): boolean => {
    const sqlInjectionPattern = /(\b(union|select|insert|update|delete|drop|create|alter|exec|script|javascript)\b|--|\/\*|\*\/|xp_)/i
    return !sqlInjectionPattern.test(input)
  }
  
  const validateXSS = (input: string): boolean => {
    const xssPattern = /(<script|<iframe|<object|<embed|<link|javascript:|onload|onerror)/i
    return !xssPattern.test(input)
  }
  
  return {
    validateSQLInjection,
    validateXSS
  }
}
```