# 外数生命周期产品方案

## 背景与目标
- 聚焦外部数据从“接入档案 → 效果评估 → 服务调用 → 风险监控/预算管理”的全链路治理，统一指标口径与跨模块协同。
- 目标：提升评估质量与服务可用性，形成闭环的预算健康度监控与结算管理能力。

## 生命周期阶段与页面映射
- 档案管理：`src/pages/external-data-archive/index.vue`（/risk/external-data/archive）
- 效果评估：`src/pages/exploration/ExternalDataEvaluationList.vue`（/exploration/external-data-evaluation/list），详情页：`src/pages/exploration/ExternalDataEvaluationDetail.vue`
- 服务管理：`src/pages/external-data-service/index.vue`（/external-data-service）及组件
- 风险监控：`src/pages/exploration/external-data-analysis/external-data-monitor.vue`（/exploration/external-data-analysis/external-data-monitor）
- 预算管理：总览/列表/合同/监控/结算（/risk/budget-*），页面位于 `src/pages/budget/*`。

## 系统架构与路由拓扑
- 风险域入口：`src/router/index.js:408, 421, 446, 459, 465`（预算总览/列表/合同/监控/结算）
- 预算独立模块映射：`src/router/index.js:514, 520, 545, 551, 557`
- 外数域入口与探索域：档案/评估/监控/服务均在 `src/router/index.js` 与 `router/modules/exploration.js` 中注册。
- 菜单映射：预算总览入口 `src/config/menuConfig.js`（项：external-data-budget-management → /risk/budget-overview）。

## 数据模型与核心存储
- 外数 Store：`src/store/modules/external-data.ts`（产品、预警、燃尽、评估引用）
- 预算 Store：`src/store/modules/budget.ts:54,76,86,101`
- 预算 API：`src/api/budget.ts:56,88,99,131,148`

## 关键组件与交互
- 预算燃尽 Tabs：`src/components/modals/BudgetBurndownTabs.vue:58,64,70,92,116`
- 档案编辑抽屉：`src/pages/external-data-archive/index.vue:412–431`
- 档案跨模块跳转封装：`src/pages/external-data-archive/index.vue:75–79,102,128,134,179,437–441`
- 评估详情核心动作：保存/发布/归档 `src/pages/exploration/ExternalDataEvaluationDetail.vue:674–714,717–745,775–808`
- 监控页数据加载与初始化：`src/pages/exploration/external-data-analysis/external-data-monitor.vue:300–305,308–314,322–372`
- 结算任务闭环：`src/pages/budget/SettlementManagement.vue:304–317,319–348,365–381,385–395`

## 指标体系与口径
- 评估指标：评分、样本量、时段、发布状态（详情页保存/发布/归档动作绑定评估生命周期）。
- 服务指标：可用性、响应时间、错误率（来源服务管理页与任务查询组件）。
- 预算指标：当年预算总额、当前累积消耗、当年实际核销、预算健康度（总览与监控页一致口径）。
- 监控指标：燃尽曲线、预警 TopN、目标额度分布（监控页图表与表格）。

## 跨模块调用逻辑
- 统一跳转协议：`archiveId`、`from`、`product`、`tab`（封装位置：`src/pages/external-data-archive/index.vue:75–79,179,437–441`）
- 评估 → 档案：评估发布/归档后更新档案记录与标签（通过评估详情的 `publishReport`、`archiveReport`）。
- 评估 → 预算：评估结论映射到预算项的可用性/效果分，触发预算监控阈值与预警（预算监控页展示）。
- 档案 → 服务：使用场景调整同步到服务申请与任务查询视图（服务管理页组件）。
- 服务 → 监控：服务任务结果写入监控数据源，驱动燃尽与预警更新（监控页 `onMounted` 加载）。
- 预算 → 合同 → 结算：预算监控发现异常 → 定位合同 → 发起结算任务 → 报告生成与核销更新（`SettlementManagement.vue:304–317,319–348,365–381`）。
- 事件驱动：前端以 Store 触发与消费事件为落地方式，结合后端消息队列实现异步联动。

## 落地路径与迭代
- 现状：上述页面与核心函数已实现基础能力，支持导航封装与数据展示。
- 下一步：
  - 打通评估结果回写到档案与预算域（标注字段与写回接口）。
  - 结算报告写回合同域与预算核销（占位函数 `updateData`）。
  - 统一日志与错误上报通道，完善服务调用监控与重试策略。

## 验证与自检
- 打开以下页面交叉验证行号与行为：
  - `/risk/budget-overview`、`/risk/budget/list`、`/risk/budget/contracts`、`/risk/budget/monitor`、`/risk/budget/settlement`
  - `/risk/external-data/archive`、`/exploration/external-data-evaluation/list`、`/exploration/external-data-analysis/external-data-monitor`、`/external-data-service`
- 对照路由与菜单，确保入口与页面对应正确。

## 设计原则与交互规范（基于 Arco Design）
- 清晰与一致：统一使用 Arco 的按钮、抽屉、弹窗、表单、表格与消息反馈；页内操作采用同构语义与视觉层级。
- 即时反馈：动作触发后以 `Message.success/error/info`、`Spin/Skeleton`、按钮 `loading` 与禁用态反馈进行状态传达。
- 进阶呈现：复杂信息使用分节/折叠与“更多”机制，避免一次性信息过载；属性面板优先显示关键字段。
- 可控与可撤销：破坏性操作均使用 `Popconfirm` 确认；支持撤销/恢复（前端层面保留最近一次变更缓存与提示）。
- 空/错/权限：统一空状态 `Empty`、错误提示与权限不可用态（按钮禁用 + Tooltip），避免无反馈。
- 键盘与辅助：提供聚焦状态、键盘可达与快捷键（如保存、返回、筛选重置），提升专业用户效率。

## 详细事件与状态流（跨模块）
- 档案 → 评估：
  - 事件：`onJumpToEvaluation(product)`；组件：`a-button`；反馈：`Message.info('已进入评估中心')`；路由：携带 `product` 与 `archiveId`。
  - 异常：路由失败或参数缺失 → `Message.error` 并提示重试；记录埋点：导航失败原因。
- 档案 → 监控：
  - 事件：`onJumpToMonitor(product)`；组件：`a-button`；初始化：监控页 `onMounted` 拉取燃尽与预警。
  - 加载：`Spin` 或骨架屏；筛选应用：`onFilterApply` 显示 `loading` 与禁用控件，完成后 `Message.success('已更新监控')`。
- 评估详情：
  - 保存：`onEvaluationSave` → `Message.success('报告保存成功')`；失败 → `Message.error`；行号参考：`src/pages/exploration/ExternalDataEvaluationDetail.vue:674–714`。
  - 发布：`onEvaluationPublish` → 状态改为“已发布”，禁用编辑控件；行号：`717–745`。
  - 归档/删除：均用 `Popconfirm`；行号：`775–808`、`810–844`；成功后返回列表并提示。
- 服务申请与任务：
  - 提交：`onServiceApplySubmit` → 任务中心新增项，`Message.success('已提交申请')`；失败 → `Message.error` 并可重试。
  - 重试/取消：`onTaskRetry/onTaskCancel`；统一状态机：`pending/running/succeeded/failed/canceled`；可在查询页 `TaskQuery` 提供。
- 预算监控与结算：
  - 触发结算：`onTriggerSettlement(contractIds)`；结算页创建任务并打开详情；行号参考：`src/pages/budget/SettlementManagement.vue:304–317`。
  - 进度：`onSettlementProgressTick` 每秒刷新；成功完成 → `Message.success('结算任务已完成')`；行号：`319–348`。
  - 报告与写回：`onSettlementReportDownload/onSettlementUpdateData`；行号：`365–381, 385–387`；写回为后端联调占位。

## 通用组件映射与模式
- 导航：`a-button` + `router.push` + `Message`；危险操作：`a-popconfirm`；表单：`a-form` + 校验 + `loading`；列表：`a-table` + 空/加载/错误态；抽屉：`a-drawer`；筛选：`a-select/a-input/a-date-picker`；导出：`a-button` + 文件流。
- 加载与空态：`a-spin/a-skeleton/a-empty`；通知与结果：`Message/Notification`；布局工具：`a-space/a-card/a-tabs/a-collapse`。
