**问题概述**

* 分层轮廓偶发越界：当前轮廓长度与宽度由节点分布和 iconSize 推导，叠加标题向左扩展，小画布或极端分布时可能超出可视区域。

* 加工层（index=3）节点分布导致不与其他层平行：全局 U 轴从跨度最大层估计，若某层（如加工层）点集分布与参考层差异大，会出现视觉不平行。

* 画布覆盖不完整：content 仅 scale，未做自适应平移/包络约束；背景图与叠加层边界未统一。

**目标**

* 所有分层轮廓在画布内可见，留有安全边距。

* 全局轴向统一，保证各层总线和连接线视觉平行。

* 画布自动适配覆盖所有图像与叠加元素范围。

**方案一：约束与自适应（低侵入优先）**

* 动态边界夹持：在 [Canvas2\_5D.vue](file:///Users/mac/nis_mock/data_comunity/data_comunity/src/components/architecture/Canvas2_5D.vue#L470-L486) 生成 pU/pV 边界后，加入对 content 边界的夹持（0 与 width/height），并为四角交点做边界裁剪；安全边距建议 24–48px。

* 自适应轮廓参数：

  * 宽度 fixedWidth 与 iconSize 联动但加入上限比例：min(iconDiag*0.8, contentMin*0.25)。

  * 标题左扩 extraLeftPx 基于可用空间缩放：min(extraLeftPx, 可用U向剩余空间\*0.4)。

* 节点视觉中心偏移限制：nodesContactPx 的 y 偏移按 iconSize 比例但上限 12px，避免层厚度计算被过度拉宽。

**方案二：轴向统一（稳定并行）**

* 固定设计轴：采用设计指定的 U 轴角度（推荐 -30° \~ -35°），不再从数据分布估计；V 轴取正交。

* 参考层锁定：如需基于数据估计，指定“参考层”（如数据仓储层 index=1）仅从该层估计 U 轴，避免因加工层分布异常改变全局轴。

* 连接线方向保持 -148° 投影不变，确保与侧边平行。

**方案三：画布视域自适应（完整覆盖）**

* 计算叠加层包络：对 bus、edge、layerPolygons 取整体 bounding box，加入安全边距。

* 自动缩放与居中：根据包络与容器尺寸计算 scale 与 translate，使所有元素可见；在 contentStyle 中加入 translate(-cx, -cy) 与 scale 的联动。

* 背景图一致性：确保 bg-image 对齐 content 的坐标系（object-fit: contain + 同步 scale/translate），避免背景与叠加图层错位。

**方案四：加工层节点分布校正**

* 轨道化分布：对每层按 U 轴投影后做等距分布（gridSnap 不仅按 xPct，还按 U 投影均匀化），保证同层节点“沿总线”排列。

* 层内厚度控制：按 V 轴投影对节点做最大厚度限制与居中，避免加工层厚度显著偏离其他层。

**风险与权衡**

* 方案一与三对视觉稳定性贡献最大，入侵性低。

* 方案二改变轴来源，需产品/设计确认角度；一旦固定，整体并行性最佳。

* 方案四会改变节点精确位置，需与业务数据含义保持一致（仅视觉分布，不改变语义）。

**推荐组合**

* 首选：方案一 + 方案三（立即消除越界并保证完整覆盖）。

* 中期：方案二（锁定统一 U 轴），提升各层并行一致性。

* 辅助：方案四（仅在加工层明显不齐时启用），作为视觉整齐度增强。

**验证清单**

* 越界检测：渲染后计算包络是否在容器内，边距是否 ≥ 24px。

* 并行性检测：各层总线与连接线方向差异角 ≤ 2°。

* 画面完整性：背景、节点、轮廓、线条均在视域内，无裁剪。

