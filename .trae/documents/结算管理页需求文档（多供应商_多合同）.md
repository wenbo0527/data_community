## 概述与目标
- 结算管理页支持单次结算任务同时选择“多个供应商”，并在每个供应商下选择“多个合同”，完成批量对账、差异计算、报告生成与数据写回。
- 参考工作台结构（工具栏 + 列表 + 创建任务 + 状态/进度 + 操作），强调多实体并行结算的可视化和可控性。

## 页面与路由
- 列表页：`/risk/budget/settlement`
- 任务详情页：`/risk/budget/settlement/task/:id`
- 报告页：`/risk/budget/settlement/report/:id`

## 核心功能
- 批量结算：单任务内支持“多供应商 + 多合同”的组合处理。
- 状态与进度：总任务进度 + 每供应商子进度；失败/部分成功时给出可重试与跳过策略。
- 报告输出：生成“合并报告”（整体摘要）与“分卷报告”（按供应商/合同）。
- 数据更新：支持一次性写回各合同的核销与结算记录；保留快照与回滚能力。

## 创建结算（表单）
- 选择维度：
  - 供应商（多选，必填）
  - 合同（多选，可根据选中的供应商过滤）
- 粒度与时间：
  - 结算粒度（年/季/月）
  - 结算时间标签（如：2025、2025-Q2、2025-01）
- 数据源：
  - 预算快照版本（下拉）
  - 实际数据版本/账期（下拉）
- 规则与参数：
  - 严格对齐（启用则差异阈值必须≤设定值）
  - 包含税费（影响实际金额口径）
  - 小额误差阈值（数值）
- 备注：文本域
- 提交后：创建“总任务（Task）”和“供应商子任务（SubTask）”，状态进入`running`并显示进度。

## 任务执行与并发模型
- 总任务包含多个子任务（按供应商划分）：
  - 每个子任务内处理其所选合同的差异计算、校验、报告分卷生成与写回。
- 并发策略：
  - 前端进度显示：总进度 = 完成子任务数/全部子任务数 × 100%
  - 后端可并发执行子任务；前端轮询或 SSE/WS 更新状态。
- 失败与重试：
  - 子任务失败不阻断总任务；支持“重试该供应商”或“跳过并继续”。

## 结算报告（合并 + 分卷）
- 合并报告：
  - 摘要卡：总预算金额、总实际金额、总差异金额、总差异率、供应商数、合同数、结算周期
  - 差异构成：按供应商与合同聚合的饼图/柱图
  - 导出：PDF/XLSX（包含分卷索引）
- 分卷报告（每供应商）：
  - 摘要：该供应商下合同的预算/实际/差异
  - 明细：按合同/科目列出预算/实际/差异与备注
  - 导出：独立文件（PDF/XLSX）

## 数据更新与回滚
- 写回对象：
  - 合同：更新`writtenOffAmount`、追加`settlementRecords`、标记结算状态
  - 预算：可选同步执行额与剩余预算（配置开关）
- 回滚机制：
  - 以快照版本为基准，支持“撤销本次结算写入”恢复到前一版本
  - 操作审计：记录操作者、时间、影响范围（供应商/合同/金额）

## 数据模型（前端）
- SettlementTask
  - `id, granularity, timeLabel, status, progress, createdBy, createdAt`
  - `supplierIds: string[]`（选择的供应商）
  - `contractIds: string[]`（选择的合同，跨供应商）
  - `summary: { budgetAmount, actualAmount, diffAmount, diffRate, supplierCount, contractCount }`
- SettlementSubTask（按供应商）
  - `id, taskId, supplierId, status, progress`
  - `contracts: string[]`
  - `summary: { budgetAmount, actualAmount, diffAmount, diffRate }`
- SettlementReport
  - `id, taskId, type: 'merged' | 'supplier'`
  - `supplierId?`
  - `summary, items[], charts?, downloadUrl`
- SettlementItem
  - `supplierId, contractId, dimension, budget, actual, diff, diffRate, comment`

## API（占位设计）
- 任务
  - `GET /api/settlements/tasks?page&pageSize&supplier&status&timeLabel`
  - `POST /api/settlements/tasks`（创建，body: `{ supplierIds: string[], contractIds: string[], granularity, timeLabel, budgetSnapshotId, actualSnapshotId, options }`）
  - `GET /api/settlements/tasks/:id`（包含子任务与进度）
  - `POST /api/settlements/tasks/:id/cancel`
  - `POST /api/settlements/tasks/:id/update`（写回数据，支持部分供应商/合同范围）
- 子任务
  - `POST /api/settlements/subtasks/:id/retry`
  - `POST /api/settlements/subtasks/:id/skip`
- 报告
  - `POST /api/settlements/tasks/:id/report?type=merged|supplier&supplierId?`
  - `GET /api/settlements/reports/:id`
  - `GET /api/settlements/reports/:id/download?type=pdf|xlsx`
- 字典/快照
  - `GET /api/contracts?supplierIds&status`
  - `GET /api/settlements/snapshots?type=budget|actual`

## 列表页结构（参考评估列表页）
- 工具栏：供应商（多选）、合同（多选）、结算周期（粒度 + 时间标签）、状态、创建人；按钮：发起结算、刷新、导出列表
- 表格列：任务编号、供应商数、合同数、结算周期、预算金额、实际金额、差异金额/率、状态、进度、创建人/时间、操作（查看/生成报告/更新数据/取消/下载）
- 详情抽屉：子任务步骤与日志 + 分卷摘要预览 + 操作（重试/跳过/生成报告）

## 交互与组件（Arco）
- `a-form`（过滤与创建）/ `a-modal`或`a-drawer`（创建与详情）
- `a-table`（列表）/ `a-steps`（步骤）/ `a-progress`（进度）/ `a-tag`（状态）/ `a-card + a-statistic`（摘要）

## 权限与审计
- 创建/写回操作需“结算管理员”权限
- 二次确认与操作审计日志（操作者、时间、影响供应商/合同/金额/快照版本）

## 错误与边界
- 多供应商选择后合同选择需实时过滤；无合同时禁止提交
- 部分失败不阻断，总任务给出“汇总状态：部分成功”与待处理列表
- 幂等与重复：同一粒度/时间标签重复创建提示，允许覆盖或新版本

## 验收标准
- 可筛选与浏览结算任务，支持多供应商+多合同创建任务
- 任务进度显示总/分两层；失败可重试/跳过
- 生成合并与分卷报告并可下载；数据写回有确认与回滚

## 里程碑
- M1：列表与创建（多选维度）+ 假数据状态流转
- M2：报告（合并/分卷）与更新写回 + 回滚
- M3：图表与性能优化 + 接口联调