# 预算管理与外数生命周期模块拆分架构方案

## 1. 项目概述

基于现有系统架构，将预算管理与外数生命周期拆分为两个独立的子应用模块。保持现有路由入口与UI风格一致性，明确数据边界，避免跨Store耦合，提升系统可维护性和扩展性。

## 2. 核心目标

- **模块独立**：预算管理与外数生命周期作为两个完全独立的子应用
- **路由保持**：保持现有路由入口不变，确保用户体验连续性
- **UI一致性**：保持Arco Design设计体系和视觉风格统一
- **数据隔离**：明确数据边界，避免Store间直接耦合
- **技术栈一致**：继续使用Vue 3 + Composition API + Vite架构

## 3. 模块架构设计

### 3.1 预算管理子应用

**核心功能模块：**
- 预算总览页面
- 预算列表管理
- 预算创建与编辑
- 预算监控预警
- 合同管理
- 结算管理

**独立路由结构：**
```
/budget/*
/risk/budget/*
```

**独立Store：**
- `useBudgetStore` - 预算数据管理
- `useContractStore` - 合同数据管理
- `useSettlementStore` - 结算数据管理

### 3.2 外数生命周期子应用

**核心功能模块：**
- 外数档案管理
- 外数生命周期管理
- 外数数据服务
- 外数评估中心
- 外数监控中心

**独立路由结构：**
```
/external-data/*
/discovery/external/*
/risk/external-data/*
```

**独立Store：**
- `useExternalDataStore` - 外数数据管理
- `useEvaluationStore` - 评估数据管理
- `useLifecycleStore` - 生命周期数据管理

## 4. 技术架构

### 4.1 前端架构

**技术栈：**
- 前端框架：Vue 3 (Composition API)
- 构建工具：Vite
- 状态管理：Pinia (替代Vuex)
- UI组件：Arco Design Vue
- 路由管理：Vue Router 4
- 图形引擎：AntV X6 (画布相关)

**模块拆分策略：**
```
src/
├── modules/
│   ├── budget/           # 预算管理子应用
│   │   ├── components/   # 预算相关组件
│   │   ├── stores/       # 预算状态管理
│   │   ├── api/          # 预算API接口
│   │   ├── router/       # 预算路由配置
│   │   └── pages/        # 预算页面
│   └── external-data/    # 外数生命周期子应用
│       ├── components/   # 外数相关组件
│       ├── stores/       # 外数状态管理
│       ├── api/          # 外数API接口
│       ├── router/       # 外数路由配置
│       └── pages/        # 外数页面
├── shared/              # 共享组件和工具
└── core/               # 核心功能
```

### 4.2 数据边界定义

**预算管理数据域：**
- 预算基础信息
- 预算执行数据
- 合同信息
- 结算记录
- 预算预警规则

**外数生命周期数据域：**
- 外部数据源信息
- 数据评估报告
- 数据使用记录
- 数据生命周期状态
- 数据服务配置

### 4.3 通信机制

**模块间通信原则：**
- 避免直接Store调用
- 使用事件总线进行解耦通信
- 通过URL参数传递必要信息
- 使用共享服务层处理交叉业务

**事件总线示例：**
```typescript
// 共享事件总线
export const useEventBus = () => {
  const emitter = mitt()
  
  return {
    // 预算相关事件
    emitBudgetCreated: (budgetId: string) => emitter.emit('budget:created', budgetId),
    onBudgetCreated: (callback: (budgetId: string) => void) => emitter.on('budget:created', callback),
    
    // 外数相关事件
    emitExternalDataUpdated: (dataId: string) => emitter.emit('external:data:updated', dataId),
    onExternalDataUpdated: (callback: (dataId: string) => void) => emitter.on('external:data:updated', callback)
  }
}
```

## 5. 路由设计

### 5.1 预算管理路由

```typescript
// modules/budget/router/index.ts
export const budgetRoutes = [
  {
    path: '/budget',
    component: () => import('@/modules/budget/layouts/BudgetLayout.vue'),
    children: [
      { path: 'overview', component: () => import('@/modules/budget/pages/Overview.vue') },
      { path: 'list', component: () => import('@/modules/budget/pages/List.vue') },
      { path: 'create', component: () => import('@/modules/budget/pages/Create.vue') },
      { path: 'edit/:id', component: () => import('@/modules/budget/pages/Edit.vue') },
      { path: 'detail/:id', component: () => import('@/modules/budget/pages/Detail.vue') },
      { path: 'monitor', component: () => import('@/modules/budget/pages/Monitor.vue') },
      { path: 'contracts', component: () => import('@/modules/budget/pages/Contracts.vue') },
      { path: 'settlement', component: () => import('@/modules/budget/pages/Settlement.vue') }
    ]
  }
]
```

### 5.2 外数生命周期路由

```typescript
// modules/external-data/router/index.ts
export const externalDataRoutes = [
  {
    path: '/external-data',
    component: () => import('@/modules/external-data/layouts/ExternalDataLayout.vue'),
    children: [
      { path: 'archive', component: () => import('@/modules/external-data/pages/Archive.vue') },
      { path: 'lifecycle', component: () => import('@/modules/external-data/pages/Lifecycle.vue') },
      { path: 'service', component: () => import('@/modules/external-data/pages/Service.vue') },
      { path: 'evaluation', component: () => import('@/modules/external-data/pages/Evaluation.vue') },
      { path: 'monitor', component: () => import('@/modules/external-data/pages/Monitor.vue') }
    ]
  }
]
```

## 6. 状态管理设计

### 6.1 预算管理Store结构

```typescript
// modules/budget/stores/budget.ts
export const useBudgetStore = defineStore('budget', () => {
  const budgets = ref<Budget[]>([])
  const loading = ref(false)
  const error = ref<Error | null>(null)
  
  // actions
  const fetchBudgets = async () => { /* 实现 */ }
  const createBudget = async (budget: Budget) => { /* 实现 */ }
  const updateBudget = async (id: string, budget: Partial<Budget>) => { /* 实现 */ }
  const deleteBudget = async (id: string) => { /* 实现 */ }
  
  return {
    budgets: readonly(budgets),
    loading: readonly(loading),
    error: readonly(error),
    fetchBudgets,
    createBudget,
    updateBudget,
    deleteBudget
  }
})
```

### 6.2 外数数据Store结构

```typescript
// modules/external-data/stores/external-data.ts
export const useExternalDataStore = defineStore('externalData', () => {
  const externalDataList = ref<ExternalData[]>([])
  const evaluations = ref<Evaluation[]>([])
  const lifecycleData = ref<LifecycleData[]>([])
  
  // actions
  const fetchExternalData = async () => { /* 实现 */ }
  const createEvaluation = async (evaluation: Evaluation) => { /* 实现 */ }
  const updateLifecycle = async (id: string, data: LifecycleData) => { /* 实现 */ }
  
  return {
    externalDataList: readonly(externalDataList),
    evaluations: readonly(evaluations),
    lifecycleData: readonly(lifecycleData),
    fetchExternalData,
    createEvaluation,
    updateLifecycle
  }
})
```

## 7. 组件设计

### 7.1 共享组件库

```
src/shared/components/
├── BaseTable.vue      # 基础表格组件
├── BaseForm.vue       # 基础表单组件
├── BaseModal.vue      # 基础弹窗组件
├── BaseDrawer.vue     # 基础抽屉组件
├── Charts/           # 图表组件
└── Layouts/          # 布局组件
```

### 7.2 模块专属组件

**预算管理组件：**
```
modules/budget/components/
├── BudgetCard.vue        # 预算卡片
├── BudgetForm.vue        # 预算表单
├── BudgetStats.vue       # 预算统计
├── BudgetMonitor.vue     # 预算监控
└── ContractForm.vue      # 合同表单
```

**外数生命周期组件：**
```
modules/external-data/components/
├── ExternalDataCard.vue     # 外数数据卡片
├── EvaluationForm.vue      # 评估表单
├── LifecycleTimeline.vue     # 生命周期时间线
├── DataServicePanel.vue    # 数据服务面板
└── MonitorDashboard.vue    # 监控仪表板
```

## 8. API接口设计

### 8.1 预算管理API

```typescript
// modules/budget/api/budget.ts
export const budgetApi = {
  // 预算相关
  getBudgets: () => http.get<Budget[]>('/api/budgets'),
  getBudget: (id: string) => http.get<Budget>(`/api/budgets/${id}`),
  createBudget: (budget: Budget) => http.post<Budget>('/api/budgets', budget),
  updateBudget: (id: string, budget: Partial<Budget>) => http.put<Budget>(`/api/budgets/${id}`, budget),
  deleteBudget: (id: string) => http.delete(`/api/budgets/${id}`),
  
  // 合同相关
  getContracts: () => http.get<Contract[]>('/api/contracts'),
  createContract: (contract: Contract) => http.post<Contract>('/api/contracts', contract),
  
  // 结算相关
  getSettlements: () => http.get<Settlement[]>('/api/settlements'),
  createSettlement: (settlement: Settlement) => http.post<Settlement>('/api/settlements', settlement)
}
```

### 8.2 外数生命周期API

```typescript
// modules/external-data/api/external-data.ts
export const externalDataApi = {
  // 外数数据相关
  getExternalData: () => http.get<ExternalData[]>('/api/external-data'),
  getExternalDataDetail: (id: string) => http.get<ExternalData>(`/api/external-data/${id}`),
  createExternalData: (data: ExternalData) => http.post<ExternalData>('/api/external-data', data),
  
  // 评估相关
  getEvaluations: () => http.get<Evaluation[]>('/api/evaluations'),
  createEvaluation: (evaluation: Evaluation) => http.post<Evaluation>('/api/evaluations', evaluation),
  
  // 生命周期相关
  getLifecycleData: (dataId: string) => http.get<LifecycleData[]>(`/api/external-data/${dataId}/lifecycle`),
  updateLifecycle: (dataId: string, lifecycle: LifecycleData) => http.put<LifecycleData>(`/api/external-data/${dataId}/lifecycle`, lifecycle)
}
```

## 9. 部署方案

### 9.1 独立构建配置

```typescript
// modules/budget/vite.config.ts
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  plugins: [vue()],
  build: {
    lib: {
      entry: './src/main.ts',
      name: 'BudgetModule',
      fileName: 'budget-module'
    },
    rollupOptions: {
      external: ['vue', 'vue-router', 'pinia'],
      output: {
        globals: {
          vue: 'Vue',
          'vue-router': 'VueRouter',
          pinia: 'Pinia'
        }
      }
    }
  }
})
```

### 9.2 微前端集成

```typescript
// 主应用中的模块加载
import { createApp } from 'vue'
import { createRouter, createWebHistory } from 'vue-router'

const routes = [
  {
    path: '/budget',
    component: () => import('./modules/budget/ModuleLoader.vue')
  },
  {
    path: '/external-data',
    component: () => import('./modules/external-data/ModuleLoader.vue')
  }
]

const router = createRouter({
  history: createWebHistory(),
  routes
})
```

## 10. 实施计划

### 第一阶段：基础架构搭建（1-2周）
- 创建模块目录结构
- 配置独立构建环境
- 建立共享组件库
- 设置事件总线机制

### 第二阶段：预算管理模块迁移（2-3周）
- 迁移预算相关页面
- 重构预算Store
- 独立预算API层
- 测试预算功能完整性

### 第三阶段：外数生命周期模块迁移（2-3周）
- 迁移外数相关页面
- 重构外数Store
- 独立外数API层
- 测试外数功能完整性

### 第四阶段：集成测试与优化（1-2周）
- 模块间通信测试
- 路由切换测试
- 性能优化
- 文档完善

## 11. 风险与对策

### 技术风险
- **风险**：模块间通信复杂
- **对策**：使用事件总线，避免直接耦合

### 数据一致性风险
- **风险**：数据边界不清晰导致数据不一致
- **对策**：明确数据所有权，建立数据同步机制

### 性能风险
- **风险**：模块加载性能下降
- **对策**：使用懒加载和代码分割优化

### 维护风险
- **风险**：模块间依赖关系复杂
- **对策**：建立清晰的模块接口规范，完善文档

## 12. 预期收益

1. **可维护性提升**：模块独立，代码结构清晰
2. **开发效率提高**：团队可以并行开发不同模块
3. **系统稳定性增强**：模块隔离，降低相互影响
4. **扩展性改善**：新功能可以独立添加到对应模块
5. **部署灵活性**：支持独立部署和更新

通过本次模块拆分，我们将建立一个更加模块化、可维护、可扩展的前端架构体系。