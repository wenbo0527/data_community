# ç”»å¸ƒç›¸å…³æ–‡ä»¶è¿ç§»æ–¹æ¡ˆ

## 1. è¿ç§»ç›®æ ‡è·¯å¾„è§„åˆ’

### 1.1 ç›®æ ‡æ ¹è·¯å¾„
```
/Users/mac/nis_mock/data_comunity/data_comunity/src/pages/marketing/tasks/
```

### 1.2 ç›®å½•ç»“æ„è§„åˆ’
```
src/pages/marketing/tasks/
â”œâ”€â”€ components/           # Vueç»„ä»¶
â”‚   â”œâ”€â”€ canvas/          # ç”»å¸ƒç›¸å…³ç»„ä»¶
â”‚   â”œâ”€â”€ workflow/        # å·¥ä½œæµç»„ä»¶
â”‚   â””â”€â”€ workflow-editor/ # å·¥ä½œæµç¼–è¾‘å™¨ç»„ä»¶
â”œâ”€â”€ composables/         # ç»„åˆå¼å‡½æ•°
â”‚   â”œâ”€â”€ canvas/         # ç”»å¸ƒç›¸å…³composables
â”‚   â””â”€â”€ layout/         # å¸ƒå±€ç›¸å…³composables
â””â”€â”€ utils/              # å·¥å…·å‡½æ•°
    â”œâ”€â”€ canvas/         # ç”»å¸ƒæ ¸å¿ƒå·¥å…·ç±»
    â””â”€â”€ coordinate-refactor/ # åæ ‡ç³»ç»Ÿé‡æ„ç›¸å…³
```

## 2. æ–‡ä»¶åˆ†ç±»å’Œç»„ç»‡ç»“æ„

### 2.1 Componentsç›®å½•ï¼ˆVueç»„ä»¶ï¼‰

#### 2.1.1 ç”»å¸ƒæ ¸å¿ƒç»„ä»¶
**æºè·¯å¾„**: `/src/components/`
**ç›®æ ‡è·¯å¾„**: `/src/pages/marketing/tasks/components/canvas/`

- `CanvasManualControls.vue` â†’ `components/canvas/CanvasManualControls.vue`
- `ConnectionContextMenu.vue` â†’ `components/canvas/ConnectionContextMenu.vue`
- `FlowNode.vue` â†’ `components/canvas/FlowNode.vue`
- `NodeConfigDrawer.vue` â†’ `components/canvas/NodeConfigDrawer.vue`
- `NodeTypeSelector.vue` â†’ `components/canvas/NodeTypeSelector.vue`
- `PreviewLineStyleConfig.vue` â†’ `components/canvas/PreviewLineStyleConfig.vue`

#### 2.1.2 å·¥ä½œæµç»„ä»¶
**æºè·¯å¾„**: `/src/components/workflow/`
**ç›®æ ‡è·¯å¾„**: `/src/pages/marketing/tasks/components/workflow/`

- æ•´ä¸ª`workflow/`ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶

#### 2.1.3 å·¥ä½œæµç¼–è¾‘å™¨ç»„ä»¶
**æºè·¯å¾„**: `/src/components/workflow-editor/`
**ç›®æ ‡è·¯å¾„**: `/src/pages/marketing/tasks/components/workflow-editor/`

- æ•´ä¸ª`workflow-editor/`ç›®å½•

### 2.2 Composablesç›®å½•ï¼ˆç»„åˆå¼å‡½æ•°ï¼‰

#### 2.2.1 ç”»å¸ƒç›¸å…³composables
**æºè·¯å¾„**: `/src/composables/`
**ç›®æ ‡è·¯å¾„**: `/src/pages/marketing/tasks/composables/canvas/`

- `useCanvasConnection.js` â†’ `composables/canvas/useCanvasConnection.js`
- `useCanvasExport.js` â†’ `composables/canvas/useCanvasExport.js`
- `useCanvasHistory.js` â†’ `composables/canvas/useCanvasHistory.js`
- `useCanvasMinimap.js` â†’ `composables/canvas/useCanvasMinimap.js`
- `useCanvasToolbar.js` â†’ `composables/canvas/useCanvasToolbar.js`
- `useConfigDrawers.js` â†’ `composables/canvas/useConfigDrawers.js`
- `useEventManager.js` â†’ `composables/canvas/useEventManager.js`
- `useLayoutEngine.js` â†’ `composables/canvas/useLayoutEngine.js`
- `useNodeManager.js` â†’ `composables/canvas/useNodeManager.js`
- `usePreviewLine.js` â†’ `composables/canvas/usePreviewLine.js`
- `usePreviewLineManager.js` â†’ `composables/canvas/usePreviewLineManager.js`
- `useStructuredLayout.js` â†’ `composables/canvas/useStructuredLayout.js`
- `useX6Events.js` â†’ `composables/canvas/useX6Events.js`

#### 2.2.2 å¸ƒå±€ç›¸å…³composables
**æºè·¯å¾„**: `/src/composables/layout/`
**ç›®æ ‡è·¯å¾„**: `/src/pages/marketing/tasks/composables/layout/`

- `HierarchyAdapter.js` â†’ `composables/layout/HierarchyAdapter.js`
- `HierarchyLayoutEngine.js` â†’ `composables/layout/HierarchyLayoutEngine.js`

### 2.3 Utilsç›®å½•ï¼ˆå·¥å…·å‡½æ•°ï¼‰

#### 2.3.1 ç”»å¸ƒæ ¸å¿ƒå·¥å…·ç±»
**æºè·¯å¾„**: `/src/utils/`
**ç›®æ ‡è·¯å¾„**: `/src/pages/marketing/tasks/utils/canvas/`

- `CanvasPanZoomManager.js` â†’ `utils/canvas/CanvasPanZoomManager.js`
- `CoordinateSystemManager.js` â†’ `utils/canvas/CoordinateSystemManager.js`
- `EdgeOverlapManager.js` â†’ `utils/canvas/EdgeOverlapManager.js`
- `EndNodeConfig.js` â†’ `utils/canvas/EndNodeConfig.js`
- `GlobalDragStateManager.js` â†’ `utils/canvas/GlobalDragStateManager.js`
- `NodeConfigManager.js` â†’ `utils/canvas/NodeConfigManager.js` âœ…
- `PreviewLineStyleManager.js` â†’ `utils/canvas/PreviewLineStyleManager.js` âœ…
- `UnifiedPreviewLineManager.js` â†’ `utils/canvas/UnifiedPreviewLineManager.js` âš ï¸
- `UnifiedStructuredLayoutEngine.js` â†’ `utils/canvas/UnifiedStructuredLayoutEngine.js` âš ï¸
- `canvasConfig.js` â†’ `utils/canvas/canvasConfig.js` âœ…
- `canvasValidation.js` â†’ `utils/canvas/canvasValidation.js` âœ…
- `connectionConfigFactory.js` â†’ `utils/canvas/connectionConfigFactory.js` âœ…
- `nodeConnectionHelper.js` â†’ `utils/canvas/nodeConnectionHelper.js`
- `portConfigFactory.js` â†’ `utils/canvas/portConfigFactory.js`
- `previewConfig.js` â†’ `utils/canvas/previewConfig.js`
- `workflowNodeCreator.js` â†’ `utils/canvas/workflowNodeCreator.js`
- `workflowNodeTypes.js` â†’ `utils/canvas/workflowNodeTypes.js`
- `x6Config.js` â†’ `utils/canvas/x6Config.js`

#### 2.3.2 åæ ‡ç³»ç»Ÿé‡æ„ç›¸å…³
**æºè·¯å¾„**: `/src/utils/coordinate-refactor/`
**ç›®æ ‡è·¯å¾„**: `/src/pages/marketing/tasks/utils/coordinate-refactor/`

- æ•´ä¸ª`coordinate-refactor/`ç›®å½•åŠå…¶æ‰€æœ‰å­ç›®å½•å’Œæ–‡ä»¶

## 3. ä¾èµ–å…³ç³»åˆ†æ

### 3.1 æ ¸å¿ƒä¾èµ–é“¾
```
Vueç»„ä»¶ â†’ Composables â†’ Utilså·¥å…·ç±»
    â†“         â†“           â†“
  UIå±‚    ä¸šåŠ¡é€»è¾‘å±‚   æ ¸å¿ƒç®—æ³•å±‚
```

### 3.2 å…³é”®ä¾èµ–å…³ç³»

#### 3.2.1 ç”»å¸ƒæ ¸å¿ƒä¾èµ–
- `FlowNode.vue` ä¾èµ– `NodeConfigManager.js`
- `useLayoutEngine.js` ä¾èµ– `UnifiedStructuredLayoutEngine.js`
- `usePreviewLineManager.js` ä¾èµ– `UnifiedPreviewLineManager.js`
- `useCanvasConnection.js` ä¾èµ– `connectionConfigFactory.js`

#### 3.2.2 æ ·å¼å’Œé…ç½®ä¾èµ–
- å¤šä¸ªç»„ä»¶ä¾èµ– `PreviewLineStyleManager.js`
- ç”»å¸ƒåˆå§‹åŒ–ä¾èµ– `canvasConfig.js` å’Œ `x6Config.js`
- ç«¯å£é…ç½®ä¾èµ– `portConfigFactory.js`

#### 3.2.3 åæ ‡ç³»ç»Ÿä¾èµ–
- `UnifiedStructuredLayoutEngine.js` ä¾èµ– `coordinate-refactor/` ä¸‹çš„å¤šä¸ªæ¨¡å—
- `CoordinateSystemManager.js` ä¸åæ ‡é‡æ„æ¨¡å—ç´§å¯†å…³è”

## 4. è¿ç§»æ­¥éª¤è¯¦ç»†è¯´æ˜

### 4.1 ç¬¬ä¸€é˜¶æ®µï¼šå·¥å…·ç±»è¿ç§»ï¼ˆå·²å®Œæˆéƒ¨åˆ†ï¼‰
âœ… **å·²å®Œæˆ**:
- `NodeConfigManager.js`
- `PreviewLineStyleManager.js`
- `canvasConfig.js`
- `canvasValidation.js`
- `connectionConfigFactory.js`

âš ï¸ **éœ€è¦æ‰‹åŠ¨å¤„ç†**:
- `UnifiedPreviewLineManager.js` (13646è¡Œï¼Œè¿‡å¤§)
- `UnifiedStructuredLayoutEngine.js` (4571è¡Œï¼Œè¿‡å¤§)

ğŸ”„ **å¾…è¿ç§»**:
1. `CanvasPanZoomManager.js`
2. `CoordinateSystemManager.js`
3. `EdgeOverlapManager.js`
4. `EndNodeConfig.js`
5. `GlobalDragStateManager.js`
6. `nodeConnectionHelper.js`
7. `portConfigFactory.js`
8. `previewConfig.js`
9. `workflowNodeCreator.js`
10. `workflowNodeTypes.js`
11. `x6Config.js`
12. æ•´ä¸ª `coordinate-refactor/` ç›®å½•

### 4.2 ç¬¬äºŒé˜¶æ®µï¼šComposablesè¿ç§»
1. åˆ›å»ºç›®æ ‡ç›®å½•ç»“æ„
2. è¿ç§»å¸ƒå±€ç›¸å…³composables
3. è¿ç§»ç”»å¸ƒç›¸å…³composables
4. æ›´æ–°importè·¯å¾„

### 4.3 ç¬¬ä¸‰é˜¶æ®µï¼šVueç»„ä»¶è¿ç§»
1. è¿ç§»ç”»å¸ƒæ ¸å¿ƒç»„ä»¶
2. è¿ç§»å·¥ä½œæµç»„ä»¶ç›®å½•
3. è¿ç§»å·¥ä½œæµç¼–è¾‘å™¨ç»„ä»¶ç›®å½•
4. æ›´æ–°ç»„ä»¶å†…çš„importè·¯å¾„

### 4.4 ç¬¬å››é˜¶æ®µï¼šè·¯å¾„æ›´æ–°å’Œæµ‹è¯•
1. å…¨å±€æœç´¢æ›¿æ¢importè·¯å¾„
2. æ›´æ–°ç›¸å¯¹è·¯å¾„å¼•ç”¨
3. è¿è¡Œæµ‹è¯•éªŒè¯åŠŸèƒ½

## 5. ä»£ç æ›´æ–°ç­–ç•¥ï¼ˆimportè·¯å¾„æ›´æ–°ï¼‰

### 5.1 å·¥å…·ç±»è·¯å¾„æ›´æ–°è§„åˆ™
```javascript
// åŸè·¯å¾„
import { NodeConfigManager } from '@/utils/NodeConfigManager.js'

// æ–°è·¯å¾„
import { NodeConfigManager } from '@/pages/marketing/tasks/utils/canvas/NodeConfigManager.js'
```

### 5.2 Composablesè·¯å¾„æ›´æ–°è§„åˆ™
```javascript
// åŸè·¯å¾„
import { useLayoutEngine } from '@/composables/useLayoutEngine.js'

// æ–°è·¯å¾„
import { useLayoutEngine } from '@/pages/marketing/tasks/composables/canvas/useLayoutEngine.js'
```

### 5.3 ç»„ä»¶è·¯å¾„æ›´æ–°è§„åˆ™
```javascript
// åŸè·¯å¾„
import FlowNode from '@/components/FlowNode.vue'

// æ–°è·¯å¾„
import FlowNode from '@/pages/marketing/tasks/components/canvas/FlowNode.vue'
```

### 5.4 æ‰¹é‡è·¯å¾„æ›¿æ¢è„šæœ¬
```bash
# ä½¿ç”¨sedå‘½ä»¤æ‰¹é‡æ›¿æ¢ï¼ˆç¤ºä¾‹ï¼‰
find . -name "*.vue" -o -name "*.js" | xargs sed -i 's|@/utils/canvas|@/pages/marketing/tasks/utils/canvas|g'
find . -name "*.vue" -o -name "*.js" | xargs sed -i 's|@/composables/use|@/pages/marketing/tasks/composables/canvas/use|g'
```

## 6. é£é™©è¯„ä¼°å’Œæ³¨æ„äº‹é¡¹

### 6.1 é«˜é£é™©é¡¹
1. **å¤§æ–‡ä»¶è¿ç§»**: `UnifiedPreviewLineManager.js` å’Œ `UnifiedStructuredLayoutEngine.js` æ–‡ä»¶è¿‡å¤§ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†
2. **å¾ªç¯ä¾èµ–**: æŸäº›å·¥å…·ç±»ä¹‹é—´å¯èƒ½å­˜åœ¨å¾ªç¯ä¾èµ–ï¼Œéœ€è¦ä»”ç»†æ£€æŸ¥
3. **è·¯å¾„å¼•ç”¨**: å¤§é‡çš„ç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„éœ€è¦æ›´æ–°

### 6.2 ä¸­é£é™©é¡¹
1. **åæ ‡ç³»ç»Ÿ**: `coordinate-refactor/` ç›®å½•åŒ…å«å¤æ‚çš„ç®—æ³•æ¨¡å—
2. **æ ·å¼ç®¡ç†**: é¢„è§ˆçº¿æ ·å¼ç®¡ç†å™¨çš„ä¸»é¢˜é…ç½®å¯èƒ½å½±å“UIæ˜¾ç¤º
3. **äº‹ä»¶ç³»ç»Ÿ**: X6äº‹ä»¶ç®¡ç†å™¨çš„è¿ç§»å¯èƒ½å½±å“äº¤äº’åŠŸèƒ½

### 6.3 æ³¨æ„äº‹é¡¹
1. **ä¿æŒåŸæœ‰ç›®å½•ç»“æ„**: åœ¨ç›®æ ‡è·¯å¾„ä¸‹ä¿æŒåŸæœ‰çš„å­ç›®å½•ç»“æ„
2. **æµ‹è¯•è¦†ç›–**: æ¯ä¸ªé˜¶æ®µå®Œæˆåéƒ½è¦è¿›è¡ŒåŠŸèƒ½æµ‹è¯•
3. **å¤‡ä»½åŸæ–‡ä»¶**: è¿ç§»å‰å¤‡ä»½åŸå§‹æ–‡ä»¶
4. **åˆ†æ‰¹è¿ç§»**: é¿å…ä¸€æ¬¡æ€§è¿ç§»æ‰€æœ‰æ–‡ä»¶ï¼Œåˆ†æ‰¹è¿›è¡Œä¾¿äºé—®é¢˜å®šä½

### 6.4 ç‰¹æ®Šå¤„ç†æ–‡ä»¶
- `UnifiedPreviewLineManager.js`: éœ€è¦æ‰‹åŠ¨å¤åˆ¶å®Œæ•´å†…å®¹
- `UnifiedStructuredLayoutEngine.js`: éœ€è¦æ‰‹åŠ¨å¤åˆ¶å®Œæ•´å†…å®¹
- `coordinate-refactor/` ç›®å½•: åŒ…å«å¤šå±‚åµŒå¥—ï¼Œéœ€è¦ä¿æŒå®Œæ•´ç»“æ„

## 7. éªŒè¯æµ‹è¯•è®¡åˆ’

### 7.1 å•å…ƒæµ‹è¯•
- [ ] å·¥å…·ç±»åŠŸèƒ½æµ‹è¯•
- [ ] Composablesé€»è¾‘æµ‹è¯•
- [ ] ç»„ä»¶æ¸²æŸ“æµ‹è¯•

### 7.2 é›†æˆæµ‹è¯•
- [ ] ç”»å¸ƒåˆå§‹åŒ–æµ‹è¯•
- [ ] èŠ‚ç‚¹åˆ›å»ºå’Œè¿æ¥æµ‹è¯•
- [ ] å¸ƒå±€å¼•æ“æµ‹è¯•
- [ ] é¢„è§ˆçº¿åŠŸèƒ½æµ‹è¯•

### 7.3 UIæµ‹è¯•
- [ ] ç”»å¸ƒäº¤äº’æµ‹è¯•
- [ ] èŠ‚ç‚¹æ‹–æ‹½æµ‹è¯•
- [ ] è¿æ¥åˆ›å»ºæµ‹è¯•
- [ ] æ ·å¼ä¸»é¢˜åˆ‡æ¢æµ‹è¯•

### 7.4 æ€§èƒ½æµ‹è¯•
- [ ] å¤§é‡èŠ‚ç‚¹æ¸²æŸ“æ€§èƒ½
- [ ] å¸ƒå±€è®¡ç®—æ€§èƒ½
- [ ] å†…å­˜ä½¿ç”¨æƒ…å†µ

## 8. è¿ç§»è¿›åº¦è·Ÿè¸ª

### 8.1 å·²å®Œæˆ âœ…

#### Utilsç›®å½• (å·²è¿ç§»åˆ°canvas/å­ç›®å½•)
- [x] NodeConfigManager.js
- [x] PreviewLineStyleManager.js
- [x] canvasConfig.js
- [x] canvasValidation.js
- [x] connectionConfigFactory.js
- [x] CanvasPanZoomManager.js
- [x] CoordinateSystemManager.js
- [x] EdgeOverlapManager.js
- [x] EndNodeConfig.js
- [x] GlobalDragStateManager.js
- [x] UnifiedPreviewLineManager.js
- [x] UnifiedStructuredLayoutEngine.js
- [x] nodeConnectionHelper.js
- [x] portConfigFactory.js
- [x] previewConfig.js
- [x] workflowNodeCreator.js
- [x] workflowNodeTypes.js
- [x] x6Config.js
- [x] coordinate-refactor/ æ•´ä¸ªç›®å½•

#### Composablesç›®å½• (å·²è¿ç§»)
- [x] canvas/å­ç›®å½•ä¸‹18ä¸ªç»„åˆå‡½æ•°
- [x] layout/å­ç›®å½•ä¸‹2ä¸ªå¸ƒå±€ç»„åˆå‡½æ•°

### 8.2 éœ€è¦å¤„ç†çš„é—®é¢˜ âš ï¸

#### é‡å¤æ–‡ä»¶éœ€è¦æ¸…ç†
- [ ] UnifiedPreviewLineManager.js (æ ¹ç›®å½•å’Œcanvas/å­ç›®å½•éƒ½å­˜åœ¨)
- [ ] canvasValidation.js (æ ¹ç›®å½•å’Œcanvas/å­ç›®å½•éƒ½å­˜åœ¨)

#### æ–‡ä»¶åˆ†ç±»éœ€è¦è°ƒæ•´
- [ ] DataTransformUtils.js (æ ¹ç›®å½•) â†’ éœ€è¦åˆ†ç±»åˆ°åˆé€‚å­ç›®å½•
- [ ] ErrorHandler.js (æ ¹ç›®å½•) â†’ éœ€è¦åˆ†ç±»åˆ°åˆé€‚å­ç›®å½•
- [ ] EventManagerBase.js (æ ¹ç›®å½•) â†’ éœ€è¦åˆ†ç±»åˆ°åˆé€‚å­ç›®å½•
- [ ] GraphOperationUtils.js (æ ¹ç›®å½•) â†’ éœ€è¦åˆ†ç±»åˆ°åˆé€‚å­ç›®å½•
- [ ] StyleConfig.js (æ ¹ç›®å½•) â†’ éœ€è¦åˆ†ç±»åˆ°åˆé€‚å­ç›®å½•
- [ ] enhancedCanvasValidation.js (æ ¹ç›®å½•) â†’ åº”ç§»åŠ¨åˆ°canvas/å­ç›®å½•
- [ ] idGenerator.js (æ ¹ç›®å½•) â†’ éœ€è¦åˆ†ç±»åˆ°åˆé€‚å­ç›®å½•
- [ ] taskStorage.js (æ ¹ç›®å½•) â†’ éœ€è¦åˆ†ç±»åˆ°åˆé€‚å­ç›®å½•

### 8.3 å¾…è¿ç§» ğŸ”„
- [ ] Vueç»„ä»¶æ–‡ä»¶ (componentsç›®å½•ä¸‹çš„ç»„ä»¶)
- [ ] æ ¹ç›®å½•ä¸‹æ•£è½çš„å·¥å…·æ–‡ä»¶é‡æ–°åˆ†ç±»

### 8.4 åç»­ä»»åŠ¡ ğŸ“‹
- [ ] æ¸…ç†é‡å¤æ–‡ä»¶
- [ ] é‡æ–°åˆ†ç±»æ ¹ç›®å½•ä¸‹çš„å·¥å…·æ–‡ä»¶
- [ ] è·¯å¾„æ›´æ–°
- [ ] åŠŸèƒ½æµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] æ–‡æ¡£æ›´æ–°

---

**è¿ç§»å®Œæˆæ ‡å‡†**:
1. æ‰€æœ‰ç”»å¸ƒç›¸å…³æ–‡ä»¶æˆåŠŸè¿ç§»åˆ°ç›®æ ‡è·¯å¾„
2. importè·¯å¾„å…¨éƒ¨æ›´æ–°æ­£ç¡®
3. ç”»å¸ƒåŠŸèƒ½æ­£å¸¸è¿è¡Œ
4. é€šè¿‡æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹
5. æ€§èƒ½æŒ‡æ ‡ç¬¦åˆé¢„æœŸ
