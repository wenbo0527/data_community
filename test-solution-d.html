<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>方案D测试 - Y坐标问题修复验证</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .status-item {
            flex: 1;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .status-success {
            background-color: #f0f9ff;
            border: 1px solid #0ea5e9;
            color: #0c4a6e;
        }
        .status-warning {
            background-color: #fffbeb;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
        }
        .test-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #374151;
        }
        .test-result {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            background: #f9fafb;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #2563eb;
        }
        .btn-success {
            background: #10b981;
        }
        .btn-success:hover {
            background: #059669;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔧 方案D执行验证</h1>
            <p>优化预览线管理器初始化时序 - Y坐标问题修复</p>
        </div>

        <div class="status">
            <div class="status-item status-success">
                <h3>✅ 修改完成</h3>
                <p>已移除过早的预览线管理器访问</p>
            </div>
            <div class="status-item status-success">
                <h3>🎯 时序优化</h3>
                <p>预览线管理器将在数据加载后初始化</p>
            </div>
            <div class="status-item status-warning">
                <h3>🧪 待验证</h3>
                <p>需要测试实际效果</p>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">📋 修改内容总结</div>
            <div class="test-result">
✅ 文件：TaskFlowCanvas.vue
✅ 位置：第918-933行
✅ 操作：移除过早的预览线管理器访问代码

修改前：
- 在initCanvas方法中过早尝试获取unifiedPreviewManager
- 导致"无法获取统一预览线管理器"错误
- 影响Y坐标计算的时序

修改后：
- 移除过早访问代码
- 添加清晰的日志说明
- 保持initializeLayoutEngineAfterDataLoad方法不变
- 确保预览线管理器在正确时机初始化
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">🎯 预期效果</div>
            <div class="test-result">
1. ✅ 消除初始化错误日志
   - 不再看到："[TaskFlowCanvas] 无法获取统一预览线管理器"
   
2. ✅ 正确的初始化时序
   - 预览线管理器在数据加载后初始化
   - 布局引擎有正确的节点信息
   
3. ✅ Y坐标计算准确
   - 预览线使用正确的层级Y坐标
   - 不再使用固定偏移量
   
4. ✅ 架构保持稳定
   - 不影响现有功能
   - 风险极低
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">🔍 验证方法</div>
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn" onclick="openTaskFlow()">打开任务流画布</button>
                <button class="btn btn-success" onclick="checkConsole()">检查控制台日志</button>
            </div>
            <div class="test-result" id="verification-result">
点击上方按钮开始验证...

验证步骤：
1. 打开任务流画布页面
2. 检查控制台是否还有"无法获取统一预览线管理器"错误
3. 添加几个节点，观察预览线Y坐标是否正确
4. 确认预览线管理器在数据加载后正确初始化
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">📊 技术细节</div>
            <div class="test-result">
核心问题：时序错误
- 原因：在initCanvas中过早访问configDrawers.value?.structuredLayout.unifiedPreviewManager
- 时机：此时structuredLayout还未完全初始化
- 结果：获取到null，导致后续Y坐标计算使用固定偏移

解决方案：延迟初始化
- 移除：过早的预览线管理器访问代码
- 保持：initializeLayoutEngineAfterDataLoad方法
- 确保：预览线管理器在有节点数据时才初始化
- 效果：Y坐标计算使用正确的布局引擎层级信息
            </div>
        </div>
    </div>

    <script>
        function openTaskFlow() {
            const result = document.getElementById('verification-result');
            result.textContent = '正在打开任务流画布页面...\n\n请在新窗口中：\n1. 观察控制台日志\n2. 添加节点测试预览线\n3. 检查Y坐标是否正确';
            
            // 打开任务流页面
            window.open('http://localhost:5173/marketing/tasks', '_blank');
        }

        function checkConsole() {
            const result = document.getElementById('verification-result');
            result.textContent = `验证检查清单：

✅ 应该看到的日志：
- "[TaskFlowCanvas] 跳过预览线管理器的过早访问，将在数据加载后初始化"
- "[TaskFlowCanvas] 布局引擎初始化完成"
- "[TaskFlowCanvas] 统一预览线管理器已成功初始化并绑定事件监听器"

❌ 不应该看到的日志：
- "[TaskFlowCanvas] 无法获取统一预览线管理器"
- "[TaskFlowCanvas] StructuredLayout 不存在，无法获取统一预览线管理器"

🎯 Y坐标验证：
- 添加多个节点后，预览线应该使用正确的层级Y坐标
- 不再使用固定的 nodePosition.y + nodeSize.height + 100 偏移量
- 预览线终点应该对齐到下一层的正确位置

当前时间：${new Date().toLocaleString()}`;
        }

        // 页面加载时显示当前状态
        window.onload = function() {
            const result = document.getElementById('verification-result');
            result.textContent = `方案D已成功执行！

修改内容：
✅ 移除了TaskFlowCanvas.vue第918-933行的过早预览线管理器访问
✅ 添加了清晰的延迟初始化日志说明
✅ 保持了现有的initializeLayoutEngineAfterDataLoad方法

下一步：点击上方按钮进行验证测试`;
        };
    </script>
</body>
</html>