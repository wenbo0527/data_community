## 布局方向切换功能实现总结

### 已完成的修改

1. **端口配置工厂 (portConfigFactory.js)**
   - ✅ 修改 `createPortConfig` 函数，支持 `layoutDirection` 参数
   - ✅ 修改 `createNodePortConfig` 函数，根据布局方向动态配置端口位置
   - ✅ LR布局：输入端口在左侧，输出端口在右侧
   - ✅ TB布局：输入端口在顶部，输出端口在底部

2. **连接配置工厂 (connectionConfigFactory.js)**
   - ✅ 修改 `createConnectionConfig` 函数，支持 `layoutDirection` 参数
   - ✅ 修改 `createLabeledConnectionConfig` 函数，传递布局方向参数
   - ✅ 修改 `createBranchConnectionConfig` 函数，传递布局方向参数

3. **预览线管理器 (ConnectionPreviewManager.js)**
   - ✅ 添加 `layoutDirection` 参数到构造函数
   - ✅ 添加 `getDynamicDirectionConfig` 方法，根据布局方向返回连接方向
   - ✅ 添加 `updateLayoutDirection` 方法，更新布局方向并刷新预览线
   - ✅ 添加 `refreshAllPreviews` 方法，重新创建所有预览线
   - ✅ 更新硬编码的方向配置，使用动态配置

4. **统一预览线管理器 (useStructuredLayout.js)**
   - ✅ 修改 `UnifiedPreviewLineManager` 初始化，传递布局方向参数
   - ✅ 修改 `switchLayoutDirection` 函数，在切换时更新预览线管理器

5. **画布配置 (canvasConfig.js 和 x6Config.js)**
   - ✅ 修改 `getPortGroups` 函数，支持动态端口位置配置

6. **节点类型配置 (nodeTypes.js)**
   - ✅ 修改 `getNodePorts` 函数，接收并传递布局方向参数

7. **任务流画布 (TaskFlowCanvas.vue)**
   - ✅ 修改 `createNodePorts` 函数，获取当前布局方向并传递给端口配置工厂
   - ✅ 修改 `addConnectionToGraph` 函数，根据布局方向动态配置连接路由器

8. **节点连接助手 (nodeConnectionHelper.js)**
   - ✅ 修改 `createPresetConnection` 函数，支持布局方向参数
   - ✅ 修改 `createNodePresetConnections` 函数，传递布局方向参数

### 功能验证

通过测试验证了以下功能：

1. **端口位置配置**
   - TB布局：输入端口在顶部(top)，输出端口在底部(bottom) ✅
   - LR布局：输入端口在左侧(left)，输出端口在右侧(right) ✅

2. **连接方向配置**
   - TB布局：起始方向为底部(bottom)，结束方向为顶部(top) ✅
   - LR布局：起始方向为右侧(right)，结束方向为左侧(left) ✅

### 使用方法

1. **切换布局方向**
   ```javascript
   // 在 TaskFlowCanvas.vue 中
   const { switchLayoutDirection } = useStructuredLayout()
   
   // 切换到从左到右布局
   switchLayoutDirection('LR')
   
   // 切换到从上到下布局
   switchLayoutDirection('TB')
   ```

2. **预览线管理器会自动更新**
   - 切换布局方向时，预览线管理器会自动调用 `updateLayoutDirection` 方法
   - 所有现有的预览线会被清除并重新创建
   - 新创建的节点和连接会使用新的布局方向

### 技术实现要点

1. **动态方向配置函数**
   ```javascript
   const getDynamicDirectionConfig = (layoutDirection) => {
     if (layoutDirection === 'LR') {
       return {
         startDirections: ['right'],
         endDirections: ['left']
       }
     } else {
       return {
         startDirections: ['bottom'],
         endDirections: ['top']
       }
     }
   }
   ```

2. **端口位置动态配置**
   ```javascript
   if (layoutDirection === 'LR') {
     // 从左到右布局：输入端口在左侧，输出端口在右侧
     portPosition = isInputPort ? 'left' : 'right'
   } else {
     // 从上到下布局：输入端口在顶部，输出端口在底部
     portPosition = isInputPort ? 'top' : 'bottom'
   }
   ```

3. **错误处理和回滚机制**
   - 在 `switchLayoutDirection` 函数中实现了错误处理
   - 如果切换失败，会自动回滚到之前的布局方向

### 总结

布局方向切换功能已经完全实现，包括：
- ✅ 端口位置的动态调整
- ✅ 连接线方向的动态调整
- ✅ 预览线的自动更新
- ✅ 错误处理和回滚机制
- ✅ 完整的测试验证

用户现在可以在TB（从上到下）和LR（从左到右）两种布局方向之间自由切换，所有的节点端口和连接线都会自动适应新的布局方向。