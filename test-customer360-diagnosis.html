<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer360 æ·±åº¦è¯Šæ–­</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .content {
            padding: 20px;
        }
        
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .test-section.info { background: #e3f2fd; border-color: #2196f3; }
        .test-section.success { background: #e8f5e8; border-color: #4caf50; }
        .test-section.warning { background: #fff3e0; border-color: #ff9800; }
        .test-section.error { background: #ffebee; border-color: #f44336; }
        
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        .btn.success { background: #28a745; }
        .btn.warning { background: #ffc107; color: #212529; }
        .btn.danger { background: #dc3545; }
        
        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background: #4caf50; }
        .status-warning { background: #ff9800; }
        .status-error { background: #f44336; }
        .status-info { background: #2196f3; }
        
        .data-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .data-display pre {
            margin: 0;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .memory-info {
            background: #f1f3f4;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .event-listeners {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” Customer360 æ·±åº¦è¯Šæ–­å·¥å…·</h1>
            <p>ä¸“é—¨è¯Šæ–­ç”¨æˆ·887123é¡µé¢æ˜¾ç¤ºé—®é¢˜</p>
        </div>
        
        <div class="content">
            <div class="test-section info">
                <h3>ğŸ¯ è¯Šæ–­æ§åˆ¶é¢æ¿</h3>
                <button class="btn" onclick="runFullDiagnosis()">ğŸš€ è¿è¡Œå®Œæ•´è¯Šæ–­</button>
                <button class="btn" onclick="testApiCall()">ğŸ“ æµ‹è¯•APIè°ƒç”¨</button>
                <button class="btn" onclick="testDataBinding()">ğŸ”— æµ‹è¯•æ•°æ®ç»‘å®š</button>
                <button class="btn" onclick="testRenderLogic()">ğŸ­ æµ‹è¯•æ¸²æŸ“é€»è¾‘</button>
                <button class="btn" onclick="checkMemoryLeaks()">ğŸ§  æ£€æŸ¥å†…å­˜æ³„æ¼</button>
                <button class="btn" onclick="openRealPage()">ğŸ“„ æ‰“å¼€çœŸå®é¡µé¢</button>
                <button class="btn danger" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
            </div>
            
            <div class="grid">
                <div>
                    <div class="test-section">
                        <h4>ğŸ“Š è¯Šæ–­çŠ¶æ€</h4>
                        <div id="diagnosisStatus">ç­‰å¾…å¼€å§‹è¯Šæ–­...</div>
                    </div>
                    
                    <div class="test-section">
                        <h4>ğŸ§  å†…å­˜çŠ¶æ€</h4>
                        <div id="memoryStatus" class="memory-info">æœªæ£€æµ‹</div>
                    </div>
                    
                    <div class="test-section">
                        <h4>ğŸ‘‚ äº‹ä»¶ç›‘å¬å™¨çŠ¶æ€</h4>
                        <div id="eventListenerStatus" class="event-listeners">æœªæ£€æµ‹</div>
                    </div>
                </div>
                
                <div>
                    <div class="test-section">
                        <h4>ğŸ“ è¯Šæ–­æ—¥å¿—</h4>
                        <div id="logContainer" class="log-container">ç­‰å¾…è¯Šæ–­å¼€å§‹...
</div>
                    </div>
                </div>
            </div>
            
            <div class="test-section">
                <h4>ğŸ“Š æ•°æ®å±•ç¤ºåŒº</h4>
                <div id="dataDisplay" class="data-display">
                    <pre>æš‚æ— æ•°æ®</pre>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        let logContainer, diagnosisStatus, memoryStatus, eventListenerStatus, dataDisplay;
        let apiCallCount = 0;
        let renderAttempts = 0;
        let memoryLeakDetected = false;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            logContainer = document.getElementById('logContainer');
            diagnosisStatus = document.getElementById('diagnosisStatus');
            memoryStatus = document.getElementById('memoryStatus');
            eventListenerStatus = document.getElementById('eventListenerStatus');
            dataDisplay = document.getElementById('dataDisplay');
            
            log('ğŸ¯ è¯Šæ–­å·¥å…·åˆå§‹åŒ–å®Œæˆ', 'success');
            updateStatus('è¯Šæ–­å·¥å…·å°±ç»ª', 'success');
        });
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'success': 'âœ…',
                'error': 'âŒ',
                'warning': 'âš ï¸',
                'info': 'â„¹ï¸'
            }[type] || 'â„¹ï¸';
            
            logContainer.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`${prefix} ${message}`);
        }
        
        function updateStatus(message, type = 'info') {
            const statusClass = `status-${type}`;
            diagnosisStatus.innerHTML = `<span class="status-indicator ${statusClass}"></span>${message}`;
        }
        
        function displayData(data, title = 'æ•°æ®') {
            dataDisplay.innerHTML = `<h5>${title}</h5><pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
        
        function clearAll() {
            logContainer.textContent = 'æ—¥å¿—å·²æ¸…ç©º\n';
            dataDisplay.innerHTML = '<pre>æš‚æ— æ•°æ®</pre>';
            updateStatus('æ—¥å¿—å·²æ¸…ç©º', 'info');
        }
        
        // æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ
        function checkMemoryLeaks() {
            log('ğŸ§  å¼€å§‹æ£€æŸ¥å†…å­˜çŠ¶æ€...', 'info');
            
            if (performance.memory) {
                const memory = performance.memory;
                const usedMB = (memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
                const totalMB = (memory.totalJSHeapSize / 1024 / 1024).toFixed(2);
                const limitMB = (memory.jsHeapSizeLimit / 1024 / 1024).toFixed(2);
                
                log(`å†…å­˜ä½¿ç”¨: ${usedMB}MB / ${totalMB}MB (é™åˆ¶: ${limitMB}MB)`, 'info');
                
                memoryStatus.innerHTML = `
                    <div>å·²ä½¿ç”¨: ${usedMB} MB</div>
                    <div>æ€»è®¡: ${totalMB} MB</div>
                    <div>é™åˆ¶: ${limitMB} MB</div>
                    <div>ä½¿ç”¨ç‡: ${((memory.usedJSHeapSize / memory.jsHeapSizeLimit) * 100).toFixed(1)}%</div>
                `;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å†…å­˜æ³„æ¼è¿¹è±¡
                if (memory.usedJSHeapSize / memory.jsHeapSizeLimit > 0.8) {
                    log('âš ï¸ è­¦å‘Šï¼šå†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ï¼Œå¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼', 'warning');
                    memoryLeakDetected = true;
                }
            } else {
                log('âŒ æµè§ˆå™¨ä¸æ”¯æŒå†…å­˜ç›‘æ§', 'error');
                memoryStatus.innerHTML = 'æµè§ˆå™¨ä¸æ”¯æŒå†…å­˜ç›‘æ§';
            }
            
            // æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨
            checkEventListeners();
        }
        
        function checkEventListeners() {
            log('ğŸ‘‚ æ£€æŸ¥äº‹ä»¶ç›‘å¬å™¨çŠ¶æ€...', 'info');
            
            // æ¨¡æ‹Ÿæ£€æŸ¥EventEmitterç›‘å¬å™¨æ•°é‡
            const mockListenerCount = Math.floor(Math.random() * 15) + 5;
            
            eventListenerStatus.innerHTML = `
                <div>æ¨¡æ‹Ÿç›‘å¬å™¨æ•°é‡: ${mockListenerCount}</div>
                <div>è­¦å‘Šé˜ˆå€¼: 10</div>
                <div>çŠ¶æ€: ${mockListenerCount > 10 ? 'âš ï¸ è¶…å‡ºé˜ˆå€¼' : 'âœ… æ­£å¸¸'}</div>
            `;
            
            if (mockListenerCount > 10) {
                log(`âš ï¸ æ£€æµ‹åˆ°è¿‡å¤šäº‹ä»¶ç›‘å¬å™¨: ${mockListenerCount} ä¸ª`, 'warning');
                log('ğŸ’¡ å»ºè®®ï¼šæ£€æŸ¥æ˜¯å¦æ­£ç¡®ç§»é™¤äº‹ä»¶ç›‘å¬å™¨', 'info');
            } else {
                log(`âœ… äº‹ä»¶ç›‘å¬å™¨æ•°é‡æ­£å¸¸: ${mockListenerCount} ä¸ª`, 'success');
            }
        }
        
        // æµ‹è¯•APIè°ƒç”¨
        async function testApiCall() {
            log('ğŸ“ å¼€å§‹æµ‹è¯•APIè°ƒç”¨...', 'info');
            updateStatus('æµ‹è¯•APIè°ƒç”¨ä¸­...', 'warning');
            apiCallCount++;
            
            try {
                const { fetchUserInfo } = await import('./src/mock/customer360.ts');
                
                log(`ğŸ“ ç¬¬${apiCallCount}æ¬¡è°ƒç”¨ fetchUserInfo('887123')...`, 'info');
                const startTime = performance.now();
                const result = await fetchUserInfo('887123');
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);
                
                log(`âœ… APIè°ƒç”¨å®Œæˆï¼Œè€—æ—¶: ${duration}ms`, 'success');
                
                if (result && result.error) {
                    log(`âŒ APIè¿”å›é”™è¯¯: ${result.error}`, 'error');
                    log(`âŒ é”™è¯¯æ¶ˆæ¯: ${result.message}`, 'error');
                    updateStatus('APIè°ƒç”¨å¤±è´¥', 'error');
                    displayData(result, 'APIé”™è¯¯å“åº”');
                } else if (result) {
                    log('âœ… APIè¿”å›æ­£å¸¸æ•°æ®', 'success');
                    log(`ğŸ“Š ç”¨æˆ·ID: ${result.userId}`, 'info');
                    log(`ğŸ“Š ç”¨æˆ·å§“å: ${result.name}`, 'info');
                    log(`ğŸ“Š åŸºæœ¬ä¿¡æ¯: ${result.basicInfo ? 'å­˜åœ¨' : 'ç¼ºå¤±'}`, result.basicInfo ? 'success' : 'error');
                    log(`ğŸ“Š å­˜æ¬¾äº§å“: ${result.depositProducts?.length || 0} ä¸ª`, 'info');
                    log(`ğŸ“Š è´·æ¬¾äº§å“: ${result.loanProducts?.length || 0} ä¸ª`, 'info');
                    
                    updateStatus('APIè°ƒç”¨æˆåŠŸ', 'success');
                    displayData(result, 'ç”¨æˆ·887123å®Œæ•´æ•°æ®');
                    
                    // æµ‹è¯•æ•°æ®ç»‘å®š
                    await testDataBindingWithData(result);
                } else {
                    log('âŒ APIè¿”å›ç©ºæ•°æ®', 'error');
                    updateStatus('APIè¿”å›ç©ºæ•°æ®', 'error');
                }
            } catch (error) {
                log(`âŒ APIè°ƒç”¨å¼‚å¸¸: ${error.message}`, 'error');
                updateStatus('APIè°ƒç”¨å¼‚å¸¸', 'error');
                console.error('APIè°ƒç”¨å¼‚å¸¸:', error);
            }
        }
        
        // æµ‹è¯•æ•°æ®ç»‘å®š
        async function testDataBinding() {
            log('ğŸ”— å¼€å§‹æµ‹è¯•æ•°æ®ç»‘å®š...', 'info');
            
            try {
                const { fetchUserInfo } = await import('./src/mock/customer360.ts');
                const userInfo = await fetchUserInfo('887123');
                
                await testDataBindingWithData(userInfo);
            } catch (error) {
                log(`âŒ æ•°æ®ç»‘å®šæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testDataBindingWithData(userInfo) {
            log('ğŸ”— æµ‹è¯•Vueç»„ä»¶æ•°æ®ç»‘å®šé€»è¾‘...', 'info');
            
            // æ¨¡æ‹ŸVueç»„ä»¶çŠ¶æ€
            let componentState = {
                loading: true,
                error: null,
                userInfo: null,
                basicInfo: null,
                productModules: [],
                debugLogs: []
            };
            
            log('ğŸ“Š åˆå§‹ç»„ä»¶çŠ¶æ€:', 'info');
            log(`  loading: ${componentState.loading}`, 'info');
            log(`  userInfo: ${componentState.userInfo ? 'æœ‰æ•°æ®' : 'null'}`, 'info');
            
            // æ¨¡æ‹Ÿæ•°æ®è·å–å®Œæˆ
            if (userInfo && !userInfo.error) {
                componentState.loading = false;
                componentState.userInfo = userInfo;
                componentState.basicInfo = userInfo.basicInfo || {
                    name: userInfo.name,
                    age: userInfo.age,
                    gender: userInfo.gender,
                    idCard: userInfo.idCard,
                    phone: userInfo.mobile
                };
                
                log('ğŸ“Š æ•°æ®ç»‘å®šåçŠ¶æ€:', 'success');
                log(`  loading: ${componentState.loading}`, 'success');
                log(`  userInfo: ${componentState.userInfo ? 'æœ‰æ•°æ®' : 'null'}`, 'success');
                log(`  basicInfo: ${componentState.basicInfo ? 'æœ‰æ•°æ®' : 'null'}`, 'success');
                
                // æµ‹è¯•æ¸²æŸ“æ¡ä»¶
                await testRenderConditions(componentState);
            } else {
                componentState.loading = false;
                componentState.error = userInfo?.error || 'æ•°æ®è·å–å¤±è´¥';
                
                log('âŒ æ•°æ®ç»‘å®šå¤±è´¥ï¼Œè®¾ç½®é”™è¯¯çŠ¶æ€', 'error');
                log(`  error: ${componentState.error}`, 'error');
            }
        }
        
        // æµ‹è¯•æ¸²æŸ“æ¡ä»¶
        async function testRenderConditions(componentState) {
            log('ğŸ­ æµ‹è¯•æ¸²æŸ“æ¡ä»¶é€»è¾‘...', 'info');
            renderAttempts++;
            
            const { loading, error, userInfo, basicInfo } = componentState;
            
            // æ¨¡æ‹ŸVueæ¨¡æ¿æ¸²æŸ“é€»è¾‘
            log('ğŸ­ æ£€æŸ¥æ¸²æŸ“æ¡ä»¶:', 'info');
            
            if (loading) {
                log('  â³ æ˜¾ç¤ºåŠ è½½çŠ¶æ€', 'warning');
                return 'loading';
            }
            
            if (error) {
                log('  âŒ æ˜¾ç¤ºé”™è¯¯çŠ¶æ€', 'error');
                return 'error';
            }
            
            if (!userInfo) {
                log('  ğŸ“­ æ˜¾ç¤ºæ— æ•°æ®çŠ¶æ€', 'warning');
                return 'no-data';
            }
            
            // æ£€æŸ¥å…³é”®æ•°æ®æ˜¯å¦å­˜åœ¨
            const hasBasicInfo = !!(basicInfo && basicInfo.name);
            const hasProducts = !!(userInfo.depositProducts?.length || userInfo.loanProducts?.length);
            
            log(`  âœ… æ¸²æŸ“ä¸»è¦å†…å®¹ (ç¬¬${renderAttempts}æ¬¡å°è¯•)`, 'success');
            log(`    - åŸºæœ¬ä¿¡æ¯: ${hasBasicInfo ? 'âœ…' : 'âŒ'}`, hasBasicInfo ? 'success' : 'error');
            log(`    - äº§å“ä¿¡æ¯: ${hasProducts ? 'âœ…' : 'âŒ'}`, hasProducts ? 'success' : 'error');
            
            if (hasBasicInfo && hasProducts) {
                log('ğŸ‰ æ‰€æœ‰æ¸²æŸ“æ¡ä»¶æ»¡è¶³ï¼Œé¡µé¢åº”è¯¥æ­£å¸¸æ˜¾ç¤º', 'success');
                updateStatus('æ¸²æŸ“æµ‹è¯•é€šè¿‡', 'success');
                return 'success';
            } else {
                log('âš ï¸ éƒ¨åˆ†æ¸²æŸ“æ¡ä»¶ä¸æ»¡è¶³ï¼Œå¯èƒ½å¯¼è‡´é¡µé¢æ˜¾ç¤ºå¼‚å¸¸', 'warning');
                updateStatus('æ¸²æŸ“æµ‹è¯•éƒ¨åˆ†é€šè¿‡', 'warning');
                return 'partial';
            }
        }
        
        // æµ‹è¯•æ¸²æŸ“é€»è¾‘
        async function testRenderLogic() {
            log('ğŸ­ å¼€å§‹ç‹¬ç«‹æµ‹è¯•æ¸²æŸ“é€»è¾‘...', 'info');
            
            // åˆ›å»ºæ¨¡æ‹Ÿæ•°æ®
            const mockUserInfo = {
                userId: '887123',
                name: 'å¼ *',
                basicInfo: {
                    name: 'å¼ *',
                    age: 35,
                    gender: 'ç”·',
                    idCard: '320*******123X',
                    phone: '159****5678'
                },
                depositProducts: [{
                    productKey: 'regular-887123',
                    name: 'æ´»æœŸå­˜æ¬¾',
                    balance: 20000.00
                }],
                loanProducts: [{
                    productKey: 'consumer-887123',
                    name: 'ä¸ªäººæ¶ˆè´¹è´·æ¬¾',
                    balance: 30000.00
                }]
            };
            
            const componentState = {
                loading: false,
                error: null,
                userInfo: mockUserInfo,
                basicInfo: mockUserInfo.basicInfo
            };
            
            await testRenderConditions(componentState);
        }
        
        // è¿è¡Œå®Œæ•´è¯Šæ–­
        async function runFullDiagnosis() {
            log('ğŸš€ å¼€å§‹è¿è¡Œå®Œæ•´è¯Šæ–­æµç¨‹...', 'info');
            updateStatus('è¿è¡Œå®Œæ•´è¯Šæ–­ä¸­...', 'warning');
            
            try {
                // 1. æ£€æŸ¥å†…å­˜çŠ¶æ€
                checkMemoryLeaks();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 2. æµ‹è¯•APIè°ƒç”¨
                await testApiCall();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 3. æµ‹è¯•æ¸²æŸ“é€»è¾‘
                await testRenderLogic();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 4. ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
                generateDiagnosisReport();
                
                log('ğŸ‰ å®Œæ•´è¯Šæ–­æµç¨‹å®Œæˆ', 'success');
                updateStatus('è¯Šæ–­å®Œæˆ', 'success');
            } catch (error) {
                log(`âŒ è¯Šæ–­è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`, 'error');
                updateStatus('è¯Šæ–­å¤±è´¥', 'error');
            }
        }
        
        function generateDiagnosisReport() {
            log('ğŸ“‹ ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š...', 'info');
            
            const report = {
                timestamp: new Date().toISOString(),
                apiCallCount: apiCallCount,
                renderAttempts: renderAttempts,
                memoryLeakDetected: memoryLeakDetected,
                recommendations: []
            };
            
            if (memoryLeakDetected) {
                report.recommendations.push('æ£€æŸ¥EventEmitterç›‘å¬å™¨çš„æ·»åŠ å’Œç§»é™¤');
                report.recommendations.push('ä¼˜åŒ–ç»„ä»¶å¸è½½æ—¶çš„æ¸…ç†é€»è¾‘');
            }
            
            if (apiCallCount > 3) {
                report.recommendations.push('APIè°ƒç”¨æ¬¡æ•°è¾ƒå¤šï¼Œæ£€æŸ¥æ˜¯å¦æœ‰é‡å¤è°ƒç”¨');
            }
            
            if (renderAttempts > 2) {
                report.recommendations.push('æ¸²æŸ“å°è¯•æ¬¡æ•°è¾ƒå¤šï¼Œæ£€æŸ¥æ•°æ®æµå’Œæ¡ä»¶é€»è¾‘');
            }
            
            displayData(report, 'è¯Šæ–­æŠ¥å‘Š');
            log('ğŸ“‹ è¯Šæ–­æŠ¥å‘Šå·²ç”Ÿæˆ', 'success');
        }
        
        function openRealPage() {
            log('ğŸ“„ æ‰“å¼€çœŸå®Customer360é¡µé¢...', 'info');
            const url = 'http://localhost:5173/#/customer/detail/887123';
            window.open(url, '_blank');
            log(`ğŸ“„ é¡µé¢å·²åœ¨æ–°çª—å£æ‰“å¼€: ${url}`, 'success');
        }
        
        // å…¨å±€å‡½æ•°
        window.runFullDiagnosis = runFullDiagnosis;
        window.testApiCall = testApiCall;
        window.testDataBinding = testDataBinding;
        window.testRenderLogic = testRenderLogic;
        window.checkMemoryLeaks = checkMemoryLeaks;
        window.openRealPage = openRealPage;
        window.clearAll = clearAll;
    </script>
</body>
</html>